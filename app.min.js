function responsiveDisplay(a){if((null==menuVM.cartMode()||menuVM.cartMode()==SHOPPING_CART_MODE_DEFAULT)&&(menuVM.hasPackageCustomerRights()||menuVM.hasPackageSellerRights())&&!menuVM.hasCashDeskSale()&&-1==location.hash.indexOf("#packages"))return $("#packages").addClass("active",!0),void(location.hash="packages");if(0==a.indexOf("skipass")){if("skipass"!=$("#formShop .tab-pane.active").attr("id"))return void(location.hash="shop")}else if(0==a.indexOf("bergbahn_epr")){if("bergbahn_epr"!=$("#formShop .tab-pane.active").attr("id"))return void(location.hash="shop")}else if(0==a.indexOf("railway_seat_reservation_mrag")){if("railway_seat_reservation_mrag"!=$("#formShop .tab-pane.active").attr("id"))return void(location.hash="shop")}else if(0==a.indexOf("railway_seat_reservation_timetable")){if("railway_seat_reservation_timetable"!=$("#formShop .tab-pane.active").attr("id"))return void(location.hash="shop")}else if(0==a.indexOf("railway_seat_reservation")){if("railway_seat_reservation"!=$("#formShop .tab-pane.active").attr("id"))return void(location.hash="shop")}else if(0==a.indexOf("bergbahn")){if("bergbahn"!=$("#formShop .tab-pane.active").attr("id"))return void(location.hash="shop")}else if(0==a.indexOf("cargo")){if("cargo"!=$("#formShop .tab-pane.active").attr("id"))return void(location.hash="shop")}else if(0==a.indexOf("bus")){if("bus"!=$("#formShop .tab-pane.active").attr("id"))return void(location.hash="shop")}else if(0==a.indexOf("daytrips")){if("daytrips"!=$("#formShop .tab-pane.active").attr("id"))return void(location.hash="shop")}else if(0==a.indexOf("localevent")){if("localevent"!=$("#formShop .tab-pane.active").attr("id"))return void(location.hash="shop")}else if(0==a.indexOf("specialevent")){if("specialevent"!=$("#formShop .tab-pane.active").attr("id"))return void(location.hash="shop")}else if(0==a.indexOf("hotel")){if("hotel"!=$("#formShop .tab-pane.active").attr("id"))return void(location.hash="shop")}else if(0==a.indexOf("depot")){if("depot"!=$("#formShop .tab-pane.active").attr("id"))return void(location.hash="shop")}else if(0==a.indexOf("parking")){if("parking"!=$("#formShop .tab-pane.active").attr("id"))return void(location.hash="shop")}else if(0==a.indexOf("restaurant")){if("restaurant"!=$("#formShop .tab-pane.active").attr("id"))return void(location.hash="shop")}else if(0==a.indexOf("autoverlad")&&"autoverlad"!=$("#formShop .tab-pane.active").attr("id"))return void(location.hash="shop");if($(window).width()<=768)switch(a){case"":headerVM.showOperatorSelection()?displayOperatorSelection():displayCategory();break;case"category":displayCategory();break;case"bergbahn":displayBergbahn();break;case"skipass":displaySkipass();break;case"skipass_duration":displaySkipassDuration();break;case"bergbahn_date":displayBergbahnDate();break;case"skipass_date":displaySkipassDate();break;case"bergbahn_destination":displayBergbahnDestination();break;case"bergbahn_via":displayBergbahnVia();break;case"bergbahn_type":displayBergbahnType();break;case"skipass_persons":displaySkipassPersons();break;case"bergbahn_persons":displayBergbahnPersons();break;case"bergbahn_epr":displayBergbahnEpr();break;case"bergbahn_epr_date":displayBergbahnEprDate();break;case"bergbahn_epr_destination":displayBergbahnEprDestination();break;case"bergbahn_epr_trainup":displayBergbahnEprTrainUp();break;case"bergbahn_epr_traindown":displayBergbahnEprTrainDown();break;case"bergbahn_epr_persons":displayBergbahnEprPersons();break;case"railway_seat_reservation":displayRailwaySeatReservation();break;case"railway_seat_reservation_timetable":displayRailwaySeatReservationTimetable();break;case"railway_seat_reservation_mrag":displayRailwaySeatReservationMrag();break;case"railway_seat_reservation_origin":displayRailwaySeatReservationOrigin();break;case"railway_seat_reservation_destination":displayRailwaySeatReservationDestination();break;case"railway_seat_reservation_type":displayRailwaySeatReservationType();break;case"railway_seat_reservation_catering":displayRailwaySeatReservationCatering();break;case"railway_seat_reservation_date":displayRailwaySeatReservationDate();break;case"railway_seat_reservation_persons":displayRailwaySeatReservationPersons();break;case"bus":displayBus();break;case"bus_busup":displayBusUp();break;case"bus_downdate":displayBusDownDate();break;case"bus_busdown":displayBusDown();break;case"bus_addon":displayBusAddOn();break;case"bus_persons":displayBusPersons();break;case"daytrips":displayDaytrips();break;case"daytrips_addon":displayDaytripsAddon();break;case"daytrips_date":displayDaytripsDate();break;case"daytrips_persons":displayDaytripsPersons();break;case"localevent":displayLocalEvent();break;case"localevent_activity":displayLocalEventActivity();break;case"localevent_product":displayLocalEventProduct();break;case"localevent_type":displayLocalEventType();break;case"localevent_date":displayLocalEventDate();break;case"localevent_time":displayLocalEventTime();break;case"localevent_persons":displayLocalEventPersons();break;case"specialevent":displaySpecialEvent();break;case"specialevent_product":displaySpecialEventProduct();break;case"specialevent_type":displaySpecialEventType();break;case"specialevent_date":displaySpecialEventDate();break;case"specialevent_time":displaySpecialEventTime();break;case"specialevent_persons":displaySpecialEventPersons();break;case"publictransportation_mode":displayPublictransportationMode();break;case"hotel":displayHotel();break;case"hotel_roomcategory":displayHotelRoomCategory();break;case"hotel_arrivaldate":displayHotelArrivalDate();break;case"hotel_departuredate":displayHotelDepartureDate();break;case"hotel_roomcount":displayHotelRoomCount();break;case"hotel_adultcount":displayHotelAdultCount();break;case"hotel_childcount":displayHotelChildCount();break;case"hotel_children":displayHotelChildren();break;case"hotel_city":displayHotelCity();break;case"hotel_accommodation":displayHotelAccommodation();break;case"hotel_offers":displayHotelOffers();break;case"depot":displayLocalEvent();break;case"depot_persons":break;case"parking":case"parking_locations":displayParkingLocations();break;case"parking_ticketTypes":displayParkingTicketTypes();break;case"parking_durations":displayParkingDurations();break;case"parking_begin":displayParkingBegin();break;case"autoverlad":displayAutoverladStations()();break;case"autoverlad_direction":displayAutoverladDirections();break;case"autoverlad_type":displayAutoverladTypes();break;case"autoverlad_date":displayAutoverladDates();break;case"autoverlad_category":displayAutoverladCategories();break;case"restaurant":case"restaurant_region":displayRestaurantRegions();break;
case"restaurant_city":displayRestaurantCity();break;case"restaurant_consumer_type":displayRestaurantConsumerType();break;case"restaurant_date":displayRestaurantDate();break;case"restaurant_restaurants":displayRestaurants()}else displayAll()}function displayCategory(){displayNone(),$("#formShop #categoryInfo .btn-group-body").slideDown()}function displayOperatorSelection(){displayNone("#formShop #operatorSelection .btn-group-body"),$("#formShop #operatorSelection .btn-group-body").slideDown()}function displayBergbahn(){displayNone(),$("#formShop #bergbahn .origin-col .btn-group-body").slideDown()}function displaySkipass(){displayNone(),$("#formShop #skipass .skiarea-col .btn-group-body").slideDown()}function displaySkipassDuration(){displayNone(),$("#formShop #skipass .duration-col .btn-group-body").slideDown()}function displayBergbahnDestination(){displayNone(),$("#formShop #bergbahn .destination-col .btn-group-body").slideDown()}function displayBergbahnVia(){displayNone(),$("#formShop #bergbahn .via-col .btn-group-body").slideDown()}function displayBergbahnType(){displayNone(),$("#formShop #bergbahn .type-col .btn-group-body").slideDown()}function displayBergbahnDate(){displayNone(),$("#formShop #bergbahn .date-col .btn-group-body").slideDown()}function displaySkipassDate(){displayNone(),$("#formShop #skipass .date-col .btn-group-body").slideDown()}function displaySkipassPersons(){displayNone(),$("#formShop #skipass .persons-col .btn-group-body").slideDown()}function displayBergbahnPersons(){displayNone(),$("#formShop #bergbahn .persons-col .btn-group-body").slideDown()}function displayBergbahnEpr(){displayNone(),$("#formShop #bergbahn_epr .origin-col .btn-group-body").slideDown()}function displayBergbahnEprDestination(){displayNone(),$("#formShop #bergbahn_epr .destination-col .btn-group-body").slideDown()}function displayBergbahnEprDate(){displayNone(),$("#formShop #bergbahn_epr .date-col .btn-group-body").slideDown()}function displayBergbahnEprTrainUp(){displayNone(),$("#formShop #bergbahn_epr .trainup-col .btn-group-body").slideDown()}function displayBergbahnEprTrainDown(){displayNone(),$("#formShop #bergbahn_epr .traindown-col .btn-group-body").slideDown()}function displayBergbahnEprPersons(){displayNone(),$("#formShop #bergbahn_epr .persons-col .btn-group-body").slideDown()}function displayRailwaySeatReservation(){displayNone(),$("#formShop #railway_seat_reservation .contractor-col .btn-group-body").slideDown()}function displayRailwaySeatReservationTimetable(){displayNone(),$("#formShop #railway_seat_reservation .contractor-col .btn-group-body").slideDown()}function displayRailwaySeatReservationTimetable(){displayNone(),$("#formShop #railway_seat_reservation .contractor-col .btn-group-body").slideDown()}function displayRailwaySeatReservationMrag(){displayNone(),$("#formShop #railway_seat_reservation .contractor-col .btn-group-body").slideDown()}function displayRailwaySeatReservationOrigin(){displayNone(),$("#formShop #railway_seat_reservation .origin-col .btn-group-body").slideDown()}function displayRailwaySeatReservationDestination(){displayNone(),$("#formShop #railway_seat_reservation .destination-col .btn-group-body").slideDown()}function displayRailwaySeatReservationType(){displayNone(),$("#formShop #railway_seat_reservation .type-col .btn-group-body").slideDown()}function displayRailwaySeatReservationCatering(){displayNone(),$("#formShop #railway_seat_reservation .catering-col .btn-group-body").slideDown()}function displayRailwaySeatReservationDate(){displayNone(),$("#formShop #railway_seat_reservation .date-col .btn-group-body").slideDown()}function displayRailwaySeatReservationPersons(){displayNone(),$("#formShop #railway_seat_reservation .persons-col .btn-group-body").slideDown()}function displayBus(){displayNone(),$("#formShop #bus .origin-col .btn-group-body").slideDown()}function displayBusUp(){displayNone(),$("#formShop #bus .busup-col .btn-group-body").slideDown()}function displayBusDownDate(){displayNone(),$("#formShop #bus .down-date-col .btn-group-body").slideDown()}function displayBusDown(){displayNone(),$("#formShop #bus .busdown-col .btn-group-body").slideDown()}function displayBusAddOn(){displayNone(),$("#formShop #bus .addon-col .btn-group-body").slideDown()}function displayBusPersons(){displayNone(),$("#formShop #bus .persons-col-bus .btn-group-body").slideDown()}function displayDaytrips(){displayNone(),$("#formShop #daytrips .bundle-col .btn-group-body").slideDown()}function displayDaytripsAddon(){displayNone(),$("#formShop #daytrips .addon-col .btn-group-body").slideDown()}function displayDaytripsDate(){displayNone(),$("#formShop #daytrips .date-col .btn-group-body").slideDown()}function displayDaytripsPersons(){displayNone(),$("#formShop #daytrips .persons-col .btn-group-body").slideDown()}function displayLocalEvent(){displayNone(),$("#formShop #localevent .region-col .btn-group-body").slideDown()}function displayLocalEventActivity(){displayNone(),$("#formShop #localevent .activity-col .btn-group-body").slideDown()}function displayLocalEventProduct(){displayNone(),$("#formShop #localevent .product-col .btn-group-body").slideDown()}function displayLocalEventType(){displayNone(),$("#formShop #localevent .type-col .btn-group-body").slideDown()}function displayLocalEventDate(){displayNone(),$("#formShop #localevent .date-col .btn-group-body").slideDown()}function displayLocalEventTime(){displayNone(),$("#formShop #localevent .time-col .btn-group-body").slideDown()}function displayLocalEventPersons(){displayNone(),$("#formShop #localevent .persons-col .btn-group-body").slideDown()}function displaySpecialEvent(){displayNone(),$("#formShop #specialevent .region-col .btn-group-body").slideDown()}function displaySpecialEventProduct(){displayNone(),$("#formShop #specialevent .product-col .btn-group-body").slideDown()}function displaySpecialEventType(){displayNone(),$("#formShop #specialevent .type-col .btn-group-body").slideDown()}function displaySpecialEventDate(){displayNone(),$("#formShop #specialevent .date-col .btn-group-body").slideDown()}function displaySpecialEventTime(){displayNone(),$("#formShop #specialevent .time-col .btn-group-body").slideDown()}function displaySpecialEventPersons(){displayNone(),$("#formShop #specialevent .persons-col .btn-group-body").slideDown()}function displayPublictransportationMode(){displayNone(),$("#formShop #bergbahn .mode-col .btn-group-body").slideDown()}function displayHotel(){displayNone(),$("#formShop #hotel .region-col .btn-group-body").slideDown()}function displayHotelRoomCategory(){displayNone(),$("#formShop #hotel .roomcategory-col .btn-group-body").slideDown()}function displayHotelArrivalDate(){displayNone(),$("#formShop #hotel .arrival-date-col .btn-group-body").slideDown()}function displayHotelDepartureDate(){displayNone(),$("#formShop #hotel .departure-date-col .btn-group-body").slideDown()}function displayHotelRoomCount(){displayNone(),$("#formShop #hotel .room-count-col .btn-group-body").slideDown()}function displayHotelAdultCount(){displayNone(),$("#formShop #hotel .adult-count-col .btn-group-body").slideDown()}function displayHotelChildCount(){displayNone(),$("#formShop #hotel .child-count-col .btn-group-body").slideDown()}function displayHotelChildren(){displayNone(),$("#formShop #hotel .children-col .btn-group-body").slideDown()}function displayHotelCity(){displayNone(),$("#formShop #hotel .city-col .btn-group-body").slideDown()}function displayHotelAccommodation(){displayNone(),$("#formShop #hotel .hotel-col .btn-group-body").slideDown()}function displayHotelOffers(){displayNone(),$("#formShop #hotel .persons-col .btn-group-body").slideDown()}function displayParkingLocations(){displayNone(),$("#formShop #parking .location-col .btn-group-body").slideDown()}function displayParkingTicketTypes(){displayNone(),$("#formShop #parking .ticket-type-col .btn-group-body").slideDown()}function displayParkingDurations(){displayNone(),$("#formShop #parking .duration-col .btn-group-body").slideDown()}function displayParkingBegin(){displayNone(),$("#formShop #parking .date-col .btn-group-body").slideDown()}function displayAutoverladStations(){displayNone(),$("#formShop #autoverlad .product-col .btn-group-body").slideDown()}function displayAutoverladDirections(){displayNone(),$("#formShop #autoverlad .direction-col .btn-group-body").slideDown()}function displayAutoverladTypes(){displayNone(),$("#formShop #autoverlad .type-col .btn-group-body").slideDown()}function displayAutoverladDates(){displayNone(),$("#formShop #autoverlad .date-col .btn-group-body").slideDown()}function displayAutoverladCategories(){displayNone(),$("#formShop #autoverlad .category-col .btn-group-body").slideDown()}function displayRestaurantRegions(){displayNone(),$("#formShop #restaurant .region-col .btn-group-body").slideDown()}function displayRestaurantCity(){displayNone(),$("#formShop #restaurant .city-col .btn-group-body").slideDown()}function displayRestaurantConsumerType(){displayNone(),$("#formShop #restaurant .type-col .btn-group-body").slideDown()}function displayRestaurantDate(){displayNone(),$("#formShop #restaurant .date-col .btn-group-body").slideDown()}function displayRestaurants(){displayNone(),$("#formShop #restaurant .restaurant-col .btn-group-body").slideDown()}function displayNone(a){$("#formShop #categoryInfo .btn-group-body, #formShop #operatorSelection .btn-group-body, #formShop #skipass .skiarea-col .btn-group-body, #formShop #skipass .duration-col .btn-group-body, #formShop .date-col .btn-group-body, #formShop .persons-col .btn-group-body, #formShop #bergbahn .type-col .btn-group-body, #formShop #bergbahn .via-col .btn-group-body, #formShop #bergbahn .origin-col .btn-group-body, #formShop #bergbahn .destination-col .btn-group-body, #formShop #bergbahn_epr .destination-col .btn-group-body, #formShop #bergbahn_epr .trainup-col .btn-group-body, #formShop #bergbahn_epr .traindown-col .btn-group-body, #formShop #bergbahn_epr .origin-col .btn-group-body, #formShop #railway_seat_reservation .contractor-col .btn-group-body, #formShop #railway_seat_reservation .origin-col .btn-group-body, #formShop #railway_seat_reservation .destination-col .btn-group-body, #formShop #railway_seat_reservation .type-col .btn-group-body, #formShop #railway_seat_reservation .catering-col .btn-group-body, #formShop #railway_seat_reservation_timetable .contractor-col .btn-group-body, #formShop 
#railway_seat_reservation_timetable .origin-col .btn-group-body, #formShop #railway_seat_reservation_timetable .destination-col .btn-group-body, #formShop #railway_seat_reservation_timetable .type-col .btn-group-body, #formShop #railway_seat_reservation_timetable .catering-col .btn-group-body, #formShop #railway_seat_reservation_mrag .contractor-col .btn-group-body, #formShop #railway_seat_reservation_mrag .origin-col .btn-group-body, #formShop #railway_seat_reservation_mrag .destination-col .btn-group-body, #formShop #railway_seat_reservation_mrag .type-col .btn-group-body, #formShop #railway_seat_reservation_mrag .catering-col .btn-group-body, #formShop #bus .origin-col .btn-group-body, #formShop #bus .busup-col .btn-group-body, #formShop #bus .down-date-col .btn-group-body, #formShop #bus .busdown-col .btn-group-body, #formShop #bus .addon-col .btn-group-body, #formShop #daytrips .bundle-col .btn-group-body, #formShop #daytrips .addon-col .btn-group-body, #formShop #localevent .region-col .btn-group-body, #formShop #localevent .product-col .btn-group-body, #formShop #localevent .type-col .btn-group-body, #formShop #localevent .time-col .btn-group-body, #formShop #specialevent .region-col .btn-group-body, #formShop #specialevent .product-col .btn-group-body, #formShop #specialevent .type-col .btn-group-body, #formShop #specialevent .time-col .btn-group-body, #formShop #hotel .region-col .btn-group-body, #formShop #hotel .roomcategory-col .btn-group-body, #formShop #hotel .arrival-date-col .btn-group-body, #formShop #hotel .departure-date-col .btn-group-body, #formShop #hotel .room-count-col .btn-group-body, #formShop #hotel .adult-count-col .btn-group-body, #formShop #hotel .child-count-col .btn-group-body, #formShop #hotel .children-col .btn-group-body, #formShop #hotel .city-col .btn-group-body, #formShop #hotel .hotel-col .btn-group-body, #formShop #hotel .persons-col .btn-group-body ").not(a).hide()}function displayAll(){$("#formShop #categoryInfo .btn-group-body").show(),$("#formShop #operatorSelection .btn-group-body").show(),$("#formShop #skipass .skiarea-col .btn-group-body").show(),$("#formShop #skipass .duration-col .btn-group-body").show(),$("#formShop .date-col .btn-group-body").show(),$("#formShop .persons-col .btn-group-body").show(),$("#formShop #bergbahn .type-col .btn-group-body").show(),$("#formShop #bergbahn .via-col .btn-group-body").show(),$("#formShop #bergbahn .origin-col .btn-group-body").show(),$("#formShop #bergbahn .destination-col .btn-group-body").show(),$("#formShop #bergbahn_epr .trainup-col .btn-group-body").show(),$("#formShop #bergbahn_epr .traindown-col .btn-group-body").show(),$("#formShop #bergbahn_epr .origin-col .btn-group-body").show(),$("#formShop #bergbahn_epr .destination-col .btn-group-body").show(),$("#formShop #railway_seat_reservation .contractor-col .btn-group-body").show(),$("#formShop #railway_seat_reservation .origin-col .btn-group-body").show(),$("#formShop #railway_seat_reservation .destination-col .btn-group-body").show(),$("#formShop #railway_seat_reservation .type-col .btn-group-body").show(),$("#formShop #railway_seat_reservation .catering-col .btn-group-body").show(),$("#formShop #railway_seat_reservation_timetable .contractor-col .btn-group-body").show(),$("#formShop #railway_seat_reservation_timetable .origin-col .btn-group-body").show(),$("#formShop #railway_seat_reservation_timetable .destination-col .btn-group-body").show(),$("#formShop #railway_seat_reservation_timetable .type-col .btn-group-body").show(),$("#formShop #railway_seat_reservation_timetable .catering-col .btn-group-body").show(),$("#formShop #railway_seat_reservation_mrag .contractor-col .btn-group-body").show(),$("#formShop #railway_seat_reservation_mrag .origin-col .btn-group-body").show(),$("#formShop #railway_seat_reservation_mrag .destination-col .btn-group-body").show(),$("#formShop #railway_seat_reservation_mrag .type-col .btn-group-body").show(),$("#formShop #railway_seat_reservation_mrag .catering-col .btn-group-body").show(),$("#formShop #bus .origin-col .btn-group-body").show(),$("#formShop #bus .busup-col .btn-group-body").show(),$("#formShop #bus .down-date-col .btn-group-body").show(),$("#formShop #bus .busdown-col .btn-group-body").show(),$("#formShop #bus .addon-col .btn-group-body").show(),$("#formShop #daytrips .bundle-col .btn-group-body").show(),$("#formShop #daytrips .addon-col .btn-group-body").show(),$("#formShop #localevent .region-col .btn-group-body").show(),$("#formShop #localevent .product-col .btn-group-body").show(),$("#formShop #localevent .type-col .btn-group-body").show(),$("#formShop #localevent .time-col .btn-group-body").show(),$("#formShop #specialevent .region-col .btn-group-body").show(),$("#formShop #specialevent .product-col .btn-group-body").show(),$("#formShop #specialevent .type-col .btn-group-body").show(),$("#formShop #specialevent .time-col .btn-group-body").show(),$("#formShop #hotel .region-col .btn-group-body").show(),$("#formShop #hotel .roomcategory-col .btn-group-body").show(),$("#formShop #hotel .arrival-date-col .btn-group-body").show(),$("#formShop #hotel .departure-date-col .btn-group-body").show(),$("#formShop #hotel .room-count-col .btn-group-body").show(),$("#formShop #hotel .adult-count-col .btn-group-body").show(),$("#formShop #hotel .child-count-col .btn-group-body").show(),$("#formShop #hotel .children-col .btn-group-body").show(),$("#formShop #hotel .city-col .btn-group-body").show(),$("#formShop #hotel .hotel-col .btn-group-body").show(),$("#formShop #hotel .persons-col .btn-group-body").show()}function parseCookie(){var a;console.log("Parse the play cookie to obtain the subject ..");for(var b=$.cookie("PLAY_SESSION"),c=b.substring(b.indexOf("-")+1),d=c.split("&"),e=0;e<d.length;e++)if(0==d[e].indexOf("subject")){var f=d[e].substring(d[e].indexOf("=")+1);a=JSON.parse(f)}else 0==d[e].indexOf("SESSIONID")&&(appSessionId=d[e].substring(d[e].indexOf("=")+1));console.log(a),subjectRoles=a.roles,subjectLocale=a.locale,subjectIdentifier=a.identifier,console.log("setting subjectLocale="+subjectLocale),null!=subjectLocale&&subjectLocale.length>2&&(subjectLang=subjectLocale.substr(0,2),console.log("setting subjectLang="+subjectLang))}function getOptionValue(a,b){for(var c=0;c<a.length;c++)if(a[c].key()==b)return a[c].value();return""}function getOption(a,b){for(var c=0;c<a.length;c++)if(a[c].key()==b)return a[c];return null}function getCategoryName(a,b){for(var c=0;c<a.length;c++)if(a[c].key()==b)return a[c].displayName();return b}function getCategoryInfo(a,b){return headerVM.categoryLabelsMap&&headerVM.categoryLabelsMap()[a.toLowerCase()]&&headerVM.categoryLabelsMap()[a.toLowerCase()].categoryLabel()?headerVM.categoryLabelsMap()[a.toLowerCase()].categoryLabel():a.toUpperCase()==CATEGORY_KEY_SKIPASS?i18n.t("category.skipass",{count:null!=b?b:1}):a.toUpperCase()==CATEGORY_KEY_BERGBAHN?i18n.t("category.bergbahn",{count:null!=b?b:1}):a.toUpperCase()==CATEGORY_KEY_CARGO?i18n.t("category.cargo",{count:null!=b?b:1}):a.toUpperCase()==CATEGORY_KEY_BERGBAHN_GROUP_RESERVATION?i18n.t("category.bergbahn",{count:null!=b?b:1}):a.toUpperCase()==CATEGORY_KEY_MENU?i18n.t("category.restaurant",{count:null!=b?b:1}):a.toUpperCase()==CATEGORY_KEY_DRINK?i18n.t("category.drink",{count:null!=b?b:1}):a.toUpperCase()==CATEGORY_KEY_PUBLICTRANSPORTATION?i18n.t("category.publictransportation",{count:null!=b?b:1}):a.toUpperCase()==CATEGORY_KEY_BERGBAHN_EPR?i18n.t("category.bergbahn_epr",{count:null!=b?b:1}):a.toUpperCase()==CATEGORY_KEY_RAILWAY_SEAT_RESERVATION?i18n.t("category.railway_seat_reservation",{count:null!=b?b:1}):a.toUpperCase()==CATEGORY_KEY_RAILWAY_SEAT_RESERVATION_TIMETABLE?i18n.t("category.railway_seat_reservation_timetable",{count:null!=b?b:1}):a.toUpperCase()==CATEGORY_KEY_RAILWAY_SEAT_RESERVATION_MRAG?i18n.t("category.railway_seat_reservation_mrag",{count:null!=b?b:1}):a.toUpperCase()==CATEGORY_KEY_BUS?i18n.t("category.bus",{count:null!=b?b:1}):a.toUpperCase()==CATEGORY_KEY_BUNDLE?i18n.t("category.bundle",{count:null!=b?b:1}):a.toUpperCase()==CATEGORY_KEY_ADDON?i18n.t("category.addon",{count:null!=b?b:1}):a.toUpperCase()==CATEGORY_KEY_CATERING?i18n.t("category.catering",{count:null!=b?b:1}):a.toUpperCase()==CATEGORY_KEY_LOCAL_EVENT?i18n.t("category.localevent",{count:null!=b?b:1}):a.toUpperCase()==CATEGORY_KEY_SPECIAL_EVENT?i18n.t("category.specialevent",{count:null!=b?b:1}):a.toUpperCase()==CATEGORY_KEY_DEPOT?i18n.t("category.depot",{count:null!=b?b:1}):a.toUpperCase()==CATEGORY_KEY_PARKING?i18n.t("category.parking",{count:null!=b?b:1}):a.toUpperCase()==CATEGORY_KEY_CARGO?i18n.t("category.cargo",{count:null!=b?b:1}):a.toUpperCase()==CATEGORY_KEY_AUTOVERLAD?i18n.t("category.autoverlad",{count:null!=b?b:1}):a.toUpperCase()==CATEGORY_KEY_RESTAURANT?i18n.t("category.restaurant",{count:null!=b?b:1}):"category not supported : "+a}function menuViewModel(){var a=this;a.isSalesAdmin=ko.observable(!1),a.isSalesCurrencyEdit=ko.observable(!1),a.isTourGuide=ko.observable(!1),a.isSales=ko.observable(!1),a.isAbacusExport=ko.observable(!1),a.hasCashDeskSale=ko.observable(!1),a.hasDriverInfo=ko.observable(!1),a.hasTourOperator=ko.observable(!1),a.hasAboPersonalisation=ko.observable(!1),a.hasAboAdditionalValues=ko.observable(!1),a.hasAbo=ko.observable(!1),a.hasAboSwapMedia=ko.observable(!1),a.hasRegistrationRights=ko.observable(!1),a.hasRegistrationReadOnlyRights=ko.observable(!1),a.hasRegistrationDiscardRights=ko.observable(!1),a.hasRegistrationNonMandatory=ko.observable(!1),a.hasPackageSellerRights=ko.observable(!1),a.hasPackageCustomerRights=ko.observable(!1),a.cartMode=ko.observable(),a.cartCallbackId=ko.observable(),a.timeIntervalDays=ko.observable(),a.dummyHotels=ko.observableArray([]),a.showMageOrderIncrId=ko.observable(!1),a.hasPaymentTypeStoreCredits=ko.observable(!1),a.hideNavigation=ko.observable(!0),a.registrationActive=ko.observable(!1),a.showExchangeRate=ko.observable(!0),a.navigationPointClicked=function(b,c){return c.target.parentElement&&"shop"==c.target.parentElement.id&&menuVM.cartMode(SHOPPING_CART_MODE_DEFAULT),a.registrationActive(c.target.parentElement&&"registration"===c.target.parentElement.id),a.showExchangeRate(!a.registrationActive()),$("ul.nav-bar > li.active").removeClass("active"),$(c.currentTarget).addClass("active",!0),$(window).width()<=767&&a.hideNavigation(!0),!0},a.backToPackagesOverview=function(){packagesVM&&packagesVM.backToOverview()},a.initRights=function(){console.log("Menu view model initialized");for(var b=subjectRoles,c=0;c<b.length;c++)b[c]===ROLE_SALES_ADMIN?a.isSalesAdmin(!0):b[c]===ROLE_SALES_CURRENCY_EDIT?a.isSalesCurrencyEdit(!0):b[c]===ROLE_SALES_TOURGUIDE?a.isTourGuide(!0):b[c]===ROLE_SALES?a.isSales(!0):b[c]===ROLE_ABACUS_EXPORT&&a.isAbacusExport(!0)};var b=function(a,b){try{$.ajax(serviceRootURL+"/general_config",{type:"GET",data:{key:a},dataType:"json",contentType:"application/json",success:function(a,c,d){b(a)},error:function(a,b,c){checkSession(a),console.log("Server error on loading dummy hotels: "+a.responseText),showError("Fehler beim Laden der dummy hotels",a,b,c)}})}catch(a){console.log("Exception on on loading dummy hotels: "+a),showException("Exception on on loading dummy hotels",a)}};a.initRights(),(a.isSalesAdmin()||a.isSales())&&(b(GENERAL_CONFIG_TYPES.MRAG_DUMMY_HOTELS,function(b){b.dummyHotels&&(console.log("Dummy Hotels found: ",b.dummyHotels),a.dummyHotels([]),b.dummyHotels.forEach(function(b){a.dummyHotels.push(b)}))}),b(GENERAL_CONFIG_TYPES.SHOW_MAGE_ORDER_ID,function(b){console.log("Show Mage Order Incr Id: ",b.showMageOrderIncrId),a.showMageOrderIncrId(b.showMageOrderIncrId)}))}function setLogoutUrl(a){logoutUrl=a}function setManualUrls(a,b){manualUrlHotel=a,manualUrlTO=b}function getManualUrlHotel(){return manualUrlHotel}function getManualUrlTO(){return manualUrlTO}function showError(a,b,c,d,e){console.log(a);try{if(null!=b)if(-1!=getErrorCode(b)){var f=$.parseJSON(b.responseText);if(null!=f&&null!=f.code)if("268435459"==f.code&&"security error - invalid session id"==f.message)window.location.replace(logoutUrl+"?logoutReason=268435459");else{var g=f.message+" (code: "+f.code+")";bootbox.alert({title:i18n.t("common.bootbox.error"),message:e?a+": "+g:g})}}else if(401==b.status)window.location.replace(logoutUrl+"?logoutReason=401");else{var h=a+":<br/>";h+=b.responseText,bootbox.alert({title:i18n.t("common.bootbox.internalServerError"),message:h})}else bootbox.alert({title:i18n.t("common.bootbox.error"),message:a})}catch(b){alert(a)}}function checkSession(a){return 401!=a.status&&403!=a.status}function showException(a,b){showError(a+": "+b)}function showInfo(a,b){b?bootbox.alert({title:"Info",message:a,callback:b}):bootbox.alert({title:"Info",message:a})}function showWarning(a,b){bootbox.alert({title:'<span class="glyphicon glyphicon-exclamation-sign warning"></span> '+i18n.t("common.bootbox.warning"),message:a}),b&&$(".bootbox-alert").find("div.modal-dialog").css("width",b)}function showQuestionOkCancel(a,b){bootbox.confirm({title:i18n.t("common.bootbox.question"),size:"small",message:a,callback:b})}function showQuestionYesNo(a,b){bootbox.confirm({title:i18n.t("common.bootbox.question"),size:"small",message:a,callback:b,buttons:{cancel:{label:i18n.t("common.bootbox.no")},confirm:{label:i18n.t("common.bootbox.yes")}}})}function getErrorCode(a){var b=-1;try{var c=$.parseJSON(a.responseText);null!=c&&null!=c.code&&(b=c.code)}catch(a){}return b}function isMac(){return console.log("navigator.platform="+navigator.platform),!!navigator.platform.match(/(Mac|iPhone|iPod|iPad)/i)}function luhn_checksum(a){for(var b=a.length,c=b%2,d=0,e=b-1;e>=0;e--){var f=parseInt(a.charAt(e));e%2==c&&(f*=2),f>9&&(f-=9),d+=f}return d%10}function isDTANumber(a){return/^([0-9]{2})-([0-9]{7,20})-([0-9]{1})$/.test(a)||/^([0-9]{2})-([0-9 ]{7,24})-([0-9]{1})$/.test(a)}function 
isDTANumberWithoutChecksum(a){return/^([0-9]{2})-([0-9]{7,20})-$/.test(a)||/^([0-9]{2})-([0-9 ]{7,24})-$/.test(a)}function appendDTANumberChecksum(a){var b=a.substr(0,3),c=a.substring(3,23),d=(10-luhn_checksum("1"+c+"0"))%10,e=b+c+"-"+d;console.log("appendDTANumberChecksum("+a+"), prefix="+b+", mediaId="+c+", checksum="+d+" returns "+e);var f=0==luhn_checksum("1"+c+d);return console.log("appendDTANumberChecksum validate result: "+f),e}function isSwisspassNumber(a){return/^([a-zA-Z0-9]{3})-([a-zA-Z0-9]{3})-([a-zA-Z0-9]{3})-([a-zA-Z0-9]{3})$/.test(a)||/^([a-zA-Z0-9]{12})$/.test(a)}function isAxessBackend(a){return null!=categoriesVM&&null!=categoriesVM.getCategory(a)&&null!=categoriesVM.getCategory(a).categoryModel()&&categoriesVM.getCategory(a).categoryModel().config().accessSystem==AXESS}function isSkidataBackend(a){return null!=categoriesVM&&null!=categoriesVM.getCategory(a)&&null!=categoriesVM.getCategory(a).categoryModel()&&categoriesVM.getCategory(a).categoryModel().config().accessSystem==SKIDATA}function submitForm(a,b,c,d){var e=$("<form></form>");switch(e.attr("id",d),b){case"get":
e.attr("method","get");break;case"post":default:e.attr("method","post")}e.attr("action",a),e.attr("style","display: none;");var f=function(a,b){if(_.isObject(b))$.each(b,function(b,c){f(a+"["+b+"]",c)});else if(_.isArray(b))$.each(b,function(b,c){f(a+"[]",c)});else{var c=$("<input />");c.attr("type","hidden"),c.attr("name",a),c.attr("value",b),e.append(c)}};$.each(c,function(a,b){f(a,b)}),$(document.body).append(e),e.submit()}function getPaymentResponseTitle(){return paymentTitle}function getPaymentResponseMessage(){return paymentMsg}function setPaymentResponse(a,b){paymentTitle=a,paymentMsg=b}function setTheme(a){theme=a}function setCurrency(a){currency(a),console.log("Currency set to ",a)}function setAppendSkidataChecksum(a){appendSkidataChecksum="true"==a,console.log("Setting appendSkidataChecksum to "+appendSkidataChecksum)}function isObservableArray(a){return ko.isObservable(a)&&!(void 0===a.destroyAll)}function isInt(a){return!isNaN(a)&&parseInt(Number(a))==a&&!isNaN(parseInt(a,10))}function debounce(a,b,c){var d;return function(){var e=this,f=arguments,g=function(){d=null,c||a.apply(e,f)},h=c&&!d;clearTimeout(d),d=setTimeout(g,b),h&&a.apply(e,f)}}function isBreakpoint(a){return $(".device-"+a).is(":visible")}function getMomentJsDateFormat(){var a="D.M.YYYY";return"dd.mm.yy"===DATE_PICKER_FORMAT?a="D.M.YYYY":"mm/dd/yy"===DATE_PICKER_FORMAT?a="M/D/YYYY":"dd/mm/yy"===DATE_PICKER_FORMAT&&(a="D/M/YYYY"),a}function changeUrl(a){var b="/"+a;window.history.pushState("data",document.title,b),document.title=title}function printerAdapter(a,b){var c=this;c.serverUrl=null!=a?a:"http://localhost:8085/PrinterService",c.timeout=b,c.getVersion=function(a){return $.ajax({url:c.serverUrl+"/getVersion",crossDomain:!0,type:"GET",data:"deviceNumber="+a,dataType:"json",contentType:"application/json",error:function(a,b,c){console.log("Server error on getting the version:\n"+a.responseText)}}).pipe(function(a){return a})},c.getConfig=function(){return $.ajax({url:c.serverUrl+"/getConfig",crossDomain:!0,type:"GET",data:"",dataType:"json",contentType:"application/json",error:function(a,b,c){showError("Fehler beim Laden der Printer Config",a,b,c)}}).pipe(function(a){return console.log("received config: "+JSON.stringify(a)),a})},c.getDeviceState=function(a){return $.ajax({url:c.serverUrl+"/getDeviceState",crossDomain:!0,type:"GET",data:"deviceNumber="+a,dataType:"json",contentType:"application/json",error:function(a,b,c){console.log("Server error on getting the device state:\n"+a.responseText)}}).pipe(function(a){return console.log("received device state: "+JSON.stringify(a)),a})},c.checkDeviceState=function(a){return $.ajax({url:c.serverUrl+"/getDeviceState",crossDomain:!0,type:"GET",data:"deviceNumber="+a,dataType:"json",contentType:"application/json"}).pipe(function(a){return console.log("received device state: "+JSON.stringify(a)),a})},c.readAndEjectTicket=function(a,b,d){return $.ajax({url:c.serverUrl+"/readAndEjectTicket?deviceNumber="+a+"&handFeed="+b+"&timeout="+c.timeout+"&sessionId="+d,crossDomain:!0,type:"POST",data:"",dataType:"json",contentType:"application/json",error:function(a,b,c){isPrinterSessionValid(a)&&(null!=a.responseJSON&&"1073741825"==a.responseJSON.code||showError("Fehler beim Lesen des Tickets",a,b,c))}}).pipe(function(a){return console.log("received ticket: "+JSON.stringify(a)),a})},c.feedTicket=function(a,b,d){return $.ajax({url:c.serverUrl+"/feedTicket?deviceNumber="+a+"&handFeed="+b+"&timeout="+c.timeout+"&sessionId="+d,crossDomain:!0,type:"POST",data:"",dataType:"json",contentType:"application/json",error:function(a,b,c){isPrinterSessionValid(a)&&showError("Fehler beim Einziehen des Tickets",a,b,c)}}).pipe(function(a){return console.log("received ticket: "+JSON.stringify(a)),a})},c.ejectTicket=function(a,b){return $.ajax({url:c.serverUrl+"/ejectTicket?deviceNumber="+a+"&sessionId="+b,crossDomain:!0,type:"POST",data:"",dataType:"json",contentType:"application/json",error:function(a,b,c){isPrinterSessionValid(a)&&showError("Fehler beim Ausgeben des Tickets",a,b,c)}}).pipe(function(a){return console.log("received result: "+JSON.stringify(a)),a})},c.printText=function(a,b){return $.ajax({url:c.serverUrl+"/printText?sessionId="+b,crossDomain:!0,type:"POST",data:JSON.stringify(a),dataType:"json",contentType:"application/json",error:function(a,b,c){isPrinterSessionValid(a)&&showError("Fehler beim optischen Ticketdruck",a,b,c)}}).pipe(function(a){return console.log("received result: "+JSON.stringify(a)),a})},c.codeAndPrint=function(a,b){return $.ajax({url:c.serverUrl+"/codeAndPrintText?sessionId="+b,crossDomain:!0,type:"POST",data:JSON.stringify(a),dataType:"json",contentType:"application/json",error:function(a,b,c){if(console.log("Fehler beim Codieren und optischem Ticketdruck"),isPrinterSessionValid(a)){return{codingOk:!1,printingOk:!1,message:a.responseJSON.message}}}}).pipe(function(a){return console.log("received result: "+JSON.stringify(a)),{codingOk:a.codingOk,printingOk:a.printingOk,message:a.executionInfo.message}})},c.printBarcode=function(a,b){return $.ajax({url:c.serverUrl+"/printBarcode?sessionId="+b,crossDomain:!0,type:"POST",data:JSON.stringify(a),dataType:"json",contentType:"application/json",error:function(a,b,c){if(console.log("Fehler beim Barcodedruck"),isPrinterSessionValid(a)){return{printingOk:!1,message:a.responseJSON.message}}}}).pipe(function(a){return console.log("received result: "+JSON.stringify(a)),{printingOk:a.printingOk,message:a.executionInfo.message}})},c.cleanPrintHead=function(a,b){return $.ajax({url:c.serverUrl+"/cleanPrintHead?deviceNumber="+a+"&timeout=10&sessionId="+b,crossDomain:!0,type:"POST",data:"",dataType:"json",contentType:"application/json",error:function(a,b,c){isPrinterSessionValid(a)&&showError("Fehler beim Reinigen des Druckkopfs",a,b,c)}}).pipe(function(a){return console.log("cleanPrintHead returns: "+JSON.stringify(a)),a})},c.cleanDriveRollers=function(a,b){return $.ajax({url:c.serverUrl+"/cleanDriveRollers?deviceNumber="+a+"&timeout="+c.timeout+"&sessionId="+b,crossDomain:!0,type:"POST",data:"",dataType:"json",contentType:"application/json",error:function(a,b,c){isPrinterSessionValid(a)&&showError("Fehler beim Reinigen der Druckerwalze",a,b,c)}}).pipe(function(a){return console.log("cleanDriveRollers returns: "+JSON.stringify(a)),a})},c.getType=function(){return"RFID"}}function isPrinterSessionValid(a){return null==a.responseJSON||"268435459"!=a.responseJSON.code||"security error - invalid session id"!=a.responseJSON.message||(showError("Druckerserver wurde für einen anderen Cashdesk gestartet. Bitte starten Sie ihn für den aktuellen Cashdesk neu"),!1)}function dummyPrinterAdapter(){var a=this;a.getVersion=function(b){return a.getVersionPromise().done(function(a){return a})},a.getConfig=function(){return $.ajax({url:a.serverUrl+"/getConfig",crossDomain:!0,type:"GET",data:"",dataType:"json",contentType:"application/json",error:function(a,b,c){showError("Fehler beim Laden der Printer Config",a,b,c)}}).pipe(function(a){return console.log("received config: "+JSON.stringify(a)),a})},a.getDeviceState=function(b){return $.ajax({url:a.serverUrl+"/getDeviceState",crossDomain:!0,type:"GET",data:"deviceNumber="+b,dataType:"json",contentType:"application/json",error:function(a,b,c){showError("Fehler beim Laden des Printer Status",a,b,c)}}).pipe(function(a){return console.log("received device state: "+JSON.stringify(a)),a})},a.checkDeviceState=function(b){return a.deviceStatePromise().done(function(a){return console.log("received state: "+JSON.stringify(a)),a})},a.readAndEjectTicket=function(b,c,d){return a.ticketPromise().done(function(a){return a})},a.feedTicket=function(b,c,d){return a.ticketPromise().done(function(a){return a})},a.ejectTicket=function(b,c){return a.executionResultPromise().done(function(a){return console.log("received result: "+JSON.stringify(a)),a})},a.printText=function(b,c){return a.executionResultPromise().done(function(a){return console.log("received result: "+JSON.stringify(a)),a})},a.codeAndPrint=function(b,c){return a.codingResultPromise().done(function(a){return console.log("received result: "+JSON.stringify(a)),{codingOk:a.codingOk,printingOk:a.printingOk,message:a.executionInfo.message}})},a.printBarcode=function(b,c){return a.printBarcodeResultPromise().done(function(a){return console.log("received result: "+JSON.stringify(a)),{printingOk:a.printingOk,message:a.executionInfo.message}})},a.cleanPrintHead=function(b,c){return a.executionResultPromise().done(function(a){return console.log("received result: "+JSON.stringify(a)),a})},a.cleanDriveRollers=function(b,c){return a.executionResultPromise().done(function(a){return console.log("received result: "+JSON.stringify(a)),a})},a.getVersionPromise=function(){var a={executionInfo:{code:0,execTime:120,message:"OK!"},firmwareVersion:"[SM021414]",serialNumber:"[9FF8016]",serverVersion:"[10,4,15,03]"},b=$.Deferred();return b.resolve(a),b.promise()},a.ticketPromise=function(){var a={executionInfo:{code:0,execTime:3191,message:"OK!",originalMessage:";nError=0x00000000;szError=OK!;szMediaID=E0040108008D3AAF;nDTType=3;nProjNr=980;nVers=2;nSSC=122;nPhysType=4;szChipID=31488D00;nDTChipType=37;nDTSize=316;nDSF=2;nMediaName=5356744;nManufacturerCode=23;nPackageCode=1;nCoatingCode=0;nCardFlags=0;arSegList=/7A495003-000000000000000000000000/7A425302-02EC3102F0600A21BF735D253E840D2CAF85C5252F00000000000000000000000000000000000000/7A425303-02128202F00000000000000000000000000000000000000000000000000000000000000000000000/7A434F00-00800100001800200000000000000000000000000000000000000000000000000000000000000000/7A484408-FFFFFFFF000000000000000000000000000000000000000000000000000000000000000000000000;nExecTime=3770"},chipId:"489D1624",chipSize:112,chipType:10,mediaId:"E0040108008D3AAF",physicalType:31,projectNr:980,dsf:2,segmentList:"/7A495003-000000000000000000000000/7A425302-02EC3102F0600A21BF735D253E840D2CAF85C5252F00000000000000000000000000000000000000/7A425303-02128202F00000000000000000000000000000000000000000000000000000000000000000000000/7A434F00-00800100001800200000000000000000000000000000000000000000000000000000000000000000/7A484408-FFFFFFFF000000000000000000000000000000000000000000000000000000000000000000000000"},b=$.Deferred();return b.resolve(a),b.promise()},a.executionResultPromise=function(){var a={executionInfo:{code:0,execTime:281,message:"OK!"}},b=$.Deferred();return b.resolve(a),b.promise()},a.codingResultPromise=function(){var a={executionInfo:{code:0,execTime:281,message:"OK!"},codingOk:!0,printingOk:!0},b=$.Deferred();return b.resolve(a),b.promise()},a.printBarcodeResultPromise=function(){var a={executionInfo:{code:"0",execTime:"4670",message:"Printing OK!",originalMessage:";nError=0x00000000;szError=Printing OK!;szBCData=812856400655606328835616;nExecTime=4670"},codingOk:"false",printingOk:"true"},b=$.Deferred();return b.resolve(a),b.promise()},a.getType=function(){return"DUMMY"},a.deviceStatePromise=function(){var a={executionInfo:{code:"512",execTime:"94",message:"Device found!",originalMessage:";nError=0x00000200;szError=Device found!;nCodingRes=1;nPrintRes=1;nSynDB=0;bPSFront=0;bPSPrint=0;bPSBack=0;bPSStackFilled=0;nStoredPEO=0;nExecTime=94"}},b=$.Deferred();return b.resolve(a),b.promise()}}function initHalAdapter(a,b){if("DUMMY"==a)console.log("initHalAdapter for dummyAdapter"),halAD=new dummyHalAdapter;else{var c="http://"+a+":"+b+"/HalService";console.log("initHalAdapter with url:"+c),halAD=new halAdapter(c)}return halAD}function getHalAdapter(){return null==halAD&&(halAD=new dummyHalAdapter),halAD}function readHalConfig(){return console.log("readHalConfig started"),$.getJSON(serviceRootURL+"/cashdesk").fail(function(a,b,c){showError("Fehler beim Laden des aktuellen Cash Desk",a,b,c)}).pipe(function(a){var b="DUMMY",c="8085";if($.each(a.printers,function(a,d){"RFID"==d.type&&1==d.local&&(b=d.server,c=d.port)}),"DUMMY"!=b){var d="http://"+b+":"+c+"/HalService";console.log("readHalConfig returned halAdapter with url:"+d),null==halAD?halAD=new halAdapter(d):"DUMMY"==halAD.getType()&&(console.log("start real halAdapter because previous adapter was the dummy adapter"),halAD=new halAdapter(d))}else console.log("readHalConfig returned dummy halAdapter"),null==halAD?halAD=new dummyHalAdapter:"REAL"==printerAD.getType()&&(console.log("start dummy halAdapter because previous adapter was the real adapter"),halAD=new dummyHalAdapter);return b})}function halAdapter(a){var b=this;b.serverUrl=null!=a?a:"http://localhost:8085/HalService",b.getVersion=function(){return $.ajax({url:b.serverUrl+"/getVersion",crossDomain:!0,type:"GET",data:"",dataType:"json",contentType:"text/plain",error:function(a,b,c){console.log("Server error on getting the version:\n"+a.responseText)}}).pipe(function(a){return a})},b.downloadAndStartServer=function(){window.location.replace("assets/halserver/halserver.jnlp")},b.readInstalledVersion=function(){return $.ajax({url:"assets/halserver/PeakConfig.properties",beforeSend:function(a){a.overrideMimeType("text/plain")},type:"GET",data:"",error:function(a,b,c){showError("Fehler beim Lesen der installierten Version",a,b,c)}}).pipe(function(a){console.log("Read installed version: "+a);var c=b.parseData(a),d=c["peak.product.version"],e=c["peak.product.build"],f=d+" ("+e+")";return console.log("Read installed version: "+f),f})},b.shutdownServer=function(){return $.ajax({url:b.serverUrl+"/shutdownServer",crossDomain:!0,type:"GET",data:"",dataType:"text",contentType:"text/plain",error:function(a,b,c){}})},b.getType=function(){return"REAL"},b.parseData=function(a){for(var b=a.split(/\n/),c=/(\\u.{4})/gi,d={},e=0;e<b.length;e++)if(b[e]=b[e].replace(/^\s\s*/,"").replace(/\s\s*$/,""),b[e].length>0&&"#"!=b[e].match("^#")){var f=b[e].split("=");if(f.length>0){for(var g=unescape(f[0]).replace(/^\s\s*/,"").replace(/\s\s*$/,""),h=1==f.length?"":f[1];"\\"==h.match(/\\$/);)h=h.substring(0,h.length-1),h+=b[++e].replace(/\s\s*$/,"");for(var i=2;i<f.length;i++)h+="="+f[i];h=h.replace(/^\s\s*/,"").replace(/\s\s*$/,"");var j=h.match(c);if(j)for(var k=0;k<j.length;k++)h=h.replace(j[k],unescapeUnicode(j[k]));d[g]=h}}return d}}function dummyHalAdapter(){var a=this;a.getVersion=function(b){return a.getVersionPromise().pipe(function(a){return a})},a.readInstalledVersion=function(){return a.getVersionPromise().pipe(function(a){return console.log("installed version: "+JSON.stringify(a)),a.productVersion+" ("+a.productBuild+")"})},a.downloadAndStartServer=function(){return a.emptyResultPromise().pipe(function(a){return console.log("received result: "+a),a})},a.shutdownServer=function(){return a.emptyResultPromise().pipe(function(a){return console.log("received result: "+a),a})},a.getType=function(){return"DUMMY"},a.getVersionPromise=function(){var a={productBuild:"0",productVersion:"0.0.0"},b=$.Deferred();return b.resolve(a),b.promise()},a.emptyResultPromise=function(){var a=$.Deferred();return a.resolve("OK"),a.promise()}}function getAuditLogAdapter(){return null==auditLogAD&&(auditLogAD=new auditLogAdapter),auditLogAD}function auditLogAdapter(){this.writeLog=function(a,b,c,d){var e="?action="+a;return null!=b&&(e+="&ticketMediaId="+b),null!=c&&(e+="&externalMediaId="+c),console.log("write auditlog with params: "+e),$.ajax({url:serviceRootURL+"/write_audit_log"+e,type:"POST",data:null!=d?JSON.stringify(d):"",dataType:"json",contentType:null!=d?"application/json":"text/plain",error:function(a,b,c){showError("Fehler beim Audit Log Speichern",a,b,c)}}).pipe(function(a){return console.log("received auditlog result: "+JSON.stringify(a)),a})}}function setAllowedDsfIds(){null!=arguments&&arguments.length>0&&
(printerAllowedDsfIds=arguments)}function validateDsf(a){var b=!1;for(i=0;i<printerAllowedDsfIds.length;i++){if(a==printerAllowedDsfIds[i]){b=!0;break}}return b}function initPrinterAdapter(a,b,c){if("DUMMY"==a)console.log("initPrinterAdapter for dummyAdapter"),printerAD=new dummyPrinterAdapter;else{var d="http://"+a+":"+b+"/PrinterService";console.log("initPrinterAdapter with url:"+d+", timeout = "+c),printerAD=new printerAdapter(d,c)}return printerAD}function getPrinterAdapter(){return null==printerAD&&(printerAD=new dummyPrinterAdapter),printerAD}function readPrinterConfig(){return console.log("readPrinterConfig started"),$.getJSON(serviceRootURL+"/cashdesk").fail(function(a,b,c){showError("Fehler beim Laden des aktuellen Cash Desk",a,b,c)}).pipe(function(a){var b="DUMMY",c="8085";if($.each(a.printers,function(a,d){"RFID"==d.type&&1==d.local&&(b=d.server,c=d.port)}),"DUMMY"!=b){var d="http://"+b+":"+c+"/PrinterService";console.log("readPrinterConfig returned real printerAdapter withr url:"+d),null==printerAD?printerAD=new printerAdapter(d):"DUMMY"==printerAD.getType()&&(console.log("start real printerAdapter because previous adapter was the dummy adapter"),printerAD=new printerAdapter(d))}else console.log("readPrinterConfig returned dummy printerAdapter"),null==printerAD?printerAD=new dummyPrinterAdapter:"RFID"==printerAD.getType()&&(console.log("start dummy printerAdapter because previous adapter was the real adapter"),printerAD=new dummyPrinterAdapter);return b})}function printerGetMediaId(){console.log("printerGetMediaId -- ");var a=getSessionId();return getPrinterAdapter().readAndEjectTicket(headerVM.CurrentPrinter().deviceNumber(),!0,a).pipe(function(a){console.log("received ticket info: "+JSON.stringify(a));var b=!0;return-1!=a.projectNr&&validateDsf(a.dsf)||(console.log("invalid ticket read. projectNr =  "+a.projectNr+", dsf = "+a.dsf),b=!1),{valid:b,mediaId:a.mediaId,projectNumber:a.projectNr,originalMessage:a.executionInfo.originalMessage}})}function printerFeedTicket(a){console.log("printerFeedTicket -- ");var b=getSessionId();return getPrinterAdapter().feedTicket(headerVM.CurrentPrinter().deviceNumber(),headerVM.CurrentPrinter().isHandFeed(a),b).pipe(function(a){console.log("received ticket info: "+JSON.stringify(a));var b=!0;return-1!=a.projectNr&&validateDsf(a.dsf)||(console.log("invalid ticket read. projectNr =  "+a.projectNr+", dsf = "+a.dsf),b=!1),{valid:b,mediaId:a.mediaId,projectNumber:a.projectNr,originalMessage:a.executionInfo.originalMessage}})}function printerEjectTicket(){console.log("printerEjectTicket -- ");var a=getSessionId();return getPrinterAdapter().ejectTicket(headerVM.CurrentPrinter().deviceNumber(),a).pipe(function(a){return console.log("received result: "+JSON.stringify(a)),a})}function printerPrintAndEjectSkiTicket(a,b,c){var d={deviceNumber:headerVM.CurrentPrinter().deviceNumber(),handFeed:!1,lines:[{dir:"P",font:"2H",leftBound:!0,posX:4,posY:500,text:a.price().region()},{dir:"P",font:"2H",leftBound:!0,posX:4,posY:600,text:a.price().duration()},{dir:"P",font:"2H",leftBound:!0,posX:4,posY:700,text:a.price().consumer()},{dir:"P",font:"2H",leftBound:!0,posX:4,posY:800,text:a.price().date()},{dir:"P",font:"2H",leftBound:!0,posX:4,posY:900,text:b}],ticketType:3};console.log("printerPrintAndEjectTicket -- ");var e=getSessionId();return getPrinterAdapter().printText(d,e).pipe(function(a){return console.log("received result: "+JSON.stringify(a)),getAuditLogAdapter().writeLog(TICKET_PRINTED,c,b,d),a})}function printerCodeAndPrintSkiTicket(a,b,c,d,e){try{var f=a.permissionCode,g=a.segments,h=a.amount,i=b.printData}catch(a){throw new Error("Invalid/Incomplete printing and coding data provided")}var j={amount:h,codingDataPermissionCode:f,codingDataSegments:g,deviceNumber:headerVM.CurrentPrinter().deviceNumber(),handFeed:!1,printData:i,readData:c,ticketType:3};console.log("printerCodeAndPrintSkiTicket -- ");var k=getSessionId();return getAuditLogAdapter().writeLog(TICKET_PREPARE_CODING,d,e,j),getPrinterAdapter().codeAndPrint(j,k).pipe(function(a){return console.log("received result: "+JSON.stringify(a)),getAuditLogAdapter().writeLog(TICKET_CODED,d,e,j),a})}function printerPrintBarcodeTicket(a,b){try{var c=b.printData}catch(a){throw new Error("Invalid/Incomplete printing data provided")}var d={printData:c,deviceNumber:headerVM.CurrentPrinter().deviceNumber(),handFeed:headerVM.CurrentPrinter().isHandFeed(a),ticketType:0,flipBarcode:0,peo:100};console.log("printerPrintBarcodeTicket -- ");var e=getSessionId();return getAuditLogAdapter().writeLog(TICKET_PREPARE_PRINTING,null,null,c),getPrinterAdapter().printBarcode(d,e).pipe(function(a){return console.log("received result: "+JSON.stringify(a)),getAuditLogAdapter().writeLog(TICKET_CODED,null,null,c),a})}function checkPrinterState(){return getPrinterAdapter().checkDeviceState(headerVM.CurrentPrinter().deviceNumber()).pipe(function(a){return console.log("printer is active"),a})}function cleanPrintHead(){console.log("cleanPrintHead -- ");var a=getSessionId();return getPrinterAdapter().cleanPrintHead(headerVM.CurrentPrinter().deviceNumber(),a).pipe(function(a){console.log("cleanPrintHead done")})}function cleanDriveRollers(){console.log("cleanDriveRollers -- ");var a=getSessionId();return getPrinterAdapter().cleanDriveRollers(headerVM.CurrentPrinter().deviceNumber(),a).pipe(function(a){console.log("cleanDriveRollers done")})}function getSessionId(){return appSessionId}function categoryLabelModel(a){this.id=ko.observable(a.id),this.key=ko.observable(a.key),this.categoryLabel=ko.observable(a.categoryLabel),this.categoryMenuLabel=ko.observable(a.categoryMenuLabel),this.categoryShortLabel=ko.observable(a.categoryShortLabel),this.categoryUseTicketLabel=ko.observable(a.categoryUseTicketLabel)}function exchangeRateModel(a){this.id=ko.observable(a.id),this.name=ko.observable(a.name),this.rate=ko.observable(a.rate)}function creditCardModel(a){this.id=ko.observable(a.id),this.pmethod=ko.observable(a.pmethod),this.maskedCC=ko.observable(a.maskedCC),this.expm=ko.observable(a.expm),this.expy=ko.observable(a.expy),this.preferred=ko.observable(a.preferred),this.isValid=ko.observable(a.isValid),this.isDeleteClicked=ko.observable(!1);var b=this;this.deleteCreditCard=function(){b.isDeleteClicked(!0)},this.cancelDeleteCreditCard=function(){b.isDeleteClicked(!1)}}function partnerModel(a){this.id=ko.observable(a.id),this.name=ko.observable(a.name),this.preselect=ko.observable(a.preselect)}function tourguideModel(a){var b=this;this.id=ko.observable(a.id),this.firstname=ko.observable(a.firstname),this.lastname=ko.observable(a.lastname),this.username=ko.observable(a.username),this.email=ko.observable(a.email),this.phone=ko.observable(a.phone),this.changedatepwd=ko.observable(a.changedatepwd),this.locale=ko.observable(a.locale),this.forwardTypeOptions=ko.observableArray([{key:FORWARD_ORDER_FORWARD_TYPE_EMAIL,name:"E-Mail ("+this.email()+")"},{key:FORWARD_ORDER_FORWARD_TYPE_SYSTEM,name:"System"}]),this.displayName=ko.computed(function(){var a=[];return a.push(b.lastname()),a.push(b.firstname()),a.join(" ")}),this.optionValue=ko.observable(a.id),this.optionText=ko.observable(this.displayName())}function expertModel(a){this.id=ko.observable(a.id),this.firstname=ko.observable(a.firstname),this.lastname=ko.observable(a.lastname),this.username=ko.observable(a.username),this.email=ko.observable(a.email),this.changedatepwd=ko.observable(a.changedatepwd),this.locale=ko.observable(a.locale),this.travelDateMax=ko.observable(a.travelDateMax),this.groupSizeMin=ko.observable(a.groupSizeMin),this.noShow=ko.observable(a.noShow),this.updateSurcharge=ko.observable(a.updateSurcharge),this.displayName=this.firstname()+" "+this.lastname(),this.isReseller=a.isReseller}function storeCreditHistoryModel(a){this.id=ko.observable(a.id),this.action=ko.observable(a.action),this.updatedAt=ko.observable(a.updatedAt),this.orderState=ko.observable(a.orderState),this.balanceDelta=ko.observable(a.balanceDelta),this.balanceAmount=ko.observable(a.balanceAmount),this.comment=ko.observable(a.comment),this.cashDeskOrderId=ko.observable(a.cashDeskOrderId),this.cashDeskOrderIdDisplay=null!=this.cashDeskOrderId()&&""!=this.cashDeskOrderId()?"#"+this.cashDeskOrderId():""}function optionCargoFavoritesModel(a){this.id=ko.observable(a.id),this.key=ko.observable(a.name),this.value=ko.observable(a.name),this.dataModel=ko.observable(a.dataModel),this.optionValue=ko.observable(a.id),this.optionText=ko.observable(a.name)}function optionModel(a){this.id=ko.observable(a.id),this.key=ko.observable(a.key),this.value=ko.observable(a.localizedValue),this.isEmptyOption=ko.observable(null!=a.isEmptyOption&&a.isEmptyOption),this.additionalInfo=ko.observable(a.additionalInfo),this.hidden=ko.observable(a.hidden),this.background=ko.observable(!!a.background&&a.background),this.optionValue=ko.observable(a.key),this.optionText=ko.observable(a.localizedValue)}function compareOptions(a,b){return a.value()>b.value()?1:-1}function consumerOptionModel(a){var b=this;ko.utils.extend(b,new optionModel(a)),this.consumerName=ko.observable(),this.consumerDescr=ko.observable();var c=this.value().indexOf(" ");c>1?(this.consumerName(this.value().substring(0,c)),this.consumerDescr(this.value().substring(c))):(this.consumerName(this.value()),this.consumerDescr(""))}function skiRegionOptionModel(a){var b=this;ko.utils.extend(b,new optionModel(a));var c=$.map(a.localizedOptions.consumer,function(a){return new optionModel(a)});this.consumer=ko.observableArray(c);var d=$.map(a.localizedOptions.types,function(a){return new optionModel(a)});this.durations=ko.observableArray(d)}function localEventTicketTypeModel(a){var b=this;if(b.id=ko.observable(a.id),b.key=ko.observable(a.key),b.localizedValue=ko.observable(a.localizedValue),b.availableCategories=ko.observableArray(),b.contingent=ko.observable(),b.available=ko.observable(),null!=a.localizedOptions){var c=$.map(a.localizedOptions.categories,function(a){return new localEventCategoryModel(a,b)});b.availableCategories(c)}b.additionalInfo=ko.computed(function(){for(var a=0;a<b.availableCategories().length;a++){var c=b.availableCategories()[a];if(c.additionalInfo()&&(null!=c.additionalInfo().bergbahnValidFrom||null!=c.additionalInfo().bergbahnValidTo))return console.log("Using category additional info for type restriction",c.additionalInfo(),b.key()),c.additionalInfo()}return null})}function localEventCategoryModel(a,b){var c=this;c.id=ko.observable(a.id),c.key=ko.observable(a.key),c.localizedValue=ko.observable(a.localizedValue),c.price=ko.observable(),c.available=ko.observable(null),c.additionalInfo=ko.observable(a.additionalInfo),c.productContingent=ko.observable(a.additionalInfo.eventContingentQuantity),c.availableContingent=ko.computed(function(){var a=null;return null==c.available()&&null==b.contingent()?a=100:c.available()>0&&0==b.contingent()?a=100:null!=c.available()&&b.contingent()>0?a=10*Math.ceil(c.available()/b.contingent()*10):-1==c.available()?(c.available(null),a=null):0==b.contingent()&&(a=0),a}),c.contingentText=ko.computed(function(){if(null!=c.available()&&c.available()>0)return c.available()+" / "+b.contingent()}),c.getLocalEventContingentTooltipTemplate=ko.computed(function(){return"<p>"+c.available()+"</p>"})}function createHtmlTooltip(a,b,c){if(null==b&&(null==c||-1!=c.indexOf("no_selection")))return null;var d="";return d+="<h3>"+a+"</h3>",b&&(d+="<p>"+b+"</p>"),c&&-1==c.indexOf("no_selection")&&(d+='<img width="800" class="local-event-tooltip-image" src="'+c+'"/>'),d}function localEventModel(a){var b=this;this.id=ko.observable(a.id),this.key=ko.observable(a.key),this.localizedValue=ko.observable(a.localizedValue),this.additionalInfo=ko.observable(a.additionalInfo);var c=$.map(a.localizedOptions.ticketTypes,function(a){return new localEventTicketTypeModel(a)});b.tooltip=ko.observable(createHtmlTooltip(b.localizedValue(),b.additionalInfo()?b.additionalInfo().description:"No description",b.additionalInfo()?b.additionalInfo().image:null)),b.availableTypes=ko.observableArray(c),b.description=ko.observable()}function stationOptionModel(a,b){var c=this;ko.utils.extend(c,new optionModel(a)),this.stationType=ko.observable(b)}function bergbahnTypeOptionModel(a){var b=this;ko.utils.extend(b,new optionModel(a)),this.classKey=ko.observable(a.additionalInfo.class_key),this.tripTypeKey=ko.observable(a.additionalInfo.trip_type_key),!0===a.additionalInfo.isPrestigeClass&&"E"===this.classKey()?this.className=ko.observable(i18n.t("bergbahn.bergbahn-class.P")):this.className=ko.observable(i18n.t("bergbahn.bergbahn-class."+this.classKey())),this.tripTypeName=ko.observable(i18n.t("bergbahn.bergbahn-tripType."+this.tripTypeKey())),this.supportedRoutes=ko.observable(a.additionalInfo.supported_routes),b.isFromStationSupported=function(a){if(null!=b.supportedRoutes()){return null!=ko.utils.arrayFirst(b.supportedRoutes(),function(b){return b.from_key==a})}return!0},b.isToStationSupported=function(a,c){if(null!=b.supportedRoutes()){return null!=ko.utils.arrayFirst(b.supportedRoutes(),function(b){return b.from_key==a&&b.to_key==c})}return!0}}function bergbahnViaOptionModel(a){var b=this;ko.utils.extend(b,new optionModel(a)),this.fromKey=ko.observable(a.additionalInfo?a.additionalInfo.from_key:null),this.toKey=ko.observable(a.additionalInfo?a.additionalInfo.to_key:null),this.additionalInfo=ko.observable(a.additionalInfo),this.displayName=ko.observable(""==b.value()?i18n.t("bergbahn.bergbahn-via-option.direct"):b.value())}function bergbahnEprRouteOptionModel(a){var b=this;ko.utils.extend(b,new optionModel(a));var c=this.key().split(".");if(b.fromKey=ko.observable(c[c.length-2]),b.toKey=ko.observable(c[c.length-1]),b.trainsUpTraditional=ko.observableArray([]),b.trainsDownTraditional=ko.observableArray([]),b.trainsUpVbahn=ko.observableArray([]),b.trainsDownVbahn=ko.observableArray([]),null!=a.localizedOptions){if(a.localizedOptions.trainsUpTraditional){var d=$.map(a.localizedOptions.trainsUpTraditional,function(a){return new bergbahnEprTrainOptionModel(a)});this.trainsUpTraditional(d)}if(a.localizedOptions.trainsDownTraditional){var e=$.map(a.localizedOptions.trainsDownTraditional,function(a){return new bergbahnEprTrainOptionModel(a)});this.trainsDownTraditional(e)}if(a.localizedOptions.trainsUpVbahn){var e=$.map(a.localizedOptions.trainsUpVbahn,function(a){return new bergbahnEprTrainOptionModel(a)});this.trainsUpVbahn(e)}if(a.localizedOptions.trainsDownVbahn){var e=$.map(a.localizedOptions.trainsDownVbahn,function(a){return new bergbahnEprTrainOptionModel(a)});this.trainsDownVbahn(e)}}b.availableOutwardTrainTypes=ko.computed(function(){return null!=b.additionalInfo().outwardTraditionalAddonId&&null!=b.additionalInfo().outwardVbahnAddonId?[{key:ko.observable(BERGBAHN_TRAIN_TYPE_TRADITIONAL),value:ko.observable(i18n.t("checkout.epr.traditional")),addonId:b.additionalInfo().outwardTraditionalAddonId},{key:ko.observable(BERGBAHN_TRAIN_TYPE_VBAHN),value:ko.observable(i18n.t("checkout.epr.vBahn")),addonId:b.additionalInfo().outwardVbahnAddonId}]:null!=b.additionalInfo().outwardTraditionalAddonId?[{key:ko.observable(BERGBAHN_TRAIN_TYPE_TRADITIONAL),value:ko.observable(i18n.t("checkout.epr.traditional")),addonId:b.additionalInfo().outwardTraditionalAddonId}]:[]}),b.availableReturnTrainTypes=ko.computed(function(){return null!=b.additionalInfo().returnTraditionalAddonId&&null!=b.additionalInfo().returnVbahnAddonId?[{key:ko.observable(BERGBAHN_TRAIN_TYPE_TRADITIONAL),value:ko.observable(i18n.t("checkout.epr.traditional")),addonId:b.additionalInfo().returnTraditionalAddonId},{key:ko.observable(BERGBAHN_TRAIN_TYPE_VBAHN),value:ko.observable(i18n.t("checkout.epr.vBahn")),addonId:b.additionalInfo().returnVbahnAddonId}]:null!=b.additionalInfo().returnTraditionalAddonId?[{key:ko.observable(BERGBAHN_TRAIN_TYPE_TRADITIONAL),value:ko.observable(i18n.t("checkout.epr.traditional")),addonId:b.additionalInfo().returnTraditionalAddonId}]:[]}),console.log("bergbahnEprRouteOptionModel",a,b)}function bergbahnEprTrainOptionModel(a){var b=this;ko.utils.extend(b,new optionModel(a)),b.deptime=ko.observable(a.additionalInfo.deptime),b.arrtime=ko.observable(a.additionalInfo.arrtime),b.campaign=ko.observable(parseInt(a.additionalInfo.campaign)),b.trainNumber=ko.observable(a.key),b.contingent=ko.observable(),b.displayValue=ko.observable(this.deptime()+" ("+this.arrtime()+" "+i18n.t("shop.bergbahnEpr.arrival")+")"),
b.disabled=ko.observable(!1),b.reservationStatus=ko.computed(function(){return b.contingent()?0===b.contingent().contingent()?null:b.contingent().contingentPercent():null}),b.freeSeatsDisplayText=ko.computed(function(){var a="";return b.contingent()&&b.contingent().status()>0&&(a=b.contingent().freeSeats()+" / "+b.contingent().contingent()),a}),b.displayValueNew=ko.observable(this.deptime()+" - "+this.arrtime()+" "+b.freeSeatsDisplayText()),b.available=ko.computed(function(){return null!==b.reservationStatus()&&b.reservationStatus()>0&&!b.disabled()})}function bergbahnGroupReservationStationOptionModel(a){var b=this;ko.utils.extend(b,new optionModel(a)),this.shortName=ko.observable(a.additionalInfo?a.additionalInfo.short_name:null)}function bergbahnGroupReservationPresetOptionModel(a){var b=this;ko.utils.extend(b,new optionModel(a)),b.additionalInfo(a.additionalInfo)}function bergbahnGroupTravelAgencyOptionModel(a){var b=this;b.city=ko.observable(a.city),b.country=ko.observable(a.country),b.email=ko.observable(a.email),b.id=ko.observable(a.id),b.locale=ko.observable(a.locale),b.name=ko.observable(a.name),b.partnerId=ko.observable(a.partnerId),b.street=ko.observable(a.street),b.streetNumber=ko.observable(a.streetNumber),b.zipCode=ko.observable(a.zipCode)}function bergbahnGroupContactPartnerOptionModel(a){var b=this;b.email=ko.observable(a.email),b.firstname=ko.observable(a.firstname),b.id=ko.observable(a.id),b.lastname=ko.observable(a.lastname),b.partnerId=ko.observable(a.partnerId),b.gender=ko.observable(a.gender),b.displaySalutation=ko.computed(function(){var a=_.find((new abstractPersonalizationViewModel).optionsSalutation(),{key:b.gender()});return kp.get(a,"name")}),b.name=a.firstname+" "+a.lastname}function bergbahnGroupReservationRestaurantOptionModel(a){var b=this;ko.utils.extend(b,new optionModel(a)),b.menuEntries=ko.observableArray(a.localizedOptions?a.localizedOptions.menus:[]),b.menuVegetarianEntries=ko.observableArray(a.localizedOptions?a.localizedOptions.menusVegetarian:[])}function bergbahnGroupReservationRestaurantMenuOptionModelNew(a){var b=this;ko.utils.extend(b,new optionModel(a));var c=ko.observableArray(a.localizedOptions?a.localizedOptions.addons:[]),d=$.map(c(),function(a){return new optionModel(a)});b.addons=ko.observableArray(d)}function bergbahnGroupReservationTextGroupOptionModel(a){var b=this;ko.utils.extend(b,new optionModel(a)),b.texts=ko.observableArray([])}function bergbahnGroupReservationRestaurantMenuOptionModel(a){var b=this;ko.utils.extend(b,new optionModel(a)),b.vegetarianId=ko.observable(_.get(a,"additionalInfo.vegetarian_id",!1)),b.optionText=ko.observable(a.localizedValue+" - ("+_.get(a,"additionalInfo.code")+")"),b.description=ko.observable(_.get(a,"additionalInfo.description",!1))}function bergbahnGroupReservationBergbahnTariffOptionModel(a){var b=this;ko.utils.extend(b,new optionModel(a)),b.ticketTypes=ko.observableArray([])}function daytripsGroupReservationTariffOptionModel(a){var b=this;ko.utils.extend(b,new optionModel(a)),b.bundles=ko.observableArray([])}function bergbahnGroupReservationBergbahnTicketTypeOptionModel(a){var b=this;ko.utils.extend(b,new optionModel(a)),b.tariffType=ko.observable()}function daytripsGroupReservationDaytripsTicketTypeOptionModel(a,b){var c=this;ko.utils.extend(c,new daytripsOptionModel(a)),c.tariffType=ko.observable(),c.localizedOptions=ko.observable(a.localizedOptions),c.additionalInfo(a.additionalInfo);var d=b.key().split(".");c.fromKey=ko.observable(d[0]),c.toKey=ko.observable(d[1]),c.via=ko.observable(b)}function bergbahnGroupReservationTourOperatorOptionModel(a){var b=this;a.key=a.id,a.localizedValue=a.name,ko.utils.extend(b,new optionModel(a)),this.shortName=ko.observable(""),this.paymentTypesArray=a.paymentTypes.split(","),this.displayName=a.name,this.displayStreet=ko.observable(),this.displayRegion=ko.observable(),null!==a.billingAddress&&(this.displayStreet(a.billingAddress.street),this.displayRegion(a.billingAddress.postcode+" "+a.billingAddress.city)),this.optionValue=ko.observable(a.id),this.optionText=ko.observable(a.name),this.travelagencyDefaultId=ko.observable(a.travelagencyDefaultId),this.contactPersonDefaultId=ko.observable(a.contactPersonDefaultId),this.groupreservationLanguageDefaultId=ko.observable(a.groupreservationLanguageDefaultId),this.storeCreditAmount=ko.observable(a.storeCreditAmount)}function bergbahnGroupReservationExpertOptionModel(a){var b=this;a.key=a.id,a.localizedValue=a.lastname,ko.utils.extend(b,new optionModel(a)),this.firstname=a.firstname,this.lastname=a.lastname,this.optionValue=ko.observable(a.id),this.optionText=ko.observable(a.lastname)}function railwaySeatReservationRouteOptionModel(a){var b=this;ko.utils.extend(b,new optionModel(a)),this.fromKey=ko.observable(a.additionalInfo.from_key),this.fromDate=ko.observable(a.additionalInfo.from_date),this.toKey=ko.observable(a.additionalInfo.to_key),this.toDate=ko.observable(a.additionalInfo.to_date)}function railwaySeatReservationCateringOptionViewModel(a){var b=this;ko.utils.extend(b,new optionModel(a)),this.isOptional=ko.observable(a.additionalInfo.optional),this.isOptionalSelected=ko.observable(!1),b.localizedValue=ko.observable(a.localizedValue),b.additionalInfo(a.additionalInfo),b.selectOptional=function(){b.isOptionalSelected(!b.isOptionalSelected())}}function busOptionModel(a){var b=this;ko.utils.extend(b,new optionModel(a));var c=this.key().split(".");this.from=ko.observable(c[0]),this.to=ko.observable(c[1]),this.direction=ko.observable(c[2].substr(0,1)),this.deptime=ko.observable(a.additionalInfo.deptime),this.arrtime=ko.observable(a.additionalInfo.arrtime),this.campaign=ko.observable(parseInt(a.additionalInfo.campaign)),this.displayValue=ko.computed(function(){return b.direction()
==BERGBAHN_EPR_VIA_PREFIX_UP?ko.observable(b.value()+" "+i18n.t("shop.bus.busUpInfo",{deptime:b.deptime()})):b.direction()==BERGBAHN_EPR_VIA_PREFIX_DOWN?ko.observable(b.value()+" "+i18n.t("shop.bus.busDownInfo",{arrtime:b.arrtime()})):void 0}),this.disabled=ko.observable(!1),this.reservationStatus=ko.computed(function(){var a=null;if(b.direction()==BERGBAHN_EPR_VIA_PREFIX_UP&&null!=categoriesVM&&null!=categoriesVM.busVM()&&null!=categoriesVM.busVM().ContingentInfoBusUp()?a=categoriesVM.busVM().ContingentInfoBusUp():b.direction()==BERGBAHN_EPR_VIA_PREFIX_DOWN&&null!=categoriesVM&&null!=categoriesVM.busVM()&&null!=categoriesVM.busVM().ContingentInfoBusDown()&&(a=categoriesVM.busVM().ContingentInfoBusDown()),a&&a.length>0){var c=a[0];if(null!=c)return c.status()}return-1}),this.available=ko.computed(function(){return b.reservationStatus()>0&&!b.disabled()})}function daytripsOptionModel(a){var b=this;ko.utils.extend(b,new optionModel(a)),b.additionalInfo()&&(b.additionalInfo().description||b.additionalInfo().image)?b.tooltip=ko.observable(createHtmlTooltip(b.value(),b.additionalInfo().description,b.additionalInfo().image)):b.tooltip=ko.observable(null)}function consumerMappingModel(a){this.station=ko.observable(a.station),this.targetKey=ko.observable(a.targetKey),this.replaceKey=ko.observable(a.replaceKey),this.replaceName=ko.observable(a.replaceName)}function addOnOptionModel(a){var b=this;if(ko.utils.extend(b,new optionModel(a)),this.categoryKey=ko.observable(a.additionalInfo.categoryKey),this.consumerMapping=ko.observableArray(),this.categoryName=ko.computed(function(){if(null!=b.categoryKey())return i18n.t("category."+b.categoryKey().toLowerCase())}),a.additionalInfo.consumerMapping){var c=$.map(a.additionalInfo.consumerMapping,function(a){return new consumerMappingModel(a)});b.consumerMapping(c)}b.getConsumerMapping=function(a,c,d){var e=ko.utils.arrayFilter(b.consumerMapping(),function(b){return b.targetKey()==a&&"*"==b.station()}),f=ko.utils.arrayFilter(b.consumerMapping(),function(b){return b.targetKey()==a&&b.station()==c&&b.station()==d});return f.length>0?f[0].replaceKey():e.length>0?e[0].replaceKey():null},b.getConsumerName=function(a){var c=ko.utils.arrayFilter(b.consumerMapping(),function(b){return b.replaceKey()==a});return c.length>0?c[0].replaceName():""}}function addOnBergbahnOptionModel(a){var b=this;ko.utils.extend(b,new addOnOptionModel(a)),this.fromKey=ko.observable(a.additionalInfo.fromKey),this.fromName=ko.observable(a.additionalInfo.fromName),this.toKey=ko.observable(a.additionalInfo.toKey),this.toName=ko.observable(a.additionalInfo.toName),this.viaKey=ko.observable(a.additionalInfo.viaKey),this.viaName=ko.observable(a.additionalInfo.viaName),this.tripTypeKey=ko.observable(a.additionalInfo.tripTypeKey),this.tripTypeName=ko.observable(a.additionalInfo.tripTypeName),this.classKey=ko.observable(a.additionalInfo.classKey),this.className=ko.observable(a.additionalInfo.className),this.displayValue=ko.computed(function(){return b.viaName()+", "+b.className()+", "+b.tripTypeName()})}function addOnSkipassOptionModel(a){var b=this;ko.utils.extend(b,new addOnOptionModel(a)),this.regionKey=ko.observable(a.additionalInfo.regionKey),this.regionName=ko.observable(a.additionalInfo.regionName),this.durationKey=ko.observable(a.additionalInfo.durationKey),this.durationName=ko.observable(a.additionalInfo.durationName),this.displayValue=ko.computed(function(){return b.regionName()+", "+b.durationName()}),b.getConsumerMappingKeys=function(a,c,d){var e=["",""],f=b.getConsumerMapping(a,c,d);if(null!=f){var g=f.split(".");e[0]=g[0],g.length>1&&(e[1]=g[1])}return e}}function getAddOnOptionModelInstance(a){var b=a.additionalInfo.categoryKey;if(b==CATEGORY_KEY_BERGBAHN)return new addOnBergbahnOptionModel(a);if(b==CATEGORY_KEY_SKIPASS)return new addOnSkipassOptionModel(a);var c="category not supported: "+b;throw alert(c),c}function categoryModel(a){this.id=ko.observable(a.id),this.key=ko.observable(a.key),this.name=ko.observable(a.name),this.url=ko.observable(a.url),this.dataVersion=ko.observable(a.dataVersion),this.hint=ko.observable(a.hint),this.config=ko.observable(a.config),this.cms=ko.observable(a.cms);var b=this.key().toLowerCase();headerVM.getCategoryLabel&&headerVM.getCategoryLabel(b)?this.displayName=headerVM.getCategoryLabel(b):this.displayName=ko.observable(i18n.t("category."+b)),headerVM.getCategoryMenuLabel&&headerVM.getCategoryMenuLabel(this.key().toLowerCase())?this.displayShortName=headerVM.getCategoryMenuLabel(b):this.displayShortName=ko.observable(i18n.t("category.menu."+b)),this.isDepending=ko.observable(a.isDepending),this.visible=ko.observable(!this.isDepending())}function addressModel(a){this.id=ko.observable(a.id),this.firstname=ko.observable(a.firstname),this.lastname=ko.observable(a.lastname),this.street=ko.observable(a.street),this.postcode=ko.observable(a.postcode),this.city=ko.observable(a.city)}function userModel(a){this.id=ko.observable(a.id),this.email=ko.observable(a.email),this.username=ko.observable(a.username),this.name=ko.observable(a.name),this.firstname=ko.observable(a.firstname),this.lastname=ko.observable(a.lastname),this.password=ko.observable(a.password),this.viewrole=ko.observable(a.viewrole),this.currencyEdit=ko.observable(a.currencyEdit),this.roles=ko.observableArray(a.roles),this.changedatepwd=ko.observable(a.changedatepwd),this.deleted=ko.observable(a.deleted),this.locale=ko.observable(a.locale)}function cashdeskModel(a){var b=this;this.id=ko.observable(a.id),this.name=ko.observable(a.name),this.key=ko.observable(a.key),this.skipassRegions=ko.observable(a.skipassRegions),this.skipassConsumerGroups=ko.observable(a.skipassConsumerGroups),this.skipassShowReduced=ko.observable(a.skipassShowReduced),this.skipassRedProducts=ko.observable(a.skipassRedProducts),this.bergbahnConsumerGroups=ko.observable(a.bergbahnConsumerGroups),this.deleted=ko.observable(a.deleted),b.showSkipassReductionLevel=function(a){if(b.skipassShowReduced()){if(null!=b.skipassRedProducts()&&""!=b.skipassRedProducts()){return-1!=(b.skipassRedProducts()+",").indexOf(a+",")}return!0}return!1}}function configModel(a){this.id=ko.observable(a.id),this.categoryId=ko.observable(a.categoryId),this.optionKey=ko.observable(a.optionKey),this.optionValueKey=ko.observable(a.optionValueKey)}function priceModel(a,b){var c=this;this.id=ko.observable(a.id),this.productId=ko.observable(a.productId),this.sku=ko.observable(a.sku),this.categoryKey=ko.observable(a.categoryKey),this.consumerKey=ko.observable(a.consumerKey),this.previousConsumerKey=ko.observableArray([]),this.timeRangeId=ko.observable(a.timeRangeId),this.timeRangeKey=ko.observable(a.timeRangeKey),this.timeRangeName=ko.observable(a.timeRangeName),this.timeRangeEndId=ko.observable(a.timeRangeEndId),this.timeRangeEndKey=ko.observable(a.timeRangeEndKey),this.timeRangeEndName=ko.observable(a.timeRangeEndName),this.reductionLevel=ko.observable(a.reductionLevel),this.reservationId=ko.observable(a.reservationId),this.personalizationId=ko.observable(a.personalizationId),this.firstName=ko.observable(),this.lastName=ko.observable(),this.phone=ko.observable(),this.dateOfBirth=ko.observable(),this.isAddOn=ko.observable(a.isAddOn),this.addOnOption=ko.observable(b),this.rebateRuleId=ko.observable(),this.isGroupItem=ko.observable(!1),this.visible=ko.observable(a.visible),this.crossSeason=ko.observable(a.crossSeason),this.price=ko.observable(a.price),this.totalPrice=ko.computed(function(){if(null!=a.bundleItems){for(var b=0,d=0;d<a.bundleItems.length;d++)b+=a.bundleItems[d].price;return b}return c.price()}),this.foreignPrice=ko.computed(function(){return void 0!==headerVM.selectedRateValue&&headerVM.selectedRateValue()?c.totalPrice()*headerVM.selectedRateValue():0}),this.productKey=ko.observable(a.productKey),this.date=ko.observable(a.date),this.supportsQuantity=ko.observable(!0),this.isComputed=ko.observable(!1),this.error=ko.observable(),c.matches=function(a){return c.id()==a.id()&&c.personalizationId()==a.personalizationId()&&c.reservationId()==a.reservationId()},c.isFreeSpecial=function(){return!!a.consumerKey&&a.consumerKey.startsWith("670_FRE")}}function bundlePriceModel(a,b,c){var d=this;ko.utils.extend(d,new priceModel(a)),d.bundleProductName=ko.observable(),a.productName?d.bundleProductName(a.productName):b&&d.bundleProductName(b.value()),d.categoryKey=ko.observable(a.categoryKey),d.bundleItems=ko.observableArray([]),d.bundleConsumerName=ko.computed(function(){var a=null;return d.bundleItems().forEach(function(b){console.log("bundleConsumerName",b),b.categoryKey()==CATEGORY_KEY_BERGBAHN&&(a=b.price().consumerKey())}),a}),d.matches=function(a){var b=ko.utils.arrayFirst(d.bundleItems(),function(a){return a.categoryKey()==CATEGORY_KEY_BERGBAHN}),c=ko.utils.arrayFirst(a.bundleItems(),function(a){return a.categoryKey()==CATEGORY_KEY_BERGBAHN});return d.id()==a.id()&&d.personalizationId()==a.personalizationId()&&d.reservationId()==a.reservationId()&&b.price().sku()==c.price().sku()&&b.price().viaKey()==c.price().viaKey()}}function bundlePriceItemModel(a,b){var c=this;this.categoryKey=ko.observable(a),c.price=ko.observable(b)}function getPriceBundleItemInstance(a,b){var c=null;if(null!=a.categoryKey&&a.categoryKey.toUpperCase()==CATEGORY_KEY_SKIPASS)c=new skiPriceModel(a,b);else if(null!=a.categoryKey&&a.categoryKey.toUpperCase()==CATEGORY_KEY_BERGBAHN)c=new bergbahnPriceModel(a,b);else if(null!=a.categoryKey&&a.categoryKey.toUpperCase()==CATEGORY_KEY_BERGBAHN_GROUP_RESERVATION)c=new bergbahnPriceModel(a,b);else if(null!=a.categoryKey&&a.categoryKey.toUpperCase()==CATEGORY_KEY_BERGBAHN_EPR)c=new bergbahnEprPriceModel(a,b);else if(null!=a.categoryKey&&a.categoryKey.toUpperCase()==CATEGORY_KEY_BERGBAHN_GROUP_RESERVATION)c=new bergbahnPriceModel(a,b);else if(null!=a.categoryKey&&a.categoryKey.toUpperCase()==CATEGORY_KEY_RAILWAY_SEAT_RESERVATION)c=new railwaySeatReservationPriceModel(a,b);else if(null!=a.categoryKey&&a.categoryKey.toUpperCase()==CATEGORY_KEY_RAILWAY_SEAT_RESERVATION_TIMETABLE)c=new railwaySeatReservationPriceModel(a,b);else if(null!=a.categoryKey&&a.categoryKey.toUpperCase()==CATEGORY_KEY_RAILWAY_SEAT_RESERVATION_MRAG)c=new railwaySeatReservationPriceModel(a,b);else if(null!=a.categoryKey&&a.categoryKey.toUpperCase()==CATEGORY_KEY_BUS)c=new busPriceModel(a,b);else if(null!=a.categoryKey&&a.categoryKey.toUpperCase()==CATEGORY_KEY_ADDON)c=-1!=a.sku.indexOf("ADDON.EPR")?new eprAddonPriceModel(a,b):new addonPriceModel(a,b);else if(null!=a.categoryKey&&a.categoryKey.toUpperCase()==CATEGORY_KEY_PARKING)c=new ParkingPriceModel(a,b);else{if(null==a.categoryKey||a.categoryKey.toUpperCase()!=CATEGORY_KEY_RESTAURANT){var d="category not supported: "+a.categoryKey;throw alert(d),d}c=new RestaurantPriceModel(a,b)}return new bundlePriceItemModel(a.categoryKey,c)}function skiPriceModel(a,b){var c=this;ko.utils.extend(c,new priceModel(a,b)),this.durationKey=ko.observable(a.durationKey),this.regionKey=ko.observable(a.regionKey),this.region=ko.pureComputed(function(){return null!=c.addOnOption()?c.addOnOption().regionName():getOptionValue(categoriesVM.skipassVM().AllRegions(),c.regionKey())},this),this.duration=ko.pureComputed(function(){if(null!=c.addOnOption())return c.addOnOption().durationName();for(var a=categoriesVM.skipassVM().AllRegions(),b=0;b<a.length;b++)if(a[b].key()==c.regionKey())return getOptionValue(a[b].durations(),c.durationKey());return""},this),this.consumer=ko.pureComputed(function(){if(null!=c.addOnOption())return c.addOnOption().getConsumerName(c.consumerKey());for(var a=categoriesVM.skipassVM().AllRegions(),b=0;b<a.length;b++)if(a[b].key()==c.regionKey()){var d=c.consumerKey();null!=c.reductionLevel()&&""!=c.reductionLevel()&&(d=d+"."+c.reductionLevel());var e=getOptionValue(a[b].consumer(),d);return null!=e&&""!=e||(e=getOptionValue(a[b].consumer(),c.consumerKey())+" "+c.reductionLevel()),e}return""},this),c.getSpecificAttributes=function(){return["durationKey:"+c.durationKey(),"regionKey:"+c.regionKey()]}}function bergbahnBasePriceModel(a,b){var c=this;ko.utils.extend(c,new priceModel(a,b)),this.fromKey=ko.observable(a.fromKey),this.toKey=ko.observable(a.toKey),this.viaKey=ko.observable(a.viaKey),this.classKey=ko.observable(a.classKey),this.tripTypeKey=ko.observable(a.tripTypeKey),this.fromName=ko.observable(a.fromName),this.toName=ko.observable(a.toName),this.viaName=ko.observable(a.viaName),this.className=ko.observable(a.className),this.tripTypeName=ko.observable(a.tripTypeName),this.consumerName=ko.observable(a.consumerName);var d=this.consumerKey().split(".");this.tariffKey=ko.observable(d[0]),this.personKey=ko.observable(d[1]),this.className=ko.observable(i18n.t("bergbahn.bergbahn-class."+this.classKey())),this.tripTypeName=ko.observable(i18n.t("bergbahn.bergbahn-tripType."+this.tripTypeKey())),c.getSpecificAttributes=function(){return{fromKey:c.fromKey(),toKey:c.toKey(),viaKey:c.viaKey(),classKey:c.classKey(),tripTypeKey:c.tripTypeKey()}}}function bergbahnPriceModel(a,b){var c=this,d=new bergbahnBasePriceModel(a,b);ko.utils.extend(c,d),c.dummyProduct=ko.observable(!!a.dummyProduct&&a.dummyProduct),this.bergbahnFrom=ko.pureComputed(function(){return null!=c.fromName()?c.fromName():null!=c.addOnOption()?c.addOnOption().fromName():null!=categoriesVM&&null!=categoriesVM.bergbahnVM()&&null!=categoriesVM.bergbahnVM().Froms()?getOptionValue(categoriesVM.bergbahnVM().Froms(),c.fromKey()):void 0},this),this.bergbahnTo=ko.pureComputed(function(){return null!=c.toName()?c.toName():null!=c.addOnOption()?c.addOnOption().toName():null!=categoriesVM&&null!=categoriesVM.bergbahnVM()&&null!=categoriesVM.bergbahnVM().Tos()?getOptionValue(categoriesVM.bergbahnVM().Tos(),c.toKey()):void 0},this),this.consumer=ko.pureComputed(function(){return null!=c.addOnOption()&&c.addOnOption().consumerMapping().length>0?c.addOnOption().getConsumerName(c.consumerKey()):null!=c.consumerName()?c.consumerName():null!=categoriesVM&&null!=categoriesVM.bergbahnVM()&&null!=categoriesVM.bergbahnVM().Consumer()?getOptionValue(categoriesVM.bergbahnVM().Consumer(),c.consumerKey()):void 0},this),c.selectedOutwardTrain=ko.observable(),c.outwardTrainType=ko.observable(),c.selectedReturnTrain=ko.observable(),c.returnTrainType=ko.observable(),c.getSpecificAttributes=function(){return d.getSpecificAttributes()}}function publicTransportationPriceModel(a,b){var c=this;if(ko.utils.extend(c,new bergbahnBasePriceModel(a,b)),this.id=ko.observable(a.id),this.bergbahnFrom=c.fromKey,this.bergbahnTo=c.toKey,this.bergbahnAddOn=ko.observable(),this.bergbahnAddOnName=ko.observable(),this.seatReservationAddOn=ko.observable(),this.cateringAddOns=ko.observableArray([]),this.offerId=ko.observable(a.offerId),a.addOn&&(this.bergbahnAddOn(new bergbahnPriceModel(a.addOn)),this.bergbahnAddOnName(i18n.t("shop.bergbahn.splitstationInfo",{fromName:this.bergbahnAddOn().fromName(),toName:this.bergbahnAddOn().toName()}))),a.seatReservation&&this.seatReservationAddOn(new railwaySeatReservationPriceModel(a.seatReservation)),a.catering){var d=$.map(a.catering,function(a){return new simplePriceModel(a)});this.cateringAddOns(d)}if(this.contractorKey=ko.observable(a.contractorKey),!c.consumerName()){var e=c.consumerKey();null!=c.consumerKey()&&c.consumerKey().includes(".")&&(e=c.consumerKey().split(".")[1]),"none"==e?c.consumerName(i18n.t("ticketsDetail.ticketholder.options.consumer.adult")):"half-fare"==e?c.consumerName(i18n.t("ticketsDetail.ticketholder.options.consumer.halffare")):"child"==e?c.consumerName(i18n.t("ticketsDetail.ticketholder.options.consumer.kidteen")):"kid"==e?c.consumerName(i18n.t("ticketsDetail.ticketholder.options.consumer.kidyoung")):c.consumerName(e.charAt(0).toUpperCase()+e.slice(1))}c.getSpecificAttributes=function(){return{id:a.id,fromKey:c.fromKey(),toKey:c.toKey(),viaKey:c.viaKey(),classKey:c.classKey(),tripTypeKey:c.tripTypeKey(),offerId:c.offerId(),contractorKey:c.contractorKey()}},c.matches=function(a){return c.firstName()&&a.firstName()&&c.lastName()&&a.lastName()&&c.dateOfBirth()&&a.dateOfBirth()?c.id()==a.id()&&c.offerId()==a.offerId()&&c.consumerKey()==a.consumerKey()&&c.firstName()==a.firstName()&&c.lastName()==a.lastName()&&c.dateOfBirth()==a.dateOfBirth():c.id()==a.id()&&c.offerId()==a.offerId()&&c.consumerKey()==a.consumerKey()&&c.classKey()==a.classKey()}}function railwaySeatReservationPriceModel(a,b){var c=this;ko.utils.extend(c,new bergbahnBasePriceModel(a,b)),this.contractorKey=ko.observable(a.contractorKey),this.consumer=ko.observable(a.consumerName),this.seatNumber=ko.observable(a.seatNumber),this.seatId=ko.observable(a.seatId),c.getSpecificAttributes=function(){return{fromKey:c.fromKey(),toKey:c.toKey(),viaKey:c.viaKey(),classKey:c.classKey(),tripTypeKey:c.tripTypeKey(),contractorKey:c.contractorKey(),seatNumber:c.seatNumber(),seatId:c.seatId()}},c.matches=function(a){return c.firstName()&&a.firstName()&&c.lastName()&&a.lastName()&&c.dateOfBirth()&&a.dateOfBirth()?c.id()==a.id()&&c.fromKey()==a.fromKey()&&c.toKey()==a.toKey()&&c.seatNumber()==a.seatNumber()&&c.firstName()==a.firstName()&&c.lastName()==a.lastName()&&c.dateOfBirth()==a.dateOfBirth():c.id()==a.id()&&c.fromKey()==a.fromKey()&&c.toKey()==a.toKey()&&c.seatNumber()==a.seatNumber()}}function bergbahnEprPriceModel(a,b){var c=this;ko.utils.extend(c,new bergbahnBasePriceModel(a,b)),this.bergbahnFrom=ko.pureComputed(function(){return null!=c.addOnOption()?c.addOnOption().fromName():null!=categoriesVM&&null!=categoriesVM.bergbahnEprVM()&&null!=categoriesVM.bergbahnEprVM().Froms()?getOptionValue(categoriesVM.bergbahnEprVM().Froms(),c.fromKey()):void 0},this),this.bergbahnTo=ko.pureComputed(function(){return null!=c.addOnOption()?c.addOnOption().toName():null!=categoriesVM&&null!=categoriesVM.bergbahnEprVM()&&null!=categoriesVM.bergbahnEprVM().Tos()?getOptionValue(categoriesVM.bergbahnEprVM().Tos(),c.toKey()):void 0},this),this.consumer=ko.pureComputed(function(){return null!=c.addOnOption()?c.addOnOption().getConsumerName(c.consumerKey()):null!=categoriesVM&&null!=categoriesVM.bergbahnEprVM()&&null!=categoriesVM.bergbahnEprVM().Consumer()?getOptionValue(categoriesVM.bergbahnEprVM().Consumer(),c.consumerKey()):void 0},this);var d=this.viaKey().split(".");this.direction=ko.observable(d[2].substr(0,1)),this.routeName=ko.pureComputed(function(){return c.direction()==BERGBAHN_EPR_VIA_PREFIX_UP?c.bergbahnFrom()+" - "+c.bergbahnTo():c.direction()==BERGBAHN_EPR_VIA_PREFIX_DOWN?c.bergbahnTo()+" - "+c.bergbahnFrom():void 0},this),this.train=ko.pureComputed(function(){if(null!=categoriesVM&&null!=categoriesVM.bergbahnEprVM()&&null!=categoriesVM.bergbahnEprVM().Routes()){for(var a=null,b=categoriesVM.bergbahnEprVM().Routes(),d=0;d<b.length;d++)if(b[d].key()==c.fromKey()+"."+c.toKey()){if(c.direction()==BERGBAHN_EPR_VIA_PREFIX_UP){a=getOption(b[d].trainsUpTraditional(),c.viaKey());break}if(c.direction()==BERGBAHN_EPR_VIA_PREFIX_DOWN){a=getOption(b[d].trainsDownTraditional(),c.viaKey());break}}if(null!=a)return a.deptime()}},this)}function busPriceModel(a,b){var c=this;ko.utils.extend(c,new bergbahnPriceModel(a,b));var d=this.viaKey().split(".");this.direction=ko.observable(d[2].substr(0,1)),this.station=ko.pureComputed(function(){var a=null;return null!=categoriesVM&&null!=categoriesVM.busVM()&&null!=categoriesVM.busVM().BusesUp()&&null!=categoriesVM.busVM().BusesDown()&&(c.direction()==BERGBAHN_EPR_VIA_PREFIX_UP?a=getOption(categoriesVM.busVM().BusesUp(),c.viaKey()):c.direction()==BERGBAHN_EPR_VIA_PREFIX_DOWN&&(a=getOption(categoriesVM.busVM().BusesDown(),c.viaKey()))),a},this),this.consumer=ko.pureComputed(function(){if(null!=categoriesVM&&null!=categoriesVM.busVM()&&null!=categoriesVM.busVM().Consumer())return getOptionValue(categoriesVM.busVM().Consumer(),c.consumerKey())},this),this.routeName=ko.computed(function(){if(null!=c.station&&null!=c.station()){if(c.direction()==BERGBAHN_EPR_VIA_PREFIX_UP)return i18n.t("cart.bus.routeUp",{station:c.station().value()});if(c.direction()==BERGBAHN_EPR_VIA_PREFIX_DOWN)return i18n.t("cart.bus.routeDown",{station:c.station().value()})}},this),this.train=ko.computed(function(){if(null!=c.station&&null!=c.station()){if(c.direction()==BERGBAHN_EPR_VIA_PREFIX_UP)return i18n.t("cart.bus.timeBusUp",{deptime:c.station().deptime(),arrtime:c.station().arrtime()});if(c.direction()==BERGBAHN_EPR_VIA_PREFIX_DOWN)return i18n.t("cart.bus.timeBusDown",{deptime:c.station().deptime(),arrtime:c.station().arrtime()})}},this)}function cateringPriceModel(a,b){var c=this;ko.utils.extend(c,new simplePriceModel(a,b)),c.seatNumber=ko.observable(a.seatNumber),c.seatId=ko.observable(a.seatId),c.getSpecificAttributes=function(){return{productKey:c.productKey(),seatNumber:c.seatNumber(),seatId:c.seatId()}}}function simplePriceModel(a,b){var c=this;ko.utils.extend(c,new priceModel(a,b)),this.productKey=ko.observable(a.productKey),this.productNameValue=ko.observable(a.productName),this.selectable=ko.observable(!1),this.productName=ko.pureComputed(function(){return c.productNameValue()?c.productNameValue():null!=c.addOnOption()?c.addOnOption().value():void 0},this),c.getSpecificAttributes=function(){return{productKey:c.productKey()}}}function eprAddonPriceModel(a,b){var c=this;ko.utils.extend(c,new simplePriceModel(a,b)),c.selectedTrain=ko.observable(),c.eprSelected=ko.observable(!1),c.timeslot=ko.observable(),c.timeslotChanged=ko.observable(!1),c.availableTrains=ko.observableArray(),c.availableTimes=ko.observableArray(),c.productId=ko.observable(a.productId),c.eprInfo=ko.observable(),c.direction=ko.computed(function(){return-1!=c.sku().indexOf("KLEINE_SCHEIDEGG_-_JUNGFRAUJOCH")||-1!=c.sku().indexOf("GRINDELWALD_TERMINAL_-_JUNGFRAUJOCH")?BERGBAHN_EPR_OUTWARD:-1!=c.sku().indexOf("JUNGFRAUJOCH_-_KLEINE_SCHEIDEGG")||-1!=c.sku().indexOf("JUNGFRAUJOCH_-_GRINDELWALD_TERMINAL")?BERGBAHN_EPR_RETURN:null}),c.trainType=ko.pureComputed(function(){return-1!=c.sku().indexOf("KLEINE_SCHEIDEGG_-_JUNGFRAUJOCH")||-1!=c.sku().indexOf("JUNGFRAUJOCH_-_KLEINE_SCHEIDEGG")?BERGBAHN_TRAIN_TYPE_TRADITIONAL:-1!=c.sku().indexOf("GRINDELWALD_TERMINAL")?BERGBAHN_TRAIN_TYPE_VBAHN:null}),c.getSpecificAttributes=function(){var a={};return c.eprInfo()?(a.epr={},a.epr[c.direction()]=prepareEprOptionsFromEprInfo(c.eprInfo(),c.date())):c.selectedTrain()&&(a.epr={},a.epr[c.direction()]=prepareEprOptionsFromTrain(c.selectedTrain(),c.date(),c.trainType())),a}}function addonPriceModel(a,b){var c=this;ko.utils.extend(c,new simplePriceModel(a,b)),c.productId=ko.observable(a.productId),c.type=ko.observable(a.type),c.selectable(!1),c.selected=ko.observable(!0),c.getSpecificAttributes=function(){return{}}}function localEventPriceModel(a,b){var c=this;ko.utils.extend(c,new priceModel(a,b)),c.productName=ko.observable(a.productName),c.ticketTypeName=ko.observable(),c.isTimeDependingTicket=ko.observable(!1),c.availability=ko.observable(),c.getSpecificAttributes=function(){return c.isTimeDependingTicket()?{productKey:c.productKey(),ticketTime:c.date()}:{productKey:c.productKey()}},c.matches=function(a){return c.isTimeDependingTicket()?c.id()==a.id()&&c.personalizationId()==a.personalizationId()&&c.reservationId()==a.reservationId()&&c.date()==a.date():c.id()==a.id()&&c.personalizationId()==a.personalizationId()&&c.reservationId()==a.reservationId()}}function depotPriceModel(a,b){var c=this;ko.utils.extend(c,new simplePriceModel(a,b)),c.consumerKey=ko.observable(a.consumerKey),c.consumerName=ko.observable(a.consumerName),c.roomId=ko.observable(a.roomKey),c.roomName=ko.observable(a.roomName),c.durationTypeId=ko.observable(a.durationTypeKey),c.durationTypeName=ko.observable(a.durationTypeName),c.duration=ko.observable(a.duration),c.dateFrom=ko.observable(a.fromDate),c.dateTo=ko.observable(a.toDate),c.lockerExtId=ko.observable(a.lockerExtId),c.availability=ko.observable(a.availability),c.getSpecificAttributes=function(){return{productKey:c.productKey(),consumerKey:c.consumerKey(),consumerName:c.consumerName(),roomId:c.roomId(),roomName:c.roomName(),durationTypeId:c.durationTypeId(),durationTypeName:c.durationTypeName(),duration:c.duration(),dateFrom:c.dateFrom(),dateTo:c.dateTo(),lockerExtId:c.lockerExtId(),availability:c.availability()}},c.matches=function(a){return c.consumerKey()==a.consumerKey()&&c.roomName()==a.roomName()&&c.durationTypeId()==a.durationTypeId()&&c.date()==a.date()&&c.duration()==a.duration()}}function autoverladPriceModel(a,b){var c=this;ko.utils.extend(c,new simplePriceModel(a,b)),c.consumerKey=ko.observable(a.consumerKey),c.consumerName=ko.observable(a.consumerName),c.stationKey=ko.observable(a.stationKey),c.stationName=ko.observable(a.stationName),c.typeKey=ko.observable(a.typeKey),c.typeName=ko.observable(a.typeName),c.dateCategoryKey=ko.observable(a.dateCategoryKey),c.dateCategoryName=ko.observable(a.dateCategoryName),c.dateFrom=ko.observable(a.date),c.directionKey=ko.observable(a.directionKey),c.directionName=ko.observable(a.directionName),c.contingent=ko.observable(a.contingent),c.minLicensePlates=ko.observable(a.minLicensePlates),c.maxLicensePlates=ko.observable(a.maxLicensePlates),c.licensePlates=ko.observableArray(),c.licencePlate=ko.observable(),c.showDateCategory=function(){return"NONE"!=c.dateCategoryKey()||"single-one-way"!=c.typeKey()},c.getSpecificAttributes=function(){return{productKey:c.productKey(),consumerKey:c.consumerKey(),consumerName:c.consumerName(),stationKey:c.stationKey(),stationName:c.stationName(),typeKey:c.typeKey(),typeName:c.typeName(),dateCategoryKey:c.dateCategoryKey(),dateCategoryName:c.dateCategoryName(),dateFrom:c.dateFrom(),directionKey:c.directionKey(),directionName:c.directionName(),contingent:c.contingent(),minLicensePlates:c.minLicensePlates(),maxLicensePlates:c.maxLicensePlates(),licensePlates:c.getLicensePlatesJson(),licencePlate:c.licencePlate()}},c.getLicensePlatesJson=function(){var a=[];return c.licensePlates().forEach(function(b){a.push(b.licensePlate())}),a},c.matches=function(a){return c.consumerKey()==a.consumerKey()&&c.stationKey()==a.stationKey()&&c.typeKey()==a.typeKey()&&c.dateCategoryKey()==a.dateCategoryKey()&&c.dateFrom()==a.dateFrom()}}function ParkingPriceModel(a,b){var c=this;if(ko.utils.extend(c,new simplePriceModel(a,b)),c.productKey(a.sku),c.productName=ko.observable(),c.durationName=ko.observable(),
c.duration=ko.observable(a.duration),c.parkingType=ko.observable(a.parkingType),c.location=ko.observable(a.location),a.productName){var d=a.productName.split(" - ");c.productName(d[0]),d.length>0&&(c.durationName(d[1]),c.duration(d[1].split(" ")[0]))}c.getSpecificAttributes=function(){return{productKey:c.productKey(),dateFrom:c.date(),duration:c.duration(),parkingType:c.parkingType(),location:c.location()}},c.matches=function(a){return c.productKey()==a.productKey()},console.log("Parking price model",c)}function ticketModelHotel(a){this.price=ko.observable(a)}function hotelPriceModel(a,b){var c=this;c.accommRateTypeKey=ko.observable("FIT"),c.starsInfo=ko.observable(),""!=a.stars.number&&c.starsInfo(i18n.t("shop.hotel.starsInfo",{stars:a.stars.number})),this.productName=ko.observable(a.name),this.consumerName=ko.observable(),this.place=ko.observable(a.place),this.categoryName=ko.observable(b.selectedRoomCategoryName),this.departureDate=ko.observable(b.selectedDepartureDate),this.regionName=ko.observable(b.selectedRegionName),c.flatPrices=ko.observable(a.flat_prices),c.serviceCodeDisplay=ko.pureComputed(function(){return c.flatPrices()&&"standard"!=c.flatPrices().category?c.flatPrices().categoryName:null}),c.specificAttributes={departureDate:c.departureDate(),type:a.type,stars:a.stars,regionId:b.selectedRegionId,roomCategoryId:b.selectedRoomCategoryId,occupancy:1,accommRateTypeKey:c.accommRateTypeKey(),accommExtid:a.accommExtId,serviceCode:c.flatPrices()?c.flatPrices().category:null,serviceCodeDisplay:c.flatPrices()?c.flatPrices().categoryName:null},c.singleRoomPrice=ko.observable(),c.doubleRoomPrice=ko.observable(),c.tripleRoomPrice=ko.observable(),c.updatePricesForAccommRateTypeKey=function(a){c.singleRoomPrice(c.flatPrices()?c.flatPrices()[a].occ_1:null),c.doubleRoomPrice(c.flatPrices()?c.flatPrices()[a].occ_2:null),c.tripleRoomPrice(c.flatPrices()?c.flatPrices()[a].occ_3:null)},c.setAccommRateTypeKey=function(b){c.accommRateTypeKey(b),c.consumerKey(c.accommRateTypeKey()+".1"),c.specificAttributes.accommRateTypeKey=b,c.productKey(a.sku+"_"+b)},ko.utils.extend(c,new priceModel({id:a.id,productId:a.id,sku:a.sku,categoryKey:CATEGORY_KEY_HOTEL,consumerKey:c.accommRateTypeKey+".1",price:c.singleRoomPrice,productKey:a.sku,date:b.selectedArrivalDate})),c.supportsQuantity(!1),c.getSpecificAttributes=function(){return c.specificAttributes},c.matches=function(a){return c.id()==a.id()&&c.categoryName()==a.categoryName()&&c.specificAttributes.accommRateTypeKey==a.specificAttributes.accommRateTypeKey}}function hotelRoomPriceModel(a,b,c){var d=this,e=c.selectedAdultCount,f=b.rate_type.reference,g=b.rate_type.label;ko.utils.extend(d,new priceModel({id:a.id,productId:a.id,sku:a.sku,categoryKey:CATEGORY_KEY_HOTEL,consumerKey:f+"."+e,price:b.price,productKey:a.sku,date:c.selectedArrivalDate})),d.supportsQuantity(!1),this.productName=ko.observable(a.name),this.consumerName=ko.observable(g),this.offerId=ko.observable(b.id),this.departureDate=ko.observable(c.selectedDepartureDate),this.roomName=ko.observable(b.name),this.mealName=ko.observable(b.meal_name),this.roomInfo=ko.observable(i18n.t("shop.hotel.occupancy."+e)+" / "+d.mealName()),this.specificAttributes={accommExtid:b.accomm_extid,departureDate:d.departureDate(),offerId:d.offerId(),type:a.type,roomName:d.roomName(),mealName:d.mealName(),occupancy:e,accommRateTypeKey:f,regionId:c.selectedRegionId,roomCategoryId:c.selectedRoomCategoryId},d.getSpecificAttributes=function(){return d.specificAttributes},d.matches=function(a){return d.id()==a.id()&&d.offerId()==a.offerId()&&d.consumerKey()==a.consumerKey()}}function hotelAccommodationOptionModel(a,b){var c=this;if(this.key=ko.observable(a.id),this.url=ko.observable(a.url),this.value=ko.observable(a.name),this.bookable=ko.observable(a.bookable),this.description=ko.observable(a.description),this.tooltip=ko.observable(getHotelTooltip(a.name,a.description,a.image)),this.image=ko.observable(a.image),this.stars=ko.observable(a.stars),this.type=ko.observable(a.type),this.starsInfo=ko.observable(),this.hotelTicketModel=ko.observable(),this.accommExtId=ko.observable(a.accommExtId),c.stars()&&""!=c.stars().number&&c.starsInfo(i18n.t("shop.hotel.starsInfo",{stars:c.stars().number})),this.price=ko.observable(),this.offers=ko.observableArray([]),a.offers.length>0){var d=$.map(a.offers,function(c){return new ticketModelHotel(new hotelRoomPriceModel(a,c,b))});this.offers(d)}else{var e=new hotelPriceModel(a,b);c.hotelTicketModel(e),this.price=c.hotelTicketModel().singleRoomPrice}}function hotelCityOptionModel(a,b){if(this.key=ko.observable(a.id),this.value=ko.observable(a.name),this.accommodations=ko.observableArray([]),a.accommodations){var c=$.map(a.accommodations,function(a){return new hotelAccommodationOptionModel(a,b)});c=c.sort(function(a,b){return a.value()>b.value()?1:-1}),this.accommodations(c)}}function ticketModel(a){this.consumer=ko.observable(a),this.price=ko.observable()}function ticketModelSkipass(a){var b=this;ko.utils.extend(b,new ticketModel(a));var c=this.consumer().key().split(".");this.personKey=ko.observable(c[0]),this.reductionLevel=ko.observable(""),c.length>1&&this.reductionLevel(c[1])}function TicketModelParking(){var a=this;ko.utils.extend(a,new ticketModel("car")),a.contingent=ko.observable(),a.addToCartEnabled=ko.computed(function(){return a.contingent()>0&&null!=a.price()})}function ticketModelLocalEvent(a){this.ticketType=ko.observable(a),this.price=ko.observable()}function ticketModelBergbahn(a,b){var c=this;ko.utils.extend(c,new ticketModel(a)),this.stationType=ko.observable(b);var d=this.consumer().key().split(".");this.tariffKey=ko.observable(d[0]),this.personKey=ko.observable(d[1]),c.eprDaytripReference=ko.observable(),c.eprDaytripPriceDisplay=ko.computed(function(){if(!c.eprDaytripReference())return null;var a=null,b=null;return c.eprDaytripReference().bundleItems().forEach(function(c){c.price()instanceof eprAddonPriceModel?(null==a||a>c.price().price())&&(a=Number(c.price().price())):c.categoryKey()==CATEGORY_KEY_BERGBAHN&&(b=Number(c.price().price()))}),null!=b&&null!=a?b+a:null})}function ticketModelBergbahnEpr(a){var b=this;ko.utils.extend(b,new ticketModelBergbahn(a,STATION_TYPE_BERGBAHN)),this.priceDown=ko.observable()}function ticketModelLocalEvent(a){this.ticketType=ko.observable(a),this.price=ko.observable()}function cartEntryModel(a,b,c,d,e){var f=this;this.categoryKey=ko.observable(a),this.internalId=ko.observable(c),this.parentEntry=ko.observable(d),this.quantity=ko.observable(1).extend({numericInt:0}),this.price=ko.observable(b),this.totalPrice=ko.computed(function(){if(a==CATEGORY_KEY_BUNDLE){var b=0;return f.price().bundleItems().forEach(function(a){a.price()instanceof eprAddonPriceModel?a.price().eprSelected()&&(b+=a.price().price()):b+=a.price().price()}),f.quantity()*b}return f.quantity()*f.price().price()}),this.totalForeignPrice=ko.computed(function(){if(a==CATEGORY_KEY_BUNDLE){var b=0;return f.price().bundleItems().forEach(function(a){a.price()instanceof eprAddonPriceModel?a.price().eprSelected()&&(b+=a.price().foreignPrice()):b+=a.price().foreignPrice()}),f.quantity()*b}return f.quantity()*f.price().foreignPrice()}),this.focused=ko.observable(!1),this.rebateRuleItemReference=ko.observableArray([]);var g=this.focused.subscribe(function(a){0==a&&e&&e(f)});cartEntryModel.prototype.dispose=function(){g.dispose()}}function CheckoutItemModel(a,b,c){var d=this;this.id=ko.observable(),this.origOrderItemId=ko.observable(),this.ticketNr=ko.observable(b),this.categoryKey=ko.observable(a.categoryKey()),this.quantity=ko.observable(1),this.mediaCardId=ko.observable(),this.mediaCardOrigId=ko.observable(),this.zipCode=ko.observable(),this.media=ko.observable(MEDIA_KEYCARD),this.categoryName=ko.observable(i18n.t("category.short."+this.categoryKey().toLowerCase())),null!=headerVM.categoryLabelsMap&&null!=headerVM.categoryLabelsMap()[this.categoryKey().toLowerCase()]&&(this.categoryName=ko.observable(headerVM.categoryLabelsMap()[this.categoryKey().toLowerCase()].categoryShortLabel())),this.printingState=ko.observable(PRINTING_STATE_OPEN),this.coding=ko.observable(!0),this.printerTray=ko.observable(),this.error=ko.observable(),d.supportedMedia=ko.observable(c.supportedMedia),d.requiredPersonalizationInfo=ko.observable(c.requiredPersonalizationInfo),d.mediaIdEnabled=ko.observable(!1),d.swisspassSupported=ko.observable(!1),d.keycardSupported=ko.observable(!1),d.placeholderKeycard=ko.observable("")}function ShopCheckoutItemModel(a,b,c,d,e){var f=this;f.type=ko.observable(d),f.disabledInCheckout=ko.observable(!1),f.isTotalBundleGroupItem=ko.observable(!1),ko.utils.extend(f,new CheckoutItemModel(a,b,e)),"undefined"!=typeof menuVM&&menuVM.hasCashDeskSale()&&shoppingcartVM.orderType()==CONTRACT_ORDERTYPE_CASHDESK&&null!=f.supportedMedia()&&(-1!=f.supportedMedia().indexOf("swisspass")&&(f.swisspassSupported(!0),f.mediaIdEnabled(!0)),-1!=f.supportedMedia().indexOf("keycard")&&(f.keycardSupported(!0),f.mediaIdEnabled(!0)),-1!=f.supportedMedia().indexOf("voucher")&&(a.price().isGroupItem()&&f.mediaIdEnabled(!1),f.placeholderKeycard(i18n.t("checkout.placeholder.keycardOptional")))),this.groupId=ko.observable(c),this.price=ko.observable(a.price()),this.personalisationInfo=ko.observable(),this.firstName=ko.observable(a.price().firstName()),this.lastName=ko.observable(a.price().lastName()),this.phone=ko.observable(a.price().phone()),this.dateOfBirth=ko.observable(a.price().dateOfBirth()),this.requiredPersonalizationFirstname=ko.observable(!1),this.requiredPersonalizationLastname=ko.observable(!1),this.requiredPersonalizationInfoPhone=ko.observable(!1),this.requiredPersonalizationInfoDateOfBirth=ko.observable(!1),this.requiresPersonalizationInfo=ko.observable(!1),f.licencePlate=ko.observable(),f.licensePlates=ko.observableArray(),f.computePersonalizationInfo=ko.computed(function(){var b=f.requiredPersonalizationInfo(),c=kp.get(a,"categoryKey"),d=kp.get(a,"price.sku");if(c==CATEGORY_KEY_LOCAL_EVENT&&d){var e=categoriesVM.getCategory(c);f.requiresPersonalizationInfo(!0),personalisationInfo=e.getPersonalisationInfo(d),-1!=personalisationInfo.personalisation.indexOf("firstname")&&personalisationInfo.personalisation.push("firstName"),-1!=personalisationInfo.personalisation.indexOf("birthdate")&&personalisationInfo.personalisation.push("dob"),f.personalisationInfo(new personalisationModel(personalisationInfo))}if(c==CATEGORY_KEY_AUTOVERLAD&&"furka"==f.price().stationKey()){f.requiresPersonalizationInfo(!0),f.licensePlates(new Array(parseInt(a.price().maxLicensePlates())));for(var g=0;g<f.licensePlates().length;g++)f.licensePlates()[g]={licensePlate:ko.observable()}}null!=b&&""!=b&&(f.requiresPersonalizationInfo(!0),-1!=b.indexOf("firstname")&&f.requiredPersonalizationFirstname(!0),-1!=b.indexOf("lastname")&&f.requiredPersonalizationLastname(!0),-1!=b.indexOf("phone")&&f.requiredPersonalizationInfoPhone(!0),-1!=b.indexOf("dateOfBirth")&&f.requiredPersonalizationInfoDateOfBirth(!0))}),f.hiddenInCheckout=ko.computed(function(){return"ADDON.OPTIONAL"===f.price().sku()||(f.price()instanceof eprAddonPriceModel?!f.price().eprSelected():!(!f.price().dummyProduct||!f.price().dummyProduct()))}),f.showPrice=ko.computed(function(){return!0})}function ShopCheckoutBundleItemModel(a,b,c,d,e){var f=this;this.bundle=ko.observable(d),ko.utils.extend(f,new ShopCheckoutItemModel(a,b,c,ORDER_ITEM_TYPE_BUDLE_ITEM,e))}function ShopCheckoutBundleItemGroupModel(a,b,c,d,e){var f=this;ko.utils.extend(f,new ShopCheckoutItemModel(b,c,d,ORDER_ITEM_TYPE_BUDLE_ITEM,e)),f.isTotalBundleGroupItem=ko.observable(!0),console.log("ShopCheckoutBundleItemGroupModel",f),f.totalPrice=ko.observable(f.price().price()*a.quantity()),f.quantity=ko.observable(a.quantity())}function ShopCheckoutBundleItemGroupDummyModel(a){var b=this;ko.utils.extend(b,a[0]),b.totalPrice=ko.observable(b.price().price()*a.length),b.quantity=ko.observable(a.length),b.isTotalBundleGroupItem=ko.observable(!0)}function PickupCheckoutItemModel(a,b,c){var d=this;ko.utils.extend(d,new CheckoutItemModel(a,b,c)),menuVM.hasCashDeskSale()&&shoppingcartVM.orderType()==CONTRACT_ORDERTYPE_CASHDESK&&null!=d.supportedMedia()&&(-1!=d.supportedMedia().indexOf("swisspass")&&(d.swisspassSupported(!0),d.mediaIdEnabled(!0)),-1!=d.supportedMedia().indexOf("keycard")&&(d.keycardSupported(!0),d.mediaIdEnabled(!0)),-1!=d.supportedMedia().indexOf("voucher")&&d.placeholderKeycard(i18n.t("checkout.placeholder.keycardOptional"))),this.orderItem=ko.observable(a),this.origOrderItemId(a.origOrderItemId())}function ReservationCheckoutItemModel(a,b,c){var d=this;d.showPersonalization=ko.observable(!1),ko.utils.extend(d,new CheckoutItemModel(a,b,c)),null!=d.supportedMedia()&&(-1!=d.supportedMedia().indexOf("swisspass")&&(d.swisspassSupported(!0),d.mediaIdEnabled(!0)),-1!=d.supportedMedia().indexOf("keycard")&&(d.keycardSupported(!0),d.mediaIdEnabled(!0)),-1!=d.supportedMedia().indexOf("voucher")&&d.placeholderKeycard(i18n.t("checkout.placeholder.keycardOptional"))),this.orderItem=ko.observable(a),d.id(d.orderItem().id()),d.origOrderItemId(d.id()),"adultgoldupgrade"==d.orderItem().consumerKey()&&console.log("adultgoldupgrade"),this.ticketHolder=ko.observable(new ticketholderModel),d.getError=function(a,b,c){var d="";if(-1!=getErrorCode(a)){var e=$.parseJSON(a.responseText);d=e.message+" (code: "+e.code+")"}else d=a.responseText;return d}}function categoryCountModel(a){var b=this;this.categoryKey=ko.observable(a),this.quantity=ko.observable(1),this.categoryName=ko.pureComputed(function(){return getCategoryInfo(b.categoryKey())},this)}function bundleCategoryCountModel(a,b,c){var d=this;ko.utils.extend(d,new categoryCountModel(a)),this.productKey=ko.observable(b),this.productName=ko.observable(c),this.categoryName=ko.pureComputed(function(){return getCategoryInfo(d.categoryKey())+" "+c},this)}function printerModel(a){var b=this;this.id=ko.observable(a.id),this.name=ko.observable(a.name),this.type=ko.observable(a.type),this.trayConfig=ko.observable(a.trayConfig),this.bundleConfig=ko.observable(a.bundleConfig),this.server=ko.observable(a.server),this.port=ko.observable(a.port),this.timeout=ko.observable(a.timeout),this.local=ko.observable(a.local),this.deviceNumber=ko.observable(a.deviceNumber),this.version=ko.observable(),this.installedVersion=ko.observable(),b.serverPort=ko.computed(function(){return b.server()+":"+b.port()},b),this.isHandFeed=function(a){return a==CATEGORY_KEY_SKIPASS?b.trayConfig()==AXESS_PRINTER_TRAY_CONFIG_BERGBAHN_SKIPASS:a==CATEGORY_KEY_BERGBAHN||a==CATEGORY_KEY_BERGBAHN_EPR?b.trayConfig()==AXESS_PRINTER_TRAY_CONFIG_SKIPASS_BERGBAHN||b.trayConfig()==AXESS_PRINTER_BERGBAHN_HAND_CONFIG_SKIPASS_PICKUP:void 0},this.printingEnabled=function(a,c){var d=!0;return c&&(d=b.bundleConfig()==AXESS_PRINTER_BUNDLE_CONFIG_PRINT),a==CATEGORY_KEY_SKIPASS?b.trayConfig()!=AXESS_PRINTER_BERGBAHN_HAND_CONFIG_SKIPASS_PICKUP&&b.trayConfig()!=AXESS_PRINTER_BERGBAHN_TRAY_CONFIG_SKIPASS_PICKUP&&d:a==CATEGORY_KEY_BERGBAHN||a==CATEGORY_KEY_BERGBAHN_EPR?(b.trayConfig()==AXESS_PRINTER_TRAY_CONFIG_SKIPASS_BERGBAHN||b.trayConfig()==AXESS_PRINTER_TRAY_CONFIG_BERGBAHN_SKIPASS||b.trayConfig()==AXESS_PRINTER_BERGBAHN_HAND_CONFIG_SKIPASS_PICKUP||b.trayConfig()==AXESS_PRINTER_BERGBAHN_TRAY_CONFIG_SKIPASS_PICKUP)&&d:void 0}}function orderModel(a){var b=this;if(this.id=ko.observable(a.id),this.mageOrderIncrId=ko.observable(a.mageOrderIncrId),this.type=ko.observable(a.type),this.status=ko.observable(a.status),this.comment=ko.observable(a.comment),this.noShow=ko.observable(a.noShow),this.amount=ko.observable(a.amount),this.adjustment=ko.observable(a.adjustment),this.paymentType=ko.observable(a.paymentType),this.customerPaymentType=ko.observable(a.customerPaymentType),this.createdAt=ko.observable(a.createdAt),this.updatedAt=ko.observable(a.updatedAt),this.updatedBy=ko.observable(a.updatedBy),this.ticketsTotal=ko.observable(a.ticketsTotal),this.ticketsTotalUsed=ko.observable(a.ticketsTotalUsed),this.cancelInfo=ko.observable(),this.userId=ko.observable(a.userId),this.cashdeskId=ko.observable(a.cashdeskId),this.origOrderId=ko.observable(a.origOrderId),this.orderItems=ko.observableArray(),this.cancelOrder=ko.observable(!1),b.isOrderPending=ko.computed(function(){return"new"==b.status()},b),b.displayAmount=ko.computed(function(){return 1==b.isOrderPending()?0:null!=b.amount()?b.amount():0},b),this.listenOnCancelOrder=ko.computed(function(){null!=b.orderItems()&&b.orderItems().forEach(function(a){a.cancelable()&&a.cancelOrderItem(b.cancelOrder()),a instanceof orderItemBundleModel&&a.bundleItems().forEach(function(a){a.cancelable()&&a.cancelOrderItem(b.cancelOrder())})})}),b.selectOrderItemToCancel=function(a,c){var d=a.reservationId(),e=a.rebateRuleId();a.cancelable()&&a.cancelOrderItem(c.target.checked),a instanceof orderItemBundleModel?a.bundleItems().forEach(function(a){a.cancelable()&&a.cancelOrderItem(c.target.checked)}):null!=b.orderItems()&&b.orderItems().forEach(function(f){if(f.cancelable()&&((null!=e&&null!=f.rebateRuleId()||null!=d&&null!=f.reservationId())&&f.cancelOrderItem(c.target.checked),null!=a.refItemId())){var g=b.getItem(a.refItemId()),h=!0;g.bundleItems().forEach(function(a){a.cancelOrderItem()||a.dummyProduct()||(h=!1)}),g.cancelOrderItem(h)}})},b.getItem=function(a){for(var c=0;c<b.orderItems().length;c++)if(b.orderItems()[c].id()==a)return b.orderItems()[c]},null!=a.categoryInfos)for(var c=$.map(a.categoryInfos,function(a){var b=new categoryCountModel(a.key);return b.quantity(a.count),b}),d="",e=0;e<c.length;e++)d+=c[e].quantity()+" ",d+=getCategoryInfo(c[e].categoryKey(),c[e].quantity()),e+1<c.length&&(d+=", ");this.categoryInfoText=ko.observable(d),this.userName=ko.pureComputed(function(){if(b.userId()){var a=ko.utils.arrayFirst(headerVM.Users(),function(a){return a.id()===b.userId()});if(a)return a.name()}},this),this.cashdeskName=ko.pureComputed(function(){if(b.cashdeskId()){var a=ko.utils.arrayFirst(headerVM.Cashdesks(),function(a){return a.id()===b.cashdeskId()});if(a)return a.name()}},this),this.setOrderItems=function(a){var b=$.map(a.orderItems,function(a){return getOrderItemInstace(a)});this.orderItems(b)},this.setOrderDetails=function(a){this.cancelOrder(!1),a.cancelInfo&&this.cancelInfo(new orderCancelInfoModel(a.cancelInfo)),this.setOrderItems(a)},this.cancelable=ko.pureComputed(function(){return null!=this.cancelInfo()&&this.cancelInfo().cancelability()==ORDER_CANCEL_INFO_POSSIBLE},this),a.orderItems&&a.orderItems.length>0&&this.setOrderItems(a)}function forwardOrderModel(a){var b=this;if(this.forwardOrderDisplayState=ko.observable(a.forwardOrderDisplayState),this.receiverName=ko.observable(a.receiverName),this.forwardStatus=ko.observable(),this.exportStatus=ko.observable(),this.receiverId=ko.observable(),this.receiverType=ko.observable(),this.receiver=ko.observable(),this.forwardAddress=ko.observable(),this.forwardType=ko.observable(),this.forwardDate=ko.observable(),this.exportDate=ko.observable(),this.tourguideCode=ko.observable(a.tourguideCode),this.pickupCode=ko.observable(a.pickupCode),this.partnerId=ko.observable(a.partnerId),this.partnerName=ko.observable(a.partnerName),this.stateIcon=ko.observable(),this.tourStyle=ko.observable(),ko.utils.extend(b,new orderModel(a)),b.tourToName=ko.observable(),b.tourDate=ko.observable(),null!=b.orderItems&&b.orderItems().length>0&&null!=b.orderItems()[0]){var c=b.orderItems()[0];c.categoryKey()==CATEGORY_KEY_BERGBAHN?b.tourToName(c.toName()):b.tourToName(c.productName()),b.tourDate(c.date())}b.forwardOrderDisplayState()==FORWARD_ORDER_DISPLAY_STATE_PLANNED?(b.stateIcon("fa-cog"),b.tourStyle("requested-tour")):b.forwardOrderDisplayState()==FORWARD_ORDER_DISPLAY_STATE_SENT?(b.stateIcon("fa-check-square-o"),b.tourStyle("new-tour")):b.forwardOrderDisplayState()==FORWARD_ORDER_DISPLAY_STATE_CONFIRMED?(b.stateIcon("fa-shopping-basket"),b.tourStyle("fetch-tour")):b.forwardOrderDisplayState()==FORWARD_ORDER_DISPLAY_STATE_PICKED_UP&&(b.stateIcon("fa-check"),b.tourStyle("fetched-tour")),this.setForwardDetails=function(a){b.forwardOrderDisplayState(a.forwardOrderDisplayState),b.receiverName(a.receiverName),b.forwardStatus(a.forwardStatus),b.exportStatus(a.exportStatus),b.receiverId(a.receiverId),b.receiverType(a.receiverType);var c=ko.utils.arrayFirst(headerVM.Tourguides(),function(a){return a.id()===b.receiverId()});b.receiver(c),b.forwardAddress(a.forwardAddress),b.forwardType(a.forwardType),b.forwardDate(a.forwardDate),b.exportDate(a.exportDate)},this.isConfirmed=ko.pureComputed(function(){return null!=this.forwardOrderDisplayState()&&(this.forwardOrderDisplayState()==FORWARD_ORDER_DISPLAY_STATE_CONFIRMED||this.forwardOrderDisplayState()==FORWARD_ORDER_DISPLAY_STATE_PICKED_UP)},this)}function pickupOrderModel(a){var b=this;ko.utils.extend(b,new orderModel(a)),this.orderNr=ko.observable(a.orderNr),this.origOrderId=ko.observable(a.origOrderId)}function orderCancelInfoModel(a){var b=this;this.cancelability=ko.observable(a.cancelability),this.cancellationPeriodDefined=ko.observable(a.cancellationPeriodDefined),this.stillCancelableDays=ko.observable(a.stillCancelableDays),this.stillCancelableHours=ko.observable(a.stillCancelableHours),this.stillCancelableMinutes=ko.observable(a.stillCancelableMinutes),b.cancelabilityText=ko.computed(function(){if(b.cancelability()==ORDER_CANCEL_INFO_POSSIBLE){if(!b.cancellationPeriodDefined())return i18n.t("cancelInfo.possibleNoPeriod");if(b.stillCancelableDays()>0)return i18n.t("cancelInfo.possible",{stillCancelableDays:b.stillCancelableDays(),stillCancelableHours:b.stillCancelableHours(),stillCancelableMinutes:b.stillCancelableMinutes()});if(0==b.stillCancelableDays())return i18n.t("cancelInfo.possibleNoDays",{stillCancelableHours:b.stillCancelableHours(),stillCancelableMinutes:b.stillCancelableMinutes()})}else{if(b.cancelability()==ORDER_CANCEL_INFO_NOT_POSSIBLE)return i18n.t("cancelInfo.notPossible");if(b.cancelability()==ORDER_CANCEL_INFO_CANCELLED)return i18n.t("cancelInfo.cancelled")}})}function getOrderInstance(a){return a.type==ORDER_TYPE_FORWARD_ORDER?new forwardOrderModel(a):new orderModel(a)}function orderItemCancelInfoModel(a){this.cancelability=ko.observable(a.cancelability),this.cancelableUntil=ko.observable(a.cancelableUntil)}function orderItemModel(a){var b=this;if(this.id=ko.observable(a.id),this.type=ko.observable(a.type),this.status=ko.observable(a.status),this.ticketType=ko.observable(a.ticketType),this.ticketNr=ko.observable(a.ticketNr),this.orderId=ko.observable(a.orderId),this.externalOrderId=ko.observable(a.externalOrderId),this.externalOrderId=ko.observable(a.externalOrderId),this.createdAt=ko.observable(a.createdAt),this.refItemId=ko.observable(a.refItemId),this.origOrderId=ko.observable(a.origOrderId),this.origOrderItemId=ko.observable(a.origOrderItemId),this.origOrderCreatedAt=ko.observable(a.origOrderCreatedAt),this.categoryKey=ko.observable(a.categoryKey.toUpperCase()),a.categoryKey!=a.categoryName)this.categoryName=ko.observable(a.categoryName);else{var c=this.categoryKey().toLowerCase();this.categoryName=ko.observable(i18n.t("category.short."+c)),null!=headerVM.categoryLabelsMap&&null!=headerVM.categoryLabelsMap()[c]&&""!=headerVM.categoryLabelsMap()[c].categoryShortLabel()&&this.categoryName(headerVM.categoryLabelsMap()[c].categoryShortLabel())}this.durationKey=ko.observable(a.durationKey),this.durationName=ko.observable(a.durationName),this.price=ko.observable(a.price),this.priceCorrection=ko.observable(a.priceCorrection),this.amount=ko.observable(a.amount),this.currency=ko.observable(a.currency),this.sku=ko.observable(a.sku),this.productKey=ko.observable(a.productKey),this.productExtKey=ko.observable(a.productExtKey),this.consumerKey=ko.observable(a.consumerKey),this.consumerName=ko.observable(a.consumerName),this.seasonKey=ko.observable(a.seasonKey),this.seasonName=ko.observable(a.seasonName),this.regionKey=ko.observable(a.regionKey),this.regionName=ko.observable(a.regionName),this.date=ko.observable(a.date),this.toDate=ko.observable(a.toDate),this.mediaId=ko.observable(a.mediaId),this.media=ko.observable(a.media),this.cancelOrderItem=ko.observable(!1),this.cancelInfo=ko.observable(),this.pickupType=ko.observable(a.pickupType),this.rebateRuleId=ko.observable(a.rebateRuleId),this.reservationId=ko.observable(a.reservationId),this.contractorSystemStatus=ko.observable(a.contractorSystemStatus),this.vendingMachineStatus=ko.observable(a.vendingMachineStatus),this.pickupCode=ko.observable(a.pickupNr),this.dtaIdentificationNumber=ko.observable(a.dtaIdentificationNr),this.firstname=ko.observable(a.firstName),this.lastname=ko.observable(a.lastName),this.phone=ko.observable(a.phone),this.selectOrderItem=ko.observable(!0),this.exportStatus=ko.observable(a.exportStatus),this.exportDate=ko.observable(a.exportDate),this.ticketholder=ko.observable(),this.totalForwarded=ko.observable(a.totalForwarded),this.totalUsed=ko.observable(a.totalUsed),this.totalUsedUpdate=ko.observable(a.totalUsed),this.totalPrice=ko.observable(a.totalPrice),this.items=ko.observable(a.items),this.quantity=ko.observable(a.quantity),this.quantityProduce=ko.observable(0),this.quantityProduceOriginal=ko.observable(0),this.totalUsedUpdateAmount=ko.observable(0),this.touristCardPermissions=ko.observableArray(),this.focused=ko.observable(!1),this.serviceProviderPhone=ko.observable(a.serviceProviderPhone),this.note=ko.observable(a.note),this.extendedNote=ko.observable(a.extendedNote),this.startTime=ko.observable(a.startTime),this.startTimeTba=ko.observable(a.startTimeTba),this.packageMargin=ko.observable(a.packageMargin),this.focused=ko.observable(!1),this.dummyProduct=ko.observable(a.dummyProduct),b.showPrice=function(a){return!a||0==a.sku().indexOf("DAYTRIPS.EPR")},this.setTouristCardPermissions=function(a,b){if(null!=a.touristCardPermissions){var c=$.map(a.touristCardPermissions,function(a){return new touristCardPermissionsModel(a)});c=ko.utils.arrayFilter(c,function(a){return-1!=b.indexOf(a.key()+",")}),this.touristCardPermissions(c)}},this.maxQuantity=ko.pureComputed(function(){if(null!=this.quantity()){return Math.min(this.quantity(),MAX_ORDERITEMS_FOR_PRODUCTION)}return null},this),this.dateChanged=ko.observable(!1),null!=a.cancelInfo&&this.cancelInfo(new orderItemCancelInfoModel(a.cancelInfo)),null!=a.ticketholder&&this.ticketholder(new ticketholderModel(a.ticketholder)),this.cancelable=ko.pureComputed(function(){return null!=this.cancelInfo()&&this.cancelInfo().cancelability()==ORDER_ITEM_CANCEL_INFO_POSSIBLE},this),this.canceled=ko.pureComputed(function(){return null!=this.cancelInfo()&&this.cancelInfo().cancelability()==ORDER_ITEM_CANCEL_INFO_CANCELLED},this)}function orderItemSkiModel(a){var b=this;ko.utils.extend(b,new orderItemModel(a)),this.durationKey=ko.observable(a.durationKey),this.durationName=ko.observable(a.durationName),this.regionKey=ko.observable(a.regionKey),this.regionName=ko.observable(a.regionName)}function orderItemBergbahnModel(a){var b=this;if(ko.utils.extend(b,new orderItemModel(a)),b.fromKey=ko.observable(a.fromKey),b.fromName=ko.observable(a.fromName),b.toKey=ko.observable(a.toKey),b.toName=ko.observable(a.toName),b.viaKey=ko.observable(a.viaKey),b.viaName=ko.observable(a.viaName),b.viaStationName=ko.observable(a.viaStationName),b.viaDisplayText=ko.observable(a.viaDisplayText),b.classKey=ko.observable(a.classKey),b.tripTypeKey=ko.observable(a.tripTypeKey),b.deptime=ko.observable(a.deptime),b.arrtime=ko.observable(a.arrtime),b.tariffKey=ko.observable(),b.personKey=ko.observable(),b.className=ko.observable(),b.tripTypeName=ko.observable(),b.consumerKey()){var c=b.consumerKey().split(".");c.length>0&&b.tariffKey(c[0]),c.length>1&&b.personKey(c[1])}b.classKey()&&b.className(i18n.t("bergbahn.bergbahn-class."+b.classKey())),b.tripTypeKey()&&b.tripTypeName(i18n.t("bergbahn.bergbahn-tripType."+b.tripTypeKey()))}function orderItemRestaurantGroupReservationModel(a){var b=this;ko.utils.extend(b,new orderItemModel(a)),b.productName=ko.observable(a.productName),b.status=ko.observable(a.status)}function orderItemCargoModel(a){var b=this;ko.utils.extend(b,new orderItemModel(a)),b.productName=ko.observable(a.productName),b.consumerName=ko.observable(a.wareTypeLabel),b.barcode=ko.observable(a.barcode),b.shipmentDate=ko.observable(a.shipmentDate),b.stationFrom=ko.observable(a.stationFrom),b.stationTo=ko.observable(a.stationTo),b.sender=ko.observable(a.sender),b.receiver=ko.observable(a.receiver),b.payer=ko.observable(a.payer),b.quantityExchangePallet=ko.observable(a.quantityExchangePallet),b.quantityExchangeFrame=ko.observable(a.quantityExchangeFrame),b.quantityExchangeBoard=ko.observable(a.quantityExchangeBoard),b.wareType=ko.observable(a.wareType),b.transportType=ko.observable(a.transportType),b.packaging=ko.observable(a.packaging),b.quantity=ko.observable(a.quantity),b.totalWeight=ko.observable(a.totalWeight),b.fee=ko.observable(a.fee),b.quantityFee=ko.observable(a.quantityFee),b.reference=ko.observable(a.reference),b.stationFromLabel=ko.observable(a.stationFromLabel),b.stationToLabel=ko.observable(a.stationToLabel),b.wareTypeLabel=ko.observable(a.wareTypeLabel),b.transportTypeLabel=ko.observable(a.transportTypeLabel),b.senderLabel=ko.observable(a.senderLabel),b.receiverLabel=ko.observable(a.receiverLabel),b.payerLabel=ko.observable(a.payerLabel)}function orderItemSubserviceModel(a){var b=this;ko.utils.extend(b,new orderItemModel(a)),b.productName=ko.observable(a.productName),b.consumerName=ko.observable(a.consumerKey),b.personGroupKey=ko.observable(a.personGroupKey),b.personGroupName=ko.observable(a.personGroupName),b.durationOverwrite=ko.observable(a.durationOverwrite)}function orderItemRestaurantModel(a){var b=this;ko.utils.extend(b,new orderItemModel(a)),b.productName=ko.observable(a.productName),b.consumerName=ko.observable(a.consumerName),b.regionName=ko.observable(a.regionName),b.cityName=ko.observable(a.cityName),b.personGroupKey=ko.observable(a.personGroupKey),b.personGroupName=ko.observable(a.personGroupName)}function orderItemPublicTransportationModel(a){var b=this;ko.utils.extend(b,new orderItemBergbahnModel(a))}function orderItemBergbahnEprModel(a){var b=this;ko.utils.extend(b,new orderItemBergbahnModel(a)),this.viaKey()&&(this.direction=ko.observable(this.viaKey().split(".")[2].substr(0,1))),this.routeName=ko.pureComputed(function(){return b.direction()==BERGBAHN_EPR_VIA_PREFIX_UP?b.fromName()+" - "+b.toName():b.direction()==BERGBAHN_EPR_VIA_PREFIX_DOWN?b.toName()+" - "+b.fromName():void 0},this),this.train=ko.pureComputed(function(){var a=this.viaKey().split(".")[2];a.substr(0,1);return a.substr(1,2)+":"+a.substr(3,2)},this)}function orderItemBusModel(a){var b=this;ko.utils.extend(b,new orderItemBergbahnModel(a)),this.direction=ko.observable(this.viaKey().split(".")[2].substr(0,1)),this.routeName=ko.pureComputed(function(){return b.direction()==BERGBAHN_EPR_VIA_PREFIX_UP?i18n.t("sales.bus.routeUp",{from:b.fromName(),to:b.toName()}):b.direction()==BERGBAHN_EPR_VIA_PREFIX_DOWN?i18n.t("sales.bus.routeDown",{from:b.toName(),to:b.fromName()}):void 0},this),this.trainDate=ko.pureComputed(function(){var a=this.viaKey().split(".")[2],c=(a.substr(0,1),a.substr(1,2)),d=a.substr(3,2),e=c+":"+d;return b.date()+" "+e},this),this.train=ko.pureComputed(function(){var a=this.viaKey().split(".")[2],b=a.substr(0,1),c=a.substr(1,2),d=a.substr(3,2),e=c+":"+d;return b==BERGBAHN_EPR_VIA_PREFIX_UP?i18n.t("sales.bus.timeBusUp",{deptime:e}):b==BERGBAHN_EPR_VIA_PREFIX_DOWN?i18n.t("sales.bus.timeBusDown",{arrtime:e}):void 0},this)}function orderItemBundleModel(a){var b=this;ko.utils.extend(b,new orderItemModel(a)),this.productName=ko.observable(a.productName),this.bundleItems=ko.observableArray(),this.setBundleItems=function(a){var b=$.map(a.bundleItems,function(a){return getOrderItemInstace(a)});this.bundleItems(b)},b.setBundleItems(a)}function orderItemAddonModel(a){var b=this;ko.utils.extend(b,new orderItemModel(a)),this.productName=ko.observable(a.productName),
null!=a.eprInfo&&null!=a.eprInfo&&null!=a.eprInfo.departureDateTime&&a.eprInfo.departureDateTime.length>11&&null!=a.eprInfo.arrivalDateTime&&a.eprInfo.arrivalDateTime.length>11&&(this.timeslot=ko.observable(a.eprInfo.departureDateTime.substring(11)+" - "+a.eprInfo.arrivalDateTime.substring(11)),this.timeslotChanged=ko.observable(!1),this.availableTrains=ko.observable(),this.availableTimes=ko.observable(),this.productId=ko.observable(a.eprInfo.productId),this.eprInfo=a.eprInfo,loadContingent(a,b)),this.externalDisableFlag=ko.observable(!1),this.produceDisabled=ko.observable(!0)}function loadContingent(a,b){var c=a.date,d=a.eprInfo.productId,e=a.eprInfo.availableTrains,f=a.eprInfo.availableTimes;$.getJSON(serviceRootURL+"/contingent_info",{categoryKey:CATEGORY_KEY_BERGBAHN_EPR,dateString:c,productId:d}).done(function(c){for(var d=$.map(c,function(a){return new categoryContingentModel(a)}),g=[],h=[],i=0;i<e.length;i++)for(var j=0;j<d.length;j++)d[j].id()==e[i]&&d[j].freeSeats()>0&&(g.push(e[i]),h.push(f[i]));b.availableTrains(g),b.availableTimes(h),b.timeslot(a.eprInfo.departureDateTime.substring(11)+" - "+a.eprInfo.arrivalDateTime.substring(11)),console.log("Chosen timeslot: "+b.timeslot())}).fail(function(){console.log("Timeselection contingent info not found for addon",d,c)})}function orderItemCateringModel(a){var b=this;ko.utils.extend(b,new orderItemModel(a)),this.productName=ko.observable(a.productName),this.reservationId=ko.observable(a.reservationId)}function orderItemRailwaySeatReservationModel(a){var b=this;ko.utils.extend(b,new orderItemBergbahnModel(a)),b.productName=ko.observable(a.productName),b.seatNumber=ko.observable(a.seat),b.seatNumber()&&b.seatNumber(i18n.t("trainReservation.seat.number")+" "+b.seatNumber())}function orderItemRailwaySeatReservationMragModel(a){var b=this;ko.utils.extend(b,new orderItemBergbahnModel(a)),b.productName=ko.observable(a.productName),b.seatNumber=ko.observable(a.seat),b.seatNumber()&&b.seatNumber(i18n.t("trainReservation.seat.number")+" "+b.seatNumber())}function orderItemLocalEventModel(a){var b=this;ko.utils.extend(b,new orderItemModel(a)),this.productName=ko.observable(a.parentProductName),this.regionId=ko.observable(a.regionId),this.regionName=ko.observable(a.regionName),this.accommCityId=ko.observable(a.accommCityId),this.accommCityName=ko.observable(a.accommCityName),this.accommCityName=ko.observable(a.accommCityName),this.eventType=ko.observable(a.eventType),this.eventCategory=ko.observable(a.eventCategory)}function orderItemMarginModel(a){var b=this;ko.utils.extend(b,new orderItemModel(a)),this.productName=ko.observable(a.productName),this.priceCorrectionEdit=ko.observable(b.priceCorrection())}function orderItemAdhocModel(a){var b=this;ko.utils.extend(b,new orderItemModel(a)),this.productName=ko.observable(a.productName)}function orderItemTouristTaxModel(a){var b=this;ko.utils.extend(b,new orderItemModel(a)),this.regionId=ko.observable(a.regionId),this.regionName=ko.observable(a.regionName),this.accommCityId=ko.observable(a.accommCityId),this.accommCityName=ko.observable(a.accommCityName)}function orderItemHotelModel(a){var b=this;ko.utils.extend(b,new orderItemModel(a)),this.productName=ko.observable(a.productName),b.regionKey=ko.observable(a.regionId),this.regionName=ko.observable(a.regionName),this.roomCategoryName=ko.observable(a.roomCategoryName),this.occupancy=ko.observable(a.occupancy),this.occupancyInfo=ko.observable(a.occupancyInfo),this.accommRateTypeName=ko.observable(a.accommRateTypeName),this.accommRateTypeKey=ko.observable(a.accommRateTypeKey),this.roomName=ko.observable(a.roomName),this.roomCategoryId=ko.observable(a.roomCategoryId),this.mealName=ko.observable(a.mealName),this.stars=ko.observable(a.stars),this.personGroupName=ko.observable(a.personGroupName),this.accommCityId=ko.observable(a.accommCityId),this.accommCityName=ko.observable(a.accommCityName),this.priceCorrectionEdit=ko.observable(b.priceCorrection()),this.starsInfo=ko.observable(),b.serviceCode=ko.observable(a.serviceCode),b.serviceCodeDisplay=ko.pureComputed(function(){return b.serviceCode()&&"standard"!=b.serviceCode()?a.serviceCodeDisplay:null}),b.stars()&&b.starsInfo(i18n.t("shop.hotel.starsInfo",{stars:b.stars().number}))}function orderItemDepotModel(a){var b=this;ko.utils.extend(b,new orderItemModel(a)),this.productName=ko.observable(a.productName),this.roomKey=ko.observable(a.roomKey),this.roomName=ko.observable(a.roomName),this.durationTypeKey=ko.observable(a.durationTypeKey),this.durationTypeName=ko.observable(a.durationTypeName),this.duration=ko.observable(a.duration),this.consumerKey=ko.observable(a.consumerKey),this.consumerName=ko.observable(a.consumerName)}function orderItemAutoverladModel(a){var b=this;ko.utils.extend(b,new orderItemModel(a)),this.productName=ko.observable(a.productName),this.productShortDescription=ko.observable(a.productShortDescription),this.stationKey=ko.observable(a.stationKey),this.stationName=ko.observable(a.stationName),this.typeKey=ko.observable(a.typeKey),this.typeName=ko.observable(a.typeName),this.dateCategoryKey=ko.observable(a.dateCategoryKey),this.dateCategoryName=ko.observable(a.dateCategoryName),this.dateFrom=ko.observable(a.fromDate),this.dateTo=ko.observable(a.toDate),this.consumerKey=ko.observable(a.consumerKey),this.consumerName=ko.observable(a.consumerName)}function OrderItemParkingModel(a){var b=this;ko.utils.extend(b,new orderItemModel(a)),this.productName=ko.observable(a.productName),this.duration=ko.observable(a.duration),this.consumerKey=ko.observable(a.consumerKey),this.consumerName=ko.observable(a.consumerName)}function getOrderItemInstace(a){if(null!=a.categoryKey&&a.categoryKey.toUpperCase()==CATEGORY_KEY_SKIPASS)return new orderItemSkiModel(a);if(null!=a.categoryKey&&a.categoryKey.toUpperCase()==CATEGORY_KEY_BERGBAHN)return new orderItemBergbahnModel(a);if(null!=a.categoryKey&&a.categoryKey.toUpperCase()==CATEGORY_KEY_PUBLICTRANSPORTATION)return new orderItemPublicTransportationModel(a);if(null!=a.categoryKey&&a.categoryKey.toUpperCase()==CATEGORY_KEY_BERGBAHN_EPR)return new orderItemBergbahnEprModel(a);if(null!=a.categoryKey&&a.categoryKey.toUpperCase()==CATEGORY_KEY_BERGBAHN_GROUP_RESERVATION)return new orderItemBergbahnModel(a);if(null!=a.categoryKey&&a.categoryKey.toUpperCase()==CATEGORY_KEY_RAILWAY_SEAT_RESERVATION)return new orderItemRailwaySeatReservationModel(a);if(null!=a.categoryKey&&a.categoryKey.toUpperCase()==CATEGORY_KEY_RAILWAY_SEAT_RESERVATION_TIMETABLE)return new orderItemRailwaySeatReservationModel(a);if(null!=a.categoryKey&&a.categoryKey.toUpperCase()==CATEGORY_KEY_RAILWAY_SEAT_RESERVATION_MRAG)return new orderItemRailwaySeatReservationMragModel(a);if(null!=a.categoryKey&&a.categoryKey.toUpperCase()==CATEGORY_KEY_CATERING)return new orderItemCateringModel(a);if(null!=a.categoryKey&&a.categoryKey.toUpperCase()==CATEGORY_KEY_BUS)return new orderItemBusModel(a);if(null!=a.categoryKey&&a.categoryKey.toUpperCase()==CATEGORY_KEY_BUNDLE)return new orderItemBundleModel(a);if(null!=a.categoryKey&&a.categoryKey.toUpperCase()==CATEGORY_KEY_ADDON)return new orderItemAddonModel(a);if(null!=a.categoryKey&&a.categoryKey.toUpperCase()==CATEGORY_KEY_LOCAL_EVENT)return new orderItemLocalEventModel(a);if(null!=a.categoryKey&&a.categoryKey.toUpperCase()==CATEGORY_KEY_SPECIAL_EVENT)return new orderItemLocalEventModel(a);if(null!=a.categoryKey&&a.categoryKey.toUpperCase()==CATEGORY_KEY_HOTEL)return new orderItemHotelModel(a);if(null!=a.categoryKey&&a.categoryKey.toUpperCase()==CATEGORY_KEY_MARGIN)return new orderItemMarginModel(a);if(null!=a.categoryKey&&a.categoryKey.toUpperCase()==CATEGORY_KEY_ADHOC)return new orderItemAdhocModel(a);if(null!=a.categoryKey&&a.categoryKey.toUpperCase()==CATEGORY_KEY_TOURIST_TAX)return new orderItemTouristTaxModel(a);if(null!=a.categoryKey&&a.categoryKey.toUpperCase()==CATEGORY_KEY_DEPOT)return new orderItemDepotModel(a);if(null==a.categoryKey||a.categoryKey.toUpperCase()!=CATEGORY_KEY_MENU&&a.categoryKey.toUpperCase()!=CATEGORY_KEY_DRINK){if(null!=a.categoryKey&&a.categoryKey.toUpperCase()==CATEGORY_KEY_PARKING)return new OrderItemParkingModel(a);if(null!=a.categoryKey&&a.categoryKey.toUpperCase()==CATEGORY_KEY_CARGO)return new orderItemCargoModel(a);if(null!=a.categoryKey&&a.categoryKey.toUpperCase()==CATEGORY_KEY_AUTOVERLAD)return new orderItemAutoverladModel(a);if(null!=a.categoryKey&&a.categoryKey.toUpperCase()==CATEGORY_KEY_SUBSERVICE)return new orderItemSubserviceModel(a);if(null!=a.categoryKey&&a.categoryKey.toUpperCase()==CATEGORY_KEY_RESTAURANT)return new orderItemRestaurantModel(a);var b="category not supported: "+a.categoryKey;throw alert(b),b}return new orderItemRestaurantGroupReservationModel(a)}function categoryContingentModel(a){var b=this;b.id=ko.observable(),b.date=ko.observable(),b.localizedDate=ko.observable(),b.status=ko.observable(),b.contingent=ko.observable(),b.available=ko.observable(),b.freeSeats=ko.observable(),b.categoryContingents=ko.observableArray(),b.update=function(a){b.id(a.id),b.date(a.date),b.localizedDate(new Date(a.date).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})),b.status(a.status),b.freeSeats(a.freeSeats),b.contingent(a.contingent),a.freeSeats>=0?b.available(a.freeSeats):b.available(100),b.categoryContingents(a.categoryContingents)},b.update(a),b.isTimeSlotContingent=ko.pureComputed(function(){return"00:00:00"!=moment(b.date(),"YYYY-MM-DDTHH:mm:ss").format("HH:mm:ss")}),b.contingentText=ko.computed(function(){var a=null;return-1==b.freeSeats()?a=i18n.t("shop.contingent.ticketsAvailable."):null!=b.contingent()&&b.contingent()>0&&null!=b.freeSeats()?a=b.freeSeats()+" / "+b.contingent():null!=b.contingent()&&0==b.contingent()&&null!=b.freeSeats()&&(a=b.freeSeats()+" "+i18n.t("shop.contingent.ticketsAvailable.")),a}),b.contingentPercent=ko.computed(function(){var a=100;return null!=b.contingent()&&0!==b.contingent()&&null!=b.freeSeats()&&-1!=b.freeSeats()?a=10*Math.ceil(b.freeSeats()/b.contingent()*10):null!=b.contingent()&&0==b.contingent()&&0==b.freeSeats()&&(a=0),a})}function touristCardPermissionsModel(a){this.key=ko.observable(a.key),this.name=ko.observable(a.name),this.description=ko.observable(a.description),this.hasContingent=ko.observable(a.has_contingent),this.maxAvailable=ko.observable(a.max_available),this.available=ko.observable(a.available)}function personalisationModel(a){var b=this,c=kp.get(a,"additional",[]),d=kp.get(a,"personalisation",[]),e=kp.get(a,"general",[]),f={personalisation:{},additional:{},type:{}};b.personalisationFields=ko.observable({}),b.additionalFields=ko.observableArray([]),b.generalConfiguration=ko.observableArray(e);for(var g=["name","address","birthdate","phone","gender","language","email"],h=0;h<g.length;h++){var i=g[h],j=i;"address"==i&&(j="street"),"birthdate"==i&&(j="dob"),"phone"==i&&(j="phone"),"name"==i&&(j="firstName");var k=-1!==d.indexOf(j);k&&(f.personalisation[i]=ko.observable(null)),b.personalisationFields()[i]=k}for(var h=0;h<c.length;h++){var i=c[h],l=ko.observable(null);f.additional[i.id]=l,b.additionalFields.push(new personalisationModelField(i,l))}f.type=a.type,this.data=ko.observable(f),this.hasAdditionalFields=ko.computed(function(){return b.additionalFields().length>0})}function personalisationModelField(a,b){var c=this;c.id=ko.observable(a.id),c.label=ko.observable(a.label),c.type=ko.observable(a.type),c.options=ko.observable(a.options),c.frontend=ko.observable(a.frontend),c.required=ko.observable(a.required),c.pattern=ko.observable(a.pattern),c.patternmsg=ko.observable(a.patternmsg),c.parsleyType=ko.observable(a.parsleyType);var d=a.inputType||"text";c.inputType=ko.observable(d),c.value=b,c.visibleInFrontend=ko.computed(function(){return ko.unwrap(c.frontend)}),c.isRequired=ko.computed(function(){return ko.unwrap(c.required)})}function ticketholderModel(a){var b=this;b.id=ko.observable(),b.gender=ko.observable(),b.firstName=ko.observable(),b.lastName=ko.observable(),b.street=ko.observable(),b.streetNumber=ko.observable(),b.streetNameAndNr=ko.observable(),b.zipCode=ko.observable(),b.city=ko.observable(),b.country=ko.observable(),b.birthDate=ko.observable(),b.phone=ko.observable(),b.email=ko.observable(),b.encodedPhoto=ko.observable(),b.birthdateMonth=ko.observable(),b.birthdateDay=ko.observable(),b.birthdateYear=ko.observable(),b.upgradedItem=ko.observable(),b.containsSwisspassData=ko.observable(),b.nationality=ko.observable(),b.secondName=ko.observable(),b.language=ko.observable(),b.idType=ko.observable(),b.idNumber=ko.observable(),b.residenceTaxExemption=ko.observable(),b.accommodationTaxExemption=ko.observable(),b.taxPersonGroupId=ko.observable(),b.taxRateCode=ko.observable(),b.accommodationTaxRate=ko.observable(),b.arrivalBy=ko.observable(),b.setData=function(a){if(b.id(a.id),b.gender(a.gender),b.firstName(a.firstName),b.lastName(a.lastName),b.streetNameAndNr(a.streetNameAndNr),b.zipCode(a.zipCode),b.city(a.city),b.country(a.country),b.phone(a.phone),b.email(a.email),b.encodedPhoto(a.encodedPhoto),b.containsSwisspassData(!1),null!=a.birthDateString){var c=$.datepicker.parseDate(DATE_SERVER_FORMAT,a.birthDateString);b.birthdateMonth(c.getMonth()+1),b.birthdateDay(c.getDate()),b.birthdateYear(c.getFullYear())}else b.birthdateMonth(void 0),b.birthdateDay(void 0),b.birthdateYear(void 0);b.language(a.language),b.idType(a.idType),b.idNumber(a.idNumber),b.secondName(a.secondName),b.nationality(a.nationality),b.residenceTaxExemption(a.residenceTaxExemption),b.accommodationTaxExemption(a.accommodationTaxExemption),b.taxPersonGroupId=ko.observable(a.taxPersonGroupId),b.arrivalBy(a.arrivalBy)},a&&null!==a&&b.setData(a),b.birthDateDate=ko.observable(),b.birthDate=ko.computed(function(){if(b.birthdateMonth()&&b.birthdateDay()&&b.birthdateYear()){var a=b.birthdateYear()+"-"+b.birthdateMonth()+"-"+b.birthdateDay(),c=moment(a,"YYYY-MM-DD");if(!c.isValid())return;var d=c.toDate();return b.birthDateDate(d),$.datepicker.formatDate(DATE_SERVER_FORMAT,d)}},b)}function RegistrationConfigModel(a){var b=this;b.initialized=ko.observable(!1),b.idTypeOptions=ko.observableArray([]),b.nationalityOptions=ko.observableArray([]),b.countryOptions=ko.observableArray([]),b.touristTaxExemptionOptions=ko.observableArray([]),b.accommodationTaxExemptionOptions=ko.observableArray([]),b.touristTaxConfigList=ko.observableArray(),b.personGroupOptionList=ko.observableArray(),b.filterdPersonGroupOptionList=ko.observableArray(),b.showAccommodationTax=ko.observable(!1),b.showTouristTax=ko.observable(!1),b.personGroupTravelDates=ko.observable(!1),b.preselectedCountry=ko.observable(!1),b.showPersongroupMaintraveller=ko.observable(!1),b.registrationOverviewColored=ko.observable(!1),b.defaultIdType=ko.observable(),b.genericCheckinGlobal=ko.observable(!1),b.mainTravellerFields=ko.observableArray([]),b.fellowTravellerFields=ko.observableArray([]),b.mandatoryTravellerFields=ko.observableArray([]),b.arrivalByOptions=ko.observableArray(),b.kantonOptions=ko.observableArray(),b.showServiceproviderSpecificFormId=ko.observable(!1),b.allowProlongationOfActivatedGuestcards=ko.observable(!1),b.allowArrivalDateChangeWithActiveGuestcard=ko.observable(!1),b.idReferenceNonMandatoryCountries=ko.observable(!1),b.printVersion=ko.observable(),b.printVersionAnalogGuestcard=ko.observable(!1),b.hidePrintAnalogGuestcardMessage=ko.observable(!1),b.showCheckinCheckout=ko.observable(!1),b.useMaintravellerSurname=ko.observable(!1),b.showQuickcheckinInOverview=ko.observable(!1),b.showGuestcardInOverview=ko.observable(!1),b.disableIncompleteForms=ko.observable(!0),b.languageOptions=ko.observableArray([]),b.supportCms=ko.observable(!1);var c=function(a){b.personGroupOptionList([]),b.filterdPersonGroupOptionList([]),b.touristTaxConfigList(a);var c=new Set;b.touristTaxConfigList().forEach(function(a){c.has(a.personGroupId)||(c.add(a.personGroupId),a.label=i18n.t("registration.details.personGroupEnum."+a.personGroupName),b.personGroupOptionList.push(a),"Befreite"!=a.personGroupName&&b.filterdPersonGroupOptionList.push(a))})};b.getPersonGroupByCode=function(a){for(var c=0;c<b.personGroupOptionList().length;c++){var d=b.personGroupOptionList()[c];if(d.taxRateCode==a)return d}return console.error("Failed to look up person group for code",a,b.personGroupOptionList()),null},b.getPersonGroupForId=function(a){for(var c=0;c<b.personGroupOptionList().length;c++){var d=b.personGroupOptionList()[c];if(d.personGroupId==a)return d}return console.error("Failed to look up person group for id",a,b.personGroupOptionList()),null},b.getPersonGroupForAge=function(a){for(var c=0;c<b.personGroupOptionList().length;c++){var d=b.personGroupOptionList()[c];if((null!=d.ageFrom||null!=d.ageTo)&&(d.ageFrom<=a&&(null==d.ageTo||a<=d.ageTo)))return d}return console.error("Failed to look up person group for age",a,b.personGroupOptionList()),null},b.getIdTypeNameByKey=function(a){for(var c=0;c<b.idTypeOptions().length;c++){var d=b.idTypeOptions()[c];if(d.key==a)return d.name}return console.warn("Failed to look up Id type",a,b.idTypeOptions()),null},b.getNationalityNameByKey=function(a){for(var c=0;c<b.nationalityOptions().length;c++){var d=b.nationalityOptions()[c];if(d.key==a||d.key.toLowerCase()==a)return d.name}return console.warn("Failed to look up nationality",a,b.nationalityOptions()),null},b.getCountryNameByKey=function(a){for(var c=0;c<b.countryOptions().length;c++){var d=b.countryOptions()[c];if(d.key==a||d.key.toLowerCase()==a)return d.name}return console.warn("Failed to look up country",a,b.countryOptions()),null},b.getResidenceTaxExemptionNameByKey=function(a){for(var c=0;c<b.touristTaxExemptionOptions().length;c++){var d=b.touristTaxExemptionOptions()[c];if(d.key==a)return d.name}return console.warn("Failed to look up tax exemption",a,b.touristTaxExemptionOptions()),null},b.getAccommodationTaxExemptionNameByKey=function(a){for(var c=0;c<b.accommodationTaxExemptionOptions().length;c++){var d=b.accommodationTaxExemptionOptions()[c];if(d.key==a)return d.name}return console.warn("Failed to look up accommodation tax exemption",a,b.accommodationTaxExemptionOptions()),null},b.getArrivalByNameByKey=function(a){for(var c=0;c<b.arrivalByOptions().length;c++){var d=b.arrivalByOptions()[c];if(d.key==a)return d.name}return console.warn("Failed to look up arrival type",a,b.arrivalByOptions()),null},b.isMandatory=function(a,c){if(menuVM.hasRegistrationNonMandatory())return!1;if(b.idReferenceNonMandatoryCountries()&&"idTypeAndNr"===a){var d=b.idReferenceNonMandatoryCountries().toUpperCase();if(c()&&-1!==d.indexOf(c()))return!1}return null!=ko.utils.arrayFirst(b.mandatoryTravellerFields(),function(b){return b==a})},b.isConfigured=function(a,c){if(c){var d=ko.utils.arrayFirst(b.mainTravellerFields(),function(b){return b==a});return null!=d}var d=ko.utils.arrayFirst(b.fellowTravellerFields(),function(b){return b==a});return null!=d},b.isAddressRowVisible=function(a){var c=["phone","streetNameAndNr","country","zipAndCity"],d=!1,e=a?b.mainTravellerFields():b.fellowTravellerFields();return c.forEach(function(a){null!=ko.utils.arrayFirst(e,function(b){return b==a})&&(d=!0)}),d},b.setData=function(a){a&&(a.idTypeOptions&&a.idTypeOptions.forEach(function(a){b.idTypeOptions.push({key:a.key,name:a.localizedValue})}),a.nationalityOptions&&a.nationalityOptions.forEach(function(a){b.nationalityOptions.push({key:a.key,name:a.localizedValue})}),a.countryOptions&&a.countryOptions.forEach(function(a){b.countryOptions.push({key:a.key,name:a.localizedValue})}),a.touristTaxExemptionOptions&&a.touristTaxExemptionOptions.forEach(function(a){b.touristTaxExemptionOptions.push({key:a.key,name:a.localizedValue})}),a.accommodationTaxExemptionOptions&&a.accommodationTaxExemptionOptions.forEach(function(a){b.accommodationTaxExemptionOptions.push({key:a.key,name:a.localizedValue})}),a.arrivalByOptions&&a.arrivalByOptions.forEach(function(a){b.arrivalByOptions.push({key:a.key,name:a.localizedValue})}),a.kantonOptions&&a.kantonOptions.forEach(function(a){b.kantonOptions.push({key:a.key,name:a.localizedValue})}),a.languageOptions&&a.languageOptions.forEach(function(a){b.languageOptions.push({key:a.key,name:a.localizedValue})}),a.touristTaxConfig&&c(a.touristTaxConfig),a.showAccommodationTax&&b.showAccommodationTax(a.showAccommodationTax),a.showTouristTax&&b.showTouristTax(a.showTouristTax),a.personGroupTravelDates&&b.personGroupTravelDates(a.personGroupTravelDates),a.showPersongroupMaintraveller&&b.showPersongroupMaintraveller(a.showPersongroupMaintraveller),a.preselectedCountry&&b.preselectedCountry(a.preselectedCountry),a.registrationOverviewColored&&b.registrationOverviewColored(a.registrationOverviewColored),a.defaultIdType&&b.defaultIdType(a.defaultIdType),a.genericCheckinGlobal&&b.genericCheckinGlobal(a.genericCheckinGlobal),a.mainTravellerFields&&b.mainTravellerFields(a.mainTravellerFields),a.fellowTravellerFields&&b.fellowTravellerFields(a.fellowTravellerFields),a.mandatoryTravellerFields&&b.mandatoryTravellerFields(a.mandatoryTravellerFields),a.useMaintravellerSurname&&b.useMaintravellerSurname(a.useMaintravellerSurname),a.idReferenceNonMandatoryCountries&&b.idReferenceNonMandatoryCountries(a.idReferenceNonMandatoryCountries),a.printVersion&&b.printVersion(a.printVersion),a.printVersionAnalogGuestcard&&b.printVersionAnalogGuestcard(a.printVersionAnalogGuestcard),a.hidePrintAnalogGuestcardMessage&&b.hidePrintAnalogGuestcardMessage(a.hidePrintAnalogGuestcardMessage),a.showServiceproviderSpecificFormId&&b.showServiceproviderSpecificFormId(a.showServiceproviderSpecificFormId),a.allowProlongationOfActivatedGuestcards&&b.allowProlongationOfActivatedGuestcards(a.allowProlongationOfActivatedGuestcards),a.allowArrivalDateChangeWithActiveGuestcard&&b.allowArrivalDateChangeWithActiveGuestcard(a.allowArrivalDateChangeWithActiveGuestcard),a.showCheckinCheckout&&b.showCheckinCheckout(a.showCheckinCheckout),a.showQuickcheckinInOverview&&b.showQuickcheckinInOverview(a.showQuickcheckinInOverview),a.showGuestcardInOverview&&b.showGuestcardInOverview(a.showGuestcardInOverview),a.supportCms&&b.supportCms(a.supportCms),a.hasOwnProperty("disableIncompleteForms")&&b.disableIncompleteForms(a.disableIncompleteForms),b.initialized(!0))},b.setData(a)}function RegistrationOverviewModel(a){var b=this;b.jsonData=a,b.id=ko.observable(),b.importId=ko.observable(),b.webshopBooking=ko.observable(),b.genericQuickCheckin=ko.observable(!1),b.createdAt=ko.observable(),b.status=ko.observable(),b.taxRateTotal=ko.observable(),b.mainPersonName=ko.observable(),b.fromDate=ko.observable(),b.toDate=ko.observable(),b.guestStatus=ko.observable(),b.travelStatus=ko.observable(),b.accommodationTaxTotal=ko.observable(),b.exportDate=ko.observable(),b.duplicateRefId=ko.observable(),b.duplicateRefHash=ko.observable(),b.resellerPartnerId=ko.observable(),b.hash=ko.observable(),b.formIdProvider=ko.observable(),b.serviceProviderExternalId=ko.observable(),b.quickStatus=ko.observable(),b.guestcardActivated=ko.observable(),b.guestcardCanceled=ko.observable(!1),b.analogGuestcardActivated=ko.observable(),b.manualQuickCheckinStatus=ko.observable(),b.autoQuickCheckinStatus=ko.observable(),b.quickCheckinMailSendDate=ko.observable(null),b.guestcardMailSendDate=ko.observable(null),b.guestcardDefinitionAvailable=ko.observable(),b.guestCardMailStatus=ko.observable(),b.mainPersonDirectPurchaseStatus=ko.observable(),b.quickStatusSubmitTime=ko.observable(),b.markAsDuplicate=ko.computed(function(){return!(!b.duplicateRefId()||b.status()!=REGISTRATION_FORM_STATES_ENUM.REGISTERED_NOT_VERIFIED)}),b.getServiceProviderName=ko.pureComputed(function(){for(var a=0;a<headerVM.assignedServiceProviderList().length;a++){var c=headerVM.assignedServiceProviderList()[a];if(c.serviceProviderExternalId===b.serviceProviderExternalId())return c.name}return null}),b.resellerNumber=function(){return registrationVM&&registrationVM.registrationConfig.showServiceproviderSpecificFormId()?b.formIdProvider():b.resellerPartnerId()?"#"+b.resellerPartnerId()+" - "+b.id():"#"+b.id()},b.getGuestcardText=ko.computed(function(){return b.jsonData.personList[0].residenceTaxExemption>0?i18n.t("registration.overview.businessTraveller"):b.guestcardCanceled()?i18n.t("registration.overview.guestcardCanceled"):"complete"==b.mainPersonDirectPurchaseStatus()&&b.guestcardActivated()?b.analogGuestcardActivated()?i18n.t("registration.overview.analogGuestcardActive"):i18n.t("registration.overview.digitalGuestcardActive"):"error"==b.mainPersonDirectPurchaseStatus()?i18n.t("registration.overview.guestcardActivationError"):b.guestCardMailStatus()?i18n.t("registration.overview.guestcardMailSend")+" "+b.guestcardMailSendDate():b.guestcardDefinitionAvailable()?b.jsonData.personList[0].email?i18n.t("registration.overview.notActivated"):i18n.t("registration.overview.noEmailAddress"):i18n.t("registration.overview.notAvailable")}).extend({throttle:10}),b.getGuestcardCss=ko.computed(function(){return b.jsonData.personList[0].residenceTaxExemption>0?"fa fa-id-card-o color-gray":b.guestcardCanceled()?"fa fa-id-card-o color-danger":b.guestcardActivated()&&"complete"==b.mainPersonDirectPurchaseStatus()?"fa fa-id-card-o color-ok":b.guestcardActivated()&&"error"==b.mainPersonDirectPurchaseStatus()?"fa fa-id-card-o color-danger":b.guestCardMailStatus()?"fa fa-id-card-o color-warning":b.guestcardDefinitionAvailable()?"fa fa-id-card-o color-danger":"fa fa-id-card-o color-gray"}).extend({throttle:10}),b.sendQuickcheckinPossible=ko.computed(function(){var a=!0;if((1==b.manualQuickCheckinStatus()||b.autoQuickCheckinStatus()>0)&&(a=!1),b.jsonData.personList){b.jsonData.personList[0].email||(a=!1)}return b.status()!=REGISTRATION_FORM_STATES_ENUM.REGISTERED_NOT_VERIFIED&&b.status()!=REGISTRATION_FORM_STATES_ENUM.COMPLETED&&b.status()!=REGISTRATION_FORM_STATES_ENUM.CHECKED_IN&&b.status()!=REGISTRATION_FORM_STATES_ENUM.CHECKED_OUT&&b.status()!=REGISTRATION_FORM_STATES_ENUM.DISCARDED||(a=!1),a}).extend({throttle:10}),b.getQuickcheckinCss=ko.computed(function(){var a=null;if((1==b.manualQuickCheckinStatus()||b.autoQuickCheckinStatus()>0)&&(a="fa fa-envelope color-warning"),b.jsonData.personList){b.jsonData.personList[0].email||(a="fa fa-envelope color-danger")}return b.status()!=REGISTRATION_FORM_STATES_ENUM.COMPLETED&&b.status()!=REGISTRATION_FORM_STATES_ENUM.CHECKED_IN&&b.status()!=REGISTRATION_FORM_STATES_ENUM.CHECKED_OUT&&b.status()!=REGISTRATION_FORM_STATES_ENUM.DISCARDED||(a=1==b.quickStatus()?"fa fa-envelope-open color-ok":"fa fa-envelope color-gray"),null==a&&(a="fa fa-envelope color-danger"),a}).extend({throttle:10}),b.getQuickcheckinText=ko.computed(function(){var a=null;if(b.jsonData.personList){b.jsonData.personList[0].email?null===a&&(a=i18n.t("registration.overview.clickToSend")):null===a&&(a=i18n.t("registration.overview.noEmailAddress"))}return b.status()==REGISTRATION_FORM_STATES_ENUM.COMPLETED||b.status()==REGISTRATION_FORM_STATES_ENUM.CHECKED_IN||b.status()==REGISTRATION_FORM_STATES_ENUM.CHECKED_OUT||b.status()==REGISTRATION_FORM_STATES_ENUM.DISCARDED?0==b.quickStatus()?i18n.t("registration.overview.dataComplete"):i18n.t("registration.overview.quickcheckinDone")+" "+b.quickStatusSubmitTime():b.quickCheckinMailSendDate()?i18n.t("registration.overview.quickcheckinSend")+" "+b.quickCheckinMailSendDate():b.status()==REGISTRATION_FORM_STATES_ENUM.REGISTERED_NOT_VERIFIED?i18n.t("registration.overview.notVerified"):(null===a&&(a=i18n.t("registration.overview.notAvailable")),a)}).extend({throttle:10}),b.update=function(a){if(b.jsonData=a,b.resellerPartnerId(a.resellerPartnerId),b.id(a.formId),b.createdAt(a.createdAt),b.hash(a.hash),b.formIdProvider(a.formIdProvider),null!=a.fromDate&&b.fromDate(a.fromDate),null!=a.toDate&&b.toDate(a.toDate),b.mainPersonName(a.mainPersonName),a.guestStatus){var c=a.guestStatus.split(";"),d=i18n.t("registration.details.states."+c[0]);b.travelStatus(c[0]),c.length>1&&(d+=c[1]),b.guestStatus(d)}b.status(a.status),b.taxRateTotal(a.taxRateTotal),b.accommodationTaxTotal(a.accommodationTaxRate),b.exportDate(a.exportDate),b.webshopBooking(a.webshopBooking),b.importId(a.importId),b.genericQuickCheckin(a.genericQuickCheckin),b.duplicateRefId(a.duplicateRefId),b.duplicateRefHash(a.duplicateRefHash),b.serviceProviderExternalId(a.serviceProvider),b.quickStatus(a.quickStatus),b.guestcardActivated(a.guestcardActivated),b.guestcardCanceled(a.guestcardCanceled),b.analogGuestcardActivated(a.analogGuestcardActivated),b.manualQuickCheckinStatus(a.manualQuickCheckinStatus),b.autoQuickCheckinStatus(a.autoQuickCheckinStatus),b.guestcardDefinitionAvailable(a.guestcardDefinitionAvailable),b.guestCardMailStatus(a.guestCardMailStatus),b.loadHistoryAndExtractDates(),b.mainPersonDirectPurchaseStatus(a.personList[0].directPurchaseStatus),b.guestcardCanceled(a.personList[0].guestcardCanceled),a.quickStatusSubmitTime&&b.quickStatusSubmitTime(moment(a.quickStatusSubmitTime).format("L"))},b.loadHistoryAndExtractDates=function(){(1==b.manualQuickCheckinStatus()||b.autoQuickCheckinStatus()>0||b.guestCardMailStatus()>0)&&RegistrationLogger.getInstance().readLogs(b.id()).pipe(function(a,c,d){a.forEach(function(a){a.logEventType!=REGISTRATION_ACTIVITY.QUICK_CHECKIN_SEND&&a.logEventType!=REGISTRATION_ACTIVITY.SYSTEM_QUICK_CHECKIN_SEND||null==b.quickCheckinMailSendDate()&&b.quickCheckinMailSendDate(moment(a.createdAt.millis).format("L")),a.logEventType!=REGISTRATION_ACTIVITY.DIGITAL_GUESTCARD_SEND&&a.logEventType!=REGISTRATION_ACTIVITY.SYSTEM_DIGITAL_GUESTCARD_SEND||null==b.guestcardMailSendDate()&&b.guestcardMailSendDate(moment(a.createdAt.millis).format("L"))})})},null!==b.jsonData&&b.update(a),b.toJson=function(){var a={};return a.webshopBooking=b.webshopBooking(),a.genericQuickCheckin=b.genericQuickCheckin(),a.quickStatus=b.quickStatus(),a.hash=b.hash(),a.formId=b.id(),a.status=b.status(),a.duplicateRefId=b.duplicateRefId(),a.importId=b.importId(),a.guestcardDefinitionAvailable=b.guestcardDefinitionAvailable(),a.analogGuestcardActivated=b.analogGuestcardActivated(),a.personList=[],a.guestcardActivated=b.guestcardActivated(),a}}function addIfChanged(a,b,c,d){b!=c&&(d[a]={from:c,to:b})}function addPropertiesIfChanged(a,b,c){for(var d={},e=0;e<c.length;e++){var f=c[e];addIfChanged(f,null!=a?a[f]:null,null!=b?b[f]:null,d)}return d}function RegistrationDetailedModel(a){function b(a,b,c){["groupName","reasonForExemption"].forEach(function(d){addIfChanged(d,null!=a?a[d]:null,null!=b?b[d]:null,c)})}function c(a,b,c,d){if(null!=a)for(var e=0;e<a.length;e++){var f=a[e].id;b.push(f);var g=null!=c?m(c,f):null,h=n(a[e],g);Object.keys(h).length>0&&(d.hasOwnProperty("personGroupList")||(d.personGroupList=[]),d.personGroupList[e]=h)}}function d(a,b,c){for(var d=0;d<a.length;d++){var e=a[d].id;if(!b.includes(e)){b.push(e);var f=n(null,a[d]);Object.keys(f).length>0&&(c.hasOwnProperty("personGroupList")||(c.personGroupList=[]),c.personGroupList[d+b.length]=f)}}}var e=this,a=a;e.clone=ko.observable(!1),e.formId=ko.observable(),e.formIdProvider=ko.observable(),e.comment=ko.observable(),e.webshopBooking=ko.observable(!1),e.genericQuickCheckin=ko.observable(!1),e.duplicateRefId=ko.observable(!1),e.duplicateRefHash=ko.observable(),e.importId=ko.observable(),e.ticketHolderList=ko.observableArray([]),e.groupData=ko.observable(),e.selectedServiceProvider=ko.observable(),e.activeAssignedServiceProviderList=ko.computed(function(){return headerVM.assignedServiceProviderList().filter(function(a){return a.active||a.serviceProviderExternalId===e.selectedServiceProvider()})}),e.taxRateTotal=ko.observable(),e.accommodationTaxTotal=ko.observable(),e.roomingListFile=ko.observableArray(),e.status=ko.observable(),e.quickStatus=ko.observable(),e.quickStatusSubmitTime=ko.observable(),e.hash=ko.observable(),e.exportDate=ko.observable(),e.historyLogs=ko.observableArray(),e.verified=ko.observable(!1),e.completed=ko.observable(),e.registrationDiscarded=ko.observable(!1),e.registrationEmailed=ko.observable(!1),e.guestcardDefinitionAvailable=ko.observable(!1),e.resetDateRestrictions=ko.observable(!1),e.autoQuickCheckinStatus=ko.observable(),
e.manualQuickCheckinStatus=ko.observable(!1),e.guestCardMailStatus=ko.observable(!1),e.resellerPartnerId=ko.observable(),e.guestcardActivated=ko.observable(),e.analogGuestcardActivated=ko.observable(),e.newsletter=ko.observable(!1),e.saved=ko.observable(!1),e.resellerNumber=function(){return registrationVM&&registrationVM.registrationConfig.showServiceproviderSpecificFormId()?e.formIdProvider():e.resellerPartnerId()&&e.formId()?e.resellerPartnerId()+" - "+e.formId():e.formId()?e.formId():null},e.headerTitle=ko.computed(function(){return null!=e.resellerNumber()?e.registrationDiscarded()?i18n.t("registration.details.registrationNumberTitle")+" "+e.resellerNumber()+" - "+i18n.t("registration.details.states.discarded"):i18n.t("registration.details.registrationNumberTitle")+" "+e.resellerNumber():i18n.t("registration.details.registrationNumberTitleNew")}),e.duplicateLinkVisible=ko.computed(function(){return e.duplicateRefId()&&e.status()==REGISTRATION_FORM_STATES_ENUM.REGISTERED_NOT_VERIFIED}),e.duplicateLinkLocation=ko.pureComputed(function(){return"#registration_detail/"+e.duplicateRefHash()}),e.duplicateLinkName=ko.pureComputed(function(){return e.resellerPartnerId()&&!registrationVM.registrationConfig.showServiceproviderSpecificFormId()?e.resellerPartnerId()+" - "+e.duplicateRefId():e.duplicateRefId()}),e.editLimitExceeded=ko.computed(function(){for(var a=getMomentJsDateFormat(),b=moment(moment().format("YYYY-MM-DD"),"YYYY-MM-DD"),c=null,d=0;d<e.ticketHolderList().length;d++){var f=e.ticketHolderList()[d],g=moment(f.vacationToDate(),a);null==c?c=g:g.isAfter(c)&&(c=g)}if(null!=c){var h=b.diff(c,"days");if(headerVM.registrationPartnerConfig()&&h>headerVM.registrationPartnerConfig().editableAfterDepartureInDays())return!(registrationVM.registrationConfig&&!registrationVM.registrationConfig.disableIncompleteForms()&&(e.status()==REGISTRATION_FORM_STATES_ENUM.REGISTERED_VERIFIED||e.status()==REGISTRATION_FORM_STATES_ENUM.REGISTERED_NOT_VERIFIED))&&(console.log("editLimitExceeded of "+headerVM.registrationPartnerConfig().editableAfterDepartureInDays()+" days"),!0)}return!1}),e.groupContainsExemptions=ko.computed(function(){return e.groupData(),!1}),e.getMainPersonLanguage=function(){for(var a=0;a<e.ticketHolderList().length;a++){var b=e.ticketHolderList()[a];if(1==b.mainPerson()&&b.language())return b.language().substr(0,2)}return null},e.sendDigitalGuestcardMailAllowed=ko.computed(function(){if(e.status()!=REGISTRATION_FORM_STATES_ENUM.COMPLETED&&e.status()!=REGISTRATION_FORM_STATES_ENUM.CHECKED_IN)return!1;if(!e.guestcardDefinitionAvailable())return!1;if(e.analogGuestcardActivated())return!1;if(e.guestcardActivated())return!1;if(5==e.autoQuickCheckinStatus())return!1;var a=e.ticketHolderList()[0];if(a&&!a.email())return!1;var b=getMomentJsDateFormat();if(a){var c=moment(moment().format("YYYY-MM-DD"),"YYYY-MM-DD"),d=moment(moment(a.vacationToDate(),b).format("YYYY-MM-DD"),"YYYY-MM-DD");if(c.isAfter(d))return!1}if(null!=e.groupData()&&1==e.ticketHolderList().length)return!1;var f=!0;return e.ticketHolderList().forEach(function(a){null!=a.residenceTaxExemption()&&0!=a.residenceTaxExemption()||(f=!1)}),!f}),e.printAnalogGuestCardAllowed=ko.computed(function(){if(!e.guestcardDefinitionAvailable())return!1;var a=!0;return e.ticketHolderList().forEach(function(b){null!=b.residenceTaxExemption()&&0!=b.residenceTaxExemption()||(a=!1)}),!a&&((e.status()==REGISTRATION_FORM_STATES_ENUM.COMPLETED||e.status()==REGISTRATION_FORM_STATES_ENUM.CHECKED_IN)&&5!=e.autoQuickCheckinStatus())}),e.eMailCheckinAllowed=ko.computed(function(){if(e.status()!=REGISTRATION_FORM_STATES_ENUM.REGISTERED_VERIFIED&&e.status()!=REGISTRATION_FORM_STATES_ENUM.NEW)return!1;if(e.autoQuickCheckinStatus()>=4)return!1;var a=e.ticketHolderList()[0];return!(a&&!a.email())&&(null==e.groupData()||1!=e.ticketHolderList().length)}),e.cloneAllowed=ko.computed(function(){return!!e.formId()}),e.discardAllowed=ko.computed(function(){return e.status()!==REGISTRATION_FORM_STATES_ENUM.DISCARDED&&e.status()!==REGISTRATION_FORM_STATES_ENUM.CHECKED_IN&&!(!menuVM.hasRegistrationDiscardRights()&&e.status()===REGISTRATION_FORM_STATES_ENUM.CHECKED_OUT)}),e.checkForDurationChange=ko.computed(function(){var b=!1,c=getMomentJsDateFormat();return e.ticketHolderList().forEach(function(d){a.personList.forEach(function(a){if(d.id()==a.id){var e=moment(a.vacationToDate),f=moment(d.vacationToDate(),c);(f.isBefore(e)||f.isAfter(e))&&(b=!0);var g=moment(a.vacationFromDate),h=moment(d.vacationFromDate(),c);(h.isAfter(g)||h.isBefore(g))&&(b=!0)}})}),b}),e.getGuestState=function(){for(var a=0,b=0,c=0,d=!1,f=!1,g=0;g<e.ticketHolderList().length;g++){var h=e.ticketHolderList()[g];1==h.checkedIn()&&(1==h.mainPerson()&&(d=!0),b++),1==h.checkedOut()&&(1==h.mainPerson()&&(f=!0),c++),a++}var h=e.groupData();if(null!=h){var i=0;h.personGroupList().forEach(function(a){i+=Number(a.nrOfPersons())}),d&&(b+=i),f&&(c+=i),a+=i}return e.registrationDiscarded()?TRAVEL_STATES_ENUM.NOT_ARRIVED+"; ("+a+"/"+a+")":c>0?TRAVEL_STATES_ENUM.DEPARTED+"; ("+c+"/"+a+")":b>0?TRAVEL_STATES_ENUM.ARRIVED+"; ("+b+"/"+a+")":TRAVEL_STATES_ENUM.AWAITED+"; ("+a+"/"+a+")"},e.addElement=function(a){var b=null;e.ticketHolderList().forEach(function(a){!0===a.mainPerson()&&(b=a)}),a===GROUP_PERSON_ENUM.PERSON?e.ticketHolderList.push(new f(b)):a===GROUP_PERSON_ENUM.GROUP&&e.groupData(h(b))},e.clearPersonData=function(a){if(a>=0&&e.ticketHolderList().length>a){var b=e.ticketHolderList()[a],c=r();i(c,b)}},e.setDataFromSwisspass=function(a,b){if(b>=0&&e.ticketHolderList().length>b){var c=e.ticketHolderList()[b];if(c.id(a.id),c.gender(a.gender),c.firstName(a.firstName),c.secondName(a.secondName),c.lastName(a.lastName),null!=a.birthDateString){var d=$.datepicker.parseDate(DATE_SERVER_FORMAT,a.birthDateString);c.birthdateMonth(d.getMonth()+1),c.birthdateDay(d.getDate()),c.birthdateYear(d.getFullYear())}c.email(a.email?a.email:c.email()),c.phone(a.phone?a.phone:c.phone()),c.street(a.street),c.streetNumber(a.streetNumber),c.zipCode(a.zipCode),c.city(a.city),c.country(a.country),c.language(a.language?a.language:c.language()),c.nationality(a.nationality?a.nationality:c.nationality()),c.idType(a.idType?a.idType:c.idType()),c.idNumber(a.idNumber?a.idNumber:c.idNumber()),c.residenceTaxExemption(a.residenceTaxExemption),c.media(MEDIA_SWISSPASS),c.containsSwisspassData(!0)}};var f=function(a){var b=new ticketholderModel;if(b.mainPerson=ko.observable(!1),b.vacationFromDate=ko.observable(),b.vacationToDate=ko.observable(),b.checkedIn=ko.observable(!1),b.checkedOut=ko.observable(!1),b.mediaCardId=ko.observable(),b.mediaCardOrigId=ko.observable(),b.media=ko.observable(),b.zipCode=ko.observable(),b.swissPassZipCode=ko.observable(),b.swissPassId=ko.observable(),b.status=ko.observable(TRAVEL_STATES_ENUM.AWAITED),b.enabled=ko.observable(!0),b.guestStatus=null,b.kanton=ko.observable(),b.vacationFromDate.subscribe(function(a){b.checkedIn(!1),b.status(TRAVEL_STATES_ENUM.AWAITED)}),b.vacationToDate.subscribe(function(a){b.checkedOut(!1),1==b.checkedIn()?b.status(TRAVEL_STATES_ENUM.ARRIVED):b.status(TRAVEL_STATES_ENUM.AWAITED)}),b.taxRate=ko.observable(),a&&(b.vacationFromDate(a.vacationFromDate()),b.vacationToDate(a.vacationToDate())),b.maxDate=ko.computed(function(){return e.guestcardActivated()?b.vacationToDate():null}),b.directPurchaseStatus=ko.observable(),b.guestcardCanceled=ko.observable(!1),b.guestCardActive=ko.computed(function(){return"complete"==b.directPurchaseStatus()||"error"==b.directPurchaseStatus()}),registrationVM&&registrationVM.registrationConfig.preselectedCountry()){var c=registrationVM.registrationConfig.preselectedCountry();b.language(g(c)),b.nationality(c),b.country(c),a&&(null!=a.language()&&b.language(a.language()),null!=a.nationality()&&b.nationality(a.nationality()),null!=a.country()&&b.country(a.country()))}return registrationVM&&registrationVM.registrationConfig.defaultIdType()&&b.idType(registrationVM.registrationConfig.defaultIdType()),registrationVM&&registrationVM.registrationConfig.useMaintravellerSurname()&&a&&b.lastName(a.lastName()),b},g=function(a){if(a){var b=a.toLowerCase();if("de"===b)return"de_CH";if("fr"===b)return"fr_CH";if("it"===b)return"it_CH"}return"en_GB"},h=function(a){var b={};return b.vacationFromDate=ko.observable(),b.vacationToDate=ko.observable(),b.groupId=void 0,b.groupName=ko.observable(null),b.personGroupList=ko.observableArray(),b.reasonForExemption=ko.observable(null),b.taxRate=ko.observable(),b.accommodationTaxRate=ko.observable(),b.isGroupTravelChecked=ko.observable(!1),a&&(b.vacationFromDate(a.vacationFromDate()),b.vacationToDate(a.vacationToDate())),b};e.createPersonGroupDataObservable=function(){moment();return{id:ko.observable(),fromDate:ko.observable(),toDate:ko.observable(),personGroupId:ko.observable(),nrOfPersons:ko.observable(0),personGroupName:ko.observable(),taxRateCode:ko.observable(),showMinusBtn:ko.observable(!1)}};var i=function(a,b){return b.setData(a),b.swissPassId(a.swissPassId),b.swissPassZipCode(a.swissPassZipCode),a.swissPassId&&a.swissPassZipCode?(b.media(MEDIA_SWISSPASS),b.containsSwisspassData(!0)):(b.media(null),b.containsSwisspassData(!1)),a.vacationFromDate&&b.vacationFromDate(moment(a.vacationFromDate).format("L")),a.vacationToDate&&b.vacationToDate(moment(a.vacationToDate).format("L")),b.checkedIn(a.checkedIn),b.checkedOut(a.checkedOut),b.status(a.status),b.personId=a.personId,b.mainPerson(a.mainPerson),b.kanton(a.kanton),b.directPurchaseStatus(a.directPurchaseStatus),b.guestcardCanceled(a.guestcardCanceled),b},j=function(){var b=a;if(e.formId(b.formId),e.formIdProvider(b.formIdProvider),e.webshopBooking(b.webshopBooking),e.genericQuickCheckin(b.genericQuickCheckin),e.duplicateRefId(b.duplicateRefId),e.duplicateRefHash(b.duplicateRefHash),e.importId(b.importId),e.resellerPartnerId(b.resellerPartnerId),e.comment(b.comment),e.registrationDiscarded(b.status===REGISTRATION_FORM_STATES_ENUM.DISCARDED),e.registrationEmailed(b.status===REGISTRATION_FORM_STATES_ENUM.COMPLETED),e.verified(b.status!=REGISTRATION_FORM_STATES_ENUM.REGISTERED_NOT_VERIFIED),e.quickStatusSubmitTime(b.quickStatusSubmitTime),e.quickStatus(b.quickStatus),e.exportDate(b.exportDate),e.hash(b.hash),e.guestcardDefinitionAvailable(b.guestcardDefinitionAvailable),e.autoQuickCheckinStatus(b.autoQuickCheckinStatus),e.manualQuickCheckinStatus(b.manualQuickCheckinStatus),e.guestCardMailStatus(b.guestCardMailStatus),e.clone(!!b.clone&&b.clone),e.ticketHolderList([]),b.personList)for(var c=0;c<b.personList.length;c++){var d=b.personList[c],g=new f;i(d,g),e.ticketHolderList.push(g)}if(b.groupData){var j=b.groupData,k=h();k.groupId=j.groupId,k.groupName(j.groupName),k.personGroupList(),j.personGroupList.forEach(function(a){var b=e.createPersonGroupDataObservable();b.id(a.id),a.fromDate&&(b.fromDate(moment(a.fromDate).format("L")),k.isGroupTravelChecked(!0)),a.toDate&&(b.toDate(moment(a.toDate).format("L")),k.isGroupTravelChecked(!0)),b.personGroupName(a.personGroupName),b.personGroupId(a.personGroupId),b.nrOfPersons(a.nrOfPersons),b.taxRateCode(a.taxRateCode),k.personGroupList.push(b)}),k.personGroupList.sort(function(a,b){return a.personGroupId()<b.personGroupId()?-1:a.personGroupId()>b.personGroupId()?1:0}),k.reasonForExemption(j.reasonForExemption),e.groupData(k)}b.serviceProvider?e.selectedServiceProvider(b.serviceProvider):e.activeAssignedServiceProviderList().length>0&&e.selectedServiceProvider(e.activeAssignedServiceProviderList()[0].serviceProviderExternalId),e.roomingListFile([]),b.roomingListFile&&(b.roomingListFile.isUploaded=ko.observable(!0),e.roomingListFile.push(b.roomingListFile)),e.status(a.status),e.guestcardActivated(a.guestcardActivated),e.analogGuestcardActivated(a.analogGuestcardActivated),e.newsletter(a.newsletter),e.completed(b.status==REGISTRATION_FORM_STATES_ENUM.COMPLETED||b.status==REGISTRATION_FORM_STATES_ENUM.CHECKED_IN||b.status==REGISTRATION_FORM_STATES_ENUM.CHECKED_OUT)};e.setDefaultArrivalAndDepartureDate=function(){var a=moment();e.ticketHolderList().forEach(function(a){var b=moment();a.vacationFromDate()||a.vacationFromDate(b.format("L")),a.vacationToDate()||a.vacationToDate(b.add(1,"days").format("L"))}),e.groupData()&&e.groupData().personGroupList().forEach(function(b){b.fromDate(a.format("L")),b.toDate(a.add(1,"days").format("L"))})},e.removePerson=function(a){var b=e.ticketHolderList.indexOf(a);b>=0&&e.ticketHolderList.splice(b,1)},e.removeGroup=function(){e.groupData(null)},e.setEmailCheckedIn=function(){e.registrationEmailed(!0)},e.setDiscarded=function(){e.registrationDiscarded(!0),e.ticketHolderList().forEach(function(a){a.status(TRAVEL_STATES_ENUM.NOT_ARRIVED)})};var k=function(a,b,c){["comment","serviceProvider","roomingListFile","webshopBooking","status","clone"].forEach(function(d){var e=a[d],f=b[d];"serviceProvider"==d?e!=f&&null!=f&&(c[d]={from:f,to:e}):e!=f&&(c[d]={from:f,to:e})});var d={};if(b.personList.length>a.personList.length)for(var e=0;e<b.personList.length;e++){var f=a.personList[e],g=b.personList[e];null==f&&null!=g&&(d[e]={from:g,to:null})}for(var e=0;e<a.personList.length;e++){var f=a.personList[e],g=b.personList[e];o(f,g,e,d)}Object.keys(d).length>0&&(c.personList=d);var h=a.groupData,i=b.groupData;if(null!=h||null!=i)if(null!=h&&null==i)c.groupData={from:null,to:h};else if(null==h&&null!=i)c.groupData={from:i,to:null};else{var j=l(h,i);Object.keys(j).length>0&&(c.groupData=j)}},l=function(a,e){var f={};b(a,e,f);var g=[];return c(a.personGroupList,g,e.personGroupList,f),d(e.personGroupList,g,f),f},m=function(a,b){return a.find(function(a){return a.id==b})},n=function(a,b){return addPropertiesIfChanged(a,b,["nrOfPersons","taxRateCode","personGroupId","fromDate","toDate"])},o=function(a,b,c,d){for(var e in a)if("mainPerson"!=e&&"taxRate"!=e&&"encodedPhoto"!=e&&"eWallet"!=e&&"accommodationTaxRate"!=e&&"additionalData"!=e&&"additionalPersonalizations"!=e){var f=null!=b&&null!=b[e]&&void 0!=b[e]?b[e]:null,g=null!=a[e]&&void 0!=a[e]?a[e]:null;null!=g&&g!=f&&(d.hasOwnProperty(c)||(d[c]={}),d[c][e]={from:f,to:g})}};e.isPersonEmpty=function(a){var b=p(a);return void 0==b.swissPassId&&void 0==b.swissPassZipCode&&void 0==b.gender&&void 0==b.firstName&&void 0==b.secondName&&void 0==b.lastName&&void 0==b.birthDateString&&void 0==b.email&&void 0==b.nationality&&void 0==b.idType&&void 0==b.idNumber&&b.status==TRAVEL_STATES_ENUM.AWAITED},e.isGroupEmpty=function(a){var b=q(a);if(console.log("isGroupEmpty",a),void 0==b.groupName&&void 0==b.reasonForExemption){for(var c=0;c<b.personGroupList.length;c++)if(0!=b.personGroupList[c].nrOfPersons)return!1;return!0}return!1},e.dataChanged=function(){var a=e.checkForChangedData(),b=Object.keys(a).length>0;return b&&console.log("Data has changed",a),b},e.checkForChangedData=function(){var b={},c=e.toJson();return k(c,a,b),b},e.calculateState=function(){if(e.status()==REGISTRATION_FORM_STATES_ENUM.DISCARDED||e.registrationDiscarded())return REGISTRATION_FORM_STATES_ENUM.DISCARDED;var a=e.status();if(e.status()==REGISTRATION_FORM_STATES_ENUM.NEW&&(a=e.clone()?REGISTRATION_FORM_STATES_ENUM.REGISTERED_NOT_VERIFIED:REGISTRATION_FORM_STATES_ENUM.REGISTERED_VERIFIED),e.status()!=REGISTRATION_FORM_STATES_ENUM.REGISTERED_NOT_VERIFIED&&e.status()!=REGISTRATION_FORM_STATES_ENUM.NEW||!e.verified()||(a=REGISTRATION_FORM_STATES_ENUM.REGISTERED_VERIFIED),e.completed()&&(a=REGISTRATION_FORM_STATES_ENUM.COMPLETED),registrationVM.registrationConfig.showCheckinCheckout())for(var b=0;b<e.ticketHolderList().length;b++){var c=e.ticketHolderList()[b];1==c.mainPerson()&&(1==c.checkedIn()&&0==c.checkedOut()&&(a=REGISTRATION_FORM_STATES_ENUM.CHECKED_IN),1==c.checkedOut()&&(a=REGISTRATION_FORM_STATES_ENUM.CHECKED_OUT))}return a},e.toJson=function(){var a={};a.webshopBooking=e.webshopBooking(),a.genericQuickCheckin=e.genericQuickCheckin(),a.quickStatus=e.quickStatus(),a.quickStatusSubmitTime=e.quickStatusSubmitTime(),a.hash=e.hash(),a.verified=e.verified(),a.clone=e.clone(),a.comment=e.comment(),a.formId=e.formId(),a.taxRateTotal=e.taxRateTotal(),a.accommodationTaxRate=e.accommodationTaxTotal(),a.serviceProvider=e.selectedServiceProvider(),a.roomingListFile=null,e.roomingListFile()[0]&&(a.roomingListFile={id:e.roomingListFile()[0].id}),a.status=e.calculateState(),a.duplicateRefId=e.duplicateRefId(),a.importId=e.importId(),a.guestcardDefinitionAvailable=e.guestcardDefinitionAvailable(),a.newsletter=e.newsletter(),a.analogGuestcardActivated=e.analogGuestcardActivated(),a.personList=[],a.groupData=null;for(var b=0;b<e.ticketHolderList().length;b++){var c=e.ticketHolderList()[b],d=p(c);d.mainPerson&&(d.firstName&&d.lastName?a.mainPersonName=d.firstName+" "+d.lastName:d.firstName?a.mainPersonName=d.firstName:d.lastName&&(a.mainPersonName=d.lastName)),a.personList.push(d)}return a.guestStatus=e.getGuestState(),e.groupData()&&(a.groupData=q(e.groupData())),a.guestcardActivated=e.guestcardActivated(),a};var p=function(a){var b=getMomentJsDateFormat(),c={};return c.id=a.id(),c.vacationFromDate=a.vacationFromDate()?moment(a.vacationFromDate(),b).format("YYYY-MM-DD"):a.vacationFromDate(),c.vacationToDate=a.vacationToDate()?moment(a.vacationToDate(),b).format("YYYY-MM-DD"):a.vacationToDate(),c.swissPassId=a.swissPassId(),c.swissPassZipCode=a.swissPassZipCode(),c.gender=a.gender(),c.firstName=a.firstName(),c.secondName=a.secondName(),c.lastName=a.lastName(),c.streetNameAndNr=a.streetNameAndNr(),c.zipCode=a.zipCode(),c.city=a.city(),c.country=a.country(),c.birthDateString=a.birthDate(),c.taxRate=a.taxRate(),c.taxRateCode=a.taxRateCode(),c.phone=a.phone(),c.email=a.email(),c.nationality=a.nationality(),c.language=a.language(),c.idType=a.idType(),c.idNumber=a.idNumber(),c.residenceTaxExemption=a.residenceTaxExemption(),c.accommodationTaxExemption=a.accommodationTaxExemption(),c.status=a.status(),c.personId=a.personId,c.taxPersonGroupId=a.taxPersonGroupId(),c.taxRateCode=a.taxRateCode(),c.accommodationTaxRate=a.accommodationTaxRate(),c.mainPerson=a.mainPerson(),c.arrivalBy=a.arrivalBy(),"CH"==a.country()&&(c.kanton=a.kanton()),c},q=function(a){var b=getMomentJsDateFormat(),c={};return c.groupId=a.groupId,c.groupName=a.groupName(),c.personGroupList=[],a.personGroupList().forEach(function(d){var e={};e.id=d.id(),a.isGroupTravelChecked()&&(e.fromDate=moment(d.fromDate(),b).format(MOMENTJS_DATE_SERVER_FORMAT),e.toDate=moment(d.toDate(),b).format(MOMENTJS_DATE_SERVER_FORMAT)),e.personGroupId=d.personGroupId(),e.personGroupName=d.personGroupName(),e.nrOfPersons=d.nrOfPersons(),e.taxRateCode=d.taxRateCode(),c.personGroupList.push(e)}),c.reasonForExemption=a.reasonForExemption(),c.taxRate=a.taxRate(),c.accommodationTaxRate=a.accommodationTaxRate(),c},r=function(){var a={},b=null;return registrationVM&&registrationVM.registrationConfig.preselectedCountry()&&(b=registrationVM.registrationConfig.preselectedCountry()),a.id=null,a.mainPerson=null,a.swissPassId=null,a.swissPassZipCode=null,a.vacationFromDate=null,a.vacationToDate=null,a.gender=null,a.firstName=null,a.secondName=null,a.lastName=null,a.streetNameAndNr=null,a.zipCode=null,a.city=null,a.country=b,a.birthDateString=null,a.taxRate=0,a.accommmodationTaxRate=0,a.taxRateCode=null,a.phone=null,a.email=null,a.nationality=b,a.language=null!==b?b.toLowerCase()+"_CH":null,a.idType=null,registrationVM&&registrationVM.registrationConfig.defaultIdType()&&(a.idType=registrationVM.registrationConfig.defaultIdType()),a.idNumber=null,a.residenceTaxExemption=null,a.accommodationTaxExemption=null,a.taxPersonGroupId=null,a.arrivalBy=null,a.status=TRAVEL_STATES_ENUM.AWAITED,a.personId=null,a};a||(a={formId:null,number:null,verified:!0,webshopBooking:!1,genericQuickCheckin:!1,comment:null,resellerPartnerId:null,resellerUserId:null,taxRateTotal:0,accommodationTaxRate:0,mainPersonName:null,serviceProvider:null,fromDate:null,toDate:null,status:REGISTRATION_FORM_STATES_ENUM.NEW,personList:[r()],groupdata:null,roomingListFile:void 0,arrivalBy:null,importId:null,duplicateRefId:null},a.personList[0].mainPerson=!0),e.setData=function(b){a=b,j()},e.setData(a)}function sectionModel(a){var b=this;this.stationFrom=ko.observable(a.stationFrom),this.stationFromName=ko.observable(a.stationFromName),this.stationTo=ko.observable(a.stationTo),this.stationToName=ko.observable(a.stationToName),this.sectionName=ko.computed(function(){return b.stationFromName()+" - "+b.stationToName()}),this.hasFirstClass=ko.observable(a.hasFirstClass),this.date=ko.observable(a.date),this.selectedTrain=ko.observable(null),this.trains=ko.observableArray([]),this.trainsFetched=ko.observable(!1),this.timeTableEnabled=ko.observable(!1),this.firstClassEnabled=ko.observable(!1),this.sectionDisplayHeight=ko.observable(null),this.sectionOffset=ko.observable(0),this.hasOvernightStay=ko.observable(!1),this.fetchTrains=function(a){b.timeTableEnabled(!1),b.trains([]),void 0===a&&(a=2),b.firstClassEnabled()&&b.hasFirstClass()&&(a=1),groupReservationApi.searchTrainsForSection(function(a){b.trains(a)},b.stationFrom,b.stationTo,b.date,a)},this.fetchTrainsDeferred=function(a){return $.Deferred(function(c){b.timeTableEnabled(!1),b.trains([]),void 0===a&&(a=2),b.firstClassEnabled()&&b.hasFirstClass()&&(a=1),groupReservationApi.searchTrainsForSection(function(a){b.trains(a),c.resolve(a)},b.stationFrom,b.stationTo,b.date,a)}).promise()},this.switchClass=function(){b.fetchTrains(b.firstClassEnabled()?1:2)},this.selectNextPossibleTrain=function(a){b.trains().forEach(function(c){b.selectedTrain()&&b.selectedTrain().departsAfter(a)||gr.trains.hasTrainEnoughSeats(c)&&c.departsAfter(a)&&b.selectedTrain(c)})},this.displayDate=ko.computed(function(){if(b.date())return moment(b.date(),DATETIME_SERVER_FORMAT).format(DATETIME_DISPLAY_FORMAT)}),this.isLoading=ko.computed(function(){return 0===kp.get(b,"trains",[]).length})}function trainModel(a){var b=this;if(this.id=ko.observable(a.id),this.journeyId=ko.observable(a.journeyId),this.trainNumber=ko.observable(a.trainNumber),this.externalId=ko.observable(a.externalId),this.date=ko.observable(a.date),this.stationFromName=ko.observable(a.stationFromName),this.stationToName=ko.observable(a.stationToName),this.stationFrom=ko.observable(a.stationFrom),this.stationTo=ko.observable(a.stationTo),this.wagonClass=ko.observable(a.wagonClass),this.departureTime=ko.observable(a.departureTime),this.arrivalTime=ko.observable(a.arrivalTime),this.isValidSelection=ko.observable(!1),this.departsBefore=function(a){var c=moment(a.departureTime(),DATETIME_SERVER_FORMAT);return moment(b.arrivalTime(),DATETIME_SERVER_FORMAT).isAfter(c)},this.departsAfter=function(a){var c=moment(a.arrivalTime(),DATETIME_SERVER_FORMAT),d=(moment(a.departureTime(),DATETIME_SERVER_FORMAT),moment(b.departureTime(),DATETIME_SERVER_FORMAT)),e=moment(b.arrivalTime(),DATETIME_SERVER_FORMAT);return d.isAfter(c)&&e.isAfter(c)},this.departsAfterDate=function(a){return moment(b.departureTime(),DATETIME_SERVER_FORMAT).isSameOrAfter(a)},this.availabilityPercent=function(){return b.availability()},this.trainTimeLabel=ko.computed(function(){return moment(b.departureTime(),DATETIME_SERVER_FORMAT).format("HH:mm")+" ab / "+moment(b.arrivalTime(),DATETIME_SERVER_FORMAT).format("HH:mm")+" an"}),this.displayArrivalTime=ko.computed(function(){if(b.arrivalTime())return moment(b.arrivalTime(),DATETIME_SERVER_FORMAT).format("HH:mm")}),this.displayDepartureTime=ko.computed(function(){if(b.departureTime())return moment(b.departureTime(),DATETIME_SERVER_FORMAT).format("HH:mm")}),this.displayDepartureDate=ko.computed(function(){if(b.departureTime())return moment(b.departureTime(),DATETIME_SERVER_FORMAT).format(DATETIME_DISPLAY_FORMAT)}),this.displayDate=ko.computed(function(){if(b.date())return moment(b.date(),DATETIME_SERVER_FORMAT).format(DATETIME_DISPLAY_FORMAT)}),this.availability=ko.observable(a.availability),this.freeSeats=ko.observable(a.freeSeats),this.totalSeats=ko.observable(a.totalSeats),this.freeHandicapSeats=ko.observable(a.freeHandicapSeats),this.totalHandicapSeats=ko.observable(a.totalHandicapSeats),this.freeOverbookingSeats=ko.observable(a.freeOverbookingSeats),this.totalOverbookingSeats=ko.observable(a.totalOverbookingSeats),this.freeOverbookingContingent=ko.observable(a.freeOverbookingContingent),this.freeOverbookingReserveSeats=ko.observable(a.freeOverbookingReserveSeats),this.totalOverbookingContingent=ko.observable(a.totalOverbookingContingent),this.totalOverbookingReserveSeats=ko.observable(a.totalOverbookingReserveSeats),this.tooltipLabel=function(){var a=[];return a.push(i18n.t("groupReservation.detail.seatsAvailable")+" <b>"+this.freeSeats()+"/"+this.totalSeats()+"</b>"),a.push(i18n.t("groupReservation.detail.seatsHandicappedAvailable")+" <b>"+this.freeHandicapSeats()+"/"+this.totalHandicapSeats()+"</b>"),a.push(i18n.t("groupReservation.detail.seatsOverbookingAvailable")+"<b> "+this.freeOverbookingContingent()+"/"+this.totalOverbookingContingent()+"</b>"),a.push(i18n.t("groupReservation.detail.seatsOverbookingReserve")+"<b> "+this.freeOverbookingReserveSeats()+"/"+this.totalOverbookingReserveSeats()+"</b>"),a.join("<br>")},this.tooltipNotEnoughSeatsLabel=function(){return'<span class="text-danger">'+i18n.t("groupReservation.detail.seatsNotEnough")+"</span> <br>"+this.tooltipLabel()},this.numberOfSeats=ko.observable(a.numberOfSeats),this.numberOfHandicapSeats=ko.observable(a.numberOfHandicapSeats),this.timeTableEntries=ko.observableArray(),a.timeTableEntries){var c=$.map(a.timeTableEntries,function(a){return new trainTimeTableEntry(a)});this.timeTableEntries(c)}this.toArray=function(){return{id:b.id(),trainNumber:parseInt(b.trainNumber()),date:moment(b.date()).format(MOMENTJS_DATE_SERVER_FORMAT),stationFrom:parseInt(b.stationFrom()),stationTo:parseInt(b.stationTo()),departureTime:b.departureTime(),arrivalTime:b.arrivalTime(),wagonClass:parseInt(b.wagonClass())}},this.departureTimeFloor=function(){return nearest15min=function(a,b){const c=Math.floor(b.clone().minute()/a)*a;return b.clone().minute(c).second(0)}(15,moment(b.departureTime())),nearest15min}}function trainTimeTableEntry(a){var b=this;this.station=ko.observable(a.station),this.stationName=ko.observable(a.stationName),this.arrivalTime=ko.observable(a.arrivalTime),this.departureTime=ko.observable(a.departureTime),this.displayArrivalTime=ko.computed(function(){if(b.arrivalTime())return moment(b.arrivalTime(),DATETIME_SERVER_FORMAT).format("HH:mm")}),this.displayDepartureTime=ko.computed(function(){if(b.departureTime())return moment(b.departureTime(),DATETIME_SERVER_FORMAT).format("HH:mm")})}function groupReservationOrderModel(a){var b=this;ko.utils.extend(b,new orderModel(a)),b.forwardOrderDisplayState=ko.observable(a.forwardOrderDisplayState),b.receiverId=ko.observable(a.receiverId),b.receiverName=ko.observable(a.receiverName),b.forwardStatus=ko.observable(a.forwardStatus),b.exportStatus=ko.observable(a.exportStatus),b.receiverType=ko.observable(a.receiverType),b.forwardAddress=ko.observable(a.forwardAddress),b.forwardType=ko.observable(a.forwardType),b.forwardDate=ko.observable(a.forwardDate),b.exportDate=ko.observable(a.exportDate),b.tourguideCode=ko.observable(a.tourguideCode),b.expertName=ko.observable(),this.pickupCode=ko.observable(a.pickupCode),this.group=ko.observable(),this.bergbahnReservation=ko.observable(),this.restaurantReservation=ko.observable(),a.group&&b.group(new groupModel(a.group)),a.bergbahnReservation&&(b.bergbahnReservation(new bergbahnGroupReservationModel(a.bergbahnReservation)),b.expertName(a.bergbahnReservation.expertName)),a.restaurantReservation&&b.restaurantReservation(new restaurantGroupReservationModel(a.restaurantReservation)),this.isConfirmed=ko.pureComputed(function(){return null!=this.forwardOrderDisplayState()&&(this.forwardOrderDisplayState()==GROUP_RESERVATION_ORDER_DISPLAY_STATE_CONFIRMED||this.forwardOrderDisplayState()==GROUP_RESERVATION_ORDER_DISPLAY_STATE_PICKED_UP)},this),b.displayRestaurantTime=ko.computed(function(){var a=kp.get(b,"restaurantReservation.status",null),c=kp.get(b,"restaurantReservation.restaurantId",!1);if(a!==ORDER_STATUS_RESTAURANT_CANCELED&&c){var d=headerVM.nameToRestaurantIdMap[c]?headerVM.nameToRestaurantIdMap[c]:"-";return moment(kp.get(b,"restaurantReservation.from")).format("HH:mm")+"-"+moment(kp.get(b,"restaurantReservation.until")).format("HH:mm")+"<br>"+d}return"-"}),b.displayRestaurantMenu=ko.computed(function(){var a=kp.get(b,"restaurantReservation.status",null),c=kp.get(b,"restaurantReservation.menus",[]);if(a!==ORDER_STATUS_RESTAURANT_CANCELED&&c.length>0){var d="";return c.forEach(function(a){var b=kp.get(a,"quantity"),c=kp.get(a,"productName","-");if(kp.get(a,"daytrip",!1)){var e="";kp.get(a,"vegetarianVariantOf",null)&&(e=" Vegeterian"),d+=b+" x "+c+" (Daytrip"+e+")<br>"}else d+=b+" x "+c+"<br>"}),d}return"-"}),b.displayRestaurantPax=ko.computed(function(){return kp.get(b,"restaurantReservation.status",null)!==ORDER_STATUS_RESTAURANT_CANCELED?kp.get(b,"restaurantReservation.pax","-"):"-"}),b.displayRestaurant=ko.computed(function(){var a=kp.get(b,"restaurantReservation.restaurantId",!1);return a&&headerVM.nameToRestaurantIdMap[a]?headerVM.nameToRestaurantIdMap[a]:"-"}),b.connectedTrainOrderId=ko.computed(function(){var a=kp.get(b,"group.orders",[]);if(a.length>0){var c=kp.get(b,"id",null),d=a.find(function(a){return parseInt(a.restaurantOrderId)===c});if(d)return d.id}return null}),b.displayRestaurantOnlyTime=ko.computed(function(){if(kp.get(b,"restaurantReservation.restaurantId",!1))return moment(kp.get(b,"restaurantReservation.from")).format("HH:mm")+" - "+moment(kp.get(b,"restaurantReservation.until")).format("HH:mm");return"-"})}function groupModel(a){this.id=ko.observable(a.id),this.groupName=ko.observable(a.groupName),this.customerLanguage=ko.observable(a.customerLanguage),this.country=ko.observable(a.country),this.partnerId=ko.observable(a.partnerId),this.partnerName=ko.observable(a.partnerName),this.tourguideId=ko.observable(a.tourguideId),this.notificationExclusive=ko.observable(a.notificationExclusive),this.notificationEmails=ko.observableArray(a.notificationEmails),this.editableFields=ko.observableArray(a.editableFields),this.partnerContactPersonId=ko.observable(a.partnerContactPersonId),this.travelagencyId=ko.observable(a.travelagencyId),this.orders=ko.observableArray(a.orders)}function addonModel(a){var b=this;this.id=ko.observable(a.id),this.course=ko.observable(a.course),this.sku=ko.observable(a.sku),this.name=ko.observable(a.name),this.description=ko.observable(a.description),this.quantity=ko.observable(a.quantity),this.quantityCalc=ko.computed({read:function(){return b.quantity()},write:function(a){a<b.quantityFree()?b.quantity(b.quantityFree()):b.quantity(a)}}),this.price=ko.observable(a.price?a.price:0),this.quantityFree=ko.observable(a.quantityFree?a.quantityFree:0),this.discountPercent=ko.observable(a.discountPercent?a.discountPercent:0),this.discountPercentCalc=ko.computed({read:function(){return b.discountPercent()},write:function(a){a>100?b.discountPercent(100):a<0?b.discountPercent(0):b.discountPercent(a)}}),this.quantityFreeCalc=ko.computed({read:function(){return b.quantityFree()},write:function(a){a>b.quantity()?b.quantityFree(b.quantity()):b.quantityFree(a)}}),this.discountTotalPrice=ko.computed(function(){return b.quantityFree()*b.price()+b.discountPercent()*b.price()*(b.quantity()-b.quantityFree())/100}),this.totalPrice=ko.computed(function(){return b.quantity()*b.price()-b.discountTotalPrice()}),this.menuAddonList=ko.observableArray(a.menuAddonList),b.displayAddon=ko.computed(function(){var b=kp.get(a,"sku","-"),c=kp.get(a,"quantity"),d=headerVM.nameToMenuSkuMap[b]?headerVM.nameToMenuSkuMap[b]:"-",e="";return kp.get(a,"daytrip",!1)?e+=c+" x "+d+" (Daytrip)":e+=c+" x "+d,e})}function menuModel(a){var b=this;if(this.id=ko.observable(a.id),this.sku=ko.observable(a.sku),this.name=ko.observable(a.name),this.productName=ko.observable(a.productName),this.description=ko.observable(a.description),this.quantity=ko.observable(a.quantity),this.vegetarianVariantOf=ko.observable(a.vegetarianVariantOf),
this.quantityCalc=ko.computed({read:function(){return b.quantity()},write:function(a){a<b.quantityFree()?b.quantity(b.quantityFree()):b.quantity(a)}}),this.daytrip=ko.observable(a.daytrip),a.addons){var c=$.map(a.addons,function(a){return new addonModel(a)});this.addons=ko.observableArray(c)}else this.addons=ko.observableArray([]);this.price=ko.observable(0),this.quantityFree=ko.observable(a.quantityFree?a.quantityFree:0),this.discountPercent=ko.observable(a.discountPercent?a.discountPercent:0),this.discountPercentCalc=ko.computed({read:function(){return b.discountPercent()},write:function(a){a>100?b.discountPercent(100):a<0?b.discountPercent(0):b.discountPercent(a)}}),this.quantityFreeCalc=ko.computed({read:function(){return b.quantityFree()},write:function(a){a>b.quantity()?b.quantityFree(b.quantity()):b.quantityFree(a)}}),this.discountTotalPrice=ko.computed(function(){return b.quantityFree()*b.price()+b.discountPercent()*b.price()*(b.quantity()-b.quantityFree())/100}),this.totalPrice=ko.computed(function(){return b.quantity()*b.price()-b.discountTotalPrice()}),this.isIndividualMenu=ko.computed(function(){return b.sku()===INDIVIDUAL_MENU}),b.displayMenu=ko.computed(function(){var b=kp.get(a,"sku","-"),c=kp.get(a,"quantity"),d=headerVM.nameToMenuSkuMap[b]?headerVM.nameToMenuSkuMap[b]:"-",e="";return kp.get(a,"daytrip",!1)?e+=c+" x "+d+" (Daytrip)":e+=c+" x "+d,e}),this.getRaw=function(){return{id:kp.get(b,"id"),sku:kp.get(b,"sku"),quantity:parseInt(kp.get(b,"quantity")),daytrip:kp.get(b,"daytrip")}}}function drinkModel(a){var b=this;this.id=ko.observable(a.id),this.category=ko.observable(a.category),this.quantity=ko.observable(a.quantity),this.quantityCalc=ko.computed({read:function(){return b.quantity()},write:function(a){a<b.quantityFree()?b.quantity(b.quantityFree()):b.quantity(a)}}),this.description=ko.observable(a.description),this.revenue=ko.observable(a.revenue),this.quantityFree=ko.observable(a.quantityFree?a.quantityFree:0),this.discountPercent=ko.observable(a.discountPercent?a.discountPercent:0),this.discountPercentCalc=ko.computed({read:function(){return b.discountPercent()},write:function(a){a>100?b.discountPercent(100):a<0?b.discountPercent(0):b.discountPercent(a)}}),this.quantityFreeCalc=ko.computed({read:function(){return b.quantityFree()},write:function(a){a>b.quantity()?b.quantityFree(b.quantity()):b.quantityFree(a)}}),this.discountTotalPrice=ko.computed(function(){return b.discountPercent()*b.revenue()/100}),this.totalPrice=ko.computed(function(){return b.revenue()-b.discountTotalPrice()})}function groupReservationModel(a){this.id=ko.observable(a.id),this.type=ko.observable(a.type),this.categoryKey=ko.observable(a.categoryKey),this.status=ko.observable(a.status),this.updateSurcharge=ko.observable(a.updateSurcharge)}function restaurantRoomModel(a){var b=this;this.roomId=ko.observable(a.roomId),this.name=ko.observable(a.name),this.pax=ko.observable(a.pax),this.maxPax=ko.observable(0),this.freePax=ko.observable(0),this.freePaxCalc=ko.computed(function(){return b.freePax()-b.pax()})}function restaurantGroupReservationModel(a){var b=this;ko.utils.extend(b,new groupReservationModel(a)),this.id=ko.observable(a.id),this.status=ko.observable(a.status),this.gastroStatus=ko.observable(a.gastroStatus),this.gastroStatusChanged=ko.observable(a.gastroStatus);var c=$.map(a.menus,function(a){return new menuModel(a)});this.menus=ko.observableArray(c);var d=$.map(a.drinks,function(a){return new drinkModel(a)});if(this.drinks=ko.observableArray(d),this.customerComment=ko.observable(a.customerComment),this.restaurantId=ko.observable(a.restaurantId),a.roomAssignments){var e=$.map(a.roomAssignments,function(a){return new restaurantRoomModel(a)});this.roomAssignments=ko.observableArray(e)}else this.roomAssignments=ko.observableArray([]);this.pax=ko.observable(a.pax),this.from=ko.observable(a.from),this.until=ko.observable(a.until),this.externalId=ko.observable(a.externalId)}function bergbahnGroupReservationModel(a){var b=this;ko.utils.extend(b,new groupReservationModel(a)),this.externalImportedId=ko.observable(a.externalImportedId),this.customerComment=ko.observable(a.customerComment),this.externalId=ko.observable(a.externalId),this.date=ko.observable(a.date),this.numberOfSeats=ko.observable(a.numberOfSeats),this.numberOfHandicapSeats=ko.observable(a.numberOfHandicapSeats),this.outwardJourney=ko.observable(new journeyModel(a.outwardJourney)),this.returnJourney=ko.observable(),this.productRoute=ko.observable(a.productRoute),this.productTripType=ko.observable(a.productTripType),this.productClassKey=ko.observable(a.productClassKey),this.texts=ko.observable(kp.get(a,"texts",[])),this.textDescriptions=ko.observable(kp.get(a,"textDescriptions",[])),a.returnJourney&&this.returnJourney(new journeyModel(a.returnJourney))}function journeyModel(a){this.id=ko.observable(a.id),this.comment=ko.observable(a.comment),this.date=ko.observable(a.date),this.searchTime=ko.observable(a.searchTime),this.searchTimeType=ko.observable(a.searchTimeType),this.stationFrom=ko.observable(a.stationFrom),this.stationFromName=ko.observable(a.stationFromName),this.stationTo=ko.observable(a.stationTo),this.stationToName=ko.observable(a.stationToName),this.stationVia=ko.observable(a.stationVia),this.stationViaName=ko.observable(a.stationViaName);var b=$.map(a.trains,function(a){return new trainModel(a)});this.trains=ko.observableArray(b)}function SubserviceMultiSelectOptionModel(a,b,c){var d=this;d.id=ko.observable(a.key),d.categoryType=ko.observable(b),d.consumerGroup=ko.observable(c),d.priceModels=ko.observableArray([]),d.price=ko.computed(function(){for(var a=null,b=0;b<d.priceModels().length;b++)(null==a||a<d.priceModels()[b].price())&&(a=d.priceModels()[b].price());return a}),d.name=ko.observable(a.name),d.productKey=ko.observable(a.productKey),d.items=ko.computed(function(){return ko.utils.arrayFilter(a.items,function(a){return d.categoryType()?a.categoryType==d.categoryType()&&a.consumerGroup==d.consumerGroup():a.consumerGroup==d.consumerGroup()})}),d.selected=ko.observable(!1),d.required=ko.observable(!1),d.refItemId=ko.observable()}function SubservicePriceModel(a,b){var c=this;ko.utils.extend(c,new simplePriceModel(a,b)),c.toDate=ko.observable(),c.getSpecificAttributes=function(){return{productKey:c.productKey(),toDate:c.toDate()}}}function RestaurantModel(a){var b=this;b.productName=ko.observable(a.name),b.displayName=ko.observable(a.name),b.sku=ko.observable(a.key),b.key=ko.observable(a.key),b.description=ko.observable(a.description),b.price=ko.observable(),b.addToCartEnabled=ko.computed(function(){return!0})}function RestaurantPriceModel(a,b){var c=this;ko.utils.extend(c,new simplePriceModel(a,b)),c.region=ko.observable(a.region),c.city=ko.observable(a.city),c.consumerType=ko.observable(a.consumerKey),c.toDate=ko.observable(a.toDate),c.matches=function(a){return c.productKey()==a.productKey()&&c.date()===a.date()&&c.consumerType()===a.consumerKey()},c.getSpecificAttributes=function(){return{productKey:c.productKey(),cityName:c.city(),regionName:c.region(),consumerType:c.consumerType(),toDate:c.toDate()}}}function PackageRequestRegionCityModel(a,b,c,d,e){var f=this;f.key=ko.observable(a),f.name=ko.observable(b),f.cityKey=ko.observable(c),f.cityName=ko.observable(d),f.serviceproviders=ko.observableArray([]),f.selectAllSelected=ko.observable(!1),f.selectAllSelected.subscribe(function(a){f.filteredServiceproviders().forEach(function(b){b.isSelected(a)})}),f.getRegionCityName=ko.pureComputed(function(){return f.name()+" ("+f.cityName()+")"}),f.filteredServiceproviders=ko.computed(function(){return ko.utils.arrayFilter(f.serviceproviders(),function(a){return!e()||e()===a.cityKey()})}),f.getServiceproviderCnt=ko.pureComputed(function(){var a=f.serviceproviders().length;return 1===a?a+" "+i18n.t("packages.reservationDialog.restaurant"):a+" "+i18n.t("packages.reservationDialog.restaurants")})}function PackageRequestServiceproviderModel(a,b,c,d,e,f){var g=this;g.productId=ko.observable(a),g.key=ko.observable(b),g.name=ko.observable(c),g.regionName=ko.observable(f),g.cityKey=ko.observable(d),g.cityName=ko.observable(e),g.isSelected=ko.observable(!1),g.confirmedSelected=ko.observable(!1),g.requestError=ko.observable(!1),g.reservationStatus=ko.observable(),g.reservationRequestHash=ko.observable(),g.details=ko.observable(),g.getRegionCityName=ko.pureComputed(function(){return g.regionName()+" ("+g.cityName()+")"}),g.getReservationStatus=ko.computed(function(){return g.reservationStatus()?i18n.t("packages.hotel.states."+g.reservationStatus()):null})}function rebateRuleModel(a,b,c){var d=this;this.id=ko.observable(a.id),this.name=ko.observable(a.name),this.description=ko.observable(a.description),this.validFrom=ko.observable(a.validFrom),this.validTo=ko.observable(a.validTo),this.type=ko.observable(a.type),this.categories=ko.observableArray(a.categories),this.rule=ko.observable(a.rule),this.hasValidationPart=ko.observable(b),this.supportsReductionValidation=ko.observable(c),this.shoppingcart=ko.observable(),this.partnerId=ko.observable(),this.isGroupReservation=ko.observable(),this.isCategory=function(a){var b=a.categoryKey(),c=a;return CATEGORY_KEY_BUNDLE==b&&d instanceof rebateRuleModel_groupReductionBergbahn&&(c=d.getBergbahnItem(a)),-1!=d.categories().indexOf(c.categoryKey().toLowerCase())},this.apply=function(a,b,c,e){if(d.isCategory(a)){d.shoppingcart(c),d.partnerId(c.partnerId()),d.isGroupReservation(c.isGroupReservation());var f=$.datepicker.parseDate(DATE_SERVER_FORMAT,d.validFrom()),g=$.datepicker.parseDate(DATE_SERVER_FORMAT,d.validTo()),h=$.datepicker.parseDate(DATE_SERVER_FORMAT,a.price().date());f<=h&&h<=g&&d.applyRule(a,b,e)}},this.getValidationAmount=function(a){if(d.hasValidationPart()&&d.isCategory(a)){var b=$.datepicker.parseDate(DATE_SERVER_FORMAT,d.validFrom()),c=$.datepicker.parseDate(DATE_SERVER_FORMAT,d.validTo()),e=$.datepicker.parseDate(DATE_SERVER_FORMAT,a.price().date());if(b<=e&&e<=c)return d.getRuleValidationAmount(a)}return null},this.validate=function(a){return!d.hasValidationPart()||d.validateRequestOrder(a)},this.validateReduction=function(a,b,c){if(d.isCategory(b)){var e=$.datepicker.parseDate(DATE_SERVER_FORMAT,d.validFrom()),f=$.datepicker.parseDate(DATE_SERVER_FORMAT,d.validTo()),g=$.datepicker.parseDate(DATE_SERVER_FORMAT,b.date());if(e<=g&&g<=f&&d.supportsReductionValidation())return d.validateReduction(a,b,c)}return!0}}function rebateRuleModel_weekdaySkuRule(a){var b=this;rebateRuleModel.apply(b,[a,!1,!1]);var c=b.rule().split(";");b.replacement=ko.observable(c[3]);var d=b.replacement().split(">");b.triggerAmount=ko.observable(c[0]),b.triggerSkus=ko.observable(c[1]),b.targetSku=ko.observable(d[0]),b.replaceSku=ko.observable(d[1]),b.replaceAmount=ko.observable(c[4]),b.weekday=ko.observable(c[5]);var e=b.targetSku().split(".");b.targetSkuCategoryKey=ko.observable(e[0]),b.targetSkuRegionKey=ko.observable(e[1].toLowerCase()),b.targetSkuDurationKey=ko.observable(e[2]),b.targetSkuConsumerKey=ko.observable(e[3].toLowerCase()),b.targetSkuReductionLevel=ko.observable(e.length>4?e[5]:null);var f=b.replaceSku().split(".");b.replaceSkuCategoryKey=ko.observable(f[0]),b.replaceSkuRegionKey=ko.observable(f[1].toLowerCase()),b.replaceSkuDurationKey=ko.observable(f[2]),b.replaceSkuConsumerKey=ko.observable(f[3].toLowerCase()),b.replaceSkuReductionLevel=ko.observable(f.length>4?f[5]:null),this.getSku=function(a){var b=null;return b="function"==typeof a.price().regionKey&&"function"==typeof a.price().durationKey&&"function"==typeof a.price().consumerKey?a.categoryKey()+"."+a.price().regionKey()+"."+a.price().durationKey()+"."+a.price().consumerKey():a.price().sku(),null!=a.price().reductionLevel()&&""!=a.price().reductionLevel()&&(b+=".RED."+a.price().reductionLevel()),b=b.toLowerCase()},this.mapTriggerDay=function(a){return"Lu"==a?a="Mo":"Di"==a||"Ma"==a?a="Tu":"Mi"==a||"Me"==a?a="We":"Do"==a||"Je"==a?a="Th":"Ve"==a?a="Fr":"So"!=a&&"Di"!=a||(a="Su"),a},this.isTriggerDay=function(a){var c=$.datepicker.parseDate(DATE_SERVER_FORMAT,a.price().date()),d=b.mapTriggerDay(moment(c).format("dd"))+",";return-1!=(b.weekday()+",").indexOf(d)},this.isTriggerSku=function(a){if(!b.isCategory(a))return!1;var c=b.getSku(a).toLowerCase();return-1!=(b.triggerSkus().toLowerCase()+"|").indexOf(c+"|")},this.isReplaceSku=function(a){return!!b.isCategory(a)&&b.getSku(a).toLowerCase()==b.replaceSku().toLowerCase()},this.isTargetSku=function(a){return!!b.isCategory(a)&&b.getSku(a).toLowerCase()==b.targetSku().toLowerCase()},this.addDayAmount=function(a,b,c){for(var d=b.price().date(),e=null!=c?c:b.quantity(),f=!1,g=0;g<a.length;g++)a[g][0]==d&&(a[g][1]=a[g][1]+e,f=!0);f||a.push([d,e])},this.getDayMaxReplacementAmount=function(a,c){for(var d=0;d<a.length;d++)if(a[d][0]==c){var e=a[d][1],f=Math.floor(e/b.triggerAmount())*b.replaceAmount();return f}return 0},this.applyRule=function(a,c){if(b.isTriggerSku(a)||b.isTargetSku(a)||b.isReplaceSku(a)){var d=new Array;b.addDayAmount(d,a,0);for(var e=0;e<c.length;e++){var f=c[e];-1!=b.categories().indexOf(f.categoryKey().toLowerCase())&&b.isTriggerDay(f)&&b.isTriggerSku(f)&&(b.addDayAmount(d,f),f.price().rebateRuleId(b.id()))}if(d.length>0)for(var e=0;e<d.length;e++){var g=d[e][0],h=b.getTargetPrice(g),i=b.getReplacePrice(g);$.when(h,i).done(function(a,e){a.rebateRuleId(b.id()),e.rebateRuleId(b.id()),b.performReplacement(a.date(),c,d,a,e)})}}},this.performReplacement=function(a,c,d,e,f){console.log("performReplacementCart");for(var g=0;g<c.length;g++){var h=c[g];if(a==h.price().date()&&b.isReplaceSku(h)){var i=h.quantity();b.shoppingcart().removeEntry(h,null,!0,!0);b.shoppingcart().addEntryQuantity(e,null,b.targetSkuCategoryKey(),null,i,!0,!1)}}var j=b.getDayMaxReplacementAmount(d,a);if(j>0)for(var k=c.slice(0),g=0;g<k.length;g++){var h=k[g];if(a==h.price().date()&&b.isTargetSku(h)){var l=h.quantity(),m=l<=j?l:j;b.shoppingcart().decrEntryQuantity(h,null,m,!0);b.shoppingcart().addEntryQuantity(f,null,b.replaceSkuCategoryKey(),null,m,!0,!1)}}},this.getReplacePrice=function(a){return console.log("getReplacePrice"),$.ajax(serviceRootURL+"/skiprice",{type:"GET",data:{categoryKey:b.replaceSkuCategoryKey(),consumerKey:b.replaceSkuConsumerKey(),regionKey:b.replaceSkuRegionKey(),durationKey:b.replaceSkuDurationKey(),reductionLevel:b.replaceSkuReductionLevel(),dateString:a},dataType:"json",contentType:"application/json",error:function(a,b,c){throw checkSession(a),showError("Error when retrieving replace price for rebateRuleModel_weekdaySkuRule",a,b,c,!0),new Error("Error when retrieving replace price for rebateRuleModel_weekdaySkuRule")}}).pipe(function(a){if(console.log("replace price: ",a),null!=a.price)return new skiPriceModel(a);throw showError("Error when retrieving replace price for rebateRuleModel_weekdaySkuRule"),new Error("Error when retrieving replace price for rebateRuleModel_weekdaySkuRule")})},this.getTargetPrice=function(a){return $.ajax(serviceRootURL+"/skiprice",{type:"GET",data:{categoryKey:b.targetSkuCategoryKey(),consumerKey:b.targetSkuConsumerKey(),regionKey:b.targetSkuRegionKey(),durationKey:b.targetSkuDurationKey(),reductionLevel:b.targetSkuReductionLevel(),dateString:a},dataType:"json",contentType:"application/json",error:function(a,b,c){throw checkSession(a),showError("Error when retrieving target price for rebateRuleModel_weekdaySkuRule",a,b,c,!0),new Error("Error when retrieving target price for rebateRuleModel_weekdaySkuRule")}}).pipe(function(a){if(null!=a.price)return new skiPriceModel(a);throw showError("Error when retrieving target price for rebateRuleModel_weekdaySkuRule"),new Error("Error when retrieving target price for rebateRuleModel_weekdaySkuRule")})}}function rebateRuleModel_groupReductionBergbahn(a){var b=this;rebateRuleModel.apply(b,[a,!0,!0]);var c=new Array,d=b.rule().split(";"),e=d[2].split(",");b.triggerTariffKey=ko.observable(d[0]),b.triggerAmount=ko.observable(d[1]),b.triggerPersonKey=ko.observable(e[0]),b.triggerPersongroups=ko.observable(e),b.frequency=ko.observable(d[3]),b.replaceAmount=ko.observable(d[4]),b.replacePersonKey=ko.observable(d[5]),b.validationTariffKey=ko.observable(b.triggerTariffKey()),b.validationAmount=ko.observable(b.triggerAmount());for(var f="",g=0;g<b.triggerPersongroups().length;g++)f+=b.triggerPersongroups()[g]+",";f+=b.replacePersonKey()+",",b.validationPersons=ko.observable(f),b.getBergbahnItem=function(a){if(a instanceof cartEntryModel){if(a.price()instanceof bergbahnPriceModel)return a.price();if(a.price()instanceof bundlePriceModel)for(var b=0;b<a.price().bundleItems().length;b++){var c=a.price().bundleItems()[b];if(c.price()instanceof bergbahnPriceModel)return c.price()}return a}if(a instanceof orderItemBergbahnModel)return a;if(a instanceof orderItemBundleModel)for(var b=0;b<a.bundleItems().length;b++){var c=a.bundleItems()[b];if(c instanceof orderItemBergbahnModel)return c}return null},this.isTriggerProduct=function(a){for(var c=b.getBergbahnItem(a),d=0;d<b.triggerPersongroups().length;d++)if(c.personKey()==b.triggerPersongroups()[d]&&null!=c.tariffKey().match(b.triggerTariffKey()+"$"))return!0;return!1},b.isCategoryMemberOfRule=function(a){var c=b.getBergbahnItem(a);return-1!=b.categories().indexOf(c.categoryKey().toLowerCase())},b.isTariffPartOfRule=function(a){var c=null;return null!=b.rule()&&(c=b.rule().split(";")[0]),!!a.match(c)},this.isReplaceProduct=function(a){var c=b.getBergbahnItem(a);return c.personKey()==b.replacePersonKey()&&null!=c.tariffKey().match(b.triggerTariffKey()+"$")},this.isValidationProduct=function(a){var c=b.getBergbahnItem(a),d=c.personKey()+",";return-1!=b.validationPersons().indexOf(d)&&null!=c.tariffKey().match(b.validationTariffKey())},this.isValidationOrderItem=function(a){var c=b.getBergbahnItem(a),d=c.personKey()+",",e=c.tariffKey();return-1!=b.validationPersons().indexOf(d)&&null!=e.match(b.validationTariffKey())},this.isGroupItem=function(a){return null!=b.getBergbahnItem(a).tariffKey().match(b.triggerTariffKey()+"$")},this.isValidationTariff=function(a){return null!=b.getBergbahnItem(a).tariffKey().match(b.validationTariffKey())},this.getProductName=function(a){var c=b.getBergbahnItem(a);return c.bergbahnFrom()+"-"+c.bergbahnTo()+", "+c.className()+", "+c.tripTypeName()},this.getKey=function(a){var c=b.getBergbahnItem(a);return a.hasOwnProperty("date")&&a.hasOwnProperty("productKey")?a.date()+"_"+a.productKey()+"_"+c.tariffKey():a.hasOwnProperty("price")&&a.price().hasOwnProperty("date")&&a.price().hasOwnProperty("productKey")?a.price().date()+"_"+a.price().productKey()+"_"+c.tariffKey():c.date()+"_"+c.productKey()+"_"+c.tariffKey()},this.addDayProductKeyAmount=function(a,c,d){for(var e=b.getKey(c),f=null!=d?d:c.quantity(),g=!1,h=0;h<a.length;h++)a[h][0]==e&&(a[h][1]=a[h][1]+f,g=!0);if(!g){var i=b.getProductName(c),j=b.getBergbahnItem(c);a.push([e,f,j.date(),j.productKey(),j.tariffKey(),i,j.fromKey(),j.toKey(),j.viaKey(),j.classKey(),j.tripTypeKey()])}},this.addDayProductKeyAmountReduction=function(a,c){for(var d=b.getKey(c),e=c.totalForwarded(),f=parseInt(c.totalUsedUpdate()),g=!1,h=0;h<a.length;h++){var i=a[h];i.key==d&&(i.totalForwarded=i.totalForwarded+e,i.totalUsedUpdate=i.totalUsedUpdate+f,g=!0)}g||a.push({key:d,totalForwarded:e,totalUsedUpdate:f})},this.getDayProductKeyAmount=function(a,c,d){var e=b.getKey(c),f=0,g=Array(),h=null;if("function"==typeof c.price().tariffKey&&(h=c.price().tariffKey().split("_")[0]),c.price().categoryKey()==CATEGORY_KEY_BERGBAHN_GROUP_RESERVATION&&"660"==h||"670"==h){for(var i=0;i<a.length;i++)c.price().productKey()==a[i][3]&&c.price().date()==a[i][2]&&h==a[i][4].split("_")[0]&&(g.push(i),f+=a[i][1]);for(var i=0;i<g.length;i++)a[g[i]][1]=f}for(var i=0;i<a.length;i++)if(a[i][0]==e)return a[i];return null},this.getDayProductKeyAmountReduction=function(a,c,d){for(var e=b.getKey(c),f=0;f<a.length;f++)if(a[f].key==e)return a[f];return null},this.getDayProductKeyTariffMaxReplacementAmount=function(a,c,d,e){for(var f=0,g=c+"_"+d+"_"+e,h=0;h<a.length;h++)if(a[h][0]===g){for(var i=0,j=0;j<a.length;j++)b.isTariffPartOfRule(a[j][4])&&a[j][2]==c&&a[j][3]==a[h][3]&&(i+=a[j][1]);if("1"==b.frequency())f=i>=b.triggerAmount()?b.replaceAmount():0;else for(var k=i;k-b.triggerAmount()>=0;)f+=Number(b.replaceAmount()),k-=Number(b.triggerAmount())}return f},this.applyRule=function(a,c,d){if(b.isCategoryMemberOfRule(a)&&(b.isTriggerProduct(a)||b.isReplaceProduct(a))){a.price().isGroupItem(b.isGroupItem(a));var e=new Array;b.addDayProductKeyAmount(e,a,0);for(var f=0;f<c.length;f++){var g=c[f];b.isCategoryMemberOfRule(g)&&(b.isTriggerProduct(g)||b.isReplaceProduct(g))&&(b.addDayProductKeyAmount(e,g),g.price().rebateRuleId(b.id()))}console.log("dayProductKeyAmounts",e);var h=!1;if(e.length>0)for(var f=0;f<e.length;f++){var i,j=e[f],k=j[2],l=j[3],m=j[4],n=j[6],o=j[7],p=j[8],q=j[9],r=j[10],s=new Array;if(a.price()instanceof bergbahnPriceModel){for(var f=0;f<b.triggerPersongroups().length;f++)s.push(b.getTargetPrice(k,l,m,n,o,p,q,r,b.triggerPersongroups()[f],a.categoryKey()));i=b.getReplacePrice(k,l,m,n,o,p,q,r,a.categoryKey())}else{for(var t=a.price(),f=0;f<b.triggerPersongroups().length;f++)s.push(b.getTargetPriceBundle(t.date(),t.productKey(),m,n,o,p,q,r,b.triggerPersongroups()[f],t.categoryKey()));i=b.getReplacePriceBundle(t.date(),t.productKey(),m,n,o,p,q,r,t.categoryKey())}var u=[];if($.when.apply($,s).done(function(){$.each(arguments,function(a,c){null!=c&&(c.rebateRuleId(b.id()),u[c.consumerKey().split(".")[1]]=c)}),$.when(i).done(function(a){a.rebateRuleId(b.id()),h=!0;for(key in u){b.performReplacementCart(u[key].date(),u[key].productKey(),u[key].consumerKey().split(".")[0],c,e,u,a,d);break}})}),!h)break}}},this.applyRuleForOrderItems=function(a,c){if(console.log("applyRuleForOrderItems",b.name(),a),b.isCategoryMemberOfRule(a)&&(b.isTriggerProduct(a)||b.isReplaceProduct(a))){if(!b.validateReduction(c,a)){a.totalUsedUpdate(parseInt(b.triggerAmount()));for(var d=0;d<c.length;d++){var e=c[d];b.isReplaceProduct(e)&&b.isCategoryMemberOfRule(e)&&e.totalUsedUpdate(0)}}var f=new Array;b.addDayProductKeyAmount(f,a,0);for(var d=0;d<c.length;d++){var e=c[d];(b.isTriggerProduct(e)||b.isReplaceProduct(e))&&b.isCategoryMemberOfRule(e)&&(b.addDayProductKeyAmount(f,e,e.totalUsedUpdate()),e.rebateRuleId(b.id()))}if(f.length>0)for(var d=0;d<f.length;d++){f[d][1]=parseInt(f[d][1]);var g=f[d],h=g[2],i=g[3],j=g[4],k=g[6],l=g[7],m=g[8],n=g[9],o=g[10],p=new Array,q=null;if(a instanceof orderItemBergbahnModel){for(var d=0;d<b.triggerPersongroups().length;d++)p.push(b.getTargetPrice(h,i,j,k,l,m,n,o,b.triggerPersongroups()[d],a.categoryKey()));q=b.getReplacePrice(h,i,j,k,l,m,n,o,a.categoryKey())}else if(a instanceof orderItemBundleModel){for(var d=0;d<b.triggerPersongroups().length;d++)p.push(b.getTargetPriceBundle(a.date(),a.productKey(),j,k,l,m,n,o,b.triggerPersongroups()[d],a.categoryKey()));q=b.getReplacePriceBundle(a.date(),a.productKey(),j,k,l,m,n,o,a.categoryKey())}var r=new Array;$.when.apply($,p).done(function(){$.each(arguments,function(a,c){var d=c;d.hasOwnProperty("rebateRuleId")?d.rebateRuleId(b.id()):d.rebateRuleId=ko.observable(b.id()),r[d.consumerKey().split(".")[1]]=d}),$.when(q).done(function(a){a.hasOwnProperty("rebateRuleId")?a.rebateRuleId(b.id()):a.rebateRuleId=ko.observable(b.id());for(key in r){b.performOrderItemReplacement(r[key].date(),r[key].productKey(),r[key].consumerKey().split(".")[0],c,f,r,a);break}})})}}},b.getTargetPriceBundle=function(a,c,d,e,f,g,h,i,j,k){var l={categoryKey:b.getBundleCategoryKey(),productKey:c,dateString:a,consumerKey:d+"."+j,selectableItems:[]},m={categoryKey:b.getBergbahnCategoryKey(),fromKey:e,toKey:f,viaKey:g,classKey:h,tripTypeKey:i,consumerKey:d+"."+j,dateString:a,isAddOn:!0,provideOptionNames:!0};return l.selectableItems.push(m),$.ajax(serviceRootURL+"/daytripsprice"+b.getDaytripsPriceRequestParams(),{type:"POST",data:JSON.stringify(l),dataType:"json",contentType:"application/json",error:function(a,b,c){throw checkSession(a),showError("Error when retrieving target bundle price for rebateRuleModel_groupReductionBergbahn",!0),new Error("Error when retrieving target bundle price for rebateRuleModel_groupReductionBergbahn",a,b,c)}}).pipe(function(a){if(null!=a.price){var b={value:ko.observable("test")},c=new bundlePriceModel(a,b);if(null!=a.bundleItems)for(var d=0;d<a.bundleItems.length;d++){var e=a.bundleItems[d].categoryKey;if(e===CATEGORY_KEY_BERGBAHN_GROUP_RESERVATION||e===CATEGORY_KEY_BERGBAHN){var f=a.bundleItems[d],g={additionalInfo:{categoryKey:e}},h=new addOnBergbahnOptionModel(g);h.fromKey(f.fromKey),h.fromName(f.fromName),h.toKey(f.toKey),h.toName(f.toName),h.viaKey(f.viaKey),h.viaName(f.viaName),h.tripTypeKey(f.tripTypeKey),h.tripTypeName(f.tripTypeName),h.classKey(f.classKey),h.className(f.className);var i=getPriceBundleItemInstance(a.bundleItems[d],h);c.bundleItems().push(i)}else if(a.bundleItems[d].categoryKey==CATEGORY_KEY_ADDON){var i=getPriceBundleItemInstance(a.bundleItems[d]);c.bundleItems().push(i)}}return c}throw console.log("Bundle price not found: "+xhr.responseText),showError("Error when retrieving target price for rebateRuleModel_groupReductionBergbahn"),new Error("Error when retrieving target price for rebateRuleModel_groupReductionBergbahn")})},b.getDaytripsPriceRequestParams=function(){var a="",c=b.partnerId();return null!==c&&(a="?partnerId="+c),a},b.getBundleCategoryKey=function(){return b.shoppingcart()instanceof shoppingCartViewModel?CATEGORY_KEY_DAYTRIPS:CATEGORY_KEY_DAYTRIPS_GROUP_RESERVATION},b.getBergbahnCategoryKey=function(){return b.shoppingcart()instanceof shoppingCartViewModel?CATEGORY_KEY_BERGBAHN:CATEGORY_KEY_BERGBAHN_GROUP_RESERVATION},b.getReplacePriceBundle=function(a,c,d,e,f,g,h,i,j){var k={categoryKey:b.getBundleCategoryKey(),productKey:c,dateString:a,consumerKey:d+"."+b.replacePersonKey(),selectableItems:[]},l={categoryKey:b.getBergbahnCategoryKey(),fromKey:e,toKey:f,viaKey:g,classKey:h,tripTypeKey:i,consumerKey:d+"."+b.replacePersonKey(),dateString:a,isAddOn:!0,provideOptionNames:!0};return k.selectableItems.push(l),$.ajax(serviceRootURL+"/daytripsprice"+b.getDaytripsPriceRequestParams(),{type:"POST",data:JSON.stringify(k),dataType:"json",contentType:"application/json",error:function(a,b,c){throw checkSession(a),showError("Error when retrieving replace bundle price for rebateRuleModel_groupReductionBergbahn",!0),new Error("Error when retrieving replace bundle price for rebateRuleModel_groupReductionBergbahn",a,b,c)}}).pipe(function(a){if(null!=a.price){var b=new bundlePriceModel(a);if(null!=a.bundleItems)for(var c=0;c<a.bundleItems.length;c++){var d=a.bundleItems[c].categoryKey;if(d==CATEGORY_KEY_BERGBAHN_GROUP_RESERVATION||d==CATEGORY_KEY_BERGBAHN){var e=a.bundleItems[c],f={additionalInfo:{categoryKey:d}},g=new addOnBergbahnOptionModel(f);g.fromKey(e.fromKey),g.fromName(e.fromName),g.toKey(e.toKey),g.toName(e.toName),g.viaKey(e.viaKey),g.viaName(e.viaName),g.tripTypeKey(e.tripTypeKey),g.tripTypeName(e.tripTypeName),g.classKey(e.classKey),g.className(e.className);var h=getPriceBundleItemInstance(a.bundleItems[c],g);b.bundleItems().push(h)}else if(a.bundleItems[c].categoryKey==CATEGORY_KEY_ADDON){var h=getPriceBundleItemInstance(a.bundleItems[c]);b.bundleItems().push(h)}}return b}throw console.log("Bundle price not found: "+xhr.responseText),showError("Error when retrieving replace price for rebateRuleModel_groupReductionBergbahn"),new Error("Error when retrieving replace price for rebateRuleModel_groupReductionBergbahn")})},this.revertFreeItems=function(a,c,d,e){for(var f=0;f<a.length;f++){var g=a[f];c==g.price().date()&&d==g.price().productKey()&&e.consumerKey()==g.price().consumerKey()&&g.rebateRuleItemReference()&&g.rebateRuleItemReference().forEach(function(c){var d=c.key,e=c.amount;b.shoppingcart().decrEntryQuantity(g,null,e,!0);for(var f=0;f<a.length;f++){var h=a[f];if(h.internalId()==d){b.shoppingcart().addEntryQuantity(h.price(),null,h.categoryKey(),null,e,!0,!1);break}}})}},this.performReplacementCart=function(a,c,d,e,f,g,h,i){console.log("performReplacementCart",a,c,d,e,f,g,h,i),b.revertFreeItems(e,a,c,h);var j=0,k=b.getDayProductKeyTariffMaxReplacementAmount(f,a,c,d);if(k>0)for(;j<k;){k-=j;for(var l=e.slice(0),m=b.getMostExpensiveCartPrice(l,a,c,d,i),n=!1,o=0;o<l.length;o++){var p=l[o],q=b.getBergbahnItem(p);if(a==p.price().date()&&c==p.price().productKey()&&(d==q.tariffKey()||b.isTariffPartOfRule(q.tariffKey()))&&m.consumerKey()==p.price().consumerKey()){var r=p.quantity(),s=r<=k?r:k;b.shoppingcart().decrEntryQuantity(p,null,s,!0);var t=b.shoppingcart().addEntryQuantity(h,null,p.categoryKey(),null,s,!0,!1);if(t.rebateRuleItemReference.push({key:p.internalId(),amount:s}),null!=p.price&&null!=t.price&&null!=p.price().bundleItems&&null!=t.price().bundleItems&&t.price().bundleItems().length==p.price().bundleItems().length)for(var u=0;u<p.price().bundleItems().length;u++){var v=p.price().bundleItems()[u],w=t.price().bundleItems()[u];null!=v.price().selectable&&null!=w.price().selectable&&1==v.price().selectable()&&t.price().bundleItems()[u].price().selectable(!0)}t.price().previousConsumerKey().push(m.consumerKey()),t.price().isGroupItem(b.isGroupItem(t)),t.price().isComputed(!0),j+=s,n=!0}}if(!n){console.error("Failed to replace an item, breaking to avoid endless loop");break}}return j},this.replacementTicketsApplyForCurrentTariffCheck=function(a,c,d,e,f,g,h){var i=!1;if(f==REBATE_RULE_DECREASE_AMOUNT)for(var j=0;j<a.length;j++)a[j][3]==d&&a[j][4]==e&&(a[j][1]=a[j][1]+1);if(b.getDayProductKeyTariffMaxReplacementAmount(a,c,d,e)>0&&(i=!0),f==REBATE_RULE_DECREASE_AMOUNT)for(var j=0;j<a.length;j++)a[j][3]==d&&a[j][4]==e&&(a[j][1]=a[j][1]-1);var k=b.getReplacementTicketsForOtherRebateRule(a,c,d,e,f,g,h),l=0,m=0,n=b.getReplacePriceEntry(g,h);if(null==n||(l=n.quantity(),"function"==typeof n.price().tariffKey)){for(var j=0;j<a.length;j++)null!=n&&n.price().productKey()==a[j][3]&&n.price().date()==a[j][2]&&n.price().tariffKey()==a[j][4]&&(m=j);return l-k<=0&&f!=REBATE_RULE_DECREASE_AMOUNT&&(a.splice(m,1),i=!1),i}},this.getReplacementTicketsForOtherRebateRule=function(a,c,d,e,f,g,h){var i=0,j=0,k=0,l=0,m=0,n=0,o=0,p=0,q=b.getReplacePriceEntry(g,h),r=0;null!=q&&(r=q.quantity());for(var s=0;s<headerVM.rebateRules().length;s++){var t=headerVM.rebateRules()[s],u=0,v=0;if(t.id()==b.id()){for(var w=0;w<g.length;w++){var x=g[w];"function"==typeof x.price().tariffKey&&b.isTariffPartOfRule(x.price().tariffKey())&&t.isTariffPartOfRule(x.price().tariffKey())&&t.isReplaceProduct(q)&&q.price().sku()!=x.price().sku()&&(k+=x.quantity())}l=Math.floor(k/t.triggerAmount()),j=(k+l)%t.triggerAmount(),f!=REBATE_RULE_DECREASE_AMOUNT?j==t.triggerAmount()-1&&m++:j==t.triggerAmount()-2&&m++}else if(t.id()!=b.id()&&t.isGroupReservation()&&b.isGroupReservation()){for(var w=0;w<g.length;w++){var x=g[w];"function"==typeof x.price().tariffKey&&!b.isTariffPartOfRule(x.price().tariffKey())&&t.isTariffPartOfRule(x.price().tariffKey())&&t.isReplaceProduct(q)&&q.price().sku()!=x.price().sku()&&(u+=x.quantity())}v=Math.floor(u/t.triggerAmount()),(u+v)%t.triggerAmount()==t.triggerAmount()-1&&p++,n+=u,o+=v}}return i=r-(l+o),p>=i?o+p:o+(i-m)},this.getReplacePriceEntry=function(a,b){for(var c=null,d=0;d<a.length;d++){var e=a[d];e.price().id()==b.id()&&(c=e)}return c},this.performOrderItemReplacement=function(a,c,d,e,f,g,h){console.log("performOrderItemReplacement",a,c,d,e,f,g,h);for(var i=parseInt(b.getNrOfFreeTickets(f,a,c,d)),j=0,k=0;k<f.length;k++)f[k][0]==a+"_"+c+"_"+d&&(j=f[k][1]);j-=i;for(var l=b.getMostExpensiveOrderItem(e,a,c),k=0;k<e.length;k++){var m=e[k];if(a==m.date()&&c==m.productKey()&&h.consumerKey()==m.consumerKey()){var n=i-m.totalUsedUpdate();m.totalUsedUpdate(i),l.totalUsedUpdate(l.totalUsedUpdate()-n),!0}}},this.getNrOfFreeTickets=function(a,c,d,e){for(var f=0;f<a.length;f++)if(a[f][0]==c+"_"+d+"_"+e){var g=a[f][1];if("1"==b.frequency())var h=g>=b.triggerAmount()?b.replaceAmount():0;else for(var h=0,i=g;i-b.triggerAmount()>=0;)h+=1,i-=b.triggerAmount();return h}return 0},
this.getMostExpensivePrice=function(a){var b=null;for(var c in a)if(a.hasOwnProperty(c)){var d=a[c];(null==b||d.price()>b.price())&&(b=d)}return b},this.getMostExpensiveOrderItem=function(a,c,d){for(var e=0,f=0,g=a[0],h=0;h<a.length;h++){var i=a[h];null!=i.tariffKey&&i.tariffKey().match(b.triggerTariffKey()+"$")&&i.date()==c&&i.productKey()==d&&(f=i.price())>e&&(e=f,g=i)}return g},this.getMostExpensiveCartPrice=function(a,c,d,e,f){for(var g=0,h=0,i=a[0].price(),j=0;j<a.length;j++){var k=a[j],l=b.getBergbahnItem(k);null!=l.tariffKey&&l.tariffKey().match(b.triggerTariffKey()+"$")&&"function"==typeof k.price().tariffKey&&k.price().date()==c&&k.price().productKey()==d&&(k.price().tariffKey()==e||b.isTariffPartOfRule(k.price().tariffKey())&&f!=REBATE_RULE_DECREASE_AMOUNT)&&(h=k.price().price())>g&&(g=h,i=k.price())}return i},this.getReplacePrice=function(a,c,d,e,f,g,h,i,j){var k=b.partnerId();return console.log("getReplacePrice: ",a,c,d,e,f,g,h,i,j),$.ajax(serviceRootURL+"/bergbahnprice",{type:"GET",data:{categoryKey:j,consumerKey:d+"."+b.replacePersonKey(),fromKey:e,toKey:f,viaKey:g,classKey:h,tripTypeKey:i,dateString:a,partnerId:k,provideOptionNames:b.isGroupReservation()},error:function(a,b,c){throw checkSession(a),showError("Error when retrieving replace price for rebateRuleModel_groupReductionBergbahn",a,b,c,!0),new Error("Error when retrieving replace price for rebateRuleModel_groupReductionBergbahn")}}).pipe(function(a){if(console.log("replace price: ",a),null!=a.price)return new bergbahnPriceModel(a);showError("Error when retrieving replace price for rebateRuleModel_groupReductionBergbahn")})},this.getTargetPrice=function(a,d,e,f,g,h,i,j,k,l){var m=b.partnerId();return console.log("getTargetPrice: ",a,d,e,f,g,h,i,j,k,l),$.ajax(serviceRootURL+"/bergbahnprice",{type:"GET",data:{categoryKey:l,consumerKey:e+"."+k,fromKey:f,toKey:g,viaKey:h,classKey:i,tripTypeKey:j,dateString:a,partnerId:m,provideOptionNames:b.isGroupReservation()},error:function(a,b,c){throw checkSession(a),showError("Error when retrieving target price for rebateRuleModel_groupReductionBergbahn",!0),new Error("Error when retrieving target price for rebateRuleModel_groupReductionBergbahn",a,b,c)}}).pipe(function(a){if(console.log("target price: ",a),null!=a.price)return c.push(a),new bergbahnPriceModel(a)})},this.getRuleValidationAmount=function(a){return b.isValidationProduct(a)?b.validationAmount():null},b.validateRequestOrder=function(a){for(var c=$.datepicker.parseDate(DATE_SERVER_FORMAT,b.validFrom()),d=$.datepicker.parseDate(DATE_SERVER_FORMAT,b.validTo()),e=new Array,f=!1,g=0;g<a.length;g++){var h=a[g],i=null;"function"==typeof h.price().tariffKey&&(i=h.price().tariffKey().split("_")),null!=i&&i.length>1?(i=i[1],b.isTriggerProduct(h)&&"FRE"!=i&&(f=!0)):null!=i&&1==i.length&&(f=!0)}if(!f)return!0;for(var g=0;g<a.length;g++){var h=a[g];if(b.isCategoryMemberOfRule(h)){var j=$.datepicker.parseDate(DATE_SERVER_FORMAT,h.price().date());c<=j&&j<=d&&b.isValidationProduct(h)&&b.addDayProductKeyAmount(e,h)}}for(var g=0;g<a.length;g++){var h=a[g];if(b.isCategoryMemberOfRule(h)&&b.isValidationTariff(h)){var k=b.getDayProductKeyAmount(e,h,b.validationAmount());if(null==k)return showInfo(i18n.t("rebateRule.groupReductionBergbahnRule.msg.validationError",{validationAmount:b.validationAmount(),date:h.price().date(),product:b.getProductName(h)})),!1;if(k[1]<b.validationAmount()){var l=k[2],m=k[5];return showInfo(i18n.t("rebateRule.groupReductionBergbahnRule.msg.validationError",{validationAmount:b.validationAmount(),date:l,product:m})),!1}}}return!0},b.validateReduction=function(a,c){for(var d=$.datepicker.parseDate(DATE_SERVER_FORMAT,b.validFrom()),e=$.datepicker.parseDate(DATE_SERVER_FORMAT,b.validTo()),f=new Array,g=0;g<a.length;g++){var h=a[g];if(b.isCategoryMemberOfRule(h)){var i=$.datepicker.parseDate(DATE_SERVER_FORMAT,h.date());d<=i&&i<=e&&b.isValidationOrderItem(h)&&b.addDayProductKeyAmountReduction(f,h)}}if(b.isValidationOrderItem(c)){var j=b.getDayProductKeyAmountReduction(f,c);if(console.log("dayProductKeyAmount",j),j.totalForwarded>=b.validationAmount()&&j.totalUsedUpdate<b.validationAmount())return showInfo(i18n.t("rebateRule.groupReductionBergbahnRule.msg.reductionValidationError",{triggerAmount:b.triggerAmount()})),!1}return!0}}function getRebateRuleInstance(a){return console.log("getRebateRuleInstance",a.type,a.name),a.type==RABATE_RULE_WEEKDAY_SKU_RULE?(console.log("weekdaySkuRule found"),new rebateRuleModel_weekdaySkuRule(a)):a.type==RABATE_RULE_GROUP_REDUCTION_BERGBAHN?(console.log("groupReductionBergbahn found"),new rebateRuleModel_groupReductionBergbahn(a)):void console.log("rebate rule type not supported:"+a.type)}function categoryViewModel(a){var b=this;b.categoryDisposed=ko.observable(!1),b.categoryModel=ko.observable(a),b.categoryKey=ko.observable(a.key().toUpperCase()),b.selectedCategory=categoriesVM.selectedCategory,b.selectedDate=ko.observable(),b.selectedDateInt=ko.observable(),b.selectedDateInput=ko.observable(),b.allowedDates=ko.observable(),b.validFrom=ko.observable(),b.validTo=ko.observable(),b.customDate=ko.observable(),b.todayActive=ko.observable(!0),b.tomorrowActive=ko.observable(!0),b.datepickerOptions={minDate:ko.observable(0),maxDate:ko.observable(null),beforeShowDay:ko.observable(null),onChangeMonthYear:ko.observable(null)},b.selectedProduct=ko.observable(),b.productAvailability=ko.observable(),b.productUseRestrictions=ko.observable(),b.seasonName=ko.observable(),b.datepickerSelection=function(){return $("#"+b.categoryModel().key()+"CustomDate")},b.handleCategorySpecificDateConfig=function(){},b.beforeShowDay=function(a){var c=jQuery.datepicker.formatDate("yy-mm-dd",a);if(shoppingcartVM.isPackageMode()){var d=menuVM.timeIntervalDays();return[-1!=$.inArray(c,d)]}if(b.allowedDates()){return[-1!=$.inArray(c,b.allowedDates())]}return[!0]},b.onChangeMonthYear=function(a,c,d){var e=moment({year:a,month:c-1,day:1}),f=e;f.isBefore(moment(b.datepickerOptions.minDate()))&&(f=moment(b.datepickerOptions.minDate())),null!=f&&(b.selectedDate($.datepicker.formatDate(DATE_SERVER_FORMAT,f.toDate())),b.selectedDateInput(b.selectedDate()),b.datepickerSelection().datepicker("setDate",f.toDate()))},b.adjustMinMaxDatesForPackageMode=function(){if(shoppingcartVM.isPackageMode()){b.todayActive(!1),b.tomorrowActive(!1);var a=menuVM.timeIntervalDays();if(a&&a.length>0){var c=$.datepicker.parseDate(DATE_SERVER_FORMAT,a[0]);b.datepickerOptions.minDate(c);var d=$.datepicker.parseDate(DATE_SERVER_FORMAT,a[a.length-1]);b.datepickerOptions.maxDate(d)}categoriesVM.hotelVM()&&categoriesVM.hotelVM().selectedArrivalDate.notifySubscribers()}},b.adjustDates=function(){console.log("adjustDates for product",b.selectedProduct(),b.validFrom(),b.validTo()),b.allowedDates(null),b.datepickerOptions.onChangeMonthYear(null);var a=moment(),c=moment().add(1,"days");if(b.validFrom()){var d=moment(b.validFrom());a.isBefore(d)?(b.datepickerOptions.minDate(d.toDate()),b.todayActive(!1)):(b.todayActive(!0),b.datepickerOptions.minDate(moment().toDate())),c.isBefore(d)?b.tomorrowActive(!1):b.tomorrowActive(!0)}else b.todayActive(!0),b.tomorrowActive(!0),b.datepickerOptions.minDate(moment().toDate());if(b.validTo()){var e=moment(b.validTo());b.datepickerOptions.maxDate(e.toDate()),e.isBefore(a)&&b.todayActive(!1),e.isBefore(c)&&b.tomorrowActive(!1)}else b.datepickerOptions.maxDate(null);if(b.productUseRestrictions()){var f=b.productAvailability(),g=[];$.each(f,function(a,b){$.each(b,function(b){0!==f[a][b]&&g.push(b)})}),b.allowedDates(g),b.todayActive(-1!=$.inArray(a.format(MOMENTJS_DATE_SERVER_FORMAT),b.allowedDates())),b.tomorrowActive(-1!=$.inArray(c.format(MOMENTJS_DATE_SERVER_FORMAT),b.allowedDates()))}b.adjustMinMaxDatesForPackageMode(),b.datepickerOptions.beforeShowDay(b.beforeShowDay),b.datepickerOptions.onChangeMonthYear(b.onChangeMonthYear),console.log("Datepicker configured min/max/today active/tomorrow active",b.datepickerOptions.minDate(),b.datepickerOptions.maxDate(),b.todayActive(),b.tomorrowActive()),b.handleCategorySpecificDateConfig(),b.todayActive()||b.tomorrowActive()||b.customDate(b.datepickerOptions.minDate())},b.selectAvailableDay=function(){null==b.selectedDateInt()&&(b.todayActive()?b.selectDate(0):b.tomorrowActive()&&b.selectDate(1))},b.setVisible=function(a){b.categoryModel().visible(a)},b.isDependingCategory=function(){return b.categoryModel().isDepending()};var c=function(){b.categoryModel().key().toUpperCase()!==CATEGORY_KEY_RAILWAY_SEAT_RESERVATION&&b.categoryModel().key().toUpperCase()!==CATEGORY_KEY_RAILWAY_SEAT_RESERVATION_TIMETABLE||shoppingcartVM.isPackageMode()||b.setShowTrainReservation&&b.setShowTrainReservation(!0)};b.resetTimeSelection=function(){},b.selectDate=function(a,d){b.datepickerSelection().val(""),b.selectedDateInput(null),b.resetTimeSelection();var e=new Date;e.setDate(e.getDate()+a),b.selectedDate($.datepicker.formatDate(DATE_SERVER_FORMAT,e)),(b.categoryModel().key().toUpperCase()!==CATEGORY_KEY_RAILWAY_SEAT_RESERVATION||b.categoryModel().key().toUpperCase()!==CATEGORY_KEY_RAILWAY_SEAT_RESERVATION_TIMETABLE||shoppingcartVM.isPackageMode())&&b.selectedDateInt(a),c(),"#tickets"!=location.hash&&b.setRoute(b.getSelectDateLocationHash())},b.getSelectDateLocationHash=function(a){if(console.log("getSelectDateLocationHash base",a),shoppingcartVM.isPackageMode());else if(console.log("getSelectDateLocationHash base shop",a),b.categoryModel().key().toUpperCase()===CATEGORY_KEY_RAILWAY_SEAT_RESERVATION||b.categoryModel().key().toUpperCase()===CATEGORY_KEY_RAILWAY_SEAT_RESERVATION_TIMETABLE)return"_train";if(!a)return"shop"},b.selectDateInput=function(a,d){var e=d.target.value,f=$.datepicker.formatDate(DATE_SERVER_FORMAT,new Date);try{if(""!=e){var g=$.datepicker.parseDate(DATE_PICKER_FORMAT,e);null!=b.allowedDates()&&b.allowedDates().length>0&&-1==$.inArray($.datepicker.formatDate(DATE_SERVER_FORMAT,g),b.allowedDates())?b.resetDate(b.allowedDates()[0]):null!=b.validFrom()&&moment(g).isBefore(moment(b.validFrom()))?b.resetDate(b.validFrom()):null!=b.validTo()&&moment(g).isAfter(moment(b.validTo()))?b.resetDate(null!=b.validFrom()?b.validFrom():f):moment(g).isBefore(moment(f))?b.resetDate(f):(b.selectedDate($.datepicker.formatDate(DATE_SERVER_FORMAT,g)),b.setRoute(b.getSelectDateLocationHash())),b.selectedDateInput()!=b.selectedDate()&&(b.selectedDateInput(b.selectedDate()),b.selectedDateInt(2)),c()}else b.selectedDateInput(null),console.log("selectedDateInput reset")}catch(a){console.error("Error selectDateInput",a),b.resetDate(f)}},b.resetDate=function(a){if(null!=a){var c=a.indexOf("T");-1!=c&&(a=a.substr(0,c))}b.selectedDate(a),b.datepickerSelection().val($.datepicker.formatDate(DATE_PICKER_FORMAT,$.datepicker.parseDate(DATE_SERVER_FORMAT,a)))},b.setSeasonInfo=function(a){if(null==a)return void b.seasonName("");a.crossSeason()?b.seasonName(i18n.t("seasonInfo.seasonchange",{startSeason:a.timeRangeName(),endSeason:a.timeRangeEndName()})):b.seasonName(a.timeRangeName())},b.selectTicket=function(a,c){b.setSeasonInfo(a.price())},b.addToCart=function(a,c){console.log("addToCart categories.js",a),null!=a.price()&&shoppingcartVM.addEntry(a.price(),c,b.categoryKey(),null,null)},b.adjustDates(),b.selectedProduct.subscribe(function(a){b.adjustDates()}),b.setRoute=function(a){0===location.hash.indexOf("#shop")&&(location.hash="shop_"+b.categoryKey().toLowerCase()+a)}}function abstractContingentViewModel(a){var b=this;b.loadingContingents=ko.observable(!0),categoryViewModel.apply(b,[a]),b.reservationInfoToday=ko.observable(),b.reservationInfoTomorrow=ko.observable(),b.reservationInfoDate=ko.observable(),b.availableContingents=ko.observableArray(),b.resetProductContingents=function(){},b.contingentInfoToday=ko.computed(function(){var a=$.datepicker.formatDate(DATE_SERVER_FORMAT,new Date),c=ko.utils.arrayFilter(b.availableContingents(),function(b){return $.datepicker.formatDate(DATE_SERVER_FORMAT,new Date(b.date()))===a});return!!c&&c[0]}),b.contingentInfoTomorrow=ko.computed(function(){var a=new Date;a.setDate(a.getDate()+1);var c=$.datepicker.formatDate(DATE_SERVER_FORMAT,a),d=($.datepicker.formatDate(DATE_SERVER_FORMAT,new Date),ko.utils.arrayFilter(b.availableContingents(),function(a){return $.datepicker.formatDate(DATE_SERVER_FORMAT,new Date(a.date()))===c}));return!!d&&d[0]}),b.contingentInfoDate=ko.computed(function(){if(!b.selectedDateInput())return!1;var a=ko.utils.arrayFilter(b.availableContingents(),function(a){return $.datepicker.formatDate(DATE_SERVER_FORMAT,new Date(a.date()))===b.selectedDateInput()});return!!a&&a[0]}),b.filterContingentsByDate=ko.computed(function(){if(b.selectedDate()){var a=$.datepicker.formatDate(DATE_SERVER_FORMAT,new Date),c=new Date;c.setDate(c.getDate()+1);var d=$.datepicker.formatDate(DATE_SERVER_FORMAT,c);return ko.utils.arrayFilter(b.availableContingents(),function(c){var e=$.datepicker.formatDate(DATE_SERVER_FORMAT,new Date(c.date()));return b.selectedDate()==b.selectedDateInput()?e===b.selectedDateInput():0==b.selectedDateInt()?e===a:1==b.selectedDateInt()&&e===d})}return[]}),b.getFirstAvailableDateOfMonth=function(a){var c=a;if(c.isBefore(moment(b.datepickerOptions.minDate()))&&(c=moment(b.datepickerOptions.minDate())),b.availableContingents()&&b.availableContingents().length>0){var d=ko.utils.arrayFirst(b.availableContingents(),function(b){return moment(b.date()).month()==a.month()&&(b.available()>0||null==b.available())});c=null!=d?moment(d.date()):null}return c},b.setDatePickerToFirstAvailableDateForMonth=function(a){var c=b.getFirstAvailableDateOfMonth(a);null!=c?(b.selectedDate($.datepicker.formatDate(DATE_SERVER_FORMAT,c.toDate())),b.selectedDateInput(b.selectedDate()),b.datepickerSelection().datepicker("setDate",c.toDate())):b.datepickerSelection().datepicker("setDate",a.toDate())},b.onChangeMonthYear=function(a,c,d){var e=moment({year:a,month:c-1,day:1}),f=!1;if(b.availableContingents().length>0){var g=moment(b.availableContingents()[b.availableContingents().length-1].date());e.isAfter(g)&&(f=!0)}else f=!0;if(f){var h=e.format(MOMENTJS_DATE_SERVER_FORMAT),i=moment(e).endOf("month").format(MOMENTJS_DATE_SERVER_FORMAT);if(b instanceof daytripsViewModel&&b.selectedBundle()){var j=b.loadContingentInfo(b.selectedBundle().key(),h,i);null!=j&&j.then(function(){b.setDatePickerToFirstAvailableDateForMonth(e)})}if((b instanceof localeventViewModel||b instanceof specialeventViewModel)&&b.selectedProduct()){var j=b.loadContingentInfo(b.selectedProduct().key(),h,i,!0);null!=j&&j.then(function(){b.setDatePickerToFirstAvailableDateForMonth(e)})}}else b.setDatePickerToFirstAvailableDateForMonth(e)},b.beforeShowDay=function(a){var c=jQuery.datepicker.formatDate("yy-mm-dd",a);if(shoppingcartVM.isPackageMode()){var d=menuVM.timeIntervalDays();return[-1!=$.inArray(c,d)]}if(b.availableContingents()&&b.availableContingents().length>0){var e=ko.utils.arrayFilter(b.availableContingents(),function(a){return $.datepicker.formatDate(DATE_SERVER_FORMAT,new Date(a.date()))==c&&(null==a.available()||a.available()>0)}),f=null!=e&&e.length>0;return[f]}if(b.allowedDates()){var f=-1!=$.inArray(c,b.allowedDates());return[f]}return[!0]},b.loadContingentInfo=function(a,c,d,e){if(b.selectedProduct()instanceof localEventModel&&0==b.selectedType())return null;c||(c=moment().format(MOMENTJS_DATE_SERVER_FORMAT),b.datepickerOptions.minDate()&&(console.log("loadContingentInfo",b,b.datepickerOptions.minDate()),moment(b.datepickerOptions.minDate()).isAfter(moment())&&(c=moment(b.datepickerOptions.minDate()).format(MOMENTJS_DATE_SERVER_FORMAT),b.todayActive()?c=moment(c).subtract("2","days").format(MOMENTJS_DATE_SERVER_FORMAT):b.tomorrowActive()&&(c=moment(c).subtract("1","days").format(MOMENTJS_DATE_SERVER_FORMAT))))),d||(d=moment(c).add(1,"month").endOf("month").format(MOMENTJS_DATE_SERVER_FORMAT),b.datepickerOptions.maxDate()&&moment(b.datepickerOptions.maxDate()).isBefore(moment(c).add(1,"month").endOf("month"))&&(d=moment(b.datepickerOptions.maxDate()).endOf("month").format(MOMENTJS_DATE_SERVER_FORMAT)),moment(d).isBefore(moment())&&(d=moment().format(MOMENTJS_DATE_SERVER_FORMAT)));var f=b.getOptionReference();return console.log("Loading contingents",a,c,d,f),b.loadingContingents(!0),$.getJSON(serviceRootURL+"/contingent_info",{categoryKey:b.categoryKey(),dateString:c+","+d,sku:a,optionReference:f,periodQuery:!0}).done(function(c){a==b.getSelectedProductKey()&&(console.log("Contingents loaded",c),b.mapContingents(c,b.availableContingents),e&&b.updateTicketContingents()),b.loadingContingents(!1)}).fail(function(){console.error("Failed to load contingents"),b.loadingContingents(!1)})},b.contingentAvailable=ko.computed(function(){if(b.selectedDate()==b.selectedDateInput()){if(0!=b.contingentInfoDate()&&b.contingentInfoDate())return b.contingentInfoDate().status()>0}else if(0==b.selectedDateInt()){if(0!=b.contingentInfoToday()&&b.contingentInfoToday())return b.contingentInfoToday().status()>0}else if(1==b.selectedDateInt()&&0!=b.contingentInfoTomorrow()&&b.contingentInfoTomorrow())return b.contingentInfoTomorrow().status()>0;return!0},b),b.mapContingents=function(a,b){if(null!=a&&a.length>0){var c=[];a.forEach(function(a){var d=ko.utils.arrayFilter(b(),function(b){return b.date()==a.date});null==d||0==d.length?c.push(new categoryContingentModel(a)):d.forEach(function(b){b.id()==a.id&&b.update(a)})}),c.length>0&&ko.utils.arrayPushAll(b,c)}},b.getOptionReference=function(){return b.selectedType().hasOwnProperty("key")?ko.isObservable(b.selectedType().key)?b.selectedType().key():b.selectedType().key:null},b.getSelectedProductKey=function(){return b.selectedProduct()&&b.selectedProduct().hasOwnProperty("key")?ko.isObservable(b.selectedProduct().key)?b.selectedProduct().key():b.selectedProduct().key:b.selectedProduct()},b.performLoadContingentInfoForSelectedDate=function(){if(null!=b.selectedDateInput()&&null!=b.selectedProduct()){console.log("performLoadContingentInfoForSelectedDate"),b.resetProductContingents();var a=b.getSelectedProductKey();b.loadingContingents(!0);var c=b.selectedType&&b.selectedType().hasOwnProperty("key")?b.selectedType().key():null;$.getJSON(serviceRootURL+"/contingent_info",{categoryKey:b.categoryKey(),dateString:b.selectedDateInput(),optionReference:c,sku:a}).done(function(a){b.mapContingents(a,b.availableContingents),b.loadingContingents(!1)}).fail(function(){console.log("contingent info not found for date "+b.selectedDate()),b.loadingContingents(!1)})}},this.reservationStatusToday=ko.computed(function(){if(null!=b.contingentInfoToday()&&0!=b.contingentInfoToday()){var a=b.contingentInfoToday();return b.reservationInfoToday(a.freeSeats()+"/"+a.contingent()),a.status()}return-1}),this.reservationStatusTomorrow=ko.computed(function(){return null!=b.contingentInfoTomorrow()&&0!=b.contingentInfoTomorrow()?(b.reservationInfoTomorrow(b.contingentInfoTomorrow().freeSeats()+"/"+b.contingentInfoTomorrow().contingent()),b.contingentInfoTomorrow().status()):-1}),this.reservationStatusDate=ko.computed(function(){return null!=b.contingentInfoDate()&&0!=b.contingentInfoDate()?(b.reservationInfoDate(b.contingentInfoDate().freeSeats()+"/"+b.contingentInfoDate().contingent()),b.contingentInfoDate().status()):-1}),b.onCloseCheckout=function(){null!=b.selectedProduct()&&(b.loadContingentInfo(b.getSelectedProductKey()),b.performLoadContingentInfoForSelectedDate())}}function filterBergbahnTickets(a){if(null!=categoriesVM.Cashdesk&&null!=categoriesVM.Cashdesk().bergbahnConsumerGroups()&&""!=categoriesVM.Cashdesk().bergbahnConsumerGroups()){var b=","+categoriesVM.Cashdesk().bergbahnConsumerGroups()+",",c=","+a.personKey()+",";return-1!=b.indexOf(c)}return!0}function bergbahnViewModel(a){var b=this;categoryViewModel.apply(b,[a]),b.selectedCategory=categoriesVM.selectedCategory,b.Froms=ko.observableArray([]),b.Tos=ko.observableArray([]),b.Vias=ko.observableArray([]),b.Types=ko.observableArray([]),b.Consumer=ko.observableArray([]),b.Tickets=ko.observableArray([]),b.PublicTransportationConsumer=ko.observableArray([]),b.PublicTransportationTickets=ko.observableArray([]),b.PublicTransportationVias=ko.observableArray([]),b.PublicTransportationViasLoading=ko.observable(!1),b.PublicTransportationFromLoading=ko.observable(!1),b.PublicTransportationToLoading=ko.observable(!1),b.Mode=ko.observable(BERGBAHN_MODE_BERGBAHN),b.fromFilter=ko.observable(),b.toFilter=ko.observable(),b.selectedFromOption=ko.observable(),b.selectedToOption=ko.observable(),b.selectedFrom=ko.observable(),b.selectedTo=ko.observable(),b.selectedVia=ko.observable(),b.selectedType=ko.observable(),b.vehicleModes=ko.observableArray([]),b.selectedVehicleMode=ko.observable(),b.vehicleModeSelectable=ko.observable(!1),b.ActiveFroms=ko.observableArray([]),b.ActiveTos=ko.observableArray([]),b.ActiveVias=ko.observableArray([]),b.loadingRailwayPrices=ko.observable(!1),this.fromFilterDelayed=ko.pureComputed(b.fromFilter).extend({rateLimit:{method:"notifyWhenChangesStop",timeout:1e3}}),this.toFilterDelayed=ko.pureComputed(b.toFilter).extend({rateLimit:{method:"notifyWhenChangesStop",timeout:1e3}}),b.Mode.subscribe(function(a){if(a==BERGBAHN_MODE_PUBLIC_TRANSPORTATION){var c=new Date,d=new Date(c.getFullYear(),c.getMonth()+2,c.getUTCDate());b.datepickerOptions.minDate(c),b.datepickerOptions.maxDate(d)}else b.datepickerOptions.minDate(null),b.datepickerOptions.maxDate(null)}),b.activeTickets=ko.computed(function(){return b.Mode()==BERGBAHN_MODE_BERGBAHN?ko.utils.arrayFilter(b.Tickets(),function(a){return null!=a.price()}):b.Mode()==BERGBAHN_MODE_PUBLIC_TRANSPORTATION&&null!=b.selectedVia()?ko.utils.arrayFilter(b.PublicTransportationTickets(),function(a){return null!=a.price()&&b.selectedVia().key()==a.price().viaKey()}):void 0}),b.resetFromFilter=function(){b.fromFilter("")},b.resetToFilter=function(){b.toFilter("")},b.FromValue=ko.pureComputed(function(){var a=null;return b.selectedFrom()&&(a=getOption(b.ActiveFroms(),b.selectedFrom())),a?(b.selectedFromOption(a),a.value()):(b.selectedFromOption(null),"")},this),b.ToValue=ko.pureComputed(function(){var a=null;return b.selectedFrom()&&(a=getOption(b.ActiveTos(),b.selectedTo())),a?(b.selectedToOption(a),a.value()):(b.selectedToOption(null),"")},this),b.ViaValue=ko.pureComputed(function(){if(0==b.ActiveVias().length)return'<span class="noroute">'+i18n.t("bergbahn.bergbahn-via-caption.noroute")+"</span>";if(b.selectedVia()){var a=getOption(b.ActiveVias(),b.selectedVia().key());return null!=a?a.displayName():""}},this),b.TypeValue=ko.pureComputed(function(){for(var a=0;a<b.Types().length;a++){var c=b.Types()[a];if(c.key()==b.selectedType())return c.tripTypeName()+", "+c.className()}return""},this),b.TypeObject=ko.pureComputed(function(){return ko.utils.arrayFirst(b.Types(),function(a){return a.key()===b.selectedType()})},this),b.loadOptionsForPartner=function(){var a=null!=touroperatorVM.selectedTouroperator()?touroperatorVM.selectedTouroperator().id():"";$.getJSON(serviceRootURL+"/options",{categoryKey:CATEGORY_KEY_BERGBAHN,optionListKey:"consumer",parentOptionListKey:"",parentOptionKey:"",partnerId:a}).done(function(a){var c=$.map(a,function(a){return new optionModel(a)}),d=$.map(a,function(a){var b=new consumerOptionModel(a);if(!b.hidden())return new ticketModelBergbahn(b,STATION_TYPE_BERGBAHN)}).filter(function(a){if(null!=categoriesVM.Cashdesk&&null!=categoriesVM.Cashdesk().bergbahnConsumerGroups()&&""!=categoriesVM.Cashdesk().bergbahnConsumerGroups()){var b=","+categoriesVM.Cashdesk().bergbahnConsumerGroups()+",",c=","+a.personKey()+",";return-1!=b.indexOf(c)}return!0});b.Consumer(c),b.Tickets(d)}).fail(function(a,b,c){checkSession(a),showError("Fehler beim Laden der Altersgruppen",a,b,c)}),$.getJSON(serviceRootURL+"/options",{categoryKey:CATEGORY_KEY_PUBLICTRANSPORTATION,optionListKey:"consumer",parentOptionListKey:"",parentOptionKey:"",partnerId:a}).done(function(a){var c=$.map(a,function(a){return new consumerOptionModel(a)});b.PublicTransportationConsumer(c)}).fail(function(a,b,c){checkSession(a),showError("Fehler beim Laden der ÖV Altersgruppen",a,b,c)}),$.getJSON(serviceRootURL+"/options",{categoryKey:CATEGORY_KEY_PUBLICTRANSPORTATION,optionListKey:"mode",parentOptionListKey:"",parentOptionKey:"",partnerId:a}).done(function(a){var c=$.map(a,function(a){return a});b.vehicleModes(c),c.length>1&&(b.selectedVehicleMode(c[0].key),b.vehicleModeSelectable(!0))}).fail(function(a,b,c){checkSession(a),showError("Fehler beim Laden der ÖV Fahrzeugtypen",a,b,c)}),$.getJSON(serviceRootURL+"/options",{categoryKey:CATEGORY_KEY_BERGBAHN,optionListKey:"from",parentOptionListKey:"",parentOptionKey:"",partnerId:a,sort:!0}).done(function(a){var c=$.map(a,function(a){return new stationOptionModel(a,STATION_TYPE_BERGBAHN)});b.Froms(c),b.Froms().length>0?b.selectedFrom(b.Froms()[0].key()):null!=categoriesVM.publictransportationVM()&&(categoriesVM.publictransportationVM().isDependingCategory()||b.setVisible(!0),b.Mode(BERGBAHN_MODE_PUBLIC_TRANSPORTATION))}).fail(function(a,b,c){checkSession(a),showError("Fehler beim Laden der VONs",a,b,c)}),$.getJSON(serviceRootURL+"/options",{categoryKey:CATEGORY_KEY_BERGBAHN,optionListKey:"to",parentOptionListKey:"",parentOptionKey:"",partnerId:a,sort:!0}).done(function(a){var c=$.map(a,function(a){return new stationOptionModel(a,STATION_TYPE_BERGBAHN)});b.Tos(c),b.Tos().length>0&&b.selectedTo(b.Tos()[0].key())}).fail(function(a,b,c){checkSession(a),showError("Fehler beim Laden der NACHs",a,b,c)}),$.getJSON(serviceRootURL+"/options",{categoryKey:CATEGORY_KEY_BERGBAHN,optionListKey:"via",parentOptionListKey:"",parentOptionKey:"",partnerId:a,sort:!0}).done(function(a){var c=$.map(a,function(a){return new bergbahnViaOptionModel(a)});b.Vias(c)}).fail(function(a,b,c){checkSession(a),showError("Fehler beim Laden der Vias",a,b,c)})},b.loadOptionsForPartner(),b.selectVehicleMode=function(a,c){null!=a&&b.selectedVehicleMode(a.key)},b.selectFrom=function(a,c){null!=a&&(b.selectedFrom(a.key()),b.setRoute("_destination"))},b.selectTo=function(a,c){b.selectedTo(a.key()),b.setRoute("_via")},b.selectVia=function(a,c){b.selectedVia(a),console.log("selectedVia",a),b.setRoute("_type")},b.selectType=function(a,c){b.selectedType(a.key()),b.setRoute("_date"),b.selectAvailableDay()},b.isActiveFromAvailable=function(){return null!=ko.utils.arrayFirst(b.ActiveFroms(),function(a){return a.key()==b.selectedFrom()})},b.loadActiveFroms=ko.computed(function(){if(null!=b.fromFilterDelayed()&&b.fromFilterDelayed().length>0){var a=ko.utils.arrayFilter(b.Froms(),function(a){return-1!=a.value().toLowerCase().indexOf(b.fromFilterDelayed().toLowerCase())});if(shoppingcartVM.isPackageMode())b.ActiveFroms(a);else{b.PublicTransportationFromLoading(!0);var c=null!=touroperatorVM.selectedTouroperator()?touroperatorVM.selectedTouroperator().id():"",d=null!=b.selectedVehicleMode()?b.selectedVehicleMode():"";$.getJSON(serviceRootURL+"/optionsrailwaystations",{term:b.fromFilterDelayed(),mode:d,partnerId:c}).done(function(c){var d=$.map(c,function(b){if(console.log("External station",b),null==ko.utils.arrayFirst(a,function(a){return a.value()==b.localizedValue}))return new stationOptionModel(b,STATION_TYPE_PUBLICTRANSPORTATION)});b.ActiveFroms(a.concat(d)),b.ActiveFroms().length>0?b.isActiveFromAvailable()||b.selectedFrom(b.ActiveFroms()[0].key()):b.selectedFrom(null),b.selectedDate()||b.selectedDate($.datepicker.formatDate(DATE_SERVER_FORMAT,new Date)),b.PublicTransportationFromLoading(!1)}).fail(function(a,c,d){checkSession(a),showError("Fehler beim Laden der Typen",a,c,d),b.PublicTransportationFromLoading(!1)})}}else b.ActiveFroms(b.Froms()),b.ActiveFroms().length>0?b.isActiveFromAvailable()||b.selectedFrom(b.ActiveFroms()[0].key()):b.selectedFrom(null)}),b.isActiveToAvailable=function(){return null!=ko.utils.arrayFirst(b.ActiveTos(),function(a){return a.key()==b.selectedTo()})},b.loadActiveTos=ko.computed(function(){var a=null;if(null!=b.toFilterDelayed()&&b.toFilterDelayed().length>0){if(null!=b.selectedFrom()&&null!=b.selectedFromOption()&&b.selectedFromOption().stationType()==STATION_TYPE_BERGBAHN&&null!=b.Tos()&&b.Tos().length>0&&null!=b.Vias()&&b.Vias().length>0){var c=ko.utils.arrayFilter(b.Vias(),function(a){return a.fromKey()==b.selectedFrom()});a=ko.utils.arrayFilter(b.Tos(),function(a){return-1!=a.value().toLowerCase().indexOf(b.toFilterDelayed().toLowerCase())&&null!=ko.utils.arrayFirst(c,function(b){return b.toKey()==a.key()})})}else a=ko.utils.arrayFilter(b.Tos(),function(a){return-1!=a.value().toLowerCase().indexOf(b.toFilterDelayed().toLowerCase())});if(shoppingcartVM.isPackageMode())b.ActiveTos(a);else{var d=null!=touroperatorVM.selectedTouroperator()?touroperatorVM.selectedTouroperator().id():"",e=null!=b.selectedVehicleMode()?b.selectedVehicleMode():"";b.PublicTransportationToLoading(!0),$.getJSON(serviceRootURL+"/optionsrailwaystations",{term:b.toFilterDelayed(),mode:e,partnerId:d}).done(function(c){var d=$.map(c,function(b){if(console.log("External station to:",b),null==ko.utils.arrayFirst(a,function(a){return a.value()==b.localizedValue}))return new stationOptionModel(b,STATION_TYPE_PUBLICTRANSPORTATION)});b.ActiveTos(a.concat(d)),b.ActiveTos().length>0?b.isActiveToAvailable()||b.selectedTo(b.ActiveTos()[0].key()):b.selectedTo(null),b.selectedDate()||b.selectedDate($.datepicker.formatDate(DATE_SERVER_FORMAT,new Date)),b.PublicTransportationToLoading(!1)}).fail(function(a,c,d){checkSession(a),showError("Fehler beim Laden der Stationen",a,c,d),b.PublicTransportationToLoading(!1)})}}else{if(null!=b.selectedFrom()&&null!=b.selectedFromOption()&&b.selectedFromOption().stationType()==STATION_TYPE_BERGBAHN&&null!=b.Tos()&&b.Tos().length>0&&null!=b.Vias()&&b.Vias().length>0){var c=ko.utils.arrayFilter(b.Vias(),function(a){return a.fromKey()==b.selectedFrom()});a=ko.utils.arrayFilter(b.Tos(),function(a){return null!=ko.utils.arrayFirst(c,function(b){return b.toKey()==a.key()})})}else a=b.Tos();b.ActiveTos(a),b.ActiveTos().length>0?b.isActiveToAvailable()||b.selectedTo(b.ActiveTos()[0].key()):b.selectedTo(null)}}).extend({deferred:!0}),b.isActiveViaAvailable=function(){if(b.selectedVia())var a=ko.utils.arrayFirst(b.ActiveVias(),function(a){return a.key()==b.selectedVia().key()});return null!=a},b.loadActiveVias=ko.computed(function(){var a=new Array;null!=b.selectedFromOption()&&null!=b.selectedToOption()?b.selectedFromOption().stationType()==STATION_TYPE_BERGBAHN&&b.selectedToOption().stationType()==STATION_TYPE_BERGBAHN?(a=ko.utils.arrayFilter(b.Vias(),function(a){return a.fromKey()==b.selectedFrom()&&a.toKey()==b.selectedTo()}),b.ActiveVias(a),!b.isActiveViaAvailable()&&b.ActiveVias().length>0&&b.selectedVia(b.ActiveVias()[0])):(b.ActiveVias(b.PublicTransportationVias()),!b.isActiveViaAvailable()&&b.ActiveVias().length>0&&b.selectedVia(b.ActiveVias()[0])):b.ActiveVias.removeAll()}),b.isActiveTypeAvailable=function(){return null!=ko.utils.arrayFirst(b.Types(),function(a){return a.key()==b.selectedType()})},b.activeTypes=ko.computed(function(){if(null==b.selectedFromOption()||null==b.selectedToOption()||b.selectedFromOption().stationType()!=STATION_TYPE_PUBLICTRANSPORTATION&&b.selectedToOption().stationType()!=STATION_TYPE_PUBLICTRANSPORTATION){if(null!=b.selectedFrom()&&null!=b.selectedTo()&&null!=b.selectedVia()){var a=null!=touroperatorVM.selectedTouroperator()?touroperatorVM.selectedTouroperator().id():"",c=b.selectedVia().key();$.ajax(serviceRootURL+"/optionsbergbahntypes",{type:"GET",data:{fromKey:b.selectedFrom(),toKey:b.selectedTo(),viaKey:c,partnerId:a},dataType:"json",contentType:"application/json",context:{fromKey:b.selectedFrom(),toKey:b.selectedTo(),viaKey:c},success:function(a,d,e){if(this.fromKey==b.selectedFrom()&&this.toKey==b.selectedTo()&&this.viaKey==c){var f=$.map(a,function(a){return new bergbahnTypeOptionModel(a)});b.Types(f),!b.isActiveTypeAvailable()&&b.Types().length>0&&b.selectType(b.Types()[0])}else console.log("route has changed in the meantime")},error:function(a,b,c){checkSession(a),showError("Fehler beim Laden der Typen",a,b,c)}})}}else{
var a=null!=touroperatorVM.selectedTouroperator()?touroperatorVM.selectedTouroperator().id():"";$.ajax(serviceRootURL+"/options",{type:"GET",data:{categoryKey:CATEGORY_KEY_PUBLICTRANSPORTATION,optionListKey:"type",parentOptionListKey:"",parentOptionKey:"",partnerId:a},dataType:"json",contentType:"application/json",success:function(a,c,d){var e=$.map(a,function(a){return new bergbahnTypeOptionModel(a)});b.Types(e),!b.isActiveTypeAvailable()&&b.Types().length>0&&b.selectType(b.Types()[0])},error:function(a,b,c){checkSession(a),showError("Fehler beim Laden der Typen",a,b,c)}})}}).extend({throttle:10}),b.dynamicViaCaption=ko.computed(function(){return 1==b.ActiveVias().length?null:b.ActiveVias().length>1?i18n.t("bergbahn.bergbahn-via-caption.select"):i18n.t("bergbahn.bergbahn-via-caption.noroute")}),b.checkRouteForEprDaytrips=function(a,b,c,d,e,f){return categoriesVM.daytripsVM()?categoriesVM.daytripsVM().getEprDaytrips(a,b,c,d,e,f):[]},b.price=ko.computed({disposeWhen:function(){return b.categoryDisposed()},read:function(){if(null!=b.selectedFromOption()&&null!=b.selectedToOption()&&b.selectedType()&&b.TypeObject()&&b.selectedDate())if(b.selectedFromOption().stationType()==STATION_TYPE_BERGBAHN&&b.selectedToOption().stationType()==STATION_TYPE_BERGBAHN){if(b.Mode(BERGBAHN_MODE_BERGBAHN),b.selectedVia()){console.log("computing bergbahn prices for all consumers..."),b.setSeasonInfo(null);var a=b.selectedVia().key(),c=b.TypeObject(),d=null!=touroperatorVM.selectedTouroperator()?touroperatorVM.selectedTouroperator().id():"",e=b.checkRouteForEprDaytrips(b.selectedFrom(),b.selectedTo(),a,c.tripTypeKey(),c.classKey(),b.selectedDate());b.loadingRailwayPrices(!0),$.ajax(serviceRootURL+"/bergbahnprices",{type:"GET",data:{categoryKey:CATEGORY_KEY_BERGBAHN,fromKey:b.selectedFrom(),toKey:b.selectedTo(),viaKey:a,classKey:c.classKey(),tripTypeKey:c.tripTypeKey(),dateString:b.selectedDate(),partnerId:d},dataType:"json",contentType:"application/json",success:function(c,d,f){console.log("Bergbahn prices received",c);for(var g=b.TypeObject(),h=0;h<b.Tickets().length;h++){var i=b.Tickets()[h],j=!1;c&&c.forEach(function(c){if(i.consumer().key()==c.consumerKey){var d=new bergbahnPriceModel(c);if(g&&d.fromKey()==b.selectedFrom()&&d.toKey()==b.selectedTo()&&d.viaKey()==a&&d.classKey()==g.classKey()&&d.tripTypeKey()==g.tripTypeKey()&&d.date()==b.selectedDate()){i.eprDaytripReference(null);for(var f=0;f<e.length;f++){var h=e[f];null!=h&&categoriesVM.daytripsVM()&&categoriesVM.daytripsVM().getDaytripTicketPrice(i,h.key(),d.date(),d.fromKey(),"",d.toKey(),"",d.viaKey(),"",d.classKey(),"",d.tripTypeKey(),"",function(a,b){b.eprDaytripReference(a)},!0)}i.price(d),j=!0}}}),j||(i.price(null),i.eprDaytripReference(null))}b.loadingRailwayPrices(!1)},error:function(a,c,d){b.loadingRailwayPrices(!1),500==a.status?(console.log("Error during retrieving price"),showError("Fehler bei Preisermittlung",a,c,d,!0)):console.log("Bergbahn price not found: "+a.responseText);for(var e=0;e<b.Tickets().length;e++){var f=b.Tickets()[e];f.price(null),f.eprDaytripReference(null)}checkSession(a)}})}}else console.log("computing prices for all consumers..."),b.setSeasonInfo(null),b.Mode(BERGBAHN_MODE_PUBLIC_TRANSPORTATION);else{b.Mode()&&b.Mode()==BERGBAHN_MODE_PUBLIC_TRANSPORTATION&&(b.PublicTransportationTickets.removeAll(),b.PublicTransportationVias.removeAll()),b.Mode(BERGBAHN_MODE_BERGBAHN);for(var f=0;f<b.Tickets().length;f++)b.Tickets()[f].price(null)}}},b).extend({throttle:50}),b.resetTicketPrices=function(){for(var a=0;a<b.Tickets().length;a++){b.Tickets()[a].price(null)}},b.computePublicTransportationPrice=ko.computed(function(){if(b.Mode()&&b.Mode()==BERGBAHN_MODE_PUBLIC_TRANSPORTATION&&null!=b.selectedFrom()&&null!=b.selectedTo()&&b.selectedType()&&b.TypeObject()&&b.selectedDate()){b.PublicTransportationTickets.removeAll(),b.PublicTransportationVias.removeAll(),b.PublicTransportationViasLoading(!0);var a=b.TypeObject(),c=null!=touroperatorVM.selectedTouroperator()?touroperatorVM.selectedTouroperator().id():"";$.ajax(serviceRootURL+"/publictransportationprices",{type:"GET",data:{categoryKey:CATEGORY_KEY_PUBLICTRANSPORTATION,fromKey:b.selectedFrom(),toKey:b.selectedTo(),classKey:a.classKey(),tripTypeKey:a.tripTypeKey(),dateString:b.selectedDate(),partnerId:c},dataType:"json",contentType:"application/json",context:{selectedFrom:b.selectedFrom(),selectedTo:b.selectedTo(),selectedClassKey:a.classKey(),selectedTripTypeKey:a.tripTypeKey(),selectedDate:b.selectedDate()},success:function(a,c,d){var e=b.TypeObject();if(this.selectedFrom==b.selectedFrom()&&this.selectedTo==b.selectedTo()&&this.selectedClassKey==e.classKey()&&this.selectedTripTypeKey==e.tripTypeKey()&&this.selectedDate==b.selectedDate()){var f=new Array,g=new Array;if(null!=a&&a.length>0)for(var h=0;h<a.length;h++){price=new publicTransportationPriceModel(a[h]);var i=ko.utils.arrayFirst(b.PublicTransportationConsumer(),function(a){return a.key()===price.consumerKey()});if(null!=i){console.log("price for consumer group "+i.key()+" and via "+price.viaKey()+" found: data.price="+price);var j=new ticketModelBergbahn(i,STATION_TYPE_PUBLICTRANSPORTATION);j.price(price),f.push(j),b.setSeasonInfo(price);var k=ko.utils.arrayFirst(g,function(a){return a.key()===price.viaKey()});if(null==k){var l=new bergbahnViaOptionModel({id:0,key:price.viaKey(),localizedValue:price.viaKey()});g.push(l)}}}b.PublicTransportationTickets(f),b.PublicTransportationVias(g),b.PublicTransportationViasLoading(!1)}else console.log("Public transportation prices not found: "+d.responseText)},error:function(a,c,d){b.PublicTransportationViasLoading(!1),500==a.status?(console.log("Error during retrieving price"),showError("Fehler bei Preisermittlung",a,c,d,!0)):console.log("Price not found: "+a.responseText),checkSession(a),b.PublicTransportationTickets.removeAll(),b.PublicTransportationVias.removeAll()}})}},b).extend({notify:"notifyWhenChangesStop",rateLimit:200}),b.addToCart=function(a,b){console.log("addingToCart",a);for(var c={},d=0;d<shoppingcartVM.entries().length;d++){var e=shoppingcartVM.entries()[d],f=e.price().productKey();null==c[f]&&(c[f]=[]),c[f].push(e)}var g=!0;if(Object.keys(c).forEach(function(a){var b=c[a],d=0;maxAmount=0;for(var e=0;e<b.length;e++){var f=b[e],h=kp.get(f,"categoryKey"),i=kp.get(f,"price.sku");h==CATEGORY_KEY_PUBLICTRANSPORTATION&&i&&(d+=f.quantity(),maxAmount=PUBLIC_TRANSPORTATION_LIMIT)}if(d>0&&null!=maxAmount&&d>=maxAmount)return showInfo(i18n.t("cart.msg.maxValidationErrorInfoPT",{maxAmount:maxAmount})),g=!1,!1}),1==g){shoppingcartVM.addEntry(a.price(),b,a.stationType()==STATION_TYPE_BERGBAHN?CATEGORY_KEY_BERGBAHN:CATEGORY_KEY_PUBLICTRANSPORTATION,null,!0);a.price().bergbahnAddOn&&a.price().bergbahnAddOn()&&shoppingcartVM.addEntry(a.price().bergbahnAddOn(),b,CATEGORY_KEY_BERGBAHN,null,!0)}},b.addToCartWithEpr=function(a,b){a.eprDaytripReference().bundleItems().forEach(function(a){a.price()instanceof eprAddonPriceModel&&a.price().selectable(!0)});var c=shoppingcartVM.addEntry(a.eprDaytripReference(),b,CATEGORY_KEY_BUNDLE,null,null);console.log("added daytrip to cart",a.eprDaytripReference(),c)},b.getSelectDateLocationHash=function(){return"_persons"}}function busViewModel(a){var b=this;categoryViewModel.apply(b,[a]),b.selectedCategory=categoriesVM.selectedCategory;b.Bundle=ko.observable(),b.BusesUp=ko.observableArray([]),b.BusesDown=ko.observableArray([]),b.AddOns=ko.observableArray([]),b.Tickets=ko.observableArray([]),b.Consumer=ko.observableArray([]),b.ContingentInfoBusUp=ko.observableArray([]),b.ContingentInfoBusDown=ko.observableArray([]),b.selectedUpDate=ko.observable(),b.selectedUpDateInt=ko.observable(),b.selectedBusUp=ko.observable(),b.selectedDownDate=ko.observable(),b.selectedDownDateInt=ko.observable(),b.selectedBusDown=ko.observable(),b.selectedAddOn=ko.observable(),b.BusUpOption=ko.pureComputed(function(){return null!=b.selectedBusUp()?getOption(b.BusesUp(),b.selectedBusUp()):null},this),b.BusDownOption=ko.pureComputed(function(){return null!=b.selectedBusDown()?getOption(b.BusesDown(),b.selectedBusDown()):null},this),b.AddOnOption=ko.pureComputed(function(){return null!=b.selectedAddOn()?getOption(b.AddOns(),b.selectedAddOn()):null},this),b.BusUpValue=ko.pureComputed(function(){return null!=b.BusUpOption()&&b.BusUpOption().available()?b.BusUpOption().displayValue():""},this),b.BusDownValue=ko.pureComputed(function(){return null!=b.BusDownOption()&&b.BusDownOption().available()?b.BusDownOption().displayValue():""},this),b.AddOnValue=ko.pureComputed(function(){return null!=b.AddOnOption()?b.AddOnOption().categoryName():""},this),b.BusUpAvailable=ko.pureComputed(function(){return null!=b.BusUpOption()&&b.BusUpOption().available()},this),b.BusDownAvailable=ko.pureComputed(function(){return null!=b.BusDownOption()&&b.BusDownOption().available()},this),b.selectUpDate=function(a){$("#busUpCustomDate").val("");var c=new Date;if(c.setDate(c.getDate()+a),b.selectedUpDate($.datepicker.formatDate(DATE_SERVER_FORMAT,c)),b.selectedUpDateInt(a),b.selectedDownDate()){var d=$.datepicker.parseDate(DATE_SERVER_FORMAT,b.selectedDownDate());1==b.selectedUpDateInt()&&moment(d)<moment(c)&&(b.selectedDownDate(b.selectedUpDate()),b.selectedDownDateInt(b.selectedUpDateInt()),$("#busDownCustomDate").val(""))}"#tickets"!=location.hash&&(location.hash=b.getSelectUpDateLocationHash())},b.getSelectUpDateLocationHash=function(a){return"shop_"+b.categoryModel().key()+"_busup"},b.selectUpDateInput=function(a,c){var d=c.target.value,e=$.datepicker.formatDate(DATE_SERVER_FORMAT,new Date);try{if(""!=d){var f=$.datepicker.parseDate(DATE_PICKER_FORMAT,d);if(moment(f)<moment(e))b.resetDate(e);else{b.selectedUpDate($.datepicker.formatDate(DATE_SERVER_FORMAT,f));var g=$.datepicker.parseDate(DATE_SERVER_FORMAT,b.selectedDownDate());moment(g)<moment(f)&&(b.selectedDownDate(b.selectedUpDate()),b.selectedDownDateInt(null),$("#busDownCustomDate").val($.datepicker.formatDate(DATE_PICKER_FORMAT,f))),location.hash="shop_"+b.categoryModel().key()+"_busup"}}}catch(a){b.resetUpDate(e)}},b.resetUpDate=function(a){b.selectedUpDate(a);var c=$.datepicker.parseDate(DATE_SERVER_FORMAT,a);$("#busUpCustomDate").val($.datepicker.formatDate(DATE_PICKER_FORMAT,c))},b.selectDownDate=function(a){$("#busDownCustomDate").val("");var c=new Date;c.setDate(c.getDate()+a),b.selectedDownDate($.datepicker.formatDate(DATE_SERVER_FORMAT,c)),b.selectedDownDateInt(a),"#tickets"!=location.hash&&(location.hash=b.getSelectDownDateLocationHash())},b.todayDownDisabled=ko.computed(function(){var a=new Date;return moment(b.selectedUpDate())>moment(a)},b),b.tomorrowDownDisabled=ko.computed(function(){var a=new Date;return a.setDate(a.getDate()+1),moment(b.selectedUpDate())>moment(a)},b),b.getSelectDownDateLocationHash=function(a){return"shop_"+b.categoryModel().key()+"_busdown"},b.selectDownDateInput=function(a,c){var d=c.target.value,e=$.datepicker.formatDate(DATE_SERVER_FORMAT,new Date);try{if(""!=d){var f=$.datepicker.parseDate(DATE_PICKER_FORMAT,d),g=$.datepicker.parseDate(DATE_SERVER_FORMAT,b.selectedUpDate());moment(f)<moment(g)?(b.selectedDownDate(b.selectedUpDate()),b.selectedDownDateInt(null),$("#busDownCustomDate").val($.datepicker.formatDate(DATE_PICKER_FORMAT,g))):moment(f)<moment(e)?b.resetDownDate(e):(b.selectedDownDate($.datepicker.formatDate(DATE_SERVER_FORMAT,f)),location.hash="shop_"+b.categoryModel().key()+"_busdown")}}catch(a){b.resetDownDate(e)}},b.resetDownDate=function(a){b.selectedDownDate(a);var c=$.datepicker.parseDate(DATE_SERVER_FORMAT,a);$("#busDownCustomDate").val($.datepicker.formatDate(DATE_PICKER_FORMAT,c))},b.selectUpDate(0),b.selectDownDate(0),b.selectBusUp=function(a,c){b.selectedBusUp(null!=a?a.key():null),location.hash="shop_bus_downdate"},b.disableBusUp=function(a){var c=a.deptime().split(":"),d=moment(b.selectedUpDate()).startOf("day");return d.hour(c[0]),d.minutes(c[1]),d<moment()?a.disabled(!0):a.disabled(!1),a.disabled()},b.selectBusDown=function(a,c){b.selectedBusDown(null!=a?a.key():null),location.hash="shop_bus_addon"},b.disableBusDown=function(a){var c=null;c=null!=a.deptime()?a.deptime().split(":"):a.arrtime().split(":");var d=moment(b.selectedDownDate()).startOf("day");return d.hour(c[0]),d.minutes(c[1]),d<moment()?a.disabled(!0):a.disabled(!1),a.disabled()},b.selectAddOn=function(a,c){b.selectedAddOn(null!=a?a.key():null),location.hash="shop_bus_persons"},b.loadOptions=function(){$.getJSON(serviceRootURL+"/options",{categoryKey:CATEGORY_KEY_BUS,optionListKey:"bundle",parentOptionListKey:"",parentOptionKey:""}).done(function(a){var c=$.map(a,function(a){return new optionModel(a)});c.length>0&&b.Bundle(c[0])}).fail(function(a,b,c){checkSession(a),showError("Fehler beim Laden der Hinreise-Optionen",a,b,c)}),$.getJSON(serviceRootURL+"/options",{categoryKey:CATEGORY_KEY_BUS,optionListKey:"consumer",parentOptionListKey:"",parentOptionKey:""}).done(function(a){var c=$.map(a,function(a){return new optionModel(a)}),d=$.map(a,function(a){var b=new consumerOptionModel(a);if(!b.hidden())return new ticketModelBergbahnEpr(b)}).filter(function(a){return filterBergbahnTickets(a)});b.Consumer(c),b.Tickets(d)}).fail(function(a,b,c){checkSession(a),showError("Fehler beim Laden der Altersgruppen",a,b,c)}),$.getJSON(serviceRootURL+"/options",{categoryKey:CATEGORY_KEY_BUS,optionListKey:"busesUp",parentOptionListKey:"",parentOptionKey:""}).done(function(a){var c=$.map(a,function(a){return new busOptionModel(a)}).sort(function(a,b){var c=a.deptime().replace(":",""),d=b.deptime().replace(":","");return parseInt(c)>parseInt(d)?1:-1});b.BusesUp(c),b.BusesUp().length>0&&b.selectedBusUp(b.BusesUp()[0].key())}).fail(function(a,b,c){checkSession(a),showError("Fehler beim Laden der Hinreise-Optionen",a,b,c)}),$.getJSON(serviceRootURL+"/options",{categoryKey:CATEGORY_KEY_BUS,optionListKey:"busesDown",parentOptionListKey:"",parentOptionKey:""}).done(function(a){var c=$.map(a,function(a){return new busOptionModel(a)}).sort(function(a,b){var c=a.arrtime().replace(":",""),d=b.arrtime().replace(":","");return parseInt(c)<parseInt(d)?1:-1});b.BusesDown(c),b.BusesDown().length>0&&b.selectedBusDown(b.BusesDown()[0].key())}).fail(function(a,b,c){checkSession(a),showError("Fehler beim Laden der Rückreise-Optionen",a,b,c)}),$.getJSON(serviceRootURL+"/options",{categoryKey:CATEGORY_KEY_BUS,optionListKey:"addOns",parentOptionListKey:"",parentOptionKey:""}).done(function(a){var c=$.map(a,function(a){return getAddOnOptionModelInstance(a)});b.AddOns(c),b.AddOns().length>0&&b.selectedAddOn(b.AddOns()[0].key())}).fail(function(a,b,c){checkSession(a),showError("Fehler beim Laden der AddOn-Optionen",a,b,c)})},b.loadOptions(),b.loadContingentInfoBusUp=ko.computed(function(){null!=b.selectedUpDate()?(b.ContingentInfoBusUp.removeAll(),$.getJSON(serviceRootURL+"/contingent_info",{categoryKey:CATEGORY_KEY_BUS,dateString:b.selectedUpDate(),direction:BERGBAHN_EPR_VIA_PREFIX_UP}).done(function(a){var c=$.map(a,function(a){return new categoryContingentModel(a)});b.ContingentInfoBusUp(c)}).fail(function(){console.log("bus up contingent info not found for date "+b.selectedDate())})):b.ContingentInfoBusUp.removeAll()},b),b.loadContingentInfoBusDown=ko.computed(function(){null!=b.selectedDownDate()?(b.ContingentInfoBusDown.removeAll(),$.getJSON(serviceRootURL+"/contingent_info",{categoryKey:CATEGORY_KEY_BUS,dateString:b.selectedDownDate(),direction:BERGBAHN_EPR_VIA_PREFIX_DOWN}).done(function(a){var c=$.map(a,function(a){return new categoryContingentModel(a)});b.ContingentInfoBusDown(c)}).fail(function(){console.log("bus down contingent info not found for date "+b.selectedDate())})):b.ContingentInfoBusDown.removeAll()},b),b.price=ko.computed({disposeWhen:function(){return b.categoryDisposed()},read:function(){if(b.selectedUpDate()&&b.selectedBusUp()&&b.selectedDownDate()&&b.selectedBusDown()){console.log("computing prices for all consumers..."),b.setSeasonInfo(null);for(var a=0;a<b.Tickets().length;a++)if(null!=b.selectedBusUp()&&b.BusUpAvailable()&&null!=b.selectedBusDown()&&b.BusDownAvailable()){var c={productKey:b.Bundle().key(),dateString:b.selectedUpDate(),consumerKey:b.Tickets()[a].consumer().key(),bundleItems:[{categoryKey:CATEGORY_KEY_BUS,consumerKey:b.Tickets()[a].consumer().key(),fromKey:b.BusUpOption().from(),toKey:b.BusUpOption().to(),viaKey:b.selectedBusUp(),classKey:"2",tripTypeKey:"O",dateString:b.selectedUpDate(),isAddOn:!1},{categoryKey:CATEGORY_KEY_BUS,consumerKey:b.Tickets()[a].consumer().key(),fromKey:b.BusDownOption().from(),toKey:b.BusDownOption().to(),viaKey:b.selectedBusDown(),classKey:"2",tripTypeKey:"O",dateString:b.selectedDownDate(),isAddOn:!1}]},d=null;if(b.AddOnOption().categoryKey()==CATEGORY_KEY_BERGBAHN)d={categoryKey:CATEGORY_KEY_BERGBAHN,fromKey:b.AddOnOption().fromKey(),toKey:b.AddOnOption().toKey(),viaKey:b.AddOnOption().viaKey(),classKey:b.AddOnOption().classKey(),tripTypeKey:b.AddOnOption().tripTypeKey(),consumerKey:b.AddOnOption().getConsumerMapping(b.Tickets()[a].consumer().key(),b.BusUpOption().from(),b.BusDownOption().from()),dateString:b.selectedUpDate(),isAddOn:!0},c.bundleItems.push(d);else if(b.AddOnOption().categoryKey()==CATEGORY_KEY_SKIPASS){var e=b.AddOnOption().getConsumerMappingKeys(b.Tickets()[a].consumer().key(),b.BusUpOption().from(),b.BusDownOption().from());d={categoryKey:CATEGORY_KEY_SKIPASS,reductionLevel:e[1],regionKey:b.AddOnOption().regionKey(),durationKey:b.AddOnOption().durationKey(),consumerKey:e[0],dateString:b.selectedUpDate(),isAddOn:!0},c.bundleItems.push(d)}$.ajax(serviceRootURL+"/bundleprice",{type:"POST",data:JSON.stringify(c),dataType:"json",contentType:"application/json",context:{ticket:b.Tickets()[a]},success:function(a,c,d){if(console.log("bus up price for consumer group "+this.ticket.consumer().key()+" found: data.price="+a.price),null!=a.price){if(price=new bundlePriceModel(a,b.Bundle()),null!=a.bundleItems&&3==a.bundleItems.length){var e=getPriceBundleItemInstance(a.bundleItems[0]),f=getPriceBundleItemInstance(a.bundleItems[1]),g=getPriceBundleItemInstance(a.bundleItems[2],b.AddOnOption());price.bundleItems().push(e),price.bundleItems().push(f),price.bundleItems().push(g),e.price().viaKey()==b.selectedBusUp()&&e.price().date()==b.selectedUpDate()&&f.price().viaKey()==b.selectedBusDown()&&f.price().date()==b.selectedDownDate()&&g.price().categoryKey()==b.AddOnOption().categoryKey()&&(this.ticket.price(price),b.setSeasonInfo(e.price()))}}else console.log("Bundle price not found: "+d.responseText),this.ticket.price(null)},error:function(a,b,c){500==a.status?(console.log("Error during retrieving bundle price"),showError("Fehler bei Preisermittlung",a,b,c,!0)):console.log("Price not found: "+a.responseText),checkSession(a),this.ticket.price(null)}})}else b.Tickets()[a].price(null)}}},b).extend({throttle:10}),b.addToCart=function(a,b){console.log("Adding bundle to cart",a),null!=a.price()&&shoppingcartVM.addEntry(a.price(),b,CATEGORY_KEY_BUNDLE,null)}}function autoverladViewModel(a){var b=this;abstractContingentViewModel.apply(b,[a]),b.categoryKey(CATEGORY_KEY_AUTOVERLAD),b.selectedCategory=categoriesVM.selectedCategory,b.Stations=ko.observableArray([]),b.selectedStation=ko.observable(),b.Directions=ko.observableArray([]),b.selectedDirection=ko.observable(),b.Types=ko.observableArray([]),b.selectedType=ko.observable(),b.DateCategories=ko.observableArray([]),b.selectedDateCategory=ko.observable(),b.selectedDate=ko.observable(),b.AutoverladCategories=ko.observableArray([]),b.AutoverladTickets=ko.observableArray([]),b.licensePlate=ko.observable(!1),b.autoverladLoading=ko.observable(!1),b.reloadContingents=function(){},$.getJSON(serviceRootURL+"/options",{categoryKey:b.categoryKey(),optionListKey:"consumer",parentOptionListKey:"",parentOptionKey:"",recursive:!1}).done(function(a){var c=$.map(a,function(a){return new optionModel(a)});b.AutoverladCategories(c)}).fail(function(a,b,c){checkSession(a),showError("Fehler beim Laden der Stationen",a,b,c)}),$.getJSON(serviceRootURL+"/options",{categoryKey:b.categoryKey(),optionListKey:"stations",parentOptionListKey:"",parentOptionKey:"",recursive:!1}).done(function(a){var c=$.map(a,function(a){return new optionModel(a)});b.Stations(c),b.Stations().length>0&&b.selectStation(b.Stations()[0])}).fail(function(a,b,c){checkSession(a),showError("Fehler beim Laden der Stationen",a,b,c)}),b.selectDirection=function(a,c){var d=a.key();null!=d&&b.selectedDirection(d)},b.selectStation=function(a,c){var d=a.key();null!=d&&(b.selectedStation(d),$.getJSON(serviceRootURL+"/options",{categoryKey:b.categoryKey(),optionListKey:"directions",parentOptionListKey:"stations",parentOptionKey:b.selectedStation(),recursive:!1}).done(function(a){var c=$.map(a,function(a){return new optionModel(a)});b.Directions(c),b.Directions().length>0&&b.selectDirection(b.Directions()[0])}).fail(function(a,b,c){checkSession(a),showError("Fehler beim Laden der Stationen",a,b,c)}),$.getJSON(serviceRootURL+"/options",{categoryKey:b.categoryKey(),optionListKey:"types",parentOptionListKey:"stations",parentOptionKey:b.selectedStation(),recursive:!1}).done(function(a){var c=$.map(a,function(a){return new optionModel(a)});b.Types(c),b.Types().length>0&&b.selectType(b.Types()[0])}).fail(function(a,b,c){checkSession(a),showError("Fehler beim Laden der Typen",a,b,c)}),$.getJSON(serviceRootURL+"/options",{categoryKey:b.categoryKey(),optionListKey:"dateCategories",parentOptionListKey:"stations",parentOptionKey:b.selectedStation,recursive:!1}).done(function(a){var c=$.map(a,function(a){return new optionModel(a)});b.DateCategories(c),b.DateCategories().length>0&&b.selectDateCategory(b.DateCategories()[0])}).fail(function(a,b,c){checkSession(a),showError("Fehler beim Laden der Typen",a,b,c)}))},b.selectType=function(a,c){var d=a.key();null!=d&&(b.selectedType(d),b.selectAvailableDay())},b.selectDateCategory=function(a,c){var d=a.key();null!=d&&b.selectedDateCategory(d)},b.price=ko.computed({disposeWhen:function(){return b.categoryDisposed()},read:function(){console.log("price loading",b.selectedStation(),b.selectedDateCategory(),b.selectedType(),b.selectedDate()),b.selectedStation()&&b.selectedDateCategory()&&b.selectedType()&&b.selectedDate()&&(b.AutoverladTickets(null),b.autoverladLoading(!0),$.ajax(serviceRootURL+"/autoverladprice",{type:"GET",data:{categoryKey:b.categoryKey(),stationKey:b.selectedStation(),dateCategoryKey:b.selectedDateCategory(),typesKey:b.selectedType(),dateString:b.selectedDate(),direction:b.selectedDirection(),partnerId:null},dataType:"json",contentType:"application/json",context:{},success:function(a,c,d){console.log("price for "+b.categoryKey()+" found:",a);var e=new Array;if(null!=a&&a.length>0){for(var f=0;f<a.length;f++)if(null!=a[f].price){for(var g=null,h=0;h<b.AutoverladCategories().length;h++)a[f].consumerKey==b.AutoverladCategories()[h].key()&&(g=b.AutoverladCategories()[h]);var i=new ticketModel(g),j=new autoverladPriceModel(a[f]);i.price(j),e.push(i)}else console.log("Price not found: "+d.responseText);b.AutoverladTickets(e)}b.autoverladLoading(!1)},error:function(a,c,d){b.autoverladLoading(!1),500==a.status?(console.log("Error during retrieving price"),showError("Fehler bei Preisermittlung",a,c,d,!0)):console.log("Price not found: "+a.responseText),checkSession(a),category.price(null)}}))}},b).extend({throttle:50}),b.activeTickets=ko.computed(function(){new Array;return ko.utils.arrayFilter(b.AutoverladTickets(),function(a){return a.price(),!0})}),b.addToCart=function(a,c){console.log("adding depot to cart",a,c),shoppingcartVM.addEntry(a.price(),c,b.categoryKey(),null,null)},b.showDefaultDates=ko.computed(function(){return"furka"==b.selectedStation()&&"single-one-way"==b.selectedType()}),b.getSelectDateLocationHash=function(){return"_category"}}function bergbahnEprViewModel(a){var b=this;categoryViewModel.apply(b,[a]),b.selectedCategory=categoriesVM.selectedCategory;b.Froms=ko.observableArray([]),b.Tos=ko.observableArray([]),b.Consumer=ko.observableArray([]),b.Routes=ko.observableArray([]),b.trainsUp=ko.observableArray([]),b.trainsDown=ko.observableArray([]),b.ContingentInfo=ko.observableArray([]),b.selectedFrom=ko.observable(),b.selectedTo=ko.observable(),b.selectedRoute=ko.observable(),b.selectedTrainUp=ko.observable(),b.selectedTrainDown=ko.observable(),b.selectedViaOutward=ko.observable(),b.selectedViaReturn=ko.observable(),b.availableOutwardTrainTypes=ko.observableArray([]),b.availableReturnTrainTypes=ko.observableArray([]),b.Tickets=ko.observableArray([]),b.loadingEprOutwardTrainContingent=ko.observable(!1),b.loadingEprReturnTrainContingent=ko.observable(!1),b.upContingents=ko.observableArray(),b.downContingents=ko.observableArray(),b.trainUpValue=ko.observable(),b.trainDownValue=ko.observable(),b.loadOptionsForPartner=function(){var a=null!=touroperatorVM.selectedTouroperator()?touroperatorVM.selectedTouroperator().id():"";$.getJSON(serviceRootURL+"/options",{categoryKey:CATEGORY_KEY_BERGBAHN_EPR,optionListKey:"consumer",parentOptionListKey:"",parentOptionKey:"",partnerId:a}).done(function(a){var c={},d=$.map(a,function(a){if(!c[a.id])return c[a.id]=1,new consumerOptionModel(a)}),e=$.map(d,function(a){if(!a.hidden())return new ticketModelBergbahnEpr(a)}).filter(function(a){return filterBergbahnTickets(a)});b.Consumer(d),b.Tickets(e)}).fail(function(a,b,c){checkSession(a),showError("Fehler beim Laden der Altersgruppen",a,b,c)}),$.getJSON(serviceRootURL+"/options",{categoryKey:CATEGORY_KEY_BERGBAHN_EPR,optionListKey:"from",parentOptionListKey:"",parentOptionKey:"",partnerId:a}).done(function(a){var c=$.map(a,function(a){return new optionModel(a)});b.Froms(c),b.Froms().length>0&&b.selectFrom(b.Froms()[0])}).fail(function(a,b,c){checkSession(a),showError("Fehler beim Laden der VONs",a,b,c)}),$.getJSON(serviceRootURL+"/options",{categoryKey:CATEGORY_KEY_BERGBAHN_EPR,optionListKey:"to",parentOptionListKey:"",parentOptionKey:"",partnerId:a}).done(function(a){var c=$.map(a,function(a){return new optionModel(a)});b.Tos(c),b.Tos().length>0&&b.selectTo(b.Tos()[0])}).fail(function(a,b,c){checkSession(a),showError("Fehler beim Laden der NACHs",a,b,c)}),$.getJSON(serviceRootURL+"/options",{categoryKey:CATEGORY_KEY_BERGBAHN_EPR,optionListKey:"routes",parentOptionListKey:"",parentOptionKey:"",partnerId:a,recursive:!0}).done(function(a){var c=$.map(a,function(a){return new bergbahnEprRouteOptionModel(a)});b.Routes(c),console.log("EPR Routes received",b.Routes(),a)}).fail(function(a,b,c){checkSession(a),showError("Fehler beim Laden der Routen",a,b,c)})},b.loadOptionsForPartner(),b.computeAvailableTrainTypesFromRoute=ko.computed(function(){var a=ko.utils.arrayFilter(b.Routes(),function(a){return!(!b.selectedFrom()||!b.selectedTo())&&(a.fromKey().toUpperCase()==b.selectedFrom().key().toUpperCase()&&a.toKey().toUpperCase()==b.selectedTo().key().toUpperCase())});if(a.length>0){var c=a[0];b.availableOutwardTrainTypes(c.availableOutwardTrainTypes()),b.availableReturnTrainTypes(c.availableReturnTrainTypes()),b.selectedRoute(c),b.availableOutwardTrainTypes().length>0&&b.selectedViaOutward(b.availableOutwardTrainTypes()[0]),b.availableReturnTrainTypes().length>0&&b.selectedViaReturn(b.availableReturnTrainTypes()[0])}else b.availableOutwardTrainTypes([]),b.availableReturnTrainTypes([])}),b.resetContingents=function(a){a.forEach(function(a){a.contingent(null)})},b.loadOutwardTrains=ko.computed(function(){b.selectedRoute()&&b.selectedViaOutward()&&b.selectedDate()&&(b.selectedTrainUp(null),b.resetContingents(b.trainsUp()),b.selectedViaOutward().key()==BERGBAHN_TRAIN_TYPE_TRADITIONAL&&b.trainsUp(b.selectedRoute().trainsUpTraditional()),b.selectedViaOutward().key()==BERGBAHN_TRAIN_TYPE_VBAHN&&b.trainsUp(b.selectedRoute().trainsUpVbahn()),b.loadContingent(b.selectedDate(),b.selectedViaOutward().addonId,BERGBAHN_EPR_OUTWARD))}),b.loadReturnTrains=ko.computed(function(){b.selectedRoute()&&b.selectedViaReturn()&&b.selectedDate()&&(b.selectedTrainDown(null),b.resetContingents(b.trainsDown()),b.selectedViaReturn().key()==BERGBAHN_TRAIN_TYPE_TRADITIONAL&&b.trainsDown(b.selectedRoute().trainsDownTraditional()),b.selectedViaReturn().key()==BERGBAHN_TRAIN_TYPE_VBAHN&&b.trainsDown(b.selectedRoute().trainsDownVbahn()),b.loadContingent(b.selectedDate(),b.selectedViaReturn().addonId,BERGBAHN_EPR_RETURN))});var c=function(a,b){if(a&&b)for(var c=0;c<a.length;c++)for(var d=a[c],e=0;e<b.length;e++){var f=b[e];if(d.campaign()==f.id()||d.trainNumber()===f.id()){d.contingent(f);break}}};b.loadContingent=function(a,d,e){e==BERGBAHN_EPR_OUTWARD&&b.loadingEprOutwardTrainContingent(!0),e==BERGBAHN_EPR_RETURN&&b.loadingEprReturnTrainContingent(!0),$.getJSON(serviceRootURL+"/contingent_info",{categoryKey:CATEGORY_KEY_BERGBAHN_EPR,dateString:a,productId:d}).done(function(a){var d=$.map(a,function(a){return new categoryContingentModel(a)});e==BERGBAHN_EPR_OUTWARD&&(b.upContingents(d),c(b.trainsUp(),b.upContingents()),b.loadingEprOutwardTrainContingent(!1)),e==BERGBAHN_EPR_RETURN&&(b.downContingents(d),c(b.trainsDown(),b.downContingents()),b.loadingEprReturnTrainContingent(!1))}).fail(function(){console.log("Timeselection contingent info not found for addon",d,a),e==BERGBAHN_EPR_OUTWARD&&(b.upContingents.removeAll(),b.loadingEprOutwardTrainContingent(!1)),e==BERGBAHN_EPR_RETURN&&(b.downContingents.removeAll(),b.loadingEprReturnTrainContingent(!1))})},b.selectFrom=function(a,c){null!=a&&(b.selectedFrom(a),location.hash="shop_bergbahn_epr_destination")},b.selectTo=function(a,c){b.selectedTo(a),location.hash="shop_bergbahn_epr_date"},b.selectViaOutward=function(a,c){b.selectedViaOutward(a),location.hash="shop_bergbahn_epr_trainup"},b.selectViaReturn=function(a,c){b.selectedViaReturn(a),location.hash="shop_bergbahn_epr_date"},b.getSelectDateLocationHash=function(){return"_trainup"},b.selectTrainUp=function(a,c){b.selectedTrainUp(a),location.hash="shop_bergbahn_epr_traindown"},b.disableTrainUp=function(a){var c=a.deptime().split(":"),d=moment(b.selectedDate()).startOf("day");return d.hour(c[0]),d.minutes(c[1]),d<moment()?a.disabled(!0):a.disabled(!1),a.disabled()},b.selectTrainDown=function(a,c){b.selectedTrainDown(a),location.hash="shop_bergbahn_epr_persons"},b.disableTrainDown=function(a){var c=a.deptime().split(":"),d=moment(b.selectedDate()).startOf("day");if(d.hour(c[0]),d.minutes(c[1]),d<moment())a.disabled(!0);else if(null==b.selectedTrainUp())a.disabled(!1);else{var e=b.selectedTrainUp().arrtime().split(":"),f=moment(b.selectedDate()).startOf("day");f.hour(e[0]),f.minutes(e[1]),d<f?a.disabled(!0):a.disabled(!1)}return a.disabled()},b.isDaytripProduct=ko.computed(function(){return!(!b.selectedRoute()||!b.selectedRoute().additionalInfo())&&b.selectedRoute().additionalInfo().isDaytrip}),b.activeTickets=ko.computed(function(){return ko.utils.arrayFilter(b.Tickets(),function(a){return null!=a.price()})}),b.getPriceForSelections=ko.computed(function(){if(b.isDaytripProduct())if(null==b.selectedTrainUp()&&null==b.selectedTrainDown())b.Tickets().forEach(function(a){a.price(null)});else{var a=b.selectedRoute().additionalInfo().tripType,c=b.selectedRoute().additionalInfo().bergbahnVias.split(","),d=b.selectedRoute().additionalInfo().productKey,e=b.selectedViaOutward()&&b.selectedTrainUp()?b.selectedViaOutward().addonId:null,f=b.selectedViaReturn()&&b.selectedTrainDown()?b.selectedViaReturn().addonId:null,g=[e,f];categoriesVM.daytripsVM()?b.Tickets().forEach(function(h){categoriesVM.daytripsVM().getDaytripTicketPrice(h,d,b.selectedDate(),b.selectedFrom().key(),"",b.selectedTo().key(),"",c[0],"",2,"",a,"",function(a,c){console.log("daytrip price received",a),a.bundleItems().forEach(function(a){var c=a.price();c instanceof eprAddonPriceModel&&(a.price().id()==e?c.selectedTrain(b.selectedTrainUp()):a.price().id()==f&&c.selectedTrain(b.selectedTrainDown()))}),c.price(a)},!0,g,!0)}):console.error("Daytrip category not available for price query. Check daytrip category assignment in contract")}}),b.price=ko.computed({disposeWhen:function(){return b.categoryDisposed()},read:function(){
if(!b.isDaytripProduct()&&b.selectedFrom()&&b.selectedTo()&&b.selectedDate()){console.log("computing prices for all consumers..."),b.setSeasonInfo(null);for(var a=null!=touroperatorVM.selectedTouroperator()?touroperatorVM.selectedTouroperator().id():"",c=0;c<b.Tickets().length;c++)null!=b.selectedTrainUp()?$.ajax(serviceRootURL+"/bergbahnprice",{type:"GET",data:{categoryKey:CATEGORY_KEY_BERGBAHN_EPR,consumerKey:b.Tickets()[c].consumer().key(),fromKey:b.selectedFrom().key(),toKey:b.selectedTo().key(),viaKey:b.selectedTrainUp().key(),classKey:"2",tripTypeKey:"O",dateString:b.selectedDate(),partnerId:a},dataType:"json",contentType:"application/json",context:{ticket:b.Tickets()[c]},success:function(a,c,d){console.log("train up price for consumer group "+this.ticket.consumer().key()+" found: data.price="+a.price),null!=a.price?(price=new bergbahnEprPriceModel(a),price.fromKey()==b.selectedFrom().key()&&price.toKey()==b.selectedTo().key()&&price.viaKey()==b.selectedTrainUp().key()&&price.date()==b.selectedDate()&&(this.ticket.price(price),b.setSeasonInfo(price))):(console.log("Bergbahn train up price not found: "+d.responseText),this.ticket.price(null))},error:function(a,b,c){500==a.status?(console.log("Error during retrieving train up price"),showError("Fehler bei Preisermittlung",a,b,c,!0)):console.log("Price not found: "+a.responseText),checkSession(a),this.ticket.price(null)}}):b.Tickets()[c].price(null),null!=b.selectedTrainDown()?$.ajax(serviceRootURL+"/bergbahnprice",{type:"GET",data:{categoryKey:CATEGORY_KEY_BERGBAHN_EPR,consumerKey:b.Tickets()[c].consumer().key(),fromKey:b.selectedFrom().key(),toKey:b.selectedTo().key(),viaKey:b.selectedTrainDown().key(),classKey:"2",tripTypeKey:"O",dateString:b.selectedDate(),partnerId:a},dataType:"json",contentType:"application/json",context:{ticket:b.Tickets()[c]},success:function(a,c,d){console.log("train down price for consumer group "+this.ticket.consumer().key()+" found: data.price="+a.price),null!=a.price?(price=new bergbahnEprPriceModel(a),price.fromKey()==b.selectedFrom().key()&&price.toKey()==b.selectedTo().key()&&price.viaKey()==b.selectedTrainDown().key()&&price.date()==b.selectedDate()&&(this.ticket.priceDown(price),b.setSeasonInfo(price))):(console.log("Bergbahn train down price not found: "+d.responseText),this.ticket.priceDown(null))},error:function(a,b,c){500==a.status?(console.log("Error during retrieving train down price"),showError("Fehler bei Preisermittlung",a,b,c,!0)):console.log("Price not found: "+a.responseText),checkSession(a),this.ticket.priceDown(null)}}):b.Tickets()[c].priceDown(null)}}},b).extend({throttle:10}),b.addToCart=function(a,b){console.log("addToCart bergbahn epr",a.price()),null!=a.price()&&(a.price()instanceof bundlePriceModel?(a.price().bundleItems().forEach(function(a){a.price()instanceof eprAddonPriceModel&&a.price().eprSelected(!0)}),shoppingcartVM.addEntry(a.price(),b,CATEGORY_KEY_BUNDLE,null)):shoppingcartVM.addEntry(a.price(),b,CATEGORY_KEY_BERGBAHN_EPR,null)),null!=a.priceDown()&&shoppingcartVM.addEntry(a.priceDown(),b,CATEGORY_KEY_BERGBAHN_EPR,null)},b.loadTrains=function(a,b,c,d){var e=null!=touroperatorVM.selectedTouroperator()?touroperatorVM.selectedTouroperator().id():"";return $.getJSON(serviceRootURL+"/options",{categoryKey:CATEGORY_KEY_BERGBAHN_EPR,optionListKey:a,parentOptionListKey:"routes",parentOptionKey:b,partnerId:e}).done(function(a){var b=$.map(a,function(a){return new bergbahnEprTrainOptionModel(a)});c(b)}).fail(function(){console.log("trains not found for route ",b,direction),d()})}}function daytripsViewModel(a){var b=this;abstractContingentViewModel.apply(b,[a]),b.selectedCategory=categoriesVM.selectedCategory,b.categoryKey(CATEGORY_KEY_BUNDLE),b.Bundles=ko.observableArray([]),b.selectedBundle=ko.observable();var c=a.key();b.useTicketLabel=ko.observable(!1);var d=headerVM.getCategoryLabelModel(c);d&&"1"==d.categoryUseTicketLabel()&&(console.log("categoryUseTicketLabel = ",d.categoryUseTicketLabel()),b.useTicketLabel(!0)),b.getOptionReference=function(){return null!=b.selectedBundle()&&b.selectedBundle().hasOwnProperty("key")?b.selectedBundle().key():null},b.BundleValue=ko.pureComputed(function(){return b.selectedBundle()?b.selectedBundle().value():""},this),b.hasAddon=ko.observable(),b.hasBergbahn=ko.observable(),this.Addons=ko.observableArray(),this.Bergbahn=ko.observable(),b.selectedAddOn=ko.observable(),b.bergbahnSelected=ko.observable(),this.BergbahnProducts=ko.observableArray(),this.BergbahnFrom=ko.observableArray(),this.BergbahnTo=ko.observableArray(),this.BergbahnVia=ko.observableArray(),this.BergbahnType=ko.observableArray(),this.BergbahnConsumer=ko.observableArray(),this.selectedBergbahnFrom=ko.observable(),this.selectedBergbahnTo=ko.observable(),this.selectedBergbahnVia=ko.observable(),this.selectedBergbahnType=ko.observable(),this.selectedBergbahnConsumer=ko.observable(),b.Tickets=ko.observableArray([]),b.activityTypes=ko.observableArray([]),b.selectedActivityType=ko.observable({}),b.selectedActivityType.subscribe(function(a){for(var c,d=0;d<b.Bundles().length;d++){var e=b.Bundles()[d];if(!e.background()&&(c=e.additionalInfo().activityTypes))if(a.key)for(var f=0;f<c.length;f++){if(c[f].key==a.key){e.hidden(!1);break}e.hidden(!0)}else e.hidden(!1)}});var e=null!=touroperatorVM&&null!=touroperatorVM.selectedTouroperator()?touroperatorVM.selectedTouroperator().id():"";$.getJSON(serviceRootURL+"/options",{categoryKey:CATEGORY_KEY_DAYTRIPS,optionListKey:"daytrips",parentOptionListKey:"",parentOptionKey:"",partnerId:e,recursive:!1}).done(function(a){var c={},d=$.map(a,function(a){if(a.additionalInfo&&a.additionalInfo.activityTypes)for(var d=0;d<a.additionalInfo.activityTypes.length;d++)c[a.additionalInfo.activityTypes[d].key]||(c[a.additionalInfo.activityTypes[d].key]=!0,b.activityTypes.push({key:a.additionalInfo.activityTypes[d].key,name:a.additionalInfo.activityTypes[d].name,enabled:ko.observable(!0)}));return new daytripsOptionModel(a)});b.Bundles(d),console.log("Loaded Daytrip options",b.Bundles())}).fail(function(a,b,c){checkSession(a),showError("Fehler beim Laden der DAYTRIP Bundles",a,b,c)}),b.prepareBundleName=function(a){return a.replace(",","<br>")},b.setSelectedBundle=function(a,c){console.log("Setting selected bundle",a,c),b.hasAddon(c.additionalInfo.hasAddon),b.hasBergbahn(c.additionalInfo.hasBergbahn),b.validFrom(c.additionalInfo.bergbahnValidFrom),b.validTo(c.additionalInfo.bergbahnValidTo),b.productAvailability(JSON.parse(c.additionalInfo.bergbahnAvailability)),b.productUseRestrictions(c.additionalInfo.bergbahnUseRestrictions),b.selectedBundle(a),b.selectedProduct(new daytripsOptionModel(c)),b.loadContingentInfo(a.key())},b.selectBundle=function(a,c){b.selectedAddOn(null),b.bergbahnSelected(!1),b.todayActive(!0),b.tomorrowActive(!0),$.getJSON(serviceRootURL+"/option",{categoryKey:CATEGORY_KEY_DAYTRIPS,optionListKey:"daytrips",optionKey:a.key(),parentOptionListKey:"",parentOptionKey:"",recursive:!0}).done(function(c){if(console.log("daytripsOptionModel json",c),b.setSelectedBundle(a,c),b.hasAddon()){var d=$.map(c.localizedOptions.addons,function(a){return new addOnOptionModel(a)});b.Addons(d),b.Addons().length>0&&b.selectedAddOn(b.Addons()[0])}else b.Addons.removeAll(),b.bergbahnSelected(!0);if(c.localizedOptions.selections)for(var e=0;e<c.localizedOptions.selections.length;e++)if(c.localizedOptions.selections[e].key==CATEGORY_KEY_BERGBAHN){b.Bergbahn(new addOnBergbahnOptionModel(c.localizedOptions.selections[e]));var f=$.map(c.localizedOptions.selections[e].localizedOptions.products,function(a){return new optionModel(a)});b.BergbahnProducts(f);var f=$.map(c.localizedOptions.bergbahnFrom,function(a){return new optionModel(a)});b.BergbahnFrom(f),b.BergbahnFrom().length>0&&b.selectedBergbahnFrom(b.BergbahnFrom()[0]);var f=$.map(c.localizedOptions.bergbahnTo,function(a){return new optionModel(a)});b.BergbahnTo(f),b.BergbahnTo().length>0&&b.selectedBergbahnTo(b.BergbahnTo()[0]);var f=$.map(c.localizedOptions.selections[e].localizedOptions.via,function(a){return new bergbahnViaOptionModel(a)});b.BergbahnVia(f),b.BergbahnVia().length>0&&b.selectedBergbahnVia(b.BergbahnVia()[0]);var f=$.map(c.localizedOptions.selections[e].localizedOptions.type,function(a){return new bergbahnTypeOptionModel(a)});b.BergbahnType(f),b.BergbahnType().length>0&&b.selectedBergbahnType(b.BergbahnType()[0])}var g=$.map(c.localizedOptions.consumer,function(a){var b=new consumerOptionModel(a);if(!b.hidden())return new ticketModelBergbahn(b)}).filter(function(a){return filterBergbahnTickets(a)});b.Tickets(g),location.hash="shop_daytrips_addon"}).fail(function(a,b,c){checkSession(a),showError("Fehler beim Laden der DAYTRIPS Bundles",a,b,c)})},b.selectAddOn=function(a,c){b.bergbahnSelected(!1),b.selectedAddOn(null!=a?a:null),location.hash="shop_daytrips_date"},b.selectBergbahn=function(){b.bergbahnSelected(!0),b.selectedAddOn(null),location.hash="shop_daytrips_date"},b.selectBergbahnType=function(a,c){b.selectedBergbahnType(a),location.hash="shop_daytrips_persons"},b.isActiveBergbahnType=function(a){return!!b.selectedBergbahnType()&&b.selectedBergbahnType().key()===a},b.bergbahnTypeDisplayValue=function(){if(b.hasBergbahn()&&b.selectedBergbahnType())return b.selectedBergbahnType().className()+", "+b.selectedBergbahnType().tripTypeName()},this.bergbahnDisplayValue=ko.computed(function(){return b.hasBergbahn()&&b.selectedBergbahnFrom()&&b.selectedBergbahnTo()&&b.selectedBergbahnVia()&&b.selectedBergbahnType()?b.selectedBergbahnFrom().value()+"-"+b.selectedBergbahnTo().value()+"<br/>"+b.selectedBergbahnType().className()+", "+b.selectedBergbahnType().tripTypeName():""}),b.getEprDaytrips=function(a,c){var d=[],e=a+"."+c;return b.Bundles().forEach(function(a){-1!=a.key().indexOf(e)&&d.push(a)}),d},b.checkIfProductHasChanged=function(a){return a.price().fromKey()!=b.selectedBergbahnFrom().key()||a.price().toKey()!=b.selectedBergbahnTo().key()||a.price().viaKey()!=b.selectedBergbahnVia().key()||a.price().classKey()!=b.selectedBergbahnType().classKey()||a.price().tripTypeKey()!=b.selectedBergbahnType().tripTypeKey()||a.price().date()!=b.selectedDate()},b.getDaytripTicketPrice=function(a,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r){var s={productKey:c,dateString:d,consumerKey:a.consumer().key(),selectableItems:[],tripTypeKey:m,selectedAddonIds:q},t=null;(b.hasBergbahn()||1==p)&&(t={categoryKey:CATEGORY_KEY_BERGBAHN,fromKey:e,toKey:g,viaKey:i,classKey:k,tripTypeKey:m,consumerKey:a.consumer().key(),dateString:d,isAddOn:!0},s.selectableItems.push(t));var u=serviceRootURL+"/daytripsprice";touroperatorVM.selectedTouroperator&&null!=touroperatorVM.selectedTouroperator()&&touroperatorVM.selectedTouroperator().id()&&(u+="?partnerId="+touroperatorVM.selectedTouroperator().id()),$.ajax(u,{type:"POST",data:JSON.stringify(s),dataType:"json",contentType:"application/json",context:{ticket:a},success:function(c,d,p){if(console.log("daytrip price for consumer group "+this.ticket.consumer().key()+" found: data.price=",c.price,c),null!=c.price){price=new bundlePriceModel(c);var q=null;if(null!=c.bundleItems){for(var r=0;r<c.bundleItems.length;r++){var s=null;if(c.bundleItems[r].categoryKey==CATEGORY_KEY_BERGBAHN)b.Bergbahn()&&(b.Bergbahn().fromKey(e),b.Bergbahn().fromName(f),b.Bergbahn().toKey(g),b.Bergbahn().toName(h),b.Bergbahn().viaKey(i),b.Bergbahn().viaName(j),b.Bergbahn().tripTypeKey(m),b.Bergbahn().tripTypeName(n),b.Bergbahn().classKey(k),b.Bergbahn().className(l)),q=getPriceBundleItemInstance(c.bundleItems[r],b.Bergbahn()),price.bundleItems().push(q);else if(c.bundleItems[r].categoryKey==CATEGORY_KEY_ADDON){s=getOption(b.Addons(),c.bundleItems[r].productKey);var t=getPriceBundleItemInstance(c.bundleItems[r],s);price.bundleItems().push(t)}}if(o)return void o(price,a);b.checkIfProductHasChanged(q)||this.ticket.price(price)}else this.ticket.price(null)}else this.ticket.price(null)},error:function(b,c,d){500==b.status?(console.log("Error during retrieving bundle price"),showError("Fehler bei Preisermittlung",b,c,d,!0),this.ticket.price(null)):r&&a.price(null),checkSession(b)}})},b.price=ko.computed({disposeWhen:function(){return b.categoryDisposed()},read:function(){if(b.selectedDate()){console.log("computing daytrip prices for all consumers..."),b.setSeasonInfo(null);for(var a=0;a<b.Tickets().length;a++)b.getDaytripTicketPrice(b.Tickets()[a],b.selectedBundle().key(),b.selectedDate(),b.selectedBergbahnFrom().key(),b.selectedBergbahnFrom().value(),b.selectedBergbahnTo().key(),b.selectedBergbahnTo().value(),b.selectedBergbahnVia().key(),b.selectedBergbahnVia().value(),b.selectedBergbahnType().classKey(),b.selectedBergbahnType().className(),b.selectedBergbahnType().tripTypeKey(),b.selectedBergbahnType().tripTypeName(),!1)}else for(var a=0;a<b.Tickets().length;a++)b.Tickets()[a].price(null)}},b).extend({throttle:10}),b.activeTickets=ko.computed(function(){return ko.utils.arrayFilter(b.Tickets(),function(a){return null!=a.price()})}),b.getSelectDateLocationHash=function(){return"_persons"},b.addToCart=function(a,b){var c=shoppingcartVM.addEntry(a.price(),b,CATEGORY_KEY_BUNDLE,null,null);console.log("added daytrip to card",a.price(),c)}}function addonViewModel(a){var b=this;categoryViewModel.apply(b,[a])}function depotViewModel(a){var b=this;abstractContingentViewModel.apply(b,[a]),b.categoryKey(CATEGORY_KEY_DEPOT),b.selectedCategory=categoriesVM.selectedCategory,b.Rooms=ko.observableArray([]),b.RoomTypes=ko.observableArray([]),b.Duration=ko.observableArray([]),b.DepotCategories=ko.observableArray([]),b.DepotTickets=ko.observableArray([]),b.selectedRoom=ko.observable(),b.selectedRoomType=ko.observable(),b.selectedDate=ko.observable(),b.selectedDuration=ko.observable(),b.selectedDurationType=ko.observable("single"),b.selectedDepotCategory=ko.observable(),b.depotLoading=ko.observable(!1),b.reloadContingents=function(){},b.isActiveProductAvailable=function(a){return null!=ko.utils.arrayFirst(a,function(a){return!!b.selectedProduct()&&a.key()==b.selectedProduct().key()})},b.availableRooms=ko.computed(function(){return b.selectedProduct()?b.selectedProduct().availableRooms():[]}),b.availableRoomTypes=ko.computed(function(){return b.selectedProduct()?b.selectedProduct().availableRoomTypes():[]}),$.getJSON(serviceRootURL+"/options",{categoryKey:b.categoryKey(),optionListKey:"rooms",parentOptionListKey:"",parentOptionKey:"",recursive:!1}).done(function(a){var c=$.map(a,function(a){return new optionModel(a)});if(b.Rooms(c),b.Rooms().length>0&&b.selectedRoom(b.Rooms()[0].key()),!b.selectedDate()){var d=$.datepicker.formatDate(DATE_SERVER_FORMAT,new Date);b.selectedDate(d)}}).fail(function(a,b,c){checkSession(a),showError("Fehler beim Laden der Räume",a,b,c)}),$.getJSON(serviceRootURL+"/options",{categoryKey:b.categoryKey(),optionListKey:"consumer",parentOptionListKey:"",parentOptionKey:"",recursive:!1}).done(function(a){var c=$.map(a,function(a){return new optionModel(a)});b.DepotCategories(c),b.DepotCategories().length>0&&b.selectedDepotCategory(b.DepotCategories()[0].key())}).fail(function(a,b,c){checkSession(a),showError("Fehler beim Laden der Räume",a,b,c)}),b.selectRoom=function(a,c){var d=a.key();null!=d&&b.selectedRoom(d)},b.selectDurationInput=function(a,c){var d=c.target.value;null!=d&&""!=d?b.selectedDuration(d):c.target.value=""},b.DurationValue=ko.pureComputed(function(){return b.selectedDuration()},this),b.activeTickets=ko.computed(function(){new Array;return ko.utils.arrayFilter(b.DepotTickets(),function(a){return a.price(),!0})}),b.price=ko.computed({disposeWhen:function(){return b.categoryDisposed()},read:function(){b.selectedRoom()&&b.selectedDate()&&b.selectedDuration()&&(b.depotLoading(!0),b.DepotCategories().forEach(function(a){console.log("Getting price for category",a),$.ajax(serviceRootURL+"/depotprice",{type:"GET",data:{categoryKey:b.categoryKey(),consumerKey:a.optionValue(),roomKey:b.selectedRoom(),durationTypeKey:b.selectedDurationType(),fromDateString:b.selectedDate(),duration:b.selectedDuration()},dataType:"json",contentType:"application/json",context:{},success:function(a,c,d){console.log("price for depot consumer group "+b.categoryKey()+" found: data",a);var e=new Array;if(null!=a&&a.length>0){for(var f=0;f<a.length;f++)if(null!=a[f].price){for(var g=null,h=0;h<b.DepotCategories().length;h++)a[f].consumerKey==b.DepotCategories()[h].key()&&(g=b.DepotCategories()[h]);var i=new ticketModel(g),j=new depotPriceModel(a[f]);i.price(j),e.push(i)}else console.log("Price not found: "+d.responseText);b.DepotTickets(e)}b.depotLoading(!1)},error:function(c,d,e){b.depotLoading(!1),500==c.status?(console.log("Error during retrieving price"),showError("Fehler bei Preisermittlung",c,d,e,!0)):console.log("Price not found: "+c.responseText),checkSession(c),a.price(null)}})}))}},b).extend({throttle:50}),b.addToCart=function(a,c){console.log("adding depot to cart",a,c),console.log("ticket.price().availability(): "+a.price().availability()),0==a.price().availability()&&showInfo(i18n.t("cart.msg.depotAvailabilityError")),null!=a.price()&&a.price().availability()>0&&shoppingcartVM.addEntry(a.price(),c,b.categoryKey(),null,null)}}function hotelViewModel(a){var b=this;categoryViewModel.apply(b,[a]),b.categoryKey(CATEGORY_KEY_HOTEL),b.selectedCategory=categoriesVM.selectedCategory,b.Regions=ko.observableArray([]),b.RoomCategories=ko.observableArray([]),b.selectedRegion=ko.observable(),b.selectedRegionOption=ko.observable(),b.selectedRoomCategory=ko.observable(),b.selectedRoomCategoryOption=ko.observable(),b.selectedArrivalDate=ko.observable(),b.selectedArrivalDateInt=ko.observable(),b.departureCustomDate=ko.observable(),b.selectedDepartureDate=ko.observable(),b.selectedDepartureDateInt=ko.observable(),b.selectedRoomCount=ko.observable(1),b.selectedAdultCount=ko.observable(1),b.selectedChildCount=ko.observable(0),b.childAge1=ko.observable(),b.childAge2=ko.observable(),b.childAge3=ko.observable(),b.childAge4=ko.observable(),b.childAgesComplete=ko.observable(!0),b.Cities=ko.observableArray([]),b.selectedCity=ko.observable(),b.selectedCityOption=ko.observable(),b.Hotels=ko.observableArray([]),b.selectedHotel=ko.observable(),b.selectedHotelOption=ko.observable(),b.selectedType=ko.observable(),b.availableTypes=ko.observableArray(),b.Tickets=ko.observableArray([]),b.loadingPrices=ko.observable(!0),b.RegionValue=ko.pureComputed(function(){var a=getOption(b.Regions(),b.selectedRegion());return b.selectedRegionOption(a),a?a.value():""},this),b.RoomCategoryValue=ko.pureComputed(function(){var a=getOption(b.RoomCategories(),b.selectedRoomCategory());return b.selectedRoomCategoryOption(a),a?a.value():""},this),b.setAvailableTypes=function(){b.availableTypes.removeAll(),b.availableTypes([{key:ko.observable("FIT"),value:ko.observable(i18n.t("shop.hotel.type.fit"))},{key:ko.observable("GRP"),value:ko.observable(i18n.t("shop.hotel.type.grp"))}])},b.selectRegion=function(a,c){b.selectedRegion(a.key()),b.setRoute("_roomcategory")},b.selectType=function(a,c){b.selectedType(a),b.setRoute("_offers"),b.Hotels().forEach(function(b){b.hotelTicketModel().updatePricesForAccommRateTypeKey(a.key())})},b.selectRoomCategory=function(a,c){b.selectedRoomCategory(a.key()),location.hash="shop_hotel_arrivaldate"},$.getJSON(serviceRootURL+"/options",{categoryKey:b.categoryKey(),optionListKey:"regions",parentOptionListKey:"",parentOptionKey:"",recursive:!1}).done(function(a){var c=$.map(a,function(a){return console.log("Region option",a),new optionModel(a)});b.Regions(c),b.Regions().length>0&&b.selectedRegion(b.Regions()[0].key())}).fail(function(a,b,c){checkSession(a),showError("Fehler beim Laden der Regionen",a,b,c)}),$.getJSON(serviceRootURL+"/options",{categoryKey:b.categoryKey(),optionListKey:"roomCategories",parentOptionListKey:"",parentOptionKey:"",recursive:!1}).done(function(a){var c=$.map(a,function(a){return new optionModel(a)});b.RoomCategories(c),b.RoomCategories().length>0&&b.selectedRoomCategory(b.RoomCategories()[0].key())}).fail(function(a,b,c){checkSession(a),showError("Fehler beim Laden der Zimmerkategorien",a,b,c)}),b.selectArrivalDate=function(a){if(0==a&&!b.todayActive())return void b.selectedArrivalDate(null);if(1==a&&!b.tomorrowActive())return void b.selectedArrivalDate(null);$("#hotelArrivalCustomDate").val("");var c=new Date;if(c.setDate(c.getDate()+a),b.selectedArrivalDate($.datepicker.formatDate(DATE_SERVER_FORMAT,c)),b.selectedArrivalDateInt(a),b.selectedDepartureDate()){var d=new Date;d.setDate(d.getDate()+2),1==b.selectedArrivalDateInt()&&moment(b.selectedDepartureDate()).isBefore(moment(d))&&(b.selectedDepartureDate($.datepicker.formatDate(DATE_SERVER_FORMAT,d)),b.selectedDepartureDateInt(null),$("#hotelDepartureCustomDate").val($.datepicker.formatDate(DATE_PICKER_FORMAT,d)))}"#tickets"!=location.hash&&(location.hash=b.getSelectArrivalDateLocationHash())},b.getSelectArrivalDateLocationHash=function(a){return"shop_"+b.categoryModel().key()+"_departuredate"},b.selectArrivalDateInput=function(a,c){var d=c.target.value,e=$.datepicker.formatDate(DATE_SERVER_FORMAT,new Date);try{if(""!=d){var f=$.datepicker.parseDate(DATE_PICKER_FORMAT,d);if(moment(f).isBefore(moment(e)))b.resetDate(e);else{b.selectedArrivalDate($.datepicker.formatDate(DATE_SERVER_FORMAT,f));var g=f;g.setDate(f.getDate()+1);var h=$.datepicker.parseDate(DATE_SERVER_FORMAT,b.selectedDepartureDate());moment(h).isSameOrBefore(moment(g))&&(b.selectedDepartureDate($.datepicker.formatDate(DATE_SERVER_FORMAT,g)),b.selectedDepartureDateInt(null),$("#hotelDepartureCustomDate").val($.datepicker.formatDate(DATE_PICKER_FORMAT,g))),location.hash="shop_"+b.categoryModel().key()+"_departuredate"}}}catch(a){b.resetArrivalDate(e)}},b.resetArrivalDate=function(a){b.selectedArrivalDate(a);var c=$.datepicker.parseDate(DATE_SERVER_FORMAT,a);$("#hotelArrivalCustomDate").val($.datepicker.formatDate(DATE_PICKER_FORMAT,c))},b.selectDepartureDate=function(a){$("#hotelDepartureCustomDate").val("");var c=new Date;c.setDate(c.getDate()+a),b.selectedDepartureDate($.datepicker.formatDate(DATE_SERVER_FORMAT,c)),b.selectedDepartureDateInt(a),"#tickets"!=location.hash&&(location.hash=b.getSelectDepartureDateLocationHash())},b.tomorrowDepartureDisabled=ko.computed(function(){var a=new Date;return a=$.datepicker.formatDate(DATE_SERVER_FORMAT,a),!moment(b.selectedArrivalDate()).isSame(moment(a))||!b.tomorrowActive()},b),b.getSelectDepartureDateLocationHash=function(a){return"shop_"+b.categoryModel().key()+"_roomcount"},b.selectDepartureDateInput=function(a,c){var d=c.target.value,e=($.datepicker.formatDate(DATE_SERVER_FORMAT,new Date),new Date);e.setDate(e.getDate()+1),e=$.datepicker.formatDate(DATE_SERVER_FORMAT,e);try{if(""!=d){var f=$.datepicker.parseDate(DATE_PICKER_FORMAT,d),g=$.datepicker.parseDate(DATE_SERVER_FORMAT,b.selectedArrivalDate());if(moment(f).isSameOrBefore(moment(g))){var h=new Date;h.setDate(h.getDate()+1),h=$.datepicker.formatDate(DATE_SERVER_FORMAT,h),b.selectedDepartureDate(h),b.selectedDepartureDateInt(null),$("#hotelDepartureCustomDate").val($.datepicker.formatDate(DATE_PICKER_FORMAT,h))}else moment(f).isBefore(moment(e))?b.resetDepartureDate(e):(b.selectedDepartureDate($.datepicker.formatDate(DATE_SERVER_FORMAT,f)),location.hash=b.getSelectDepartureDateLocationHash())}}catch(a){b.resetDepartureDate(e)}},b.resetDepartureDate=function(a){b.selectedDepartureDate(a);var c=$.datepicker.parseDate(DATE_SERVER_FORMAT,a);$("#hotelDepartureCustomDate").val($.datepicker.formatDate(DATE_PICKER_FORMAT,c))},b.selectArrivalDate(0),b.selectDepartureDate(1),b.RoomCountValue=ko.pureComputed(function(){return b.selectedRoomCount()},this),b.selectRoomCount=function(a,c){$("#hotelDepartureCustomDate").val(""),b.selectedRoomCount(a),location.hash="shop_hotel_adultcount"},b.AdultCountValue=ko.pureComputed(function(){b.selectedAdultCount()},this),b.selectAdultCount=function(a,c){b.selectedAdultCount(a),location.hash="shop_hotel_childcount"},b.selectAdultCountInput=function(a,c){var d=c.target.value;null!=d&&d>=1&&d<=5?b.selectedAdultCount(d):c.target.value=""},b.ChildCountValue=ko.pureComputed(function(){b.selectedChildCount()},this),b.selectChildCount=function(a,c){b.selectedChildCount(a),b.selectedChildCount()>0?location.hash="shop_hotel_children":location.hash="shop_hotel_city"},b.selectChildCountInput=function(a,c){var d=c.target.value;null!=d&&d>=0&&d<=4?b.selectedChildCount(d):c.target.value=""},b.children=ko.computed(function(){var a="",c=!0;return b.selectedChildCount()>0&&(b.childAge1()||(c=!1),a+=b.childAge1()+","),b.selectedChildCount()>1&&(b.childAge2()||(c=!1),a+=b.childAge2()+","),b.selectedChildCount()>2&&(b.childAge3()||(c=!1),a+=b.childAge3()+","),b.selectedChildCount()>3&&(b.childAge4()||(c=!1),a+=b.childAge4()+","),a.length>0&&(a=a.substring(0,a.length-1)),b.childAgesComplete(c),a},b),b.CityValue=ko.pureComputed(function(){var a=getOption(b.Cities(),b.selectedCity());return b.selectedCityOption(a),a?(b.Hotels(b.selectedCityOption().accommodations()),b.Hotels().length>0&&b.selectedHotel(b.Hotels()[0].key()),b.selectedType()?b.selectType(b.selectedType()):b.availableTypes().length>0&&b.selectType(b.availableTypes()[0]),a.value()):(b.Hotels([]),"")},this),b.selectCity=function(a,c){b.selectedCity(a.key()),location.hash="shop_hotel_type"},b.HotelValue=ko.pureComputed(function(){var a=getOption(b.Hotels(),b.selectedHotel());return b.selectedHotelOption(a),a?(b.Tickets(b.selectedHotelOption().offers()),a.value()):(b.Tickets([]),"")},this),b.selectHotel=function(a,c){b.selectedHotel(a.key()),location.hash="shop_hotel_offers"},b.activeTickets=ko.computed(function(){return ko.utils.arrayFilter(b.Tickets(),function(a){return null!=a.price()})}),b.price=ko.computed({disposeWhen:function(){return b.categoryDisposed()},read:function(){b.selectedCategory()&&"hotel"==b.selectedCategory().key()&&null!=b.selectedRegionOption()&&null!=b.selectedRoomCategoryOption()&&b.selectedArrivalDate()&&b.selectedDepartureDate()?(console.log("Calling get hotelprices...",b.selectedCategory()),b.setSeasonInfo(null),b.Cities.removeAll(),b.availableTypes.removeAll(),b.loadingPrices(!0),$.ajax(serviceRootURL+"/hotels",{type:"GET",data:{categoryKey:CATEGORY_KEY_HOTEL,regionId:b.selectedRegionOption().id(),roomCatId:b.selectedRoomCategoryOption().id(),fromDateString:b.selectedArrivalDate(),toDateString:b.selectedDepartureDate(),adultCount:b.selectedAdultCount(),children:b.selectedChildCount()>0?b.children():null,packageMode:shoppingcartVM.isPackageMode},dataType:"json",contentType:"application/json",context:{selectedRegionId:b.selectedRegionOption().id(),selectedRegionName:b.selectedRegionOption().value(),selectedRoomCategoryId:b.selectedRoomCategoryOption().id(),selectedRoomCategoryName:b.selectedRoomCategoryOption().value(),selectedArrivalDate:b.selectedArrivalDate(),selectedDepartureDate:b.selectedDepartureDate(),selectedAdultCount:b.selectedAdultCount(),selectedChildCount:b.selectedChildCount(),selectedChildren:b.children()},success:function(a,c,d){if(console.log("hotel prices",a,b.selectedRegionOption(),b.selectedRoomCategoryOption()),null!=b.selectedRegionOption()&&this.selectedRegionId==b.selectedRegionOption().id()&&null!=b.selectedRoomCategoryOption()&&this.selectedRoomCategoryId==b.selectedRoomCategoryOption().id()&&this.selectedArrivalDate==b.selectedArrivalDate()&&this.selectedDepartureDate==b.selectedDepartureDate()&&this.selectedAdultCount==b.selectedAdultCount()&&this.selectedChildCount==b.selectedChildCount()&&this.selectedChildren==b.children()){var e=new Array;if(null!=a&&null!=a.data&&null!=a.data.items&&a.data.items.length>0){for(var f=[],g=0;g<a.data.items.length;g++){var h=a.data.items[g];if(menuVM.dummyHotels().includes(h.sku)){if(null==f[h.place]){var i={id:g,name:h.place,accommodations:[]};f[h.place]=i}f[h.place].accommodations.push(h)}}var j=this;Object.keys(f).forEach(function(a){var b=f[a],a=new hotelCityOptionModel(b,j);e.push(a)})}e=e.sort(function(a,b){return a.value()>b.value()?1:-1}),b.Cities(e),b.setAvailableTypes(),b.Cities().length>0&&b.selectedCity(b.Cities()[0].key()),b.selectType(b.availableTypes()[0]),b.loadingPrices(!1)}else console.log("Hotel prices not found: "+d.responseText)},error:function(a,c,d){b.loadingPrices(!1),500==a.status?(console.log("Error during retrieving price"),showError("Fehler bei Preisermittlung",a,c,d,!0)):console.log("Price not found: "+a.responseText),checkSession(a),b.Cities.removeAll()}})):b.Cities.removeAll()}},b).extend({notify:"notifyWhenChangesStop",rateLimit:200}),b.addToCart=function(a,c){if(console.log("hotel add to card",a),a.hotelTicketModel()){a.hotelTicketModel().setAccommRateTypeKey(b.selectedType().key());var d=ko.mapping.fromJS(ko.mapping.toJS(a.hotelTicketModel()));console.log("created copy",a.hotelTicketModel(),d),shoppingcartVM.addEntry(d,c,CATEGORY_KEY_HOTEL,null,!0)}else shoppingcartVM.addEntry(a.price(),c,CATEGORY_KEY_HOTEL,null,!0)}}function getHotelTooltip(a,b,c){var d="";return d+="<h3>"+a+"</h3>",d+="<p>"+b+"</p>",c&&c.sizes&&c.sizes&&c.sizes[400]&&(d+='<img src="'+c.sizes[400]+'"/>'),d}function localeventViewModel(a){var b=this;abstractContingentViewModel.apply(b,[a]),console.log("localeventViewModel",b,a),b.categoryKeyLowerCase=ko.observable(b.categoryKey().toLowerCase()),b.selectedCategory=categoriesVM.selectedCategory,b.eventFilter=ko.observable(),b.Regions=ko.observableArray([]),b.Products=ko.observableArray([]),b.productsOfAllRegions=ko.observableArray([]),b.regionProducts=ko.observableArray([]),b.selectedRegion=ko.observable(),b.selectedActivity=ko.observable(),b.selectedType=ko.observable(),b.selectedTime=ko.observable(),b.resetEventFilter=function(){b.eventFilter("")},b.resetTimeSelection=function(){b.selectedTime(!1)},b.isActiveProductAvailable=function(a){return null!=ko.utils.arrayFirst(a,function(a){return!!b.selectedProduct()&&a.key()==b.selectedProduct().key()})},b.Activities=ko.computed(function(){var a=[];return ko.utils.arrayForEach(b.regionProducts(),function(c){var d=c.additionalInfo().activities,e=Object.keys(d);e.length>0?e.forEach(function(c){b.addActivity(a,c,d[c])}):b.addActivity(a,-1,i18n.t("shop.localevent.common"))}),a.sort(b.compareActivities),a}),b.compareActivities=function(a,b){return-1===a.key?-1:-1===b.key?1:a.value<b.value?-1:a.value>b.value?1:0},b.addActivity=function(a,c,d){b.containsActivity(a,c)||a.push({key:c,value:d})},b.containsActivity=function(a,b){return a.map(function(a){return a.key}).includes(b)},b.applyTextFilter=function(a){return null!=b.eventFilter()&&b.eventFilter().length>0&&(a=ko.utils.arrayFilter(a,function(a){return-1!=a.localizedValue().toLowerCase().indexOf(b.eventFilter().toLowerCase())})),a},b.applyActivitySelection=function(a){return null!=b.selectedActivity()&&(a=ko.utils.arrayFilter(a,function(a){var c=a.additionalInfo().activities,d=!1,e=Object.keys(c);return e.length>0?e.forEach(function(a){b.selectedActivity()==a&&(d=!0)}):d=-1==b.selectedActivity(),d})),a},b.preselectProduct=function(a){!b.isActiveProductAvailable(a)&&a.length>0&&b.selectProduct(a[0]),0==a.length&&b.selectedProduct(null)},b.ActiveProducts=ko.computed(function(){var a=b.Products();return a=b.applyTextFilter(a),a=b.applyActivitySelection(a),b.preselectProduct(a),a}),b.TimeValue=ko.pureComputed(function(){return""},this),b.availableTypes=ko.computed(function(){return b.selectedProduct()?b.selectedProduct().availableTypes():[]}),b.availableCategories=ko.computed(function(){return b.selectedProduct()&&b.selectedType()&&0!=b.selectedType()?b.isTimeSlotContingent()&&0==b.filterContingentsByDate().length?[]:b.selectedType().availableCategories():[]}),$.getJSON(serviceRootURL+"/options",{categoryKey:b.categoryKey(),optionListKey:"regions",parentOptionListKey:"",parentOptionKey:"",recursive:!1}).done(function(a){var c=$.map(a,function(a){return new optionModel(a)});b.Regions(c),b.Regions().length>0&&b.selectedRegion(b.Regions()[0].key())}).fail(function(a,b,c){checkSession(a),showError("Fehler beim Laden der Regionen",a,b,c)}),b.loadRegionInfo=ko.computed(function(){
null!=b.selectedRegion()&&$.ajax(serviceRootURL+"/options",{type:"GET",data:{categoryKey:b.categoryKey(),optionListKey:"products",parentOptionListKey:"regions",parentOptionKey:b.selectedRegion(),recursive:!0},dataType:"json",contentType:"application/json",context:{selectedRegionKey:b.selectedRegion()},success:function(a,c,d){if(this.selectedRegionKey==b.selectedRegion()){var e=$.map(a,function(a){return new localEventModel(a)});b.regionProducts(e),b.Activities().length>0&&b.selectActivity(b.Activities()[0]),b.Products(e),b.Products().length>0&&b.selectProduct(b.Products()[0],null),b.Products().forEach(function(a){ko.utils.arrayFirst(b.productsOfAllRegions(),function(b){return b.key()==a.key()})||b.productsOfAllRegions.push(a)})}},error:function(a,b,c){checkSession(a),showError("Fehler beim Laden der Produkte",a,b,c)}})},b),b.selectRegion=function(a,c){b.selectedRegion()!=a.key()&&(b.Products.removeAll(),b.selectedProduct(null)),b.selectedRegion(a.key()),b.setRoute("_activity")},b.selectActivity=function(a,c){b.selectedActivity()!=a.key&&b.selectedActivity(a.key),b.setRoute("_product")},b.resetPrice=function(a){null!=a&&a.availableTypes().forEach(function(a){a.availableCategories().forEach(function(a){a.price(null)})})},b.selectProduct=function(a,c){if(!b.selectedProduct()||b.selectedProduct()!=a){if(b.resetPrice(b.selectedProduct()),b.selectedDate(null),b.availableContingents([]),b.selectedDateInt(-1),b.selectedDateInput(null),b.selectedType(!1),b.datepickerSelection().datepicker("setDate",null),a){var d=a.additionalInfo();b.validFrom(d.bergbahnValidFrom),b.validTo(d.bergbahnValidTo),b.productAvailability(JSON.parse(d.bergbahnAvailability)),b.productUseRestrictions(d.bergbahnUseRestrictions),b.resetProductContingents()}else b.validFrom(null),b.validTo(null),b.productAvailability(null),b.productUseRestrictions(null);b.selectedProduct(a),console.log("selectProduct",b.selectedProduct()),b.selectedProduct()&&b.selectedProduct().availableTypes().length>0&&b.selectType(b.selectedProduct().availableTypes()[0]),b.setRoute("_type")}},b.selectType=function(a,c){if(b.selectedType()!=a){b.selectedType(a);var d=b.selectedType().additionalInfo();null==d?(d=b.selectedProduct().additionalInfo(),console.log("Using additionalInfo from base product for restrictions",d)):console.log("Using additionalInfo from type product for restrictions",d),b.validFrom(d.bergbahnValidFrom),b.validTo(d.bergbahnValidTo),b.productAvailability(JSON.parse(d.bergbahnAvailability)),b.productUseRestrictions(d.bergbahnUseRestrictions),b.selectedProduct()&&(b.resetProductContingents(),b.availableContingents([]),b.loadContingentInfo(b.selectedProduct().key()).pipe(function(){if(b.selectedProduct()){if(!b.todayActive()||0!=b.selectedDateInt()&&-1!=b.selectedDateInt())if(!b.tomorrowActive()||1!=b.selectedDateInt()&&-1!=b.selectedDateInt()){if(b.datepickerOptions.maxDate()>=new Date&&(2==b.selectedDateInt()||-1==b.selectedDateInt())){b.selectedDateInt(2);var a=moment(b.datepickerOptions.minDate());if(null!=b.selectedDateInput()&&(a=moment(b.selectedDateInput())),!shoppingcartVM.isPackageMode())if(b.availableContingents()&&b.availableContingents().length>0){var c=ko.utils.arrayFirst(b.availableContingents(),function(b){var c=moment(b.date());return!(!c.isSame(a,"day")&&!c.isAfter(a,"day")||!(b.available()>0||null==b.available()))});a=null!=c?moment(c.date()):null}else a=null;null!=a?(b.datepickerSelection().datepicker("setDate",a.toDate()),b.selectedDate($.datepicker.formatDate(DATE_SERVER_FORMAT,a.toDate())),b.selectedDateInput(b.selectedDate())):(b.datepickerSelection().datepicker("setDate",null),b.selectedDate(null),b.selectedDateInput(null))}}else{b.selectedDateInt(1);var d=new Date;d.setDate(d.getDate()+1),b.selectedDate($.datepicker.formatDate(DATE_SERVER_FORMAT,d))}else b.selectedDateInt(0),b.selectedDate($.datepicker.formatDate(DATE_SERVER_FORMAT,new Date));b.setRoute(b.getSelectDateLocationHash())}}))}},b.selectTime=function(a,c){b.selectedTime(a),b.setRoute(b.getSelectDateLocationHash())},b.resetProductContingents=function(){b.selectedProduct()&&b.selectedProduct().availableTypes().forEach(function(a){a.available(null),a.contingent(null),a.availableCategories().forEach(function(a){a.available(null)})})},b.filterContingentsByDate.subscribe(function(a){a.length>0&&b.selectTime(a[0])}),b.isTimeSlotContingent=ko.computed(function(){if(b.selectedProduct()){return ko.utils.arrayFilter(b.filterContingentsByDate(),function(a){return"00:00:00"!=moment(a.date(),"YYYY-MM-DDTHH:mm:ss").format("HH:mm:ss")}).length>0}return!1}),b.showAsTimeContingent=ko.computed(function(){return!(!b.isTimeSlotContingent()||!b.selectedProduct()||0!==b.selectedProduct().key().indexOf("EVENT.MYSERVICES"))}),b.updateTicketContingents=ko.computed(function(){if(b.isTimeSlotContingent())b.selectedProduct()&&b.selectedType()&&b.selectedTime()&&b.selectedDate()&&(b.selectedType().available(b.selectedTime().available()),b.selectedType().contingent(b.selectedTime().contingent()),b.selectedType().availableCategories().forEach(function(a){b.selectedTime().categoryContingents().forEach(function(b){a.id()==b.id&&a.available(b.available)})}));else if(b.selectedProduct()&&b.selectedType()&&b.selectedDate()){var a=b.filterContingentsByDate();if(null!=a&&a.length>0){var c=a[0];b.selectedType().available(c.available()),b.selectedType().contingent(c.contingent()),b.selectedType().availableCategories().forEach(function(a){c.categoryContingents().forEach(function(c){(a.id()==c.id||b.categoryKey()==CATEGORY_KEY_SPECIAL_EVENT&&null==c.id)&&(a.available(c.available),a.price()&&a.price().availability(c.available))})})}else b.selectedType().availableCategories().forEach(function(a){a.available(0),a.price()&&a.price().availability(0)})}}).extend({throttle:50}),b.price=ko.computed(function(){b.selectedProduct()&&b.selectedDate()&&b.selectedType()&&(b.setSeasonInfo(null),b.selectedType().availableCategories().forEach(function(a){$.ajax(serviceRootURL+"/localeventprice",{type:"GET",data:{categoryKey:b.categoryKey(),regionKey:b.selectedRegion(),eventKey:b.selectedProduct().key(),productKey:a.key(),dateString:b.selectedDate()},dataType:"json",contentType:"application/json",context:{selectedProductKey:a.key(),selectedRegionKey:b.selectedRegion(),ticket:a.key(),selectedDate:b.selectedDate()},success:function(c,d,e){if(null!=c.price){var f=new localEventPriceModel(c),g=b.selectedType().localizedValue()+", "+a.localizedValue();a.additionalInfo()&&a.additionalInfo().eventContingentQuantity&&a.additionalInfo().eventContingentQuantity>1&&(g+=" ("+a.additionalInfo().eventContingentQuantity+"x)"),f.ticketTypeName(g),a.price(f),b.setSeasonInfo(f)}else console.log("Price not found: "+e.responseText),a.price(null)},error:function(b,c,d){500==b.status?(console.log("Error during retrieving price"),showError("Fehler bei Preisermittlung",b,c,d,!0)):console.log("Price not found: "+b.responseText),checkSession(b),a.price(null)}})}))},b);var c=function(a){return a.price().productKey()+"_"+a.price().date()};b.addToCart=function(a,d){var e=b.getMaxAmount(kp.get(a,"price.sku"));if(null!=a.price())if(b.isTimeSlotContingent())a.price(ko.mapping.fromJS(ko.mapping.toJS(a.price()))),a.price().date(b.selectedTime().date()),a.price().isTimeDependingTicket(!0),a.price().availability(b.selectedTime().available());else{var f=b.filterContingentsByDate();null!=f&&f.length>0&&a.price().availability(f[0].available())}for(var g=c(a),h={},i=0;i<shoppingcartVM.entries().length;i++){var j=shoppingcartVM.entries()[i],k=kp.get(j,"categoryKey");if(k==CATEGORY_KEY_LOCAL_EVENT||k==CATEGORY_KEY_SPECIAL_EVENT){var l=c(j);null==h[l]&&(h[l]=[]),h[l].push(j)}}for(var m=Object.keys(h),i=0;i<m.length;i++){var l=m[i];if(g==l){for(var n=h[l],o=0,p=0,q=0;q<n.length;q++){var j=n[q],k=kp.get(j,"categoryKey");kp.get(j,"price.sku")&&(j.price().sku()===a.price().sku()&&(o+=j.quantity()),p=j.price().availability(),k==CATEGORY_KEY_SPECIAL_EVENT&&(null==p||p>SPECIAL_EVENT_LIMIT)&&(p=SPECIAL_EVENT_LIMIT))}if(null!=e&&o+1>e)return showInfo(i18n.t("cart.msg.maxValidationErrorInfo",{ticketName:a.price().productName(),ticketDate:a.price().date(),maxAmount:e})),!1;if(o>0&&null!=p&&o>=p)return showInfo(i18n.t("cart.msg.maxValidationErrorInfo",{ticketName:j.price().productName(),ticketDate:j.price().date(),maxAmount:p})),!1}}if(null!=a.price()){var r=shoppingcartVM.addEntry(a.price(),d,b.categoryKey(),null,null);console.log("Added event to cart",a,r)}},b.getPersonalisationInfo=function(a){var c=b.getEventCategory(a);if(null!=c&&c.additionalInfo()&&null!=c.additionalInfo().personalization.personalisation&&(c.additionalInfo().personalization.personalisation.length>0||"none"==c.additionalInfo().personalization.type))return c.additionalInfo().personalization;var d=b.getBaseProduct(a);return null!=d&&d.additionalInfo()?d.additionalInfo().personalization:null},b.getMinAmount=function(a){var c=b.getEventCategory(a);if(null!=c&&c.additionalInfo())return c.additionalInfo().minAmount;var d=b.getBaseProduct(a);return null!=d&&d.additionalInfo()?d.additionalInfo().minAmount:null},b.getMaxAmount=function(a){var c=b.getEventCategory(a);if(null!=c&&c.additionalInfo())return c.additionalInfo().maxAmount;var d=b.getBaseProduct(a);return null!=d&&d.additionalInfo()?d.additionalInfo().maxAmount:null},b.getBaseProduct=function(a){for(var c=0;c<b.Products().length;c++){var d=b.Products()[c];if(a.startsWith(d.key()+"."))return console.log("Found base product for ",a,d),d}return null},b.getEventCategory=function(a){for(var c=0;c<b.Products().length;c++){var d=b.Products()[c];if(a.startsWith(d.key()+".")&&d.availableTypes())for(var c=0;c<d.availableTypes().length;c++)for(var e=d.availableTypes()[c],f=0;f<e.availableCategories().length;f++){var g=e.availableCategories()[f];if(g.key()==a)return g}}return console.log("Event category not found for ",a),null},b.reloadContingents=function(){null!=b.selectedProduct()&&b.loadContingentInfo(b.selectedProduct().key())},b.presalePeriodEndDate=ko.computed(function(){if(b.selectedProduct()){var a=b.selectedProduct().additionalInfo().presalePeriod;if(null!=a&&a>0)return moment().add(a,"days")}return null}),b.getLeadTimeStartDate=function(){if(b.selectedProduct()){var a=b.selectedProduct().additionalInfo().leadTime;if(null!=a&&0!=a){var c=a.split(";");if(4==c.length){var d=moment().add(c[0],"month").add(c[1],"days").add(c[2],"hours").add(c[3],"minutes");return console.log("Lead time found for ",b.selectedProduct().key(),a,d),d}}}return null},b.handleCategorySpecificDateConfig=function(){var a=b.presalePeriodEndDate();null!=a&&(console.log("presalePeriodEnd",a),b.todayActive()&&a.isBefore(moment(),"day")&&(b.todayActive(!1),console.log("Today disabled because of presale period")),b.tomorrowActive()&&a.isBefore(moment().add(1,"day"),"day")&&(b.tomorrowActive(!1),console.log("Tomorrow disabled because of presale period")),null!=b.datepickerOptions.maxDate()?moment(b.datepickerOptions.maxDate()).isAfter(a,"day")&&b.datepickerOptions.maxDate(a.toDate()):b.datepickerOptions.maxDate(a.toDate()));var c=b.getLeadTimeStartDate();null!=c&&(b.todayActive()&&c.isAfter(moment(),"day")&&(b.todayActive(!1),console.log("Today disabled because of lead time")),b.tomorrowActive()&&c.isAfter(moment().add(1,"day"),"day")&&(b.tomorrowActive(!1),console.log("Tomorrow disabled because of lead time")),null!=b.datepickerOptions.minDate()?moment(b.datepickerOptions.minDate()).isBefore(c,"day")&&(b.datepickerOptions.minDate(c.toDate()),console.log("Datepicker min date set because of lead time")):b.datepickerOptions.minDate(c.toDate()))},b.getSelectDateLocationHash=function(){return b.isTimeSlotContingent()?"_time":"_persons"}}function ParkingViewModel(a){var b=this;abstractContingentViewModel.apply(b,[a]),b.categoryKey(CATEGORY_KEY_PARKING),b.selectedCategory=categoriesVM.selectedCategory,b.availableLocations=ko.observableArray([]),b.availableTicketTypes=ko.observableArray([]),b.availableDurations=ko.observableArray([]),b.availableTickets=ko.observableArray([]),b.selectedLocation=ko.observable(),b.selectedTicketType=ko.observable(),b.selectedDate=ko.observable(),b.selectedDuration=ko.observable(),b.parkingLoading=ko.observable(!1);var c=null;$.getJSON(serviceRootURL+"/options",{categoryKey:b.categoryKey(),optionListKey:"locations",parentOptionListKey:"",parentOptionKey:"",recursive:!1}).done(function(a){console.log("parking options received",a),a&&a.forEach(function(a){var c=new optionModel(a);b.availableLocations.push(c)}),b.availableLocations().length>0&&b.selectLocation(b.availableLocations()[0])}).fail(function(a,b,c){checkSession(a),showError("Fehler beim Laden der Räume",a,b,c)});var d=function(a){b.availableTicketTypes([]),a.additionalInfo()&&a.additionalInfo().ticketTypes&&a.additionalInfo().ticketTypes.forEach(function(a){var c=[];a.durations&&a.durations.forEach(function(a){c.push(a)}),b.availableTicketTypes.push({key:ko.observable(a.key),value:ko.observable(a.name),durations:c})})};b.selectLocation=function(a,c){b.selectedLocation(a),a&&(d(a),b.availableTicketTypes().length>0&&b.selectTicketType(b.availableTicketTypes()[0]))},b.selectTicketType=function(a,c){b.selectedTicketType(a),a.durations?(b.availableDurations(a.durations),b.availableDurations().length>0&&b.selectDuration(b.availableDurations()[0])):b.availableDurations([])},b.selectDuration=function(a,c){if(b.selectedDuration(a),b.setDateRestrictions(a),!b.selectedDate()){var d=$.datepicker.formatDate(DATE_SERVER_FORMAT,new Date);b.selectedDate(d)}},b.setDateRestrictions=function(a){for(var c=0;c<b.selectedLocation().additionalInfo().ticketTypes.length;c++){var d=b.selectedLocation().additionalInfo().ticketTypes[c],e=null;if(b.selectedTicketType().key()===d.key){for(var f=0;f<d.durations.length;f++)b.selectedDuration().key===d.durations[f].key&&(e=d.durations[f].allowedDates);null!=e&&e.length>0?b.allowedDates(e):b.allowedDates(null)}}},b.loadContingent=function(a){null!=c&&c.abort(),c=$.getJSON(serviceRootURL+"/contingent_info",{categoryKey:b.categoryKey(),dateString:b.selectedDate(),productId:b.selectedDuration().product.id}).done(function(d){c=null,d&&d[0]&&d[0].freeSeats?a.contingent(d[0].freeSeats):a.contingent(0),b.parkingLoading(!1)}).fail(function(a,c,d){"abort"!=c&&(console.log("Contingent request failed",a,c,d),b.parkingLoading(!1),checkSession(a),showError("Error loading parking prices",a,c,d))})},b.price=ko.computed({disposeWhen:function(){return b.categoryDisposed()},read:function(){b.selectedDuration()&&b.selectedDate()&&(b.parkingLoading(!0),$.getJSON(serviceRootURL+"/parkingprice",{categoryKey:b.categoryKey(),dateString:b.selectedDate(),productKey:b.selectedDuration().product.sku}).done(function(a){b.availableTickets([]);var c=new TicketModelParking,d=new ParkingPriceModel(a);c.price(d),b.loadContingent(c),b.availableTickets.push(c)}).fail(function(a,c,d){b.availableTickets([]),b.parkingLoading(!1),checkSession(a),showError("Error loading parking prices",a,c,d)}))}},b).extend({throttle:50}),b.reloadContingents=function(){b.availableTickets().length>0&&(b.parkingLoading(!0),b.loadContingent(b.availableTickets()[0]))},b.addToCart=function(a,c){console.log("adding parking to cart",a,c),null!=a.price()&&shoppingcartVM.addEntry(a.price(),c,b.categoryKey(),null,null)}}function publictransportationViewModel(a){var b=this;categoryViewModel.apply(b,[a]),b.selectedCategory=categoriesVM.selectedCategory,b.setVisible(!1)}function railwaySeatReservationViewModel(a){var b=this;categoryViewModel.apply(b,[a]),b.selectedCategory=categoriesVM.selectedCategory,b.Contractors=ko.observableArray([]),b.Froms=ko.observableArray([]),b.Tos=ko.observableArray([]),b.Routes=ko.observableArray([]),b.Types=ko.observableArray([]),b.Catering=ko.observableArray([]),b.CateringOptional=ko.observableArray([]),b.Consumer=ko.observableArray([]),b.PublicTransportationTickets=ko.observableArray([]),b.fromFilter=ko.observable(),b.toFilter=ko.observable(),b.personFilter=ko.observable(),b.selectedFromOption=ko.observable(),b.selectedToOption=ko.observable(),b.selectedContractor=ko.observable(),b.selectedFrom=ko.observable(),b.selectedTo=ko.observable(),b.selectedVia=ko.observable(),b.selectedRoute=ko.observable(),b.selectedType=ko.observable(),b.selectedCatering=ko.observable(),b.selectedCateringOptions=ko.observableArray([]),b.selectedCateringKey=ko.observable(),b.selectedTime=ko.observable(),b.selectedTripId=ko.observable(),b.selectedClass=ko.observable(),b.loadingPrices=ko.observable(!0),b.selectedPersonCount=ko.observable(1),b.customPersonCount=ko.observable(),b.personCountValue=ko.observable(),b.showTrainReservation=ko.observable(!1),b.resetTrainReservationFlag=ko.observable(!1),b.isChecked=function(a){return!(!b.selectedType()||b.selectedType().key()!=a.key()||b.selectedType().tripTypeKey()!=a.tripTypeKey())},b.setShowTrainReservation=function(a){shoppingcartVM.isPackageMode()||b.showTrainReservation(a)},b.resetTrainReservation=function(){b.resetTrainReservationFlag(!0),b.resetTrainReservationFlag(!1),b.setShowTrainReservation(!1),b.selectedDate(null),b.selectedDateInput(null)},b.selectPersonCountInput=function(a,c){var d=c.target.value;null!=d&&d>=1&&d<=5?b.selectedPersonCount(d):c.target.value=""},b.resetFromFilter=function(){b.fromFilter("")},b.resetToFilter=function(){b.toFilter("")},b.resetPersonFilter=function(){b.personFilter("")},b.ContractorValue=ko.pureComputed(function(){if(b.selectedContractor()){var a=getOption(b.Contractors(),b.selectedContractor().key);if(a)return a.value()}return""},this),b.FromValue=ko.pureComputed(function(){var a=getOption(b.ActiveFroms(),b.selectedFrom());return a?(b.selectedFromOption(a),a.value()):""},this),b.ToValue=ko.pureComputed(function(){var a=getOption(b.ActiveTos(),b.selectedTo());return a?(b.selectedToOption(a),a.value()):""},this),b.TypeValue=ko.pureComputed(function(){for(var a=0;a<b.Types().length;a++){var c=b.Types()[a];if(b.selectedType()&&c.key()==b.selectedType().key())return c.tripTypeName()+", "+c.className()}return""},this),b.CateringValue=ko.pureComputed(function(){var a=",",c=", ";if(b.selectedCateringOptions.removeAll(),b.selectedCatering())for(var d=0;d<b.Catering().length;d++){var e=b.Catering()[d];e.isEmptyOption()||e.key()!=b.selectedCatering()||(b.selectedCateringOptions.push(e),c=e.value()+", ",a=e.key()+",")}for(var d=0;d<b.CateringOptional().length;d++){var f=b.CateringOptional()[d];f.isOptionalSelected()&&(b.selectedCateringOptions.push(f),c+=f.value()+", ",a+=f.key()+",")}return b.selectedCateringKey(a.substr(0,a.length-1)),c.substr(0,c.length-2)},this),b.TypeObject=ko.pureComputed(function(){return ko.utils.arrayFirst(b.Types(),function(a){return!!b.selectedType()&&a.key()===b.selectedType().key()})},this),$.getJSON(serviceRootURL+"/options",{categoryKey:CATEGORY_KEY_RAILWAY_SEAT_RESERVATION,optionListKey:"contractors",parentOptionListKey:"",parentOptionKey:"",recursive:!1}).done(function(a){var c=$.map(a,function(a){return new optionModel(a)});b.Contractors(c),console.log("Contractors loaded",a,b.Contractors()),b.Contractors().length>0&&b.selectContractor(b.Contractors()[0])}).fail(function(a,b,c){checkSession(a),showError("Fehler beim Laden der Leistungsträger",a,b,c)}),b.setPresalePeriodToDatePicker=function(){if(void 0!=headerVM.gexPresalePeriod()){moment().add(headerVM.gexPresalePeriod(),"T");b.datepickerOptions.maxDate(headerVM.gexPresalePeriod()),b.datepickerOptions.minDate(moment().toDate())}else if(null!=b.selectedContractor().additionalInfo().presalePeriod&&b.selectedContractor().additionalInfo().presalePeriod>0){moment().add(b.selectedContractor().additionalInfo().presalePeriod,"T");b.datepickerOptions.maxDate(b.selectedContractor().additionalInfo().presalePeriod),b.datepickerOptions.minDate(moment().toDate())}else b.datepickerOptions.maxDate(null),b.datepickerOptions.minDate(null)},b.loadContractorInfo=ko.computed(function(){null!=b.selectedContractor()&&($.getJSON(serviceRootURL+"/options",{categoryKey:CATEGORY_KEY_RAILWAY_SEAT_RESERVATION,optionListKey:"railwayConsumer",parentOptionListKey:"contractors",parentOptionKey:b.selectedContractor().key}).done(function(a){var c=$.map(a,function(a){return new consumerOptionModel(a)});b.Consumer(c)}).fail(function(a,b,c){checkSession(a),showError("Fehler beim Laden der ÖV Altersgruppen",a,b,c)}),$.getJSON(serviceRootURL+"/options",{categoryKey:CATEGORY_KEY_RAILWAY_SEAT_RESERVATION,optionListKey:"types",parentOptionListKey:"contractors",parentOptionKey:b.selectedContractor().key,productId:b.selectedContractor().id?b.selectedContractor().id():null}).done(function(a){var c=$.map(a,function(a){return new bergbahnTypeOptionModel(a)});console.log("Railways types loaded for railwaySeatReservationViewModel"),console.log("Railways types",a,c),b.Types(c),b.Types().length>0&&b.selectType(b.Types()[0])}).fail(function(a,b,c){checkSession(a),showError("Fehler beim Laden der Typen",a,b,c)}),$.getJSON(serviceRootURL+"/options",{categoryKey:CATEGORY_KEY_RAILWAY_SEAT_RESERVATION,optionListKey:"from",parentOptionListKey:"contractors",parentOptionKey:b.selectedContractor().key,sort:!0}).done(function(a){var c=$.map(a,function(a){return new stationOptionModel(a,STATION_TYPE_PUBLICTRANSPORTATION)});b.Froms(c),b.Froms().length>0&&(b.selectedFrom(b.Froms()[0]),console.log("Selected from",b.selectedFrom(),b.Froms()))}).fail(function(a,b,c){checkSession(a),showError("Fehler beim Laden der VONs",a,b,c)}),$.getJSON(serviceRootURL+"/options",{categoryKey:CATEGORY_KEY_RAILWAY_SEAT_RESERVATION,optionListKey:"to",parentOptionListKey:"contractors",parentOptionKey:b.selectedContractor().key,sort:!0}).done(function(a){var c=$.map(a,function(a){return new stationOptionModel(a,STATION_TYPE_PUBLICTRANSPORTATION)});b.Tos(c),b.Tos().length>0&&b.selectTo(b.Tos()[0])}).fail(function(a,b,c){checkSession(a),showError("Fehler beim Laden der NACHs",a,b,c)}),$.getJSON(serviceRootURL+"/options",{categoryKey:CATEGORY_KEY_RAILWAY_SEAT_RESERVATION,optionListKey:"routes",parentOptionListKey:"contractors",parentOptionKey:b.selectedContractor().key,sort:!0}).done(function(a){var c=$.map(a,function(a){return new railwaySeatReservationRouteOptionModel(a)});b.Routes(c),b.Routes().length>0&&b.selectedRoute(b.Routes()[0].key())}).fail(function(a,b,c){checkSession(a),showError("Fehler beim Laden der Routen",a,b,c)}),$.getJSON(serviceRootURL+"/options",{categoryKey:CATEGORY_KEY_RAILWAY_SEAT_RESERVATION,optionListKey:"catering",parentOptionListKey:"contractors",parentOptionKey:b.selectedContractor().key,sort:!0}).done(function(a){var c=[new railwaySeatReservationCateringOptionViewModel({id:-1,localizedValue:i18n.t("shop.railwaySeatReservation.cateringEmptyOption"),key:"EMPTY",isEmptyOption:!0,additionalInfo:{routes:null,cateringCode:"0",optional:!1}})],d=[];for(i=0;i<a.length;i++){var e=new railwaySeatReservationCateringOptionViewModel(a[i]);e.isOptional()?d.push(e):c.push(e)}b.Catering(c),b.CateringOptional(d),b.Catering().length>0&&b.selectedCatering(b.Catering()[0].key())}).fail(function(a,b,c){checkSession(a),showError("Fehler beim Laden der Routen",a,b,c)}))},b),b.checkForPresalePeriodForDatePicker=function(){if(!b.selectedContractor()||null==b.selectedContractor().additionalInfo()||"GEX"!=b.selectedContractor().additionalInfo().contractorKey&&"BEX"!=b.selectedContractor().additionalInfo().contractorKey)b.datepickerOptions.maxDate(null),b.datepickerOptions.minDate(moment().toDate());else{var a=b.selectedContractor().additionalInfo().presalePeriod;b.datepickerOptions.maxDate(a>0?a:null),b.datepickerOptions.minDate(moment().toDate())}},b.selectContractor=function(a,c){b.selectedContractor(a),b.setRoute("_type"),b.checkForPresalePeriodForDatePicker()},b.selectFrom=function(a,c){null!=a&&(b.selectedFrom(a.key()),b.setRoute("_destination"))},b.selectTo=function(a,c){b.selectedTo(a.key()),shoppingcartVM.isPackageMode()?b.setRoute("_catering"):b.setRoute("_personcount")},b.selectType=function(a,c){b.selectedType(a),b.setRoute("_origin")},b.selectCatering=function(a,c){b.selectedCatering(a.key()),b.setRoute("_date")},b.selectPerson=function(a,c){b.selectedPersonCount(a),location.hash="shop_railway_seat_reservation_date"},b.isActiveFromAvailable=function(a){return null!=ko.utils.arrayFirst(a,function(a){return a.key()==b.selectedFrom()})},b.AvailableFroms=ko.computed(function(){var a=b.Froms();return null!=a&&null!=b.TypeObject()&&(a=ko.utils.arrayFilter(a,function(a){return b.TypeObject().isFromStationSupported(a.key())})),a}),b.ActiveFroms=ko.computed(function(){var a=null;return a=null!=b.fromFilter()&&b.fromFilter().length>0?ko.utils.arrayFilter(b.AvailableFroms(),function(a){return-1!=a.value().toLowerCase().indexOf(b.fromFilter().toLowerCase())}):b.AvailableFroms(),!b.isActiveFromAvailable(a)&&a.length>0&&b.selectedFrom(a[0].key()),a}),b.adjustDateSelectionsForConnection=ko.computed(function(){if(b.selectedFrom()&&b.selectedTo()){var a=ko.utils.arrayFirst(b.Routes(),function(a){return a.fromKey()==b.selectedFrom()&&a.toKey()==b.selectedTo()});if(null!=a){var c=$.datepicker.formatDate(DATE_SERVER_FORMAT,new Date),d=new Date;d.setDate(d.getDate()+1),d=$.datepicker.formatDate(DATE_SERVER_FORMAT,d);var e=null;if(null!=b.selectedContractor().additionalInfo()){var f=b.selectedContractor().additionalInfo().presalePeriod;console.log("contractor: ",b.selectedContractor()),console.log("presalePeriod: ",f),console.log("presaleEndDate: ",e),null!=f&&f>0&&(e=new Date,e.setDate(e.getDate()+f),e=$.datepicker.formatDate(DATE_SERVER_FORMAT,e))}var g=$.datepicker.parseDate(DATE_SERVER_FORMAT,c),h=$.datepicker.parseDate(DATE_SERVER_FORMAT,a.toDate());null!=e&&(e=$.datepicker.parseDate(DATE_SERVER_FORMAT,e),console.log("Final presaleEndDate: "+e),moment(h)>moment(e)&&moment(e)>moment(g)&&(h=e),moment(g)>moment(e)&&(h=e)),moment(c)>moment(g)&&(g=$.datepicker.parseDate(DATE_SERVER_FORMAT,c)),console.log("Final validTo: ",h,g),moment(c)>=moment(g)&&moment(c)<=moment(h)?b.todayActive(!0):b.todayActive(!1),moment(d)>=moment(g)&&moment(d)<=moment(h)?b.tomorrowActive(!0):b.tomorrowActive(!1),b.selectedDateInput(null),b.datepickerOptions.minDate(g),b.datepickerOptions.maxDate(h)}}}),b.isActiveToAvailable=function(a){return null!=ko.utils.arrayFirst(a,function(a){return a.key()==b.selectedTo()})},b.AvailableTos=ko.computed(function(){var a=null;return a=null!=b.selectedFrom()?ko.utils.arrayFilter(b.Tos(),function(a){return null!=ko.utils.arrayFirst(b.Routes(),function(c){return c.fromKey()==b.selectedFrom()&&c.toKey()==a.key()})}):b.Tos(),null!=a&&null!=b.TypeObject()&&(a=ko.utils.arrayFilter(a,function(a){return b.TypeObject().isToStationSupported(b.selectedFrom(),a.key())})),a}),b.ActiveTos=ko.computed(function(){var a=null;return a=null!=b.toFilter()&&b.toFilter().length>0?ko.utils.arrayFilter(b.AvailableTos(),function(a){return-1!=a.value().toLowerCase().indexOf(b.toFilter().toLowerCase())}):b.AvailableTos(),!b.isActiveToAvailable(a)&&a.length>0&&b.selectedTo(a[0].key()),a}),b.activeTickets=ko.computed(function(){return ko.utils.arrayFilter(b.PublicTransportationTickets(),function(a){return console.log("activeTicket ",a),null!=a.price()&&(!(null!=b.personFilter()&&b.personFilter().length>0)||-1!=a.price().consumerName().toLowerCase().indexOf(b.personFilter().toLowerCase()))})}),b.getSelectDateLocationHash=function(){return"_train"},b.price=ko.computed({disposeWhen:function(){return b.categoryDisposed()},read:function(){if(null!=b.selectedFrom()&&null!=b.selectedTo()&&b.selectedType()&&b.TypeObject()&&b.selectedDate()&&shoppingcartVM.isPackageMode()){console.log("computing railway seat reservation prices..."),b.setSeasonInfo(null),b.PublicTransportationTickets.removeAll();var a=b.TypeObject();b.loadingPrices(!0),$.ajax(serviceRootURL+"/publictransportationprices",{type:"GET",data:{categoryKey:CATEGORY_KEY_RAILWAY_SEAT_RESERVATION,contractorKey:b.selectedContractor().key,fromKey:b.selectedFrom(),toKey:b.selectedTo(),classKey:a.classKey(),tripTypeKey:a.tripTypeKey(),cateringKey:b.selectedCateringKey(),dateString:b.selectedDate()},dataType:"json",contentType:"application/json",context:{selectedContractor:b.selectedContractor().key,selectedFrom:b.selectedFrom(),selectedTo:b.selectedTo(),selectedClassKey:a.classKey(),selectedTripTypeKey:a.tripTypeKey(),selectedCateringKey:b.selectedCateringKey(),selectedDate:b.selectedDate()},success:function(a,c,d){var e=b.TypeObject();if(this.selectedContractor==b.selectedContractor().key&&this.selectedFrom==b.selectedFrom()&&this.selectedTo==b.selectedTo()&&this.selectedClassKey==e.classKey()&&this.selectedTripTypeKey==e.tripTypeKey()&&this.selectedCateringKey==b.selectedCateringKey()&&this.selectedDate==b.selectedDate()){var f=new Array;new Array;if(null!=a&&a.length>0)for(var g=0;g<a.length;g++){price=new publicTransportationPriceModel(a[g]);var h=ko.utils.arrayFirst(b.Consumer(),function(a){return a.key()===price.consumerKey()});if(null!=h){var i=new ticketModelBergbahn(h,STATION_TYPE_PUBLICTRANSPORTATION);i.price(price),f.push(i),b.setSeasonInfo(price)}else console.log("Consumer not found",price.consumerKey())}b.PublicTransportationTickets(f),b.loadingPrices(!1),console.log("Public transporation tickets loaded",b.PublicTransportationTickets())}else console.log("Public transportation prices not found: "+d.responseText)},error:function(a,c,d){b.loadingPrices(!1),500==a.status?(console.log("Error during retrieving price"),showError("Fehler bei Preisermittlung",a,c,d,!0)):console.log("Public transportation price not found: "+a.responseText),checkSession(a),b.PublicTransportationTickets.removeAll()}})}else b.PublicTransportationTickets.removeAll()}},b).extend({notify:"notifyWhenChangesStop",rateLimit:200}),b.addToCart=function(a,b){var c=shoppingcartVM.addEntry(a.price().seatReservationAddOn(),b,CATEGORY_KEY_RAILWAY_SEAT_RESERVATION,null,!0);for(shoppingcartVM.addEntry(a.price(),b,CATEGORY_KEY_PUBLICTRANSPORTATION,c,!0),i=0;i<a.price().cateringAddOns().length;i++)shoppingcartVM.addEntry(a.price().cateringAddOns()[i],b,CATEGORY_KEY_CATERING,c,!0)},b.getSelectDateLocationHash=function(){return"_train"}}function railwaySeatReservationTimetableViewModel(a){var b=this;categoryViewModel.apply(b,[a]),b.selectedCategory=categoriesVM.selectedCategory,b.Contractors=ko.observableArray([]),b.Froms=ko.observableArray([]),b.Tos=ko.observableArray([]),b.Routes=ko.observableArray([]),b.Types=ko.observableArray([]),b.Catering=ko.observableArray([]),b.CateringOptional=ko.observableArray([]),b.Consumer=ko.observableArray([]),b.PublicTransportationTickets=ko.observableArray([]),b.fromFilter=ko.observable(),b.toFilter=ko.observable(),b.personFilter=ko.observable(),b.selectedFromOption=ko.observable(),b.selectedToOption=ko.observable(),b.selectedContractor=ko.observable(),b.selectedFrom=ko.observable(),b.selectedTo=ko.observable(),b.selectedRoute=ko.observable(),b.selectedType=ko.observable(),b.selectedCatering=ko.observable(),b.selectedCateringOptions=ko.observableArray([]),b.selectedCateringKey=ko.observable(),b.selectedTime=ko.observable(),b.selectedTripId=ko.observable(),b.selectedClass=ko.observable(),b.selectedVia=ko.observable(),b.loadingPrices=ko.observable(!0),b.selectedPersonCount=ko.observable(1),b.customPersonCount=ko.observable(),b.personCountValue=ko.observable(),b.showTrainReservation=ko.observable(!1),b.resetTrainReservationFlag=ko.observable(!1),b.tripTypeText=ko.observable(),b.isChecked=function(a){return!(!b.selectedType()||b.selectedType().key()!=a.key()||b.selectedType().tripTypeKey()!=a.tripTypeKey())},b.setShowTrainReservation=function(a){if(!shoppingcartVM.isPackageMode()){if(a&&void 0==b.tripTypeText())return void console.log("Select route first");b.showTrainReservation(a)}},b.resetTrainReservation=function(){b.resetTrainReservationFlag(!0),b.resetTrainReservationFlag(!1),b.setShowTrainReservation(!1)},b.selectPersonCountInput=function(a,c){var d=c.target.value;null!=d&&d>=1&&d<=5?b.selectedPersonCount(d):c.target.value=""},b.resetFromFilter=function(){b.fromFilter("")},b.resetToFilter=function(){b.toFilter("")},b.resetPersonFilter=function(){
b.personFilter("")},b.ContractorValue=ko.pureComputed(function(){if(b.selectedContractor()){var a=getOption(b.Contractors(),b.selectedContractor().key);if(a)return a.value()}return""},this),b.FromValue=ko.pureComputed(function(){var a=getOption(b.ActiveFroms(),b.selectedFrom());return a?(b.selectedFromOption(a),a.value()):""},this),b.ToValue=ko.pureComputed(function(){var a=getOption(b.ActiveTos(),b.selectedTo());return a?(b.selectedToOption(a),a.value()):""},this),b.TypeValue=ko.pureComputed(function(){for(var a=0;a<b.Types().length;a++){var c=b.Types()[a];if(b.selectedType()&&c.key()==b.selectedType().key())return c.tripTypeName()+", "+c.className()}return""},this),b.CateringValue=ko.pureComputed(function(){var a=",",c=", ";if(b.selectedCateringOptions.removeAll(),b.selectedCatering())for(var d=0;d<b.Catering().length;d++){var e=b.Catering()[d];e.isEmptyOption()||e.key()!=b.selectedCatering()||(b.selectedCateringOptions.push(e),c=e.value()+", ",a=e.key()+",")}for(var d=0;d<b.CateringOptional().length;d++){var f=b.CateringOptional()[d];f.isOptionalSelected()&&(b.selectedCateringOptions.push(f),c+=f.value()+", ",a+=f.key()+",")}return b.selectedCateringKey(a.substr(0,a.length-1)),c.substr(0,c.length-2)},this),b.TypeObject=ko.pureComputed(function(){return ko.utils.arrayFirst(b.Types(),function(a){return!!b.selectedType()&&a.key()===b.selectedType().key()})},this),$.getJSON(serviceRootURL+"/options",{categoryKey:CATEGORY_KEY_RAILWAY_SEAT_RESERVATION_TIMETABLE,optionListKey:"contractors",parentOptionListKey:"",parentOptionKey:"",recursive:!1}).done(function(a){var c=$.map(a,function(a){return new optionModel(a)});b.Contractors(c),console.log("Contractors loaded",a,b.Contractors()),b.Contractors().length>0&&b.selectContractor(b.Contractors()[0])}).fail(function(a,b,c){checkSession(a),showError("Fehler beim Laden der Leistungsträger",a,b,c)}),b.setPresalePeriodToDatePicker=function(){if(void 0!=headerVM.gexPresalePeriod()){moment().add(headerVM.gexPresalePeriod(),"T");b.datepickerOptions.maxDate(headerVM.gexPresalePeriod()),b.datepickerOptions.minDate(moment().toDate())}else if(null!=b.selectedContractor().additionalInfo().presalePeriod&&b.selectedContractor().additionalInfo().presalePeriod>0){moment().add(b.selectedContractor().additionalInfo().presalePeriod,"T");b.datepickerOptions.maxDate(b.selectedContractor().additionalInfo().presalePeriod),b.datepickerOptions.minDate(moment().toDate())}else b.datepickerOptions.maxDate(null),b.datepickerOptions.minDate(null)},b.loadContractorInfo=ko.computed(function(){null!=b.selectedContractor()&&($.getJSON(serviceRootURL+"/options",{categoryKey:CATEGORY_KEY_RAILWAY_SEAT_RESERVATION_TIMETABLE,optionListKey:"railwayConsumer",parentOptionListKey:"contractors",parentOptionKey:b.selectedContractor().key}).done(function(a){var c=$.map(a,function(a){return new consumerOptionModel(a)});b.Consumer(c)}).fail(function(a,b,c){checkSession(a),showError("Fehler beim Laden der ÖV Altersgruppen",a,b,c)}),$.getJSON(serviceRootURL+"/options",{categoryKey:CATEGORY_KEY_RAILWAY_SEAT_RESERVATION_TIMETABLE,optionListKey:"types",parentOptionListKey:"contractors",parentOptionKey:b.selectedContractor().key,productId:b.selectedContractor().id?b.selectedContractor().id():null}).done(function(a){var c=$.map(a,function(a){return b.selectedContractor().additionalInfo().sku.indexOf("PRESTIGE")>0&&(a.additionalInfo.isPrestigeClass=!0),new bergbahnTypeOptionModel(a)});console.log("Railways types loaded for railwaySeatReservationTimetableViewModel"),console.log("Railways types",a,c);for(var d=[],e=0;e<c.length;e++)"T"!=c[e].tripTypeKey()&&d.push(c[e]);console.log("Railways types filtered",a,d),b.Types(d),b.Types().length>0&&b.selectType(b.Types()[0])}).fail(function(a,b,c){checkSession(a),showError("Fehler beim Laden der Typen",a,b,c)}),$.getJSON(serviceRootURL+"/options",{categoryKey:CATEGORY_KEY_RAILWAY_SEAT_RESERVATION_TIMETABLE,optionListKey:"from",parentOptionListKey:"contractors",parentOptionKey:b.selectedContractor().key,sort:!0}).done(function(a){var c=$.map(a,function(a){return new stationOptionModel(a,STATION_TYPE_PUBLICTRANSPORTATION)});b.Froms(c),b.Froms().length>0&&(b.selectedFrom(b.Froms()[0]),console.log("Selected from",b.selectedFrom(),b.Froms()))}).fail(function(a,b,c){checkSession(a),showError("Fehler beim Laden der VONs",a,b,c)}),$.getJSON(serviceRootURL+"/options",{categoryKey:CATEGORY_KEY_RAILWAY_SEAT_RESERVATION_TIMETABLE,optionListKey:"to",parentOptionListKey:"contractors",parentOptionKey:b.selectedContractor().key,sort:!0}).done(function(a){var c=$.map(a,function(a){return new stationOptionModel(a,STATION_TYPE_PUBLICTRANSPORTATION)});b.Tos(c),b.Tos().length>0&&b.selectTo(b.Tos()[0])}).fail(function(a,b,c){checkSession(a),showError("Fehler beim Laden der NACHs",a,b,c)}),$.getJSON(serviceRootURL+"/options",{categoryKey:CATEGORY_KEY_RAILWAY_SEAT_RESERVATION_TIMETABLE,optionListKey:"routes",parentOptionListKey:"contractors",parentOptionKey:b.selectedContractor().key,sort:!0}).done(function(a){var c=$.map(a,function(a){return new railwaySeatReservationRouteOptionModel(a)});b.Routes(c),b.Routes().length>0&&b.selectedRoute(b.Routes()[0].key())}).fail(function(a,b,c){checkSession(a),showError("Fehler beim Laden der Routen",a,b,c)}),$.getJSON(serviceRootURL+"/options",{categoryKey:CATEGORY_KEY_RAILWAY_SEAT_RESERVATION_TIMETABLE,optionListKey:"catering",parentOptionListKey:"contractors",parentOptionKey:b.selectedContractor().key,sort:!0}).done(function(a){var c=[new railwaySeatReservationCateringOptionViewModel({id:-1,localizedValue:i18n.t("shop.railwaySeatReservation.cateringEmptyOption"),key:"EMPTY",isEmptyOption:!0,additionalInfo:{routes:null,cateringCode:"0",optional:!1}})],d=[];for(i=0;i<a.length;i++){var e=new railwaySeatReservationCateringOptionViewModel(a[i]);e.isOptional()?d.push(e):c.push(e)}b.Catering(c),b.CateringOptional(d),b.Catering().length>0&&b.selectedCatering(b.Catering()[0].key())}).fail(function(a,b,c){checkSession(a),showError("Fehler beim Laden der Routen",a,b,c)}))},b),b.checkForPresalePeriodForDatePicker=function(){if(!b.selectedContractor()||null==b.selectedContractor().additionalInfo()||"GEX"!=b.selectedContractor().additionalInfo().contractorKey&&"BEX"!=b.selectedContractor().additionalInfo().contractorKey)b.datepickerOptions.maxDate(null),b.datepickerOptions.minDate(moment().toDate());else{var a=b.selectedContractor().additionalInfo().presalePeriod;b.datepickerOptions.maxDate(a>0?a:null),b.datepickerOptions.minDate(moment().toDate())}},b.selectContractor=function(a,c){b.selectedContractor(a),b.tripTypeText(null),location.hash="shop_railway_seat_reservation_type",b.checkForPresalePeriodForDatePicker()},b.selectFrom=function(a,c){null!=a&&(b.selectedFrom(a.key()),location.hash="shop_railway_seat_reservation_destination")},b.selectTo=function(a,c){b.selectedTo(a.key()),shoppingcartVM.isPackageMode()?location.hash="shop_railway_seat_reservation_catering":location.hash="shop_railway_seat_reservation_personcount"},b.selectType=function(a,c){b.selectedType(a),location.hash="shop_railway_seat_reservation_origin"},b.selectCatering=function(a,c){b.selectedCatering(a.key()),location.hash="shop_railway_seat_reservation_date"},b.selectPerson=function(a,c){b.selectedPersonCount(a),b.setShowTrainReservation(!0)},b.isActiveFromAvailable=function(a){return null!=ko.utils.arrayFirst(a,function(a){return a.key()==b.selectedFrom()})},b.AvailableFroms=ko.computed(function(){var a=b.Froms();return null!=a&&null!=b.TypeObject()&&(a=ko.utils.arrayFilter(a,function(a){return b.TypeObject().isFromStationSupported(a.key())})),a}),b.ActiveFroms=ko.computed(function(){var a=null;return a=null!=b.fromFilter()&&b.fromFilter().length>0?ko.utils.arrayFilter(b.AvailableFroms(),function(a){return-1!=a.value().toLowerCase().indexOf(b.fromFilter().toLowerCase())}):b.AvailableFroms(),!b.isActiveFromAvailable(a)&&a.length>0&&b.selectedFrom(a[0].key()),a}),b.adjustDateSelectionsForConnection=ko.computed(function(){if(b.selectedFrom()&&b.selectedTo()){var a=ko.utils.arrayFirst(b.Routes(),function(a){return a.fromKey()==b.selectedFrom()&&a.toKey()==b.selectedTo()});if(null!=a){var c=$.datepicker.formatDate(DATE_SERVER_FORMAT,new Date),d=new Date;d.setDate(d.getDate()+1),d=$.datepicker.formatDate(DATE_SERVER_FORMAT,d);var e=null;if(null!=b.selectedContractor().additionalInfo()){var f=b.selectedContractor().additionalInfo().presalePeriod;console.log("contractor: ",b.selectedContractor()),console.log("contractorKey: ",b.selectedContractor().additionalInfo().contractorKey),console.log("presalePeriod: ",f),console.log("presaleEndDate: ",e),null!=f&&f>0&&(e=new Date,e.setDate(e.getDate()+f),e=$.datepicker.formatDate(DATE_SERVER_FORMAT,e))}var g=$.datepicker.parseDate(DATE_SERVER_FORMAT,c),h=$.datepicker.parseDate(DATE_SERVER_FORMAT,a.toDate());null!=e&&(e=$.datepicker.parseDate(DATE_SERVER_FORMAT,e),console.log("Final presaleEndDate: "+e),moment(h)>moment(e)&&moment(e)>moment(g)&&(h=e),moment(g)>moment(e)&&(h=e)),moment(c)>moment(g)&&(g=$.datepicker.parseDate(DATE_SERVER_FORMAT,c)),console.log("Final validTo: ",h,g),moment(c)>=moment(g)&&moment(c)<=moment(h)?b.todayActive(!0):b.todayActive(!1),moment(d)>=moment(g)&&moment(d)<=moment(h)?b.tomorrowActive(!0):b.tomorrowActive(!1),b.selectedDateInput(null),b.datepickerOptions.minDate(g),b.datepickerOptions.maxDate(h)}}}),b.isActiveToAvailable=function(a){return null!=ko.utils.arrayFirst(a,function(a){return a.key()==b.selectedTo()})},b.AvailableTos=ko.computed(function(){var a=null;return a=null!=b.selectedFrom()?ko.utils.arrayFilter(b.Tos(),function(a){return null!=ko.utils.arrayFirst(b.Routes(),function(c){return c.fromKey()==b.selectedFrom()&&c.toKey()==a.key()})}):b.Tos(),null!=a&&null!=b.TypeObject()&&(a=ko.utils.arrayFilter(a,function(a){return b.TypeObject().isToStationSupported(b.selectedFrom(),a.key())})),a}),b.ActiveTos=ko.computed(function(){var a=null;return a=null!=b.toFilter()&&b.toFilter().length>0?ko.utils.arrayFilter(b.AvailableTos(),function(a){return-1!=a.value().toLowerCase().indexOf(b.toFilter().toLowerCase())}):b.AvailableTos(),!b.isActiveToAvailable(a)&&a.length>0&&b.selectedTo(a[0].key()),a}),b.activeTickets=ko.computed(function(){return ko.utils.arrayFilter(b.PublicTransportationTickets(),function(a){return console.log("activeTicket ",a),null!=a.price()&&(!(null!=b.personFilter()&&b.personFilter().length>0)||-1!=a.price().consumerName().toLowerCase().indexOf(b.personFilter().toLowerCase()))})}),b.price=ko.computed({disposeWhen:function(){return b.categoryDisposed()},read:function(){if(null!=b.selectedFrom()&&null!=b.selectedTo()&&b.selectedType()&&b.TypeObject()&&b.selectedDate()&&shoppingcartVM.isPackageMode()){console.log("computing railway seat reservation prices..."),b.setSeasonInfo(null),b.PublicTransportationTickets.removeAll();var a=b.TypeObject();b.loadingPrices(!0),$.ajax(serviceRootURL+"/publictransportationprices",{type:"GET",data:{categoryKey:CATEGORY_KEY_RAILWAY_SEAT_RESERVATION,contractorKey:b.selectedContractor().key,fromKey:b.selectedFrom(),toKey:b.selectedTo(),viaKey:b.selectedVia(),classKey:a.classKey(),tripTypeKey:a.tripTypeKey(),cateringKey:b.selectedCateringKey(),dateString:b.selectedDate()},dataType:"json",contentType:"application/json",context:{selectedContractor:b.selectedContractor().key,selectedFrom:b.selectedFrom(),selectedTo:b.selectedTo(),selectedClassKey:a.classKey(),selectedTripTypeKey:a.tripTypeKey(),selectedCateringKey:b.selectedCateringKey(),selectedDate:b.selectedDate()},success:function(a,c,d){var e=b.TypeObject();if(this.selectedContractor==b.selectedContractor().key&&this.selectedFrom==b.selectedFrom()&&this.selectedTo==b.selectedTo()&&this.selectedClassKey==e.classKey()&&this.selectedTripTypeKey==e.tripTypeKey()&&this.selectedCateringKey==b.selectedCateringKey()&&this.selectedDate==b.selectedDate()){var f=new Array;new Array;if(null!=a&&a.length>0)for(var g=0;g<a.length;g++){price=new publicTransportationPriceModel(a[g]);var h=ko.utils.arrayFirst(b.Consumer(),function(a){return a.key()===price.consumerKey()});if(null!=h){var i=new ticketModelBergbahn(h,STATION_TYPE_PUBLICTRANSPORTATION);i.price(price),f.push(i),b.setSeasonInfo(price)}else console.log("Consumer not found",price.consumerKey())}b.PublicTransportationTickets(f),b.loadingPrices(!1),console.log("Public transporation tickets loaded",b.PublicTransportationTickets())}else console.log("Public transportation prices not found: "+d.responseText)},error:function(a,c,d){b.loadingPrices(!1),500==a.status?(console.log("Error during retrieving price"),showError("Fehler bei Preisermittlung",a,c,d,!0)):console.log("Public transportation price not found: "+a.responseText),checkSession(a),b.PublicTransportationTickets.removeAll()}})}else b.PublicTransportationTickets.removeAll()}},b).extend({notify:"notifyWhenChangesStop",rateLimit:200}),b.addToCart=function(a,b){var c=shoppingcartVM.addEntry(a.price().seatReservationAddOn(),b,CATEGORY_KEY_RAILWAY_SEAT_RESERVATION,null,!0);for(shoppingcartVM.addEntry(a.price(),b,CATEGORY_KEY_PUBLICTRANSPORTATION,c,!0),i=0;i<a.price().cateringAddOns().length;i++)shoppingcartVM.addEntry(a.price().cateringAddOns()[i],b,CATEGORY_KEY_CATERING,c,!0)},b.setTimetableDataForConnection=function(a){if(b.selectedVia(null),a.forEach(function(a){"date"==a.name&&b.selectedDate(a.value),"departure_time"==a.name&&b.selectedTime(a.value),"from"==a.name&&b.selectedFrom(a.value),"to"==a.name&&b.selectedTo(a.value),"trip_type"==a.name&&b.selectedTripId(a.value),"class"==a.name&&b.selectedClass(a.value),"class"==a.name&&b.selectedClass(a.value),"travel_to"==a.name&&(b.selectedVia(b.selectedTo()),b.selectedTo(a.value)),"arrive_from"==a.name&&(b.selectedVia(b.selectedFrom()),b.selectedFrom(a.value))}),b.selectedFrom()&&b.selectedTo()&&b.selectedDate()&&b.selectedTime()){var c=b.selectedFrom()+" - "+b.selectedTo();null!=b.selectedVia()&&(c+=" via "+b.selectedVia()),c+=", "+b.selectedDate()+" "+b.selectedTime(),b.tripTypeText(c)}console.log("setTimetableDataForConnection",a,b)},b.getSelectDateLocationHash=function(){return"_train"},b.displayTrainSelectIframe=function(){var a='<iframe src="https://journey.mob.ch/'+subjectLang+'/routing?isB2B=yes"  height="400" width="600"></iframe><a href=\'#\' onclick=\'$("#myModal").hide()\'>Close</a>';$("#miniWindow").html(a),$("#myModal").show()}}function railwaySeatReservationViewModelMrag(a){var b=this;categoryViewModel.apply(b,[a]),b.selectedCategory=categoriesVM.selectedCategory,b.Contractors=ko.observableArray([]),b.Froms=ko.observableArray([]),b.Tos=ko.observableArray([]),b.Routes=ko.observableArray([]),b.Types=ko.observableArray([]),b.Catering=ko.observableArray([]),b.CateringOptional=ko.observableArray([]),b.Consumer=ko.observableArray([]),b.PublicTransportationTickets=ko.observableArray([]),b.fromFilter=ko.observable(),b.toFilter=ko.observable(),b.personFilter=ko.observable(),b.selectedFromOption=ko.observable(),b.selectedToOption=ko.observable(),b.selectedContractor=ko.observable(),b.selectedFrom=ko.observable(),b.selectedTo=ko.observable(),b.selectedVia=ko.observable(),b.selectedRoute=ko.observable(),b.selectedType=ko.observable(),b.selectedCatering=ko.observable(),b.selectedCateringOptions=ko.observableArray([]),b.selectedCateringKey=ko.observable(),b.selectedTime=ko.observable(),b.selectedTripId=ko.observable(),b.selectedClass=ko.observable(),b.ActiveFroms=ko.observableArray([]),b.ActiveTos=ko.observableArray([]),b.loadingPrices=ko.observable(!1),b.resetFromFilter=function(){b.fromFilter("")},b.resetToFilter=function(){b.toFilter("")},b.resetPersonFilter=function(){b.personFilter("")},b.ContractorValue=ko.pureComputed(function(){var a=getOption(b.Contractors(),b.selectedContractor());return a?a.value():""},this),b.FromValue=ko.pureComputed(function(){var a=getOption(b.ActiveFroms(),b.selectedFrom());return a?(b.selectedFromOption(a),a.value()):""},this),b.ToValue=ko.pureComputed(function(){var a=getOption(b.ActiveTos(),b.selectedTo());return a?(b.selectedToOption(a),a.value()):""},this),b.TypeValue=ko.pureComputed(function(){for(var a=0;a<b.Types().length;a++){var c=b.Types()[a];if(c.key()==b.selectedType())return c.tripTypeName()+", "+c.className()}return""},this),b.CateringValue=ko.pureComputed(function(){var a=",",c=", ";if(b.selectedCateringOptions.removeAll(),b.selectedCatering())for(var d=0;d<b.Catering().length;d++){var e=b.Catering()[d];e.isEmptyOption()||e.key()!=b.selectedCatering()||(b.selectedCateringOptions.push(e),c=e.value()+", ",a=e.key()+",")}for(var d=0;d<b.CateringOptional().length;d++){var f=b.CateringOptional()[d];f.isOptionalSelected()&&(b.selectedCateringOptions.push(f),c+=f.value()+", ",a+=f.key()+",")}return b.selectedCateringKey(a.substr(0,a.length-1)),c.substr(0,c.length-2)},this),b.TypeObject=ko.pureComputed(function(){return ko.utils.arrayFirst(b.Types(),function(a){return a.key()===b.selectedType()})},this),$.getJSON(serviceRootURL+"/options",{categoryKey:CATEGORY_KEY_RAILWAY_SEAT_RESERVATION_MRAG,optionListKey:"contractors",parentOptionListKey:"",parentOptionKey:"",recursive:!1}).done(function(a){var c=$.map(a,function(a){return new optionModel(a)});b.Contractors(c),b.Contractors().length>0&&b.selectedContractor(b.Contractors()[0].key())}).fail(function(a,b,c){checkSession(a),showError("Fehler beim Laden der Leistungsträger",a,b,c)}),b.loadContractorInfo=ko.computed(function(){null!=b.selectedContractor()&&($.getJSON(serviceRootURL+"/options",{categoryKey:CATEGORY_KEY_RAILWAY_SEAT_RESERVATION_MRAG,optionListKey:"railwayConsumer",parentOptionListKey:"contractors",parentOptionKey:b.selectedContractor()}).done(function(a){var c=$.map(a,function(a){return new consumerOptionModel(a)});b.Consumer(c)}).fail(function(a,b,c){checkSession(a),showError("Fehler beim Laden der ÖV Altersgruppen",a,b,c)}),$.getJSON(serviceRootURL+"/options",{categoryKey:CATEGORY_KEY_RAILWAY_SEAT_RESERVATION_MRAG,optionListKey:"from",parentOptionListKey:"contractors",parentOptionKey:b.selectedContractor(),sort:!0}).done(function(a){var c=$.map(a,function(a){return new stationOptionModel(a,STATION_TYPE_PUBLICTRANSPORTATION)});b.Froms(c),b.Froms().length>0&&b.selectedFrom(b.Froms()[0].key())}).fail(function(a,b,c){checkSession(a),showError("Fehler beim Laden der VONs",a,b,c)}),$.getJSON(serviceRootURL+"/options",{categoryKey:CATEGORY_KEY_RAILWAY_SEAT_RESERVATION_MRAG,optionListKey:"to",parentOptionListKey:"contractors",parentOptionKey:b.selectedContractor(),sort:!0}).done(function(a){var c=$.map(a,function(a){return new stationOptionModel(a,STATION_TYPE_PUBLICTRANSPORTATION)});b.Tos(c),b.Tos().length>0&&b.selectedTo(b.Tos()[0].key())}).fail(function(a,b,c){checkSession(a),showError("Fehler beim Laden der NACHs",a,b,c)}),$.getJSON(serviceRootURL+"/options",{categoryKey:CATEGORY_KEY_RAILWAY_SEAT_RESERVATION_MRAG,optionListKey:"routes",parentOptionListKey:"contractors",parentOptionKey:b.selectedContractor(),sort:!0}).done(function(a){var c=$.map(a,function(a){return new railwaySeatReservationRouteOptionModel(a)});b.Routes(c),b.Routes().length>0&&b.selectedRoute(b.Routes()[0].key())}).fail(function(a,b,c){checkSession(a),showError("Fehler beim Laden der Routen",a,b,c)}),$.getJSON(serviceRootURL+"/options",{categoryKey:CATEGORY_KEY_RAILWAY_SEAT_RESERVATION_MRAG,optionListKey:"catering",parentOptionListKey:"contractors",parentOptionKey:b.selectedContractor(),sort:!0}).done(function(a){console.log(a);var c=[new railwaySeatReservationCateringOptionViewModel({id:-1,localizedValue:i18n.t("shop.railwaySeatReservation.cateringEmptyOption"),key:"EMPTY",isEmptyOption:!0,additionalInfo:{cateringCode:"0",optional:!1}})],d=[];for(i=0;i<a.length;i++){var e=new railwaySeatReservationCateringOptionViewModel(a[i]);e.isOptional()?d.push(e):c.push(e)}b.Catering(c),b.CateringOptional(d),b.Catering().length>0&&b.selectedCatering(b.Catering()[0].key())}).fail(function(a,b,c){checkSession(a),showError("Fehler beim Laden der Routen",a,b,c)}),$.getJSON(serviceRootURL+"/options",{categoryKey:CATEGORY_KEY_RAILWAY_SEAT_RESERVATION_MRAG,optionListKey:"types",parentOptionListKey:"contractors",parentOptionKey:b.selectedContractor(),sort:!0}).done(function(a){var c=$.map(a,function(a){return new bergbahnTypeOptionModel(a)});b.Types(c),b.Types().length>0&&b.selectedType(b.Types()[0].key())}).fail(function(a,b,c){checkSession(a),showError("Fehler beim Laden der Typen",a,b,c)}))},b),b.selectContractor=function(a,c){b.selectedContractor(a.key()),location.hash="shop_railway_seat_reservation_mrag_origin"},b.selectFrom=function(a,c){null!=a&&(b.selectedFrom(a.key()),location.hash="shop_railway_seat_reservation_mrag_destination")},b.selectTo=function(a,c){b.selectedTo(a.key()),location.hash="shop_railway_seat_reservation_mrag_type"},b.selectType=function(a,c){b.selectedType(a.key()),location.hash="shop_railway_seat_reservation_mrag_catering"},b.selectCatering=function(a,c){b.selectedCatering(a.key()),location.hash="shop_railway_seat_reservation_mrag_date"},b.isActiveFromAvailable=function(a){return null!=ko.utils.arrayFirst(a,function(a){return a.key()==b.selectedFrom()})},b.AvailableFroms=ko.computed(function(){if(null!=b.selectedDate()){return ko.utils.arrayFilter(b.Froms(),function(a){return null!=ko.utils.arrayFirst(b.Routes(),function(c){return c.fromKey()==a.key()&&moment(c.fromDate()).isSameOrBefore(moment(b.selectedDate()))&&moment(b.selectedDate()).isSameOrBefore(moment(c.toDate()))})})}return b.Froms()}),b.ActiveFroms=ko.computed(function(){var a=null;return a=null!=b.fromFilter()&&b.fromFilter().length>0?ko.utils.arrayFilter(b.AvailableFroms(),function(a){return-1!=a.value().toLowerCase().indexOf(b.fromFilter().toLowerCase())}):b.AvailableFroms(),!b.isActiveFromAvailable(a)&&a.length>0&&b.selectedFrom(a[0].key()),a}),b.isActiveToAvailable=function(a){return null!=ko.utils.arrayFirst(a,function(a){return a.key()==b.selectedTo()})},b.AvailableTos=ko.computed(function(){if(null!=b.selectedDate()&&null!=b.selectedFrom()){return ko.utils.arrayFilter(b.Tos(),function(a){return null!=ko.utils.arrayFirst(b.Routes(),function(c){return c.fromKey()==b.selectedFrom()&&c.toKey()==a.key()&&moment(c.fromDate()).isSameOrBefore(moment(b.selectedDate()))&&moment(b.selectedDate()).isSameOrBefore(moment(c.toDate()))})})}return b.Tos()}),b.ActiveTos=ko.computed(function(){var a=null;return a=null!=b.toFilter()&&b.toFilter().length>0?ko.utils.arrayFilter(b.AvailableTos(),function(a){return-1!=a.value().toLowerCase().indexOf(b.toFilter().toLowerCase())}):b.AvailableTos(),!b.isActiveToAvailable(a)&&a.length>0&&b.selectedTo(a[0].key()),a}),b.activeTickets=ko.computed(function(){return ko.utils.arrayFilter(b.PublicTransportationTickets(),function(a){return null!=a.price()&&(!(null!=b.personFilter()&&b.personFilter().length>0)||-1!=a.price().consumerName().toLowerCase().indexOf(b.personFilter().toLowerCase()))})}),b.price=ko.computed({disposeWhen:function(){return b.categoryDisposed()},read:function(){if(console.log("Railway price",b.selectedFrom(),b.selectedTo(),b.selectedType(),b.TypeObject(),b.selectedDate()),null!=b.selectedFrom()&&null!=b.selectedTo()&&b.selectedType()&&b.TypeObject()&&b.selectedDate()){console.log("computing public transportation prices for all railway consumers..."),b.setSeasonInfo(null),b.PublicTransportationTickets.removeAll();var a=b.TypeObject();b.loadingPrices(!0),$.ajax(serviceRootURL+"/publictransportationprices",{type:"GET",data:{categoryKey:CATEGORY_KEY_RAILWAY_SEAT_RESERVATION_MRAG,contractorKey:b.selectedContractor(),fromKey:b.selectedFrom(),toKey:b.selectedTo(),classKey:a.classKey(),tripTypeKey:a.tripTypeKey(),cateringKey:b.selectedCateringKey(),dateString:b.selectedDate()},dataType:"json",contentType:"application/json",context:{selectedContractor:b.selectedContractor(),selectedFrom:b.selectedFrom(),selectedTo:b.selectedTo(),selectedClassKey:a.classKey(),selectedTripTypeKey:a.tripTypeKey(),selectedCateringKey:b.selectedCateringKey(),selectedDate:b.selectedDate()},success:function(a,c,d){var e=b.TypeObject();if(this.selectedContractor==b.selectedContractor()&&this.selectedFrom==b.selectedFrom()&&this.selectedTo==b.selectedTo()&&this.selectedClassKey==e.classKey()&&this.selectedTripTypeKey==e.tripTypeKey()&&this.selectedCateringKey==b.selectedCateringKey()&&this.selectedDate==b.selectedDate()){var f=new Array;new Array;if(null!=a&&a.length>0)for(var g=0;g<a.length;g++){price=new publicTransportationPriceModel(a[g]);var h=ko.utils.arrayFirst(b.Consumer(),function(a){var b=a.key().split(".");return b.length>1?a.key()===price.consumerKey()||b[1]===price.consumerKey():a.key()===price.consumerKey()});if(null!=h){var i=new ticketModelBergbahn(h,STATION_TYPE_PUBLICTRANSPORTATION);i.price(price),f.push(i),b.setSeasonInfo(price)}else console.log("Consumer not found",price.consumerKey())}b.PublicTransportationTickets(f),b.loadingPrices(!1),console.log("Public transporation tickets loaded",b.PublicTransportationTickets())}else console.log("Public transportation prices not found: "+d.responseText)},error:function(a,c,d){b.loadingPrices(!1),500==a.status?(console.log("Error during retrieving price"),showError("Fehler bei Preisermittlung",a,c,d,!0)):console.log("Public transportation price not found: "+a.responseText),checkSession(a),b.PublicTransportationTickets.removeAll()}})}else b.PublicTransportationTickets.removeAll()}},b).extend({notify:"notifyWhenChangesStop",rateLimit:200}),b.addToCart=function(a,b){var c=shoppingcartVM.addEntry(a.price().seatReservationAddOn(),b,CATEGORY_KEY_RAILWAY_SEAT_RESERVATION_MRAG,null,!0);for(shoppingcartVM.addEntry(a.price(),b,CATEGORY_KEY_PUBLICTRANSPORTATION,c,!0),i=0;i<a.price().cateringAddOns().length;i++)shoppingcartVM.addEntry(a.price().cateringAddOns()[i],b,CATEGORY_KEY_CATERING,c,!0)},b.getSelectDateLocationHash=function(){return"_persons"}}function cateringViewModel(a){var b=this;categoryViewModel.apply(b,[a])}function RestaurantViewModel(a){var b=this;categoryViewModel.apply(b,[a]),b.categoryKey(CATEGORY_KEY_RESTAURANT),b.selectedCategory=categoriesVM.selectedCategory,b.availableRegions=ko.observableArray([]),b.selectedRegion=ko.observable(),b.selectedConsumerType=ko.observable(),b.selectedDate=ko.observable(),b.selectedCity=ko.observable(),b.selectedRestaurant=ko.observable(),b.loading=ko.observable(!1),b.availableConsumerTypes=ko.observableArray([{key:"FIT",value:"FIT"},{key:"GRP",value:"Group"}]),b.availableCities=ko.computed(function(){var a=[],c={};if(b.selectedRegion()){var d=b.selectedRegion().additionalInfo().cities;Object.keys(d).forEach(function(b){var e=d[b];c.hasOwnProperty(b)||(c[b]=c,a.push({key:b,value:e[0].cityName}))})}return a}),b.availableRestaurants=ko.computed(function(){var a=[];if(b.selectedRegion()){var c=b.selectedRegion().additionalInfo().cities;Object.keys(c).forEach(function(d){var e=c[d];b.selectedCity()&&b.selectedCity().key!=d||e.forEach(function(b){shoppingcartVM.isPackageMode()&&-1==b.key.indexOf(".TEMPLATE")||a.push(new RestaurantModel(b))})})}return a}),b.availableCategoryTypes=ko.computed(function(){var a=[],c={};if(b.selectedRegion()){var d=b.selectedRegion().additionalInfo().cities;console.log("availableCategoryTypes",b.selectedRegion(),d);Object.keys(d).forEach(function(b){d[b].forEach(function(b){var d=b.categoryName.toLowerCase();c.hasOwnProperty(d)||(c[d]=d,a.push({key:d,value:b.categoryName}))})})}return a}),$.getJSON(serviceRootURL+"/options",{categoryKey:b.categoryKey(),optionListKey:"regions",parentOptionListKey:"",parentOptionKey:"",recursive:!1}).done(function(a){console.log("restaurant options received",a),a&&a.forEach(function(a){var c=new optionModel(a);b.availableRegions.push(c)}),b.availableRegions().length>0&&b.selectRegion(b.availableRegions()[0]),console.log("self.availableRegions()",b.availableRegions())}).fail(function(a,b,c){checkSession(a),showError("Fehler beim Laden der Restaurants",a,b,c)}),b.selectRegion=function(a,c){b.selectedRegion(a),a&&b.availableCities().length>0&&b.selectCity(b.availableCities()[0]),location.hash="shop_restaurant_city"},b.selectCity=function(a,c){b.selectedCity(a),b.availableConsumerTypes().length>0&&b.selectConsumerType(b.availableConsumerTypes()[0]),location.hash="shop_restaurant_consumer_type"},b.selectConsumerType=function(a,c){b.selectedConsumerType(a),location.hash="shop_restaurant_date"},b.selectRestaurant=function(a,c){b.selectedRestaurant(a)},b.getSelectDateLocationHash=function(){return"_restaurants"},b.price=ko.computed({disposeWhen:function(){return b.categoryDisposed()},read:function(){b.selectedDate()&&b.selectedConsumerType()&&(b.loading(!0),b.availableRestaurants().forEach(function(a){$.getJSON(serviceRootURL+"/restaurantprice",{dateString:b.selectedDate(),productKey:a.key}).done(function(c){var d=new RestaurantPriceModel(c);d.consumerType(b.selectedConsumerType().value),d.consumerKey(b.selectedConsumerType().key),a.price(d),console.log("Restaurant price received",c,d)}).fail(function(a,b,c){checkSession(a),showError("Error loading restaurant prices",a,b,c)})}),b.loading(!1))}},b).extend({throttle:50}),b.addToCart=function(a,c){console.log("adding restaurant to cart",a,c),null!=a.price()&&shoppingcartVM.addEntry(a.price(),c,b.categoryKey(),null,null)}}function skipassViewModel(a){var b=this;categoryViewModel.apply(b,[a]),b.selectedCategory=ko.observable(),b.skipassCategoryId=ko.observable(),b.Configs=headerVM.Configs,b.Regions=ko.observableArray([]),b.Consumer=ko.observableArray([]),b.Duration=ko.observableArray([]),b.Tickets=ko.observableArray([]),b.activeTickets=ko.computed(function(){return ko.utils.arrayFilter(b.Tickets(),function(a){return null!=a.price()}).sort(function(a,b){return a.reductionLevel()==b.reductionLevel()?a.consumer().value()>b.consumer().value()?1:-1:(isInt(a.reductionLevel())?parseInt(a.reductionLevel()):0)>(isInt(b.reductionLevel())?parseInt(b.reductionLevel()):0)?1:-1})}),b.AllRegions=ko.observableArray([]),b.skipassDefaultRegion=ko.observable(),b.selectedDuration=ko.observable(),b.selectedRegion=ko.observable(),b.RegionValue=ko.pureComputed(function(){return getOptionValue(b.Regions(),b.selectedRegion())},this),b.DurationValue=ko.pureComputed(function(){for(var a=b.AllRegions(),c=0;c<a.length;c++)if(a[c].key()==b.selectedRegion())return getOptionValue(a[c].durations(),b.selectedDuration());return""},this),$.getJSON(serviceRootURL+"/options",{categoryKey:CATEGORY_KEY_SKIPASS,optionListKey:"regions",parentOptionListKey:"",parentOptionKey:"",recursive:!0}).done(function(a){var c=$.map(a,function(a){return new skiRegionOptionModel(a)});b.AllRegions(c)}).fail(function(a,b,c){checkSession(a),showError("Fehler beim Laden der SKIPASS Regionen",a,b,c)}),b.price=ko.computed(function(){if(b.selectedDuration()&&b.selectedRegion()&&b.selectedDate()){console.log("computing prices for all consumers..."),b.setSeasonInfo(null);for(var a=0;a<b.Tickets().length;a++)$.ajax(serviceRootURL+"/skiprice",{type:"GET",data:{categoryKey:CATEGORY_KEY_SKIPASS,consumerKey:b.Tickets()[a].personKey(),reductionLevel:b.Tickets()[a].reductionLevel(),regionKey:b.selectedRegion(),durationKey:b.selectedDuration(),dateString:b.selectedDate()},dataType:"json",contentType:"application/json",context:{ticket:b.Tickets()[a]},success:function(a,c,d){null!=a.price?(price=new skiPriceModel(a),price.regionKey()==b.selectedRegion()&&price.durationKey()==b.selectedDuration()&&price.date()==b.selectedDate()&&(this.ticket.price(price),b.setSeasonInfo(price))):(console.log("Price not found: "+d.responseText),this.ticket.price(null))},error:function(a,b,c){500==a.status?(console.log("Error during retrieving price"),showError("Fehler bei Preisermittlung",a,b,c,!0)):console.log("Price not found: "+a.responseText),checkSession(a),this.ticket.price(null)}})}},b),b.addToCart=function(a,b){shoppingcartVM.addEntry(a.price(),b,CATEGORY_KEY_SKIPASS,null,!0)},b.skipassDefaultRegion=ko.computed(function(){if(null!=b.skipassCategoryId()&&b.Configs().length>0)for(var a=0;a<b.Configs().length;a++)if("region"==b.Configs()[a].optionKey()&&b.Configs()[a].categoryId()==b.skipassCategoryId()){
var c=b.Configs()[a].optionValueKey();if(b.isRegionAvailable(c))return b.selectedRegion(c),c}},b),b.SpecialTicketDurations=ko.computed(function(){return ko.utils.arrayFilter(b.Duration(),function(a){return null!=a.key()&&a.key().length>0&&(0==a.key().indexOf("P")||0==a.key().indexOf("S")||0==a.key().indexOf("H"))}).sort(function(a,b){var c=a.key(),d=b.key();return 0==c.indexOf("P")&&0==d.indexOf("P")?(c=c.substr(1),d=d.substr(1)):0==c.indexOf("S")&&0==d.indexOf("S")?(c=c.substr(1),d=d.substr(1)):0==c.indexOf("H")&&0==d.indexOf("H")&&(c=c.substr(1),d=d.substr(1)),parseInt(c)>parseInt(d)?1:-1})}),b.CustomDurationsExist=ko.computed(function(){var a=ko.utils.arrayFilter(b.Duration(),function(a){return null!=a.key()&&a.key()>7});return null!=a&&a.length>0}),b.selectDuration=function(a,c){$("#skipassCustomDays").val(""),b.selectedDuration(a),b.selectAvailableDay(),b.setRoute("_date")},b.notSeasonSelected=ko.computed(function(){return!(null!=b.selectedDuration()&&0==b.selectedDuration().indexOf("S"))}),b.selectDurationInput=function(a){var c=ko.utils.arrayFirst(b.Duration(),function(b){return b.key()===a});null!=c?(b.selectedDuration(c.key()),b.selectAvailableDay(),b.setRoute("_date")):(b.durationInput(a),b.selectedDuration(a))},b.durationInput=ko.observable(),b.keyPressed=function(a,c){b.durationInput($("#skipassCustomDays").val())},b.durationListener=ko.computed(function(){b.selectDurationInput(b.durationInput())}).extend({throttle:250}),b.findDuration=function(a,b){return null!=ko.utils.arrayFirst(a,function(a){return a.key()===b})},b.selectRegion=function(a,c){b.selectedRegion(a.key()),b.setRoute("_duration")},b.loadRegionInfo=ko.computed(function(){null!=b.selectedRegion()&&($.getJSON(serviceRootURL+"/options",{categoryKey:CATEGORY_KEY_SKIPASS,optionListKey:"consumer",parentOptionListKey:"regions",parentOptionKey:b.selectedRegion()}).done(function(a){var c=$.map(a,function(a){return new optionModel(a)}),d=$.map(a,function(a){return new ticketModelSkipass(new consumerOptionModel(a))}).filter(function(a){if(""!=a.reductionLevel()&&!categoriesVM.Cashdesk().showSkipassReductionLevel(a.reductionLevel()))return!1;if(null!=categoriesVM.Cashdesk().skipassConsumerGroups()&&""!=categoriesVM.Cashdesk().skipassConsumerGroups()){var b=","+categoriesVM.Cashdesk().skipassConsumerGroups()+",",c=","+a.personKey()+",";return-1!=b.indexOf(c)}return!0});b.Consumer(c),b.Tickets(d)}).fail(function(){console.log("consumer options not found for region "+b.selectedRegion())}),$.getJSON(serviceRootURL+"/options",{categoryKey:CATEGORY_KEY_SKIPASS,optionListKey:"types",parentOptionListKey:"regions",parentOptionKey:b.selectedRegion()}).done(function(a){var c=$.map(a,function(a){return new optionModel(a)});b.Duration(c),b.DurationValue().length>0&&b.selectDuration(b.DurationValue()[0].key())}).fail(function(){console.log("types not found for region "+b.selectedRegion())}))},b),b.isRegionAvailable=function(a){if(null!=categoriesVM.Cashdesk().skipassRegions()&&""!=categoriesVM.Cashdesk().skipassRegions()){var b=","+categoriesVM.Cashdesk().skipassRegions()+",",c=","+a+",";return-1!=b.indexOf(c)}return!0},$.getJSON(serviceRootURL+"/options",{categoryKey:CATEGORY_KEY_SKIPASS,optionListKey:"regions",parentOptionListKey:"",parentOptionKey:""}).done(function(a){var c=$.map(a,function(a){return console.log("Skipass regions",a),new optionModel(a)}).filter(function(a){return b.isRegionAvailable(a.key())});b.Regions(c),b.Regions().length>0&&b.selectRegion(b.Regions()[0])}).fail(function(){console.log("regions not found")}),b.getSelectDateLocationHash=function(){return"_persons"}}function specialeventViewModel(a){var b=this;localeventViewModel.apply(b,[a]),b.categoryKey(CATEGORY_KEY_SPECIAL_EVENT),$.getJSON(serviceRootURL+"/options",{categoryKey:b.categoryKey(),optionListKey:"regions",parentOptionListKey:"",parentOptionKey:"",recursive:!1}).done(function(a){var c=$.map(a,function(a){return new optionModel(a)});b.Regions(c),b.Regions().length>0&&b.selectedRegion(b.Regions()[0].key())}).fail(function(a,b,c){checkSession(a),showError("Fehler beim Laden der Regionen",a,b,c)})}function touroperatorBaseViewModel(){var a=this;a.Touroperators=ko.observableArray([]),a.selectedTouroperator=ko.observable(),a.changeTouroperator=function(){}}function categoryBaseViewModel(){var a=this;a.serviceURL=serviceRootURL+"/categories?categoryType="+CATEGORY_TYPE_CASHDESKSALE+"&imagesAsLinks=true",a.Categories=ko.observableArray([]),a.selectedCategory=ko.observable(),a.skipassVM=ko.observable(),a.bergbahnVM=ko.observable(),a.cargoVM=ko.observable(),a.bergbahnEprVM=ko.observable(),a.railwaySeatReservationVM=ko.observable(),a.railwaySeatReservationTimetableVM=ko.observable(),a.railwaySeatReservationMragVM=ko.observable(),a.publictransportationVM=ko.observable(),a.busVM=ko.observable(),a.daytripsVM=ko.observable(),a.localeventVM=ko.observable(),a.specialeventVM=ko.observable(),a.addonVM=ko.observable(),a.cateringVM=ko.observable(),a.hotelVM=ko.observable(),a.depotVM=ko.observable(),a.parkingVM=ko.observable(),a.autoverladVM=ko.observable(),a.restaurantVM=ko.observable(),a.visibleCategories=ko.computed(function(){return ko.utils.arrayFilter(a.Categories(),function(b){if(null!=b&&"daytrips"==b.key()&&null!=a.daytripsVM()){for(var c=null,d=0;d<a.daytripsVM().Bundles().length;d++){0==a.daytripsVM().Bundles()[d].background()&&b.visible()&&(c=!1)}return null!=c}return null!=b&&b.visible()}).sort(function(a,b){return a.displayShortName()>b.displayShortName()?1:-1})}),a.cleanCategories=function(){null!=a.skipassVM()&&(a.skipassVM().categoryDisposed(!0),a.skipassVM(null)),null!=a.bergbahnVM()&&(a.bergbahnVM().categoryDisposed(!0),a.bergbahnVM(null)),null!=a.cargoVM()&&(a.cargoVM().categoryDisposed(!0),a.cargoVM(null)),null!=a.bergbahnEprVM()&&(a.bergbahnEprVM().categoryDisposed(!0),a.bergbahnEprVM(null)),null!=a.publictransportationVM()&&(a.publictransportationVM().categoryDisposed(!0),a.publictransportationVM(null)),null!=a.railwaySeatReservationVM()&&(a.railwaySeatReservationVM().categoryDisposed(!0),a.railwaySeatReservationVM(null)),null!=a.railwaySeatReservationTimetableVM()&&(a.railwaySeatReservationTimetableVM().categoryDisposed(!0),a.railwaySeatReservationTimetableVM(null)),null!=a.railwaySeatReservationMragVM()&&(a.railwaySeatReservationMragVM().categoryDisposed(!0),a.railwaySeatReservationMragVM(null)),null!=a.busVM()&&(a.busVM().categoryDisposed(!0),a.busVM(null)),null!=a.daytripsVM()&&(a.daytripsVM().categoryDisposed(!0),a.daytripsVM(null)),null!=a.localeventVM()&&(a.localeventVM().categoryDisposed(!0),a.localeventVM(null)),null!=a.specialeventVM()&&(a.specialeventVM().categoryDisposed(!0),a.specialeventVM(null)),null!=a.hotelVM()&&(a.hotelVM().categoryDisposed(!0),a.hotelVM(null)),null!=a.depotVM()&&(a.depotVM().categoryDisposed(!0),a.depotVM(null)),null!=a.parkingVM()&&(a.parkingVM().categoryDisposed(!0),a.parkingVM(null)),null!=a.autoverladVM()&&(a.autoverladVM().categoryDisposed(!0),a.autoverladVM(null)),null!=a.restaurantVM()&&(a.restaurantVM().categoryDisposed(!0),a.restaurantVM(null))},a.selectCategory=function(b){a.selectedCategory()&&a.selectedCategory().key().toUpperCase()===CATEGORY_KEY_RAILWAY_SEAT_RESERVATION&&b.key().toUpperCase()===CATEGORY_KEY_RAILWAY_SEAT_RESERVATION&&null!=a.railwaySeatReservationVM()&&(a.railwaySeatReservationVM().setShowTrainReservation(!1),a.railwaySeatReservationVM().selectedDateInput(null)),null!=a.railwaySeatReservationVM()&&a.railwaySeatReservationVM().selectedDate(null),a.selectedCategory()&&a.selectedCategory().key().toUpperCase()===CATEGORY_KEY_RAILWAY_SEAT_RESERVATION_TIMETABLE&&b.key().toUpperCase()===CATEGORY_KEY_RAILWAY_SEAT_RESERVATION_TIMETABLE&&null!=a.railwaySeatReservationTimetableVM()&&(a.railwaySeatReservationTimetableVM().setShowTrainReservation(!1),a.railwaySeatReservationTimetableVM().selectedDateInput(null)),a.selectedCategory()&&a.selectedCategory().key().toUpperCase()===CATEGORY_KEY_RAILWAY_SEAT_RESERVATION_MRAG&&b.key().toUpperCase()===CATEGORY_KEY_RAILWAY_SEAT_RESERVATION_MRAG&&null!=a.railwaySeatReservationMragVM()&&a.railwaySeatReservationMragVM().selectedDateInput(null),null!=a.railwaySeatReservationMragVM()&&a.railwaySeatReservationMragVM().selectedDate(null),a.selectedCategory(b),0===location.hash.indexOf("#shop")&&(location.hash="shop_"+b.key())},a.initCategory=function(b){var c=b.key.toLowerCase();if(console.log("initCategory",c,b),"skipass"==c){var d=new categoryModel({id:b.id,key:c,url:"#"+c,name:"Skipass",dataVersion:b.dataVersion,config:b.config,cms:b.cms,isDepending:b.isDepending});return a.skipassVM(new skipassViewModel(d)),a.skipassVM().selectedCategory=a.selectedCategory,a.skipassVM().skipassCategoryId(b.id),d}if("bergbahn"==c){var e=new categoryModel({id:b.id,key:c,url:"#"+c,name:"Bergbahn",dataVersion:b.dataVersion,config:b.config,cms:b.cms,isDepending:b.isDepending});return a.bergbahnVM(new bergbahnViewModel(e)),e}if("cargo"==c){var f=new categoryModel({id:b.id,key:c,url:"#"+c,name:"Cargo",dataVersion:b.dataVersion,config:b.config,cms:b.cms,isDepending:b.isDepending});return a.cargoVM(new cargoViewModel(f)),f}if("bergbahn_epr"==c){var e=new categoryModel({id:b.id,key:c,url:"#"+c,name:"BergbahnEpr",dataVersion:b.dataVersion,config:b.config,cms:b.cms,isDepending:b.isDepending});return a.bergbahnEprVM(new bergbahnEprViewModel(e)),e}if("publictransportation"==c){var g=new categoryModel({id:b.id,key:c,url:"#"+c,name:"PublicTransportation",dataVersion:b.dataVersion,config:b.config,cms:b.cms,isDepending:b.isDepending});return a.publictransportationVM(new publictransportationViewModel(g)),g}if(c.toUpperCase()==CATEGORY_KEY_RAILWAY_SEAT_RESERVATION){var h=new categoryModel({id:b.id,key:c,url:"#"+c,name:"RailwaySeatReservation",dataVersion:b.dataVersion,config:b.config,cms:b.cms,isDepending:b.isDepending});return a.railwaySeatReservationVM(new railwaySeatReservationViewModel(h)),h}if(c.toUpperCase()==CATEGORY_KEY_RAILWAY_SEAT_RESERVATION_TIMETABLE)return railwaySeatReservationTimetableModel=new categoryModel({id:b.id,key:c,url:"#"+c,name:"RailwaySeatReservationTimetable",dataVersion:b.dataVersion,config:b.config,cms:b.cms,isDepending:b.isDepending}),a.railwaySeatReservationTimetableVM(new railwaySeatReservationTimetableViewModel(railwaySeatReservationTimetableModel)),railwaySeatReservationTimetableModel;if(c.toUpperCase()==CATEGORY_KEY_RAILWAY_SEAT_RESERVATION_MRAG){var i=new categoryModel({id:b.id,key:c,url:"#"+c,name:"RailwaySeatReservationMrag",dataVersion:b.dataVersion,config:b.config,cms:b.cms,isDepending:b.isDepending});return a.railwaySeatReservationMragVM(new railwaySeatReservationViewModelMrag(i)),i}if("bus"==c){var j=new categoryModel({id:b.id,key:c,url:"#"+c,name:"Bus",dataVersion:b.dataVersion,config:b.config,cms:b.cms,isDepending:b.isDepending});return a.busVM(new busViewModel(j)),j}if("daytrips"==c){var k=new categoryModel({id:b.id,key:c,url:"#"+c,name:"Daytrips",dataVersion:b.dataVersion,config:b.config,cms:b.cms,isDepending:b.isDepending});return a.daytripsVM(new daytripsViewModel(k)),k}if("addon"==c){var l=new categoryModel({id:b.id,key:c,url:"#"+c,name:"Addon",dataVersion:b.dataVersion,config:b.config,cms:b.cms,isDepending:b.isDepending});return a.addonVM(new addonViewModel(l)),l}if("localevent"==c){var m=new categoryModel({id:b.id,key:c,url:"#"+c,name:"LocalEvent",dataVersion:b.dataVersion,config:b.config,cms:b.cms,isDepending:b.isDepending});return a.localeventVM(new localeventViewModel(m)),m}if("specialevent"==c){var n=new categoryModel({id:b.id,key:c,url:"#"+c,name:"SpecialEvent",dataVersion:b.dataVersion,config:b.config,cms:b.cms,isDepending:b.isDepending});return a.specialeventVM(new specialeventViewModel(n)),n}if("catering"==c){var o=new categoryModel({id:b.id,key:c,url:"#"+c,name:"Catering",dataVersion:b.dataVersion,config:b.config,cms:b.cms,isDepending:b.isDepending});return a.cateringVM(new cateringViewModel(o)),o}if("hotel"==c){var p=new categoryModel({id:b.id,key:c,url:"#"+c,name:"Hotel",dataVersion:b.dataVersion,config:b.config,cms:b.cms,isDepending:b.isDepending});return a.hotelVM(new hotelViewModel(p)),p}if(c==CATEGORY_KEY_DEPOT.toLowerCase()){var q=new categoryModel({id:b.id,key:c,url:"#"+c,name:"Depot",dataVersion:b.dataVersion,config:b.config,cms:b.cms,isDepending:b.isDepending});return a.depotVM(new depotViewModel(q)),q}if(c==CATEGORY_KEY_AUTOVERLAD.toLowerCase())return autoverladCategoryModel=new categoryModel({id:b.id,key:c,url:"#"+c,name:"Autoverlad",dataVersion:b.dataVersion,config:b.config,cms:b.cms,isDepending:b.isDepending}),a.autoverladVM(new autoverladViewModel(autoverladCategoryModel)),autoverladCategoryModel;if(c==CATEGORY_KEY_PARKING.toLowerCase()){console.log("CATEGORY_KEY_PARKING",b);var r=new categoryModel({id:b.id,key:c,url:"#"+c,name:"Parking",dataVersion:b.dataVersion,config:b.config,cms:b.cms,isDepending:b.isDepending});return a.parkingVM(new ParkingViewModel(r)),r}if(c==CATEGORY_KEY_RESTAURANT.toLowerCase()){console.log("CATEGORY_KEY_RESTAURANT",b);var r=new categoryModel({id:b.id,key:c,url:"#"+c,name:"Restaurant",dataVersion:b.dataVersion,config:b.config,cms:b.cms,isDepending:b.isDepending});return a.restaurantVM(new RestaurantViewModel(r)),console.log("self.restaurantVM()",a.restaurantVM()),r}},a.getCategory=function(b){if(null!=b){if((b=b.toUpperCase())==CATEGORY_KEY_SKIPASS)return a.skipassVM();if(b==CATEGORY_KEY_BERGBAHN)return a.bergbahnVM();if(b==CATEGORY_KEY_CARGO)return a.cargoVM();if(b==CATEGORY_KEY_BERGBAHN_EPR)return a.bergbahnEprVM();if(b==CATEGORY_KEY_PUBLICTRANSPORTATION)return a.publictransportationVM();if(b==CATEGORY_KEY_RAILWAY_SEAT_RESERVATION)return a.railwaySeatReservationVM();if(b==CATEGORY_KEY_RAILWAY_SEAT_RESERVATION_TIMETABLE)return a.railwaySeatReservationTimetableVM();if(b==CATEGORY_KEY_RAILWAY_SEAT_RESERVATION_MRAG)return a.railwaySeatReservationMragVM();if(b==CATEGORY_KEY_BUS)return a.busVM();if(b==CATEGORY_KEY_DAYTRIPS)return a.daytripsVM();if(b==CATEGORY_KEY_ADDON)return a.addonVM();if(b==CATEGORY_KEY_LOCAL_EVENT)return a.localeventVM();if(b==CATEGORY_KEY_SPECIAL_EVENT)return a.specialeventVM();if(b==CATEGORY_KEY_CATERING)return a.cateringVM();if(b==CATEGORY_KEY_HOTEL)return a.hotelVM();if(b==CATEGORY_KEY_DEPOT)return a.depotVM();if(b==CATEGORY_KEY_PARKING)return a.parkingVM();if(b==CATEGORY_KEY_AUTOVERLAD)return a.autoverladVM();if(b==CATEGORY_KEY_RESTAURANT)return a.restaurantVM()}},a.isBergbahn=function(a){return null!=a&&a==CATEGORY_KEY_BERGBAHN},a.onCloseCheckout=function(){null!=a.daytripsVM&&null!=a.daytripsVM()&&a.daytripsVM().onCloseCheckout(),null!=a.localeventVM&&null!=a.localeventVM()&&"localevent"==a.selectedCategory().key()&&a.localeventVM().reloadContingents(),null!=a.depotVM&&null!=a.depotVM()&&"depot"==a.selectedCategory().key()&&a.depotVM().reloadContingents(),null!=a.specialeventVM&&null!=a.specialeventVM()&&a.selectedCategory().key(),null!=a.railwaySeatReservationVM&&null!=a.railwaySeatReservationVM()&&a.railwaySeatReservationVM().resetTrainReservation(),null!=a.railwaySeatReservationTimetableVM&&null!=a.railwaySeatReservationTimetableVM()&&a.railwaySeatReservationTimetableVM().resetTrainReservation(),null!=a.railwaySeatReservationMragVM&&a.railwaySeatReservationMragVM(),null!=a.parkingVM&&null!=a.parkingVM()&&"parking"==a.selectedCategory().key()&&a.parkingVM().reloadContingents(),null!=a.autoverladVM&&null!=a.autoverladVM()&&"autoverlad"==a.selectedCategory().key()&&a.autoverladVM().reloadContingents()}}function categoriesViewModel(){var a=this;a.Cashdesk=ko.observable(),categoryBaseViewModel.apply(a,[]),a.loadCategories=function(){console.log("loadCashdesk started"),$.getJSON(serviceRootURL+"/cashdesk",function(b){a.Cashdesk(new cashdeskModel(b)),$.getJSON(a.serviceURL,function(b){setTimeout(headerVM.startPrinterServerAutomatically,1e3),console.log("Mapping categories: ",b);var c=$.map(b,function(b){return a.initCategory(b)});a.Categories(c);var d=a.visibleCategories();if(d.length>0){d[0].key().toUpperCase()==CATEGORY_KEY_PUBLICTRANSPORTATION&&d.length>1?a.selectCategory(d[1]):a.selectCategory(d[0])}$("#shop-spinner").hide()}).fail(function(a,b,c){checkSession(a),showError("Fehler beim Laden der Produktkategorien",a,b,c),$("#shop-spinner").hide()})}).fail(function(a,b,c){checkSession(a),showError("Fehler beim Laden des aktuellen Cash Desks",a,b,c),$("#shop-spinner").hide()})},a.loadCategories()}function seasonViewModel(){var a=this;a.seasonName=ko.computed(function(){if(null!=categoriesVM.selectedCategory()){var a=categoriesVM.getCategory(categoriesVM.selectedCategory().key());if(null!=a&&a.seasonName())return a.seasonName()}return null}),a.hint=ko.computed(function(){var a=null;if(null!=categoriesVM.selectedCategory()){var b=categoriesVM.selectedCategory();return null!=b.cms()&&b.cms().hint&&(a=b.cms().hint),a}return null})}function categoriesContainerViewModel(){var a=this;a.skipassVM=categoriesVM.skipassVM,a.bergbahnVM=categoriesVM.bergbahnVM,a.cargoVM=categoriesVM.cargoVM,a.bergbahnEprVM=categoriesVM.bergbahnEprVM,a.railwaySeatReservationVM=categoriesVM.railwaySeatReservationVM,a.railwaySeatReservationTimetableVM=categoriesVM.railwaySeatReservationTimetableVM,a.railwaySeatReservationMragVM=categoriesVM.railwaySeatReservationMragVM,a.busVM=categoriesVM.busVM,a.daytripsVM=categoriesVM.daytripsVM,a.localeventVM=categoriesVM.localeventVM,a.specialeventVM=categoriesVM.specialeventVM,a.hotelVM=categoriesVM.hotelVM,a.depotVM=categoriesVM.depotVM,a.parkingVM=categoriesVM.parkingVM,a.autoverladVM=categoriesVM.autoverladVM,a.restaurantVM=categoriesVM.restaurantVM}function abstractShoppingCartViewModel(){var a=this;a.commentPlaceholder=ko.observable(i18n.t("cart.comment")),a.internalId=ko.observable(0),a.isGroupReservation=ko.observable(!1),a.entries=ko.observableArray([]),a.comment=ko.observable(),a.quantity=ko.observable(),a.maxQuantity=ko.observable(null),a.rebateRules=headerVM.rebateRules,a.validateItems=function(){for(var b=$.datepicker.formatDate(DATE_SERVER_FORMAT,new Date),c=0;c<a.entries().length;c++){var d=a.entries()[c],e=d.price().date();if(moment(e)<moment(b)&&d.categoryKey()!==CATEGORY_KEY_CARGO)return showInfo(i18n.t("cart.msg.dateValidationError")),!1}for(var c=0;c<a.rebateRules().length;c++){if(!a.rebateRules()[c].validate(a.entries()))return!1}for(var c=0;c<a.entries().length;c++){var d=a.entries()[c],e=d.price().date(),f=kp.get(d,"categoryKey"),g=kp.get(d,"price.sku");if((f==CATEGORY_KEY_LOCAL_EVENT||f==CATEGORY_KEY_SPECIAL_EVENT)&&g){var h=categoriesVM.getCategory(f);if(minAmount=h.getMinAmount(g),maxAmount=h.getMaxAmount(g),f==CATEGORY_KEY_SPECIAL_EVENT&&(null==maxAmount||maxAmount>SPECIAL_EVENT_LIMIT)&&(maxAmount=SPECIAL_EVENT_LIMIT),null!=minAmount&&d.quantity()<minAmount)return showInfo(i18n.t("cart.msg.minValidationError",{ticketName:d.price().productName(),ticketDate:d.price().date(),minAmount:minAmount})),!1;if(null!=maxAmount&&d.quantity()>maxAmount)return showInfo(i18n.t("cart.msg.maxValidationError",{ticketName:d.price().productName(),ticketDate:d.price().date(),maxAmount:maxAmount})),!1}}for(var i={},c=0;c<a.entries().length;c++){var d=a.entries()[c],j=d.price().productKey()+"_"+d.price().date();null==i[j]&&(i[j]=[]),i[j].push(d)}var k=!0;return Object.keys(i).forEach(function(a){for(var b=i[a],c=0,d=0,e=0;e<b.length;e++){var f=b[e],g=kp.get(f,"categoryKey"),h=kp.get(f,"price.sku");g!=CATEGORY_KEY_LOCAL_EVENT&&g!=CATEGORY_KEY_SPECIAL_EVENT||!h||(c+=f.quantity(),d=f.price().availability(),g==CATEGORY_KEY_SPECIAL_EVENT&&(null==d||d>SPECIAL_EVENT_LIMIT)&&(d=SPECIAL_EVENT_LIMIT))}c>0&&(c<0&&(showInfo(i18n.t("cart.msg.minValidationError",{ticketName:f.price().productName(),ticketDate:f.price().date(),minAmount:0})),k=!1),null!=d&&c>d&&(showInfo(i18n.t("cart.msg.maxValidationError",{ticketName:f.price().productName(),ticketDate:f.price().date(),maxAmount:d})),k=!1))}),k},a.getNextId=function(){return a.internalId(a.internalId()+1),a.internalId()},a.addEntry=function(b,c,d,e,f){return a.addEntryQuantity(b,c,d,e,1,!1,f)},a.addEntryQuantity=function(b,c,d,e,f,g,h){if(0!=f){for(var i,j=null==g||!g,k=!1,l=0;l<a.entries().length;l++){var m=a.entries()[l];if(m.price().categoryKey()==b.categoryKey()&&m.price().matches(b)&&m.price().date()==b.date()){"undefined"!=typeof shoppingcartVM&&null!==shoppingcartVM&&shoppingcartVM.isPackageMode()||m.price().supportsQuantity()&&m.quantity(m.quantity()+f),i=m,k=!0;break}}if(0==k){var n=new cartEntryModel(d,b,a.getNextId(),e,function(b){a.entryQuantityChanged(b)});if(null!=h&&1==h){var o=a.getValidationAmount(n);null!=o?n.quantity(o):n.quantity(f)}else n.quantity(f);a.entries.push(n),i=n}return j&&a.applyRebateRules(i),i}},a.applyRebateRules=function(b,c){for(var d=0;d<a.rebateRules().length;d++){a.rebateRules()[d].apply(b,a.entries(),a,c)}},a.getValidationAmount=function(b){for(var c,d=0;d<a.rebateRules().length;d++){var e=a.rebateRules()[d];if(null!=(c=e.getValidationAmount(b))&&null!=e.triggerPersongroups&&null!=e.triggerPersongroups()&&1==e.triggerPersongroups().length)return c}return null},a.removeDependingEntries=function(b){console.log("removeDependingEntries("+b.internalId()+")");for(var c=a.entries().slice(0),d=0;d<c.length;d++){var e=c[d];console.log("removeDependingEntries("+b.internalId()+"): checking entry: "+e.internalId()),e.parentEntry()&&e.parentEntry().internalId()==b.internalId()&&(console.log("removeDependingEntries("+b.internalId()+"): removing entry: "+e.internalId()),a.removeEntry(e,null,null,!0)),e.price()&&e.price().reservationId()&&b.price().reservationId()&&e.price().reservationId()==b.price().reservationId()&&(console.log("removeDependingEntries("+b.internalId()+"): removing entry: "+e.internalId()),a.removeEntry(e,null,null,!0))}},a.removeEntry=function(b,c,d,e){var f=null==d||!d;e||a.removeDependingEntries(b),a.entries.remove(b),f&&a.applyRebateRules(b)},a.incrEntryQuantity=function(b){var c=b,d=(c.price().date(),kp.get(c,"categoryKey")),e=kp.get(c,"price.sku");if((d==CATEGORY_KEY_LOCAL_EVENT||d==CATEGORY_KEY_SPECIAL_EVENT)&&e){var f=categoriesVM.getCategory(d);if(maxAmount=f.getMaxAmount(e),d==CATEGORY_KEY_SPECIAL_EVENT&&(null==maxAmount||maxAmount>SPECIAL_EVENT_LIMIT)&&(maxAmount=SPECIAL_EVENT_LIMIT),null!=maxAmount&&c.quantity()+1>maxAmount)return showInfo(i18n.t("cart.msg.maxValidationErrorInfo",{ticketName:c.price().productName(),ticketDate:c.price().date(),maxAmount:maxAmount})),!1}if(d==CATEGORY_KEY_PUBLICTRANSPORTATION&&e&&(maxAmount=PUBLIC_TRANSPORTATION_LIMIT,c.quantity()+1>maxAmount))return showInfo(i18n.t("cart.msg.maxValidationErrorInfoPT",{maxAmount:maxAmount})),!1;var g=0;maxAmount=0;var c=b,d=kp.get(c,"categoryKey"),e=kp.get(c,"price.sku"),h=REBATE_RULE_INCREASE_AMOUNT;if(d!=CATEGORY_KEY_LOCAL_EVENT&&d!=CATEGORY_KEY_SPECIAL_EVENT||!e||(g+=c.quantity()+1,maxAmount=c.price().availability(),d==CATEGORY_KEY_SPECIAL_EVENT&&(null==maxAmount||maxAmount>SPECIAL_EVENT_LIMIT)&&(maxAmount=SPECIAL_EVENT_LIMIT)),g>0&&null!=maxAmount&&g>maxAmount)return showInfo(i18n.t("cart.msg.maxValidationErrorInfo",{ticketName:c.price().productName(),ticketDate:c.price().date(),maxAmount:maxAmount})),!1;b.quantity(b.quantity()+1),a.applyRebateRules(b,h)},a.entryQuantityChanged=function(b){var c=REBATE_RULE_CHANGE_QUANTITY;a.maxQuantity()&&null!=a.maxQuantity()&&a.quantity()>a.maxQuantity()&&b.quantity(b.quantity()-(a.quantity()-a.maxQuantity())),a.applyRebateRules(b,c)},a.onEnter=function(b,c){return 13!==c.keyCode||(a.entryQuantityChanged(b.entry),!1)},a.decrEntryQuantity=function(b,c,d,e){var f=b,g=(f.price().date(),kp.get(f,"categoryKey")),h=kp.get(f,"price.sku");if(g==CATEGORY_KEY_LOCAL_EVENT&&h){var i=categoriesVM.getCategory(g);if(minAmount=i.getMinAmount(h),null!=minAmount&&f.quantity()-1>=0&&f.quantity()-1<minAmount)return showInfo(i18n.t("cart.msg.minValidationErrorInfo",{ticketName:f.price().productName(),ticketDate:f.price().date(),minAmount:minAmount})),!1}var j=0;minAmount=0;var f=b,g=kp.get(f,"categoryKey"),h=kp.get(f,"price.sku"),k=REBATE_RULE_DECREASE_AMOUNT;if(g==CATEGORY_KEY_LOCAL_EVENT&&h&&(j+=f.quantity()-1),j>=0&&null!=minAmount&&j<minAmount)return showInfo(i18n.t("cart.msg.minValidationError",{ticketName:f.price().productName(),ticketDate:f.price().date(),minAmount:minAmount})),!1;var l=null!=d?d:1,m=null==e||!e;b.quantity()>l?(b.quantity(b.quantity()-l),m&&a.applyRebateRules(b,k)):b.quantity()==l&&a.removeEntry(b,c,e,!0)},a.reset=function(b){a.entries.removeAll(),a.comment("")},a.removeEntriesWithReservationId=function(b){a.entries().slice(0).forEach(function(c){c.price().hasOwnProperty("reservationId")&&c.price().reservationId()==b&&a.entries.remove(c)})},a.compareCartItems=function(a,b){return moment(a.price().date()).isSame(moment(b.price().date()))?a.price().categoryKey()==b.price().categoryKey()?null!=a.price().reductionLevel()&&""!=a.price().reductionLevel()||null==b.price().reductionLevel()||""==b.price().reductionLevel()?null!=b.price().reductionLevel()&&""!=b.price().reductionLevel()||null==a.price().reductionLevel()||""==a.price().reductionLevel()?a.price().productKey()!=b.price().productKey()?a.price().productKey()>b.price().productKey()?1:-1:a.price().price()!=b.price().price()?a.price().price()<b.price().price()?1:-1:a.price().consumerKey()&&b.price().consumerKey()?a.price().consumerKey()>b.price().consumerKey()?1:-1:0:1:-1:a.price().categoryKey()>b.price().categoryKey()?1:-1:moment(a.price().date()).isAfter(moment(b.price().date()))?1:-1}}function shoppingCartViewModel(){var a=this;abstractShoppingCartViewModel.apply(a,[]),a.preSelectedTourguide=ko.observable(),a.requestOrderId=ko.observable(),a.orderType=ko.observable(),a.paymentType=ko.observable(),a.customerPaymentType=ko.observable(headerVM.customerPaymentTypes()[0]),a.title=ko.observable(),a.isPackageMode=ko.observable(),a.eprAddonSelected=ko.computed(function(){if(menuVM.cartMode()==SHOPPING_CART_MODE_PACKAGE||menuVM.cartMode()==SHOPPING_CART_MODE_PACKAGE_ADDITIONAL||menuVM.cartMode()==SHOPPING_CART_MODE_PACKAGE_OPTIONAL||menuVM.cartMode()==SHOPPING_CART_MODE_PACKAGE_COMPENSATORY)return!0;for(var b=0;b<a.entries().length;b++){var c=a.entries()[b];if(c.categoryKey()==CATEGORY_KEY_BUNDLE&&0==c.price().sku().indexOf("DAYTRIPS.EPR")){var d=!1;if(c.price().bundleItems().forEach(function(a){a.price()instanceof eprAddonPriceModel&&a.price().eprSelected()&&(d=!0)}),!d)return!1}}return!0}),a.computeMode=ko.computed(function(){menuVM.cartMode()==SHOPPING_CART_MODE_PACKAGE||menuVM.cartMode()==SHOPPING_CART_MODE_PACKAGE_ADDITIONAL||menuVM.cartMode()==SHOPPING_CART_MODE_PACKAGE_OPTIONAL||menuVM.cartMode()==SHOPPING_CART_MODE_PACKAGE_COMPENSATORY?(a.title(i18n.t("cart.title."+SHOPPING_CART_MODE_PACKAGE)),a.isPackageMode(!0)):(a.title(i18n.t("cart.title."+SHOPPING_CART_MODE_DEFAULT)),a.isPackageMode(!1))},a),a.partnerId=ko.computed(function(){return null},a),a.skipassShowReduced=ko.computed(function(){return null!=categoriesVM&&null!=categoriesVM.Cashdesk&&null!=categoriesVM.Cashdesk()&&categoriesVM.Cashdesk().skipassShowReduced()},a),a.setDefaultOrderType=ko.computed(function(){headerVM.hasOrderTypeCashdesk()?a.orderType(CONTRACT_ORDERTYPE_CASHDESK):headerVM.hasOrderTypeReservation&&a.orderType(CONTRACT_ORDERTYPE_RESERVATION)},a),a.setDefaultPaymentType=ko.computed(function(){headerVM.hasPaymentTypeInvoice()?a.paymentType(PAYMENTTYPE_INVOICE):headerVM.hasPaymentTypeStoreCredits()?a.paymentType(PAYMENTTYPE_STORECREDITS):headerVM.hasPaymentTypeCreditCard()&&a.paymentType(PAYMENTTYPE_CREDITCARD)},a),a.totalPrice=ko.computed(function(){for(var b=0,c=0,d=0;d<a.entries().length;d++){var e=a.entries()[d];b+=e.totalPrice(),c+=e.quantity()}return a.quantity(c),b},a),a.totalForeignPrice=ko.computed(function(){return a.totalPrice()*headerVM.selectedRateValue()},a),a.showCheckout=function(){a.validateItems()&&(menuVM.cartMode()==SHOPPING_CART_MODE_PACKAGE?(showPackage(menuVM.cartCallbackId()),packageVM.addServices(a.entries()),location.hash="packages/"+menuVM.cartCallbackId()):menuVM.cartMode()==SHOPPING_CART_MODE_PACKAGE_ADDITIONAL?(showPackage(menuVM.cartCallbackId()),packageVM.addAdditionalServices(a.entries()),location.hash="packages/"+menuVM.cartCallbackId()):menuVM.cartMode()==SHOPPING_CART_MODE_PACKAGE_OPTIONAL?(showPackage(menuVM.cartCallbackId()),packageVM.addOptionalServices(a.entries()),location.hash="packages/"+menuVM.cartCallbackId()):menuVM.cartMode()==SHOPPING_CART_MODE_PACKAGE_COMPENSATORY?(showPackage(menuVM.cartCallbackId()),packageVM.addCompensatoryServices(a.entries()),location.hash="packages/"+menuVM.cartCallbackId()):$(".shop-checkout").load("assets/shop-checkout.html",function(){$.getScript("assets/js/jungfrau.min.js"),checkoutVM=new shopCheckoutViewModel(a.entries(),a.comment(),a.paymentType(),a.preSelectedTourguide(),a.requestOrderId(),a.orderType(),a.customerPaymentType()),ko.applyBindings(checkoutVM,document.getElementById("shopCheckout")),$("#shopCheckout").modal("show")}))}}function getShoppingcartVM(){return null==shoppingcartVM&&(shoppingcartVM=new shoppingCartViewModel),shoppingcartVM}function initCategories(){null==categoriesVM?(categoriesVM=new categoriesViewModel,categoriesContainerVM=categoriesContainerViewModel(),seasonVM=new seasonViewModel):($("#shop-spinner").hide(),categoriesVM.selectedCategory(categoriesVM.selectedCategory()))}function getTouroperatorVM(){return null==touroperatorVM&&(touroperatorVM=new touroperatorBaseViewModel),touroperatorVM}function cleanContainer(){var a=ko.utils.domNodeDisposal.cleanExternalData;ko.utils.domNodeDisposal.cleanExternalData=function(){},ko.cleanNode(document.getElementById("container")),ko.utils.domNodeDisposal.cleanExternalData=a}function showShop(){cleanContainer(),$("#container").load("assets/shop.html",function(){$(this).trigger("shop_dom_loaded"),ko.applyBindings(getTouroperatorVM(),document.getElementById("operatorSelection")),initCategories(),categoriesVM.railwaySeatReservationVM()&&categoriesVM.railwaySeatReservationVM().setShowTrainReservation(!1),categoriesVM.railwaySeatReservationTimetableVM()&&categoriesVM.railwaySeatReservationTimetableVM().setShowTrainReservation(!1),categoriesVM.railwaySeatReservationMragVM(),ko.applyBindings(getShoppingcartVM(),document.getElementById("shoppingCart")),ko.applyBindings(categoriesVM,document.getElementById("categoryInfo")),ko.applyBindings(categoriesContainerVM,document.getElementById("categoriesContainer")),ko.applyBindings(seasonVM,document.getElementById("seasonInfo")),$.getScript("assets/js/jungfrau.min.js")})}function addShopRoutes(a){a.get("#shop",function(){a.setNavigationVisibleState(!0),showShop(),$("#container").on("shop_dom_loaded",function(){$(".back-btn").hide(),responsiveDisplay("")})}),a.get("#shop_category",function(){0==$(".shop-container").length?(showShop(),$("#container").on("shop_dom_loaded",function(){responsiveDisplay("category")})):responsiveDisplay("category")}),a.get("#shop_bergbahn",function(){0==$(".shop-container").length?(showShop(),$("#container").on("shop_dom_loaded",function(){responsiveDisplay("bergbahn")})):responsiveDisplay("bergbahn")}),a.get("#shop_cargo",function(){0==$(".shop-container").length?(showShop(),$("#container").on("shop_dom_loaded",function(){responsiveDisplay("cargo")})):responsiveDisplay("cargo")}),a.get("#shop_bergbahn_destination",function(){0==$(".shop-container").length?(showShop(),$("#container").on("shop_dom_loaded",function(){responsiveDisplay("bergbahn_destination")})):responsiveDisplay("bergbahn_destination")}),a.get("#shop_bergbahn_via",function(){0==$(".shop-container").length?(showShop(),$("#container").on("shop_dom_loaded",function(){responsiveDisplay("bergbahn_via")})):responsiveDisplay("bergbahn_via")}),a.get("#shop_bergbahn_type",function(){0==$(".shop-container").length?(showShop(),$("#container").on("shop_dom_loaded",function(){responsiveDisplay("bergbahn_type")})):responsiveDisplay("bergbahn_type")}),a.get("#shop_bergbahn_date",function(){0==$(".shop-container").length?(showShop(),$("#container").on("shop_dom_loaded",function(){responsiveDisplay("bergbahn_date")})):responsiveDisplay("bergbahn_date")}),
a.get("#shop_bergbahn_persons",function(){0==$(".shop-container").length?(showShop(),$("#container").on("shop_dom_loaded",function(){responsiveDisplay("bergbahn_persons")})):responsiveDisplay("bergbahn_persons")}),a.get("#shop_publictransportation_mode",function(){0==$(".shop-container").length?(showShop(),$("#container").on("shop_dom_loaded",function(){responsiveDisplay("publictransportation_mode")})):responsiveDisplay("publictransportation_mode")}),a.get("#shop_publictransportation_persons",function(){0==$(".shop-container").length?(showShop(),$("#container").on("shop_dom_loaded",function(){responsiveDisplay("bergbahn_persons")})):responsiveDisplay("bergbahn_persons")}),a.get("#shop_bergbahn_epr",function(){0==$(".shop-container").length?(showShop(),$("#container").on("shop_dom_loaded",function(){responsiveDisplay("bergbahn_epr")})):responsiveDisplay("bergbahn_epr")}),a.get("#shop_bergbahn_epr_destination",function(){0==$(".shop-container").length?(showShop(),$("#container").on("shop_dom_loaded",function(){responsiveDisplay("bergbahn_epr_destination")})):responsiveDisplay("bergbahn_epr_destination")}),a.get("#shop_bergbahn_epr_date",function(){0==$(".shop-container").length?(showShop(),$("#container").on("shop_dom_loaded",function(){responsiveDisplay("bergbahn_epr_date")})):responsiveDisplay("bergbahn_epr_date")}),a.get("#shop_bergbahn_epr_trainup",function(){0==$(".shop-container").length?(showShop(),$("#container").on("shop_dom_loaded",function(){responsiveDisplay("bergbahn_epr_trainup")})):responsiveDisplay("bergbahn_epr_trainup")}),a.get("#shop_bergbahn_epr_traindown",function(){0==$(".shop-container").length?(showShop(),$("#container").on("shop_dom_loaded",function(){responsiveDisplay("bergbahn_epr_traindown")})):responsiveDisplay("bergbahn_epr_traindown")}),a.get("#shop_bergbahn_epr_persons",function(){0==$(".shop-container").length?(showShop(),$("#container").on("shop_dom_loaded",function(){responsiveDisplay("bergbahn_epr_persons")})):responsiveDisplay("bergbahn_epr_persons")}),a.get("#shop_railway_seat_reservation",function(){0==$(".shop-container").length?(showShop(),$("#container").on("shop_dom_loaded",function(){responsiveDisplay("railway_seat_reservation")})):responsiveDisplay("railway_seat_reservation")}),a.get("#shop_railway_seat_reservation_origin",function(){0==$(".shop-container").length?(showShop(),$("#container").on("shop_dom_loaded",function(){responsiveDisplay("railway_seat_reservation_origin")})):responsiveDisplay("railway_seat_reservation_origin")}),a.get("#shop_railway_seat_reservation_destination",function(){0==$(".shop-container").length?(showShop(),$("#container").on("shop_dom_loaded",function(){responsiveDisplay("railway_seat_reservation_destination")})):responsiveDisplay("railway_seat_reservation_destination")}),a.get("#shop_railway_seat_reservation_type",function(){0==$(".shop-container").length?(showShop(),$("#container").on("shop_dom_loaded",function(){responsiveDisplay("railway_seat_reservation_type")})):responsiveDisplay("railway_seat_reservation_type")}),a.get("#shop_railway_seat_reservation_catering",function(){0==$(".shop-container").length?(showShop(),$("#container").on("shop_dom_loaded",function(){responsiveDisplay("railway_seat_reservation_catering")})):responsiveDisplay("railway_seat_reservation_catering")}),a.get("#shop_railway_seat_reservation_date",function(){0==$(".shop-container").length?(showShop(),$("#container").on("shop_dom_loaded",function(){responsiveDisplay("railway_seat_reservation_date")})):responsiveDisplay("railway_seat_reservation_date")}),a.get("#shop_railway_seat_reservation_persons",function(){0==$(".shop-container").length?(showShop(),$("#container").on("shop_dom_loaded",function(){responsiveDisplay("railway_seat_reservation_persons")})):responsiveDisplay("railway_seat_reservation_persons")}),a.get("#shop_railway_seat_reservation_personcount",function(){0==$(".shop-container").length?(showShop(),$("#container").on("shop_dom_loaded",function(){responsiveDisplay("railway_seat_reservation_personcount")})):responsiveDisplay("railway_seat_reservation_personcount")}),a.get("#shop_railway_seat_reservation_train",function(){0==$(".shop-container").length?(showShop(),$("#container").on("shop_dom_loaded",function(){responsiveDisplay("railway_seat_reservation_train")})):responsiveDisplay("railway_seat_reservation_train")}),a.get("#shop_railway_seat_reservation_timetable",function(){0==$(".shop-container").length?(showShop(),$("#container").on("shop_dom_loaded",function(){responsiveDisplay("railway_seat_reservation_timetable")})):responsiveDisplay("railway_seat_reservation_timetable")}),a.get("#shop_railway_seat_reservation_timetable_origin",function(){0==$(".shop-container").length?(showShop(),$("#container").on("shop_dom_loaded",function(){responsiveDisplay("railway_seat_reservation_timetable_origin")})):responsiveDisplay("railway_seat_reservation_timetable_origin")}),a.get("#shop_railway_seat_reservation_timetable_destination",function(){0==$(".shop-container").length?(showShop(),$("#container").on("shop_dom_loaded",function(){responsiveDisplay("railway_seat_reservation_timetable_destination")})):responsiveDisplay("railway_seat_reservation_timetable_destination")}),a.get("#shop_railway_seat_reservation_timetable_type",function(){0==$(".shop-container").length?(showShop(),$("#container").on("shop_dom_loaded",function(){responsiveDisplay("railway_seat_reservation_timetable_type")})):responsiveDisplay("railway_seat_reservation_timetable_type")}),a.get("#shop_railway_seat_reservation_timetable_catering",function(){0==$(".shop-container").length?(showShop(),$("#container").on("shop_dom_loaded",function(){responsiveDisplay("railway_seat_reservation_timetable_catering")})):responsiveDisplay("railway_seat_reservation_timetable_catering")}),a.get("#shop_railway_seat_reservation_timetable_date",function(){0==$(".shop-container").length?(showShop(),$("#container").on("shop_dom_loaded",function(){responsiveDisplay("railway_seat_reservation_timetable_date")})):responsiveDisplay("railway_seat_reservation_timetable_date")}),a.get("#shop_railway_seat_reservation_timetable_persons",function(){0==$(".shop-container").length?(showShop(),$("#container").on("shop_dom_loaded",function(){responsiveDisplay("railway_seat_reservation_timetable_persons")})):responsiveDisplay("railway_seat_reservation_timetable_persons")}),a.get("#shop_railway_seat_reservation_timetable_personcount",function(){0==$(".shop-container").length?(showShop(),$("#container").on("shop_dom_loaded",function(){responsiveDisplay("railway_seat_reservation_timetable_personcount")})):responsiveDisplay("railway_seat_reservation_timetable_personcount")}),a.get("#shop_railway_seat_reservation_timetable_train",function(){0==$(".shop-container").length?(showShop(),$("#container").on("shop_dom_loaded",function(){responsiveDisplay("railway_seat_reservation_timetable_train")})):responsiveDisplay("railway_seat_reservation_timetable_train")}),a.get("#shop_railway_seat_reservation_mrag",function(){0==$(".shop-container").length?(showShop(),$("#container").on("shop_dom_loaded",function(){responsiveDisplay("railway_seat_reservation_mrag")})):responsiveDisplay("railway_seat_reservation_mrag")}),a.get("#shop_railway_seat_reservation_mrag_origin",function(){0==$(".shop-container").length?(showShop(),$("#container").on("shop_dom_loaded",function(){responsiveDisplay("railway_seat_reservation_mrag_origin")})):responsiveDisplay("railway_seat_reservation_mrag_origin")}),a.get("#shop_railway_seat_reservation_mrag_destination",function(){0==$(".shop-container").length?(showShop(),$("#container").on("shop_dom_loaded",function(){responsiveDisplay("railway_seat_reservation_mrag_destination")})):responsiveDisplay("railway_seat_reservation_mrag_destination")}),a.get("#shop_railway_seat_reservation_mrag_type",function(){0==$(".shop-container").length?(showShop(),$("#container").on("shop_dom_loaded",function(){responsiveDisplay("railway_seat_reservation_mrag_type")})):responsiveDisplay("railway_seat_reservation_mrag_type")}),a.get("#shop_railway_seat_reservation_mrag_catering",function(){0==$(".shop-container").length?(showShop(),$("#container").on("shop_dom_loaded",function(){responsiveDisplay("railway_seat_reservation_mrag_catering")})):responsiveDisplay("railway_seat_reservation_mrag_catering")}),a.get("#shop_railway_seat_reservation_mrag_date",function(){0==$(".shop-container").length?(showShop(),$("#container").on("shop_dom_loaded",function(){responsiveDisplay("railway_seat_reservation_mrag_date")})):responsiveDisplay("railway_seat_reservation_mrag_date")}),a.get("#shop_railway_seat_reservation_mrag_persons",function(){0==$(".shop-container").length?(showShop(),$("#container").on("shop_dom_loaded",function(){responsiveDisplay("railway_seat_reservation_mrag_persons")})):responsiveDisplay("railway_seat_reservation_mrag_persons")}),a.get("#shop_railway_seat_reservation_mrag_personcount",function(){0==$(".shop-container").length?(showShop(),$("#container").on("shop_dom_loaded",function(){responsiveDisplay("railway_seat_reservation_mrag_personcount")})):responsiveDisplay("railway_seat_reservation_mrag_personcount")}),a.get("#shop_railway_seat_reservation_mrag_train",function(){0==$(".shop-container").length?(showShop(),$("#container").on("shop_dom_loaded",function(){responsiveDisplay("railway_seat_reservation_mrag_train")})):responsiveDisplay("railway_seat_reservation_mrag_train")}),a.get("#shop_catering_persons",function(){0==$(".shop-container").length?(showShop(),$("#container").on("shop_dom_loaded",function(){responsiveDisplay("railway_seat_reservation_persons")})):responsiveDisplay("railway_seat_reservation_persons")}),a.get("#shop_bus",function(){0==$(".shop-container").length?(showShop(),$("#container").on("shop_dom_loaded",function(){responsiveDisplay("bus")})):responsiveDisplay("bus")}),a.get("#shop_bus_busup",function(){0==$(".shop-container").length?(showShop(),$("#container").on("shop_dom_loaded",function(){responsiveDisplay("bus_busup")})):responsiveDisplay("bus_busup")}),a.get("#shop_bus_downdate",function(){0==$(".shop-container").length?(showShop(),$("#container").on("shop_dom_loaded",function(){responsiveDisplay("bus_downdate")})):responsiveDisplay("bus_downdate")}),a.get("#shop_bus_busdown",function(){0==$(".shop-container").length?(showShop(),$("#container").on("shop_dom_loaded",function(){responsiveDisplay("bus_busdown")})):responsiveDisplay("bus_busdown")}),a.get("#shop_bus_addon",function(){0==$(".shop-container").length?(showShop(),$("#container").on("shop_dom_loaded",function(){responsiveDisplay("bus_addon")})):responsiveDisplay("bus_addon")}),a.get("#shop_bus_persons",function(){0==$(".shop-container").length?(showShop(),$("#container").on("shop_dom_loaded",function(){responsiveDisplay("bus_persons")})):responsiveDisplay("bus_persons")}),a.get("#shop_skipass",function(){0==$(".shop-container").length?(showShop(),$("#container").on("shop_dom_loaded",function(){responsiveDisplay("skipass")})):responsiveDisplay("skipass")}),a.get("#shop_skipass_duration",function(){0==$(".shop-container").length?(showShop(),$("#container").on("shop_dom_loaded",function(){responsiveDisplay("skipass_duration")})):responsiveDisplay("skipass_duration")}),a.get("#shop_skipass_date",function(){0==$(".shop-container").length?(showShop(),$("#container").on("shop_dom_loaded",function(){responsiveDisplay("skipass_date")})):responsiveDisplay("skipass_date")}),a.get("#shop_skipass_persons",function(){0==$(".shop-container").length?(showShop(),$("#container").on("shop_dom_loaded",function(){responsiveDisplay("skipass_persons")})):responsiveDisplay("skipass_persons")}),a.get("#shop_localevent",function(){0==$(".shop-container").length?(showShop(),$("#container").on("shop_dom_loaded",function(){responsiveDisplay("localevent")})):responsiveDisplay("localevent")}),a.get("#shop_localevent_activity",function(){0==$(".shop-container").length?(showShop(),$("#container").on("shop_dom_loaded",function(){responsiveDisplay("localevent_activity")})):responsiveDisplay("localevent")}),a.get("#shop_localevent_product",function(){0==$(".shop-container").length?(showShop(),$("#container").on("shop_dom_loaded",function(){responsiveDisplay("localevent_product")})):responsiveDisplay("localevent_product")}),a.get("#shop_localevent_type",function(){0==$(".shop-container").length?(showShop(),$("#container").on("shop_dom_loaded",function(){responsiveDisplay("localevent_type")})):responsiveDisplay("localevent_type")}),a.get("#shop_localevent_date",function(){0==$(".shop-container").length?(showShop(),$("#container").on("shop_dom_loaded",function(){responsiveDisplay("localevent_date")})):responsiveDisplay("localevent_date")}),a.get("#shop_localevent_time",function(){0==$(".shop-container").length?(showShop(),$("#container").on("shop_dom_loaded",function(){responsiveDisplay("localevent_time")})):responsiveDisplay("localevent_time")}),a.get("#shop_localevent_persons",function(){0==$(".shop-container").length?(showShop(),$("#container").on("shop_dom_loaded",function(){responsiveDisplay("localevent_persons")})):responsiveDisplay("localevent_persons")}),a.get("#shop_specialevent",function(){0==$(".shop-container").length?(showShop(),$("#container").on("shop_dom_loaded",function(){responsiveDisplay("specialevent")})):responsiveDisplay("specialevent")}),a.get("#shop_specialevent_product",function(){0==$(".shop-container").length?(showShop(),$("#container").on("shop_dom_loaded",function(){responsiveDisplay("specialevent_product")})):responsiveDisplay("specialevent_product")}),a.get("#shop_specialevent_type",function(){0==$(".shop-container").length?(showShop(),$("#container").on("shop_dom_loaded",function(){responsiveDisplay("specialevent_type")})):responsiveDisplay("specialevent_type")}),a.get("#shop_specialevent_date",function(){0==$(".shop-container").length?(showShop(),$("#container").on("shop_dom_loaded",function(){responsiveDisplay("specialevent_date")})):responsiveDisplay("specialevent_date")}),a.get("#shop_specialevent_time",function(){0==$(".shop-container").length?(showShop(),$("#container").on("shop_dom_loaded",function(){responsiveDisplay("specialevent_time")})):responsiveDisplay("specialevent_time")}),a.get("#shop_specialevent_persons",function(){0==$(".shop-container").length?(showShop(),$("#container").on("shop_dom_loaded",function(){responsiveDisplay("specialevent_persons")})):responsiveDisplay("specialevent_persons")}),a.get("#shop_daytrips",function(){0==$(".shop-container").length?(showShop(),$("#container").on("shop_dom_loaded",function(){responsiveDisplay("daytrips")})):responsiveDisplay("daytrips")}),a.get("#shop_daytrips_addon",function(){0==$(".shop-container").length?(showShop(),$("#container").on("shop_dom_loaded",function(){responsiveDisplay("daytrips_addon")})):responsiveDisplay("daytrips_addon")}),a.get("#shop_daytrips_date",function(){0==$(".shop-container").length?(showShop(),$("#container").on("shop_dom_loaded",function(){responsiveDisplay("daytrips_date")})):responsiveDisplay("daytrips_date")}),a.get("#shop_bundle_persons",function(){0==$(".shop-container").length?(showShop(),$("#container").on("shop_dom_loaded",function(){responsiveDisplay("daytrips_persons")})):responsiveDisplay("daytrips_persons")}),a.get("#shop_addon_persons",function(){0==$(".shop-container").length?(showShop(),$("#container").on("shop_dom_loaded",function(){responsiveDisplay("daytrips_persons")})):responsiveDisplay("daytrips_persons")}),a.get("#shop_hotel",function(){0==$(".shop-container").length?(showShop(),$("#container").on("shop_dom_loaded",function(){responsiveDisplay("hotel")})):responsiveDisplay("hotel")}),a.get("#shop_hotel_roomcategory",function(){0==$(".shop-container").length?(showShop(),$("#container").on("shop_dom_loaded",function(){responsiveDisplay("hotel_roomcategory")})):responsiveDisplay("hotel_roomcategory")}),a.get("#shop_hotel_arrivaldate",function(){0==$(".shop-container").length?(showShop(),$("#container").on("shop_dom_loaded",function(){responsiveDisplay("hotel_arrivaldate")})):responsiveDisplay("hotel_arrivaldate")}),a.get("#shop_hotel_departuredate",function(){0==$(".shop-container").length?(showShop(),$("#container").on("shop_dom_loaded",function(){responsiveDisplay("hotel_departuredate")})):responsiveDisplay("hotel_departuredate")}),a.get("#shop_hotel_",function(){0==$(".shop-container").length?(showShop(),$("#container").on("shop_dom_loaded",function(){responsiveDisplay("hotel_")})):responsiveDisplay("hotel_")}),a.get("#shop_hotel_roomcount",function(){0==$(".shop-container").length?(showShop(),$("#container").on("shop_dom_loaded",function(){responsiveDisplay("hotel_roomcount")})):responsiveDisplay("hotel_roomcount")}),a.get("#shop_hotel_adultcount",function(){0==$(".shop-container").length?(showShop(),$("#container").on("shop_dom_loaded",function(){responsiveDisplay("hotel_adultcount")})):responsiveDisplay("hotel_adultcount")}),a.get("#shop_hotel_",function(){0==$(".shop-container").length?(showShop(),$("#container").on("shop_dom_loaded",function(){responsiveDisplay("hotel_")})):responsiveDisplay("hotel_")}),a.get("#shop_hotel_childcount",function(){0==$(".shop-container").length?(showShop(),$("#container").on("shop_dom_loaded",function(){responsiveDisplay("hotel_childcount")})):responsiveDisplay("hotel_childcount")}),a.get("#shop_hotel_",function(){0==$(".shop-container").length?(showShop(),$("#container").on("shop_dom_loaded",function(){responsiveDisplay("hotel_")})):responsiveDisplay("hotel_")}),a.get("#shop_hotel_children",function(){0==$(".shop-container").length?(showShop(),$("#container").on("shop_dom_loaded",function(){responsiveDisplay("hotel_children")})):responsiveDisplay("hotel_children")}),a.get("#shop_hotel_city",function(){0==$(".shop-container").length?(showShop(),$("#container").on("shop_dom_loaded",function(){responsiveDisplay("hotel_city")})):responsiveDisplay("hotel_city")}),a.get("#shop_hotel_type",function(){0==$(".shop-container").length?(showShop(),$("#container").on("shop_dom_loaded",function(){responsiveDisplay("hotel_type")})):responsiveDisplay("hotel_accommodation")}),a.get("#shop_hotel_accommodation",function(){0==$(".shop-container").length?(showShop(),$("#container").on("shop_dom_loaded",function(){responsiveDisplay("hotel_accommodation")})):responsiveDisplay("hotel_accommodation")}),a.get("#shop_hotel_offers",function(){0==$(".shop-container").length?(showShop(),$("#container").on("shop_dom_loaded",function(){responsiveDisplay("hotel_offers")})):responsiveDisplay("hotel_offers")}),a.get("#shop_depot",function(){0==$(".shop-container").length?(showShop(),$("#container").on("shop_dom_loaded",function(){responsiveDisplay("depot")})):responsiveDisplay("depot")}),a.get("#shop_depot_persons",function(){0==$(".shop-container").length?(showShop(),$("#container").on("shop_dom_loaded",function(){responsiveDisplay("depot_persons")})):responsiveDisplay("depot_persons")}),a.get("#shop_autoverlad",function(){0==$(".shop-container").length?(showShop(),$("#container").on("shop_dom_loaded",function(){responsiveDisplay("autoverlad")})):responsiveDisplay("autoverlad")}),a.get("#shop_autoverlad_direction",function(){0==$(".shop-container").length?(showShop(),$("#container").on("shop_dom_loaded",function(){responsiveDisplay("autoverlad_direction")})):responsiveDisplay("autoverlad_direction")}),a.get("#shop_autoverlad_type",function(){0==$(".shop-container").length?(showShop(),$("#container").on("shop_dom_loaded",function(){responsiveDisplay("autoverlad_type")})):responsiveDisplay("autoverlad_type")}),a.get("#shop_autoverlad_date",function(){0==$(".shop-container").length?(showShop(),$("#container").on("shop_dom_loaded",function(){responsiveDisplay("autoverlad_date")})):responsiveDisplay("autoverlad_date")}),a.get("#shop_autoverlad_category",function(){0==$(".shop-container").length?(showShop(),$("#container").on("shop_dom_loaded",function(){responsiveDisplay("autoverlad_category")})):responsiveDisplay("autoverlad_category")}),a.get("#shop_parking",function(){console.log("#shop_parking",0==$(".shop-container").length),0==$(".shop-container").length?(showShop(),$("#container").on("shop_dom_loaded",function(){responsiveDisplay("parking")})):responsiveDisplay("parking")}),a.get("#shop_parking_locations",function(){0==$(".shop-container").length?(showShop(),$("#container").on("shop_dom_loaded",function(){responsiveDisplay("parking_locations")})):responsiveDisplay("parking_locations")}),a.get("#shop_parking_ticketType",function(){0==$(".shop-container").length?(showShop(),$("#container").on("shop_dom_loaded",function(){responsiveDisplay("parking_ticketType")})):responsiveDisplay("parking_ticketType")}),a.get("#shop_parking_duration",function(){0==$(".shop-container").length?(showShop(),$("#container").on("shop_dom_loaded",function(){responsiveDisplay("parking_duration")})):responsiveDisplay("parking_duration")}),a.get("#shop_parking_begin",function(){0==$(".shop-container").length?(showShop(),$("#container").on("shop_dom_loaded",function(){responsiveDisplay("parking_begin")})):responsiveDisplay("parking_begin")}),a.get("#shop_parking_persons",function(){0==$(".shop-container").length?(showShop(),$("#container").on("shop_dom_loaded",function(){responsiveDisplay("parking_persons")})):responsiveDisplay("parking_persons")}),a.get("#shop_restaurant",function(){0==$(".shop-container").length?(showShop(),$("#container").on("shop_dom_loaded",function(){responsiveDisplay("restaurant")})):responsiveDisplay("restaurant")}),a.get("#shop_restaurant_region",function(){0==$(".shop-container").length?(showShop(),$("#container").on("shop_dom_loaded",function(){responsiveDisplay("restaurant_region")})):responsiveDisplay("restaurant_region")}),a.get("#shop_restaurant_city",function(){0==$(".shop-container").length?(showShop(),$("#container").on("shop_dom_loaded",function(){responsiveDisplay("restaurant_city")})):responsiveDisplay("restaurant_city")}),a.get("#shop_restaurant_consumer_type",function(){0==$(".shop-container").length?(showShop(),$("#container").on("shop_dom_loaded",function(){responsiveDisplay("restaurant_consumer_type")})):responsiveDisplay("restaurant_consumer_type")}),a.get("#shop_restaurant_date",function(){0==$(".shop-container").length?(showShop(),$("#container").on("shop_dom_loaded",function(){responsiveDisplay("restaurant_date")})):responsiveDisplay("restaurant_date")}),a.get("#shop_restaurant_restaurants",function(){0==$(".shop-container").length?(showShop(),$("#container").on("shop_dom_loaded",function(){responsiveDisplay("restaurant_restaurants")})):responsiveDisplay("restaurant_restaurants")})}function abstractCheckoutViewModel(){var a=this;a.DUMMY_ADDON_SKU="ADDON.OPTIONAL",a.entries=ko.observableArray([]),a.categories=ko.observableArray([]),a.errorMessage=ko.observable(),a.successMessage=ko.observable(),a.orderId=ko.observable(),a.finishCheckout=function(){shoppingcartVM.reset(),headerVM.loadPartner(!0),categoriesVM.onCloseCheckout(),a.closeCheckout()},a.resetTrains=function(){if(a.entries&&a.entries())for(var b=0;b<a.entries().length;b++){var c=a.entries()[b];c instanceof ShopCheckoutBundleItemModel&&c.categoryKey()==CATEGORY_KEY_ADDON&&c.price()instanceof eprAddonPriceModel&&(c.disabledInCheckout(!1),c.price().selectedTrain(null),c.price().visible(!0))}},a.cancelCheckout=function(){a.closeCheckout()},a.closeCheckout=function(){a.resetTrains(),$("#shopCheckout").modal("hide"),$(".modal-backdrop").remove()},a.getError=function(a,b,c){var d="";if(-1!=getErrorCode(a)){var e=$.parseJSON(a.responseText);d=e.message+" (code: "+e.code+")"}else d=a.responseText;return d},a.checkoutDisabled=ko.observable(!1),a.showSpinner=ko.observable(!1),a.disableCheckout=function(){$(".cart-detail").addClass("disabled"),$(".cart-detail").find("input,select").attr("disabled","true"),$(".checkout-dialog").find("button").attr("disabled","true"),$(".modal-header").find("button").hide(),a.checkoutDisabled(!0),a.showSpinner(!0)},a.createOrderItem=function(b){var c=null,d=null,e=null,f=null,g=null,h=null,i=null,j=null,k=null,l=null,m=null,n=null,o=null,p=null,q=null,r=null,s=null;if(b instanceof ShopCheckoutBundleItemModel)c=ORDER_ITEM_TYPE_BUDLE_ITEM,d=b.bundle().groupId(),e=b.bundle().firstName(),f=b.bundle().lastName(),g=b.bundle().phone(),h=b.bundle().dateOfBirth();else{c=ORDER_ITEM_TYPE_SIMPLE_ITEM;var t=kp.get(b,"categoryKey");if(t==CATEGORY_KEY_LOCAL_EVENT){var u=kp.get(b,"personalisationInfo.data.personalisation",[]);b.personalisationInfo().personalisationFields().name&&(e=kp.get(u,"name.firstName"),f=kp.get(u,"name.lastName")),b.personalisationInfo().personalisationFields().phone&&(g=kp.get(u,"phone")),b.personalisationInfo().personalisationFields().birthdate&&(h=kp.get(u,"birthdate")),b.personalisationInfo().personalisationFields().address&&(i=kp.get(u,"address.street"),j=kp.get(u,"address.streetNumber"),k=kp.get(u,"address.zipCode"),l=kp.get(u,"address.city"),m=kp.get(u,"address.country")),b.personalisationInfo().personalisationFields().gender&&(n=kp.get(u,"gender")),b.personalisationInfo().personalisationFields().language&&(o=kp.get(u,"language")),b.personalisationInfo().personalisationFields().email&&(p=kp.get(u,"email")),q=ko.toJS(kp.get(b,"personalisationInfo.data.additional",{}))}else t==CATEGORY_KEY_PARKING?r=b.licencePlate():t==CATEGORY_KEY_AUTOVERLAD?s=b.licensePlates():(e=b.firstName(),f=b.lastName(),g=b.phone(),h=b.dateOfBirth())}null==e&&(e=b.price().firstName()),null==f&&(f=b.price().lastName());var v={type:c,ticketNr:b.ticketNr(),bundleNr:d,firstName:e,lastName:f,phone:g,dateOfBirth:h,price:b.price().price(),sku:b.price().sku(),reservationId:b.price().reservationId(),consumerKey:b.price().consumerKey(),categoryKey:b.categoryKey(),timeRangeId:b.price().timeRangeId(),timeRangeKey:b.price().timeRangeKey(),reductionLevel:b.price().reductionLevel(),rebateRuleId:b.price().rebateRuleId(),crossSeason:b.price().crossSeason(),productKey:b.price().productKey(),date:b.price().date(),specificAttributes:b.price().getSpecificAttributes(),ticketholder:{firstName:e,lastName:f,phone:g,birthDateString:h,street:i,streetNumber:j,zipCode:k,city:l,country:m,gender:n,language:o,email:p,additionalData:q}};return null!=r&&(v.specificAttributes.licencePlate=r),null!=s&&(v.specificAttributes.licensePlates=a.getLicensePlatesJson(s)),v},a.getLicensePlatesJson=function(a){var b=[];return a.forEach(function(a){b.push(a.licensePlate())}),b},a.validateTravelTimes=function(){console.log("validateTravelTimes...");for(var b=!0,c=null,d=null,e=0;e<a.entries().length;e++){var f=a.entries()[e];f.price().categoryKey()==CATEGORY_KEY_ADDON&&f.price().sku()!=a.DUMMY_ADDON_SKU&&"function"==typeof f.price().eprSelected&&f.price().eprSelected()&&"function"==typeof f.price().getSpecificAttributes&&null!=f.price().getSpecificAttributes().epr.outward&&(c=new Date(f.price().getSpecificAttributes().epr.outward.arrivalDateTime)),f.price().categoryKey()==CATEGORY_KEY_ADDON&&f.price().sku()!=a.DUMMY_ADDON_SKU&&"function"==typeof f.price().eprSelected&&f.price().eprSelected()&&"function"==typeof f.price().getSpecificAttributes&&null!=f.price().getSpecificAttributes().epr.return&&(d=new Date(f.price().getSpecificAttributes().epr.return.departureDateTime)),c&&d&&(c>d&&(b=!1),c=null,d=null)}return b};var b=function(a){return console.log("getBundlePrice",a),a instanceof ShopCheckoutItemBundleViewModel||a instanceof ShopCheckoutGroupItemBundleViewModel?a.priceCalculated():a.price().price()};a.createBundleOrderItem=function(a){var c=null;return(a instanceof ShopCheckoutItemBundleViewModel||a instanceof ShopCheckoutGroupItemBundleViewModel)&&(c={type:ORDER_ITEM_TYPE_BUNDLE,bundleNr:a.groupId(),firstName:a.firstName(),lastName:a.lastName(),phone:a.phone(),dateOfBirth:a.dateOfBirth(),price:b(a),sku:a.price().sku(),reservationId:a.price().reservationId(),consumerKey:a.price().consumerKey(),categoryKey:a.categoryKey(),timeRangeId:a.price().timeRangeId(),timeRangeKey:a.price().timeRangeKey(),reductionLevel:a.price().reductionLevel(),rebateRuleId:a.price().rebateRuleId(),crossSeason:a.price().crossSeason(),productKey:a.price().productKey(),date:a.price().date()}),c},a.getDummyAddonIfNeeded=function(){for(var b=null,c=!1,d=!1,e=!1,f=0;f<a.entries().length;f++){var g=a.entries()[f];g.price().sku()==a.DUMMY_ADDON_SKU&&(b=g),g.price()instanceof eprAddonPriceModel&&(g.price().direction()==BERGBAHN_EPR_RETURN&&(e=!0),!g.disabledInCheckout()&&g.price().eprSelected()&&(g.price().direction()==BERGBAHN_EPR_OUTWARD?c=!0:g.price().direction()==BERGBAHN_EPR_RETURN&&(d=!0)))}return!c||!d&&e?b:null}}function calculateTotalPrice(a){for(var b=0,c=0;null!=a&&c<a().length;c++){var d=a()[c];d.categoryKey()==CATEGORY_KEY_BUNDLE?d.price().bundleItems().forEach(function(a){a.price()instanceof eprAddonPriceModel?a.price().eprSelected()&&(b+=a.price().price()):b+=a.price().price()}):b+=d.price().price()}return b}function checkoutViewModel(){var a=this;abstractCheckoutViewModel.apply(a,[]),a.orderId=ko.observable(),a.showVoucher=ko.observable(!1),a.expandGroupedItems=function(){},a.validatePrintingState=function(a){return!0},a.retryGroupReservationOrder=function(){},a.pickupSupported=function(){return!0},a.produce=function(){console.log("produce ...");for(var b=!1,c=0;c<a.entries().length;c++){var d=a.entries()[c];d.categoryKey()==CATEGORY_KEY_CARGO&&d.price().paymentType()==PAYMENTTYPE_CASH&&calculateTotalPrice(a.entries)>0&&(b=!0);if(!a.validateChildTicket(d))return void showError(i18n.t("trainReservation.birthdateAndTicketTypeMismatch"));var e=categoriesVM.getCategory(d.categoryKey());if(console.log("produce category",e),!e.categoryModel().config().produceEnabled)return void showInfo("Produzieren von Tickets der Kategorie "+d.categoryKey()+" wird derzeit noch nicht unterstützt. Bitte entfernen Sie die entsprechenden Produkte aus dem Warenkorb.");if(!a.validatePrintingState(d))return;if(d.printingState()==PRINTING_STATE_NRPROCESSING)return void showInfo("Ticket IDs werden überprüft");if(d.printingState()==PRINTING_STATE_NRINVALID)return void showError("Ungültige Ticket IDs vorhanden");if(d.printingState()==PRINTING_STATE_NRINCOMPLETE)return void showError(d.media()==MEDIA_SWISSPASS?"SwissPass Nr. bei einem der Tickets nicht vollständig":"Ticket IDs nicht vollständig");if(1==d.coding()){var f=categoriesVM.getCategory(d.categoryKey()).categoryModel().config().supportedMedia;if(null==f)return void showInfo("Produktion nicht möglich. Es wurden keine Medien für Kategorie "+d.categoryKey()+" konfiguriert.");if(headerVM.printerRunning()){var g=d instanceof ShopCheckoutBundleItemModel;if(d.categoryKey()==CATEGORY_KEY_SKIPASS)if(headerVM.CurrentPrinter().printingEnabled(d.categoryKey(),g))d.media(MEDIA_KEYCARD);else{if(!a.pickupSupported())return void showInfo("Für alle Tickets der Kategorie "+d.categoryKey()+" müssen IDs hinterlegt werden (Drucken laut Schachkonfiguration deaktiviert).");d.coding(!1),d.media(MEDIA_VOUCHER)}else if(d.categoryKey()==CATEGORY_KEY_BERGBAHN||d.categoryKey()==CATEGORY_KEY_BERGBAHN_EPR)if(headerVM.CurrentPrinter().printingEnabled(d.categoryKey(),g))d.media(MEDIA_BARCODE);else{if(!a.pickupSupported())return void showInfo("Für alle Tickets der Kategorie "+d.categoryKey()+" müssen IDs hinterlegt werden (Drucken laut Schachkonfiguration deaktiviert).");d.coding(!1),d.media(MEDIA_VOUCHER)}else d.categoryKey()==CATEGORY_KEY_BUS?(d.coding(!1),d.media(MEDIA_VOUCHER)):d.categoryKey()==CATEGORY_KEY_CARGO?(d.coding(!1),d.media(MEDIA_VOUCHER)):d.categoryKey()==CATEGORY_KEY_ADDON?(d.coding(!1),d.media(MEDIA_VOUCHER)):d.categoryKey()==CATEGORY_KEY_DEPOT?(d.coding(!1),d.media(MEDIA_VOUCHER)):d.categoryKey()==CATEGORY_KEY_PARKING?(d.coding(!1),d.media(MEDIA_VOUCHER)):d.categoryKey()==CATEGORY_KEY_CARGO&&(d.coding(!1),d.media(MEDIA_VOUCHER))}else if(-1!=f.indexOf("voucher"))d.coding(!1),d.media(MEDIA_VOUCHER),console.log("setting media = voucher");else{
if(-1!=f.indexOf("keycard")||-1!=f.indexOf("swisspass"))return void showInfo("Kein Drucker verfügbar. Für alle Tickets der Kategorie "+d.categoryKey()+" müssen IDs hinterlegt werden.");if(-1!=f.indexOf("barcode"))return void showInfo("Kein Drucker verfügbar. Produktion von Barcode Tickets für Kategorie "+d.categoryKey()+" nicht möglich.")}}}if(!a.validateTravelTimes())return void showInfo(i18n.t("checkout.msg.selectedTimesConflict"));var h=function(){a.disableCheckout(),a.expandGroupedItems(),a.createOrder()};b?bootbox.confirm({className:"custom-cargo-confirm",size:"small",message:i18n.t("checkout.msg.cargoReminderCashPayment"),callback:function(b){1==b?h():(a.cancelCheckout(),shoppingcartVM.reset())},buttons:{cancel:{label:i18n.t("checkout.msg.confirmBox.cancel")},confirm:{label:i18n.t("checkout.msg.confirmBox.confirm")}}}):h()},a.validateChildTicket=function(a){var b=!0,c=null;return null!=a.dateOfBirth()?(c=moment.duration(moment().diff(moment(a.dateOfBirth()))).asYears(),"juniorcard"==a.price().consumerKey()&&c>=16&&"PUBLICTRANSPORTATION"==a.categoryKey()&&(b=!1)):null!=a.personalisationInfo()&&null!=a.personalisationInfo().data()&&null!=a.personalisationInfo().data().personalisation&&"function"==typeof a.personalisationInfo().data().personalisation.birthdate&&null!=a.personalisationInfo().data().personalisation.birthdate()&&(c=moment.duration(moment().diff(moment(a.personalisationInfo().data().personalisation.birthdate()))).asYears(),(a.price().ticketTypeName().indexOf("6 - 16")>=0||a.price().ticketTypeName().indexOf("Kind")>=0||a.price().ticketTypeName().indexOf("Child")>=0)&&c>=16&&"LOCALEVENT"==a.categoryKey()?b=!1:a.price().ticketTypeName().indexOf("6 - 16")>=0&&c<6&&"LOCALEVENT"==a.categoryKey()&&(b=!1)),b},a.retry=function(){console.log("retrying checkout ..."),a.disableCheckout();for(var b=0;b<a.entries().length;b++){var c=a.entries()[b];c.printingState()==PRINTING_STATE_ERROR&&c.printingState(PRINTING_STATE_RETRY)}null!=a.orderId()?a.performProduce():a.createOrder()},a.resume=function(){console.log("resuming checkout ..."),a.disableCheckout();for(var b=[],c=[],d=!1,e=ko.utils.arrayFirst(a.entries(),function(a){return a.printingState()==PRINTING_STATE_DONE&&null!=a.price&&null!=a.price().rebateRuleId()&&""!=a.price().rebateRuleId()}),f=0;f<a.entries().length;f++){var g=a.entries()[f];g instanceof ShopCheckoutItemModel&&g.printingState()==PRINTING_STATE_ERROR&&(null!=e&&null!=item.price&&null!=g.price().rebateRuleId()&&""!=g.price().rebateRuleId()&&(d=!0),b.push(g))}for(var f=0;f<a.groupedEntries().length;f++){var g=a.groupedEntries()[f];g instanceof ShopCheckoutItemBundleViewModel&&g.printingState()==PRINTING_STATE_ERROR&&(null!=e&&null!=item.price&&null!=g.price().rebateRuleId()&&""!=g.price().rebateRuleId()&&(d=!0),c.push(g))}for(var f=0;f<b.length;f++)a.entries.remove(b[f]);for(var f=0;f<b.length;f++)a.groupedEntries.remove(c[f]);if(d){var h={orderId:a.orderId()};getAuditLogAdapter().writeLog(BROKEN_RABTE_RULE,null,null,h),showWarning("An einer Rabattregel beteiligte Produkte wurden nur teilweise gedruckt! Bitte stornieren Sie diese gegebenfalls unter Verkäufe.")}a.completeOrder(!1)},a.performProduce=function(){for(var b=!0,c=0,d=0;d<a.entries().length;d++){var e=a.entries()[d];if(null!=e.id()&&(c++,e.printingState()==PRINTING_STATE_OPEN||e.printingState()==PRINTING_STATE_RETRY)){if(e.error(""),1==e.coding())if(e.media()==MEDIA_KEYCARD)console.log("producing ticket (coding): "+e.ticketNr()),a.performProduceCoding(e);else{if(e.media()!=MEDIA_BARCODE)return void showError("producing "+e.media()+"not supported");console.log("producing barcode ticket (coding): "+e.ticketNr()),a.performProduceBarcode(e)}else a.performProduceNoCoding(e);b=!1;break}}if(b){var f=ko.utils.arrayFilter(a.entries(),function(a){return a.printingState()==PRINTING_STATE_ERROR});null!=f&&f.length>0?a.showError(i18n.t("checkout.msg.errorProduceOrderItems",{errorCount:f.length,totalCount:c})):a.completeOrder(!1)}},a.performProduceNoCoding=function(b){var c={orderItemId:b.id(),coding:b.coding(),mediaExtId:b.mediaCardId(),mediaOriginalId:b.mediaCardOrigId(),media:b.media()};console.log("performProduceNoCoding ticketNr",b.ticketNr(),JSON.stringify(c),b),$.ajax(serviceRootURL+"/produceorderitem",{type:"GET",data:c,dataType:"json",contentType:"application/json",success:function(c,d,e){console.log("produce order item (no coding) result retrieved: ",c),b.printingState(PRINTING_STATE_DONE),null!=b.origOrderItemId()?a.completePickupOrderItem(b,b.mediaCardId()):("voucher"==b.media()&&(b.mediaCardId(c.mediaId),a.showVoucher(!0)),a.performProduce())},error:function(c,d,e){console.log("error on produceorderitem (no coding)"),checkSession(c);var f="";b.mediaCardId()&&(f=": "+b.mediaCardId()),headerVM.printerRunning()?(b.error("Unerwarteter Fehler beim Produzieren des Tickets mit ID"+f+". Beim Wiederholen wird ein neues Ticket wird ausgegeben."+a.getError(c,d,e)),b.printingState(PRINTING_STATE_ERROR),b.mediaCardId(""),"voucher"!=b.media()&&b.coding(!0)):(b.error("Unerwarteter Fehler beim Produzieren des Tickets mit ID"+f+". "+a.getError(c,d,e)),b.price().error("Unerwarteter Fehler beim Produzieren des Tickets mit ID"+f+". "+a.getError(c,d,e)),b.printingState(PRINTING_STATE_ERROR)),a.performProduce()}})},a.performProduceCoding=function(b){console.log("feeding ..."),printerFeedTicket(b.categoryKey()).done(function(c){if(c.valid){var d=c.mediaId,e=c.projectNumber;console.log(d),media2Wtp(e,d,!1).done(function(f){console.log("produceOrderItem for order item ",b.id()),getAuditLogAdapter().writeLog(NEW_TICKET_READ,d,f),$.ajax(serviceRootURL+"/produceorderitem",{type:"GET",data:{orderItemId:b.id(),coding:!0,mediaCardContent:c.originalMessage,mediaExtId:f,mediaOriginalId:d+"#"+e,media:b.media()},dataType:"json",contentType:"application/json",success:function(e,g,h){console.log("coding and printing info retrieved: "+e),e&&e.mediaCardInfo&&e.mediaCardInfo.codingData&&e.mediaCardInfo.printingData?printerCodeAndPrintSkiTicket(e.mediaCardInfo.codingData,e.mediaCardInfo.printingData,c.originalMessage,d,f).done(function(c){var d=c.codingOk,e=c.printingOk,g=c.message;console.log("codeAndPrintTicket was successful. codingOk = "+d+", printingOk = "+e);var h={codingResult:d,printingResult:e};$.ajax({url:serviceRootURL+"/produceorderitem/"+b.id(),type:"PUT",data:JSON.stringify(h),dataType:"json",contentType:"application/json",success:function(c,e,h){console.log("coding and printing ack successful: "+c),d?(b.mediaCardId(f),b.printingState(PRINTING_STATE_DONE),null!=b.origOrderItemId()?a.completePickupOrderItem(b,f):a.performProduce()):(b.printingState(PRINTING_STATE_ERROR),b.error("Fehler beim drucken: "+g),a.performProduce())},error:function(c,d,e){console.log("error on sending coding ack"),checkSession(c),b.error("Unerwarteter Fehler beim Senden der Druck Bestätigung: "+a.getError(c,d,e)),b.printingState(PRINTING_STATE_ERROR),printerEjectTicket().done(function(b){a.performProduce()})}})}).fail(function(){console.log("error on printerCodeAndPrintSkiTicket"),b.error("Unerwarteter Fehler beim Ticket codieren"),b.printingState(PRINTING_STATE_ERROR),printerEjectTicket().done(function(b){a.performProduce()})}):(console.log("no coding or printing information retrieved from server"),b.error("Fehler: Keine Print Informationen vom Server erhalten"),b.printingState(PRINTING_STATE_ERROR),a.performProduce())},error:function(c,d,e){console.log("error on produceorderitem"),checkSession(c),b.error("Unerwarteter Fehler bei Anforderung der Druck Informationen: "+a.getError(c,d,e)),b.printingState(PRINTING_STATE_ERROR),printerEjectTicket().done(function(b){a.performProduce()})}})}).fail(function(){console.log("error on media2Wtp"),b.printingState(PRINTING_STATE_ERROR),printerEjectTicket().done(function(b){a.performProduce()})})}else showError("Ungültige Karte gelesen"),printerEjectTicket().done(function(c){b.printingState(PRINTING_STATE_ERROR),a.performProduce()})}).fail(function(){console.log("error on printerFeedTicket"),b.printingState(PRINTING_STATE_ERROR),a.performProduce()})},a.performProduceBarcode=function(b){console.log("produceOrderItem for order item "+b.id()),$.ajax(serviceRootURL+"/produceorderitem",{type:"GET",data:{orderItemId:b.id(),coding:!0,media:b.media()},dataType:"json",contentType:"application/json",success:function(c,d,e){if(console.log("printing info retrieved: "+c),c&&c.mediaCardInfo&&c.mediaCardInfo.printingData){var f=c.mediaId;printerPrintBarcodeTicket(b.categoryKey(),c.mediaCardInfo.printingData).done(function(c){var d=c.printingOk,e=c.message;console.log("printBarcodeTicket was successful. printingOk = "+d);var g={codingResult:!1,printingResult:d};$.ajax({url:serviceRootURL+"/produceorderitem/"+b.id(),type:"PUT",data:JSON.stringify(g),dataType:"json",contentType:"application/json",success:function(c,g,h){console.log("printing ack successful: "+c),d?(b.mediaCardId(f),b.printingState(PRINTING_STATE_DONE),null!=b.origOrderItemId()?a.completePickupOrderItem(b,wtp):a.performProduce()):(b.printingState(PRINTING_STATE_ERROR),b.error("Fehler beim drucken: "+e),a.performProduce())},error:function(c,d,e){console.log("error on sending coding ack"),checkSession(c),b.error("Unerwarteter Fehler beim Senden der Druck Bestätigung: "+a.getError(c,d,e)),b.printingState(PRINTING_STATE_ERROR),printerEjectTicket().done(function(b){a.performProduce()})}})}).fail(function(){console.log("error on printerCodeAndPrintSkiTicket"),b.error("Unerwarteter Fehler beim Ticket drucken"),b.printingState(PRINTING_STATE_ERROR),printerEjectTicket().done(function(b){a.performProduce()})})}else console.log("no coding or printing information retrieved from server"),b.error("Fehler: Keine Print Informationen vom Server erhalten"),b.printingState(PRINTING_STATE_ERROR),a.performProduce()},error:function(c,d,e){console.log("error on produceorderitem"),checkSession(c),b.error("Unerwarteter Fehler bei Anforderung der Druck Informationen: "+a.getError(c,d,e)),b.printingState(PRINTING_STATE_ERROR),printerEjectTicket().done(function(b){a.performProduce()})}})},a.completePickupOrderItem=function(b,c){var d={originalOrderItemId:b.origOrderItemId(),mediaExtId:c};$.ajax({url:serviceRootURL+"/pickuporders/"+b.origOrderItemId(),type:"PUT",data:JSON.stringify(d),dataType:"json",contentType:"application/json",success:function(b,c,d){console.log("completePickupOrderItem successful "+b),a.performProduce()},error:function(b,c,d){console.log("error on sending coding ack"),showError("Fehler beim Senden der Bestätigung (Ticketdruck trotzdem erfolgreich)",b,c,d,!0),a.performProduce()}})},a.createOrder=function(){console.log("creating order based on price: "+a.totalPrice());var b=a.paymentType();b===PAYMENTTYPE_CREDITCARD&&0===a.totalPrice()&&(b=PAYMENTTYPE_FREE);for(var c={amount:a.totalPrice(),paymentType:b,customerPaymentType:a.customerPaymentType(),type:ORDER_TYPE_CASHDESK_ORDER,comment:a.comment(),orderItems:[]},d=0;d<a.groupedEntries().length;d++){var e=a.groupedEntries()[d];if(e instanceof ShopCheckoutGroupItemBundleViewModel){e.bundles().forEach(function(b){var d=a.createBundleOrderItem(b);null!=d&&(console.log("Created bundle order item",d),c.orderItems.push(d))})}else{var f=a.createBundleOrderItem(e);null!=f&&(console.log("Created bundle order item",f),c.orderItems.push(f))}}for(var g={},d=0;d<a.entries().length;d++){var e=a.entries()[d];if(e.price().sku()!=a.DUMMY_ADDON_SKU&&!(e instanceof ShopCheckoutBundleItemGroupModel))if(e.price()instanceof eprAddonPriceModel&&(e.disabledInCheckout()||!e.price().eprSelected()))console.log("Skipping disabled or not selected epr addon",e);else{if(kp.get(e,"categoryKey")==CATEGORY_KEY_LOCAL_EVENT){var h=e.price().productKey()+"_"+e.price().date(),i=kp.get(e,"personalisationInfo.data.type",[]);"contact"==i&&(void 0===g[h]?g[h]=e.personalisationInfo():e.personalisationInfo(g[h]))}c.orderItems.push(a.createOrderItem(e))}}var j=a.getDummyAddonIfNeeded();null!=j&&c.orderItems.push(a.createOrderItem(j)),a.performCreateOrder(c,!0)},a.performCreateOrder=function(b,c){var d=serviceRootURL+"/orders";console.log("performCreateOrder",d,b,JSON.stringify(b)),$.ajax(d,{type:"POST",data:JSON.stringify(b),dataType:"json",contentType:"application/json",success:function(b,d,e){a.orderId(b.id),console.log("order created (id="+b.id+")"),$.ajax(serviceRootURL+"/orders/"+a.orderId(),{type:"GET",data:{consumptionCheck:!1,bundleMode:PARAMKEY_GETORDER_BUNDLEMODE_LEAVES},dataType:"json",contentType:"application/json",success:function(b,d,e){console.log("order found: ",b),b&&b.orderItems&&($.map(b.orderItems,function(b){var c=ko.utils.arrayFirst(a.entries(),function(a){return a.ticketNr()===b.ticketNr});c&&c.id(b.id)}),c?a.performProduce():a.handleCreateDone())},error:function(b,c,d){console.log("Server error on loading order: "+b.responseText),a.showSpinner(!1),a.handleCreateError(b,c,d)}})},error:function(b,c,d){console.log("Server error on creating order:\n"+b.responseText),a.showSpinner(!1),a.handleCreateError(b,c,d)}})},a.handleCreateDone=function(){},a.handleCreateError=function(b,c,d){var e=checkSession(b);getErrorCode(b)==ERR_CODE_CONTINGENT_VALIDATION_ERROR?a.showError(a.getError(b,c,d)+" Retry?"):0==e?window.location.replace(logoutUrl+"?logoutReason=401"):a.showError(i18n.t("checkout.msg.errorCreateOrder")+"<br/>"+a.getError(b,c,d))},a.handleError=function(b,c,d){checkSession(b)?65==getErrorCode(b)?a.showError(a.getError(b,c,d)+"<br/>"+i18n.t("checkout.msg.retry")):a.showError(i18n.t("checkout.msg.unexpectedError")+"<br/>"+a.getError(b,c,d)):window.location.replace(logoutUrl+"?logoutReason=401")},a.completeOrder=function(b){var c={id:a.orderId(),status:b?ORDER_STATUS_DISCARDED:ORDER_STATUS_COMPLETE,amount:a.totalPrice()};console.log("completing order based on price: "+a.totalPrice(),JSON.stringify(c)),$.ajax({url:serviceRootURL+"/orders/"+a.orderId(),type:"PUT",data:JSON.stringify(c),dataType:"json",contentType:"application/json",success:function(c,d,e){if(console.log("order completed",c),!b&&a.showVoucher()){var f=c.id;console.log("print voucher for orderid: "+f),window.open("/print_voucher/"+f,"_blank","toolbar=no, location=no, status=no, scrollbars=yes, resizable=yes")}shoppingcartVM.reset(),b?a.showSuccess(i18n.t("checkout.msg.successOrderDiscard")):a.showSuccess(i18n.t("checkout.msg.successOrderComplete"))},error:function(b,c,d){console.log("Server error on completing order:\n"+b.responseText),a.handleError(b,c,d),a.showSpinner(!1)}})},a.discardPossible=function(){if(null!=a.orderId()){var b=ko.utils.arrayFirst(a.entries(),function(a){return a instanceof ShopCheckoutItemModel&&a.printingState()===PRINTING_STATE_DONE});return null==b&&(b=ko.utils.arrayFirst(a.groupedEntries(),function(a){return a instanceof ShopCheckoutItemBundleViewModel&&a.printingState()===PRINTING_STATE_DONE})),null==b}return!0},a.resumePossible=function(){if(null!=a.orderId()){return null!=ko.utils.arrayFirst(a.entries(),function(a){return a.printingState()!=PRINTING_STATE_DONE})}return!0},a.discard=function(){if(a.disableCheckout(),null!=a.orderId()){var b=ko.utils.arrayFirst(a.entries(),function(a){return a instanceof ShopCheckoutItemModel&&a.printingState()===PRINTING_STATE_DONE});null==b&&null!=a.groupedEntries&&(b=ko.utils.arrayFirst(a.groupedEntries(),function(a){return a instanceof ShopCheckoutItemBundleViewModel&&a.printingState()===PRINTING_STATE_DONE}));var c=null==b;a.completeOrder(c)}else a.closeCheckout()},a.showSuccess=function(b){a.successMessage(b),a.showSpinner(!1),$(".produce-error").slideUp(),$(".produce-success").slideDown(),$("#checkoutCancel").hide(),$("#checkoutProduce").hide(),$("#checkoutReservation").hide(),$("#checkoutForward").hide(),$("#checkoutResume").hide(),$("#checkoutDiscard").hide(),$("#checkoutFinish").show(),$(".produce-error").find("button").removeAttr("disabled"),$(".produce-success").find("button").removeAttr("disabled"),$(".modal-footer").find("button").removeAttr("disabled")},a.showError=function(b){a.disableCheckout(),a.showSpinner(!1),a.errorMessage(b),$(".produce-success").slideUp(),$(".produce-error").slideDown(),$("#checkoutCancel").hide(),$("#checkoutProduce").hide(),$("#checkoutReservation").hide(),$("#checkoutForward").hide(),a.discardPossible()?($("#checkoutResume").hide(),$("#checkoutDiscard").show()):a.resumePossible()?($("#checkoutResume").show(),$("#checkoutDiscard").hide()):($("#checkoutResume").hide(),$("#checkoutDiscard").hide()),$(".produce-error").find("button").removeAttr("disabled"),$(".produce-success").find("button").removeAttr("disabled"),$(".modal-footer").find("button").removeAttr("disabled")},a.swisspassIdChanged=function(a,b){console.log("swisspassIdChanged -- "),a.printingState(PRINTING_STATE_NRINCOMPLETE);var c=a.mediaCardId(),d=a.zipCode();a.categoryKey()==CATEGORY_KEY_DEPOT?(a.mediaCardId(c),a.mediaCardOrigId(c+"|"+d),a.coding(!1),a.printingState(PRINTING_STATE_OPEN)):null!=d&&""!=d&&getSwisspassInfo(c,d).done(function(e){console.log(e.mediaIdExt),a.mediaCardId(c),a.mediaCardOrigId(e.mediaIdExt+"|"+d),a.coding(!1),a.printingState(PRINTING_STATE_OPEN),null!=e.ticketholder&&null!=a.ticketHolder&&a.ticketHolder(new ticketholderModel(e.ticketholder)),b.target.title=""}).fail(function(){console.log("invalid swisspass id: "+c),a.printingState(PRINTING_STATE_NRINVALID),b.target.title="Ungültige Swisspass Nummer"})},a.mediaIdChanged=function(b,c){console.log("mediaIdChanged -- "),b.printingState(PRINTING_STATE_NRPROCESSING);var d=b.mediaCardId();if(b.media(MEDIA_KEYCARD),b.zipCode(""),null==d||""==d)return b.coding(!0),void b.printingState(PRINTING_STATE_OPEN);if(b.swisspassSupported()&&isSwisspassNumber(d)){if(b.mediaCardId(d.replace(/-/g,"")),a.isKeycardNumberUsed(b,d))return b.printingState(PRINTING_STATE_OPEN),void b.mediaCardId("");b.printingState(PRINTING_STATE_NRINCOMPLETE),b.media(MEDIA_SWISSPASS)}else if(/^([a-zA-Z0-9]{8})-([a-zA-Z0-9]{3})-([a-zA-Z0-9]{3})$/.test(d)){if(a.isKeycardNumberUsed(b,d))return b.printingState(PRINTING_STATE_OPEN),void b.mediaCardId("");validateKeycard(b,d).done(function(a){console.log(a),b.mediaCardId(d),b.mediaCardOrigId(d),b.coding(!1),b.printingState(PRINTING_STATE_OPEN),c.target.title=""}).fail(function(){console.log("invalid wtp number: "+d),b.printingState(PRINTING_STATE_NRINVALID),c.target.title="Ungültige WTP Nummer"})}else if(b.keycardSupported()&&isDTANumber(d))if(isAxessBackend(b.categoryKey()))media2Wtp(100,d,!0).done(function(e){if(a.isKeycardNumberUsed(b,e))return b.printingState(PRINTING_STATE_OPEN),void b.mediaCardId("");validateKeycard(b,e).done(function(a){console.log(e),b.mediaCardId(e),b.mediaCardOrigId(d),b.coding(!1),b.printingState(PRINTING_STATE_OPEN),c.target.title=""}).fail(function(){console.log("invalid wtp number: "+d),b.printingState(PRINTING_STATE_NRINVALID),c.target.title="Ungültige WTP Nummer"})}).fail(function(){console.log("invalid media id: "+d),b.printingState(PRINTING_STATE_NRINVALID),c.target.title="Ungültige DTA Keycard Nummer"});else{if(a.isKeycardNumberUsed(b,d))return b.printingState(PRINTING_STATE_OPEN),void b.mediaCardId("");validateKeycard(b,d).done(function(a){console.log(a),b.mediaCardId(d),b.mediaCardOrigId(d),b.coding(!1),b.printingState(PRINTING_STATE_OPEN),c.target.title=""}).fail(function(){console.log("invalid dta number: "+d),b.printingState(PRINTING_STATE_NRINVALID),c.target.title="Ungültige DTA Nummer"})}else if(appendSkidataChecksum&&b.keycardSupported()&&isDTANumberWithoutChecksum(d)&&isSkidataBackend(b.categoryKey()))d=appendDTANumberChecksum(d),b.mediaCardId(d),validateKeycard(b,d).done(function(a){console.log(a),b.mediaCardId(d),b.mediaCardOrigId(d),b.coding(!1),b.printingState(PRINTING_STATE_OPEN),c.target.title=""}).fail(function(){console.log("invalid dta number: "+d),b.printingState(PRINTING_STATE_NRINVALID),c.target.title="Ungültige DTA Nummer"});else{if(/^([0-9 ]*)$/.test(d)&&b.categoryKey()==CATEGORY_KEY_DEPOT)return void validateDummyKeycard(b,d).done(function(a){console.log(a),b.mediaCardId(d),b.mediaCardOrigId(d),b.coding(!1),b.printingState(PRINTING_STATE_OPEN),c.target.title=""}).fail(function(){console.log("invalid wtp number: "+d),b.printingState(PRINTING_STATE_NRINVALID),c.target.title="Ungültige WTP Nummer"});c.target.title="Ungültiges ID Format",b.printingState(PRINTING_STATE_NRINVALID)}},a.isKeycardNumberUsed=function(b,c){for(var d=0;d<a.entries().length;d++)if(b.ticketNr()!=a.entries()[d].ticketNr()&&a.entries()[d].mediaCardId()==c)return showInfo("Keycard "+c+" wird bereits für Ticket "+a.entries()[d].ticketNr()+" verwendet! Bitte verwenden Sie eine andere Keycard."),!0;return!1},a.getMediaId=function(b,c){console.log("handling media id onfocus event"),$("#shopCheckout").find("input,select").attr("disabled","true"),$("#shopCheckout").find("button").attr("disabled","true"),$("#checkoutCancel").removeAttr("disabled"),$("#checkoutProduce").attr("disabled","true"),printerGetMediaId().done(function(d){if(d.valid){var e=d.mediaId,f=d.projectNumber;$("#shopCheckout").find("input,select").not(".nomediaid").removeAttr("disabled"),$("#shopCheckout").find("button").not(".nocardread").removeAttr("disabled"),$("#checkoutProduce").removeAttr("disabled"),media2Wtp(f,e,!1).done(function(d){if(console.log(d),getAuditLogAdapter().writeLog(EXISTING_TICKET_READ,e,d),a.isKeycardNumberUsed(b,d))return b.printingState(PRINTING_STATE_OPEN),b.mediaCardId(""),void(c.target.title="Doppelte WTP Nummer");validateKeycard(b,d).done(function(a){console.log("wtp number valid"),b.mediaCardId(d),b.mediaCardOrigId(e+"#"+f),b.coding(!1),b.printingState(PRINTING_STATE_OPEN)}).fail(function(){console.log("invalid wtp number: "+e),$("#shopCheckout").find("input,select").not(".nomediaid").removeAttr("disabled"),$("#shopCheckout").find("button").not(".nocardread").removeAttr("disabled"),$("#checkoutProduce").removeAttr("disabled")})})}else $("#shopCheckout").find("input,select").not(".nomediaid").removeAttr("disabled"),$("#shopCheckout").find("button").not(".nocardread").removeAttr("disabled"),$("#checkoutProduce").removeAttr("disabled"),showError("Ungültige Karte gelesen")}).fail(function(a,b,c){checkSession(a),$("#shopCheckout").find("input,select").removeAttr("disabled"),$("#shopCheckout").find("button").removeAttr("disabled"),$("#checkoutProduce").removeAttr("disabled"),"1073741825"!=a.responseJSON.code&&$("#checkoutProduce").focus()})}}function ShopCheckoutItemGroupViewModel(a,b,c,d){var e=this;this.groupId=ko.observable(a),this.categoryKey=ko.observable(c.categoryKey()),this.quantity=ko.observable(c.quantity()),this.price=ko.observable(c.price());var f=this.categoryKey().toLowerCase();headerVM.getCategoryShortLabel&&headerVM.getCategoryShortLabel(f)?this.categoryName=headerVM.getCategoryShortLabel(f):this.categoryName=ko.observable(i18n.t("category.short."+f)),this.singleItem=ko.observable(),e.items=ko.computed(function(){var a=ko.utils.arrayFilter(b.entries(),function(a){return!(a instanceof ShopCheckoutBundleItemModel)&&a.groupId()==e.groupId()});return 1==a.length?e.singleItem(a[0]):e.singleItem(null),e.quantity(a.length),a}),this.totalPrice=ko.computed(function(){return calculateTotalPrice(e.items)}),e.defaultOpen=ko.observable(d)}function ShopCheckoutItemBundleViewModel(a,b,c){var d=this;this.groupId=ko.observable(a),this.categoryKey=ko.observable(c.categoryKey()),this.firstName=ko.observable(),this.lastName=ko.observable(),this.phone=ko.observable(),this.dateOfBirth=ko.observable(),this.licensePlate=ko.observable(),this.quantity=ko.observable(1),this.price=ko.observable(c.price()),this.requiredPersonalizationFirstname=ko.observable(!1),this.requiredPersonalizationLastname=ko.observable(!1),this.requiredPersonalizationInfoPhone=ko.observable(!1),this.requiredPersonalizationInfoDateOfBirth=ko.observable(!1),this.requiresPersonalizationInfo=ko.observable(!1),this.categoryName=ko.observable(i18n.t("category.short."+this.categoryKey().toLowerCase())),null!=headerVM.categoryLabelsMap&&null!=headerVM.categoryLabelsMap()[this.categoryKey().toLowerCase()]&&(this.categoryName=ko.observable(headerVM.categoryLabelsMap()[this.categoryKey().toLowerCase()].categoryShortLabel())),d.items=ko.computed(function(){return ko.utils.arrayFilter(b.entries(),function(a){return a instanceof ShopCheckoutBundleItemModel&&a.groupId()==d.groupId()})}),d.bundleItems=ko.observableArray([]),d.priceCalculated=ko.computed(function(){var a=0;return d.items().forEach(function(b){b.price()instanceof eprAddonPriceModel?b.price().eprSelected()&&(a+=b.price().price()):a+=b.price().price()}),a}),d.requiredPersonalizationInfo=ko.computed(function(){for(var a=0;a<b.entries().length;a++){var c=b.entries()[a],e=c.requiredPersonalizationInfo();null!=e&&""!=e&&(d.requiresPersonalizationInfo(!0),-1!=e.indexOf("firstname")&&d.requiredPersonalizationFirstname(!0),-1!=e.indexOf("lastname")&&d.requiredPersonalizationLastname(!0),-1!=e.indexOf("phone")&&d.requiredPersonalizationInfoPhone(!0),-1!=e.indexOf("dateOfBirth")&&d.requiredPersonalizationInfoDateOfBirth(!0))}}),d.printingState=ko.computed(function(){for(var a=0;a<d.items().length;a++){var b=d.items()[a];if(b.printingState()==PRINTING_STATE_OPEN||b.printingState()==PRINTING_STATE_RETRY)return PRINTING_STATE_OPEN;if(b.printingState()==PRINTING_STATE_ERROR)return PRINTING_STATE_ERROR}return PRINTING_STATE_DONE}),d.defaultOpen=ko.observable(!0),d.visible=ko.observable(!0),d.showPrice=ko.observable(!0)}function ShopCheckoutGroupItemBundleViewModel(a,b,c){var d=this;ko.utils.extend(d,new ShopCheckoutItemBundleViewModel(a,b,c)),d.bundles=ko.observableArray([]),d.quantity=ko.computed(function(){return d.bundles().length}),d.getAllBundleItems=function(){var a=[];return d.bundles().forEach(function(b){b.bundleItems().forEach(function(b){a.push(b)})}),a},d.groupByCategory=function(a){var b=new Array;return a.forEach(function(a){void 0===b[a.categoryKey()]?b[a.categoryKey()]=new Array(a):b[a.categoryKey()].push(a)}),b},d.groupBySku=function(a){var b=new Array;return a.forEach(function(a){var c=a.price().sku();void 0===b[c]?b[c]=new Array(a):b[c].push(a)}),b},d.getItems=function(){var a=[],b=d.getAllBundleItems(),c=d.groupBySku(b);for(var e in c)for(var f=c[e],g=0;g<f.length;g++){if(0==g){var h=new ShopCheckoutBundleItemGroupDummyModel(f);a.push(h)}a.push(f[g])}return a},d.items=ko.computed(function(){return d.getItems()}),d.priceCalculated=ko.computed(function(){var a=0;return d.getItems().forEach(function(b){b.isTotalBundleGroupItem()||(b.price()instanceof eprAddonPriceModel?b.price().eprSelected()&&(a+=b.price().price()):a+=b.price().price())}),a}),d.addBundle=function(a,c,e){for(var f=0;f<a.quantity();f++){var g=new ShopCheckoutItemBundleViewModel(c,b,a);d.bundles.push(g);for(var h=0;h<a.price().bundleItems().length;h++){var i=a.price().bundleItems()[h],j=new ShopCheckoutBundleItemModel(i,e,c,g,categoriesVM.getCategory(i.categoryKey()).categoryModel().config());g.bundleItems.push(j),e++}c++}return{bundleIndex:c,ticketNr:e}},d.createEntries=function(){b.groupedEntries().push(d);var a=d.getAllBundleItems(),c=d.groupByCategory(a);for(var e in c)for(var f=c[e],g=0;g<f.length;g++)b.entries.push(f[g])}}function shopCheckoutViewModel(a,b,c,d,e,f,g){function h(a,b){a.price().bundleItems().forEach(function(a){a.price()instanceof eprAddonPriceModel?a.price().eprSelected()&&(b+=a.price().price()):b+=a.price().price()});for(var c=!1,d=0;d<i.categories().length;d++){var e=i.categories()[d];if(e instanceof bundleCategoryCountModel&&e.categoryKey()==a.categoryKey()&&e.productKey()==a.price().productKey()){e.quantity(e.quantity()+1),c=!0;break}}if(!c){var f=new bundleCategoryCountModel(a.categoryKey(),a.price().productKey(),a.price().bundleProductName());i.categories.push(f)}return b}var i=this;if(i.comment=ko.observable(b),i.orderType=ko.observable(f),i.paymentType=ko.observable(c),i.customerPaymentType=ko.observable(g),i.groupedEntries=ko.observableArray([]),i.Tourguides=headerVM.Tourguides,i.selectedTourGuide=ko.observable(),i.forwardType=ko.observable(FORWARD_ORDER_FORWARD_TYPE_EMAIL),i.isTourguidePreselected=ko.observable(),i.requestOrderId=ko.observable(e),i.selectedTrainUp=ko.observable(),i.selectedTrainDown=ko.observable(),i.eprDaytripContained=ko.observable(!1),i.eprTimeSelected=ko.observable(!1),i.eprTimeslot=ko.observable(),null!=d){i.isTourguidePreselected(!0);var j=ko.utils.arrayFirst(i.Tourguides(),function(a){return a.id()===d});i.selectedTourGuide(j)}if(checkoutViewModel.apply(i,[a]),i.produceDisabled=ko.observable(!1),i.orderType()!=ORDER_TYPE_GROUP_RESERVATION_ORDER){for(var k=1,l=0,m={},n=0;n<a.length;n++){var o=a[n];if(o.price()instanceof bundlePriceModel)if(o.price().rebateRuleId()){var p,q=ko.utils.arrayFilter(headerVM.rebateRules(),function(a){return a.id()==o.price().rebateRuleId()}),r=q[0].getKey(o);m[r]?p=m[r]:(p=new ShopCheckoutGroupItemBundleViewModel(-1,i,o),m[r]=p);var s=p.addBundle(o,l,k);l=s.bundleIndex,k=s.ticketNr}else for(var t=0;t<o.quantity();t++){var u=new ShopCheckoutItemBundleViewModel(l,i,a[n]);i.groupedEntries().push(u);for(var v=0;v<o.price().bundleItems().length;v++){var w=o.price().bundleItems()[v],x=new ShopCheckoutBundleItemModel(w,k,l,u,categoriesVM.getCategory(w.categoryKey()).categoryModel().config());i.entries.push(x),k++}l++}else{for(var t=0;t<o.quantity();t++){var x=new ShopCheckoutItemModel(o,k,n,ORDER_ITEM_TYPE_SIMPLE_ITEM,categoriesVM.getCategory(o.categoryKey()).categoryModel().config());i.entries().push(x),k++}var y=new ShopCheckoutItemGroupViewModel(n,i,o,menuVM.hasCashDeskSale()&&i.orderType()==CONTRACT_ORDERTYPE_CASHDESK);i.groupedEntries().push(y)}}for(var r in m)m[r].createEntries()}i.expandGroupedItems=function(){$("#shopCheckout").find(".expand").parents(".row-container").find(".row").slideToggle(),$("#shopCheckout").find(".expand").toggleClass("expand deflate")},i.totalPrice=ko.computed(function(){var a=0;i.categories.removeAll();for(var b=0;b<i.entries().length;b++){var c=i.entries()[b];if(!(c instanceof ShopCheckoutBundleItemModel)){a+=c instanceof ShopCheckoutBundleItemGroupModel?c.totalPrice():c.price().price();for(var d=!1,e=0;e<i.categories().length;e++){var f=i.categories()[e];if(f.categoryKey()==c.categoryKey()){f.quantity(f.quantity()+1),d=!0;break}}if(!d){var g=new categoryCountModel(c.categoryKey());i.categories.push(g)}}}for(var b=0;b<i.groupedEntries().length;b++){var j=i.groupedEntries()[b];if(j instanceof ShopCheckoutItemBundleViewModel)a=h(j,a);else if(j instanceof ShopCheckoutGroupItemBundleViewModel){var k=j.bundles();k.forEach(function(b){a=h(b,a)})}}return console.log("total proice",a),a},i),i.totalForeignPrice=ko.computed(function(){return i.totalPrice()*headerVM.selectedRateValue()},i),i.createForwardOrder=function(){console.log("forward ...");for(var a=0;a<i.entries().length;a++){var b=i.entries()[a];if(b.categoryKey()!=CATEGORY_KEY_BERGBAHN&&b.categoryKey()!=CATEGORY_KEY_BERGBAHN_EPR&&b.categoryKey()!=CATEGORY_KEY_BUNDLE&&b.categoryKey()!=CATEGORY_KEY_ADDON)return void showInfo(i18n.t("checkout.msg.forwardOfCategoryNotSupported",{category:b.categoryKey()}));if(b.coding()||showInfo("Beim Weiterleiten werden die eigegebenen Ticket IDs ignoriert."),!i.validateTravelTimes())return void showInfo(i18n.t("checkout.msg.selectedTimesConflict"))}i.disableCheckout(),i.performCreateForwardOrder()},i.performCreateForwardOrder=function(){console.log("creating order based on price: "+i.totalPrice());var a=i.paymentType();a===PAYMENTTYPE_CREDITCARD&&0===i.totalPrice()&&(a=PAYMENTTYPE_FREE);for(var b={amount:i.totalPrice(),paymentType:a,customerPaymentType:i.customerPaymentType(),type:ORDER_TYPE_FORWARD_ORDER,origOrderId:i.requestOrderId(),receiverId:null!=i.selectedTourGuide()?i.selectedTourGuide().id():null,comment:i.comment(),orderItems:[]},c=0;c<i.groupedEntries().length;c++){var d=i.groupedEntries()[c];if(d instanceof ShopCheckoutGroupItemBundleViewModel){d.bundles().forEach(function(a){var c=i.createBundleOrderItem(a);null!=c&&(console.log("Created bundle order item",c),b.orderItems.push(c))})}else{var e=i.createBundleOrderItem(d)
;null!=e&&(console.log("Created bundle order item",e),b.orderItems.push(e))}}for(var c=0;c<i.entries().length;c++){var d=i.entries()[c];d.price().sku()!=i.DUMMY_ADDON_SKU&&(d instanceof ShopCheckoutBundleItemGroupModel||(d.price()instanceof eprAddonPriceModel&&(d.disabledInCheckout()||!d.price().eprSelected())?console.log("Skipping disabled or not selected epr addon",d):b.orderItems.push(i.createOrderItem(d))))}var f=i.getDummyAddonIfNeeded();null!=f&&b.orderItems.push(i.createOrderItem(f)),$.ajax(serviceRootURL+"/orders",{type:"POST",data:JSON.stringify(b),dataType:"json",contentType:"application/json",success:function(a,b,c){getShoppingcartVM().requestOrderId(null),i.orderId(a.id),console.log("order created (id="+a.id+")"),shoppingcartVM.reset(),headerVM.loadPartner(!0),i.showForwardSuccess(i18n.t("checkout.msg.successForwardOrderComplete"))},error:function(a,b,c){console.log("Server error on creating forward order:\n"+a.responseText),headerVM.loadPartner(!0),i.handleForwardError(a,b,c)}})},i.handleForwardError=function(a,b,c){checkSession(a),i.showForwardError(i18n.t("checkout.msg.errorCreateForwardOrder")+"<br/>"+i.getError(a,b,c))},i.retryForwardOrder=function(){console.log("retrying forward ..."),i.disableCheckout(),i.createForwardOrder()},i.discardForward=function(){i.disableCheckout(),i.closeCheckout()},i.sendForwardOrder=function(){if(null==i.selectedTourGuide())return void showInfo(i18n.t("checkout.validation.notourguideselected"));i.disableCheckout();var a={id:i.orderId(),receiverId:i.selectedTourGuide().id(),receiverType:FORWARD_ORDER_RECEIVER_TYPE_TOURGUIDE,forwardAddress:i.selectedTourGuide().email(),forwardType:i.forwardType()};$.ajax({url:serviceRootURL+"/orders/"+i.orderId(),type:"PUT",data:JSON.stringify(a),dataType:"json",contentType:"application/json",success:function(a,b,c){console.log("order forwarded"+a),i.showSendForwardSuccess(i18n.t("checkout.msg.successSendForwardOrder"))},error:function(a,b,c){console.log("Server error on completing order:\n"+a.responseText),checkSession(a),i.showSendForwardError(i18n.t("checkout.msg.errorSendForwardOrder")+"<br/>"+i.getError(a,b,c))}})},i.showForwardSuccess=function(a){i.successMessage(a),$("#forwardError").slideUp(),$("#forwardSuccess").slideDown(),$(".send-body").slideDown(),$("#checkoutProduce, #checkoutReservation, #checkoutForward, #checkoutResume, #checkoutDiscardReservation, #checkoutDiscardForward, #checkoutFinish").hide(),$("#checkoutCancel, #checkoutSendForward").show(),$("#forwardError").find("button").removeAttr("disabled"),$("#forwardSuccess").find("button").removeAttr("disabled"),$(".modal-footer").find("button").removeAttr("disabled"),$(".send-body").slideDown(),i.showSpinner(!1)},i.showForwardError=function(a){i.disableCheckout(),i.errorMessage(a),$("#forwardSuccess").slideUp(),$("#forwardError").slideDown(),$("#checkoutProduce, #checkoutReservation, #checkoutForward, #checkoutDiscardReservation").hide(),$("#checkoutCancel, #checkoutDiscardForward").show(),$("#forwardError").find("button").removeAttr("disabled"),$("#forwardSuccess").find("button").removeAttr("disabled"),$(".modal-footer").find("button").removeAttr("disabled"),i.showSpinner(!1)},i.showSendForwardSuccess=function(a){i.successMessage(a),$("#senfForwardError").slideUp(),$("#forwardSuccess").slideUp(),$("#sendForwardSuccess").slideDown(),$(".send-body").slideUp(),$("#checkoutCancel, #checkoutProduce, #checkoutReservation, #checkoutForward, #checkoutResume, #checkoutDiscardReservation, #checkoutDiscardForward, #checkoutSendForward").hide(),$("#checkoutFinish").show(),$("#senfForwardError").find("button").removeAttr("disabled"),$("#sendForwardSuccess").find("button").removeAttr("disabled"),$(".modal-footer").find("button").removeAttr("disabled"),$(".send-body").slideUp(),i.showSpinner(!1)},i.showSendForwardError=function(a){i.disableCheckout(),i.errorMessage(a),$("#sendForwardSuccess").slideUp(),$("#forwardSuccess").slideUp(),$("#senfForwardError").slideDown(),$("#checkoutFinish").hide(),$("#checkoutCancel, #checkoutSendForward").show(),$(".send-body").slideDown(),$("#forwardError").find("button").removeAttr("disabled"),$("#forwardSuccess").find("button").removeAttr("disabled"),$(".modal-footer").find("button").removeAttr("disabled"),i.showSpinner(!1)},i.createReservationOrder=function(){console.log("forward ...");for(var a=0,b=0;b<i.entries().length;b++){i.entries()[b];if(++a>500)return void showInfo("Maximal 500 Tickets pro Bestellung möglich.")}i.disableCheckout(),i.performCreateReservationOrder()},i.performCreateReservationOrder=function(){console.log("performCreateReservationOrder ..."),console.log("creating order based on price: "+i.totalPrice());for(var a={amount:i.totalPrice(),paymentType:i.paymentType(),comment:i.comment(),type:ORDER_TYPE_RESERVATION_ORDER,orderItems:[]},b=0;b<i.groupedEntries().length;b++){var c=i.groupedEntries()[b].items()[0],d=i.groupedEntries()[b].quantity(),e={type:ORDER_ITEM_TYPE_SIMPLE_ITEM,quantity:d,price:c.price().price(),consumerKey:c.price().consumerKey(),categoryKey:c.categoryKey(),timeRangeId:c.price().timeRangeId(),timeRangeKey:c.price().timeRangeKey(),reductionLevel:c.price().reductionLevel(),rebateRuleId:c.price().rebateRuleId(),crossSeason:c.price().crossSeason(),productKey:c.price().productKey(),date:c.price().date(),media:"pickup",specificAttributes:c.price().getSpecificAttributes()};a.orderItems.push(e)}$.ajax(serviceRootURL+"/orders",{type:"POST",data:JSON.stringify(a),dataType:"json",contentType:"application/json",success:function(a,b,c){i.orderId(a.id),console.log("order created (id="+a.id+")"),shoppingcartVM.reset(),headerVM.loadPartner(!0),i.showReservationSuccess(i18n.t("checkout.msg.successReservationOrderComplete"))},error:function(a,b,c){console.log("Server error on creating reservation order:\n"+a.responseText),headerVM.loadPartner(!0),i.handleReservationError(a,b,c)}})},i.handleReservationError=function(a,b,c){checkSession(a),i.showReservationError(i18n.t("checkout.msg.errorCreateReservationOrder")+"<br/>"+i.getError(a,b,c))},i.retryReservationOrder=function(){console.log("retrying reservation ..."),i.disableCheckout(),i.createReservationOrder()},i.discardReservation=function(){i.disableCheckout(),i.closeCheckout()},i.showReservationSuccess=function(a){i.successMessage(a),$("#reservationError").slideUp(),$("#reservationSuccess").slideDown(),$("#checkoutProduce, #checkoutCancel, #checkoutReservation, #checkoutForward, #checkoutResume, #checkoutDiscardForward, #checkoutFinish").hide(),$("#checkoutFinish").show(),$("#reservationError").find("button").removeAttr("disabled"),$("#reservationSuccess").find("button").removeAttr("disabled"),$(".modal-footer").find("button").removeAttr("disabled")},i.showReservationError=function(a){i.disableCheckout(),i.errorMessage(a),$("#reservationSuccess").slideUp(),$("#reservationError").slideDown(),$("#checkoutProduce, #checkoutReservation, #checkoutForward").hide(),$("#checkoutCancel, #checkoutDiscardReservation").show(),$("#reservationError").find("button").removeAttr("disabled"),$("#reservationSuccess").find("button").removeAttr("disabled"),$(".modal-footer").find("button").removeAttr("disabled")},i.createGroupReservationOrder=function(){},i.discardGroupReservation=function(){},i.checkIfTrainReservationNeedsToBeShown=function(){for(var a=!1,b=[],c=0;c<i.entries().length;c++)var d=i.entries()[c];for(var c=0;c<i.entries().length;c++){var d=i.entries()[c];if(d instanceof ShopCheckoutBundleItemModel&&(0==d.price().sku().indexOf("DAYTRIPS.EPR")&&!0,d.categoryKey()==CATEGORY_KEY_ADDON&&d.price()instanceof eprAddonPriceModel)){if(null!=d.price().eprInfo()){i.eprTimeSelected(!0);var e=d.price().eprInfo().direction;"outward"==e?e=i18n.t("groupReservation.detail.journeyOutward.label"):"return"==e&&(e=i18n.t("groupReservation.detail.journeyReturn.label")),i.eprTimeslot()?b.indexOf(d.price().eprInfo().trainId+"-"+d.price().eprInfo().direction)>=0||(i.eprTimeslot(i.eprTimeslot()+"; "+e+": "+d.price().timeslot()),b.push(d.price().eprInfo().trainId+"-"+d.price().eprInfo().direction)):(i.eprTimeslot(e+": "+d.price().timeslot()),b.push(d.price().eprInfo().trainId+"-"+d.price().eprInfo().direction))}null!=d.price().selectedTrain()&&(a=!0)}}i.eprDaytripContained(!a)},i.checkIfTrainReservationNeedsToBeShown()}function media2Wtp(a,b,c){return console.log("Invoke mediacardextid ("+b+")"),$.getJSON(serviceRootURL+"/mediacardextid",{projectNumber:a,mediaId:b,isDTANr:c}).pipe(function(a){if(a)return console.log("wtp number: "+a),a}).fail(function(a,b,c){console.log("mediacard service failed: "+a.responseText),checkSession(a),showError("Fehler beim Laden der externen Media Card ID",a,b,c)})}function getSwisspassInfo(a,b){return console.log("Retrieving swisspass info via mediacardextinfo ("+a+", "+b+")"),$.getJSON(serviceRootURL+"/mediacardextinfo",{mediaId:a,zipCode:b}).pipe(function(a){if(a)return console.log("swisspass uid: "+a.mediaIdExt),a}).fail(function(a,b,c){console.log("mediacard service failed: "+a.responseText),checkSession(a),getErrorCode(a)==ERR_CODE_INVALID_MEDIAID&&showError(i18n.t("checkout.msg.swisspassInvalidMediaId"),a,b,c,!0)})}function validateKeycard(a,b){return console.log("Invoke mediacardextid ("+b+")"),null!=a.id()?$.getJSON(serviceRootURL+"/mediacardvalidateoi",{orderItemId:a.id(),mediaExtId:b}).fail(function(a,b,c){console.log("wtp validation failed: "+a.responseText),checkSession(a),showError("Fehler beim Überprüfen der WTP Nummer",a,b,c)}):$.getJSON(serviceRootURL+"/mediacardvalidate",{productKey:a.price().productKey(),consumerKey:a.price().consumerKey(),reductionLevel:a.price().reductionLevel(),categoryKey:a.categoryKey(),productValidFrom:a.price().date(),mediaExtId:b}).fail(function(a,b,c){console.log("wtp validation failed: "+a.responseText),checkSession(a),showError("Fehler beim Überprüfen der WTP Nummer",a,b,c)})}function validateDummyKeycard(a,b){if(console.log("Invoke dummy mediacardextid ("+b+")"),a.categoryKey()==CATEGORY_KEY_DEPOT)return $.getJSON(serviceRootURL+"/mediacardvalidate",{productKey:a.price().productKey(),consumerKey:a.price().consumerKey(),reductionLevel:a.price().reductionLevel(),categoryKey:a.categoryKey(),productValidFrom:a.price().date(),mediaExtId:DUMMY_WTP_NUMBER}).fail(function(a,b,c){console.log("wtp validation failed: "+a.responseText),checkSession(a),showError("Fehler beim Überprüfen der WTP Nummer",a,b,c)})}function headerBaseViewModel(){var a=this;a.showOperatorSelection=ko.observable(menuVM.isTourGuide()),a.showPrices=ko.observable(!menuVM.isTourGuide()),a.supportsPayment=ko.observable(!menuVM.isTourGuide()),a.rebateRules=ko.observableArray([]),a.isMobile=ko.observable(isBreakpoint("xs")),a.dateTimeOverwriteLocale=ko.observable(),a.categoryLabels=ko.observableArray([]),a.categoryLabelsMap=ko.computed(function(){var b={};return ko.utils.arrayForEach(a.categoryLabels(),function(a){b[a.key().toLowerCase()]=a}),b}),a.getCategoryLabelModel=function(a){return this.categoryLabelsMap()[a.toLowerCase()]},a.getCategoryLabel=function(a){return this.categoryLabelsMap()[a]&&this.categoryLabelsMap()[a].categoryLabel()?(console.log("categoryLabel = ",headerVM.categoryLabelsMap()[a].categoryLabel()),ko.observable(this.categoryLabelsMap()[a].categoryLabel())):null},a.getCategoryMenuLabel=function(a){return this.categoryLabelsMap()[a]&&this.categoryLabelsMap()[a].categoryMenuLabel()?(console.log("categoryMenuLabel = ",headerVM.categoryLabelsMap()[a].categoryMenuLabel()),ko.observable(this.categoryLabelsMap()[a].categoryMenuLabel())):null},a.getCategoryShortLabel=function(a){return this.categoryLabelsMap()[a]&&this.categoryLabelsMap()[a].categoryShortLabel()?(console.log("categoryShortLabel = ",headerVM.categoryLabelsMap()[a].categoryShortLabel()),ko.observable(this.categoryLabelsMap()[a].categoryShortLabel())):null},a.logoutWithCheck=function(a){null!=shoppingcartVM&&shoppingcartVM.quantity()>0?showQuestionYesNo("Beim Logout geht der Warenkorb verloren. Abmelden trotzdem durchführen?",function(b){1==b&&window.location.replace(a)}):window.location.replace(a)},a.loadRebateRules=function(){$.getJSON(serviceRootURL+"/rebaterules",function(b){var c=$.map(b,function(a){return getRebateRuleInstance(a)});a.rebateRules(c)}).fail(function(a,b,c){checkSession(a),showError("Fehler beim Laden der Rabatt Regeln",a,b,c)})},a.loadCategoryLabels=function(){$.getJSON(serviceRootURL+"/categories_labels",function(b){var c=$.map(b,function(a){return new categoryLabelModel(a)});a.categoryLabels(c)}).fail(function(a,b,c){checkSession(a),showError("Fehler beim Laden der Rabatt Regeln",a,b,c)})},a.loadRebateRules(),a.loadCategoryLabels()}function headerViewModel(a){var b=this;ko.utils.extend(b,new headerBaseViewModel),b.callbackFct=a,b.Rates=ko.observableArray([]),b.selectedRate=ko.observable(),b.CreditCards=ko.observableArray([]),b.hasSettingsExclamationMark=ko.observable(),b.orderReference=null,b.billingAddress=ko.observable(),b.Configs=ko.observableArray([]),b.Operations=ko.observable(),b.OrderTypes=ko.observableArray([]),b.hasOrderTypeCashdesk=ko.observable(),b.hasOrderTypeReservation=ko.observable(),b.PaymentTypes=ko.observableArray([]),b.hasPaymentTypeStoreCredits=menuVM.hasPaymentTypeStoreCredits,b.hasPaymentTypeInvoice=ko.observable(),b.hasPaymentTypeCreditCard=ko.observable(),b.getPreferredCreditCardDetails=ko.observable(),b.touristCardPermissions=ko.observableArray([]),b.storeCreditAmount=ko.observable(),b.scOrderLowerLimit=ko.observable(),b.scOrderUpperLimit=ko.observable(),b.scOrderDatatransLowerLimit=ko.observable(),b.scOrderDatatransUpperLimit=ko.observable(),b.datatransPaymentMethods=ko.observable(),b.isPartnerTypeHotel=ko.observable(),b.isPartnerTypeTourOperator=ko.observable(),b.pickupTeaser=ko.observable(),b.pickupTeaserMessage=ko.observable(),b.pickupTypes=ko.observable(),b.hasPickupTypeWebshop=ko.observable(),b.hasPickupTypeReservation=ko.observable(),b.optionsPickupOrderType=ko.observableArray([]),b.selectedRateName=ko.observable(),b.printerAvailable=ko.observable(!0),b.printerIsLocal=ko.observable(!0),b.printerState=ko.observable(PRINTER_STATE_NOT_AVAILABLE),b.CurrentPrinter=ko.observable(),b.cashDeskName=ko.observable(),b.Users=ko.observableArray([]),b.Cashdesks=ko.observableArray([]),b.Tourguides=ko.observableArray([]),b.shouldStartPrinterServer=ko.observable(!1),b.assignedPackageCustomerPartnerList=ko.observableArray(),b.assignedServiceProviderList=ko.observableArray(),b.activeAssignedServiceProviderList=ko.computed(function(){return b.assignedServiceProviderList().filter(function(a){return a.active})}),b.gexPresalePeriod=ko.observable(),b.gexCancellationPeriod=ko.observable(),b.registrationPartnerConfig=ko.observable(),b.isPaymentByCreditCardPossible=ko.observable(),b.customerPaymentTypes=ko.observableArray([]),b.includeRailwayTicketSelected=ko.observable(!0),b.allowUpdateFinishedOrder=ko.observable(!1),b.loadUsers=function(){$.getJSON(serviceRootURL+"/users",{loadDeleted:"true"},function(a){var c=$.map(a,function(a){return new userModel(a)});b.Users(c)}).fail(function(a,b,c){checkSession(a),showError("Fehler beim Laden der Benutzer für Filter",a,b,c)})},b.activeUsers=ko.computed(function(){return ko.utils.arrayFilter(b.Users(),function(a){return null!=a.deleted()&&!a.deleted()})}),b.tooltipPrinterState=ko.computed(function(){return i18n.t("header.tooltip.printerstate."+b.printerState())}),b.loadCashdesks=function(){$.getJSON(serviceRootURL+"/cashdesks",{loadDeleted:"true"},function(a){var c=$.map(a,function(a){return new cashdeskModel(a)});b.Cashdesks(c)}).fail(function(a,b,c){checkSession(a),showError("Fehler beim Laden der Cashdesks für Filter",a,b,c)})},b.activeCashdesks=ko.computed(function(){return ko.utils.arrayFilter(b.Cashdesks(),function(a){return null!=a.deleted()&&!a.deleted()})}),b.loadTourguides=function(){$.getJSON(serviceRootURL+"/tourguides",function(a){var c=$.map(a,function(a){return new tourguideModel(a)});b.Tourguides(c)}).fail(function(a,b,c){showError("Fehler beim Laden der Tourguides",a,b,c)})},b.selectedRateValue=ko.computed(function(){for(var a=0;a<b.Rates().length;a++)if(b.selectedRate()==b.Rates()[a].id())return b.selectedRateName(b.Rates()[a].name()),b.Rates()[a].rate()},b),b.hasSettingsExclamationMark=ko.computed(function(){for(var a=0;a<b.CreditCards().length;a++)if(!b.CreditCards()[a].isValid())return!0;return!1},b),b.loadPartner=function(a,c){$.ajax(serviceRootURL+"/partner",{type:"GET",data:{isStoreCreditReload:a},dataType:"json",contentType:"application/json",success:function(d,e,f){if(console.log("Partner loaded",d),b.storeCreditAmount(d.storeCreditAmount),b.assignedPackageCustomerPartnerList(d.assignedPackageCustomers),b.assignedServiceProviderList(d.assignedServiceProviderList),b.assignedServiceProviderList.sort(function(a,b){return a.name<b.name?-1:a.name>b.name?1:0}),b.assignedServiceProviderList().forEach(function(a){a.active||(a.name+=" ("+i18n.t("common.inactive")+")")}),b.gexPresalePeriod(d.gexPresalePeriod),b.gexCancellationPeriod(d.gexCancellationPeriod),b.registrationPartnerConfig(ko.mapping.fromJS(d.registrationPartnerConfig)),d.customerPaymentTypes&&b.customerPaymentTypes(d.customerPaymentTypes.split(",")),null!=d.includeRailwayTicketSelected&&b.includeRailwayTicketSelected(d.includeRailwayTicketSelected),console.log("Assigned service providers",d.assignedServiceProviderList),!a){var g=new addressModel(d.billingAddress);b.billingAddress(g);var h=$.map(d.configs,function(a){return new configModel(a)});if(b.Configs(h),null!=d.operations){b.Operations(d.operations);var i=d.operations+",";console.log("allowedOperations",i),menuVM.hasCashDeskSale(-1!=i.indexOf(PARTNER_OPERATION_CASHDESKSALE)),menuVM.hasDriverInfo(-1!=i.indexOf(PARTNER_OPERATION_DRIVERINFO)),menuVM.hasTourOperator(-1!=i.indexOf(PARTNER_OPERATION_TOUROPERATOR)),menuVM.hasAboPersonalisation(-1!=i.indexOf(PARTNER_OPERATION_ABO_PERSONALISATION)),menuVM.hasAboAdditionalValues(-1!=i.indexOf(PARTNER_OPERATION_ABO_ADDITIONALVALUES)),menuVM.hasAbo(-1!=i.indexOf(PARTNER_OPERATION_ABO_PERSONALISATION)||-1!=i.indexOf(PARTNER_OPERATION_ABO_ADDITIONALVALUES)),menuVM.hasAboSwapMedia(-1!=i.indexOf(PARTNER_OPERATION_ABO_SWAPMEDIA)),menuVM.hasRegistrationRights(-1!=i.indexOf(PARTNER_OPERATION_REGISTRATION)),menuVM.hasRegistrationReadOnlyRights(-1!=i.indexOf(PARTNER_OPERATION_REGISTRATION_READER)),menuVM.hasRegistrationNonMandatory(-1!=i.indexOf(PARTNER_OPERATION_REGISTRATION_NON_MANDATORY)),menuVM.hasPackageSellerRights(-1!=i.indexOf(PARTNER_OPERATION_PACKAGES_SELLER)),menuVM.hasPackageCustomerRights(-1!=i.indexOf(PARTNER_OPERATION_PACKAGES_CUSTOMER)),menuVM.hasRegistrationDiscardRights(-1!=i.indexOf(PARTNER_OPERATION_REGISTRATION_DISCARD))}if(menuVM.hasTourOperator()&&b.loadTourguides(),null!=d.orderTypes){var j=d.orderTypes;b.OrderTypes($.grep(j.split(","),function(a){return""!=a})),b.hasOrderTypeCashdesk(-1!=b.OrderTypes().indexOf(CONTRACT_ORDERTYPE_CASHDESK)),b.hasOrderTypeReservation(-1!=b.OrderTypes().indexOf(CONTRACT_ORDERTYPE_RESERVATION))}if(null!=d.paymentTypes){var k=d.paymentTypes;b.PaymentTypes($.grep(k.split(","),function(a){return""!=a})),menuVM.hasPaymentTypeStoreCredits(-1!=b.PaymentTypes().indexOf(PAYMENTTYPE_STORECREDITS)),b.hasPaymentTypeInvoice(-1!=b.PaymentTypes().indexOf(PAYMENTTYPE_INVOICE)),b.hasPaymentTypeCreditCard(-1!=b.PaymentTypes().indexOf(PAYMENTTYPE_CREDITCARD))}if(b.touristCardPermissions(d.touristCardPermissions+","),b.scOrderLowerLimit(d.scOrderLowerLimit),b.scOrderUpperLimit(d.scOrderUpperLimit),b.scOrderDatatransLowerLimit(d.scOrderDatatransLowerLimit),b.scOrderDatatransUpperLimit(d.scOrderDatatransUpperLimit),b.datatransPaymentMethods(d.datatransPaymentMethods),b.allowUpdateFinishedOrder(d.allowUpdateFinishedOrder),null!=d.partnerType&&""!=d.partnerType&&(b.isPartnerTypeHotel(-1!=d.partnerType.indexOf(PARTNERTYPE_HOTEL)),b.isPartnerTypeTourOperator(-1!=d.partnerType.indexOf(PARTNERTYPE_TO))),b.pickupTeaser(d.pickupTeaser),b.pickupTeaserMessage(d.pickupTeaserMessage),null!=d.pickupTypes){var l=d.pickupTypes;b.pickupTypes($.grep(l.split(","),function(a){return""!=a})),b.hasPickupTypeWebshop(-1!=b.pickupTypes().indexOf(PICKUP_TYPES_WEBSHOP)),b.hasPickupTypeReservation(-1!=b.pickupTypes().indexOf(PICKUP_TYPES_RESERVATION)),b.hasPickupTypeWebshop()&&b.optionsPickupOrderType.push({key:"webshop",name:i18n.t("tickets.orderType.webshop")}),b.hasPickupTypeReservation()&&b.optionsPickupOrderType.push({key:"reservation",name:i18n.t("tickets.orderType.reservation")})}}c&&c()},error:function(a,b,c){checkSession(a),showError("Fehler beim Laden des aktuellen B2B Partners",a,b,c),console.log("partner data not found")}})},b.loadPrinterConfig=function(){$.getJSON(serviceRootURL+"/cashdesk",function(a){b.cashDeskName(i18n.t("header.tooltip.cashdesk")+": "+a.name);var c=null;console.log("loadPrinterConfig returned: "+JSON.stringify(a)),$.each(a.printers,function(a,b){"RFID"==b.type==1&&(c=b)}),null!=c?(console.log("loadPrinterConfig found printer: "+JSON.stringify(c)),b.CurrentPrinter(new printerModel(c)),b.printerState(PRINTER_STATE_STOPPED),b.printerAvailable(!0),b.printerIsLocal(c.local),initHalAdapter(c.server,c.port),initPrinterAdapter(c.server,c.port,c.timeout),getHalAdapter().readInstalledVersion().done(function(a){console.log("installedVersion: "+a),b.CurrentPrinter().installedVersion(a)}),setTimeout(b.showPrinterState,1e3),c.local&&!isMac()&&b.shouldStartPrinterServer(!0)):(b.printerState(PRINTER_STATE_NOT_AVAILABLE),b.printerAvailable(!1))}).fail(function(a,c,d){b.printerState(PRINTER_STATE_NOT_AVAILABLE),b.printerAvailable(!1)})},b.showPrinterIcon=ko.computed(function(){return b.printerState()!==PRINTER_STATE_NOT_AVAILABLE}),b.showPrinterState=function(){getHalAdapter().getVersion().done(function(a){null==headerVM.CurrentPrinter()||headerVM.printerState()!=PRINTER_STATE_STOPPED&&headerVM.printerState()!=PRINTER_STATE_PRINTER_NOTREADY&&headerVM.printerState()!=PRINTER_STATE_OUTDATED_PRINTER_NOTREADY?b.setPrinterVersion(a,!0):checkPrinterState().done(function(c){b.setPrinterVersion(a,!0)}).fail(function(){console.log("printer is not active"),b.setPrinterVersion(a,!1)})}).fail(function(a,c,d){console.log("printer server is stopped"),headerVM.printerState(PRINTER_STATE_STOPPED),b.CurrentPrinter().version("")}),b.printerAvailable()&&setTimeout(b.showPrinterState,5e3)},b.setPrinterVersion=function(a,c){c||headerVM.printerState()!=PRINTER_STATE_STOPPED||showError("Bitte um Überprüfung, ob der Drucker verbunden und eingeschalten ist");var d=a.productVersion+" ("+a.productBuild+")";b.CurrentPrinter().installedVersion()==d?headerVM.printerState(c?PRINTER_STATE_RUNNING:PRINTER_STATE_PRINTER_NOTREADY):headerVM.printerState(c?PRINTER_STATE_OUTDATED:PRINTER_STATE_OUTDATED_PRINTER_NOTREADY),b.CurrentPrinter().version(d)},b.startPrinterServerAutomatically=function(){getHalAdapter().getVersion().done(function(a){a.productVersion,a.productBuild}).fail(function(a,b,c){console.log("printer server is stopped, starting server automatically"),getHalAdapter().downloadAndStartServer()})},b.printerRunning=ko.computed(function(){return b.printerState()!=PRINTER_STATE_NOT_AVAILABLE&&b.printerState()!=PRINTER_STATE_STOPPED&&b.printerState()!=PRINTER_STATE_PRINTER_NOTREADY&&b.printerState()!=PRINTER_STATE_OUTDATED_PRINTER_NOTREADY}),b.isPrinterServerRunning=ko.computed(function(){return b.printerState()==PRINTER_STATE_RUNNING||b.printerState()==PRINTER_STATE_OUTDATED||b.printerState()==PRINTER_STATE_PRINTER_NOTREADY||b.printerState()==PRINTER_STATE_OUTDATED_PRINTER_NOTREADY},b),b.setMobileExchangeRate=function(){var a=!1;if(null!=b.selectedRate()&&b.selectedRateName()!=STORE_CREDIT_EXCHANGE_RATE_NAME){for(var c=0;c<b.Rates().length;c++)if(b.Rates()[c].name()==STORE_CREDIT_EXCHANGE_RATE_NAME){b.selectedRate(b.Rates()[c].id()),a=!0;break}a||b.selectedRate(null)}},b.loadExchangeRates=function(){$.ajax(serviceRootURL+"/exchange_rates",{type:"GET",data:{includeStorecredits:!0},dataType:"json",contentType:"application/json",success:function(a,c,d){var e=$.map(a,function(a){return new exchangeRateModel(a)});b.Rates(e),null!=b.Rates()&&b.Rates().length>0&&b.selectedRate(b.Rates()[0].id()),isBreakpoint("xs")&&b.setMobileExchangeRate()},error:function(a,b,c){checkSession(a),showError("Fehler beim Laden der Wechselkurse",a,b,c)}})},b.loadCreditCards=function(){$.getJSON(serviceRootURL+"/paymentaliases",function(a){var c=$.map(a,function(a){return a.preferred&&a.isValid&&b.getPreferredCreditCardDetails({type:a.pmethod,number:a.maskedCC,validity:a.expm+"/"+a.expy}),new creditCardModel(a)});b.CreditCards(c),b.getPreferredCreditCardDetails()&&b.isPaymentByCreditCardPossible(!0)}).fail(function(a,b,c){401==a.status?console.log("Error loading Credit Cards for B2B Partner - access denied on play"):showError("Error loading Credit Cards for B2B Partner",a,b,c)})},b.loadDateTimeOverwriteLocale=function(){$.getJSON(serviceRootURL+"/configentry?key=ui.datetime.locale.overwrite",function(a){b.dateTimeOverwriteLocale(a),null!=a&&""!=a&&($.datepicker.setDefaults($.datepicker.regional[a]),DATE_PICKER_FORMAT=$.datepicker._defaults.dateFormat)}).fail(function(a,b,c){401==a.status?console.log("Error loading config entry access denied on play"):showError("Error loading config entry for B2B Partner",a,b,c)})},b.loadPartner(!1,b.callbackFct),b.loadPrinterConfig(),b.loadExchangeRates(),b.loadCreditCards(),b.loadDateTimeOverwriteLocale(),$(window).resize(debounce(function(){isBreakpoint("xs")&&b.setMobileExchangeRate(),b.isMobile(isBreakpoint("xs"))},200))}function initBaseHeader(){headerVM=new headerBaseViewModel,ko.applyBindings(headerVM,document.getElementById("headerInfo"))}function initHeader(a){headerVM=new headerViewModel(a),ko.applyBindings(headerVM,document.getElementById("headerInfo"))}function settingsHeaderViewModel(){var a=this;a.name="settingsHeaderViewModel",a.manualUrlHotel=ko.observable(getManualUrlHotel()),a.manualUrlTO=ko.observable(getManualUrlTO()),a.showHelp=function(){ko.cleanNode($("#showHelp")[0]);var a=new helpViewModel;ko.applyBindings(a,document.getElementById("showHelp"))},a.returnToLastPage=function(){history.back(),menuVM.hideNavigation(!1)},menuVM.hideNavigation(!0)}function settingsViewModel(){var a=this;a.name="settingsViewModel",a.billingAddress=headerVM.billingAddress,a.Configs=headerVM.Configs,a.CurrentUser=ko.observable(),a.Users=ko.observableArray([]),a.Rates=ko.observableArray([]),a.CreditCards=ko.observableArray([]),a.isValid=headerVM.isValid,a.skipassCategoryId=ko.observable(),a.Regions=ko.observableArray([]),a.skipassRegion=ko.observable(),a.CurrentPrinter=headerVM.CurrentPrinter,a.printerAvailable=headerVM.printerAvailable,a.printerState=headerVM.printerState,a.Locales=ko.observableArray([]),a.isSalesAdmin=menuVM.isSalesAdmin,a.packageDescriptionFileList=ko.observableArray(),a.tourguides=headerVM.Tourguides(),a.showCurrencyEdit=ko.computed(function(){return a.isSalesAdmin()||menuVM.isSalesCurrencyEdit()},a),a.skipassRegionValue=ko.computed(function(){if(null!=a.skipassCategoryId()&&a.Configs().length>0)for(var b=0;b<a.Configs().length;b++)if("region"==a.Configs()[b].optionKey()&&a.Configs()[b].categoryId()==a.skipassCategoryId())return a.skipassRegion(a.Configs()[b]),a.Configs()[b].optionValueKey()},a),a.saveRegistrationSettings=function(){var a=ko.mapping.toJSON(headerVM.registrationPartnerConfig());console.log("saveRegistrationSettings",a),$.ajax({url:serviceRootURL+"/registration_config/1",type:"PUT",data:a,dataType:"json",contentType:"application/json",beforeSend:function(){$("#registrationSettingsSaveBtn").attr("disabled",!0)},success:function(a,b,c){console.log("updateRegistrationSettings"),headerVM.loadPartner()},error:function(a,b,c){showError("Fehler beim Updaten der Registrierungsconfig",a,b,c)},complete:function(){$("#registrationSettingsSaveBtn").attr("disabled",!1)}})},a.loadLocales=function(){$.getJSON(serviceRootURL+"/common_options",{key:"locales"}).pipe(function(b){var c=$.map(b,function(a){return new optionModel(a)});a.Locales(c)}).fail(function(a,b,c){showError("Fehler beim Laden der Locales",a,b,c)})},a.loadLocales(),a.loadCurrentUser=function(){$.getJSON(serviceRootURL+"/user",function(b){a.CurrentUser(new userModel(b))}).fail(function(a,b,c){showError("Fehler beim Laden des aktuellen Users",a,b,c)})},a.loadExchangeRates=function(){$.getJSON(serviceRootURL+"/exchange_rates",function(b){var c=$.map(b,function(a){return new exchangeRateModel(a)});a.Rates(c),headerVM.loadExchangeRates()}).fail(function(a,b,c){showError("Fehler beim Laden der Wechselkurse für B2B Partner",a,b,c)})},a.handleCreditCardCallback=function(){getPaymentResponseMessage()&&bootbox.alert({title:getPaymentResponseTitle(),message:getPaymentResponseMessage(),callback:function(){setPaymentResponse(null,null)}})},a.loadCreditCards=function(){$.getJSON(serviceRootURL+"/paymentaliases",function(b){var c=$.map(b,function(a){return new creditCardModel(a)});a.CreditCards(c),headerVM.loadCreditCards()}).fail(function(a,b,c){401==a.status?console.log("Error loading Credit Cards for B2B Partner - access denied on play"):showError("Error loading Credit Cards for B2B Partner",a,b,c)})},a.loadUsers=function(){$.getJSON(serviceRootURL+"/users",function(b){var c=$.map(b,function(a){return new userModel(a)});a.Users(c)}).fail(function(a,b,c){showError("Fehler beim Laden der User für B2B Partner",a,b,c)})},a.loadCategories=function(){$.getJSON(serviceRootURL+"/categories?categoryType="+CATEGORY_TYPE_CASHDESKSALE+"&imagesAsLinks=true",function(b){for(var c=$.map(b,function(a){return new categoryModel(a)}),d=0;d<c.length;d++)"skipass"==c[d].key().toLowerCase()&&a.skipassCategoryId(c[d].id())}).fail(function(a,b,c){showError("Fehler beim Laden der Altersgruppen",a,b,c)})},a.loadRegions=function(){$.getJSON(serviceRootURL+"/options",{categoryKey:CATEGORY_KEY_SKIPASS,optionListKey:"regions",parentOptionListKey:"",parentOptionKey:""}).done(function(b){var c=$.map(b,function(a){return console.log(a),new optionModel(a)});a.Regions(c)}).fail(function(a,b,c){showError("Fehler beim Laden der SKIPASS Regionen",a,b,c)})},a.loadCurrentUser(),a.isSalesAdmin()&&(a.loadRegions(),a.loadCategories(),a.loadUsers(),a.loadCreditCards(),a.handleCreditCardCallback()),a.showCurrencyEdit()&&a.loadExchangeRates(),a.updatePassword=function(){ko.cleanNode($("#password")[0]),$("#password").modal("show"),$("#passwordForm").parsley();var b=new passwordEditViewModel(a.CurrentUser());ko.applyBindings(b,document.getElementById("password"))},a.updateExchangeRate=function(a){ko.cleanNode($("#addCurrency")[0]),$("#addCurrency").modal("show"),$("#currencyForm").parsley();var b=new exchangeRateModelEditViewModel(a);ko.applyBindings(b,document.getElementById("addCurrency"))},a.createExchangeRate=function(){ko.cleanNode($("#addCurrency")[0]),$("#addCurrency").modal("show"),$("#currencyForm").parsley();var a=new exchangeRateModelCreateViewModel;ko.applyBindings(a,document.getElementById("addCurrency"))},a.deleteExchangeRate=function(a){$.ajax({url:serviceRootURL+"/exchange_rates/"+a.id(),type:"DELETE",data:JSON.stringify(a.id()),contentType:"application/json",success:function(a,b,c){settingsVM.loadExchangeRates()},error:function(a,b,c){showError("Fehler beim Löschen von Wechselkursen",a,b,c)}})},a.updateCreditCard=function(a){return $.ajax({url:serviceRootURL+"/paymentaliases/"+a.id(),type:"PUT",data:JSON.stringify({id:a.id()}),contentType:"application/json",success:function(a,b,c){settingsVM.loadCreditCards()},error:function(a,b,c){401==a.status?console.log("EError while updating Preferred Credit Card - access denied on play"):showError("Error while updating Preferred Credit Card",a,textStatus,c)}}),!0},a.createCreditCard=function(){$.ajax(serviceRootURL+"/paymentaliasmessage",{type:"GET",dataType:"json",contentType:"application/json",success:function(a,b,c){console.log("get Payment Alias Message: ",a),a.successUrl=serviceRootURL+"/aliasSuccess",a.cancelUrl=serviceRootURL+"/paymentCancel",a.errorUrl=serviceRootURL+"/paymentError",a.themeConfiguration={initialView:"grid"}
;var d=$("datatransPaymentForm");Datatrans.startPayment({form:d.id,params:a})},error:function(a,b,c){console.log("Server error on creating Credit Card:"+a.responseText),checkSession(a),showError("Error on creating Credit Card",a,b,c)}})},a.deleteCreditCard=function(a){$.ajax({url:serviceRootURL+"/paymentaliases/"+a.id(),type:"DELETE",data:JSON.stringify({id:a.id()}),contentType:"application/json",success:function(a,b,c){settingsVM.loadCreditCards()},error:function(a,b,c){401==a.status?console.log("Error deleting Credit Cards for B2B Partner - access denied on play"):showError("Error deleting Credit Cards for B2B Partner",a,textStatus,c)}})},a.updateAddress=function(a){ko.cleanNode($("#address")[0]),$("#address").modal("show"),$("#addressForm").parsley();var b=new addressViewModel(a);ko.applyBindings(b,document.getElementById("address"))},a.updateUser=function(a){ko.cleanNode($("#editUser")[0]),$("#editUser").modal("show"),$("#updateForm").parsley();var b=new userEditViewModel(a);ko.applyBindings(b,document.getElementById("editUser"))},a.createUser=function(){ko.cleanNode($("#addUser")[0]),$("#addUser").modal("show"),$("#createForm").parsley(),$("#createForm").parsley().reset();var a=new userCreateViewModel;ko.applyBindings(a,document.getElementById("addUser"))},a.deleteUser=function(a){$.ajax({url:serviceRootURL+"/users/"+a.id(),type:"DELETE",data:JSON.stringify(a.id()),contentType:"application/json",success:function(a,b,c){settingsVM.loadUsers()},error:function(a,b,c){showError("Fehler beim Löschen von Usern",a,b,c)}})},a.tourguideAdd=function(){showTourguideAdd()},a.tourguideAddCallback=function(a){headerVM.loadTourguides()},a.deleteTourguide=function(a){$.ajax({url:serviceRootURL+"/tourguides/"+a.id(),type:"DELETE",data:JSON.stringify(a.id()),contentType:"application/json",success:function(a,b,c){headerVM.loadTourguides()},error:function(a,b,c){showError("Fehler beim Löschen von Tourguideverknüpfungen",a,b,c)}})},a.updateProductFilterConfig=function(b,c){var d=c.target,e=d.options[d.selectedIndex].value;if(null!=a.skipassRegion()&&null!=e){var f={id:a.skipassRegion().id(),categoryId:a.skipassRegion().categoryId(),optionKey:a.skipassRegion().optionKey(),optionValueKey:e};$.ajax({url:serviceRootURL+"/product_filter_configs/"+a.skipassRegion().id(),type:"PUT",data:JSON.stringify(f),dataType:"json",contentType:"application/json",success:function(a,b,c){headerVM.loadPartner(!1)},error:function(a,b,c){showError("Fehler bei Aktualisierung der Produktfilterkonfiguration",a,b,c)}})}},a.cleanPrinter=function(){ko.cleanNode($("#cleanPrinter")[0]);var a=new cleanPrinterViewModel;ko.applyBindings(a,document.getElementById("cleanPrinter"))},a.showHelp=function(){ko.cleanNode($("#showHelp")[0]);var a=new helpViewModel;ko.applyBindings(a,document.getElementById("showHelp"))},a.installServer=function(){getHalAdapter().downloadAndStartServer().done(function(a){return console.log("installServer returned: "+a),showInfo("installServer returned: "+a),a})},a.getVersion=function(){getHalAdapter().getVersion().done(function(a){return console.log("Version: "+JSON.stringify(a)),showInfo("Version: "+JSON.stringify(a)),a})},a.startPrinterServer=function(){return setTimeout(checkPrinterState,6e3),!0},a.stopPrinterServer=function(){getHalAdapter().shutdownServer(),headerVM.printerState(PRINTER_STATE_STOPPED),a.CurrentPrinter().version("")},a.getConfig=function(){getPrinterAdapter().getConfig().done(function(a){showInfo("received config: "+JSON.stringify(a))})},a.getDeviceState=function(){getPrinterAdapter().getDeviceState(a.CurrentPrinter().deviceNumber()).done(function(a){showInfo("received device state: "+JSON.stringify(a))})},a.readAndEjectTicket=function(){getPrinterAdapter().readAndEjectTicket(a.CurrentPrinter().deviceNumber(),!0).done(function(a){showInfo("received ticket info: "+JSON.stringify(a))})},a.printTicket=function(){var b={deviceNumber:a.CurrentPrinter().deviceNumber(),handFeed:!0,lines:{dir:"P",font:"2H",leftBound:!0,posX:4,posY:900,text:"Printertest"},ticketType:3};showInfo("printData: "+JSON.stringify(b)),getPrinterAdapter().printText(b).done(function(a){showInfo("received result: "+JSON.stringify(a))})},a.getPrinterAdapterType=function(){showInfo("Printer Adapter Type: "+getPrinterAdapter().getType())},this.optionsPrinterTrayConfig=ko.observableArray([{key:"skipass_bergbahn",name:i18n.t("settings.printer.trayConfig.skipass_bergbahn")},{key:"bergbahn_skipass",name:i18n.t("settings.printer.trayConfig.bergbahn_skipass")},{key:"skipass_voucher",name:i18n.t("settings.printer.trayConfig.skipass_voucher")},{key:"bergbahnhand_skipasspickup",name:i18n.t("settings.printer.trayConfig.bergbahnhand_skipasspickup")},{key:"bergbahntray_skipasspickup",name:i18n.t("settings.printer.trayConfig.bergbahntray_skipasspickup")}]),this.optionsPrinterBundleConfig=ko.observableArray([{key:"print",name:i18n.t("settings.printer.bundleConfig.print")},{key:"voucher",name:i18n.t("settings.printer.bundleConfig.voucher")}]),a.updatePrinter=function(b){var c={id:a.CurrentPrinter().id(),trayConfig:a.CurrentPrinter().trayConfig(),bundleConfig:a.CurrentPrinter().bundleConfig()};$.ajax({url:serviceRootURL+"/printer/"+a.CurrentPrinter().id(),type:"PUT",data:JSON.stringify(c),dataType:"json",contentType:"application/json",success:function(a,b,c){console.log("printer updated"),headerVM.loadPrinterConfig()},error:function(a,b,c){showError("Fehler bei Aktualisierung der Druckerkonfiguration",a,b,c)}})}}function passwordEditViewModel(a){var b=this;b.userid=ko.observable(a.id()),b.oldpassword=ko.observable(),b.newpassword=ko.observable(),b.newpassword2=ko.observable(),b.updating=ko.observable(!1),b.updatePassword=function(a){if(b.newpassword()!=b.newpassword2())return showError(i18n.t("settings.changePasswordDetail.passwordsNotMatching")),void $("body").find("div.modal-dialog").addClass("settings-modal-box-size");b.updating(!0);var c={id:b.userid(),password:b.newpassword(),oldpassword:b.oldpassword()};$.ajax({url:serviceRootURL+"/users/"+b.userid(),type:"PUT",data:JSON.stringify(c),dataType:"json",contentType:"application/json",success:function(a,b,c){showInfo(i18n.t("settings.changePasswordDetail.passwordChangeSuccessful"),function(){$("#password").modal("hide"),$("#password").on("hidden.bs.modal",function(){settingsVM.loadCurrentUser()})}),$("body").find("div.modal-dialog").addClass("settings-modal-box-size")},error:function(a,b,c){showError("Fehler bei Aktualisierung des Passworts",a,b,c)},complete:function(){b.updating(!1)}})}}function exchangeRateModelEditViewModel(a){self.id=ko.observable(a.id()),self.ratename=ko.observable(a.name()),self.rate=ko.observable(a.rate()),self.updateExchangeRate=function(a){var b={id:self.id(),name:self.ratename(),rate:self.rate()};$.ajax({url:serviceRootURL+"/exchange_rates/"+self.id(),type:"PUT",data:JSON.stringify(b),dataType:"json",contentType:"application/json",success:function(a,b,c){console.log("updated an exchange rate"),$("#addCurrency").modal("hide"),$("#addCurrency").on("hidden.bs.modal",function(){settingsVM.loadExchangeRates()})},error:function(a,b,c){showError("Fehler bei Aktualisierung Wechselkurs",a,b,c)}})}}function exchangeRateModelCreateViewModel(){self.ratename=ko.observable(),self.rate=ko.observable(),self.name="exchangeRateModelCreateViewModel",self.updateExchangeRate=function(a){var b={name:self.ratename(),rate:self.rate()};$.ajax(serviceRootURL+"/exchange_rates",{type:"POST",data:JSON.stringify(b),dataType:"json",contentType:"application/json",success:function(a,b,c){console.log("create an exchange rate"),$("#addCurrency").modal("hide"),$("#addCurrency").on("hidden.bs.modal",function(){settingsVM.loadExchangeRates()})},error:function(a,b,c){showError("Fehler beim Erstellung Wechselkurs",a,b,c)}})}}function addressViewModel(a){self.id=ko.observable(a.id()),self.firstname=ko.observable(a.firstname()),self.lastname=ko.observable(a.lastname()),self.street=ko.observable(a.street()),self.postcode=ko.observable(a.postcode()),self.city=ko.observable(a.city()),self.updateAddress=function(a){var b={id:self.id(),firstname:self.firstname(),lastname:self.lastname(),street:self.street(),postcode:self.postcode(),city:self.city()};$.ajax({url:serviceRootURL+"/address/"+self.id(),type:"PUT",data:JSON.stringify(b),dataType:"json",contentType:"application/json",success:function(a,b,c){console.log("updated the address"),$("#address").modal("hide"),$("#address").on("hidden.bs.modal",function(){headerVM.loadPartner(!1)})},error:function(a,b,c){showError("Fehler bei Adress Aktualisierung",a,b,c)}})}}function userEditViewModel(a){self.id=ko.observable(a.id()),self.username=ko.observable(a.username()),self.firstname=ko.observable(a.firstname()),self.lastname=ko.observable(a.lastname()),self.email=ko.observable(a.email()),self.password=ko.observable(a.password()),self.roles=ko.observableArray(a.roles()),self.viewrole=ko.observable(a.viewrole()),self.selectedLocale=ko.observable(a.locale()),self.oldLocale=a.locale(),self.Locales=settingsVM.Locales,self.currencyEdit=ko.computed(function(){return null!=ko.utils.arrayFirst(self.roles(),function(a){return"SalesCurrencyEdit"===a})},self),self.updateUser=function(a){var b={id:self.id(),username:self.username(),firstname:self.firstname(),lastname:self.lastname(),email:self.email(),locale:self.selectedLocale(),password:self.password(),roles:self.roles()};$.ajax({url:serviceRootURL+"/users/"+self.id(),type:"PUT",data:JSON.stringify(b),dataType:"json",contentType:"application/json",success:function(a,b,c){console.log("updated a User"),$("#editUser").modal("hide"),$("#editUser").on("hidden.bs.modal",function(){if(self.username()==subjectIdentifier&&self.oldLocale!=self.selectedLocale())return void location.reload();settingsVM.loadUsers()})},error:function(a,b,c){showError("Fehler bei User Aktualisierung",a,b,c)}})}}function userCreateViewModel(){self.name="userCreateViewModel",self.username=ko.observable(),self.firstname=ko.observable(),self.lastname=ko.observable(),self.email=ko.observable(),self.password=ko.observable().extend({minLength:{params:3,message:"Bitte gültige Zahl eingeben"},maxLength:10}),self.currencyEdit=ko.observable(),self.changepwd=ko.observable(!1),self.selectedLocale=ko.observable(),self.Locales=settingsVM.Locales,self.createUser=function(a){var b=["Sales"];self.currencyEdit()&&b.push("SalesCurrencyEdit");var c={username:self.username(),firstname:self.firstname(),lastname:self.lastname(),email:self.email(),locale:self.selectedLocale(),password:self.password(),changepwd:self.changepwd(),roles:b};$.ajax(serviceRootURL+"/users",{type:"POST",data:JSON.stringify(c),dataType:"json",contentType:"application/json",success:function(a,b,c){console.log("create a User"),$("#addUser").modal("hide"),$("#addUser").on("hidden.bs.modal",function(){settingsVM.loadUsers()})},error:function(a,b,c){showError("Fehler bei User Erstellung",a,b,c)}})}}function changePasswordViewModel(a){self.userid=ko.observable(a),self.oldpassword=ko.observable(),self.newpassword=ko.observable(),self.newpassword2=ko.observable(),self.updatePassword=function(a){try{if(self.newpassword()!=self.newpassword2())return showError(i18n.t("settings.changePasswordDetail.passwordsNotMatching")),$("body").find("div.modal-dialog").addClass("settings-modal-box-size"),void $("#passwordForm").find("button:submit").attr("disabled",!1);var b={id:self.userid(),password:self.newpassword(),oldpassword:self.oldpassword()};$.ajax({url:serviceRootURL+"/users/"+self.userid(),type:"PUT",data:JSON.stringify(b),dataType:"json",contentType:"application/json",success:function(a,b,c){showInfo(i18n.t("settings.changePasswordDetail.passwordChangeSuccessful"),function(){$("#navSettings").show(),showStartTab()}),$("body").find("div.modal-dialog").addClass("settings-modal-box-size")},error:function(a,b,c){showError("Fehler bei Aktualisierung des Passworts",a,b,c),$("#passwordForm").find("button:submit").attr("disabled",!1)}})}catch(a){showException("Ausnahmefehler beim Aktualisieren des Passworts",a),$("#passwordForm").find("button:submit").attr("disabled",!1)}}}function cleanPrinterViewModel(){self.title=ko.observable(),self.content=ko.observable(),self.name="cleanPrinterViewModel",self.isActive=ko.observable(!1),console.log("retrieving static block for printer cleaning"),$.ajax(serviceRootURL+"/staticblocks/clean_rfid_printer",{type:"GET",dataType:"json",contentType:"application/json",success:function(a,b,c){console.log("static block found: "+a),self.title(a.title),self.content(a.content),$("#cleanPrinter").modal("show")},error:function(a,b,c){console.log("Server error on loading static block: "+a.responseText),checkSession(a),showError("Fehler beim Laden der Druckerreinigungsinfo",a,b,c)}}),self.cleanPrintingHead=function(a){self.isActive(!0),cleanPrintHead().done(function(a){console.log("cleanPrintingHead done"),self.isActive(!1)}).fail(function(a,b,c){checkSession(a),self.isActive(!1)})},self.cleanFeedRollers=function(a){self.isActive(!0),cleanDriveRollers().done(function(a){console.log("cleanDriveRollers done"),self.isActive(!1)}).fail(function(a,b,c){checkSession(a),self.isActive(!1)})}}function helpViewModel(){self.title=ko.observable(),self.content=ko.observable(),self.name="helpViewModel",self.isActive=ko.observable(!1),console.log("retrieving static block for printer cleaning"),$.ajax(serviceRootURL+"/staticblocks/help_links",{type:"GET",dataType:"json",contentType:"application/json",success:function(a,b,c){console.log("static block found: "+a),self.title(a.title),self.content(a.content),$("#showHelp").modal("show")},error:function(a,b,c){console.log("Server error on loading static block: "+a.responseText),checkSession(a),showInfo(i18n.t("settings.helpError"))}})}function showSettings(){cleanContainer(),$("#container").load("assets/setting.html",function(){settingsVM=new settingsViewModel,ko.applyBindings(settingsVM,document.getElementById("settingsInfo")),ko.applyBindings(new settingsHeaderViewModel,document.getElementById("settingsHeader"))})}function showChangePassword(){$("#navSettings").hide(),cleanContainer(),$("#container").load("assets/change-password.html",function(){$.getJSON(serviceRootURL+"/user",function(a){var b=new changePasswordViewModel(a.id);ko.applyBindings(b,document.getElementById("changePassword"))}).fail(function(a,b,c){showError("Fehler beim Laden des aktuellen Users",a,b,c)})})}function reportViewModel(){var a=this;a.fromDate=ko.observable(),a.toDate=ko.observable(),a.loading=ko.observable(!1),a.busy=ko.observable(!1),a.selectFromDate=function(b,c){var d=c.target.value;if(""!=d)try{var e=$.datepicker.parseDate(DATE_PICKER_FORMAT,d),f=null;a.toDate()&&(f=$.datepicker.parseDate(DATE_SERVER_FORMAT,a.toDate())),null!=f&&e>f?a.resetFromDate(c.target):a.fromDate($.datepicker.formatDate(DATE_SERVER_FORMAT,e))}catch(b){a.resetFromDate(c.target)}else a.fromDate("")},a.resetFromDate=function(b){var c=$.datepicker.parseDate(DATE_SERVER_FORMAT,a.fromDate()),d=$.datepicker.formatDate(DATE_PICKER_FORMAT,c);$(b).val(d)},a.selectToDate=function(b,c){var d=c.target.value;if(""!=d)try{var e=$.datepicker.parseDate(DATE_PICKER_FORMAT,d),f=null;a.fromDate()&&(f=$.datepicker.parseDate(DATE_SERVER_FORMAT,a.fromDate())),null!=f&&e<f?a.resetToDate(c.target):a.toDate($.datepicker.formatDate(DATE_SERVER_FORMAT,e))}catch(b){a.resetToDate(c.target)}else a.toDate("")},a.resetToDate=function(b){var c=$.datepicker.parseDate(DATE_SERVER_FORMAT,a.toDate()),d=$.datepicker.formatDate(DATE_PICKER_FORMAT,c);console.log("$(target)",$(b),b),$(b).val(d)},a.disableFilter=function(){a.busy(!0),$(".filter-panel").find("select").attr("disabled","true"),$(".filter-panel").find("label").attr("disabled","true"),$(".filter-panel").find("input").attr("disabled","true"),$(".filter-panel").find("button").attr("disabled","true")},a.enableFilter=function(){a.busy(!1),$(".filter-panel").find("select").removeAttr("disabled"),$(".filter-panel").find("label").removeAttr("disabled"),$(".filter-panel").find("input").removeAttr("disabled"),headerVM.printerState&&(headerVM.printerRunning()?$(".filter-panel").find("button").removeAttr("disabled"):$(".filter-panel").find("button").not("#salesInfoMediaIdBtn").removeAttr("disabled"))}}function abstractSalesViewModel(){var a=this;ko.utils.extend(a,new reportViewModel),a.Orders=ko.observableArray([]),a.dateRange=ko.observable(DATE_RANGE_ORDERDATE),a.todayPrev=ko.observable(),a.performSearchOrders=function(b){$(".dateRange").fadeOut(),a.disableFilter(),a.loading(!0);try{$.ajax(serviceRootURL+"/orders",{type:"GET",data:b,dataType:"json",contentType:"application/json",success:function(b,c,d){var e=$.map(b,function(a){return getOrderInstance(a)});a.Orders(e),console.log("orders found: ",b,a.Orders()),$.getScript("assets/js/jungfrau.min.js"),a.enableFilter(),a.loading(!1)},error:function(b,c,d){checkSession(b),a.enableFilter(),console.log("Server error on loading orders: "+b.responseText),showError("Fehler beim Laden der Bestellungen",b,c,d),a.loading(!1)}})}catch(b){a.enableFilter(),console.log("Exception on loading orders: "+b),showException("Fehler beim Laden der Bestellungen",b),a.loading(!1)}},a.selectToday=ko.computed(function(b,c){a.today()!=a.todayPrev()&&("option1"==a.today()?(a.todayPrev(a.today()),a.fromDate($.datepicker.formatDate(DATE_SERVER_FORMAT,new Date)),a.toDate($.datepicker.formatDate(DATE_SERVER_FORMAT,new Date)),$("#startDate").val(""),$("#endDate").val(""),$(".dateRange").fadeOut(),a.searchOrders()):"option2"==a.today()?(a.todayPrev(a.today()),""==$("#startDate").val()&&a.fromDate(""),""==$("#endDate").val()&&a.toDate("")):"last2Months"==a.today()&&(a.todayPrev(a.today()),lowerBound=moment(new Date).subtract(2,"month"),a.fromDate($.datepicker.formatDate(DATE_SERVER_FORMAT,lowerBound.toDate())),a.toDate(""),$("#startDate").val(""),$("#endDate").val(""),$(".dateRange").fadeOut(),a.searchOrders()))}),a.selectDatefrom=function(b,c){var d=c.target,e=$(d).find("input").val();a.dateRange(e),a.searchOrders()},a.toggleOrder=function(a){$(a).hasClass("btn-voucher")||($(a).parents(".overview-body").find(".glyphicon").toggleClass("expand deflate"),$(a).parents(".overview-body").find("> .row").slideToggle())},a.toggleBundle=function(a,b){if(a instanceof orderItemBundleModel){var c=b.target;if($(c).hasClass("cancel-checkbox"))return!0;var d=ko.contextFor(c),e="bundle-"+d.$index();$(c).parents("tr").find(".glyphicon").toggleClass("expand deflate"),$(c).parents("tbody").find("> ."+e).slideToggle()}return!0},a.getOrder=function(b,c){var d=c.target;$(c.target).parents(".overview-body").find(".glyphicon").hasClass("deflate")?a.toggleOrder(d):a.performGetOrder(b,d)}}function salesViewModel(){var a=this;a.searchText=ko.observable();var b=a.searchText();a.today=ko.observable("saasfee"==theme?"last2Months":"option1"),a.selectedCategory=ko.observable(),a.searchOrders=function(){$("#salesSearchForm").find("div").removeClass("has-error"),$("#salesInfoSearchText").prop("title","");var c={fromDate:a.fromDate(),toDate:a.toDate(),searchText:a.searchText(),dateRange:a.dateRange(),loadItems:!1,restrictStates:!0,loadForwardOrders:!1,loadCashdeskOrders:!0,prodCat:a.selectedCategory()};isAxessBackend(CATEGORY_KEY_SKIPASS)&&null!=a.searchText()&&isDTANumber(a.searchText())?media2Wtp(100,a.searchText(),!0).done(function(b){console.log(b),a.searchText(b),a.performSearchOrders(c)}).fail(function(){console.log("invalid dta number: "+b),$("#salesInfoSearchText").prop("title","Ungültige DTA Keycard Nummer"),$("#salesSearchForm").find("div").addClass("has-error")}):a.performSearchOrders(c)},abstractSalesViewModel.apply(a,[]),a.performGetOrder=function(b,c){console.log("retrieving details for order: ",b),a.busy(!0),$.ajax(serviceRootURL+"/orders/"+b.id(),{type:"GET",data:{consumptionCheck:!0,restrictStates:!0,bundleMode:PARAMKEY_GETORDER_BUNDLEMODE_EXPLODED},context:{oldOrder:b,element:c},dataType:"json",contentType:"application/json",success:function(c,d,e){b.setOrderDetails(c),null!=this.element&&a.toggleOrder(this.element),console.log("order found: ",c,b),a.busy(!1)},error:function(b,c,d){console.log("Server error on loading order: "+b.responseText),checkSession(b),a.busy(!1),showError("Fehler beim Laden der Bestellung",b,c,d)}})},a.getMediaId=function(b,c){console.log("handling media id onfocus event"),$("#salesInfoSearchText").attr("disabled","true"),$("#salesInfoSearchBtn").attr("disabled","true"),printerGetMediaId().done(function(b){if(b.valid){var c=b.mediaId;media2Wtp(b.projectNumber,c,!1).done(function(b){console.log(b),getAuditLogAdapter().writeLog(EXISTING_TICKET_READ,c,b),a.searchText(b),$("#salesInfoSearchText").removeAttr("disabled"),$("#salesInfoSearchBtn").removeAttr("disabled"),$("#salesInfoSearchBtn").focus()})}else showError("Ungültige Karte gelesen")}).fail(function(a,b,c){checkSession(a),$("#salesInfoSearchText").removeAttr("disabled"),$("#salesInfoSearchBtn").removeAttr("disabled")})},a.cancelBtnDisabled=function(a){for(var b=0;b<a.orderItems().length;b++){if(a.orderItems()[b].cancelOrderItem())return!1}return!0},a.showCancelOrder=function(b,c){for(var d=!1,e=(c.target,!1),f=!1,g=!1,h=!1,i=[],j=0;j<b.orderItems().length;j++){var k=b.orderItems()[j];if(k instanceof orderItemBundleModel)for(var l=0;l<k.bundleItems().length;l++){var m=k.bundleItems()[l];m.cancelOrderItem()&&(d=!0,i.push(m))}k.cancelOrderItem()?(d=!0,i.push(k),null!=k.rebateRuleId()&&("-1"==k.rebateRuleId()?h=!0:e=!0)):null!=k.rebateRuleId()&&(f=!0,k.cancelable()||(g=!0))}if(console.log("cancel",e,g,i),!e||!g)return h&&f?void showQuestionOkCancel(i18n.t("cancelDetail.msg.gexCancelQuestion"),function(d){setTimeout(function(){if(d){for(var e=0;e<b.orderItems().length;e++){var f=b.orderItems()[e];null!=f.rebateRuleId()&&f.cancelOrderItem(!0)}a.showCancelOrder(b,c)}},1e3)}):e&&f?void showQuestionOkCancel(i18n.t("cancelDetail.msg.rebateRuleCancelQuestion"),function(d){setTimeout(function(){if(d){for(var e=0;e<b.orderItems().length;e++){var f=b.orderItems()[e];null!=f.rebateRuleId()&&f.cancelOrderItem(!0)}a.showCancelOrder(b,c)}},1e3)}):d?void $(".cancel-detail").load("assets/cancel-detail.html",function(){$("#cancelDetail").modal("show"),cancelVM=new cancelViewModel(b),ko.applyBindings(cancelVM,document.getElementById("cancelDetail"))}):void showError(i18n.t("cancelDetail.msg.noSelection"));showInfo(i18n.t("cancelDetail.msg.rebateRuleCancel"));for(var j=0;j<b.orderItems().length;j++){var k=b.orderItems()[j];k.cancelOrderItem()&&k.cancelOrderItem(!1)}},a.isUpdateAllowed=function(){return headerVM.allowUpdateFinishedOrder()},a.checkValidUpdateOrder=function(b){var c=!0;if("function"==typeof b.orderItems)for(var d=0;d<b.orderItems().length;d++)"BERGBAHN"===b.orderItems()[d].categoryKey()&&"660"===b.orderItems()[d].tariffKey()&&!1!==a.checkValidRebateRules(b.orderItems()[d])||(c=!1);return c},a.checkValidRebateRules=function(a){for(var b=!1,c=a.rebateRuleId(),d=0;d<headerVM.rebateRules().length;d++){var e=headerVM.rebateRules()[d];if(e.id()===c){var f=e.rule().split(";"),g=f[0],h=f[4];g.toString().startsWith("660")&&"0"===h&&(b=!0)}}return b},a.showUpdateOrder=function(b,c){!0===a.checkValidUpdateOrder(b)?$(".update-detail").load("assets/update-detail.html",function(){$("#updateDetail").modal("show"),cancelVM=new updateViewModel(b),ko.applyBindings(cancelVM,document.getElementById("updateDetail"))}):showInfo(i18n.t("updateDetail.msg.updateNotAllowed"))},a.showOrderItemCancelInfo=function(a){if(a()){var b=a().cancelability();if(b==ORDER_ITEM_CANCEL_INFO_POSSIBLE){if(a().cancelableUntil()){var c=moment(a().cancelableUntil()).format("L LTS");return i18n.t("sales.orderDetails.cancelPossibleUntil",{date:c})}return i18n.t("sales.orderDetails.cancelState."+b)}if(b==ORDER_ITEM_CANCEL_INFO_NOT_POSSIBLE||b==ORDER_ITEM_CANCEL_INFO_ALREADY_USED||b==ORDER_ITEM_CANCEL_INFO_CANCELLED)return i18n.t("sales.orderDetails.cancelState."+b)}},a.startPdfVoucher=function(a){var b=a.id();window.open("/print_voucher/"+b,"_blank","toolbar=no, location=no, status=no, scrollbars=yes, resizable=yes")},a.startPdfReservationVoucher=function(a){console.log("print voucher for order items: "+a.id()),window.open("/print_reservation_pickup_voucher?items="+a.id(),"_blank","toolbar=no, location=no, status=no, scrollbars=yes, resizable=yes"),window.location="/print_reservation_pickup_voucher?download=true&items="+a.id()}}function updateViewModel(a){var b=this;b.order=a,b.categories=ko.observableArray([]),b.errorMessage=ko.observable(),b.cancelOrder=ko.observable(a.cancelOrder()),b.showSpinner=ko.observable(!1),b.updateOrder=ko.observable(),b.updateOrderItems=ko.observableArray(),b.entries=ko.computed(function(){for(var c=[],d=0;d<a.orderItems().length;d++){var e=a.orderItems()[d];if(e instanceof orderItemBundleModel&&!1===e.cancelOrderItem())for(var f=0;f<e.bundleItems().length;f++){var g=e.bundleItems()[f];g.cancelOrderItem()&&c.push(g)}e.cancelOrderItem()&&c.push(e)}return c.length<b.order.orderItems().length&&b.cancelOrder(!1),c}),b.findProductName=function(a){if(null!=a){return a.categoryKey()===CATEGORY_KEY_SKIPASS?a.regionName()+"-"+a.durationName()+"-"+a.date():a.categoryKey()===CATEGORY_KEY_BERGBAHN_EPR?a.routeName()+"-"+a.train()+"-"+moment(a.date()).format("L"):a.categoryKey()===CATEGORY_KEY_BERGBAHN||a.categoryKey()===CATEGORY_KEY_PUBLICTRANSPORTATION||a.categoryKey()===CATEGORY_KEY_RAILWAY_SEAT_RESERVATION||a.categoryKey()===CATEGORY_KEY_RAILWAY_SEAT_RESERVATION_MRAG||a.categoryKey()===CATEGORY_KEY_RAILWAY_SEAT_RESERVATION_TIMETABLE?a.fromName()+"-"+a.toName()+"-"+a.className()+"-"+a.tripTypeName()+"-"+moment(a.date()).format("L"):a.productName()+"-"+moment(a.date()).format("L")}},b.groupedEntries=ko.computed(function(){for(var c=[],d=[],e=0;e<a.orderItems().length;e++){var f=a.orderItems()[e],g=b.findProductName(f);null!=f.rebateRuleId()&&f.rebateRuleId();var h=f.categoryName()+"-"+f.consumerName()+"-"+g;h in d?d[h]++:d[h]=1}for(var i in d)for(var j=0;j<a.orderItems().length;j++){var k=a.orderItems()[j],l=b.findProductName(k);if(i===k.categoryName()+"-"+k.consumerName()+"-"+l){k.quantityProduceOriginal(d[i]),k.quantityProduce(d[i]),c.push(k);break}}return c}),b.totalPrice=ko.computed(function(){var a=0;b.categories.removeAll();for(var c=0;c<b.entries().length;c++){var d=b.entries()[c];a+=d.price();for(var e=!1,f=0;f<b.categories().length;f++){var g=b.categories()[f];if(g.categoryKey()==d.categoryKey()){g.quantity(g.quantity()+1),e=!0;break}}if(!e){var h=new categoryCountModel(d.categoryKey());b.categories.push(h)}}return a},b),b.totalForeignPrice=ko.computed(function(){return b.totalPrice()*headerVM.selectedRateValue()},b),b.performUpdateOrder=function(){console.log("performUpdateOrder: "+a.id());for(var c=!1,d=0,e=[],f=1,g=null,h=0;h<b.groupedEntries().length;h++){b.groupedEntries()[h].quantityProduce(Number(document.getElementById("quantityText"+h).value)),d+=b.groupedEntries()[h].amount()*Number(b.groupedEntries()[h].quantityProduce()),b.groupedEntries()[h].quantityProduce()!==b.groupedEntries()[h].quantityProduceOriginal()&&(c=!0);for(var i=0;i<b.groupedEntries()[h].quantityProduce();i++)e.push(b.groupedEntries()[h]),g={id:null,ticketNr:f,media:b.groupedEntries()[h].media(),produced:!1},b.updateOrderItems.push(g),f++}if(document.getElementById("totalPrice").innerHTML=(Math.round(100*d)/100).toFixed(2),!1===c)return void showInfo(i18n.t("updateDetail.msg.orderNotChanged"));b.showSpinner(!0),b.disableUpdate();var j=b.createUpdateOrderJson(a,e,d);b.performCreateOrder(j,!0)},b.createUpdateOrderJson=function(a,b,c){for(var d=null,e=null,f=null,g=null,h=null,i=null,j=null,k=null,l=null,m=null,n=null,o=null,p=null,q=null,r=null,s=null,t=null,u=null,v=null,w=null,x=null,y=null,z=null,A=null,B=null,C=null,D=null,E=null,F=null,G=null,H=null,I=null,J=null,K=0;K<b.length;K++)d=K+1,null!=b[K].type&&(e=b[K].type()),null!=b[K].firstname&&(f=b[K].firstname()),null!=b[K].lastname&&(g=b[K].lastname()),null!=b[K].phone&&(h=b[K].phone()),null!=b[K].price&&(i=b[K].price()),null!=b[K].sku&&(j=b[K].sku()),null!=b[K].consumerKey&&(k=b[K].consumerKey()),null!=b[K].categoryKey&&(l=b[K].categoryKey()),null!=b[K].productKey&&(n=b[K].productKey()),null!=b[K].date&&(o=b[K].date()),null!=b[K].rebateRuleId&&(m=b[K].rebateRuleId()),"BERGBAHN"===b[K].categoryKey()&&(null!=b[K].fromKey&&(p=b[K].fromKey()),null!=b[K].toKey&&(q=b[K].toKey()),null!=b[K].viaKey&&(r=b[K].viaKey()),null!=b[K].classKey&&(s=b[K].classKey()),null!=b[K].tripTypeKey&&(t=b[K].tripTypeKey()),I={fromKey:p,toKey:q,viaKey:r,classKey:s,tripTypeKey:t}),null!=b[K].ticketholder&&null!=b[K].ticketholder()&&(null!=b[K].ticketholder().firstName&&(u=b[K].ticketholder().firstName()),null!=b[K].ticketholder().lastName&&(v=b[K].ticketholder().lastName()),null!=b[K].ticketholder().phone&&(w=b[K].ticketholder().phone()),null!=b[K].ticketholder().dateOfBirth&&(x=b[K].ticketholder().dateOfBirth()),null!=b[K].ticketholder().street&&(y=b[K].ticketholder().street()),null!=b[K].ticketholder().streetNumber&&(z=b[K].ticketholder().streetNumber()),null!=b[K].ticketholder().zipCode&&(A=b[K].ticketholder().zipCode()),null!=b[K].ticketholder().city&&(B=b[K].ticketholder().city()),null!=b[K].ticketholder().country&&(C=b[K].ticketholder().country()),null!=b[K].ticketholder().gender&&(D=b[K].ticketholder().gender()),null!=b[K].ticketholder().language&&(E=b[K].ticketholder().language()),null!=b[K].ticketholder().email&&(F=b[K].ticketholder().email()),null!=b[K].ticketholder().additionalData&&(G=b[K].ticketholder().additionalData())),J={firstName:u,lastName:v,phone:w,birthDateString:x,street:y,streetNumber:z,zipCode:A,city:B,country:C,gender:D,language:E,email:F,additionalData:G},H={type:e,ticketNr:d,bundleNr:null,firstName:f,lastName:g,phone:h,dateOfBirth:null,price:i,sku:j,reservationId:null,consumerKey:k,categoryKey:l,timeRangeId:null,timeRangeKey:null,reductionLevel:null,rebateRuleId:m,crossSeason:null,productKey:n,date:o,specificAttributes:I,ticketholder:J},b[K]=H;var L={amount:c,paymentType:a.paymentType(),customerPaymentType:a.customerPaymentType(),type:a.type(),replacesOrder:a.id(),comment:a.comment(),orderItems:b};return console.log(L),L},b.performCreateOrder=function(a,c){var d=serviceRootURL+"/orders";console.log("performCreateOrder",d,a,JSON.stringify(a)),$.ajax(d,{type:"POST",data:JSON.stringify(a),dataType:"json",contentType:"application/json",success:function(a,d,e){var f=a.id;console.log("order created (id="+f+")"),$.ajax(serviceRootURL+"/orders/"+f,{type:"GET",data:{consumptionCheck:!1,bundleMode:PARAMKEY_GETORDER_BUNDLEMODE_LEAVES},dataType:"json",contentType:"application/json",success:function(a,d,e){console.log("order found: ",a),b.updateOrder(a),a&&a.orderItems&&($.map(a.orderItems,function(a){var c=ko.utils.arrayFirst(b.updateOrderItems(),function(b){return b.ticketNr===a.ticketNr});c&&(c.id=a.id)}),c&&b.performProduce())},error:function(a,c,d){console.log("Server error on loading order: "+a.responseText),b.showSpinner(!1),showInfo(i18n.t("updateDetail.msg.updateCreateError")+a.responseText),b.handleCreateError(a,c,d)}})},error:function(a,c,d){console.log("Server error on creating order:\n"+a.responseText),b.showSpinner(!1),showInfo(i18n.t("updateDetail.msg.updateCreateError")+a.responseText),b.handleCreateError(a,c,d)}})},b.performProduce=function(){for(var a=0,c=0;c<b.updateOrderItems().length;c++){var d=b.updateOrderItems()[c];null!=d.id&&(a++,b.performProduceNoCoding(d))}},b.performProduceNoCoding=function(a){var c={orderItemId:a.id,coding:!1,mediaExtId:null,mediaOriginalId:null,media:a.media};console.log("performProduceNoCoding ticketNr",a.ticketNr,JSON.stringify(c),a),$.ajax(serviceRootURL+"/produceorderitem",{type:"GET",data:c,dataType:"json",async:!1,contentType:"application/json",success:function(c,d,e){console.log("produce order item (no coding) result retrieved: ",c);var f=ko.utils.arrayFirst(b.updateOrderItems(),function(b){return b.id===a.id});f&&(f.produced=!0),null==ko.utils.arrayFirst(b.updateOrderItems(),function(a){return null!=a.id&&!1===a.produced})&&b.completeOrder()},error:function(a,c,d){
console.log("error on produceorderitem (no coding)"),checkSession(a),b.performProduce()}})},b.completeOrder=function(c){var d={id:b.updateOrder().id,status:c?ORDER_STATUS_DISCARDED:ORDER_STATUS_COMPLETE,amount:b.updateOrder.amount};console.log("completing order based on price: "+b.updateOrder.amount,JSON.stringify(d)),$.ajax({url:serviceRootURL+"/orders/"+b.updateOrder().id,type:"PUT",data:JSON.stringify(d),dataType:"json",contentType:"application/json",success:function(c,d,e){console.log("order completed",c),b.showSpinner(!1),showInfo(i18n.t("updateDetail.msg.updateSuccessful"));for(var f=0;f<a.orderItems().length;f++){a.orderItems()[f].cancelOrderItem(!0)}b.performCancelOrder(!1)},error:function(a,c,d){console.log("Server error on completing order:\n"+a.responseText),b.handleError(a,c,d),b.showSpinner(!1)}})},b.performCancelOrder=function(a){b.showSpinner(!0);var c=b.order,d={id:c.id(),orderItems:[]};b.cancelOrder()?d.status=ORDER_STATUS_CANCELED:b.entries().forEach(function(a){jsonOrderItem={id:a.id(),status:ORDER_STATUS_CANCELED},d.orderItems.push(jsonOrderItem)});var e=serviceRootURL+"/orders/"+c.id();a&&(e+="?forceCompleteOrder=true"),console.log("Canceling order",d),$.ajax({url:e,type:"PUT",data:JSON.stringify(d),dataType:"json",contentType:"application/json",success:function(a,c,d){console.log("order canceled successfully"),b.showSpinner(!1),b.finishUpdate(!0,!0)},error:function(a,c,d){if(console.log("Server error on cancel order:\n"+a.responseText),showInfo(i18n.t("updateDetail.msg.updateCancelError")+a.responseText),checkSession(a)){var e=getErrorCode(a);if(e>0&&e<100){var f=$.parseJSON(a.responseText);b.showError(i18n.t("cancelDetail.msg.validationError")+f.message+" (code: "+f.code+")",!0)}else b.showError(i18n.t("cancelDetail.msg.error")+a.responseText);b.showSpinner(!1)}}})},b.finishUpdate=function(a,c){c&&showInfo(i18n.t("updateDetail.msg.cancellationSuccessful")),$("#updateDetail").modal("hide"),$("#updateDetail").on("hidden.bs.modal",function(){$(".cancel-detail").text(""),a&&(salesVM.performGetOrder(b.order,null),headerVM.loadPartner(!0))})},b.disableUpdate=function(){$("#updateDetail").find("button").attr("disabled","true")},b.showError=function(a,c){b.disableCancel(),b.errorMessage(a),$(".alert-success").slideUp(),$(".alert-error").slideDown(),c?($("#cancelCancel").show(),$("#cancelConfirm").hide(),$("#cancelResume").hide()):($("#cancelCancel").hide(),$("#cancelConfirm").hide(),$("#cancelResume").show()),$(".alert-error").find("button").removeAttr("disabled"),$(".alert-success").find("button").removeAttr("disabled"),$(".modal-footer").find("button").removeAttr("disabled")},b.abortUpdate=function(){b.finishUpdate(!1)}}function cancelViewModel(a){var b=this;b.order=a,b.categories=ko.observableArray([]),b.errorMessage=ko.observable(),b.cancelOrder=ko.observable(a.cancelOrder()),b.showSpinner=ko.observable(!1),b.entries=ko.computed(function(){for(var c=[],d=0;d<a.orderItems().length;d++){var e=a.orderItems()[d];if(e instanceof orderItemBundleModel&&0==e.cancelOrderItem())for(var f=0;f<e.bundleItems().length;f++){var g=e.bundleItems()[f];g.cancelOrderItem()&&c.push(g)}e.cancelOrderItem()&&c.push(e)}return c.length<b.order.orderItems().length&&b.cancelOrder(!1),c}),b.totalPrice=ko.computed(function(){var a=0;b.categories.removeAll();for(var c=0;c<b.entries().length;c++){var d=b.entries()[c];a+=d.price();for(var e=!1,f=0;f<b.categories().length;f++){var g=b.categories()[f];if(g.categoryKey()===d.categoryKey()){g.quantity(g.quantity()+1),e=!0;break}}if(!e){var h=new categoryCountModel(d.categoryKey());b.categories.push(h)}}return a},b),b.totalForeignPrice=ko.computed(function(){return b.totalPrice()*headerVM.selectedRateValue()},b),b.performCancelOrderWithCheck=function(){b.order.isOrderPending()?showQuestionYesNo(i18n.t("cancelDetail.msg.orderInProduction"),function(a){1==a&&b.performCancelOrder(!0)}):b.performCancelOrder(!1)},b.performCancelOrder=function(a){b.disableCancel(),b.showSpinner(!0);var c=b.order,d={id:c.id(),orderItems:[]};b.cancelOrder()?d.status=ORDER_STATUS_CANCELED:b.entries().forEach(function(a){jsonOrderItem={id:a.id(),status:ORDER_STATUS_CANCELED},d.orderItems.push(jsonOrderItem)});var e=serviceRootURL+"/orders/"+c.id();a&&(e+="?forceCompleteOrder=true"),console.log("Canceling order",d),$.ajax({url:e,type:"PUT",data:JSON.stringify(d),dataType:"json",contentType:"application/json",success:function(a,c,d){console.log("order canceled successfully"),b.showSpinner(!1),b.showSuccess()},error:function(a,c,d){if(console.log("Server error on cancel order:\n"+a.responseText),checkSession(a)){var e=getErrorCode(a);if(e>0&&e<100){var f=$.parseJSON(a.responseText);b.showError(i18n.t("cancelDetail.msg.validationError")+f.message+" (code: "+f.code+")",!0)}else b.showError(i18n.t("cancelDetail.msg.error")+a.responseText);b.showSpinner(!1)}}})},b.showSuccess=function(){$(".alert-error").slideUp(),$(".alert-success").slideDown(),$("#cancelCancel").hide(),$("#cancelConfirm").hide(),$("#cancelResume").hide(),$("#cancelFinish").show(),$(".alert-error").find("button").removeAttr("disabled"),$(".alert-success").find("button").removeAttr("disabled"),$(".modal-footer").find("button").removeAttr("disabled")},b.finishCancel=function(a){$("#cancelDetail").modal("hide"),$("#cancelDetail").on("hidden.bs.modal",function(){$(".cancel-detail").text(""),a&&(salesVM.performGetOrder(b.order,null),headerVM.loadPartner(!0))})},b.disableCancel=function(){$(".cart-detail").addClass("disabled"),$(".cart-detail").find("input").attr("disabled","true"),$("#cancelDetail").find("button").attr("disabled","true")},b.showError=function(a,c){b.disableCancel(),b.errorMessage(a),$(".alert-success").slideUp(),$(".alert-error").slideDown(),c?($("#cancelCancel").show(),$("#cancelConfirm").hide(),$("#cancelResume").hide()):($("#cancelCancel").hide(),$("#cancelConfirm").hide(),$("#cancelResume").show()),$(".alert-error").find("button").removeAttr("disabled"),$(".alert-success").find("button").removeAttr("disabled"),$(".modal-footer").find("button").removeAttr("disabled")},b.resume=function(){b.finishCancel(!0)},b.abortCancel=function(){b.finishCancel(!1)},b.abortUpdate=function(){console.log("abortUpdate"),b.finishUpdate(!1)}}function getGroupAmount(a,b){for(var c=0,d=0;d<30;d++)null!=document.getElementById("quantityText"+d)&&null!=document.getElementById("decrQuantity_"+d+"_"+b+"_"+a)&&(c+=parseInt(document.getElementById("quantityText"+d).value));return c}function decrQuantity(){console.log("decrQuantity");for(var a=event.currentTarget.id.split("_")[1],b=event.currentTarget.id.split("_")[2],c=event.currentTarget.id.split("_")[3],d=event.currentTarget.value,e=0,f=getGroupAmount(c,b),g=0;g<headerVM.rebateRules().length;g++){var h=headerVM.rebateRules()[g];if(h.id()===parseInt(b)){var i=h.rule().split(";");!1===isNaN(i[1])&&(e=parseInt(i[1]))}}null!=document.getElementById("quantityText"+a)&&!1===isNaN(document.getElementById("quantityText"+a).value)&&!1===isNaN(f)&&document.getElementById("quantityText"+a).value>0&&f>e&&(document.getElementById("quantityText"+a).value=Number(document.getElementById("quantityText"+a).value)-1,document.getElementById("totalPrice").innerHTML=(Number(document.getElementById("totalPrice").innerHTML)-Number(d)).toFixed(2))}function incrQuantity(){console.log("incrQuantity");var a=event.currentTarget.id.split("_")[1],b=event.currentTarget.value;null!=document.getElementById("quantityText"+a)&&!1===isNaN(document.getElementById("quantityText"+a).value)&&(document.getElementById("quantityText"+a).value=Number(document.getElementById("quantityText"+a).value)+1,document.getElementById("totalPrice").innerHTML=(Number(document.getElementById("totalPrice").innerHTML)+Number(b)).toFixed(2))}function showSales(){var a=$("#container");cleanContainer(),a.load("assets/sales.html",function(){salesVM=new salesViewModel,ko.applyBindings(salesVM,document.getElementById("salesInfo"))})}function driverInfoViewModel(){var a=this;ko.utils.extend(a,new reportViewModel),a.rangeType=ko.observable(TURNOVER_RANGE_TODAY),a.direction=ko.observable("up"),a.OrderItems=ko.observableArray([]),a.visibleOrderItems=ko.computed(function(){return ko.utils.arrayFilter(a.OrderItems(),function(b){return null!=b&&(b.direction()==BERGBAHN_EPR_VIA_PREFIX_UP&&"up"==a.direction()||b.direction()==BERGBAHN_EPR_VIA_PREFIX_DOWN&&"down"==a.direction())}).sort(function(b,c){return a.compareBusses(b,c)})}),a.compareBusses=function(a,b){if(moment(a.trainDate()).isSame(moment(b.trainDate()))){var c=a.lastname().localeCompare(b.lastname());return 0==c?a.firstname().localeCompare(b.firstname()):c}return moment(a.trainDate()).isAfter(moment(b.trainDate()))?1:-1},a.selectFromDate=function(b,c){var d=c.target.value;if(""!=d)try{var e=$.datepicker.parseDate(DATE_PICKER_FORMAT,d);a.fromDate($.datepicker.formatDate(DATE_SERVER_FORMAT,e))}catch(b){a.resetFromDate()}else a.fromDate("")},a.selectDirection=function(b,c){var d=c.target,e=$(d).find("input").val();a.direction(e)},a.searchOrderItems=function(){$(".dateRange").fadeOut(),a.disableFilter();try{$.ajax(serviceRootURL+"/order_items",{type:"GET",data:{rangeType:a.rangeType(),orderType:ORDER_TYPE_CASHDESK_ORDER,categoryKey:CATEGORY_KEY_BUS,fromDate:a.fromDate(),toDate:a.fromDate()},dataType:"json",contentType:"application/json",success:function(b,c,d){console.log("order items found: "+b);var e=$.map(b,function(a){return getOrderItemInstace(a)});a.OrderItems(e),a.enableFilter()},error:function(b,c,d){checkSession(b),a.enableFilter(),console.log("Server error on loading order items: "+b.responseText),showError("Fehler beim Laden der Bestellungen",b,c,d)}})}catch(b){a.enableFilter(),console.log("Exception on loading order items: "+b),showException(i18n.t("bus.msg.errorLoadingOrderItems"),b)}},a.selectRangeType=ko.computed(function(b,c){a.rangeType()!=TURNOVER_RANGE_CUSTOM?(a.fromDate(""),$("#startDate").val(""),$(".dateRange").fadeOut(),a.searchOrderItems()):a.rangeType()==TURNOVER_RANGE_CUSTOM&&""==$("#startDate").val()&&a.fromDate("")})}function initDriverInfo(){$("#customDateRange").on("click",function(){$(".dateRange").fadeIn()}),$(function(){$(".datepicker").datepicker()})}function showDriverInfo(){cleanContainer(),$("#container").load("assets/driverinfo.html",function(){initDriverInfo(),driverVM=new driverInfoViewModel,ko.applyBindings(driverVM,document.getElementById("driverInfo"))})}function toursViewModel(){var a=this;a.searchText=ko.observable(),a.today=ko.observable("option1"),a.searchState=ko.observable("all"),a.searchStatePrev=ko.observable(a.searchState()),a.Users=headerVM.Users,a.activeUsers=headerVM.activeUsers,a.selectedUser=ko.observable(),a.Tourguides=headerVM.Tourguides,a.selectedTourguide=ko.observable(),a.resendTourGuide=ko.observable(),a.forwardType=ko.observable(),headerVM.loadUsers(),headerVM.loadTourguides(),a.searchOrders=function(){$("#salesSearchForm").find("div").removeClass("has-error"),$("#salesInfoSearchText").prop("title","");var b=null!=a.searchState()?a.searchState():"all",c={fromDate:a.fromDate(),toDate:a.toDate(),dateRange:a.dateRange(),loadItems:!1,restrictStates:!0,loadForwardOrders:!0,loadCashdeskOrders:!1,userId:null!=a.selectedUser()?a.selectedUser().id():null,receiverId:null!=a.selectedTourguide()?a.selectedTourguide().id():null,forwardOrderDisplayState:b,loadPlannedForwardOrders:!0};a.performSearchOrders(c)},abstractSalesViewModel.apply(a,[]),a.selectSearchState=ko.computed(function(b,c){a.searchState()!=a.searchStatePrev()&&(a.searchStatePrev(a.searchState()),a.searchOrders())}),a.openOrder=function(b,c){var d=c.target;$(d).closest(".overview-body").find(".cancel-error").slideUp(),$(d).closest(".overview-body").find(".send-success").slideUp(),$(d).closest(".overview-body").find(".send-error").slideUp(),a.getOrder(b,c)},a.performGetOrder=function(b,c){console.log("retrieving details for order: ",b),$.ajax(serviceRootURL+"/orders/"+b.id(),{type:"GET",data:{consumptionCheck:!1,restrictStates:!0,groupItems:!0,bundleMode:null},context:{oldOrder:b,element:c},dataType:"json",contentType:"application/json",success:function(c,d,e){console.log("order found: "+c),b.setForwardDetails(c),b.setOrderDetails(c),null!=this.element&&a.toggleOrder(this.element),a.enableList()},error:function(b,c,d){console.log("Server error on loading order: "+b.responseText),checkSession(b),showError("Fehler beim Laden der Bestellung",b,c,d),a.enableList()}})},a.performCancelOrder=function(b,c){var d=c.target,e=$(d).closest(".tour-detail"),f=e.find(".cancel-error");a.disableList(),a.disableFilter();var g={id:b.id(),status:ORDER_STATUS_CANCELED,orderItems:[]},h=serviceRootURL+"/orders/"+b.id();h+="?forceCompleteOrder=true",$.ajax({url:h,type:"PUT",data:JSON.stringify(g),dataType:"json",contentType:"application/json",success:function(c,d,e){console.log("order canceled successfully"),f.slideUp(),a.enableFilter(),a.performGetOrder(b,null),headerVM.loadPartner(!0)},error:function(b,c,d){if(console.log("Server error on cancel order:\n"+b.responseText),checkSession(b)){var f=getErrorCode(b);if(f>0&&f<100){$.parseJSON(b.responseText);a.showCancelError(i18n.t("tours.msg.cancelOrderValidationError")+"\n"+a.getError(b,c,d),e)}else a.showCancelError(i18n.t("tours.msg.cancelOrderError")+b.responseText,e);a.enableFilter(),a.enableList(),headerVM.loadPartner(!0)}}})},a.showCancelError=function(a,b){var c=b.find(".cancel-error");c.find(".error-message").html(a),c.slideDown(),b.find(".order-operation-result").slideUp()},a.showOrderItemCancelInfo=function(a){var b=a().cancelability();return i18n.t("sales.orderDetails.cancelState."+b)},a.getError=function(a,b,c){var d="";if(-1!=getErrorCode(a)){var e=$.parseJSON(a.responseText);d=e.message+" (code: "+e.code+")"}else d=a.responseText;return d},a.resendForwardOrder=function(b,c){var d=c.target;if(b.forwardOrderDisplayState()==FORWARD_ORDER_DISPLAY_STATE_BOOKED)return void $(d).closest(".tour-detail").find(".send-box").slideDown();a.sendForwardOrder(b,c,!0)},a.sendForwardOrder=function(b,c,d){var e=c.target,f=$(e).closest(".tour-detail"),g=null!=b.receiver();if(!g&&null==a.resendTourGuide())return void showInfo(i18n.t("checkout.validation.notourguideselected"));a.disableFilter(),a.disableList();var h={id:b.id(),receiverId:null!=b.receiverId()?b.receiverId():a.resendTourGuide().id(),receiverType:FORWARD_ORDER_RECEIVER_TYPE_TOURGUIDE,forwardAddress:d?b.forwardAddress():g?b.receiver().email():a.resendTourGuide().email(),forwardType:d?b.forwardType():a.forwardType()};$.ajax({url:serviceRootURL+"/orders/"+b.id(),type:"PUT",data:JSON.stringify(h),dataType:"json",contentType:"application/json",success:function(c,d,g){console.log("order forwarded"+c),a.showSendForwardSuccess(i18n.t("tours.msg.successSendForwardOrder"),f),a.enableFilter(),$(e).closest(".tour-detail").find(".send-box").slideUp(),a.performGetOrder(b,null)},error:function(c,d,e){console.log("Server error on completing order:\n"+c.responseText),checkSession(c),a.showSendForwardError(i18n.t("tours.msg.errorSendForwardOrder")+"\n"+a.getError(c,d,e),f),a.enableFilter(),a.performGetOrder(b,null)}})},a.showSendForwardSuccess=function(a,b){var c=b.find(".send-success");b.find(".order-operation-result").not(".send-success").slideUp(),c.find(".success-message").html(a),c.slideDown()},a.showSendForwardError=function(a,b){var c=b.find(".send-error");b.find(".order-operation-result").not(".send-error").slideUp(),c.find(".error-message").html(a),c.slideDown()},a.takeoverToCart=function(b,c){var d=c.target,e=$(d).closest(".tour-detail"),f=e.find(".takeover-error");f.slideUp(),f.find(".error-message").html(""),getShoppingcartVM().quantity()>0?showQuestionOkCancel(i18n.t("tours.msg.cartNotEmpty"),function(c){c&&(getShoppingcartVM().reset(),a.performOrderToCart(b,e))}):a.performOrderToCart(b,e)},a.performOrderToCart=function(b,c){var d=[];try{for(var e=[],f=-1,g=[],h=0;h<b.orderItems().length;h++)b.orderItems()[h].type()==ORDER_ITEM_TYPE_BUNDLE&&(f>=0&&b.orderItems()[f].bundleItems(g),f=h,g=[]),b.orderItems()[h].type()==ORDER_ITEM_TYPE_BUDLE_ITEM&&g.push(b.orderItems()[h]);f>=0&&b.orderItems()[f].bundleItems(g);for(var h=0;h<b.orderItems().length;h++)(b.orderItems()[h].type()==ORDER_ITEM_TYPE_BUNDLE||b.orderItems()[h].type()==ORDER_ITEM_TYPE_SIMPLE_ITEM&&b.orderItems()[h].categoryKey()==CATEGORY_KEY_BERGBAHN)&&e.push(b.orderItems()[h]);for(var h=0;h<e.length;h++){var i=e[h];d.push(a.addToCart(i.categoryKey(),i,i.totalForwarded(),i.rebateRuleId()).error(function(b,d,e){checkSession(b),a.showTakeoverError(i18n.t("tours.msg.takeoverPriceError")+"\n"+a.getError(b,d,e),c)}))}$.when.apply(null,d).done(function(){for(var a=getShoppingcartVM().entries(),c=0;c<a.length;c++){var d=a[c];if(d.price().rebateRuleId()&&0==d.price().price()){for(var e=null,f=0;f<a.length;f++){var g=a[f];d.price().rebateRuleId()==g.price().rebateRuleId()&&d.price().date()==g.price().date()&&g.price().price()>0&&g.price().productKey()==d.price().productKey()&&(null==e?e=g:e.price().price()<g.price().price()&&(e=g))}null!=e&&(d.rebateRuleItemReference.push({key:e.internalId(),amount:d.quantity()}),d.price().isComputed(!0))}}getShoppingcartVM().preSelectedTourguide(b.receiverId()),getShoppingcartVM().requestOrderId(b.id()),getShoppingcartVM().comment(b.tourguideCode()),location.hash="shop"})}catch(b){console.error("takeover failed: "+b),a.showTakeoverError(i18n.t("tours.msg.takeoverPriceError")+"\n"+b,c)}},a.getPriceInstance=function(a,b){if(a.toUpperCase()==CATEGORY_KEY_BERGBAHN)return new bergbahnPriceModel(b);if(a.toUpperCase()==CATEGORY_KEY_BERGBAHN_EPR)return new bergbahnEprPriceModel(b);if(a.toUpperCase()==CATEGORY_KEY_BUNDLE)return new bundlePriceModel(b);if(a.toUpperCase()==CATEGORY_KEY_ADDON)return new eprAddonPriceModel(b);var c="category not supported: "+a;throw alert(c),c},a.addToCart=function(b,c,d,e){if(c.categoryKey()==CATEGORY_KEY_BERGBAHN)return $.ajax(serviceRootURL+"/bergbahnprice",{type:"GET",data:{categoryKey:b,consumerKey:c.consumerKey(),fromKey:c.fromKey(),toKey:c.toKey(),viaKey:c.viaKey(),classKey:c.classKey(),tripTypeKey:c.tripTypeKey(),dateString:c.date(),context:{quantity:d,rebateRuleId:e,categoryKey:b},partnerId:""},dataType:"json",contentType:"application/json",success:function(c,f,g){if(console.log("price for order item: "+c),null==c.price)throw showError(i18n.t("tours.msg.takeoverPriceError")),new Error(i18n.t("tours.msg.takeoverPriceError"));var h=a.getPriceInstance(b,c);getShoppingcartVM().addEntryQuantity(h,null,b,null,d,!0,!1).price().rebateRuleId(e)}});for(var f={productKey:c.productKey(),dateString:c.date(),consumerKey:c.consumerKey(),selectableItems:[]},g=0;g<c.bundleItems().length;g++)if(c.bundleItems()[g].categoryKey()==CATEGORY_KEY_BERGBAHN){var h=c.bundleItems()[g],i={categoryKey:h.categoryKey(),fromKey:h.fromKey(),toKey:h.toKey(),viaKey:h.viaKey(),classKey:h.classKey(),tripTypeKey:h.tripTypeKey(),consumerKey:h.consumerKey(),dateString:h.date(),isAddOn:!0,provideOptionNames:!0};f.selectableItems.push(i)}return $.ajax(serviceRootURL+"/daytripsprice",{type:"POST",data:JSON.stringify(f),dataType:"json",contentType:"application/json",error:function(a,b,c){throw checkSession(a),showError("Error when retrieving bundle price for touroperator tours",!0),new Error("Error when retrieving bundle price for touroperator tours",a,b,c)},success:function(e,f,g){if(console.log("price for order item: "+e),null==e.price)throw showError(i18n.t("tours.msg.takeoverPriceError")),new Error(i18n.t("tours.msg.takeoverPriceError"));var h=a.getPriceInstance(b,e);e.bundleItems.forEach(function(b){var d=a.getPriceInstance(b.categoryKey,b);if(d instanceof eprAddonPriceModel){d.selectable(!0);for(var e=!1,f=null,g=null,i=0;i<c.bundleItems().length;i++)c.bundleItems()[i].sku()==d.sku()&&(e=!0,f=c.bundleItems()[i].timeslot(),g=c.bundleItems()[i].eprInfo);1==e&&(d.eprSelected(!0),d.timeslot(f),d.eprInfo(g))}var j=new bundlePriceItemModel(b.categoryKey,d);h.bundleItems().push(j)}),console.log("addToCartWithEpr",e,null),getShoppingcartVM().addEntryQuantity(h,null,b,null,d,!0,!1)}})},a.showTakeoverError=function(a,b){var c=b.find(".takeover-error");b.find(".order-operation-result").not(".takeover-error").slideUp();var d=c.find(".error-message");d.html((""!=d.html()?d.html()+"<br/> ":"")+a),c.slideDown()},a.disableList=function(){$(".overview-body").find("button").attr("disabled","true"),$(".overview-body").find("select").attr("disabled","true")},a.enableList=function(){$(".overview-body").find("button").removeAttr("disabled"),$(".overview-body").find("select").removeAttr("disabled")}}function showTours(){cleanContainer(),$("#container").load("assets/tours.html",function(){toursVM=new toursViewModel,ko.applyBindings(toursVM,document.getElementById("toursInfo"))})}function turnoverViewModel(){var a=this;ko.utils.extend(a,new reportViewModel),a.Orders=ko.observableArray([]),a.CancelledOrderItems=ko.observableArray([]),a.CancellationOrders=ko.observableArray([]),a.cancelledTotal=ko.observable(0),a.income=ko.observable(0),a.incomeSum=ko.observable(0),a.total=ko.observable(0),a.storeCredits=ko.observable(0),a.cashPayments=ko.observable(0),a.creditCardPayments=ko.observable(0),a.invoicePayments=ko.observable(0),a.provision=ko.observable(0),a.net=ko.observable(0),a.rangeType=ko.observable(TURNOVER_RANGE_TODAY),a.Users=headerVM.Users,a.activeUsers=headerVM.activeUsers,a.selectedUser=ko.observable(),a.Cashdesks=headerVM.Cashdesks,a.activeCashdesks=headerVM.activeCashdesks,a.selectedCashdesk=ko.observable(),a.selectedCategory=ko.observable(),a.showMageOrderIncrId=ko.observable(menuVM.showMageOrderIncrId()),headerVM.loadUsers(),headerVM.loadCashdesks(),a.getCurrency=ko.computed(function(){return currency()}),a.searchOrders=function(){$(".dateRange").fadeOut(),a.disableFilter(),a.loading(!0);try{$.ajax(serviceRootURL+"/turnover",{type:"GET",data:{rangeType:a.rangeType(),fromDate:a.fromDate(),toDate:a.toDate(),userId:null!=a.selectedUser()?a.selectedUser().id():null,cashdeskId:null!=a.selectedCashdesk()?a.selectedCashdesk().id():null,productCategory:a.selectedCategory()},dataType:"json",contentType:"application/json",success:function(b,c,d){console.log("turnover orders found: ",b);var e=$.map(b.orders,function(a){return new orderModel(a)});a.Orders(e),console.log("turnover orders found and mapped: ",b,a.Orders());var f=$.map(b.cancellationOrders,function(a){return new orderModel(a)});a.CancellationOrders(f),$.getScript("assets/js/jungfrau.min.js"),a.income(b.income),a.incomeSum(b.incomeSum),a.total(b.total),a.storeCredits(b.storeCredits),a.cashPayments(b.cashPayments),a.creditCardPayments(b.creditCardPayments),a.invoicePayments(b.invoicePayments),a.provision(b.provision),a.net(b.net);var g=b.cancellationDetails;if(g&&g.cancelledOrderItems){a.cancelledTotal(g.cancelledTotal);var h=$.map(g.cancelledOrderItems,function(a){return getOrderItemInstace(a)});a.CancelledOrderItems(h)}a.enableFilter(),a.loading(!1)},error:function(b,c,d){checkSession(b),a.enableFilter(),console.log("Server error on loading turnover orders: "+b.responseText),showError("Fehler beim Laden der Umsätze",b,c,d),a.loading(!1)}})}catch(b){a.enableFilter(),console.log("Exception on loading turnover orders: "+b),showException("Fehler beim Laden der Umsätze",b),a.loading(!1)}},a.selectRangeType=ko.computed(function(b,c){a.rangeType()!=TURNOVER_RANGE_CUSTOM?(a.fromDate(""),a.toDate(""),$("#startDate").val(""),$("#endDate").val(""),$(".dateRange").fadeOut(),a.searchOrders()):a.rangeType()==TURNOVER_RANGE_CUSTOM&&(""==$("#startDate").val()&&a.fromDate(""),""==$("#endDate").val()&&a.toDate(""))}),a.toggleCancelRow=function(a,b){var c=b.target;$(c).parents(".overview-body").find(".row").slideToggle(),$(c).parents(".overview-body").find(".glyphicon").toggleClass("expand deflate")},a.printPDF=function(){a.printOrders(PRINT_TYPE_PDF)},a.printCSV=function(){a.printOrders(PRINT_TYPE_CSV)},a.toggleTurnover=function(a,b){var c=b.target;$(c).parents(".overview-body").find(".row").slideToggle(),$(c).parents(".overview-body").find(".glyphicon").toggleClass("expand deflate")},a.printOrders=function(b){var c=a.rangeType(),d=a.fromDate(),e=a.toDate(),f=null!=a.selectedUser()?a.selectedUser().id():null,g=null!=a.selectedCashdesk()?a.selectedCashdesk().id():null,h="/print_sales?rangeType="+c;null!=d&&(h+="&fromDate="+d),null!=e&&(h+="&toDate="+e),null!=f&&(h+="&userId="+f),null!=g&&(h+="&cashdeskId="+g),a.selectedCategory()&&(h+="&productCategory="+a.selectedCategory()),h+="&printType="+b,b==PRINT_TYPE_PDF?window.open(h,"_blank","toolbar=no, location=no, status=no, scrollbars=yes, resizable=yes"):PRINT_TYPE_CSV&&(window.location=h)}}function showTurnover(){cleanContainer(),$("#container").load("assets/turnover.html",function(){turnoverVM=new turnoverViewModel,ko.applyBindings(turnoverVM,document.getElementById("turnoverInfo"))})}function ticketsViewModel(){var a=this;ko.utils.extend(a,new reportViewModel),a.Order=ko.observable(),a.orderNumber=ko.observable(),a.allItems=ko.observable(!0),a.orderType=ko.observable(),a.optionsPickupOrderType=headerVM.optionsPickupOrderType,a.viewType=ko.observable("available"),a.OrderItems=ko.observableArray([]),a.OrderItemsProduced=ko.observableArray([]),headerVM.loadUsers(),a.Users=headerVM.Users,a.activeUsers=headerVM.activeUsers,a.selectedUser=ko.observable(),a.rangeType=ko.observable("today"),a.searchText=ko.observable(),a.getCategoryInfo=ko.computed(function(){"reservation"==a.orderType()&&("available"==a.viewType()?a.searchReservationPickupOrders():(a.rangeType(),a.searchReservationPickupOrdersProduced()))},a),a.selectViewType=function(b,c){var d=c.target,e=$(d).find("input").val();a.viewType(e)},a.searchReservationPickupOrders=function(){a.OrderItems(null),a.disableFilter(),$.ajax(serviceRootURL+"/order_items",{type:"GET",data:{orderType:ORDER_TYPE_RESERVATION_ORDER,groupByProduct:!0},dataType:"json",contentType:"application/json",success:function(b,c,d){console.log("order items found: "+b);var e=$.map(b,function(a){return getOrderItemInstace(a)});a.OrderItems(e),a.enableFilter()},error:function(b,c,d){checkSession(b),a.enableFilter(),console.log("Server error on loading order items: "+b.responseText),showError("Fehler beim Laden der Bestellungen",b,c,d)}})},a.searchReservationPickupOrdersProduced=function(){a.OrderItemsProduced(null),a.disableFilter(),$.ajax(serviceRootURL+"/order_items",{type:"GET",data:{rangeType:a.rangeType(),fromDate:a.fromDate(),toDate:a.toDate(),orderType:ORDER_TYPE_RESERVATION_ORDER,statusFilter:"produced",searchText:a.searchText(),userId:null!=a.selectedUser()?a.selectedUser().id():null},dataType:"json",contentType:"application/json",success:function(b,c,d){console.log("order items found: "+b);var e=$.map(b,function(a){return getOrderItemInstace(a)});a.OrderItemsProduced(e),a.enableFilter()},error:function(b,c,d){checkSession(b),a.enableFilter(),console.log("Server error on loading order items: "+b.responseText),showError("Fehler beim Laden der Bestellungen",b,c,d)}})},a.searchOrder=function(){if(null==a.orderNumber())return void showInfo("Bitte Buchungscode eingeben!");a.disableFilter();try{$.ajax(serviceRootURL+"/pickuporders/"+a.orderNumber(),{type:"GET",data:{orderNumber:a.orderNumber()},dataType:"json",contentType:"application/json",success:function(b,c,d){console.log("order found: "+b),a.Order(new pickupOrderModel(b)),a.enableFilter()},error:function(b,c,d){a.enableFilter(),console.log("Server error on loading order: "+b.responseText),showError(i18n.t("tickets.msg.errorLoading"),b,c,d)}})}catch(b){a.enableFilter(),console.log("Exception on loading orders: "+b),showException(i18n.t("tickets.msg.errorLoading"),b)}},a.showCheckout=function(){for(var b=0;b<a.Order().orderItems().length;b++)if(!a.Order().orderItems()[b].selectOrderItem())return void showInfo("Keine Tickets selektiert!");$(".tickets-checkout").load("assets/tickets-checkout.html",function(){$.getScript("assets/js/jungfrau.min.js"),ticketsCheckoutVM=new ticketsCheckoutViewModel(a.Order()),ko.applyBindings(ticketsCheckoutVM,document.getElementById("ticketsCheckout")),$("#ticketsCheckout").modal("show")})},a.showReservationCheckout=function(){for(var b="",c=0,d=0;d<a.OrderItems().length;d++){var e=a.OrderItems()[d];e.quantityProduce()>0&&(b+=e.productExtKey()+","+e.quantityProduce()+","+e.seasonKey()+";",c+=parseInt(e.quantityProduce()))}return""==b||0==b.length?void showError("Es wurden keine Tickets ausgewählt!"):(b=b.substr(0,b.length-1),c>MAX_ORDERITEMS_FOR_PRODUCTION?void showError(i18n.t("tickets.msg.maxProductionValidationError",{max:MAX_ORDERITEMS_FOR_PRODUCTION})):void $(".tickets-checkout").load("assets/tickets-reservation-checkout.html",function(){$.getScript("assets/js/jungfrau.min.js"),ticketsReservationCheckoutVM=new ticketsReservationCheckoutViewModel(b),ko.applyBindings(ticketsReservationCheckoutVM,document.getElementById("ticketsCheckout")),$("#ticketsCheckout").modal("show")}))},a.reset=function(){a.Order(null),a.orderNumber(null),a.OrderItems(null)},a.startPdfReservationVoucher=function(a){console.log("print voucher for order items: "+a.id()),window.open("/print_reservation_pickup_voucher?items="+a.id(),"_blank","toolbar=no, location=no, status=no, scrollbars=yes, resizable=yes"),window.location="/print_reservation_pickup_voucher?download=true&items="+a.id()},a.activeUserChanged=function(){var b=null!=a.selectedUser()?a.selectedUser().id():"null";console.log("activeUserChanged: "+b)}}function ticketsReservationCheckoutViewModel(a){var b=this;abstractPersonalizationViewModel.apply(b,[]),checkoutViewModel.apply(b,[]),b.reservationTotal=ko.observable(),b.reservationTotalForeignPrice=ko.observable();var c=new Date,d=c.toISOString();console.log("ticketsReservationCheckoutViewModel().date: "+d),b.exportDate=ko.observable(d),b.validatePrintingState=function(a){return a.printingState()!=PRINTING_STATE_NRPROCESSING&&a.printingState()!=PRINTING_STATE_NRINVALID||null==a.ticketHolder()||null==a.ticketHolder().upgradedItem()||(document.getElementById("checkoutProduce").focus(),!1)},b.searchOrderItems=function(){console.log("load order items ..."),$("#checkoutProduce").attr("disabled","true"),$("#checkoutCancel").attr("disabled","true"),$.ajax(serviceRootURL+"/order_items",{type:"GET",data:{orderType:ORDER_TYPE_RESERVATION_ORDER,groupByProduct:!1,productQuantityFilter:a},dataType:"json",contentType:"application/json",success:function(a,c,d){console.log("order items found: "+a);var e=1,f=$.map(a,function(a){e++;var b=getOrderItemInstace(a);return new ReservationCheckoutItemModel(b,e,categoriesVM.getCategory(b.categoryKey()).categoryModel().config())});b.entries(f),b.computeTotal(),b.handleLoadingComplete()},error:function(a,b,c){checkSession(a),console.log("Server error on loading order items: "+a.responseText),showError("Fehler beim Laden der Bestellungen",a,b,c)}})},b.searchOrderItems(),b.onChange=function(a,b){console.log("onChange");b.which?b.which:b.keyCode;a.printingState(PRINTING_STATE_NRPROCESSING),a.showPersonalization(!1)},b.checkKeypress=function(a,c){13===(c.which?c.which:c.keyCode)&&b.validateTicketToUpgrade(a)},b.validateTicketToUpgrade=function(a){console.log("validateTicketToUpgrade"),a.showPersonalization(!1);a.orderItem();if(a.printingState(PRINTING_STATE_NRPROCESSING),null!=a.ticketHolder().upgradedItem())try{$.ajax(serviceRootURL+"/pickuporderitem",{type:"GET",data:{pickupCode:a.ticketHolder().upgradedItem(),loadTouristCardPermissions:menuVM.hasAboAdditionalValues(),isUpgradeAction:!0},dataType:"json",contentType:"application/json",success:function(b,c,d){console.log("success");var e=new orderItemModel(b[0]);if(e.ticketholder().upgradedItem(a.ticketHolder().upgradedItem()),a.ticketHolder(e.ticketholder()),a.ticketHolder().encodedPhoto()){var f=a.ticketHolder().encodedPhoto(),g="data:image/jpeg;base64,"+f;a.ticketHolder().encodedPhoto(g)}a.showPersonalization()||a.showPersonalization(!0),a.printingState(PRINTING_STATE_OPEN)},error:function(b,c,d){checkSession(b),a.printingState(PRINTING_STATE_NRINVALID),a.showPersonalization(!1),
console.log("Server error on loading order: "+b.responseText),showError(i18n.t("tickets.msg.errorLoading"),b,c,d)}})}catch(b){a.printingState(PRINTING_STATE_NRINVALID),a.showPersonalization(!1),console.log("Exception on loading orders: "+b),showException(i18n.t("tickets.msg.errorLoading"),b)}else a.printingState(PRINTING_STATE_NRPROCESSING),a.showPersonalization(!1),console.log("No Upgrade Item provided")},b.handleLoadingComplete=function(){$(".alert-error").slideUp(),$("#checkoutProduce").show(),$("#checkoutCancel").show(),$("#ticketsCheckout").find("input").not(".media-id").removeAttr("disabled"),$(".alert-error").find("button").removeAttr("disabled"),$(".alert-success").find("button").removeAttr("disabled"),$(".modal-footer").find("button").removeAttr("disabled")},b.createOrder=function(){if(!b.validateBirthdates())return void b.enableCheckout();b.performProduce()},b.computeTotal=function(){for(var a=0,c=0;c<b.entries().length;c++){a+=b.entries()[c].orderItem().price()}b.reservationTotal(a),b.reservationTotalForeignPrice(b.reservationTotal()*headerVM.selectedRateValue())},b.ticketRetry=function(){console.log("retrying checkout ..."),$(".ticketholder-email-retry").removeClass("ticketholder-email-retry"),b.retry()},b.completePickupOrderItem=function(a,c){console.log("ticketsReservationCheckoutViewModel.completePickupOrderItem().date: "+b.exportDate());var d={codingResult:!0,printingResult:!0,exportDate:b.exportDate(),ticketholder:{gender:a.ticketHolder().gender(),firstName:a.ticketHolder().firstName(),lastName:a.ticketHolder().lastName(),street:a.ticketHolder().street(),streetNumber:a.ticketHolder().streetNumber(),zipCode:a.ticketHolder().zipCode(),city:a.ticketHolder().city(),country:a.ticketHolder().country(),birthDateString:a.ticketHolder().birthDate(),phone:a.ticketHolder().phone(),email:a.ticketHolder().email(),upgradedItem:a.ticketHolder().upgradedItem(),encodedPhoto:a.ticketHolder().encodedPhoto()}};$.ajax({url:serviceRootURL+"/produceorderitem/"+a.id(),type:"PUT",data:JSON.stringify(d),dataType:"json",contentType:"application/json",success:function(c,d,e){console.log("completePickupOrderItem successful "+c),"voucher"==a.media()&&(a.mediaCardId(c.mediaId),b.showVoucher(!0)),b.performProduce()},error:function(c,d,e){console.log("error on sending coding ack"),checkSession(c);var f=null!=a.mediaCardId()?a.mediaCardId():a.id();a.error("Unerwarteter Fehler beim Produzieren des Tickets mit ID: "+f+" "+b.getError(c,d,e)),a.printingState(PRINTING_STATE_ERROR);var g=getErrorCode(c);console.log("ERROR Code: "+g),g!=ERR_CODE_DUPLICATE_EMAIL&&g!=ERR_CODE_INVALID_EMAIL_FORMAT||($("#ticketholder_"+a.id()).find(".ticketholder-email").addClass("ticketholder-email-retry"),$("#ticketholder_"+a.id()).find(".ticketholder-email").removeAttr("disabled"),showError("Duplicate email",c,d,e,!1)),b.performProduce()}})},b.disableCheckout=function(){$(".cart-detail").addClass("disabled"),$(".cart-detail").find("input,select").not(".ticketholder-email-retry").attr("disabled","true"),$(".checkout-dialog").find("button").attr("disabled","true"),$(".modal-header").find("button").hide()},b.completeOrder=function(a){if(console.log("completing reservation pickup order"),b.showVoucher()){for(var c="",d=0;d<b.entries().length;d++){var e=b.entries()[d];e.printingState()==PRINTING_STATE_DONE&&"voucher"==e.media()&&(c+=e.id()+",")}c.length>0&&(c=c.substr(0,c.length-1)),$.ajax(serviceRootURL+"/order_items",{type:"GET",data:{rangeType:"all",fromDate:"",toDate:"",orderType:ORDER_TYPE_RESERVATION_ORDER,statusFilter:"produced",searchText:"",userId:null,orderItemFilter:c},dataType:"json",contentType:"application/json",success:function(d,e,f){console.log("order items found: "+d);var g=$.map(d,function(a){return console.log(a),getOrderItemInstace(a)});g&&($.map(g,function(a){var c=ko.utils.arrayFirst(b.entries(),function(b){return b.origOrderItemId()===a.id()});c&&c.mediaCardId(a.mediaId())}),$(".media-id").first().prop("disabled",!1).select().prop("disabled",!0),a?b.showSuccess(i18n.t("tickets.msg.discarded")):b.showSuccess(i18n.t("tickets.msg.checkoutComplete")),console.log("print voucher for order items: "+c),window.open("/print_reservation_pickup_voucher?items="+c,"_blank","toolbar=no, location=no, status=no, scrollbars=yes, resizable=yes"),window.location="/print_reservation_pickup_voucher?download=true&items="+c)},error:function(a,b,c){console.log("Server error on fetching media ids: "+a.responseText)}})}else a?b.showSuccess(i18n.t("tickets.msg.discarded")):b.showSuccess(i18n.t("tickets.msg.checkoutComplete"))},b.discardPossible=function(){return null==ko.utils.arrayFirst(b.entries(),function(a){return a.printingState()===PRINTING_STATE_DONE})},b.discard=function(){b.disableCheckout();var a=ko.utils.arrayFirst(b.entries(),function(a){return a.printingState()===PRINTING_STATE_DONE}),c=null==a;b.completeOrder(c)},b.finishCheckout=function(){$(".media-id").first().prop("disabled",!1).select().prop("disabled",!0),document.execCommand("copy"),$("#ticketsCheckout").modal("hide"),$("#ticketsCheckout").on("hidden.bs.modal",function(){ticketsVM.reset(),ticketsVM.searchReservationPickupOrders()})},b.enableCheckout=function(){$(".cart-detail").removeClass("disabled"),$(".cart-detail").find("input,select").removeAttr("disabled"),$(".checkout-dialog").find("button").removeAttr("disabled"),$(".modal-header").find("button").show()},b.validateBirthdates=function(){for(i=0;i<b.entries().length;i++){var a=b.entries()[i],c=categoriesVM.getCategory(a.categoryKey()).categoryModel().config().reductionDuedate;if(null==c)return!0;var d=$.datepicker.parseDate(DATE_SERVER_FORMAT,c);if(a.orderItem().consumerKey()==CONSUMER_CHILD){if(null==a.ticketHolder().birthDate())return!1;var e=d;"S1"==a.orderItem().durationKey()?e=moment(e).subtract(16,"year").add(1,"day"):"S3"==a.orderItem().durationKey()&&(e=moment(e).subtract(14,"year").add(1,"day"));if(moment(a.ticketHolder().birthDate()).isBefore(e))return showError(i18n.t("ticketsDetail.messages.dueDateValidationError",{age:"S3"==a.orderItem().durationKey()?13:15,reductionDuedate:moment(d).format("L")})),!1}}return!0}}function ticketsCheckoutViewModel(a){var b=this;b.Order=ko.observable(a),checkoutViewModel.apply(b,[a]);var c=1;ticketsVM.allItems(!0);for(var d=0;d<a.orderItems().length;d++)if(a.orderItems()[d].selectOrderItem()){var e=a.orderItems()[d],f=new PickupCheckoutItemModel(e,c,categoriesVM.getCategory(e.categoryKey()).categoryModel().config());b.entries().push(f),c++}else ticketsVM.allItems(!1);b.getCategoryInfo=ko.computed(function(){b.categories.removeAll();for(var a=0;a<b.entries().length;a++){for(var c=b.entries()[a],d=!1,e=0;e<b.categories().length;e++){var f=b.categories()[e];if(f.categoryKey()==c.categoryKey()){f.quantity(f.quantity()+1),d=!0;break}}if(!d){var g=new categoryCountModel(c.categoryKey());b.categories.push(g)}}},b),b.initOrder=function(){console.log("init pickup order ..."),$("#checkoutProduce").attr("disabled","true"),$("#checkoutCancel").attr("disabled","true");for(var a={origOrderId:b.Order().origOrderId(),type:ORDER_TYPE_PICKUP_ORDER,orderItems:[]},c=0;c<b.entries().length;c++){var d=b.entries()[c],e={ticketNr:d.ticketNr(),origOrderItemId:d.origOrderItemId(),categoryKey:d.categoryKey()};a.orderItems.push(e)}b.performCreateOrder(a,!1)},b.pickupSupported=function(){return!1},b.createOrder=function(){b.performProduce()},b.handleCreateError=function(a,c,d){checkSession(a),b.errorMessage(i18n.t("tickets.msg.errorCreate")+"\n"+b.getError(a,c,d)),$(".alert-success").slideUp(),$(".alert-error").slideDown(),$("#checkoutCancel").show(),$("#checkoutCancel").removeAttr("disabled"),$("#checkoutProduce").hide()},b.handleCreateDone=function(){$(".alert-error").slideUp(),$("#checkoutProduce").show(),$("#checkoutDiscard").show(),$("#checkoutCancel").hide(),$("#ticketsCheckout").find("input").removeAttr("disabled"),$(".alert-error").find("button").removeAttr("disabled"),$(".alert-success").find("button").removeAttr("disabled"),$(".modal-footer").find("button").removeAttr("disabled")},b.completeOrder=function(a){console.log("completing pickup order");var c={id:b.orderId(),status:a?ORDER_STATUS_DISCARDED:ORDER_STATUS_COMPLETE,type:ORDER_TYPE_PICKUP_ORDER};$.ajax({url:serviceRootURL+"/orders/"+b.orderId(),type:"PUT",data:JSON.stringify(c),dataType:"json",contentType:"application/json",success:function(c,d,e){console.log("order completed",c),a?b.showSuccess(i18n.t("tickets.msg.discarded")):b.showSuccess(i18n.t("tickets.msg.checkoutComplete"))},error:function(a,c,d){console.log("Server error on completing pickup order:\n"+a.responseText),b.handleError(a,c,d)}})},b.initOrder(),b.finishCheckout=function(){$("#ticketsCheckout").modal("hide"),$("#ticketsCheckout").on("hidden.bs.modal",function(){ticketsVM.allItems()?ticketsVM.reset():ticketsVM.searchOrder()})},b.ticketRetry=function(){console.log("retrying checkout ..."),null!=b.orderId()?b.retry():b.initOrder()}}function showTickets(){cleanContainer(),$("#container").load("assets/tickets.html",function(){getTouroperatorVM(),initCategories(),getShoppingcartVM(),ticketsVM=new ticketsViewModel,ko.applyBindings(ticketsVM,document.getElementById("ticketsInfo")),headerVM.pickupTeaser()&&showInfo(headerVM.pickupTeaserMessage())})}function storeCreditsViewModel(){var a=this;ko.utils.extend(a,new reportViewModel),a.rangeType=ko.observable(TURNOVER_RANGE_MONTH),a.storeCreditAmount=headerVM.storeCreditAmount,a.purchaseAmountField=ko.observable(),a.purchaseAmount=ko.observable(),a.successMessage=ko.observable(),a.errorMessage=ko.observable(),a.paymentMethod=ko.observable(),a.purchaseOngoing=ko.observable(!1),a.qrCode=ko.observable(),a.purchased=ko.observable(!1),a.cardNo=ko.observable(),a.cardName=ko.observable(),a.cvv=ko.observable(),a.expiryMonth=ko.observable(),a.expiryYear=ko.observable(),a.optionsExpiryYear=ko.observableArray(),a.paymentHint=ko.observable(),a.hasPaymentMethod=function(a){return-1!=(headerVM.datatransPaymentMethods()+",").indexOf(a)},a.paymentMethodIsCC=ko.computed(function(b,c){return a.paymentMethod()==DATATRANS_ECA||a.paymentMethod()==DATATRANS_VIS||a.paymentMethod()==DATATRANS_AMX||a.paymentMethod()==DATATRANS_DIN}),a.cancelPurchaseVisible=ko.computed(function(){return!a.purchased()}),a.submitPurchaseVisible=ko.computed(function(){return!a.purchased()}),a.okVisible=ko.computed(function(){return 1==a.purchased()&&!a.isPaymentProvider(BACHMANNPAY)}),a.scannedVisible=ko.computed(function(){return 1==a.purchased()&&a.isPaymentProvider(BACHMANNPAY)}),a.isPaymentProvider=function(b){return!!a.paymentMethod()&&a.paymentMethod().startsWith(b)},a.getPaymentMethodKey=function(){var b=a.paymentMethod(),c=a.getPaymentParts(b);return c&&c.length>1?c[1]:b},a.getPaymentType=function(){var b=a.paymentMethod(),c=a.getPaymentParts(b);return c&&c.length>1?c[0]:b},a.getPaymentParts=function(a){return a?a.split(PAYMENT_SEPARATOR):null};for(var b=moment().year(),c=b;c<=b+10;c++)a.optionsExpiryYear.push({id:c,value:new String(c).substr(2,4)});this.optionsExpiryMonth=ko.observableArray([{Id:1,Name:i18n.t("storecredits.purchase.expiryMonth.1")},{Id:2,Name:i18n.t("storecredits.purchase.expiryMonth.2")},{Id:3,Name:i18n.t("storecredits.purchase.expiryMonth.3")},{Id:4,Name:i18n.t("storecredits.purchase.expiryMonth.4")},{Id:5,Name:i18n.t("storecredits.purchase.expiryMonth.5")},{Id:6,Name:i18n.t("storecredits.purchase.expiryMonth.6")},{Id:7,Name:i18n.t("storecredits.purchase.expiryMonth.7")},{Id:8,Name:i18n.t("storecredits.purchase.expiryMonth.8")},{Id:9,Name:i18n.t("storecredits.purchase.expiryMonth.9")},{Id:10,Name:i18n.t("storecredits.purchase.expiryMonth.10")},{Id:11,Name:i18n.t("storecredits.purchase.expiryMonth.11")},{Id:12,Name:i18n.t("storecredits.purchase.expiryMonth.12")}]),a.StoreCreditHistory=ko.observableArray([]),a.storeCreditAmountTitle=ko.computed(function(a,b){return""}),a.cleanAddCredit=function(){a.purchaseOngoing(!1),a.purchased(!1),$(".purchase-success, .purchase-error").hide(),a.successMessage(""),a.errorMessage("")},a.addCredit=function(){if(a.resetPayment(),a.cleanAddCredit(),a.purchaseAmountField()){if(a.purchaseAmountField()<1)return void showInfo(i18n.t("storecredits.purchase.msg.validationErrorZero"));a.purchaseAmount(a.purchaseAmountField()),$(".creditPayment").fadeIn()}},a.validateLimit=function(){if(!a.paymentMethod())return!0;if(a.paymentMethod()==INVOICE){if(null!=headerVM.scOrderLowerLimit()&&a.purchaseAmount()<headerVM.scOrderLowerLimit())return showInfo(i18n.t("storecredits.purchase.msg.validationErrorLowerLimit",{validationAmount:a.purchaseAmount(),limit:headerVM.scOrderLowerLimit()})),!1;if(null!=headerVM.scOrderUpperLimit()&&a.purchaseAmount()>headerVM.scOrderUpperLimit())return showInfo(i18n.t("storecredits.purchase.msg.validationErrorUpperLimit",{validationAmount:a.purchaseAmount(),limit:headerVM.scOrderUpperLimit()})),!1}else{if(null!=headerVM.scOrderDatatransLowerLimit()&&a.purchaseAmount()<headerVM.scOrderDatatransLowerLimit())return showInfo(i18n.t("storecredits.purchase.msg.validationErrorDatatransLowerLimit",{validationAmount:a.purchaseAmount(),limit:headerVM.scOrderDatatransLowerLimit()})),!1;if(null!=headerVM.scOrderDatatransUpperLimit()&&a.purchaseAmount()>headerVM.scOrderDatatransUpperLimit())return showInfo(i18n.t("storecredits.purchase.msg.validationErrorDatatransUpperLimit",{validationAmount:a.purchaseAmount(),limit:headerVM.scOrderDatatransUpperLimit()})),!1}return!0},a.purchase=function(){a.purchaseOngoing(!0);var b={amount:a.purchaseAmount(),paymentType:a.getPaymentType()};$.ajax(serviceRootURL+"/store_credits",{type:"POST",data:JSON.stringify(b),dataType:"json",contentType:"application/json",success:function(b,c,d){console.log("store credit order created (id="+b.id+")"),a.paymentMethod()==INVOICE?a.showSuccess(i18n.t("storecredits.purchase.msg.success")):a.isPaymentProvider(DATATRANS)?a.payStoreCreditsDatatrans(b):a.isPaymentProvider(BACHMANNPAY)?a.payStoreCreditsBachmannpay(b):showError("Unknown payment provider.",d,c,errorThrown)},error:function(b,c,d){console.log("Server error on creating store credit order:\n"+b.responseText),showError("Server error on creating store credit order:",b,c,d),a.handleOtherError(b,c,d)}})},a.payStoreCreditsDatatrans=function(b){$.ajax(serviceRootURL+"/preparepayment_stc/"+b.id,{type:"GET",dataType:"json",contentType:"application/json",success:function(b,c,d){var e={amount:b.amount,refno:b.refno,paymentmethod:a.getPaymentMethodKey(a.paymentMethod()),currency:b.currency,successUrl:b.successUrl,errorUrl:b.errorUrl,cancelUrl:b.cancelUrl,language:b.language,reqtype:b.reqtype,sign:b.sign,hiddenMode:"yes",merchantId:merchantId};a.paymentMethod()!=DATATRANS_PEF&&a.paymentMethod()!=DATATRANS_PFC&&a.paymentMethod()!=DATATRANS_PAP&&(e.cardno=a.cardNo(),e.expm=a.expiryMonth(),e.expy=a.expiryYear(),e.cvv=a.cvv()),submitForm(b.redirect,"POST",e,"paymentFormGen")},error:function(a,b,c){console.log("error during payment"),showError("Fehler beim Durchführen der Bezahlung",a,b,c)}})},a.payStoreCreditsBachmannpay=function(b){$.ajax(serviceRootURL+"/getpaymentmessage/"+b.id,{type:"GET",data:{paymentMethod:a.paymentMethod()},dataType:"json",contentType:"application/json",success:function(b,c,d){a.purchaseOngoing(!1);var e={errorCode:b.errorCode,errorText:b.errorText,qrCode:b.qrCode};null!==e.qrCode&&e.qrCode.length>0?(a.qrCode(e.qrCode),a.showSuccess(i18n.t("storecredits.purchase.msg.success"))):(console.log("error during payment - unknown error"),showError("Fehler beim Durchführen der Bezahlung - unbekannter Fehler"))},error:function(a,b,c){console.log("error during bachmannpay payment"),showError("Fehler beim Durchführen der Bezahlung",a,b,c)}})},a.handlePaymentCallback=function(){getPaymentResponseMessage()&&bootbox.alert({title:getPaymentResponseTitle(),message:getPaymentResponseMessage(),callback:function(){a.finishPurchase(),setPaymentResponse(null,null)}})},a.handlePaymentCallback(),a.resetPayment=function(){a.purchased(!1),a.paymentMethod(null),a.cardNo(null),a.expiryMonth(null),a.expiryYear(null),a.cvv(null)},a.cancelPurchase=function(){a.resetPayment(),$(".creditPayment").fadeOut(function(){a.cleanAddCredit()})},a.finishPurchase=function(){$(".creditPayment").fadeOut(function(){a.cleanAddCredit(),a.searchHistory()})},a.handlePurchaseError=function(b,c,d){checkSession(b),a.showError(i18n.t("storecredits.purchase.msg.unexpectederror",{amount:a.purchaseAmount(),currency:currency()})+"\n"+a.getError(b,c,d))},a.handleOtherError=function(b,c,d){checkSession(b),a.showError("")},a.showSuccess=function(b){a.purchased(!0),a.purchaseOngoing(!1),a.successMessage(b),$(".purchase-error").slideUp(),$(".purchase-success").slideDown()},a.showError=function(b){a.purchased(!1),a.purchaseOngoing(!1),a.errorMessage(b),$(".purchase-error").slideDown(),$(".purchase-success").slideUp()},a.qrCodeVisible=ko.computed(function(){return a.isPaymentProvider(BACHMANNPAY)&&a.purchased()}),a.searchHistory=function(){$(".dateRange").fadeOut(),a.disableFilter();try{$.ajax(serviceRootURL+"/store_credits",{type:"GET",data:{rangeType:a.rangeType(),fromDate:a.fromDate(),toDate:a.toDate()},dataType:"json",contentType:"application/json",success:function(b,c,d){console.log("store credit history found: "+b);var e=$.map(b,function(a){return console.log(a),new storeCreditHistoryModel(a)});a.StoreCreditHistory(e),a.enableFilter()},error:function(b,c,d){checkSession(b),a.enableFilter(),console.log("Server error on loading store credit history: "+b.responseText),showError(i18n.t("storecredits.msg.errorLoadingHistory"),b,c,d)}})}catch(b){a.enableFilter(),console.log("Exception on loading store credit history: "+b),showException(i18n.t("storecredits.msg.errorLoadingHistory"),b)}},a.getError=function(a,b,c){var d="";if(-1!=getErrorCode(a)){var e=$.parseJSON(a.responseText);d=e.message+" (code: "+e.code+")"}else d=a.responseText;return d},a.selectRangeType=ko.computed(function(b,c){a.rangeType()!=TURNOVER_RANGE_CUSTOM?(a.fromDate(""),a.toDate(""),$("#startDate").val(""),$("#endDate").val(""),$(".dateRange").fadeOut(),a.searchHistory()):a.rangeType()==TURNOVER_RANGE_CUSTOM&&(""==$("#startDate").val()&&a.fromDate(""),""==$("#endDate").val()&&a.toDate(""))})}function init(){$("#customDateRange").on("click",function(){$(".dateRange").fadeIn()}),$(function(){$(".datepicker").datepicker()})}function showStoreCredits(){ko.cleanNode($("#container")),$("#container").load("assets/store-credits.html",function(){init(),storeCreditsVM=new storeCreditsViewModel,ko.applyBindings(storeCreditsVM,document.getElementById("storeCreditsInfo"))})}function abosViewModel(){var a=this;ko.utils.extend(a,new reportViewModel),a.OrderItem=ko.observable(),a.orderNumber=ko.observable(),a.allItems=ko.observable(!0),a.orderType=ko.observable(),a.optionsPickupOrderType=headerVM.optionsPickupOrderType,a.viewType=ko.observable("available"),a.OrderItems=ko.observableArray([]),a.OrderItemsProduced=ko.observableArray([]),a.mediaSwap=function(a){console.log("media Swap Ticket"),$(".abos-mediaSwap").load("assets/abos-mediaSwap.html",function(){$.getScript("assets/js/jungfrau.min.js");var b=new abosMediaSwapViewModel(a);ko.applyBindings(b,document.getElementById("mediaSwap")),$("#mediaSwap").modal("show"),$("#mediaSwapForm").parsley()})},a.isProduced=function(a){return console.log("isProduced..."),$("#personalize").modal("hide"),"booked"==a.contractorSystemStatus()&&"produced"==a.vendingMachineStatus()},a.personalizeTicket=function(a){console.log("personalize Ticket"),$("#personalizationSave").attr("disabled","false"),$("#personalizationCancel").attr("disabled","false"),$(".abos-personalization").load("assets/abos-personalization.html",function(){$.getScript("assets/js/jungfrau.min.js");var b=new abosPersonalizationViewModel(a);ko.applyBindings(b,document.getElementById("personalize")),$("#personalize").modal("show"),$("#personalizeForm").parsley(),"booked"!=a.contractorSystemStatus()&&menuVM.hasAboPersonalisation()||($("#personalizeForm").find("select").attr("disabled","true"),$("#personalizeForm").find("label").attr("disabled","true"),$("#personalizeForm").find("input").attr("disabled","true"),$("#personalizeForm").find("button").not("#personalizationCancel").attr("disabled","true"))})},a.searchOrderAbo=function(){if(!a.orderNumber())return void showInfo(i18n.t("abos.msgPickupCodeMissing"));isSwisspassNumber(a.orderNumber())&&a.orderNumber(a.orderNumber().replace(/-/g,"")),a.disableFilter();try{$.ajax(serviceRootURL+"/pickuporderitem",{type:"GET",data:{pickupCode:a.orderNumber(),loadTouristCardPermissions:menuVM.hasAboAdditionalValues(),isUpgradeAction:!1},dataType:"json",contentType:"application/json",success:function(b,c,d){var e=$.map(b,function(a){var b=new orderItemModel(a);return b.setTouristCardPermissions(a,headerVM.touristCardPermissions()),b});a.OrderItems(e),a.enableFilter()},error:function(b,c,d){checkSession(b),a.enableFilter(),console.log("Server error on loading order: "+b.responseText),showError(i18n.t("tickets.msg.errorLoading"),b,c,d)}})}catch(b){checkSession(xhr),a.enableFilter(),console.log("Exception on loading orders: "+b),showException(i18n.t("tickets.msg.errorLoading"),b)}},a.reset=function(){a.OrderItem(null),a.orderNumber(null),a.OrderItems(null)},a.consumeTouristCardPermission=function(a,b,c){console.log("consumeTouristCardPermission: "+b.key());var d={id:a.id(),touristCardPermissions:[{key:b.key(),used:!0}]};$.ajax({url:serviceRootURL+"/pickuporderitem/"+a.id(),type:"PUT",data:JSON.stringify(d),dataType:"json",contentType:"application/json",success:function(a,b,c){console.log("updatePickupOrderItem successful "+a),abosVM.searchOrderAbo()},error:function(a,b,c){checkSession(a),console.log("Unerwarteter Fehler beim Einlösen des Mehrwerts"),showError(i18n.t("abos.touristCardPermissions.msgUpdateError"),a,b,c)}})}}function abosMediaSwapViewModel(a){var b=this;b.mediaSwapNumber=ko.observable(),b.performMediaSwap=function(){console.log("performMediaSwap..."),console.log("ORDER found: "+a),str=JSON.stringify(a,null,4),console.log(str),console.log("Here"),console.log(a.id()),console.log(a.categoryKey()),console.log(a.pickupCode()),console.log(b.mediaSwapNumber());var c={id:a.id()};console.log(c);try{$.ajax(serviceRootURL+"/mediaswap_pickuporderitem/"+a.id()+"/"+b.mediaSwapNumber(),{type:"PUT",data:JSON.stringify(c),dataType:"json",contentType:"application/json",success:function(a,b,c){$("#abos-mediaSwap").modal("hide"),$("#mediaSwap").modal("hide"),console.log("success "+c.responseText)},error:function(a,b,c){console.log("Server error on loading order: "+a.responseText),showError(i18n.t("tickets.msg.errorLoading"),a,b,c)}})}catch(a){console.log("Exception on loading orders: "+a),showException(i18n.t("tickets.msg.errorLoading"),a)}}}function abosPersonalizationViewModel(a){var b=this;abstractPersonalizationViewModel.apply(b,[]),b.selectedGender=ko.observable(a.ticketholder().gender()),b.selectedFirstName=ko.observable(a.ticketholder().firstName()),b.selectedLastName=ko.observable(a.ticketholder().lastName()),b.selectedEmail=ko.observable(a.ticketholder().email()),b.selectedStreet=ko.observable(a.ticketholder().street()),b.selectedStreetNo=ko.observable(a.ticketholder().streetNumber()),b.selectedZipCode=ko.observable(a.ticketholder().zipCode()),b.selectedCity=ko.observable(a.ticketholder().city()),b.selectedCountry=ko.observable(a.ticketholder().country()),b.selectedBirthdateDay=ko.observable(a.ticketholder().birthdateDay()),b.selectedBirthdateMonth=ko.observable(a.ticketholder().birthdateMonth()),b.selectedBirthdateYear=ko.observable(a.ticketholder().birthdateYear()),b.selectedPhoto=ko.observable(),b.uploadedPhoto=ko.observable(),b.encodedPhoto=ko.observable(a.ticketholder().encodedPhoto()),b.encodedPhotoWebcam=ko.observable();var c=new Date,d=c.toISOString();console.log("abosPersonalizationViewModel().date: "+d),b.exportDate=ko.observable(d),str=JSON.stringify(a,null,4),console.log(a),console.log(a.ticketholder().firstName()),console.log(a.ticketholder().lastName());var e=a.ticketholder().encodedPhoto(),f=e;e&&!e.startsWith("data:image/jpeg;base64,")&&(f="data:image/jpeg;base64,"+e),a.ticketholder().encodedPhoto(f),b.selectedPhoto(f),b.encodedPhoto(f),b.encodedPhotoWebcam(f),"booked"!=a.contractorSystemStatus()&&menuVM.hasAboPersonalisation()?b.showing=ko.observable("1"):b.showing=ko.observable("4"),b.activateWebcam=function(){console.log("abosPersonalizationViewModel.activateWebcam()"),b.showing("2");var a=document.getElementById("video"),c={video:{mandatory:{maxWidth:"250",maxHeight:"320",minWidth:"250",minHeight:"320"},audio:!1}};navigator.mediaDevices&&navigator.mediaDevices.getUserMedia&&a?(navigator.mediaDevices.getUserMedia(c).then(function(c){b.webcamStream=c,"srcObject"in a?a.srcObject=c:a.src=window.URL.createObjectURL(c),a.onloadedmetadata=function(b){a.play()}}).catch(function(a){console.log("Camera rejected",a)}),console.log("video initialized")):console.log("video couldn't be initialized")},b.snapPhoto=function(){console.log("abosPersonalizationViewModel.snapPhoto()");var a=document.getElementById("video"),c=document.getElementById("canvas");c.getContext("2d").drawImage(a,0,0,250,320);var d=new Image;d.src=c.toDataURL("image/jpeg"),b.encodedPhotoWebcam(d.src),b.showing("3"),b.webcamStream.getTracks().forEach(function(a){a.stop()})},b.replacePhoto=function(){console.log("abosPersonalizationViewModel.snapPhoto()"),b.encodedPhoto(b.encodedPhotoWebcam()),b.showing("1")},b.backToPhoto=function(){console.log("abosPersonalizationViewModel.backToPhoto()"),b.showing("1"),b.selectedPhoto=null,b.webcamStream&&b.webcamStream.getTracks().forEach(function(a){a.stop()}),console.log("Shutdown")},b.updatePickupOrderItem=function(){if(console.log("abosPersonalizationViewModel.updatePickupOrderItem().date: "+b.exportDate()),$("#personalizationSave").attr("disabled","true"),$("#personalizationCancel").attr("disabled","true"),$("#personalizeForm").parsley().validate()){var c={id:a.id(),ticketholder:{gender:b.selectedGender(),firstName:b.selectedFirstName(),lastName:b.selectedLastName(),street:b.selectedStreet(),streetNumber:b.selectedStreetNo(),zipCode:b.selectedZipCode(),city:b.selectedCity(),country:b.selectedCountry(),birthDateString:b.selectedBirthdateYear()+"-"+b.selectedBirthdateMonth()+"-"+b.selectedBirthdateDay(),email:b.selectedEmail(),encodedPhoto:b.encodedPhoto()}};$.ajax({url:serviceRootURL+"/pickuporderitem/"+a.id(),type:"PUT",data:JSON.stringify(c),dataType:"json",contentType:"application/json",success:function(a,b,c){console.log("updatePickupOrderItem successful "+a),abosVM.searchOrderAbo()},error:function(b,c,d){checkSession(b),console.log("Unerwarteter Fehler beim Personalisieren des Tickets mit ID: "+a.id()),showError(i18n.t("abos.msgPersonalizationError"),b,c,d)}})}}}function showAbos(){cleanContainer(),$("#container").load("assets/abos.html",function(){abosVM=new abosViewModel,ko.applyBindings(abosVM,document.getElementById("abosInfo"))})}function abstractPersonalizationViewModel(){var a=this;this.optionsGender=ko.observableArray([{key:"male",name:i18n.t("ticketsDetail.ticketholder.options.gender.male")},{key:"female",name:i18n.t("ticketsDetail.ticketholder.options.gender.female")}]),this.optionsSalutation=ko.observableArray([{key:"male",name:i18n.t("registration.details.salutationOptions.male")},{key:"female",name:i18n.t("registration.details.salutationOptions.female")}]),this.optionsBirthdateMonth=ko.observableArray([{Id:1,Name:i18n.t("ticketsDetail.ticketholder.options.birthdateMonth.1")},{Id:2,Name:i18n.t("ticketsDetail.ticketholder.options.birthdateMonth.2")},{Id:3,Name:i18n.t("ticketsDetail.ticketholder.options.birthdateMonth.3")},{Id:4,Name:i18n.t("ticketsDetail.ticketholder.options.birthdateMonth.4")},{Id:5,Name:i18n.t("ticketsDetail.ticketholder.options.birthdateMonth.5")},{Id:6,Name:i18n.t("ticketsDetail.ticketholder.options.birthdateMonth.6")},{Id:7,Name:i18n.t("ticketsDetail.ticketholder.options.birthdateMonth.7")},{Id:8,Name:i18n.t("ticketsDetail.ticketholder.options.birthdateMonth.8")},{Id:9,Name:i18n.t("ticketsDetail.ticketholder.options.birthdateMonth.9")},{Id:10,Name:i18n.t("ticketsDetail.ticketholder.options.birthdateMonth.10")},{Id:11,Name:i18n.t("ticketsDetail.ticketholder.options.birthdateMonth.11")},{Id:12,Name:i18n.t("ticketsDetail.ticketholder.options.birthdateMonth.12")}]),this.optionsBirthdateDay=ko.observableArray([{Id:"1"},{Id:"2"},{Id:"3"},{Id:"4"},{Id:"5"},{Id:"6"},{Id:"7"},{Id:"8"},{Id:"9"},{Id:"10"},{Id:"11"},{Id:"12"},{Id:"13"},{Id:"14"},{Id:"15"},{Id:"16"},{Id:"17"},{Id:"18"},{Id:"19"},{Id:"20"},{Id:"21"},{Id:"22"},{Id:"23"},{Id:"24"},{Id:"25"},{Id:"26"},{Id:"27"},{Id:"28"},{Id:"29"},{Id:"30"},{Id:"31"}]);var b=moment().year();this.optionsBirthdateYear=ko.observableArray();for(var c=b;c>=1900;c--)this.optionsBirthdateYear.push({Id:c});for(a.compareCountries=function(a,b){return a.name.localeCompare(b.name)},this.languageOptions=ko.observableArray([{key:"de_CH",name:i18n.t("common.language.german"),enabled:ko.observable(!0)},{key:"en_GB",name:i18n.t("common.language.english"),enabled:ko.observable(!0)},{key:"fr_CH",name:i18n.t("common.language.france"),enabled:ko.observable(!0)}]),this.optionsCountry=ko.observableArray([{key:"CH",name:i18n.t("ticketsDetail.ticketholder.options.country.CH"),enabled:ko.observable(!0)},{key:"DE",name:i18n.t("ticketsDetail.ticketholder.options.country.DE"),enabled:ko.observable(!0)},{key:"FR",name:i18n.t("ticketsDetail.ticketholder.options.country.FR"),enabled:ko.observable(!0)},{key:"IT",name:i18n.t("ticketsDetail.ticketholder.options.country.IT"),enabled:ko.observable(!0)},{key:"GB",name:i18n.t("ticketsDetail.ticketholder.options.country.GB"),enabled:ko.observable(!0)},{key:"NL",name:i18n.t("ticketsDetail.ticketholder.options.country.NL"),enabled:ko.observable(!0)},{key:"AT",name:i18n.t("ticketsDetail.ticketholder.options.country.AT"),enabled:ko.observable(!0)}]),this.optionsCountryLowPrio=ko.observableArray([{key:"AF",name:i18n.t("ticketsDetail.ticketholder.options.country.AF"),enabled:ko.observable(!0)},{key:"AX",name:i18n.t("ticketsDetail.ticketholder.options.country.AX"),enabled:ko.observable(!0)},{key:"AL",name:i18n.t("ticketsDetail.ticketholder.options.country.AL"),enabled:ko.observable(!0)},{key:"DZ",name:i18n.t("ticketsDetail.ticketholder.options.country.DZ"),enabled:ko.observable(!0)},{key:"AS",name:i18n.t("ticketsDetail.ticketholder.options.country.AS"),enabled:ko.observable(!0)},{key:"AD",name:i18n.t("ticketsDetail.ticketholder.options.country.AD"),enabled:ko.observable(!0)},{key:"AO",name:i18n.t("ticketsDetail.ticketholder.options.country.AO"),enabled:ko.observable(!0)},{key:"AI",name:i18n.t("ticketsDetail.ticketholder.options.country.AI"),enabled:ko.observable(!0)},{key:"AQ",name:i18n.t("ticketsDetail.ticketholder.options.country.AQ"),enabled:ko.observable(!0)},{key:"AG",name:i18n.t("ticketsDetail.ticketholder.options.country.AG"),enabled:ko.observable(!0)},{key:"AR",name:i18n.t("ticketsDetail.ticketholder.options.country.AR"),enabled:ko.observable(!0)},{key:"AM",name:i18n.t("ticketsDetail.ticketholder.options.country.AM"),enabled:ko.observable(!0)},{key:"AW",name:i18n.t("ticketsDetail.ticketholder.options.country.AW"),enabled:ko.observable(!0)},{key:"AU",name:i18n.t("ticketsDetail.ticketholder.options.country.AU"),enabled:ko.observable(!0)},{key:"AZ",name:i18n.t("ticketsDetail.ticketholder.options.country.AZ"),enabled:ko.observable(!0)},{key:"BS",name:i18n.t("ticketsDetail.ticketholder.options.country.BS"),enabled:ko.observable(!0)},{key:"BH",name:i18n.t("ticketsDetail.ticketholder.options.country.BH"),enabled:ko.observable(!0)},{key:"BD",name:i18n.t("ticketsDetail.ticketholder.options.country.BD"),enabled:ko.observable(!0)},{key:"BB",name:i18n.t("ticketsDetail.ticketholder.options.country.BB"),enabled:ko.observable(!0)},{key:"BY",name:i18n.t("ticketsDetail.ticketholder.options.country.BY"),enabled:ko.observable(!0)},{key:"BE",name:i18n.t("ticketsDetail.ticketholder.options.country.BE"),enabled:ko.observable(!0)},{key:"BZ",
name:i18n.t("ticketsDetail.ticketholder.options.country.BZ"),enabled:ko.observable(!0)},{key:"BJ",name:i18n.t("ticketsDetail.ticketholder.options.country.BJ"),enabled:ko.observable(!0)},{key:"BM",name:i18n.t("ticketsDetail.ticketholder.options.country.BM"),enabled:ko.observable(!0)},{key:"BT",name:i18n.t("ticketsDetail.ticketholder.options.country.BT"),enabled:ko.observable(!0)},{key:"BO",name:i18n.t("ticketsDetail.ticketholder.options.country.BO"),enabled:ko.observable(!0)},{key:"BA",name:i18n.t("ticketsDetail.ticketholder.options.country.BA"),enabled:ko.observable(!0)},{key:"BW",name:i18n.t("ticketsDetail.ticketholder.options.country.BW"),enabled:ko.observable(!0)},{key:"BV",name:i18n.t("ticketsDetail.ticketholder.options.country.BV"),enabled:ko.observable(!0)},{key:"BR",name:i18n.t("ticketsDetail.ticketholder.options.country.BR"),enabled:ko.observable(!0)},{key:"IO",name:i18n.t("ticketsDetail.ticketholder.options.country.IO"),enabled:ko.observable(!0)},{key:"VG",name:i18n.t("ticketsDetail.ticketholder.options.country.VG"),enabled:ko.observable(!0)},{key:"BN",name:i18n.t("ticketsDetail.ticketholder.options.country.BN"),enabled:ko.observable(!0)},{key:"BG",name:i18n.t("ticketsDetail.ticketholder.options.country.BG"),enabled:ko.observable(!0)},{key:"BF",name:i18n.t("ticketsDetail.ticketholder.options.country.BF"),enabled:ko.observable(!0)},{key:"BI",name:i18n.t("ticketsDetail.ticketholder.options.country.BI"),enabled:ko.observable(!0)},{key:"KH",name:i18n.t("ticketsDetail.ticketholder.options.country.KH"),enabled:ko.observable(!0)},{key:"CM",name:i18n.t("ticketsDetail.ticketholder.options.country.CM"),enabled:ko.observable(!0)},{key:"CA",name:i18n.t("ticketsDetail.ticketholder.options.country.CA"),enabled:ko.observable(!0)},{key:"CV",name:i18n.t("ticketsDetail.ticketholder.options.country.CV"),enabled:ko.observable(!0)},{key:"KY",name:i18n.t("ticketsDetail.ticketholder.options.country.KY"),enabled:ko.observable(!0)},{key:"CF",name:i18n.t("ticketsDetail.ticketholder.options.country.CF"),enabled:ko.observable(!0)},{key:"TD",name:i18n.t("ticketsDetail.ticketholder.options.country.TD"),enabled:ko.observable(!0)},{key:"CL",name:i18n.t("ticketsDetail.ticketholder.options.country.CL"),enabled:ko.observable(!0)},{key:"CN",name:i18n.t("ticketsDetail.ticketholder.options.country.CN"),enabled:ko.observable(!0)},{key:"CX",name:i18n.t("ticketsDetail.ticketholder.options.country.CX"),enabled:ko.observable(!0)},{key:"CC",name:i18n.t("ticketsDetail.ticketholder.options.country.CC"),enabled:ko.observable(!0)},{key:"CO",name:i18n.t("ticketsDetail.ticketholder.options.country.CO"),enabled:ko.observable(!0)},{key:"KM",name:i18n.t("ticketsDetail.ticketholder.options.country.KM"),enabled:ko.observable(!0)},{key:"CG",name:i18n.t("ticketsDetail.ticketholder.options.country.CG"),enabled:ko.observable(!0)},{key:"CD",name:i18n.t("ticketsDetail.ticketholder.options.country.CD"),enabled:ko.observable(!0)},{key:"CK",name:i18n.t("ticketsDetail.ticketholder.options.country.CK"),enabled:ko.observable(!0)},{key:"CR",name:i18n.t("ticketsDetail.ticketholder.options.country.CR"),enabled:ko.observable(!0)},{key:"HR",name:i18n.t("ticketsDetail.ticketholder.options.country.HR"),enabled:ko.observable(!0)},{key:"CU",name:i18n.t("ticketsDetail.ticketholder.options.country.CU"),enabled:ko.observable(!0)},{key:"CY",name:i18n.t("ticketsDetail.ticketholder.options.country.CY"),enabled:ko.observable(!0)},{key:"CZ",name:i18n.t("ticketsDetail.ticketholder.options.country.CZ"),enabled:ko.observable(!0)},{key:"DK",name:i18n.t("ticketsDetail.ticketholder.options.country.DK"),enabled:ko.observable(!0)},{key:"DJ",name:i18n.t("ticketsDetail.ticketholder.options.country.DJ"),enabled:ko.observable(!0)},{key:"DM",name:i18n.t("ticketsDetail.ticketholder.options.country.DM"),enabled:ko.observable(!0)},{key:"DO",name:i18n.t("ticketsDetail.ticketholder.options.country.DO"),enabled:ko.observable(!0)},{key:"TL",name:i18n.t("ticketsDetail.ticketholder.options.country.TL"),enabled:ko.observable(!0)},{key:"EC",name:i18n.t("ticketsDetail.ticketholder.options.country.EC"),enabled:ko.observable(!0)},{key:"EG",name:i18n.t("ticketsDetail.ticketholder.options.country.EG"),enabled:ko.observable(!0)},{key:"SV",name:i18n.t("ticketsDetail.ticketholder.options.country.SV"),enabled:ko.observable(!0)},{key:"GQ",name:i18n.t("ticketsDetail.ticketholder.options.country.GQ"),enabled:ko.observable(!0)},{key:"ER",name:i18n.t("ticketsDetail.ticketholder.options.country.ER"),enabled:ko.observable(!0)},{key:"EE",name:i18n.t("ticketsDetail.ticketholder.options.country.EE"),enabled:ko.observable(!0)},{key:"ET",name:i18n.t("ticketsDetail.ticketholder.options.country.ET"),enabled:ko.observable(!0)},{key:"FK",name:i18n.t("ticketsDetail.ticketholder.options.country.FK"),enabled:ko.observable(!0)},{key:"FO",name:i18n.t("ticketsDetail.ticketholder.options.country.FO"),enabled:ko.observable(!0)},{key:"FJ",name:i18n.t("ticketsDetail.ticketholder.options.country.FJ"),enabled:ko.observable(!0)},{key:"FI",name:i18n.t("ticketsDetail.ticketholder.options.country.FI"),enabled:ko.observable(!0)},{key:"GF",name:i18n.t("ticketsDetail.ticketholder.options.country.GF"),enabled:ko.observable(!0)},{key:"PF",name:i18n.t("ticketsDetail.ticketholder.options.country.PF"),enabled:ko.observable(!0)},{key:"TF",name:i18n.t("ticketsDetail.ticketholder.options.country.TF"),enabled:ko.observable(!0)},{key:"GA",name:i18n.t("ticketsDetail.ticketholder.options.country.GA"),enabled:ko.observable(!0)},{key:"GM",name:i18n.t("ticketsDetail.ticketholder.options.country.GM"),enabled:ko.observable(!0)},{key:"GE",name:i18n.t("ticketsDetail.ticketholder.options.country.GE"),enabled:ko.observable(!0)},{key:"GH",name:i18n.t("ticketsDetail.ticketholder.options.country.GH"),enabled:ko.observable(!0)},{key:"GI",name:i18n.t("ticketsDetail.ticketholder.options.country.GI"),enabled:ko.observable(!0)},{key:"GR",name:i18n.t("ticketsDetail.ticketholder.options.country.GR"),enabled:ko.observable(!0)},{key:"GL",name:i18n.t("ticketsDetail.ticketholder.options.country.GL"),enabled:ko.observable(!0)},{key:"GD",name:i18n.t("ticketsDetail.ticketholder.options.country.GD"),enabled:ko.observable(!0)},{key:"GP",name:i18n.t("ticketsDetail.ticketholder.options.country.GP"),enabled:ko.observable(!0)},{key:"GU",name:i18n.t("ticketsDetail.ticketholder.options.country.GU"),enabled:ko.observable(!0)},{key:"GT",name:i18n.t("ticketsDetail.ticketholder.options.country.GT"),enabled:ko.observable(!0)},{key:"GN",name:i18n.t("ticketsDetail.ticketholder.options.country.GN"),enabled:ko.observable(!0)},{key:"GW",name:i18n.t("ticketsDetail.ticketholder.options.country.GW"),enabled:ko.observable(!0)},{key:"GY",name:i18n.t("ticketsDetail.ticketholder.options.country.GY"),enabled:ko.observable(!0)},{key:"HT",name:i18n.t("ticketsDetail.ticketholder.options.country.HT"),enabled:ko.observable(!0)},{key:"HM",name:i18n.t("ticketsDetail.ticketholder.options.country.HM"),enabled:ko.observable(!0)},{key:"HN",name:i18n.t("ticketsDetail.ticketholder.options.country.HN"),enabled:ko.observable(!0)},{key:"HK",name:i18n.t("ticketsDetail.ticketholder.options.country.HK"),enabled:ko.observable(!0)},{key:"HU",name:i18n.t("ticketsDetail.ticketholder.options.country.HU"),enabled:ko.observable(!0)},{key:"IS",name:i18n.t("ticketsDetail.ticketholder.options.country.IS"),enabled:ko.observable(!0)},{key:"IN",name:i18n.t("ticketsDetail.ticketholder.options.country.IN"),enabled:ko.observable(!0)},{key:"ID",name:i18n.t("ticketsDetail.ticketholder.options.country.ID"),enabled:ko.observable(!0)},{key:"IR",name:i18n.t("ticketsDetail.ticketholder.options.country.IR"),enabled:ko.observable(!0)},{key:"IQ",name:i18n.t("ticketsDetail.ticketholder.options.country.IQ"),enabled:ko.observable(!0)},{key:"IE",name:i18n.t("ticketsDetail.ticketholder.options.country.IE"),enabled:ko.observable(!0)},{key:"IL",name:i18n.t("ticketsDetail.ticketholder.options.country.IL"),enabled:ko.observable(!0)},{key:"CI",name:i18n.t("ticketsDetail.ticketholder.options.country.CI"),enabled:ko.observable(!0)},{key:"JM",name:i18n.t("ticketsDetail.ticketholder.options.country.JM"),enabled:ko.observable(!0)},{key:"JP",name:i18n.t("ticketsDetail.ticketholder.options.country.JP"),enabled:ko.observable(!0)},{key:"JO",name:i18n.t("ticketsDetail.ticketholder.options.country.JO"),enabled:ko.observable(!0)},{key:"KZ",name:i18n.t("ticketsDetail.ticketholder.options.country.KZ"),enabled:ko.observable(!0)},{key:"KE",name:i18n.t("ticketsDetail.ticketholder.options.country.KE"),enabled:ko.observable(!0)},{key:"KI",name:i18n.t("ticketsDetail.ticketholder.options.country.KI"),enabled:ko.observable(!0)},{key:"KW",name:i18n.t("ticketsDetail.ticketholder.options.country.KW"),enabled:ko.observable(!0)},{key:"KG",name:i18n.t("ticketsDetail.ticketholder.options.country.KG"),enabled:ko.observable(!0)},{key:"LA",name:i18n.t("ticketsDetail.ticketholder.options.country.LA"),enabled:ko.observable(!0)},{key:"LV",name:i18n.t("ticketsDetail.ticketholder.options.country.LV"),enabled:ko.observable(!0)},{key:"LB",name:i18n.t("ticketsDetail.ticketholder.options.country.LB"),enabled:ko.observable(!0)},{key:"LS",name:i18n.t("ticketsDetail.ticketholder.options.country.LS"),enabled:ko.observable(!0)},{key:"LR",name:i18n.t("ticketsDetail.ticketholder.options.country.LR"),enabled:ko.observable(!0)},{key:"LY",name:i18n.t("ticketsDetail.ticketholder.options.country.LY"),enabled:ko.observable(!0)},{key:"LI",name:i18n.t("ticketsDetail.ticketholder.options.country.LI"),enabled:ko.observable(!0)},{key:"LT",name:i18n.t("ticketsDetail.ticketholder.options.country.LT"),enabled:ko.observable(!0)},{key:"LU",name:i18n.t("ticketsDetail.ticketholder.options.country.LU"),enabled:ko.observable(!0)},{key:"MO",name:i18n.t("ticketsDetail.ticketholder.options.country.MO"),enabled:ko.observable(!0)},{key:"MK",name:i18n.t("ticketsDetail.ticketholder.options.country.MK"),enabled:ko.observable(!0)},{key:"MG",name:i18n.t("ticketsDetail.ticketholder.options.country.MG"),enabled:ko.observable(!0)},{key:"MW",name:i18n.t("ticketsDetail.ticketholder.options.country.MW"),enabled:ko.observable(!0)},{key:"MY",name:i18n.t("ticketsDetail.ticketholder.options.country.MY"),enabled:ko.observable(!0)},{key:"MV",name:i18n.t("ticketsDetail.ticketholder.options.country.MV"),enabled:ko.observable(!0)},{key:"ML",name:i18n.t("ticketsDetail.ticketholder.options.country.ML"),enabled:ko.observable(!0)},{key:"MT",name:i18n.t("ticketsDetail.ticketholder.options.country.MT"),enabled:ko.observable(!0)},{key:"MH",name:i18n.t("ticketsDetail.ticketholder.options.country.MH"),enabled:ko.observable(!0)},{key:"MQ",name:i18n.t("ticketsDetail.ticketholder.options.country.MQ"),enabled:ko.observable(!0)},{key:"MR",name:i18n.t("ticketsDetail.ticketholder.options.country.MR"),enabled:ko.observable(!0)},{key:"MU",name:i18n.t("ticketsDetail.ticketholder.options.country.MU"),enabled:ko.observable(!0)},{key:"YT",name:i18n.t("ticketsDetail.ticketholder.options.country.YT"),enabled:ko.observable(!0)},{key:"MX",name:i18n.t("ticketsDetail.ticketholder.options.country.MX"),enabled:ko.observable(!0)},{key:"FM",name:i18n.t("ticketsDetail.ticketholder.options.country.FM"),enabled:ko.observable(!0)},{key:"MD",name:i18n.t("ticketsDetail.ticketholder.options.country.MD"),enabled:ko.observable(!0)},{key:"MC",name:i18n.t("ticketsDetail.ticketholder.options.country.MC"),enabled:ko.observable(!0)},{key:"MN",name:i18n.t("ticketsDetail.ticketholder.options.country.MN"),enabled:ko.observable(!0)},{key:"ME",name:i18n.t("ticketsDetail.ticketholder.options.country.ME"),enabled:ko.observable(!0)},{key:"MS",name:i18n.t("ticketsDetail.ticketholder.options.country.MS"),enabled:ko.observable(!0)},{key:"MA",name:i18n.t("ticketsDetail.ticketholder.options.country.MA"),enabled:ko.observable(!0)},{key:"MZ",name:i18n.t("ticketsDetail.ticketholder.options.country.MZ"),enabled:ko.observable(!0)},{key:"MM",name:i18n.t("ticketsDetail.ticketholder.options.country.MM"),enabled:ko.observable(!0)},{key:"NA",name:i18n.t("ticketsDetail.ticketholder.options.country.NA"),enabled:ko.observable(!0)},{key:"NR",name:i18n.t("ticketsDetail.ticketholder.options.country.NR"),enabled:ko.observable(!0)},{key:"NP",name:i18n.t("ticketsDetail.ticketholder.options.country.NP"),enabled:ko.observable(!0)},{key:"AN",name:i18n.t("ticketsDetail.ticketholder.options.country.AN"),enabled:ko.observable(!0)},{key:"NC",name:i18n.t("ticketsDetail.ticketholder.options.country.NC"),enabled:ko.observable(!0)},{key:"NZ",name:i18n.t("ticketsDetail.ticketholder.options.country.NZ"),enabled:ko.observable(!0)},{key:"NI",name:i18n.t("ticketsDetail.ticketholder.options.country.NI"),enabled:ko.observable(!0)},{key:"NE",name:i18n.t("ticketsDetail.ticketholder.options.country.NE"),enabled:ko.observable(!0)},{key:"NG",name:i18n.t("ticketsDetail.ticketholder.options.country.NG"),enabled:ko.observable(!0)},{key:"NU",name:i18n.t("ticketsDetail.ticketholder.options.country.NU"),enabled:ko.observable(!0)},{key:"NF",name:i18n.t("ticketsDetail.ticketholder.options.country.NF"),enabled:ko.observable(!0)},{key:"MP",name:i18n.t("ticketsDetail.ticketholder.options.country.MP"),enabled:ko.observable(!0)},{key:"KP",name:i18n.t("ticketsDetail.ticketholder.options.country.KP"),enabled:ko.observable(!0)},{key:"NO",name:i18n.t("ticketsDetail.ticketholder.options.country.NO"),enabled:ko.observable(!0)},{key:"OM",name:i18n.t("ticketsDetail.ticketholder.options.country.OM"),enabled:ko.observable(!0)},{key:"PK",name:i18n.t("ticketsDetail.ticketholder.options.country.PK"),enabled:ko.observable(!0)},{key:"PW",name:i18n.t("ticketsDetail.ticketholder.options.country.PW"),enabled:ko.observable(!0)},{key:"PS",name:i18n.t("ticketsDetail.ticketholder.options.country.PS"),enabled:ko.observable(!0)},{key:"PA",name:i18n.t("ticketsDetail.ticketholder.options.country.PA"),enabled:ko.observable(!0)},{key:"PG",name:i18n.t("ticketsDetail.ticketholder.options.country.PG"),enabled:ko.observable(!0)},{key:"PY",name:i18n.t("ticketsDetail.ticketholder.options.country.PY"),enabled:ko.observable(!0)},{key:"PE",name:i18n.t("ticketsDetail.ticketholder.options.country.PE"),enabled:ko.observable(!0)},{key:"PH",name:i18n.t("ticketsDetail.ticketholder.options.country.PH"),enabled:ko.observable(!0)},{key:"PN",name:i18n.t("ticketsDetail.ticketholder.options.country.PN"),enabled:ko.observable(!0)},{key:"PL",name:i18n.t("ticketsDetail.ticketholder.options.country.PL"),enabled:ko.observable(!0)},{key:"PT",name:i18n.t("ticketsDetail.ticketholder.options.country.PT"),enabled:ko.observable(!0)},{key:"PR",name:i18n.t("ticketsDetail.ticketholder.options.country.PR"),enabled:ko.observable(!0)},{key:"QA",name:i18n.t("ticketsDetail.ticketholder.options.country.QA"),enabled:ko.observable(!0)},{key:"RE",name:i18n.t("ticketsDetail.ticketholder.options.country.RE"),enabled:ko.observable(!0)},{key:"RO",name:i18n.t("ticketsDetail.ticketholder.options.country.RO"),enabled:ko.observable(!0)},{key:"RU",name:i18n.t("ticketsDetail.ticketholder.options.country.RU"),enabled:ko.observable(!0)},{key:"RW",name:i18n.t("ticketsDetail.ticketholder.options.country.RW"),enabled:ko.observable(!0)},{key:"SH",name:i18n.t("ticketsDetail.ticketholder.options.country.SH"),enabled:ko.observable(!0)},{key:"KN",name:i18n.t("ticketsDetail.ticketholder.options.country.KN"),enabled:ko.observable(!0)},{key:"LC",name:i18n.t("ticketsDetail.ticketholder.options.country.LC"),enabled:ko.observable(!0)},{key:"PM",name:i18n.t("ticketsDetail.ticketholder.options.country.PM"),enabled:ko.observable(!0)},{key:"VC",name:i18n.t("ticketsDetail.ticketholder.options.country.VC"),enabled:ko.observable(!0)},{key:"WS",name:i18n.t("ticketsDetail.ticketholder.options.country.WS"),enabled:ko.observable(!0)},{key:"SM",name:i18n.t("ticketsDetail.ticketholder.options.country.SM"),enabled:ko.observable(!0)},{key:"ST",name:i18n.t("ticketsDetail.ticketholder.options.country.ST"),enabled:ko.observable(!0)},{key:"SA",name:i18n.t("ticketsDetail.ticketholder.options.country.SA"),enabled:ko.observable(!0)},{key:"SN",name:i18n.t("ticketsDetail.ticketholder.options.country.SN"),enabled:ko.observable(!0)},{key:"RS",name:i18n.t("ticketsDetail.ticketholder.options.country.RS"),enabled:ko.observable(!0)},{key:"SC",name:i18n.t("ticketsDetail.ticketholder.options.country.SC"),enabled:ko.observable(!0)},{key:"SL",name:i18n.t("ticketsDetail.ticketholder.options.country.SL"),enabled:ko.observable(!0)},{key:"SG",name:i18n.t("ticketsDetail.ticketholder.options.country.SG"),enabled:ko.observable(!0)},{key:"SK",name:i18n.t("ticketsDetail.ticketholder.options.country.SK"),enabled:ko.observable(!0)},{key:"SI",name:i18n.t("ticketsDetail.ticketholder.options.country.SI"),enabled:ko.observable(!0)},{key:"SB",name:i18n.t("ticketsDetail.ticketholder.options.country.SB"),enabled:ko.observable(!0)},{key:"SO",name:i18n.t("ticketsDetail.ticketholder.options.country.SO"),enabled:ko.observable(!0)},{key:"ZA",name:i18n.t("ticketsDetail.ticketholder.options.country.ZA"),enabled:ko.observable(!0)},{key:"GS",name:i18n.t("ticketsDetail.ticketholder.options.country.GS"),enabled:ko.observable(!0)},{key:"KR",name:i18n.t("ticketsDetail.ticketholder.options.country.KR"),enabled:ko.observable(!0)},{key:"ES",name:i18n.t("ticketsDetail.ticketholder.options.country.ES"),enabled:ko.observable(!0)},{key:"LK",name:i18n.t("ticketsDetail.ticketholder.options.country.LK"),enabled:ko.observable(!0)},{key:"SD",name:i18n.t("ticketsDetail.ticketholder.options.country.SD"),enabled:ko.observable(!0)},{key:"SR",name:i18n.t("ticketsDetail.ticketholder.options.country.SR"),enabled:ko.observable(!0)},{key:"SJ",name:i18n.t("ticketsDetail.ticketholder.options.country.SJ"),enabled:ko.observable(!0)},{key:"SZ",name:i18n.t("ticketsDetail.ticketholder.options.country.SZ"),enabled:ko.observable(!0)},{key:"SE",name:i18n.t("ticketsDetail.ticketholder.options.country.SE"),enabled:ko.observable(!0)},{key:"SY",name:i18n.t("ticketsDetail.ticketholder.options.country.SY"),enabled:ko.observable(!0)},{key:"TW",name:i18n.t("ticketsDetail.ticketholder.options.country.TW"),enabled:ko.observable(!0)},{key:"TJ",name:i18n.t("ticketsDetail.ticketholder.options.country.TJ"),enabled:ko.observable(!0)},{key:"TZ",name:i18n.t("ticketsDetail.ticketholder.options.country.TZ"),enabled:ko.observable(!0)},{key:"TH",name:i18n.t("ticketsDetail.ticketholder.options.country.TH"),enabled:ko.observable(!0)},{key:"TG",name:i18n.t("ticketsDetail.ticketholder.options.country.TG"),enabled:ko.observable(!0)},{key:"TK",name:i18n.t("ticketsDetail.ticketholder.options.country.TK"),enabled:ko.observable(!0)},{key:"TO",name:i18n.t("ticketsDetail.ticketholder.options.country.TO"),enabled:ko.observable(!0)},{key:"TT",name:i18n.t("ticketsDetail.ticketholder.options.country.TT"),enabled:ko.observable(!0)},{key:"TN",name:i18n.t("ticketsDetail.ticketholder.options.country.TN"),enabled:ko.observable(!0)},{key:"TR",name:i18n.t("ticketsDetail.ticketholder.options.country.TR"),enabled:ko.observable(!0)},{key:"TM",name:i18n.t("ticketsDetail.ticketholder.options.country.TM"),enabled:ko.observable(!0)},{key:"TC",name:i18n.t("ticketsDetail.ticketholder.options.country.TC"),enabled:ko.observable(!0)},{key:"TV",name:i18n.t("ticketsDetail.ticketholder.options.country.TV"),enabled:ko.observable(!0)},{key:"UG",name:i18n.t("ticketsDetail.ticketholder.options.country.UG"),enabled:ko.observable(!0)},{key:"UA",name:i18n.t("ticketsDetail.ticketholder.options.country.UA"),enabled:ko.observable(!0)},{key:"AE",name:i18n.t("ticketsDetail.ticketholder.options.country.AE"),enabled:ko.observable(!0)},{key:"US",name:i18n.t("ticketsDetail.ticketholder.options.country.US"),enabled:ko.observable(!0)},{key:"UM",name:i18n.t("ticketsDetail.ticketholder.options.country.UM"),enabled:ko.observable(!0)},{key:"UY",name:i18n.t("ticketsDetail.ticketholder.options.country.UY"),enabled:ko.observable(!0)},{key:"VI",name:i18n.t("ticketsDetail.ticketholder.options.country.VI"),enabled:ko.observable(!0)},{key:"UZ",name:i18n.t("ticketsDetail.ticketholder.options.country.UZ"),enabled:ko.observable(!0)},{key:"VU",name:i18n.t("ticketsDetail.ticketholder.options.country.VU"),enabled:ko.observable(!0)},{key:"VA",name:i18n.t("ticketsDetail.ticketholder.options.country.VA"),enabled:ko.observable(!0)},{key:"VE",name:i18n.t("ticketsDetail.ticketholder.options.country.VE"),enabled:ko.observable(!0)},{key:"VN",name:i18n.t("ticketsDetail.ticketholder.options.country.VN"),enabled:ko.observable(!0)},{key:"WF",name:i18n.t("ticketsDetail.ticketholder.options.country.WF"),enabled:ko.observable(!0)},{key:"EH",name:i18n.t("ticketsDetail.ticketholder.options.country.EH"),enabled:ko.observable(!0)},{key:"YE",name:i18n.t("ticketsDetail.ticketholder.options.country.YE"),enabled:ko.observable(!0)},{key:"ZM",name:i18n.t("ticketsDetail.ticketholder.options.country.ZM"),enabled:ko.observable(!0)},{key:"ZW",name:i18n.t("ticketsDetail.ticketholder.options.country.ZW"),enabled:ko.observable(!0)}]).sort(function(b,c){return a.compareCountries(b,c)}),c=0;c<this.optionsCountryLowPrio().length;c++)this.optionsCountry.push(this.optionsCountryLowPrio()[c]);a.validateBirthdates=function(){for(c=0;c<a.entries().length;c++){var b=a.entries()[c],d=categoriesVM.getCategory(b.categoryKey()).categoryModel().config().reductionDuedate;if(null==d)return!0;var e=$.datepicker.parseDate(DATE_SERVER_FORMAT,d);if(b.orderItem().consumerKey()==CONSUMER_CHILD){if(null==b.ticketHolder().birthDate())return!1;var f=e;"S1"==b.orderItem().durationKey()?f=moment(f).subtract(16,"year").add(1,"day"):"S3"==b.orderItem().durationKey()&&(f=moment(f).subtract(14,"year").add(1,"day"));if(moment(b.ticketHolder().birthDate()).isBefore(f))return showError(i18n.t("ticketsDetail.messages.dueDateValidationError",{age:"S3"==b.orderItem().durationKey()?13:15,reductionDuedate:moment(e).format("L")})),!1}}return!0}}function AbstractRegistrationViewModel(){var a=this;ko.utils.extend(a,new reportViewModel);var b=Object.freeze({CREATED:"created",ARRIVAL:"arrival",DEPARTURE:"departure"});a.queryBy=ko.observable(b.CREATED),a.todayPrev=ko.observable(),a.searchText=ko.observable(),a.timeRangeSelection=ko.observable("last2Months"),a.busy=ko.observable(!1),a.configOptions={},a.currentUser=ko.observable(),a.billingAddress=headerVM.billingAddress,a.queryByText=b.CREATED,a.customFromDate=ko.observable(),a.customToDate=ko.observable(),a.registrationConfig=new RegistrationConfigModel,a.selectCustomFromDate=function(b,c){var d=c.target.value;if(""!=d)try{var e=$.datepicker.parseDate(DATE_PICKER_FORMAT,d),f=null;a.customToDate()&&(f=$.datepicker.parseDate(DATE_SERVER_FORMAT,a.customToDate())),null!=f&&e>f?a.resetCustomFromDate(c.target):a.customFromDate($.datepicker.formatDate(DATE_SERVER_FORMAT,e))}catch(b){a.resetCustomFromDate(c.target)}else a.customFromDate("")},a.resetCustomFromDate=function(b){var c=$.datepicker.parseDate(DATE_SERVER_FORMAT,a.customFromDate()),d=$.datepicker.formatDate(DATE_PICKER_FORMAT,c);$(b).val(d)},a.selectCustomToDate=function(b,c){var d=c.target.value;if(""!=d)try{var e=$.datepicker.parseDate(DATE_PICKER_FORMAT,d),f=null;a.customFromDate()&&(f=$.datepicker.parseDate(DATE_SERVER_FORMAT,a.customFromDate())),null!=f&&e<f?a.resetCustomToDate(c.target):a.customToDate($.datepicker.formatDate(DATE_SERVER_FORMAT,e))}catch(b){a.resetCustomToDate(c.target)}else a.customToDate("")},a.resetCustomToDate=function(b){var c=$.datepicker.parseDate(DATE_SERVER_FORMAT,a.toDate()),d=$.datepicker.formatDate(DATE_PICKER_FORMAT,c);$(b).val(d)},a.queryCustomRange=function(){a.customFromDate()?a.fromDate(a.customFromDate()):a.fromDate(""),a.customToDate()?a.toDate(a.customToDate()):a.toDate("")},a.selectQueryBy=function(b,c){var d=c.target,e=$(d).find("input").val();a.queryBy(e)},a.getConfigOptions=function(b){if(a.configOptions.hasOwnProperty(b))return a.configOptions[b];a.loadCommonConfiguration(b)},a.setFilterEnableState=function(b){$(".filter-row").find("select").attr("disabled",!b),$(".filter-row").find("label").attr("disabled",!b),$(".filter-panel").find("select").attr("disabled",!b),$(".filter-panel").find("label").attr("disabled",!b),$("#registrationInfoSearchText").attr("disabled",!b),$("#registrationInfoSearchBtn").attr("disabled",!b),a.isReadOnly()?($("#newRegistrationBtn").attr("disabled",!0),$("#importRegistrationBtn").attr("disabled",!0),$("#abacusExportBtn").attr("disabled",!0),$("#genericLinkBtn").attr("disabled",!0)):($("#newRegistrationBtn").attr("disabled",!b),$("#importRegistrationBtn").attr("disabled",!b),$("#genericLinkBtn").attr("disabled",!b))},a.performSearchRegistrations=function(b,c){$(".dateRange").fadeOut(),c&&a.registrationList([]),$.ajax(serviceRootURL+"/registration",{type:"GET",data:b,dataType:"json",contentType:"application/json",beforeSend:function(){a.setFilterEnableState(!1),a.busy(!0)},success:function(b,c,d){console.log("Registrations found: ",b);for(var e=[],f=0;f<b.length;f++){var g=new RegistrationOverviewModel(b[f]);e.push(g)}b.length>0?a.nrOfPages(b[0].maxPageNr):a.nrOfPages(1),a.registrationList(e),$.getScript("assets/js/jungfrau.min.js")},error:function(b,c,d){a.registrationList([]),checkSession(b),console.log("Server error on loading registrations: "+b.responseText),showError("Fehler beim Laden der Registrierungen",b,c,d)},complete:function(b){a.setFilterEnableState(!0),a.busy(!1)}})},a.loadConfiguration=function(){$.ajax(serviceRootURL+"/general_config",{type:"GET",data:{key:"registrationConfig"},dataType:"json",contentType:"application/json",beforeSend:function(){a.setFilterEnableState(!1),a.busy(!0)},success:function(b,c,d){a.registrationConfig.setData(b),console.log("Registration config loaded: ",b,a.registrationConfig)},error:function(b,c,d){a.registrationList([]),a.setFilterEnableState(!0),a.busy(!1),checkSession(b),console.log("Server error on loading configuration: "+b.responseText),showError("Fehler beim Laden der Configs",b,c,d)},complete:function(a){}})},a.timeRangeSelectionListener=ko.computed(function(b,c){if(a.timeRangeSelection()!=a.todayPrev())if("option1"==a.timeRangeSelection())a.todayPrev(a.timeRangeSelection()),a.fromDate($.datepicker.formatDate(DATE_SERVER_FORMAT,new Date)),a.toDate($.datepicker.formatDate(DATE_SERVER_FORMAT,new Date)),$("#startDate").val(""),$("#endDate").val(""),$(".dateRange").fadeOut();else if("option2"==a.timeRangeSelection())a.todayPrev(a.timeRangeSelection()),""==$("#startDate").val()&&a.customFromDate(""),""==$("#endDate").val()&&a.customToDate("");else if("last2Months"==a.timeRangeSelection()){a.todayPrev(a.timeRangeSelection());var d=moment(new Date).subtract(2,"month");a.fromDate($.datepicker.formatDate(DATE_SERVER_FORMAT,d.toDate())),a.toDate($.datepicker.formatDate(DATE_SERVER_FORMAT,new Date)),$("#startDate").val(""),$("#endDate").val(""),$(".dateRange").fadeOut()}}),a.showSupportWindow=function(){$(".support-window").load("assets/support.html",function(){$("#support").modal("show"),ko.applyBindings(null,document.getElementById("support"))})},a.closeSupportWindow=function(){$("#support").modal("hide")}}function RegistrationOverviewViewModel(){var a=this,b=Object.freeze({MANUAL:"manuallyCreated",IMPORTED:"imported",WEBSHOP:"webshop",GENERIC_LINK:"genericLink",DUPLICATE:"duplicate"});a.registrationList=ko.observableArray([]),a.allowedImportFiles=ko.observable(),a.selectedImportFile=ko.observableArray(),a.selectedStatus=ko.observable(),a.selectedSource=ko.observable(),a.selectedServiceProvider=ko.observable(),a.selectedPage=ko.observable(1),a.nrOfPages=ko.observable(1),a.selectedItemsPerPage=ko.observable(20),AbstractRegistrationViewModel.apply(a,[]),a.resetFilters=function(){a.selectedStatus(null),a.selectedSource(null),a.selectedServiceProvider(null),a.selectedPage(1)},a.filterSelected=ko.computed(function(){return null!=a.selectedStatus()||null!=a.selectedSource()||null!=a.selectedServiceProvider()}),a.statusSelectOptions=ko.pureComputed(function(){var b=[REGISTRATION_FORM_STATES_ENUM.REGISTERED_NOT_VERIFIED,REGISTRATION_FORM_STATES_ENUM.REGISTERED_VERIFIED,REGISTRATION_FORM_STATES_ENUM.COMPLETED,REGISTRATION_FORM_STATES_ENUM.CHECKED_IN,REGISTRATION_FORM_STATES_ENUM.CHECKED_OUT,REGISTRATION_FORM_STATES_ENUM.DISCARDED],c=[];return a.selectedStatus(null),b.forEach(function(a){c.push({key:a,label:i18n.t("registration.details.states."+a)})}),c}),a.sourceSelectOptions=ko.pureComputed(function(){var a=[b.MANUAL,b.IMPORTED,b.WEBSHOP,b.GENERIC_LINK],c=[];return a.forEach(function(a){c.push({key:a,label:i18n.t("registration.details.sources."+a)})}),c}),a.paginationChangeTrigger=function(){a.searchRegistrations()},a.searchRegistrations=function(){$("#registrationSearchForm").find("div").removeClass("has-error"),$("#registrationInfoSearchText").prop("title","");var b={fromDate:a.fromDate(),toDate:a.toDate(),searchText:a.searchText(),queryBy:a.queryBy(),pageNr:a.selectedPage(),pageLimit:a.selectedItemsPerPage(),source:a.selectedSource(),registrationStatus:a.selectedStatus(),serviceProvider:a.selectedServiceProvider()};a.performSearchRegistrations(b,!1)},a.getFormatedDate=function(a){return null!=a?moment(a).format("L"):""},a.sendQuickcheckinMail=function(b){console.log("sendQuickcheckinMail",b);var c=serviceRootURL+"/registration/quickcheckin/"+b.hash();$.ajax({url:c,type:"GET",data:null,beforeSend:function(){$(".quickcheckin-btn").attr("disabled",!0),a.setFilterEnableState(!1),a.busy(!0)},success:function(a,c,d){console.log("quickCheckin successful",a),b.manualQuickCheckinStatus(1),b.loadHistoryAndExtractDates()},error:function(a,c,d){showError("Fehler beim senden der Mail für Quickcheckin",a,c,d),b.manualQuickCheckinStatus(0)},complete:function(){a.setFilterEnableState(!0),a.busy(!1),$(".quickcheckin-btn").blur(),$(".quickcheckin-btn").attr("disabled",!1)}})};a.allowedImportFiles(".csv");a.selectedImportFile.subscribe(function(a){if(console.log("value changed",a),a.length>0){var b=new FormData;b.append("file",a[0]),c(b)}}),a.getExportMsg=function(){var b=i18n.t("registration.export.exportSuccessful",{fromDate:a.fromDate(),toDate:a.toDate()});if(a.selectedServiceProvider()){var c=headerVM.assignedServiceProviderList().find(function(b){return b.serviceProviderExternalId===a.selectedServiceProvider()});b=i18n.t("registration.export.exportSuccessfulWithSP",{fromDate:a.fromDate(),toDate:a.toDate(),serviceProvider:c.name})}return b},a.performAbacusExportData=function(b){var c=a.fromDate(),d=a.toDate(),e={fromDate:c,toDate:d,serviceProvider:a.selectedServiceProvider(),queryBy:a.queryBy(),force:b};a.busy(!0),$.ajax({url:serviceRootURL+"/abacus_export",type:"PUT",data:JSON.stringify(e),dataType:"json",contentType:"application/json",success:function(b,c,d){a.busy(!1),console.log("Export successful",b),showInfo(a.getExportMsg(),function(){a.searchRegistrations()})},error:function(b,c,d){a.busy(!1),showError("Error",b,c,d)}})},a.exportAbacusBtnDisabled=ko.computed(function(){return 0==a.registrationList().length||a.busy()||"option2"==a.timeRangeSelection()&&!a.customFromDate()&&!a.customToDate()}),a.abacusExportData=function(){var b=null;if(a.selectedServiceProvider()){var c="";headerVM.assignedServiceProviderList().forEach(function(b){b.serviceProviderExternalId==a.selectedServiceProvider()&&(c=b.name)}),b=i18n.t("registration.abacus.messageWithSp",{fromDate:formatDate(a.fromDate()),toDate:formatDate(a.toDate()),serviceProvider:c})}else b=i18n.t("registration.abacus.messageWithoutSp",{fromDate:formatDate(a.fromDate()),toDate:formatDate(a.toDate())});bootbox.prompt({title:i18n.t("registration.abacus.abacusExportTitle"),message:b,inputType:"radio",size:"small",inputOptions:[{text:i18n.t("registration.abacus.abacusExportOnlyNew"),value:"1"},{text:i18n.t("registration.abacus.abacusExportAll"),value:"2"}],callback:function(b){null!=b&&a.performAbacusExportData(2==b)}})},a.importPersonData=function(){$("#importPersonData").click()},a.createGenericLink=function(){$("#genericLinkDialog").modal("show")};var c=function(b){a.busy(!0),console.log("Uploading",b),$.ajax(serviceRootURL+"/registration/import",{type:"POST",data:b,processData:!1,contentType:!1,success:function(b,c,d){
if(console.log("Upload finished",b),a.busy(!1),a.selectedImportFile([]),$("#importPersonData")[0].value=null,0==b.success){for(var e="\n",f=0;f<b.failedMessages.length;f++)e+=b.failedMessages[f]+"\n";showWarning(0==b.successMessages.length?i18n.t("registration.import.failedToImportAnyRegistrations",{message:e}):i18n.t("registration.import.failedToImportSomeRegistrations",{message:e}))}else showInfo(i18n.t("registration.import.importSuccessful",{nrOfImportedRegistrations:b.successMessages.length})),$(".bootbox-confirm").find("div.modal-dialog").addClass("popup-confirm-box");a.searchRegistrations()},error:function(b,c,d){showError("Fehler beim hochladen der files",b,c,d),console.log("File upload failed: ",d),a.selectedImportFile([]),a.busy(!1)}})};a.confirmClone=function(a){showQuestionYesNo(i18n.t("registration.details.cloneRegistrationQuestion")+": "+a.resellerNumber()+"?",function(b){1==b&&showRegistrationDetails(a.hash(),!0)}),$(".bootbox-confirm").find("div.modal-dialog").addClass("popup-confirm-box")},a.showNewRegistrationDialog=function(){showRegistrationDetails()},a.openRegistration=function(a,b){console.log("openRegistration",a,b,b.target),-1==b.target.className.indexOf("glyphicon glyphicon-duplicate")&&-1==b.target.className.indexOf("quickcheckin-icon")&&-1==b.target.className.indexOf("quickcheckin-text")&&-1==b.target.className.indexOf("quickcheckin-btn")&&(location.hash="#registration_detail/"+a.hash())},a.getCssForRegistrationState=function(a){if(registrationVM&&registrationVM.registrationConfig.registrationOverviewColored()){if(a===REGISTRATION_FORM_STATES_ENUM.REGISTERED_VERIFIED||a===REGISTRATION_FORM_STATES_ENUM.REGISTERED_NOT_VERIFIED)return"state-display orange-background color-white";if(a===REGISTRATION_FORM_STATES_ENUM.COMPLETED||a===REGISTRATION_FORM_STATES_ENUM.CHECKED_IN||a===REGISTRATION_FORM_STATES_ENUM.CHECKED_OUT)return"state-display green-background color-white";if(a===REGISTRATION_FORM_STATES_ENUM.DISCARDED)return"state-display red-background color-white"}return"state-display"},a.isReadOnly=ko.computed(function(){return menuVM.hasRegistrationReadOnlyRights()}),a.reloadListener=ko.computed(function(){0!=a.registrationConfig.initialized()&&a.searchRegistrations()}).extend({throttle:50}),a.loadConfiguration()}function closeModelListener(a){27==a.keyCode&&null!=registrationDetailVM&&registrationDetailVM.cancelRegistration()}function showRegistrationOverview(a){cleanContainer(),$("#container").load("assets/registration.html",function(){null==registrationVM?(registrationVM=new RegistrationOverviewViewModel(void 0==a),document.addEventListener("keydown",closeModelListener),registrationVM.setFilterEnableState(!1)):registrationVM.setFilterEnableState(!0),ko.applyBindings(registrationVM,document.getElementById("registrationOverview")),a&&a()})}function coalesce(a,b){return void 0===a||null===a||""===a?b:a}function showRegistrationDetails(a,b){if(null==registrationVM){showRegistrationOverview(function(){showRegistrationDetails(a)})}else $("#modal-content-part").load("assets/registration-details.html",function(){registrationDetailVM=new RegistrationDetailedViewModel(a,b,registrationVM.registrationConfig),ko.cleanNode($("#modal-content-part")[0]),ko.applyBindings(registrationDetailVM,document.getElementById("modal-content-part")),$("#registrationDetails").modal("show"),$("#registrationForm").parsley(),$("#registrationDetails").on("hide.bs.modal",function(a){if(null!=registrationDetailVM)if(registrationDetailVM.closeDialog()){$("body").removeClass("modal-open"),$(".modal-backdrop").remove(),location.hash="#registration";var b=registrationDetailVM.registration().dataChanged();(b||registrationDetailVM.registration().saved())&&registrationVM.searchRegistrations(),registrationDetailVM=null}else a.preventDefault()})})}function PackageAbstractViewModel(){var a=this;a.isCustomer=menuVM.hasPackageCustomerRights,a.isSeller=menuVM.hasPackageSellerRights,ko.utils.extend(a,new reportViewModel);var b=Object.freeze({CREATED:"created",ARRIVAL:"arrival",DEPARTURE:"departure"});a.queryBy=ko.observable(b.CREATED),a.todayPrev=ko.observable(),a.searchText=ko.observable(),a.timeRangeSelection=ko.observable("last2Months"),a.busy=ko.observable(!1),a.customFromDate=ko.observable(),a.customToDate=ko.observable(),a.createPackage=function(b,c,d,e){console.log("Calling createPackage with",b);var f=serviceRootURL+"/packages";e&&(f=f+"?clone="+e),$.ajax({url:f,type:"POST",data:JSON.stringify(b),dataType:"json",contentType:"application/json",success:function(a,b,d){console.log("created the package",a),c&&"function"==typeof c&&c(a)},error:function(b,c,e){showError("Fehler beim Erstellen des Package",b,c,e),a.showLoadingSpinner(!1),d&&"function"==typeof d&&d()}})},a.selectCustomFromDate=function(b,c){var d=c.target.value;if(""!=d)try{var e=$.datepicker.parseDate(DATE_PICKER_FORMAT,d),f=null;a.customToDate()&&(f=$.datepicker.parseDate(DATE_SERVER_FORMAT,a.customToDate())),null!=f&&e>f?a.resetCustomFromDate(c.target):a.customFromDate($.datepicker.formatDate(DATE_SERVER_FORMAT,e))}catch(b){a.resetCustomFromDate(c.target)}else a.customFromDate("")},a.resetCustomFromDate=function(b){var c=$.datepicker.parseDate(DATE_SERVER_FORMAT,a.customFromDate()),d=$.datepicker.formatDate(DATE_PICKER_FORMAT,c);$(b).val(d)},a.selectCustomToDate=function(b,c){var d=c.target.value;if(""!=d)try{var e=$.datepicker.parseDate(DATE_PICKER_FORMAT,d),f=null;a.customFromDate()&&(f=$.datepicker.parseDate(DATE_SERVER_FORMAT,a.customFromDate())),null!=f&&e<f?a.resetCustomToDate(c.target):a.customToDate($.datepicker.formatDate(DATE_SERVER_FORMAT,e))}catch(b){a.resetCustomToDate(c.target)}else a.customToDate("")},a.resetCustomToDate=function(b){var c=$.datepicker.parseDate(DATE_SERVER_FORMAT,a.toDate()),d=$.datepicker.formatDate(DATE_PICKER_FORMAT,c);$(b).val(d)},a.queryCustomRange=function(){a.customFromDate()?a.fromDate(a.customFromDate()):a.fromDate(""),a.customToDate()?a.toDate(a.customToDate()):a.toDate("")},a.selectQueryBy=function(b,c){var d=c.target,e=$(d).find("input").val();a.queryBy(e)}}function PackageReservationDialogViewModel(a,b){var c=this;c.parentView=a,c.groupViewModel=ko.observable(b),c.closeDialog=ko.observable(!1),c.showLoadingSpinner=ko.observable(!1),c.selectedRegion=ko.observable(),c.selectedCity=ko.observable(),c.regionList=ko.observableArray(),c.regionFilterList=ko.observableArray(),c.confirmedServiceproviders=ko.observableArray(),c.cityList=ko.observableArray(),c.fromDate=ko.observable(b.date()),c.toDate=ko.observable(),c.newRequestDone=ko.observable(!1),c.orderId=ko.observable(b.firstItem().orderId()),console.log("PackageReservationDialogViewModel",b),c.removeConfirmedServiceprovider=function(a,b){c.confirmedServiceproviders.remove(a)},c.resetFilters=function(){var a=!1,b=null;c.regionList().forEach(function(c){null==b&&(b=c.name()),b!=c.name()&&(a=!0)}),a&&c.selectedRegion(void 0),c.cityList().length>1&&c.selectedCity(void 0)},c.selectedRegion.subscribe(function(a){c.cityList([]),c.regionList().forEach(function(b){if(void 0===a||b.key()===a){null==ko.utils.arrayFirst(c.cityList(),function(a){return a.key===b.cityKey})&&c.cityList.push({key:b.cityKey(),name:b.cityName()})}}),1===c.cityList().length&&(c.selectedCity(c.cityList()[0].key),console.log("Setting city",c.cityList()[0]))});var d=function(a,b){b.slideToggle(),a.toggleClass("expand deflate")};c.toggleExpand=function(a,b){var c=$(b.target);if(c.hasClass("no-expand-on-click"))return!0;var e=c.parents(".row-container"),f=e.find(".toggle-icon");d(f,e.find(".reservation-detail"))},c.toggleExpandAll=function(a,b){var c=$(b.target).parents(".table-container").find(".toggle-icon-main");c.toggleClass("expand deflate");var e=c.hasClass("expand");$(b.target).parents(".table-container").find(".row-container").each(function(a){var b=$(this).find(".toggle-icon");b.hasClass("expand")!=e&&d(b,$(this).find(".reservation-detail"))})};var e=function(a,b,d,e){var f=ko.utils.arrayFirst(c.regionList(),function(b){return b.key()==a&&b.cityKey()==d});if(null==f){f=new PackageRequestRegionCityModel(a,b,d,e,c.selectedCity),c.regionList.push(f);null==ko.utils.arrayFirst(c.regionFilterList(),function(b){return b.key==a})&&c.regionFilterList.push({key:a,name:b})}return f},f=function(){c.showLoadingSpinner(!0),c.regionList([]),c.cityList([]),$.getJSON(serviceRootURL+"/options",{categoryKey:b.categoryKey(),optionListKey:"regions",parentOptionListKey:"",parentOptionKey:"",recursive:!1}).done(function(a){a&&(a.forEach(function(a){Object.keys(a.additionalInfo.cities).forEach(function(b){a.additionalInfo.cities[b].forEach(function(c){-1==c.key.indexOf(".TEMPLATE")&&e(a.localizedValue.toLowerCase(),a.localizedValue,b,c.cityName).serviceproviders.push(new PackageRequestServiceproviderModel(c.id,c.key,c.name,b,c.cityName,a.localizedValue))})}),c.selectedRegion(b.firstItem().regionName().toLowerCase()),c.selectedCity(b.firstItem().cityName().toLowerCase())}),c.getReservationRequests())}).fail(function(a,b,d){checkSession(a),showError("Fehler beim Laden der Restaurants",a,b,d),c.showLoadingSpinner(!1)})};c.loadServiceprovider=function(){b.categoryKey()===CATEGORY_KEY_RESTAURANT&&f()},c.getCategoryNameAndCount=function(a){if(b.categoryKey()===CATEGORY_KEY_RESTAURANT){var c=a.length;return 1===c?c+" "+i18n.t("packages.reservationDialog.restaurant"):c+" "+i18n.t("packages.reservationDialog.restaurants")}return"Category unknown"};var g=function(a){return{productId:a.productId(),reservationStatus:a.reservationStatus(),reservationRequestHash:a.reservationRequestHash(),details:a.details()}},h=function(){for(var a=0;a<c.confirmedServiceproviders().length;a++)if(c.confirmedServiceproviders()[a].confirmedSelected())return[g(c.confirmedServiceproviders()[a])]};c.selectServiceprovider=function(a,b){c.confirmedServiceproviders().forEach(function(b){a.key()===b.key()?b.confirmedSelected(!b.confirmedSelected()):b.confirmedSelected(!1),console.log("selectServiceprovider",a,b.confirmedSelected())})},c.cancelReservationDialog=function(){c.closeDialog(!0),$("#packageReservationDialog").modal("hide"),c.newRequestDone()&&(a.order().id()==c.orderId()&&a.loadOrder(),a.additionalOrder()&&a.additionalOrder().id()==c.orderId()&&a.loadAdditionalOrder())};var i=function(){var a=[];return b.items().forEach(function(c){c.categoryKey()===b.categoryKey()&&a.push(c.id())}),a};c.reserveServiceprovider=function(){var d={packageId:a.package().id(),orderId:c.orderId(),fromDate:c.fromDate(),toDate:c.toDate(),requestType:"performReservation",orderItemIds:i(),serviceproviders:h(),categoryKey:b.categoryKey(),subservices:c.subservices()};c.showLoadingSpinner(!0),console.log("reserveServiceprovider",d),$.ajax(serviceRootURL+"/serviceprovider/reserve",{type:"POST",data:JSON.stringify(d),dataType:"json",contentType:"application/json",success:function(a,b,d){c.newRequestDone(!0),c.showLoadingSpinner(!1),c.cancelReservationDialog()},error:function(a,b,d){showError("Fehler beim Reservieren der Serviceprovider",a,b,d),c.showLoadingSpinner(!1)}})},c.getReservationRequests=function(){c.showLoadingSpinner(!0),c.confirmedServiceproviders([]),c.regionList().forEach(function(a){a.serviceproviders().forEach(function(a){a.isSelected(!1),a.reservationStatus(null),a.reservationRequestHash(null),a.details(null)})}),$.ajax(serviceRootURL+"/serviceprovider/reservation_request",{type:"GET",data:{packageId:a.package().id(),orderId:c.orderId(),fromDate:c.fromDate(),toDate:c.toDate(),categoryKey:b.categoryKey()},dataType:"json",contentType:"application/json",success:function(a,b,d){console.log("Reservation request loaded",a),null!=a&&c.regionList().forEach(function(b){b.serviceproviders().forEach(function(b){a.serviceproviders.forEach(function(a){if(a.productId==b.productId()&&(b.reservationRequestHash(a.reservationRequestHash),b.reservationStatus(a.reservationStatus),b.details(a.details),b.reservationStatus()===RESERVATION_STATES.CONFIRMED||b.reservationStatus()===RESERVATION_STATES.RESERVED||b.reservationStatus()===RESERVATION_STATES.RESERVATION_STATE_LT_CONFIRMED)){ko.utils.arrayFirst(c.confirmedServiceproviders(),function(a){return b.productId()===a.productId()})||c.confirmedServiceproviders.push(b)}})})}),c.showLoadingSpinner(!1)},error:function(a,b,d){showError("Fehler beim Laden Reservierungsanfragen",a,b,d),c.showLoadingSpinner(!1)}})};var j=function(){var a=null;return b.items().forEach(function(c){c.categoryKey()===b.categoryKey()&&(a=c.startTime())}),a};c.requestReservation=function(){var d={packageId:a.package().id(),orderId:c.orderId(),fromDate:c.fromDate(),toDate:c.toDate(),startTime:j(),requestType:"requestReservation",orderItemIds:i(),serviceproviders:k(),categoryKey:b.categoryKey(),subservices:c.subservices()};c.showLoadingSpinner(!0),console.log("requestReservation",d),$.ajax(serviceRootURL+"/serviceprovider/reservation_request",{type:"POST",data:JSON.stringify(d),dataType:"json",contentType:"application/json",success:function(a,b,d){c.newRequestDone(!0),c.getReservationRequests()},error:function(a,b,d){showError("Fehler beim Reservieren der Hotels",a,b,d),c.showLoadingSpinner(!1)}})};var k=function(){var a=[];return c.regionList().forEach(function(b){b.serviceproviders().forEach(function(b){b.isSelected()&&a.push(g(b))})}),a};c.subservices=ko.computed(function(){var a=[];return c.groupViewModel()&&ko.utils.arrayForEach(c.groupViewModel().subgroups(),function(b){b.groupItem().categoryKey()===CATEGORY_KEY_SUBSERVICE&&b.groupItem().type()===ORDER_ITEM_TYPE_PACKAGE_SUBSERVICE&&a.push(b.groupItem().id())}),a}),c.dialogTitle=ko.computed(function(){return c.groupViewModel()?c.groupViewModel().toDate()?c.groupViewModel().categoryName()+" "+i18n.t("packages.reservationDialog.reservation")+" "+c.groupViewModel().date()+" - "+c.groupViewModel().toDate():c.groupViewModel().categoryName()+" "+i18n.t("packages.reservationDialog.reservation")+" "+c.groupViewModel().date():i18n.t("packages.reservationDialog.reserverationDialogTitle")}),c.filterSelected=ko.computed(function(){return!(!c.selectedRegion()&&!c.selectedCity())}),c.filteredRegions=ko.computed(function(){return ko.utils.arrayFilter(c.regionList(),function(a){return(!c.selectedRegion()||c.selectedRegion()===a.key())&&(!c.selectedCity()||c.selectedCity()===a.cityKey())})}),c.allowRequestReservation=ko.computed(function(){return!c.showLoadingSpinner()&&k().length>0}),c.allowReservation=ko.computed(function(){if(c.showLoadingSpinner())return!1;for(var a=0;a<c.confirmedServiceproviders().length;a++)if(c.confirmedServiceproviders()[a].confirmedSelected()&&c.confirmedServiceproviders()[a].reservationStatus()!==RESERVATION_STATES.RESERVED&&c.confirmedServiceproviders()[a].reservationStatus()!==RESERVATION_STATES.RESERVATION_STATE_LT_CONFIRMED)return!0;return!1}),c.loadServiceprovider()}function PackageHotelReservationViewModel(a,b){var c=this;c.parentView=a,c.orderItemList=b,c.closeDialog=ko.observable(),c.showLoadingSpinner=ko.observable(!1),c.regionFilterList=ko.observableArray(),c.selectedRegion=ko.observable(),c.cityFilterList=ko.observableArray(),c.selectedCity=ko.observable(),c.accommodationFilterList=ko.observableArray(),c.selectedAccommodation=ko.observable(),c.capacityFilterList=ko.observableArray(),c.selectedCapacity=ko.observable(),c.samePriceCbSelected=ko.observable(!0),c.correctedSinglePrice=ko.observable(),c.correctedDoublePrice=ko.observable(),c.correctedTriplePrice=ko.observable(),c.requiredSingleRooms=ko.observable(0),c.requiredDoubleRooms=ko.observable(0),c.requiredTripleRooms=ko.observable(0),c.hotelDistributionModel=ko.observable(),c.regionList=ko.observableArray(),c.fromDate=ko.observable(),c.toDate=ko.observable(),c.selectAllSelected=ko.observable(!1),c.accommRateTypeKey=ko.observable(),c.selectedFreeRoom=ko.observable(),c.orderId=ko.observable(b[0].orderId());!function(){b&&b.forEach(function(a){a.categoryKey()===CATEGORY_KEY_HOTEL&&(c.fromDate(a.date()),c.toDate(a.toDate()))})}();console.log("PackageHotelReservationViewModel",c,b),c.confirmedSingleRooms=ko.computed(function(){var a=0;return c.regionList().forEach(function(b){b.accommodationList().forEach(function(b){b.confirmedSingleRoomCnt()&&(b.isConfirmed()||b.isReserved())&&(a+=b.confirmedSingleRoomCnt())})}),a}),c.confirmedDoubleRooms=ko.computed(function(){var a=0;return c.regionList().forEach(function(b){b.accommodationList().forEach(function(b){b.confirmedDoubleRoomCnt()&&(b.isConfirmed()||b.isReserved())&&(a+=b.confirmedDoubleRoomCnt())})}),a}),c.confirmedThreeRooms=ko.computed(function(){var a=0;return c.regionList().forEach(function(b){b.accommodationList().forEach(function(b){b.confirmedThreeRoomCnt()&&(b.isConfirmed()||b.isReserved())&&(a+=b.confirmedThreeRoomCnt())})}),a}),c.selectedAccommodationList=ko.computed(function(){var a=[];return c.regionList().forEach(function(b){b.accommodationList().forEach(function(b){(b.selectedSingleRoomCnt()>0||b.selectedDoubleRoomCnt()>0)&&a.push(b)})}),a}),c.confirmedAccommodationList=ko.computed(function(){var a=[];return c.regionList().forEach(function(b){b.accommodationList().forEach(function(b){(b.isConfirmed()||b.isReserved())&&a.push(b)})}),a}),c.allowRequestReservation=ko.computed(function(){if(c.showLoadingSpinner())return!1;var a=!1;return c.regionList().forEach(function(b){b.accommodationList().forEach(function(b){b.isSelected()&&(a=!0)})}),a}),c.allowReservation=ko.computed(function(){if(c.requiredSingleRooms()!=c.confirmedSingleRooms())return!1;if(c.requiredDoubleRooms()!=c.confirmedDoubleRooms())return!1;if(c.requiredTripleRooms()!=c.confirmedThreeRooms())return!1;if(c.showLoadingSpinner())return!1;if("GRP"==c.accommRateTypeKey()&&c.requiredSingleRooms()+2*c.requiredDoubleRooms()+3*c.requiredTripleRooms()>=10){var a=!1;if(c.regionList().forEach(function(b){b.accommodationList().forEach(function(b){(b.isConfirmed()||b.isReserved())&&(b.freeRoomAssigned(c.selectedFreeRoom()==b.accommodationName()),b.freeRoomAssigned()&&b.confirmedSingleRoomCnt()>0&&(a=!0))})}),!a)return!1}return!0}),c.filterSelected=ko.computed(function(){return!!(c.selectedRegion()||c.selectedCity()||c.selectedCapacity()||c.selectedAccommodation())}),c.resetFilters=function(){c.regionFilterList().length>1&&c.selectedRegion(void 0),c.cityFilterList().length>1&&c.selectedCity(void 0),c.selectedCapacity(void 0),c.accommodationFilterList().length>1&&c.selectedAccommodation(void 0)},c.filteredRegions=ko.computed(function(){return c.selectedRegion()||c.selectedCity()?ko.utils.arrayFilter(c.regionList(),function(a){return(!c.selectedRegion()||c.selectedRegion()===a.regionId())&&((!c.selectedCity()||c.selectedCity()===a.cityName())&&0!=a.filteredAccommodationList().length)}):c.regionList()}),c.cancelHotelReservation=function(){c.closeDialog(!0),$("#packageHotelReservation").modal("hide")},c.reloadDisabled=ko.computed(function(){return!a.order()||!a.order().id()||!!c.showLoadingSpinner()});var d=function(a){for(var b=0;b<a.length;b++)if(c.orderItemList[b].categoryKey()==CATEGORY_KEY_HOTEL)return c.orderItemList[b].roomCategoryName()},e=function(){var a=null;return c.orderItemList.forEach(function(b){b.categoryKey()===CATEGORY_KEY_HOTEL&&(a=b.startTime())}),a};c.requestReservation=function(){if(c.hotelDistributionModel()){console.log("requestReservation",a,c.orderItemList);var b={packageId:a.package().id(),orderId:c.orderId(),fromDate:c.fromDate(),toDate:c.toDate(),startTime:e(),roomCategory:d(c.orderItemList),accommodationList:c.hotelDistributionModel().getSelectedHotels(),orderItemIds:c.hotelDistributionModel().getConfirmedHotels().orderItemIds};c.showLoadingSpinner(!0),console.log("requestReservation",b),$.ajax(serviceRootURL+"/hotels/reservation_request",{type:"POST",data:JSON.stringify(b),dataType:"json",contentType:"application/json",success:function(b,d,e){c.getReservationRequests(),a.order().id()==c.orderId()&&a.loadOrder(),a.additionalOrder()&&a.additionalOrder().id()==c.orderId()&&a.loadAdditionalOrder()},error:function(a,b,d){showError("Fehler beim Reservieren der Hotels",a,b,d),c.showLoadingSpinner(!1)}})}};var f=function(a){var b=null;return c.regionList().forEach(function(c){c.accommodationList().forEach(function(c){c.accommExtId()==a&&(b=c)})}),b};c.getReservationRequests=function(){c.showLoadingSpinner(!0),$.ajax(serviceRootURL+"/hotels/reservation_request",{type:"GET",data:{packageId:a.package().id(),orderId:c.orderId(),fromDate:c.fromDate(),toDate:c.toDate()},dataType:"json",contentType:"application/json",success:function(a,b,d){console.log("Reservation request loaded",a),null!=a&&(c.regionList().forEach(function(a){a.accommodationList().forEach(function(a){a.isSelected(!1),a.reservationStatus(null),a.isConfirmed(!1),a.isReserved(!1),a.isRejected(!1),a.requestError(!1),a.updateConfirmedAndReservedRooms(0,0,0,0,0,0)})}),a.accommodationList.forEach(function(a){var b=f(a.accommExtId);null!=b&&(b.isSelected(!1),b.reservationStatus(a.reservationStatus),b.isConfirmed(b.reservationStatus()==RESERVATION_STATES.CONFIRMED||b.reservationStatus()==RESERVATION_STATES.RESERVATION_STATE_LT_CONFIRMED),b.isReserved(b.reservationStatus()==RESERVATION_STATES.RESERVED||b.reservationStatus()==RESERVATION_STATES.RESERVATION_STATE_LT_CONFIRMED),b.isRejected(b.reservationStatus()==RESERVATION_STATES.REJECTED),b.requestError(b.reservationStatus()==RESERVATION_STATES.MAIL_FAILURE),b.reservationRequestHash(a.reservationRequestHash),b.updateConfirmedAndReservedRooms(a.roomsConfirmed.singleRoomCnt,a.roomsConfirmed.doubleRoomCnt,a.roomsConfirmed.threeRoomCnt,a.roomsReserved.singleRoomCnt,a.roomsReserved.doubleRoomCnt,a.roomsReserved.threeRoomCnt))})),c.showLoadingSpinner(!1)},error:function(a,b,d){showError("Fehler beim Laden Reservierungsanfragen der Hotels",a,b,d),c.showLoadingSpinner(!1)}})},c.reloadHotelAvailability=function(){if(c.regionList([]),c.orderId()){var a="",b=null,d=null,e=null,f=null,g=null,i=null,j=null,k=null;c.requiredSingleRooms(0),c.requiredDoubleRooms(0),c.requiredTripleRooms(0);for(var l=0;l<c.orderItemList.length;l++){a+=c.orderItemList[l].id()+",";var m=c.orderItemList[l];m.categoryKey()==CATEGORY_KEY_HOTEL&&(b=m.date(),d=m.toDate(),e=m.regionKey(),f=m.regionName(),g=m.roomCategoryId(),i=m.roomCategoryName(),j=m.accommCityName(),k=m.accommCityId(),"pkgsubgrp"==m.type()&&(1==m.occupancy()&&c.requiredSingleRooms(c.requiredSingleRooms()+m.quantity()),2==m.occupancy()&&c.requiredDoubleRooms(c.requiredDoubleRooms()+m.quantity()),3==m.occupancy()&&c.requiredTripleRooms(c.requiredTripleRooms()+m.quantity()),"GRP"==m.accommRateTypeKey()&&c.accommRateTypeKey("GRP"),"FIT"==m.accommRateTypeKey()&&c.accommRateTypeKey("FIT")))}c.showLoadingSpinner(!0),$.ajax(serviceRootURL+"/hotels",{type:"GET",data:{categoryKey:CATEGORY_KEY_HOTEL,regionId:e,roomCatId:g,fromDateString:b,toDateString:d,packageMode:!0},dataType:"json",contentType:"application/json",context:{selectedRegionId:e,selectedRegionName:f,selectedRoomCategoryId:g,selectedRoomCategoryName:i,selectedArrivalDate:b,selectedDepartureDate:d},dataType:"json",contentType:"application/json",success:function(a,b,d){var g=[];null!=a&&null!=a.data&&null!=a.data.items&&a.data.items.length>0&&(g=a.data.items.filter(function(a){return!menuVM.dummyHotels().includes(a.sku)})),console.log("Hotels received / filtered",a,g);var i=c.parseHotelsPerCity(g);h(e,f,k,j,i),c.getReservationRequests()},error:function(a,b,d){showError("Fehler beim Laden der Hotels",a,b,d),c.showLoadingSpinner(!1)}})}},c.parseHotelsPerCity=function(a){var b=[];if(null!=a&&a.length>0){for(var c=[],d=0;d<a.length;d++){var e=a[d];if(null==c[e.place]){var f={id:d,name:e.place,accommodations:[]};c[e.place]=f}c[e.place].accommodations.push(e)}var g=this;Object.keys(c).forEach(function(a){var d=c[a],a=new hotelCityOptionModel(d,g);b.push(a)})}return b},c.reserveHotels=function(){c.showLoadingSpinner(!0);var b=c.hotelDistributionModel().getConfirmedHotels();console.log("reserveHotels ",b),$.ajax({url:serviceRootURL+"/packages/hotels",type:"POST",data:JSON.stringify(b),dataType:"json",contentType:"application/json",success:function(b,d,e){console.log("Hotels reserved",b),c.showLoadingSpinner(!1),c.closeDialog(!0),$("#packageHotelReservation").modal("hide"),a.order().id()==c.orderId()&&a.loadOrder(),a.additionalOrder()&&a.additionalOrder().id()==c.orderId()&&a.loadAdditionalOrder()},error:function(b,d,e){showError("Fehler beim Reservieren der Hotels",b,d,e),c.showLoadingSpinner(!1),c.closeDialog(!0),$("#packageHotelReservation").modal("hide"),a.order().id()==c.orderId()&&a.loadOrder(),a.additionalOrder()&&a.additionalOrder().id()==c.orderId()&&a.loadAdditionalOrder()}})},c.dataChanged=function(){return!1},c.selectAllAccommodations=ko.computed(function(){c.filteredRegions().forEach(function(a){a.filteredAccommodationList().forEach(function(a){a.isSelected(c.selectAllSelected())})})}),c.toggleExpand=function(a,b){var c=$(b.target);if(c.hasClass("no-expand-on-click"))return!0;var d=c.parents(".row-container"),e=d.find(".toggle-icon");g(e,d.find(".hotel-detail-content"))},c.toggleExpandAll=function(a,b){var c=$(b.target).parents(".table-container").find(".toggle-icon-main");c.toggleClass("expand deflate");var d=c.hasClass("expand");$(b.target).parents(".table-container").find(".row-container").each(function(a){var b=$(this).find(".toggle-icon");b.hasClass("expand")!=d&&g(b,$(this).find(".hotel-detail-content"))})};var g=function(a,b){b.slideToggle(),a.toggleClass("expand deflate")},h=function(a,b,d,e,f){c.cityFilterList([]),c.accommodationFilterList([]),c.regionFilterList([{display:b,value:a}]),c.selectedRegion(c.regionFilterList()[0].value);var g={selectedAccommodation:c.selectedAccommodation,selectedCapacity:c.selectedCapacity,requiredSingleRooms:c.requiredSingleRooms,requiredDoubleRooms:c.requiredDoubleRooms,requiredTripleRooms:c.requiredTripleRooms,orderItemList:c.orderItemList,samePriceSelected:c.samePriceCbSelected,packageId:c.parentView.package().id()};f.forEach(function(a){c.cityFilterList.push({display:a.value,value:a.value})}),c.selectedCity(e),c.hotelDistributionModel(new HotelDistribution(a,b,f,g)),c.regionList(c.hotelDistributionModel().regionList())};c.reloadHotelAvailability()}function PackageCreateViewModel(a){var b=this;b.parentView=a,b.closeDialog=ko.observable(),b.newPackage=ko.observable(new Package),b.showLoadingSpinner=ko.observable(!1),b.initialComment=ko.observable(),b.assignedCustomer=ko.observable(),b.customerSelectOptions=ko.observableArray(),PackageAbstractViewModel.apply(b,[]);var c=function(){b.closeDialog(!0),$("#packageCreate").modal("hide")};b.dataChanged=function(){return!!b.newPackage().title()||(!!b.newPackage().plannedArrivalDate()||(!!b.newPackage().plannedDepartureDate()||(b.newPackage().descriptionFileList().length>0||(b.newPackage().attachmentFileList().length>0||!(!b.isSeller()||void 0===b.assignedCustomer())))))};var d=function(a){var c;b.newPackage().descriptionFileList().forEach(function(a){!a.isUploaded()&&a.size>0&&(c=new FormData,c.append("type","package-description-attachment"),c.append("file",a))});for(var d,f=0;f<b.newPackage().attachmentFileList().length;){var g=b.newPackage().attachmentFileList()[f];!g.isUploaded()&&g.size>0&&(void 0===d&&(d=new FormData,d.append("type","package-file-attachment")),d.append("file",g)),0==g.size?b.newPackage().attachmentFileList().splice(f,1):f++}if(c&&d){var h=function(){e(d,b.newPackage().attachmentFileList(),a)};e(c,b.newPackage().descriptionFileList(),h)}else c?e(c,b.newPackage().descriptionFileList(),a):d?e(d,b.newPackage().attachmentFileList(),a):a()},e=function(a,b,c){$.ajax(serviceRootURL+"/packages/files",{type:"POST",data:a,processData:!1,contentType:!1,success:function(a,d,e){for(var f=0;f<a.length;f++)for(var g=a[f],h=0;h<b.length;h++){var i=b[h];i.isUploaded()||g.name===i.name&&(console.log("File uploaded:",g.id,g.name),i.isUploaded(!0),i.id=g.id)}c&&"function"==typeof c&&c()},error:function(a,b,c){showError("Fehler beim hochladen der files",a,b,c),console.log("File upload failed: ",c)}})};b.cancelPackageCreate=function(){if(!b.dataChanged())return void c();showQuestionYesNo(i18n.t("packages.details.cancelCreateRequestQuestion"),function(a){1==a&&c()}),$("body").find("div.bootbox-confirm").find("div.modal-dialog").addClass("confirm-dialog-size-600")},b.validateAndCreatePackage=function(){if($("#packageCreateForm").parsley().validate()){b.newPackage().plannedArrivalDate(b.fromDate()),b.newPackage().plannedDepartureDate(b.toDate()),b.initialComment()&&""!==b.initialComment()&&b.newPackage().commentList.push({id:void 0,comment:b.initialComment()}),b.newPackage().status(PACKAGE_STATUS_ENUM.OPEN),b.newPackage().previousStatus(PACKAGE_STATUS_ENUM.OPEN),b.showLoadingSpinner(!0);var e;if(b.isSeller()){if(headerVM.assignedPackageCustomerPartnerList().forEach(function(a){a.id==b.assignedCustomer()&&b.newPackage().customer(a)}),void 0===b.newPackage().customer().id)return void console.error("Cannot create package without assigned customer");e=function(a){PackageLogger.getInstance().writeLog(a.id,PACKAGE_LOG_TYPE.ACTIVITY,PACKAGE_LOG_STATES.PACKAGE_CREATED),b.showLoadingSpinner(!1),c(),setTimeout(function(){location.href="#packages/"+a.id},200)}}else e=function(d){PackageLogger.getInstance().writeLog(d.id,PACKAGE_LOG_TYPE.ACTIVITY,PACKAGE_LOG_STATES.PACKAGE_REQUESTED),c(),b.showLoadingSpinner(!1),a.searchPackages()};d(function(){b.createPackage(b.newPackage().toJson(),e,function(){b.showLoadingSpinner(!1)})})}}}function PackagesOverviewViewModel(){var a=this;a.showLoadingSpinner=ko.observable(!1),a.searchText=ko.observable(),a.packageList=ko.observableArray(),a.statusSelectOptions=ko.observableArray(),a.selectedStatus=ko.observable(),a.customerSelectOptions=ko.observableArray(),a.selectedCustomer=ko.observableArray(),a.sellerSelectOptions=ko.observableArray(),a.selectedSeller=ko.observableArray(),a.todayPrev=ko.observable(),a.timeRangeSelection=ko.observable("last2Months"),a.dateRange=ko.observable(),a.selectedPage=ko.observable(1),a.nrOfPages=ko.observable(1),a.selectedItemsPerPage=ko.observable(20),a.fromDate=ko.observable(),a.toDate=ko.observable(),PackageAbstractViewModel.apply(a,[]),a.backToOverview=function(){a.resetFilters(),a.searchText(null),location.href="#packages"},a.deletePackage=function(b,c){showQuestionYesNo(i18n.t("packages.msg.confirmDeletePackage"),function(c){if(1==c){var d=b.toJson();a.showLoadingSpinner(!0),$.ajax({url:serviceRootURL+"/packages/"+d.id,type:"DELETE",data:JSON.stringify(d),dataType:"json",contentType:"application/json",success:function(c,d,e){console.log("deleted the package"),a.showLoadingSpinner(!1);var f=a.packageList.indexOf(b);f>=0&&a.packageList.splice(f,1)},error:function(b,c,d){showError("Fehler beim Löschen des Package",b,c,d),a.showLoadingSpinner(!1)}})}}),$("body").find("div.modal-dialog").addClass("confirm-dialog-size-600")},a.deletePackageAllowed=function(a){return!!(a.status()&&a.status().id<=PACKAGE_STATUS_ENUM.INDICATED.id)},a.openPackage=function(a,b){$(b.target).hasClass("fa fa-trash")||(location.href="#packages/"+a.id())},a.filteredPackages=ko.computed(function(){return a.packageList()}),a.getStatusName=function(a){if(a){var b="packages.stepper."+a.name;return i18n.t(b)}return""};var b=!1;a.loadPackageOverview=function(c){if(1!=b){b=!0,console.log("loadPackageOverview",c),a.disableFilter(),a.showLoadingSpinner(!0),a.packageList([]);try{$.ajax(serviceRootURL+"/packages",{type:"GET",data:c,dataType:"json",contentType:"application/json",success:function(c,d,e){console.log("Packages found: ",c),a.enableFilter(),a.showLoadingSpinner(!1),c.forEach(function(b){var c=new Package(b);a.packageList.push(c)}),c.length>0?a.nrOfPages(c[0].overviewData.maxPageNr):a.nrOfPages(1),b=!1,$.getScript("assets/js/jungfrau.min.js")},error:function(c,d,e){checkSession(c),a.enableFilter(),a.showLoadingSpinner(!1),console.log("Server error on loading packages: "+c.responseText),b=!1,showError("Fehler beim Laden der Packages",c,d,e)}})}catch(c){a.enableFilter(),a.showLoadingSpinner(!1),console.log("Exception on loading packages: "+c),showException("Fehler beim Laden der Packages",c),b=!1}}},
a.searchPackages=function(){$(".dateRange").fadeOut();var b={fromDate:a.fromDate(),toDate:a.toDate(),searchText:a.searchText()?a.searchText().trim():a.searchText(),queryBy:a.queryBy(),pageNr:a.selectedPage(),pageLimit:a.selectedItemsPerPage(),packageStatus:a.selectedStatus()?a.selectedStatus().name:null,customer:a.selectedCustomer()?a.selectedCustomer():[],seller:a.selectedSeller()?a.selectedSeller():[]};a.loadPackageOverview(b)},a.timeRangeSelectionListener=ko.computed(function(b,c){if(a.timeRangeSelection()!=a.todayPrev())if("option1"==a.timeRangeSelection())a.todayPrev(a.timeRangeSelection()),a.fromDate($.datepicker.formatDate(DATE_SERVER_FORMAT,new Date)),a.toDate($.datepicker.formatDate(DATE_SERVER_FORMAT,new Date)),$("#startDate").val(""),$("#endDate").val(""),$(".dateRange").fadeOut();else if("option2"==a.timeRangeSelection())a.todayPrev(a.timeRangeSelection()),""==$("#startDate").val()&&a.customFromDate(""),""==$("#endDate").val()&&a.customToDate("");else if("last2Months"==a.timeRangeSelection()){a.todayPrev(a.timeRangeSelection());var d=moment(new Date).subtract(2,"month");a.fromDate($.datepicker.formatDate(DATE_SERVER_FORMAT,d.toDate())),a.toDate($.datepicker.formatDate(DATE_SERVER_FORMAT,new Date)),$("#startDate").val(""),$("#endDate").val(""),$(".dateRange").fadeOut()}});var c=function(){$(".dialog-section").load("assets/package-create.html",function(){ko.cleanNode($("#packageCreate")[0]);var b=new PackageCreateViewModel(a);ko.applyBindings(b,document.getElementById("packageCreate")),$("#packageCreate").modal("show"),$("#packageCreate").on("hide.bs.modal",function(a){!b.closeDialog()&&b.dataChanged()&&a.preventDefault()})})};a.createNewRequest=function(){c()},a.createNewPackage=function(){c()},a.showEditPackageDialog=function(a,b){showPackage(a.id())},a.resetFilters=function(){a.selectedCustomer(void 0),a.selectedStatus(void 0),a.selectedSeller(void 0),a.selectedPage(1),$("#resetFilterBtn").blur()},a.filterSelected=ko.computed(function(){return!(a.selectedCustomer()||a.selectedStatus()||a.selectedSeller())}),a.reloadListener=ko.computed(function(){a.searchPackages()}).extend({throttle:100}),function(){var b=new Set;b.add(PACKAGE_STATUS_ENUM.OPEN),b.add(PACKAGE_STATUS_ENUM.INDICATED),b.add(PACKAGE_STATUS_ENUM.PRICE_REQUESTED),b.add(PACKAGE_STATUS_ENUM.OFFERED),b.add(PACKAGE_STATUS_ENUM.INSTRUCTED),b.add(PACKAGE_STATUS_ENUM.PREBOOKED),b.add(PACKAGE_STATUS_ENUM.BOOKED),b.add(PACKAGE_STATUS_ENUM.CLOSED),b.add(PACKAGE_STATUS_ENUM.CANCELED),a.statusSelectOptions.removeAll(),b.forEach(function(b){a.statusSelectOptions.push({display:a.getStatusName(b),value:b})})}(),function(){try{$.ajax(serviceRootURL+"/packages/filter_options/1",{type:"GET",data:null,dataType:"json",contentType:"application/json",success:function(b,c,d){console.log("Filter options found: ",b),a.enableFilter(),a.showLoadingSpinner(!1),a.customerSelectOptions([]),a.sellerSelectOptions([]),b.customers.forEach(function(b){a.customerSelectOptions.push(b)}),a.customerSelectOptions.sort(function(a,b){return a.name.localeCompare(b.name)}),b.sellers.forEach(function(b){a.sellerSelectOptions.push(b)}),a.sellerSelectOptions.sort(function(a,b){return a.name.localeCompare(b.name)})},error:function(b,c,d){checkSession(b),a.enableFilter(),a.showLoadingSpinner(!1),console.log("Server error on loading filter options: "+b.responseText),showError("Fehler beim Laden der Filteroptionen",b,c,d)}})}catch(b){a.enableFilter(),a.showLoadingSpinner(!1),console.log("Exception on loading filter options: "+b),showException("Fehler beim Laden der Filteroptionen",b)}}()}function PackageOrderItemGroupViewModel(a,b){var c=this;this.firstItem=ko.observable(a),this.status=ko.observable(c.firstItem().status()),this.error=ko.observable(),this.categoryKey=ko.observable(a.categoryKey()),this.productKey=ko.observable(a.productKey()),this.date=ko.observable(a.date()),this.startTime=ko.observable(a.startTime()),this.startTimeTba=ko.observable(a.startTimeTba()),this.packageMargin=ko.observable(a.packageMargin()),this.toDate=ko.observable(a.toDate()),this.idFilter=ko.observable(),this.categoryName=ko.observable(i18n.t("category.short."+this.categoryKey().toLowerCase())),c.items=ko.observableArray(),c.subgroups=ko.observableArray(),c.groupExpanded=ko.observable(b),c.hasSubservice=function(a){if(a.categoryKey()===CATEGORY_KEY_SUBSERVICE){for(var b=0;b<c.items().length;b++)if(c.items()[b].id()==a.refItemId())return!0;for(var b=0;b<c.subgroups().length;b++)if(c.subgroups()[b].groupItem().id()==a.refItemId())return!0}return!1},c.matches=function(a){return a.categoryKey()==c.categoryKey()&&(c.categoryKey()==CATEGORY_KEY_CATERING?a.date()==c.date():c.categoryKey()==CATEGORY_KEY_TOURIST_TAX?a.regionId()==c.firstItem().regionId()&&a.accommCityId()==c.firstItem().accommCityId()&&a.date()==c.date()&&a.toDate()==c.toDate():a.productKey()==c.productKey()&&a.date()==c.date()&&a.toDate()==c.toDate())},c.totalAmount=ko.computed(function(){for(var a="",b=0,d=0;d<c.items().length;d++){var e=c.items()[d];b+=e.amount(),a+=e.id()+","}for(var d=0;d<c.subgroups().length;d++){var e=c.subgroups()[d].groupItem();a+=e.id()+","}return a=a.substr(0,a.length-1),c.idFilter(a),b},c)}function PackageOrderItemSubGroupViewModel(a,b){var c=this;c.group=a,c.groupItem=ko.observable(b),c.items=ko.computed(function(){return ko.utils.arrayFilter(c.group.items(),function(a){return a.refItemId()==b.id()})},c)}function PackageOrderItemSubServiceViewModel(a,b){var c=this;c.group=a,c.groupItem=ko.observable(b),c.items=ko.computed(function(){return ko.utils.arrayFilter(c.group.items(),function(a){return a.refItemId()==b.id()})},c)}function packageDetailViewModel(a){var b=this,c=Object.freeze({ALL:{loadParameter:"all"},OVERVIEW:{loadParameter:"overview"},COMMENTS:{loadParameter:"comments"},OFFERS:{loadParameter:"offers"},ORDERS:{loadParameter:"orders"}});b.package=ko.observable(new Package),b.package().id(a),b.order=ko.observable(),b.orderItemGroups=ko.observableArray(),b.additionalOrder=ko.observable(),b.additionalOrderItemGroups=ko.observableArray(),b.optionalOrder=ko.observable(),b.optionalOrderItemGroups=ko.observableArray(),b.compensatoryOrder=ko.observable(),b.compensatoryOrderItemGroups=ko.observableArray(),b.showLoadingSpinner=ko.observable(!1),b.loadingState=ko.observable(!1),b.processingOrder=ko.observable(!1),b.processingAdditionalOrder=ko.observable(!1),b.processingOptionalOrder=ko.observable(!1),b.processingCompensatoryOrder=ko.observable(!1),b.processingOffer=ko.observable(!1),b.processingPriceIndication=ko.observable(!1),b.selectedOfferDate=ko.observable(),b.eventBus=new ko.subscribable,b.newPriceIndicationFrom=ko.observable(),b.newPriceIndicationTo=ko.observable(),b.initialComment=ko.observable(),b.assignedCustomer=ko.observable(),b.currency=currency,b.customerChangeAllowed=ko.observable(!1),b.priceIndicationOutdated=ko.observable(!1),b.servicesOrderItemsChanged=ko.observable(!1),PackageAbstractViewModel.apply(b,[]),b.eventBus.subscribe(function(a){j(!0,!1)},null,EVENT_BUS_EVENTS.EDIT_EVENT_STARTED),b.eventBus.subscribe(function(a){j(!1,!1)},null,EVENT_BUS_EVENTS.EDIT_EVENT_FINISHED);var d=function(){var a={};location.href.replace(/[?&]+([^=&]+)=([^&]*)/gi,function(b,c,d){a[c]=d});return a},e=function(a){$(".dialog-section").load("assets/package-hotelreservation.html",function(){ko.cleanNode($("#packageHotelReservation")[0]);var c=new PackageHotelReservationViewModel(b,a);ko.applyBindings(c,document.getElementById("packageHotelReservation")),$("#packageHotelReservation").modal("show"),$("#packageHotelReservation").on("hide.bs.modal",function(a){c.closeDialog()||a.preventDefault()})})};b.openAssignHotelDialog=function(a){e(a)};var f=function(a){$(".dialog-section").load("assets/package-reservation-dialog.html",function(){ko.cleanNode($("#packageReservationDialog")[0]);var c=new PackageReservationDialogViewModel(b,a);ko.applyBindings(c,document.getElementById("packageReservationDialog")),$("#packageReservationDialog").modal("show"),$("#packageReservationDialog").on("hide.bs.modal",function(a){c.closeDialog()||a.preventDefault()})})};b.showReservationDialog=function(a){f(a)},b.getChangedItems=function(){var a=[];return b.order().orderItems().forEach(function(b){b.categoryKey()!=CATEGORY_KEY_HOTEL&&b.categoryKey()!=CATEGORY_KEY_MARGIN||b.priceCorrection()!=b.priceCorrectionEdit()&&a.push(b)}),b.additionalOrder()&&b.additionalOrder().orderItems().forEach(function(b){b.categoryKey()!=CATEGORY_KEY_HOTEL&&b.categoryKey()!=CATEGORY_KEY_MARGIN||b.priceCorrection()!=b.priceCorrectionEdit()&&a.push(b)}),a},b.setChangedValueAndLogActivity=function(){b.order().orderItems().forEach(function(a){if((a.categoryKey()==CATEGORY_KEY_HOTEL||a.categoryKey()==CATEGORY_KEY_MARGIN)&&a.priceCorrection()!=a.priceCorrectionEdit()){console.log("Price correction changed for item from to",a,a.priceCorrection(),a.priceCorrectionEdit());var c=a.categoryKey()+"_"+a.productName()+"_"+a.consumerKey()+"_"+a.priceCorrectionEdit()+"_"+b.currency();PackageLogger.getInstance().writeLog(b.package().id(),PACKAGE_LOG_TYPE.PRICE_ADJUST,c).pipe(function(a){b.package().activityList.splice(0,0,a)}),a.priceCorrection(a.priceCorrectionEdit())}})},b.createCommentForRequiredComment=function(a){var b=i18n.t("packages.msg.priceCorrectionReasonForItems"),c=i18n.t("packages.msg.reason"),d="\n";return a.forEach(function(a){if(a.categoryKey()==CATEGORY_KEY_HOTEL){var b="",c=a.consumerKey().split(".");if(3==c.length){var e=a.consumerKey();"GRP"==c[0]&&(e=i18n.t("packages.hotel.group")),"FIT"==c[0]&&(e=i18n.t("packages.hotel.FIT"));var f=i18n.t("shop.hotel.occupancy."+c[1]);b="ADULT"==c[2]?i18n.t("packages.hotel.adult"):"CHILD"==c[2]?i18n.t("packages.hotel.child"):a.consumerKey()}d+=a.productName()+" - "+f+", "+e+", "+b}else a.categoryKey()==CATEGORY_KEY_MARGIN?d+=a.productName():a.categoryKey()==CATEGORY_KEY_ADHOC&&(d+=a.productName());d=a.priceCorrection()?d+": "+a.priceCorrection()+" "+currency()+" -> "+a.priceCorrectionEdit()+" "+currency():d+": "+a.price()+" "+currency()+" -> "+a.priceCorrectionEdit()+" "+currency(),d+="\n"}),b+"\n"+d+"\n"+c+"\n"};var g=function(){var a=function(a){var b=[];return a.forEach(function(b){b.categoryKey()===CATEGORY_KEY_SUBSERVICE&&b.type()===ORDER_ITEM_TYPE_PACKAGE_SUBSERVICE&&a.forEach(function(a){a.categoryKey()===CATEGORY_KEY_SUBSERVICE&&a.refItemId()===b.id()&&a.durationOverwrite(b.durationOverwrite())})}),a.forEach(function(a){b.push({id:a.id(),priceCorrection:a.priceCorrection(),durationOverwrite:a.durationOverwrite?a.durationOverwrite():null,quantity:a.quantity()})}),b},c=a(kp.get(b,"order.orderItems",[]));return c=c.concat(a(kp.get(b,"additionalOrder.orderItems",[]))),c.concat(a(kp.get(b,"optionalOrder.orderItems",[])))},h=function(a){var c={orderItemUpdateList:g(),offer:b.package().toJson().offer,setQuantities:b.package().status()==PACKAGE_STATUS_ENUM.PREBOOKED};console.log("Calling create/update offer",c),b.processingOffer(!0),$.ajax({url:serviceRootURL+"/packages/offer",type:"POST",data:JSON.stringify(c),dataType:"json",contentType:"application/json",success:function(c,d,e){console.log("Offer created",c),b.package().setOffer(c),b.processingOffer(!1),b.loadOrder(b.package().id()),b.loadAdditionalOrder(),b.loadOptionalOrder(),!0===b.priceIndicationOutdated()&&b.refreshPriceIndication(),a?a():j(!1,!1)},error:function(a,c,d){showError(i18n.t("packages.msg.offerUpdateFailed"),a,c,d),j(!1,!1),b.processingOffer(!1),b.loadOrder()}})};b.createUpdatedOffer=function(a){var c=b.getChangedItems();if(c.length>0){var d=$("#serviceTableForm7").parsley().validate();if(b.priceIndicationOutdated(!0),!d)return void $("#serviceTableForm")[0].scrollIntoView(!0);var e=function(){b.setChangedValueAndLogActivity(),$("#offerTable")[0].scrollIntoView(!0),h(a)},f=b.createCommentForRequiredComment(c);ko.dataFor($("comment").get(0).firstChild).showCommentFieldWithText(f,e)}else h(a)},b.adjustOfferToPersons=function(){if($("#offerTable").parsley().options.requiredMessage=i18n.t("packages.details.fieldRequiredMsg"),$("#offerTable").parsley().validate()){$("#updateOfferBtn").blur(),j(!0,!1);var a=function(){b.loadPackageById(b.package().id(),c.OVERVIEW)};b.createUpdatedOffer(a)}},b.updateOfferBtnVisible=ko.computed(function(){return 0!=b.orderItemGroups().length&&(!b.isCustomer()&&(!b.package()||!b.package().status()||PACKAGE_STATUS_ENUM.INSTRUCTED!=b.package().status()&&PACKAGE_STATUS_ENUM.BOOKED.id>b.package().status().id))});var i=function(){var a=d();a.clone?(b.package().status()&&b.package().status()==PACKAGE_STATUS_ENUM.OPEN&&b.customerChangeAllowed("true"===a.clone),window.history.pushState({},document.title,location.href.replace("?clone=true",""))):b.customerChangeAllowed(!1)};b.clonePackage=function(){var a=b.package().toJson();a.id=void 0,a.overviewData.status=PACKAGE_STATUS_ENUM.OPEN.name,a.overviewData.invoicePdf=null,a.overviewData.noAutomaticInvoice=0,console.log("Cloning package json",a),b.showLoadingSpinner(!0);var c=function(a){PackageLogger.getInstance().writeLog(a.id,PACKAGE_LOG_TYPE.ACTIVITY,PACKAGE_LOG_STATES.PACKAGE_CLONED),setTimeout(function(){b.showLoadingSpinner(!1),location.href="#packages/"+a.id+"?clone=true"},200)};b.createPackage(a,c,void 0,!0)},b.requestPackageCancellation=function(){var a=b.package().toJson();a.overviewData.cancellationRequested=!0,console.log("Requesting package cancellation",a),b.showLoadingSpinner(!0);var c=function(a){PackageLogger.getInstance().writeLog(b.package().id,PACKAGE_LOG_TYPE.ACTIVITY,PACKAGE_LOG_STATES.CANCELLATION_REQUESTED),setTimeout(function(){b.showLoadingSpinner(!1)},200)};b.updatePackageData(a,PACKAGE_UPDATE_PART.CANCEL_REQUEST,c)},b.resetPackageCancellationRequest=function(){var a=b.package().toJson();a.overviewData.cancellationRequested=!1,console.log("Resetting package cancellation",a),j(!0,!0);var c=function(a){PackageLogger.getInstance().writeLog(b.package().id,PACKAGE_LOG_TYPE.ACTIVITY,PACKAGE_LOG_STATES.CANCELLATION_REQUEST_RESET),setTimeout(function(){b.showLoadingSpinner(!1)},200)};b.updatePackageData(a,PACKAGE_UPDATE_PART.CANCEL_REQUEST,c)},b.fileStatusChangeCallback=function(a,c,d){if(a&&c){console.log("fileStatusChangeCallback",a,c,d);var e="unknown";"upload"===a?(e=PACKAGE_LOG_TYPE.FILE_ATTACHED,d===FILE_TRANSFER_TYPE.DESCRIPTION_FILE&&(e=PACKAGE_LOG_TYPE.DESCRIPTION_FILE_ATTACHED),d===FILE_TRANSFER_TYPE.TRAVEL_MEMBER_LIST&&(e=PACKAGE_LOG_TYPE.TRAVELMEMBER_FILE_ATTACHED),d===FILE_TRANSFER_TYPE.ATTACHMENT_FILE&&(e=PACKAGE_LOG_TYPE.ATTACHMENT_FILE_ATTACHED),d===FILE_TRANSFER_TYPE.EXT_VOUCHER_FILE&&(e=PACKAGE_LOG_TYPE.EXT_VOUCHER_FILE_ATTACHED)):"delete"===a&&(e=PACKAGE_LOG_TYPE.FILE_REMOVED,d===FILE_TRANSFER_TYPE.DESCRIPTION_FILE&&(e=PACKAGE_LOG_TYPE.DESCRIPTION_FILE_REMOVED),d===FILE_TRANSFER_TYPE.TRAVEL_MEMBER_LIST&&(e=PACKAGE_LOG_TYPE.TRAVELMEMBER_FILE_REMOVED),d===FILE_TRANSFER_TYPE.ATTACHMENT_FILE&&(e=PACKAGE_LOG_TYPE.ATTACHMENT_FILE_REMOVED),d===FILE_TRANSFER_TYPE.EXT_VOUCHER_FILE&&(e=PACKAGE_LOG_TYPE.EXT_VOUCHER_FILE_REMOVED));var f=c.map(function(a){return a.name});PackageLogger.getInstance().writeLog(b.package().id(),e,f.join()).pipe(function(a){b.package().activityList.splice(0,0,a)})}var g=b.package().toJson();b.updatePackageData(g,PACKAGE_UPDATE_PART.ATTACHMENTS)},b.printAsPdf=function(){var a=serviceRootURL+"/packages/print/"+b.package().id();window.location=a},b.printScheduleAsPdf=function(){var a=serviceRootURL+"/packages/print_schedule/"+b.package().id();window.open(a,"_blank","toolbar=no, location=no, status=no, scrollbars=yes, resizable=yes")},b.clickUseLogo=function(a){return b.updatePackage(),!0},b.updatePackage=function(){if(!b.package()||!b.package().status())return!1;console.log("updatePackage"),j(!0,!0);var a=function(){console.log("clickUseLogo callback"),b.loadPackageById(b.package().id(),c.OVERVIEW)};b.updateEditableData(a)},b.disableUseLogo=ko.computed(function(){return!(b.package()&&b.package().customer()&&b.package().customer().logoHtml)}),b.showNoAutomaticInvoice=function(){return 1==b.package().noAutomaticInvoice()},b.updateNoAutomaticInvoiceAllowed=ko.computed(function(){return!(!b.package()||!b.package().status())&&(b.package().status().id<PACKAGE_STATUS_ENUM.BOOKED.id&&!b.package().lastMinuteChange())}),b.updateSendNoAutomaticInvoice=function(){if(!b.package()||!b.package().status()||!b.updateNoAutomaticInvoiceAllowed())return!1;if(b.package().tourNumber()){b.updateAutomaticInvoice(),j(!0,!0);var a=function(){console.log("updateSendNoAutomaticInvoice callback"),b.loadPackageById(b.package().id(),c.OVERVIEW)};b.updateEditableData(a)}console.log("updateSendNoAutomaticInvoice: "+b.package().noAutomaticInvoice())},b.updateAutomaticInvoice=function(){var a=0;document.getElementById("sendNoInvoice").checked&&(a=1),b.package().noAutomaticInvoice(a)},b.invoiceButtonsAllowed=ko.computed(function(){return!(!b.package()||!b.package().status())&&(b.package().status().id==PACKAGE_STATUS_ENUM.BOOKED.id||b.package().status().id==PACKAGE_STATUS_ENUM.CLOSED.id)}),b.initiateLastMinuteChange=function(){b.package()&&(b.package().lastMinuteChange(1),b.setPackageToNextOrPreviousState(!1,!1))},b.getIndicationOfferTableCss=function(a,c){var d="list-inline ";if(d+=a?"overview-header top-border ":"solid-body no-left-border overview-body ",b.package()){var e=document.getElementById("packageDetails");b.package().priceIndicationList()[0]?e.style.setProperty("--indicationOfferColumnCnt",b.package().priceIndicationList()[0].consumerList().length):b.package().offer()?e.style.setProperty("--indicationOfferColumnCnt",b.package().offer().consumerList().length):e.style.setProperty("--indicationOfferColumnCnt","20%")}return d+="indication-offer-table",!0===b.priceIndicationOutdated()&&!0===c&&(d+="values-outdated "),d};var j=function(a,c){b.loadingState(a),$("#backToOverviewBtn").attr("disabled",a),$("#commentBtn").attr("disabled",a),$("#confirmCancelBtn").attr("disabled",a),$("#resetCancelBtn").attr("disabled",a),$("#addCommentBtn").attr("disabled",a),$("#cancelPriceIndicationBtn").attr("disabled",a),$(".price-indication-date-input").attr("disabled",a),c&&b.showLoadingSpinner(a),a?($("#addPriceIndicationBtn").attr("disabled",!0),$("#previousStateBtn").attr("disabled",!0),$("#closePackageBtn").attr("disabled",!0),$("#moreBtn").attr("disabled",!0)):(b.showLoadingSpinner(!1),$("#addPriceIndicationBtn").attr("disabled",b.selectedTimeRangeValid()),$("#nextStateBtn").attr("disabled",!b.nextStateBtnEnabled()),$("#previousStateBtn").attr("disabled",!b.previousStateBtnEnabled()),$("#closePackageBtn").attr("disabled",b.isCustomer()))};b.scrollToComment=function(){ko.dataFor($("comment").get(0).firstChild).scrollToComment()},b.saveComment=function(a,d,e){var f=b.package().toJson();f.commentList.push({comment:a,type:d});var g=function(){console.log("saveComment callback"),b.loadPackageById(f.id,c.COMMENTS),e&&"function"==typeof e&&e()};b.updatePackageData(f,PACKAGE_UPDATE_PART.COMMENTS,g)},b.getFormatedActivityText=function(a){var b=formatDateTime(a.createdAt.millis);if(a.logEventType===PACKAGE_LOG_TYPE.ACTIVITY)return i18n.t("packages.activity."+a.details.toLowerCase())+" ("+a.userName+" - "+b+")";if(a.logEventType===PACKAGE_LOG_TYPE.FILE_ATTACHED)return i18n.t("packages.activity.file_attached")+": "+a.details+" ("+a.userName+" - "+b+")";if(a.logEventType===PACKAGE_LOG_TYPE.FILE_REMOVED)return i18n.t("packages.activity.file_removed")+": "+a.details+" ("+a.userName+" - "+b+")";if(a.logEventType===PACKAGE_LOG_TYPE.DESCRIPTION_FILE_ATTACHED)return i18n.t("packages.activity.descriptionFileAttached")+": "+a.details+" ("+a.userName+" - "+b+")";if(a.logEventType===PACKAGE_LOG_TYPE.DESCRIPTION_FILE_REMOVED)return i18n.t("packages.activity.descriptionFileRemoved")+": "+a.details+" ("+a.userName+" - "+b+")";if(a.logEventType===PACKAGE_LOG_TYPE.ATTACHMENT_FILE_ATTACHED)return i18n.t("packages.activity.attachmentFileAttached")+": "+a.details+" ("+a.userName+" - "+b+")";if(a.logEventType===PACKAGE_LOG_TYPE.ATTACHMENT_FILE_REMOVED)return i18n.t("packages.activity.attachmentFileRemoved")+": "+a.details+" ("+a.userName+" - "+b+")";if(a.logEventType===PACKAGE_LOG_TYPE.EXT_VOUCHER_FILE_ATTACHED)return i18n.t("packages.activity.extVoucherFileAttached")+": "+a.details+" ("+a.userName+" - "+b+")";if(a.logEventType===PACKAGE_LOG_TYPE.EXT_VOUCHER_FILE_REMOVED)return i18n.t("packages.activity.extVoucherFileRemoved")+": "+a.details+" ("+a.userName+" - "+b+")";if(a.logEventType===PACKAGE_LOG_TYPE.TRAVELMEMBER_FILE_ATTACHED)return i18n.t("packages.activity.travelMemberFileAttached")+": "+a.details+" ("+a.userName+" - "+b+")";if(a.logEventType===PACKAGE_LOG_TYPE.TRAVELMEMBER_FILE_REMOVED)return i18n.t("packages.activity.travelMemberFileRemoved")+": "+a.details+" ("+a.userName+" - "+b+")";if(a.logEventType===PACKAGE_LOG_TYPE.PRICE_ADJUST){var c=a.details,d=c.split("_"),e=d[0],f=d[1],g=d[2],h=d[3],i=d[4];if(e==CATEGORY_KEY_HOTEL){var j="",d=g.split(".");if(3==d.length){var k=g;"GRP"==d[0]&&(k=i18n.t("packages.hotel.group")),"FIT"==d[0]&&(k=i18n.t("packages.hotel.FIT"));var l=i18n.t("shop.hotel.occupancy."+d[1]);j="ADULT"==d[2]?i18n.t("packages.hotel.adult"):"CHILD"==d[2]?i18n.t("packages.hotel.child"):g}c=f+" - "+l+", "+k+", "+j+" - "+i18n.t("packages.hotel.newPrice")+": "+h+" "+i}else e==CATEGORY_KEY_MARGIN&&(c=f+" - "+i18n.t("packages.hotel.newPrice")+": "+h+" "+i);return i18n.t("packages.activity.price_changed")+": "+c+" ("+a.userName+" - "+b+")"}},b.getFormatedComment=function(a){return a.replace(/\r?\n/g,"<br>")},b.getFormatedCommentEntryHeader=function(a){return a.updatedBy+" "+i18n.t("packages.details.at")+" "+moment(a.createdAt.millis).format("L LTS")+":"},b.cancelCommentCallback=function(){j(!1,!1),$("#packageDetails")[0].scrollIntoView(!0),b.order().orderItems().forEach(function(a){a.categoryKey()!=CATEGORY_KEY_HOTEL&&a.categoryKey()!=CATEGORY_KEY_MARGIN||a.priceCorrection()!=a.priceCorrectionEdit()&&a.priceCorrectionEdit(a.priceCorrection())})},b.setPackageToNextOrPreviousState=function(a,d){b.package().previousStatus(b.package().status());var e,f=b.package().toJson();f.overviewData.status;if((e=!0===d?o():!0===a?m():n())===PACKAGE_STATUS_ENUM.PRICE_REQUESTED&&!0===a){$("#offerTable").parsley().options.requiredMessage=i18n.t("packages.details.fieldRequiredMsg");if(!$("#offerTable").parsley().validate())return;$("#nextStateBtn").blur()}else if(e===PACKAGE_STATUS_ENUM.CANCELED&&!0===a){var g=$("#adjustment").parsley();if(g.validate(),!g.isValid())return;if($("#cancelBtn").blur(),1==b.package().lastMinuteChange())for(var l=0;l<b.orderItemGroups().length;l++){var p=b.orderItemGroups()[l];p.status()==ORDER_STATUS_COMPLETE&&p.status(ORDER_STATUS_CANCELED)}}if(e&&(f.overviewData.previousStatus=f.overviewData.status,f.overviewData.status=e.name),!1===a){j(!0,!0);var q=null;return 1==b.package().lastMinuteChange()&&e==PACKAGE_STATUS_ENUM.PREBOOKED&&(q=function(){j(!0,!1),b.loadPackageById(f.id,c.OVERVIEW)}),void b.updatePackageData(f,PACKAGE_UPDATE_PART.STATUS,q)}if(e==PACKAGE_STATUS_ENUM.PREBOOKED&&!b.validateAllServicesConfirmed())return console.warn("Cannot confirm order, not all services have been confirmed"),showInfo(i18n.t("packages.msg.allServicesHaveToBeConfirmed")),void $("body").find("div.modal-dialog").addClass("confirm-dialog-size-600");var r=function(){console.log("customerEditAndOfferCreationCallback"),i(),k()},s=function(){var a=b.package().toJson();if(e&&(a.overviewData.previousStatus=a.overviewData.status,a.overviewData.status=e.name),b.servicesOrderItemsChanged()){var d=function(){console.log("overviewUpdateCallBack callback"),b.servicesOrderItemsChanged(!1),j(!0,!0),r(),b.loadPackageById(a.id,c.OVERVIEW)};b.updatePackageData(a,PACKAGE_UPDATE_PART.STATUS,d,!0)}else if(e&&PACKAGE_STATUS_ENUM.INSTRUCTED===e&&1>b.package().travelMemberList().length){var d=function(){j(!0,!0),r(),b.loadPackageById(a.id)};b.updatePackageData(a,PACKAGE_UPDATE_PART.STATUS,d)}else if(e&&PACKAGE_STATUS_ENUM.PRICE_REQUESTED===e){var d=function(){j(!0,!0),b.selectedOfferDate(b.getPriceIndicationForOfferDates()),b.loadPackageById(a.id,c.OVERVIEW)};b.updatePackageData(a,PACKAGE_UPDATE_PART.STATUS,d)}else{var d=function(){j(!0,!1),b.selectedOfferDate(b.getPriceIndicationForOfferDates()),b.loadPackageById(a.id,c.OVERVIEW)};b.updatePackageData(a,PACKAGE_UPDATE_PART.STATUS,d)}},t=function(){b.createUpdatedOffer(s)},u=function(){var a=function(){b.updateOptionalServices(t)};b.updateAdditionalServices(a)};if(e===PACKAGE_STATUS_ENUM.PRICE_REQUESTED||e===PACKAGE_STATUS_ENUM.OFFERED||e===PACKAGE_STATUS_ENUM.INSTRUCTED)j(!0,!0),b.isSeller()?!0===b.priceIndicationOutdated()||0==b.package().priceIndicationList()[0].consumerList().length?b.refreshPriceIndication(u):u():b.updateOffer(s);else if(e!==PACKAGE_STATUS_ENUM.INDICATED||!0!==b.priceIndicationOutdated()&&0!=b.package().priceIndicationList()[0].consumerList.length)if(e===PACKAGE_STATUS_ENUM.BOOKED){var v=function(){b.bookServices(s)};j(!0,!0),h(v)}else e===PACKAGE_STATUS_ENUM.CANCELED?b.cancelServices(s):e===PACKAGE_STATUS_ENUM.DISCARDED?b.discardServices(s):(j(!0,!0),s());else j(!0,!0),b.refreshPriceIndication(s)},b.validateAllServicesConfirmed=function(){var a=!0;return b.orderItemGroups().forEach(function(c){c.categoryKey()!==CATEGORY_KEY_TOURIST_TAX&&c.categoryKey()!==CATEGORY_KEY_MARGIN&&(1==b.package().lastMinuteChange()?c.status()!==ORDER_STATUS_CONFIRMED&&c.status()!==ORDER_STATUS_CANCELED&&(a=!1):c.status()!==ORDER_STATUS_CONFIRMED&&c.status()!==ORDER_STATUS_COMPLETE&&(a=!1))}),a},b.updateEditableData=function(a){var d=!1;headerVM.assignedPackageCustomerPartnerList().forEach(function(a){a.id==b.assignedCustomer()&&b.package().customer().id!==a.id&&(b.package().customer(a),d=!0,console.log("customer changed",b.package().customer()))});var e=b.package().toJson();if(j(!0,!1),d){var f=function(){a(),j(!0,!0),b.loadPackageById(e.id,c.OVERVIEW)};b.updatePackageData(e,PACKAGE_UPDATE_PART.OVERVIEW,f)}else b.updatePackageData(e,PACKAGE_UPDATE_PART.OVERVIEW,a)},b.updatePackageData=function(a,c,d,e){var f=serviceRootURL+"/packages/"+a.id;c&&(f=f+"?updatePart="+c),!0===e&&(f+="&increaseLfd=true"),console.log("Updating package ("+c+"):",a),$.ajax({url:f,type:"PUT",data:JSON.stringify(a),dataType:"json",contentType:"application/json",success:function(e,f,g){if(PACKAGE_UPDATE_PART.STATUS!==c&&PACKAGE_UPDATE_PART.OVERVIEW!==c&&PACKAGE_UPDATE_PART.CANCEL_REQUEST!==c||b.package().updateOverviewData(e.overviewData),b.setEditLabelEnableState(b.package().status().id<PACKAGE_STATUS_ENUM.BOOKED.id),PACKAGE_UPDATE_PART.STATUS===c&&a.overviewData.status!=a.overviewData.previousStatus){var h=PACKAGE_STATUS_ENUM.valueOf(a.overviewData.status);PackageLogger.getInstance().writeLog(a.id,PACKAGE_LOG_TYPE.ACTIVITY,h.transitionName).pipe(function(a){b.package().activityList.splice(0,0,a)})}d&&"function"==typeof d?d():j(!1,!1)},error:function(a,b,c){showError("Fehler beim updaten des Package",a,b,c),j(!1,!1)}})};var k=function(){var a=b.getPriceIndicationForOfferDates()||b.package().priceIndicationList()[0];b.package().setPriceIndicationAsOfferTemplate(a),b.selectedOfferDate(a)};b.processingIndicator=ko.computed(function(){return b.processingOrder()||b.processingOffer()}),b.setEditLabelEnableState=function(a){!1===a?(b.eventBus.notifySubscribers("releaseDateReminderOffset",EVENT_BUS_EVENTS.DISABLE_EVENT),b.eventBus.notifySubscribers("extOrdLabel",EVENT_BUS_EVENTS.DISABLE_EVENT),b.eventBus.notifySubscribers("titelLabel",EVENT_BUS_EVENTS.DISABLE_EVENT)):b.eventBus.notifySubscribers(-1,EVENT_BUS_EVENTS.EDIT_EVENT_FINISHED)},b.loadPackageById=function(a,d,e){d||(d=c.ALL),c.ALL==d&&j(!0,!0),$.ajax(serviceRootURL+"/packages/"+a,{type:"GET",data:c.ORDERS==d?c.OVERVIEW:d,dataType:"json",contentType:"application/json",success:function(f,g,h){console.log("Package loaded ("+d.loadParameter+"):",f),c.ALL==d?(b.package().setPackageData(f),b.assignedCustomer(b.package().customer()),i(),b.loadOrder(),b.loadAdditionalOrder(),b.loadOptionalOrder(!1),b.loadCompensatoryOrder(),k(),PackageLogger.getInstance().readLogs(a).pipe(function(a,c,d){return b.package().setActivityLogs(a),a}),b.setEditLabelEnableState(b.package().status().id<PACKAGE_STATUS_ENUM.BOOKED.id)):c.COMMENTS==d?b.package().updateComment(f.commentList):c.OVERVIEW==d?(b.package().updateOverviewData(f.overviewData),b.assignedCustomer(b.package().customer())):c.OFFERS==d?b.package().setOffer(f.offer):c.ORDERS==d&&(b.package().orderId(f.orderId),b.package().additionalOrderId(f.additionalOrderId),b.package().optionalOrderId(f.optionalOrderId)),b.setEditLabelEnableState(b.package().status().id<PACKAGE_STATUS_ENUM.BOOKED.id),e&&"function"==typeof e?e():j(!1,!0)},error:function(a,b,c){showError("Fehler beim laden des Packages",a,b,c),j(!1,!0)}})},b.reloadPriceIndication=function(){b.refreshPriceIndication()},b.refreshPriceIndication=function(a){if(!b.package().orderId())return void console.error("Cannot refresh without orderId");b.processingPriceIndication(!0),$.ajax(serviceRootURL+"/packages/price_indications/"+b.package().id(),{type:"GET",data:{orderId:b.package().orderId()},dataType:"json",contentType:"application/json",success:function(c,d,e){console.log("getPriceIndicationById loaded: ",c),b.processingPriceIndication(!1),b.package().updatePriceIndications(c),b.offerTimeSelectionChange(),b.priceIndicationOutdated(!1),a&&a()},error:function(a,c,d){showError("Fehler beim laden der Preis indicationen",a,c,d),b.processingPriceIndication(!1),j(!1,!1)}})},b.createPriceIndication=function(a,c){console.log("createPriceIndication",a),b.processingPriceIndication(!0),$.ajax({url:serviceRootURL+"/packages/price_indications",type:"POST",data:JSON.stringify(a),dataType:"json",contentType:"application/json",success:function(a,d,e){console.log("created the price_indications"),b.processingPriceIndication(!1),c()},error:function(a,c,d){b.processingPriceIndication(!1),showError("Fehler beim Erstellen der Preisindikation",a,c,d),j(!1,!1)}})},b.updateOffer=function(a){var c=b.package().offer().toOfferJson();console.log("Updating offer",c),b.processingOffer(!0),$.ajax(serviceRootURL+"/packages/offer/"+b.package().orderId(),{type:"PUT",data:JSON.stringify(c),dataType:"json",contentType:"application/json",success:function(c,d,e){console.log("updateOffer successfull: ",c),b.processingOffer(!1),a&&a()},error:function(a,c,d){showError("Fehler beim laden der Angebote",a,c,d),j(!1,!1),b.processingOffer(!1)}})},b.getOfferByPackageId=function(a){b.processingOffer(!0),$.ajax(serviceRootURL+"/packages/offer/"+b.package().id(),{type:"GET",data:{},dataType:"json",contentType:"application/json",success:function(c,d,e){console.log("getOfferById loaded: ",c),b.processingOffer(!1),b.package().setOffer(c),a&&"function"==typeof a?a():j(!1,!1)},error:function(a,c,d){showError("Fehler beim laden der Angebote",a,c,d),b.processingOffer(!1)}})},b.getTableHeaderWithCurrency=function(a){return a+" ("+i18n.t("packages.details.allPricesIn")+" "+currency()+")"},window.Parsley._validatorRegistry.validators.personChange&&window.Parsley.removeValidator("personChange");var l=i18n.t("packages.msg.personCntNotMatching");window.Parsley.addValidator("personChange",{validate:function(a,c,d){if(b.package().status&&b.package().status().id>=PACKAGE_STATUS_ENUM.PREBOOKED.id){var e=d.$element[0].getAttribute("name"),f=b.package().offer();if(("adult_ez"==e||"child_ez"==e)&&f.getAvailableEzCount()<0)return!1;if(("adult_dz"==e||"child_dz"==e)&&f.getAvailableDzCount()<0)return!1;if(("adult_3z"==e||"child_3z"==e)&&f.getAvailable3zCount()<0)return!1;if("piccolo"==e&&f.getAvailablePiccoloCount()<0)return!1;if("child"==e&&f.getAvailableChildCount()<0)return!1;if("adult"==e&&f.getAvailableAdultCount()<0)return!1}return!0},messages:{de:l,en:l,fr:l,it:l}}),b.getStatusName=function(a){if(a){var b="packages.stepper."+a.name;return i18n.t(b)}return""},b.offerTimeSelectionChange=function(){b.selectedOfferDate()&&b.package().setPriceIndicationAsOfferTemplate(b.selectedOfferDate())},b.getPriceIndicationForOfferDates=function(){return b.package().priceIndicationList().find(function(a){
return a.arrivalDate()===b.package().offer().arrivalDate()&&a.departureDate()===b.package().offer().departureDate()})},b.indicationEditAllowed=ko.computed(function(){return!(!b.package()||b.showLoadingSpinner())&&(!b.isCustomer()&&b.package().status()===PACKAGE_STATUS_ENUM.OPEN)}),b.priceIndicationTableVisible=ko.computed(function(){return b.package()&&b.package().priceIndicationList().length>0}),b.indicationRefreshAllowed=ko.computed(function(){return!(!b.package()||b.showLoadingSpinner())&&(!b.isCustomer()&&(!!(b.priceIndicationTableVisible()&&b.orderItemGroups().length>0)&&(b.package().status()===PACKAGE_STATUS_ENUM.OPEN||b.package().status()===PACKAGE_STATUS_ENUM.INDICATED||b.package().status()===PACKAGE_STATUS_ENUM.PRICE_REQUESTED)))}),b.offerEditAllowed=ko.computed(function(){return!(!b.package()||!b.package().status())&&b.package().status()==PACKAGE_STATUS_ENUM.INDICATED}),b.offerPriceVisible=ko.computed(function(){return!(!b.package()||!b.package().status())&&(!b.isCustomer()||b.package().status().id>=PACKAGE_STATUS_ENUM.OFFERED.id)}),b.offerEditVisible=function(){return!(!b.package()||!b.package().status())&&(!b.isCustomer()&&!(b.package().status()==PACKAGE_STATUS_ENUM.INDICATED||b.package().status().id>=PACKAGE_STATUS_ENUM.INSTRUCTED.id))},b.serviceEditAllowed=ko.computed(function(){return!(!b.package()||b.showLoadingSpinner()||b.isCustomer())&&(b.package().status()==PACKAGE_STATUS_ENUM.OPEN||b.package().status()==PACKAGE_STATUS_ENUM.PRICE_REQUESTED)}),b.compensatoryServicesVisible=ko.computed(function(){if(!b.package()||!b.package().status())return!1;if(b.isCustomer())return!1;var a=!1;return b.orderItemGroups().forEach(function(c){c.status()===ORDER_STATUS_CANCELED&&b.package().status()==PACKAGE_STATUS_ENUM.BOOKED&&(a=!0)}),a}),b.nextStateBtnEnabled=ko.computed(function(){return!(!b.package()||b.showLoadingSpinner())&&(b.isCustomer()?b.package().status()==PACKAGE_STATUS_ENUM.INDICATED||b.package().status()==PACKAGE_STATUS_ENUM.OFFERED:(b.package().status()!=PACKAGE_STATUS_ENUM.OPEN||0!=b.package().priceIndicationList().length)&&(0!=b.orderItemGroups().length&&b.package().status()!=PACKAGE_STATUS_ENUM.CLOSED))}),b.previousStateBtnEnabled=ko.computed(function(){return!(!b.package()||!b.package().status()||b.showLoadingSpinner())&&(!b.isCustomer()&&(b.package().status()!=PACKAGE_STATUS_ENUM.OPEN&&!(b.package().status().id>=PACKAGE_STATUS_ENUM.BOOKED.id)))}),b.lastMinuteChangeVisible=ko.computed(function(){return!(!b.package()||!b.package().status()||b.showLoadingSpinner())&&(!b.isCustomer()&&b.package().status().id==PACKAGE_STATUS_ENUM.BOOKED.id)}),b.packageCancellationRequestVisible=ko.computed(function(){return!(!b.package()||b.showLoadingSpinner())&&(!b.package().cancellationRequested()&&b.package().status()==PACKAGE_STATUS_ENUM.PREBOOKED)}),b.packageCancellationResetVisible=ko.computed(function(){return!(!b.package()||b.showLoadingSpinner())&&(b.package().cancellationRequested()&&b.package().status()==PACKAGE_STATUS_ENUM.PREBOOKED)}),b.packageCancellationVisible=ko.computed(function(){return!(!b.package()||b.isCustomer())&&(b.package().cancellationRequested()&&b.package().status()==PACKAGE_STATUS_ENUM.PREBOOKED)}),b.packageDiscardVisible=ko.computed(function(){return!!b.package()&&(b.isCustomer()?b.package().status()==PACKAGE_STATUS_ENUM.INDICATED:b.package().status()==PACKAGE_STATUS_ENUM.INDICATED||b.package().status()==PACKAGE_STATUS_ENUM.INSTRUCTED)}),b.packageStateButtonsVisible=ko.computed(function(){return!!b.package()&&(!b.package().cancellationRequested()&&b.package().status()!=PACKAGE_STATUS_ENUM.CANCELED&&b.package().status()!=PACKAGE_STATUS_ENUM.CLOSED&&b.package().status()!=PACKAGE_STATUS_ENUM.DISCARDED)}),b.moreButtonEnabled=ko.computed(function(){return!b.loadingState()&&(!!b.isSeller()||(!!b.packageCancellationRequestVisible()||!!b.packageDiscardVisible()))}),b.voucherVisible=ko.computed(function(){return b.package()&&(b.package().status()==PACKAGE_STATUS_ENUM.BOOKED||b.package().status()==PACKAGE_STATUS_ENUM.CLOSED)}),b.invoiceVisible=ko.computed(function(){return b.package()&&(b.package().status()==PACKAGE_STATUS_ENUM.BOOKED||b.package().status()==PACKAGE_STATUS_ENUM.CLOSED)&&null!=b.package().invoicePdf()}),b.totalPriceVisible=ko.computed(function(){return b.package()&&b.package().status()!=PACKAGE_STATUS_ENUM.OPEN}),b.adjustmentVisible=ko.computed(function(){return b.package()&&(b.package().cancellationRequested()||b.package().status()==PACKAGE_STATUS_ENUM.CANCELED)}),b.adjustmentDisabled=ko.computed(function(){return!(b.package()&&!b.isCustomer())||b.package().status()==PACKAGE_STATUS_ENUM.CANCELED}),b.offerTableVisible=ko.computed(function(){return b.package()&&b.package().status()&&b.package().status().id>10}),this.totalPrice=ko.computed(function(){return b.package()&&b.package().amount()?b.package().amount():null});var m=function(){if(b.package()&&b.package().status()){switch(b.package().status()){case PACKAGE_STATUS_ENUM.OPEN:return PACKAGE_STATUS_ENUM.INDICATED;case PACKAGE_STATUS_ENUM.INDICATED:return PACKAGE_STATUS_ENUM.PRICE_REQUESTED;case PACKAGE_STATUS_ENUM.PRICE_REQUESTED:return PACKAGE_STATUS_ENUM.OFFERED;case PACKAGE_STATUS_ENUM.OFFERED:return PACKAGE_STATUS_ENUM.INSTRUCTED;case PACKAGE_STATUS_ENUM.INSTRUCTED:return PACKAGE_STATUS_ENUM.PREBOOKED;case PACKAGE_STATUS_ENUM.PREBOOKED:return b.package().cancellationRequested()?PACKAGE_STATUS_ENUM.CANCELED:PACKAGE_STATUS_ENUM.BOOKED;case PACKAGE_STATUS_ENUM.BOOKED:case PACKAGE_STATUS_ENUM.CLOSED:return PACKAGE_STATUS_ENUM.CLOSED}}},n=function(){if(b.package()&&b.package().status()){switch(b.package().status()){case PACKAGE_STATUS_ENUM.OPEN:case PACKAGE_STATUS_ENUM.INDICATED:return PACKAGE_STATUS_ENUM.OPEN;case PACKAGE_STATUS_ENUM.PRICE_REQUESTED:return PACKAGE_STATUS_ENUM.INDICATED;case PACKAGE_STATUS_ENUM.OFFERED:return PACKAGE_STATUS_ENUM.PRICE_REQUESTED;case PACKAGE_STATUS_ENUM.INSTRUCTED:return PACKAGE_STATUS_ENUM.OFFERED;case PACKAGE_STATUS_ENUM.PREBOOKED:return PACKAGE_STATUS_ENUM.INSTRUCTED;case PACKAGE_STATUS_ENUM.BOOKED:return PACKAGE_STATUS_ENUM.PREBOOKED;case PACKAGE_STATUS_ENUM.CLOSED:return PACKAGE_STATUS_ENUM.CLOSED}}},o=function(){if(b.package()&&b.package().status()){switch(b.package().status()){case PACKAGE_STATUS_ENUM.INDICATED:case PACKAGE_STATUS_ENUM.INSTRUCTED:return PACKAGE_STATUS_ENUM.DISCARDED}}};b.setPreviousState=function(){if(b.package()&&(b.setPackageToNextOrPreviousState(!1,!1),$("#previousStateBtn").blur()),b.package().status()==PACKAGE_STATUS_ENUM.PREBOOKED)for(var a=0;a<b.orderItemGroups().length;a++){var c=b.orderItemGroups()[a];c.status()==ORDER_STATUS_COMPLETE&&c.status(ORDER_STATUS_CONFIRMED)}},b.getNextStateBtnText=function(){var a=m();if(a){var b="packages.details.btn."+a.name;return i18n.t(b)}},b.nextState=function(){if(b.package()){m()&&b.setPackageToNextOrPreviousState(!0,!1),$("#nextStateBtn").blur()}},b.discardPackage=function(){if(b.package()){o()&&b.setPackageToNextOrPreviousState(!0,!0),$("#nextStateBtn").blur()}},b.statePassed=function(a){if(b.package()&&b.package().status()){return b.package().status().id>=a.id}return!1},b.isLastState=function(a){return a==PACKAGE_STATUS_ENUM.CLOSED||a==PACKAGE_STATUS_ENUM.CANCELED||a==PACKAGE_STATUS_ENUM.DISCARDED},b.backToOverview=function(){window.location.href="#packages"},b.selectedTimeRangeValid=function(){if(void 0!==b.newPriceIndicationFrom()&&""!==b.newPriceIndicationFrom()&&void 0!==b.newPriceIndicationTo()&&""!==b.newPriceIndicationTo()){$("#fromDatePicker").parsley().validate(),$("#toDatePicker").parsley().validate();var a="D.M.YYYY";"dd.mm.yy"!==DATE_PICKER_FORMAT&&(a="M/D/YYYY");var c=moment(b.newPriceIndicationFrom(),a,!0).isValid(),d=moment(b.newPriceIndicationTo(),a,!0).isValid();if(c&&d){if($.datepicker.parseDate(DATE_PICKER_FORMAT,b.newPriceIndicationFrom())<=$.datepicker.parseDate(DATE_PICKER_FORMAT,b.newPriceIndicationTo()))return!0}return!1}return!1},b.showIndicationDatePicker=function(){$("#addIndicationBtn").css("display","none"),$("#priceIndicationDatePicker").fadeIn()},b.addPriceIndication=function(){if(b.selectedTimeRangeValid()){var a=b.package().getEmptyPriceIndicationJson();a.arrivalDate=b.newPriceIndicationFrom(),a.departureDate=b.newPriceIndicationTo(),a.packageId=b.package().id(),a.orderId=b.package().orderId();var c=function(){b.newPriceIndicationTo(void 0),b.newPriceIndicationFrom(void 0),$("#priceIndicationDatePicker").css("display","none"),$("#addIndicationBtn").fadeIn(),b.refreshPriceIndication()};b.createPriceIndication(a,c)}},b.cancelAddPriceIndication=function(){b.newPriceIndicationTo(void 0),b.newPriceIndicationFrom(void 0),$("#fromDatePicker").removeClass("parsley-error"),$("#toDatePicker").removeClass("parsley-error"),$("#priceIndicationDatePicker").css("display","none"),$("#addIndicationBtn").fadeIn(),$("#priceindication-parsley-error > ul").remove()},b.enableOfferPersonInput=function(a,b){var c=ko.contextFor(b.target),d=c.$index();$("#quantityInput_"+d).attr("disabled",!1),$("#quantityInput_"+d).focus()},b.loadOrder=function(a,c){b.processingOrder(!0);var d=0;b.package()&&b.package().orderId()&&(d=b.package().orderId()),$.ajax(serviceRootURL+"/orders/"+d,{type:"GET",data:{consumptionCheck:!1,restrictStates:!1,bundleMode:PARAMKEY_GETORDER_BUNDLEMODE_PACKAGE_INFO,packageId:a,orderType:ORDER_TYPE_PACKAGE_ORDER},dataType:"json",contentType:"application/json",success:function(e,f,g){console.log("Order "+d+" for package loaded: ",e,a),c&&"function"==typeof c&&c(),b.processingOrder(!1),b.mapJsonToOrder(e,b.order,b.orderItemGroups)},error:function(a,c,d){console.log("Server error on loading order: "+a.responseText),b.processingOrder(!1)}})},$("body").click(function(a){var b=$(a.target);if(b.hasClass("order-action-link"))$(".dropdown-menu").hide();else{if(b.closest(".dropdown").length>0)return;$(".dropdown-menu").hide()}}),b.loadAdditionalOrder=function(){null!=b.package().additionalOrderId()&&(b.processingAdditionalOrder(!0),$.ajax(serviceRootURL+"/orders/"+b.package().additionalOrderId(),{type:"GET",data:{consumptionCheck:!1,restrictStates:!1,bundleMode:PARAMKEY_GETORDER_BUNDLEMODE_PACKAGE_INFO},dataType:"json",contentType:"application/json",success:function(a,c,d){console.log("Additional order for package "+b.package().id()+" loaded: ",a),b.processingAdditionalOrder(!1),b.mapJsonToOrder(a,b.additionalOrder,b.additionalOrderItemGroups)},error:function(a,c,d){console.log("Server error on loading additional order: "+a.responseText),b.processingAdditionalOrder(!1)}}))},b.loadOptionalOrder=function(a){if(null!=b.package().optionalOrderId())return b.processingOptionalOrder(!0),$.ajax(serviceRootURL+"/orders/"+b.package().optionalOrderId(),{type:"GET",data:{consumptionCheck:!1,restrictStates:!1,bundleMode:PARAMKEY_GETORDER_BUNDLEMODE_PACKAGE_INFO},dataType:"json",contentType:"application/json",success:function(d,e,f){console.log("Optional order for package "+b.package().id()+" loaded: ",d),b.processingOptionalOrder(!1),b.mapJsonToOrder(d,b.optionalOrder,b.optionalOrderItemGroups),a&&b.loadPackageById(b.package().id(),c.ORDERS,function(){b.loadOrder(),b.loadAdditionalOrder()})},error:function(a,c,d){console.log("Server error on loading optional order: "+a.responseText),b.processingOptionalOrder(!1)}})},b.mapJsonToOrder=function(a,c,d){var e=new Map;if(d().forEach(function(a){var b=a.productKey()+"_"+a.date()+"_"+a.toDate();e.set(b,a.groupExpanded())}),d.removeAll(),a&&a.orderItems.length>0){c(new orderModel(a)),c().setOrderItems(a);for(var f=0;f<c().orderItems().length;f++){var g=c().orderItems()[f];if(g.categoryKey()!==CATEGORY_KEY_SUBSERVICE){var h=ko.utils.arrayFirst(d(),function(a){return a.matches(g)});if(!h){var i=!0,j=g.productKey()+"_"+g.date()+"_"+g.toDate();g.categoryKey()==CATEGORY_KEY_HOTEL&&(j+="_"+g.accommRateTypeName()),e.has(j)&&(i=e.get(j)),h=new PackageOrderItemGroupViewModel(g,i),d.push(h)}h&&!1!==h&&(g.type()==ORDER_ITEM_TYPE_PACKAGE_SUBGRP?h.subgroups.push(new PackageOrderItemSubGroupViewModel(h,g)):h.items.push(g))}}for(var f=0;f<c().orderItems().length;f++){var g=c().orderItems()[f];if(g.categoryKey()===CATEGORY_KEY_SUBSERVICE){var h=ko.utils.arrayFirst(d(),function(a){return a.hasSubservice(g)});h&&!1!==h&&(g.type()==ORDER_ITEM_TYPE_PACKAGE_SUBSERVICE?h.subgroups.push(new PackageOrderItemSubServiceViewModel(h,g)):h.items.push(g))}}}else c(new orderModel(a)),c()&&c().type()==ORDER_TYPE_PACKAGE_ORDER&&b.refreshPriceIndication()},b.loadCompensatoryOrder=function(){null!=b.package().compensatoryOrderId()&&(b.processingCompensatoryOrder(!0),$.ajax(serviceRootURL+"/orders/"+b.package().compensatoryOrderId(),{type:"GET",data:{consumptionCheck:!1,restrictStates:!1,bundleMode:PARAMKEY_GETORDER_BUNDLEMODE_PACKAGE_INFO},dataType:"json",contentType:"application/json",success:function(a,c,d){b.processingCompensatoryOrder(!1),b.mapJsonToOrder(a,b.compensatoryOrder,b.compensatoryOrderItemGroups)},error:function(a,c,d){console.log("Server error on loading compensatory order: "+a.responseText),b.processingCompensatoryOrder(!1)}}))},b.validateCompensatoryServices=function(a){for(var c=0;c<a.length;c++){var d=a[c];if(d.price().categoryKey()==CATEGORY_KEY_HOTEL)return showInfo(i18n.t("packages.msg.hotelsNotAllowedForCompensatoryOrders")),!1;if(b.compensatoryOrder&&b.compensatoryOrder()&&b.compensatoryOrder().orderItems)for(var e=0;e<b.compensatoryOrder().orderItems().length;e++)if(b.compensatoryOrder().orderItems()[e].productKey()==d.price().productKey()&&b.compensatoryOrder().orderItems()[e].date()==d.price().date()&&b.compensatoryOrder().orderItems()[e].status()==ORDER_STATUS_COMPLETE)return showInfo(i18n.t("packages.msg.productAlreadyIncludedWithinCompensatoryOrder",{productKey:d.price().productKey(),date:d.price().date()})),!1}return!0},b.createOrderItemJson=function(a,c){var d={};if(void 0!==b.order()){var e=b.order().orderItems();for(var f in e){var g=e[f];g.consumerKey&&g.consumerKey()&&(d[g.consumerKey()]=g.quantity())}}for(var f=0;f<a.length;f++){var h=a[f],i=ORDER_ITEM_TYPE_PACKAGE_ITEM;if(h.price().categoryKey()==CATEGORY_KEY_HOTEL){i=ORDER_ITEM_TYPE_PACKAGE_SUBGRP;for(var j="GRP"==h.price().specificAttributes.accommRateTypeKey(),k=1;k<=3;k++){var l=h.price().specificAttributes.accommRateTypeKey()+"."+k,m=JSON.parse(JSON.stringify(h.price().getSpecificAttributes()));m.occupancy=k,m.accommRateTypeKey=h.price().specificAttributes.accommRateTypeKey();var n=1==k?h.price().singleRoomPrice():2==k?2*h.price().doubleRoomPrice():3==k?3*h.price().tripleRoomPrice():null,o={type:i,ticketNr:k,price:n,sku:h.price().sku(),consumerKey:l,categoryKey:h.categoryKey(),timeRangeId:h.price().timeRangeId(),timeRangeKey:h.price().timeRangeKey(),reductionLevel:h.price().reductionLevel(),rebateRuleId:h.price().rebateRuleId(),crossSeason:h.price().crossSeason(),productKey:h.price().productKey(),date:h.price().date(),quantity:l in d?d[l]:h.quantity(),amount:h.quantity()*n,media:"voucher",specificAttributes:m};if(h.parentEntry()&&(o.refItemId=h.parentEntry().internalId()),c.orderItems.push(o),1==k&&j){var p=JSON.parse(JSON.stringify(o));p.specificAttributes.accommRateTypeKey="FRE";var l="FRE.1";p.consumerKey=l,c.orderItems.push(p)}console.log("create orderitem json",o)}}else{var o={type:i,ticketNr:h.internalId(),price:h.price().price(),sku:h.price().sku(),consumerKey:h.price().consumerKey(),categoryKey:h.categoryKey(),timeRangeId:h.price().timeRangeId(),timeRangeKey:h.price().timeRangeKey(),reductionLevel:h.price().reductionLevel(),rebateRuleId:h.price().rebateRuleId(),crossSeason:h.price().crossSeason(),productKey:h.price().productKey(),date:h.price().date(),quantity:h.quantity(),amount:h.quantity()*h.price(),media:"voucher",specificAttributes:h.price().getSpecificAttributes()};h.parentEntry()&&(o.refItemId=h.parentEntry().internalId()),c.orderItems.push(o)}}},b.updateOrder=function(a){console.log("UpdateOrder",a),$.ajax(serviceRootURL+"/orders/"+b.package().orderId(),{type:"PUT",data:JSON.stringify(a),dataType:"json",contentType:"application/json",success:function(a,c,d){b.processingOrder(!1),b.priceIndicationOutdated(!0),b.servicesOrderItemsChanged(!0),b.package().orderId(a.id),console.log("order created (id="+a.id+")"),b.loadOrder(),null!=shoppingcartVM&&shoppingcartVM.reset()},error:function(a,c,d){b.processingOrder(!1),console.log("Server error on creating order:\n"+a.responseText),b.loadOrder(),showError("Fehler beim Laden der Bestellungen",a,c,d)}})},b.updateAdditionalOrder=function(a){console.log("updateAdditionalOrder",a),$.ajax(serviceRootURL+"/orders/"+b.package().additionalOrderId(),{type:"PUT",data:JSON.stringify(a),dataType:"json",contentType:"application/json",success:function(a,c,d){b.processingAdditionalOrder(!1),console.log("additional order updated (id="+a.id+")"),b.loadAdditionalOrder(),null!=shoppingcartVM&&shoppingcartVM.reset()},error:function(a,c,d){b.processingAdditionalOrder(!1),console.log("Server error on creating order:\n"+a.responseText),b.loadAdditionalOrder(),showError("Fehler beim Laden der Bestellungen",a,c,d)}})},b.updateOptionalOrder=function(a){console.log("updateOptionalOrder",a),$.ajax(serviceRootURL+"/orders/"+b.package().optionalOrderId(),{type:"PUT",data:JSON.stringify(a),dataType:"json",contentType:"application/json",success:function(a,c,d){b.processingOptionalOrder(!1),b.package().optionalOrderId(a.id),console.log("optional order created (id="+a.id+")"),b.loadOptionalOrder(!0),null!=shoppingcartVM&&shoppingcartVM.reset()},error:function(a,c,d){b.processingOptionalOrder(!1),console.log("Server error on creating order:\n"+a.responseText),b.loadOptionalOrder(!0),showError("Fehler beim Laden der Bestellungen",a,c,d)}})},b.addServices=function(a){if(null!=a&&0!=a.length){b.processingOrder(!0);var c={packageId:b.package().id(),id:b.package().orderId(),paymentType:PAYMENTTYPE_INVOICE,type:ORDER_TYPE_PACKAGE_ORDER,orderItems:[]};b.createOrderItemJson(a,c),b.updateOrder(c)}},b.addAdditionalServices=function(a){if(console.log("adding additional services"),null!=a&&0!=a.length){b.processingAdditionalOrder(!0);var c="POST",d="/orders";null!=b.package().additionalOrderId()&&(c="PUT",d+="/"+b.package().additionalOrderId());var e={packageId:b.package().id(),id:b.package().additionalOrderId(),paymentType:PAYMENTTYPE_INVOICE,type:ORDER_TYPE_PACKAGE_ADDITIONAL_ORDER,orderItems:[]};b.createOrderItemJson(a,e),$.ajax(serviceRootURL+d,{type:c,data:JSON.stringify(e),dataType:"json",contentType:"application/json",success:function(a,c,d){b.processingAdditionalOrder(!1),b.package().additionalOrderId(a.id),b.updatePackage(),console.log("order created (id="+a.id+")"),b.loadPackageById(b.package().id()),b.loadAdditionalOrder(),null!=shoppingcartVM&&shoppingcartVM.reset()},error:function(a,c,d){b.processingAdditionalOrder(!1),console.log("Server error on creating additional order:\n"+a.responseText),b.loadPackageById(b.package().id()),b.loadAdditionalOrder(),showError("Fehler beim Laden der Zusatzleistungen",a,c,d)}})}},b.addOptionalServices=function(a){if(console.log("adding optional services"),null!=a&&0!=a.length){b.processingOptionalOrder(!0);var c="POST",d="/orders";null!=b.package().optionalOrderId()&&(c="PUT",d+="/"+b.package().optionalOrderId());var e={packageId:b.package().id(),id:b.package().optionalOrderId(),paymentType:PAYMENTTYPE_INVOICE,type:ORDER_TYPE_PACKAGE_OPTIONAL_ORDER,orderItems:[]};b.createOrderItemJson(a,e),$.ajax(serviceRootURL+d,{type:c,data:JSON.stringify(e),dataType:"json",contentType:"application/json",success:function(a,c,d){b.processingOptionalOrder(!1),b.package().optionalOrderId(a.id),console.log("order created (id="+a.id+")"),b.loadOptionalOrder(!1),null!=shoppingcartVM&&shoppingcartVM.reset()},error:function(a,c,d){b.processingOptionalOrder(!1),console.log("Server error on creating optional order:\n"+a.responseText),b.loadPackageById(b.package().id()),b.loadOptionalOrder(!0),showError("Fehler beim Laden der Zusatzleistungen",a,c,d)}})}},b.updateAdditionalServices=function(a){if(null==b.package().additionalOrderId()||null==b.additionalOrder()||0==b.additionalOrder().orderItems().length)return void(a&&a());b.processingAdditionalOrder(!0);for(var c="/orders/"+b.package().additionalOrderId(),d={packageId:b.package().id(),id:b.package().additionalOrderId(),paymentType:PAYMENTTYPE_INVOICE,type:ORDER_TYPE_PACKAGE_ADDITIONAL_ORDER,orderItems:[]},e=0;e<b.additionalOrder().orderItems().length;e++){var f=b.additionalOrder().orderItems()[e],g={id:f.id(),sku:f.sku(),productKey:f.productKey(),consumerKey:f.consumerKey(),price:f.price(),quantity:f.quantity(),amount:f.quantity()*f.price(),date:f.date(),toDate:f.toDate(),startTime:f.startTime(),startTimeTba:f.startTimeTba()};d.orderItems.push(g)}$.ajax(serviceRootURL+c,{type:"PUT",data:JSON.stringify(d),dataType:"json",contentType:"application/json",success:function(c,d,e){b.processingAdditionalOrder(!1),b.loadAdditionalOrder(),a()},error:function(a,c,d){b.processingAdditionalOrder(!1),console.log("Server error on creating additional order:\n"+a.responseText),b.loadPackageById(b.package().id()),b.loadAdditionalOrder(),showError("Fehler beim Laden der Zusatzleistungen",a,c,d)}})},b.updateOptionalServices=function(a){if(null==b.package().optionalOrderId()||null==b.optionalOrder()||0==b.optionalOrder().orderItems().length)return void a();b.processingOptionalOrder(!0);for(var c="/orders/"+b.package().optionalOrderId(),d={packageId:b.package().id(),id:b.package().optionalOrderId(),paymentType:PAYMENTTYPE_INVOICE,type:ORDER_TYPE_PACKAGE_OPTIONAL_ORDER,orderItems:[]},e=0;e<b.optionalOrder().orderItems().length;e++){var f=b.optionalOrder().orderItems()[e],g={id:f.id(),sku:f.sku(),productKey:f.productKey(),consumerKey:f.consumerKey(),price:f.price(),quantity:f.quantity(),amount:f.quantity()*f.price(),date:f.date(),toDate:f.toDate()};d.orderItems.push(g)}$.ajax(serviceRootURL+c,{type:"PUT",data:JSON.stringify(d),dataType:"json",contentType:"application/json",success:function(c,d,e){b.processingOptionalOrder(!1),b.loadOptionalOrder(!0),a()},error:function(a,c,d){b.processingOptionalOrder(!1),console.log("Server error on creating optional order:\n"+a.responseText),b.loadPackageById(b.package().id()),b.loadOptionalOrder(!0),showError("Fehler beim Laden der Zusatzleistungen",a,c,d)}})},b.addCompensatoryServices=function(a){if(console.log("adding compensatory services"),!b.validateCompensatoryServices(a))return!1;if(null!=a&&0!=a.length){b.processingCompensatoryOrder(!0);var c="POST",d="/orders";null!=b.package().compensatoryOrderId()&&(c="PUT",d+="/"+b.package().compensatoryOrderId());var e={packageId:b.package().id(),id:b.package().compensatoryOrderId(),paymentType:PAYMENTTYPE_INVOICE,type:ORDER_TYPE_PACKAGE_COMPENSATORY_ORDER,orderItems:[]};b.createOrderItemJson(a,e),$.ajax(serviceRootURL+d,{type:c,data:JSON.stringify(e),dataType:"json",contentType:"application/json",success:function(a,c,d){b.processingCompensatoryOrder(!1),b.package().compensatoryOrderId(a.id),console.log("order created (id="+a.id+")"),b.loadPackageById(b.package().id()),b.loadCompensatoryOrder(),null!=shoppingcartVM&&shoppingcartVM.reset()},error:function(a,c,d){b.processingCompensatoryOrder(!1),console.log("Server error on creating compensatory order:\n"+a.responseText),b.loadPackageById(b.package().id()),b.loadCompensatoryOrder(),showError("Fehler beim Laden der Zusatzleistungen",a,c,d)}})}},b.reloadOrder=function(a){console.log("reloadOrder callback"),b.loadPackageById(b.package().id(),c.OVERVIEW),a==ORDER_TYPE_PACKAGE_ORDER?(b.priceIndicationOutdated(!0),b.servicesOrderItemsChanged(!0),b.processingOrder(!1),b.loadOrder()):a==ORDER_TYPE_PACKAGE_ADDITIONAL_ORDER?(b.processingAdditionalOrder(!1),b.loadAdditionalOrder()):a==ORDER_TYPE_PACKAGE_OPTIONAL_ORDER?(b.processingOptionalOrder(!1),b.loadOptionalOrder(!0)):a==ORDER_TYPE_PACKAGE_COMPENSATORY_ORDER&&(b.processingCompensatoryOrder(!1),b.loadCompensatoryOrder())},b.deleteOrderItem=function(a,c){return c==ORDER_TYPE_PACKAGE_ORDER?b.processingOrder(!0):c==ORDER_TYPE_PACKAGE_ADDITIONAL_ORDER?b.processingAdditionalOrder(!0):c==ORDER_TYPE_PACKAGE_OPTIONAL_ORDER?b.processingOptionalOrder(!0):c==ORDER_TYPE_PACKAGE_COMPENSATORY_ORDER&&b.processingCompensatoryOrder(!0),console.log("Deleting item",a.id(),a.productKey()),$.ajax({url:serviceRootURL+"/order_items/"+a.id(),type:"DELETE",data:JSON.stringify({packageId:b.package().id(),id:a.id()}),contentType:"application/json"})},b.bookServices=function(a){for(var c=0;c<b.orderItemGroups().length;c++){var d=b.orderItemGroups()[c];d.status()==ORDER_STATUS_ERROR&&(d.error(""),d.status(ORDER_STATUS_CONFIRMED))}for(var c=0;c<b.additionalOrderItemGroups().length;c++){var d=b.additionalOrderItemGroups()[c];d.status()==ORDER_STATUS_ERROR&&(d.error(""),d.status(ORDER_STATUS_CONFIRMED))}b.performBookServices(a)},b.performBookServices=function(a){for(var c=0;c<b.orderItemGroups().length;c++){var d=b.orderItemGroups()[c];if(d.status()==ORDER_STATUS_CONFIRMED)return void b.bookOrderItemGroup(d,!1,a)}for(var c=0;c<b.additionalOrderItemGroups().length;c++){var d=b.additionalOrderItemGroups()[c];if(d.status()==ORDER_STATUS_CONFIRMED)return void b.bookOrderItemGroup(d,!1,a)}var e=ko.utils.arrayFilter(b.orderItemGroups(),function(a){return a.status()==ORDER_STATUS_ERROR});null!=e&&e.length>0?showError(i18n.t("packages.msg.errorBookOrderItems",{errorCount:e.length,totalCount:b.orderItemGroups().length})):a&&"function"==typeof a&&a()},b.bookOrderItemGroup=function(a,c,d){console.log("book order item group : "+a.idFilter()+", standalone: "+c),j(!0,!0),a.error(""),$.ajax(serviceRootURL+"/packages_process_order_items",{type:"GET",data:{ids:a.idFilter(),action:"book"},dataType:"json",contentType:"application/json",success:function(e,f,g){console.log("book order item group result retrieved: "+e),a.status(ORDER_STATUS_COMPLETE),a.items().forEach(function(a){a.status(ORDER_STATUS_COMPLETE)}),c?(j(!1,!0),b.processingOrder(!1),b.processingAdditionalOrder(!1),b.processingCompensatoryOrder(!1)):b.performBookServices(d)},error:function(e,f,g){console.log("error on booking order item group"),checkSession(e),a.error("Unerwarteter Fehler beim Buchen des Tickets: "+b.getError(e,f,g)),a.status(ORDER_STATUS_ERROR),c?(j(!1,!0),b.processingOrder(!1),b.processingAdditionalOrder(!1),b.processingCompensatoryOrder(!1)):b.performBookServices(d)}})},b.itemMoveCallback=function(){console.log("itemMoveCallback"),b.loadOrder(),b.package().status()==PACKAGE_STATUS_ENUM.OPEN?b.refreshPriceIndication():(b.priceIndicationOutdated(!0),h())},b.cancelServices=function(a){b.performCancelServices(a)},b.performCancelServices=function(a){for(var c=0;c<b.orderItemGroups().length;c++){var d=b.orderItemGroups()[c];if(d.status()==ORDER_STATUS_CONFIRMED)return void b.cancelOrderItemGroup(d,!1,a)}for(var c=0;c<b.additionalOrderItemGroups().length;c++){var d=b.additionalOrderItemGroups()[c];if(d.status()==ORDER_STATUS_CONFIRMED)return void b.cancelOrderItemGroup(d,!1,a)}var e=ko.utils.arrayFilter(b.orderItemGroups(),function(a){return a.status()==ORDER_STATUS_ERROR});null!=e&&e.length>0?(showError(i18n.t("packages.msg.errorCancelOrderItems",{errorCount:e.length,totalCount:b.orderItemGroups().length})),b.loadOrder(b.package().id(),null),b.loadAdditionalOrder()):a&&"function"==typeof a&&a()},b.cancelOrderItemGroup=function(a,c,d){return console.log("cancel order item group : "+a.idFilter()+", standalone: "+c,a),j(!0,!0),a.error(""),$.ajax(serviceRootURL+"/packages_process_order_items",{type:"GET",data:{ids:a.idFilter(),action:"cancel",singleItem:c},dataType:"json",contentType:"application/json",success:function(e,f,g){j(!1,!0),a.status(ORDER_STATUS_CANCELED),a.items().forEach(function(a){a.status(ORDER_STATUS_CANCELED)}),c?(b.processingOrder(!1),b.processingAdditionalOrder(!1),b.processingCompensatoryOrder(!1)):b.performCancelServices(d)},error:function(e,f,g){console.log("error on cancelling order item group"),j(!1,!0),checkSession(e),a.error("Unerwarteter Fehler beim Stornieren des Tickets: "+b.getError(e,f,g)),a.status(ORDER_STATUS_ERROR),c?(b.loadOrder(b.package().id(),null),b.loadAdditionalOrder(),b.processingCompensatoryOrder(!1)):b.performCancelServices(d)}})},b.cancelOrderItem=function(a){return console.log("cancel order item : "+a),j(!0,!0),$.ajax(serviceRootURL+"/packages_process_order_items",{type:"GET",data:{ids:a,action:"cancel"},dataType:"json",contentType:"application/json",success:function(a,c,d){j(!1,!0),b.processingOrder(!1),b.processingAdditionalOrder(!1),b.processingCompensatoryOrder(!1)},error:function(a,c,d){console.log("error on cancelling order item"),j(!1,!0),checkSession(a),b.loadOrder(b.package().id(),null),b.loadAdditionalOrder(),b.processingCompensatoryOrder(!1)}})},b.discardServices=function(a){for(var c=0;c<b.orderItemGroups().length;c++){var d=b.orderItemGroups()[c];if(d.status()!=ORDER_STATUS_COMPLETE&&d.status()!=ORDER_STATUS_DISCARDED)return void b.discardOrderItemGroup(d,!1,a)}for(var c=0;c<b.additionalOrderItemGroups().length;c++){var d=b.additionalOrderItemGroups()[c];if(d.status()!=ORDER_STATUS_COMPLETE&&d.status()!=ORDER_STATUS_DISCARDED)return void b.discardOrderItemGroup(d,!1,a)}var e=ko.utils.arrayFilter(b.orderItemGroups(),function(a){return a.status()==ORDER_STATUS_ERROR});null!=e&&e.length>0?(showError(i18n.t("packages.msg.errorDiscardOrderItems",{errorCount:e.length,totalCount:b.orderItemGroups().length})),b.loadOrder(b.package().id(),null),b.loadAdditionalOrder()):a&&"function"==typeof a&&a()},b.discardOrderItemGroup=function(a,c,d){console.log("discard order item group : "+a.idFilter()+", standalone: "+c),j(!0,!0),a.error(""),$.ajax(serviceRootURL+"/packages_process_order_items",{type:"GET",data:{ids:a.idFilter(),action:"discard",singleItem:c},dataType:"json",contentType:"application/json",success:function(e,f,g){console.log("discard order item group result retrieved: "+e),j(!1,!0),a.status(ORDER_STATUS_DISCARDED),a.items().forEach(function(a){a.status(ORDER_STATUS_DISCARDED)}),c||b.discardServices(d)},error:function(e,f,g){console.log("error on discarding order item group"),j(!1,!0),checkSession(e),a.error("Unerwarteter Fehler beim Verwerfen des Tickets: "+b.getError(e,f,g)),a.status(ORDER_STATUS_ERROR),c?(b.loadOrder(b.package().id(),null),b.loadAdditionalOrder()):b.discardServices(d)}})},b.getError=function(a,b,c){var d="";if(-1!=getErrorCode(a)){var e=$.parseJSON(a.responseText);d=e.message+" (code: "+e.code+")"}else d=a.responseText;return d},b.compareOrderItemSubGroups=function(a,b){return a.groupItem().categoryKey()==CATEGORY_KEY_SUBSERVICE?1:b.groupItem().categoryKey()==CATEGORY_KEY_SUBSERVICE?-1:a.groupItem().consumerKey().indexOf("FRE")>=0?1:b.groupItem().consumerKey().indexOf("FRE")>=0?-1:a.groupItem().occupancy()<b.groupItem().occupancy()?-1:1},b.compareOrderItems=function(a,b){if(a.price()==b.price()){if(a.consumerKey()&&b.consumerKey())if("PUBLICTRANSPORTATION"==a.categoryKey()){if(a.consumerKey().indexOf(".free")>=0)return 1;if(a.consumerKey().indexOf(".child")>=0&&b.consumerKey().indexOf(".kid")>=0)return-1;if(b.consumerKey().indexOf(".child")>=0&&a.consumerKey().indexOf(".kid")>=0)return 1;if(b.consumerKey().indexOf(".kid")>=0)return-1}else{if(a.consumerKey().indexOf("ADULT")>=0)return-1;if(b.consumerKey().indexOf("ADULT")>=0)return 1;if(a.consumerKey().indexOf("CHILD")>=0&&b.consumerKey().indexOf("PICCOLO")>=0)return-1;if(b.consumerKey().indexOf("CHILD")>=0&&a.consumerKey().indexOf("PICCOLO")>=0)return 1;if(a.consumerKey().indexOf("PICCOLO")>=0&&(b.consumerKey().indexOf("FRE")>=0||b.consumerKey().indexOf("FREE")>=0))return-1;if(b.consumerKey().indexOf("PICCOLO")>=0&&(a.consumerKey().indexOf("FRE")>=0||a.consumerKey().indexOf("FREE")>=0))return 1}if(a.productName&&b.productName())return a.productName()>b.productName()?1:-1}return a.price()<b.price()?1:-1},b.compareOrderItemGroups=function(a,b){
return b.categoryKey()==CATEGORY_KEY_MARGIN&&a.categoryKey()==CATEGORY_KEY_MARGIN?"B2B.PACKAGE.MARGIN.GENERAL"==b.productKey()?1:-1:a.categoryKey()==CATEGORY_KEY_MARGIN?1:b.categoryKey()==CATEGORY_KEY_MARGIN?-1:moment(a.date()).isSame(moment(b.date()))?a.categoryName()>b.categoryName()?1:-1:moment(a.date()).isAfter(moment(b.date()))?1:-1},b.openShop=function(a){if(a==SHOPPING_CART_MODE_PACKAGE&&b.processingOrder()&&a==SHOPPING_CART_MODE_PACKAGE_ADDITIONAL&&b.processingAdditionalOrder()&&a==SHOPPING_CART_MODE_PACKAGE_OPTIONAL&&b.processingOptionalOrder()&&a==SHOPPING_CART_MODE_PACKAGE_COMPENSATORY&&b.processingCompensatoryOrder())return!1;shoppingcartVM&&shoppingcartVM.reset(),menuVM.cartMode(a),menuVM.cartCallbackId(b.package().id());var c=new Set,d=b.package().plannedArrivalDate(),e=b.package().plannedDepartureDate();b.package().priceIndicationList().length>0&&(d=b.package().priceIndicationList()[0].arrivalDate(),e=b.package().priceIndicationList()[0].departureDate());for(var f=new Date(d);f<=new Date(e);f.setDate(f.getDate()+1))c.add(moment(f).format(MOMENTJS_DATE_SERVER_FORMAT));menuVM.timeIntervalDays(Array.from(c)),null!=categoriesVM&&Object.keys(categoriesVM).forEach(function(a){var b=categoriesVM[a];ko.isObservable(b)&&b()&&b().hasOwnProperty("adjustMinMaxDatesForPackageMode")&&b().adjustMinMaxDatesForPackageMode()}),showShop()},b.deletePriceIndication=function(a,c){var d=b.package().priceIndicationList.indexOf(a);d>=0&&(b.processingPriceIndication(!0),console.log("Deleting price indication",a),$.ajax(serviceRootURL+"/packages/price_indications/"+a.id(),{type:"DELETE",data:JSON.stringify(a),dataType:"json",contentType:"application/json",success:function(a,c,e){console.log("delete price indication finished: ",a),b.package().priceIndicationList.splice(d,1),b.processingPriceIndication(!1)},error:function(c,d,e){showError("Fehler beim laden der Angebote",c,d,e),console.log("delete price indication failed: ",a,e),b.processingPriceIndication(!1)}}))},b.deleteOffer=function(a){b.processingOffer(!0),console.log("Deleting offer",a),$.ajax(serviceRootURL+"/packages/offer/"+a,{type:"DELETE",data:JSON.stringify({id:a}),dataType:"json",contentType:"application/json",success:function(a,c,d){b.package().setOffer(void 0),console.log("delete offer finished: ",a)},error:function(a,c,d){showError("Fehler beim Löschen des Angebotes",a,c,d),console.log("delete offer failed: ",d),b.processingOffer(!1)}})},b.getTranslatedConsumerKey=function(a){var b="packages.consumerKey.";return ko.isObservable(a)?b+=a():b+=a,i18n.t(b)},b.toggleDropDown=function(){document.getElementById("moreActions").classList.toggle("show")},b.toFormattedCurrency=function(a){if(ko.isObservable(a)){if(void 0!==a()&&null!==a())return a().toFixed(2)+" "+currency()}else if(void 0!==a&&null!==a)return a.toFixed(2)+" "+currency();return i18n.t("packages.details.notAvailable")},b.dateFromPassed=function(a){var b=moment(a.arrivalDate,"YYYY-MM-DD");if(moment().diff(b,"days")>0)return!0},window.onclick=function(a){if(!a.target.matches(".dropbtn")){var b,c=document.getElementsByClassName("dropdown-content");for(b=0;b<c.length;b++){var d=c[b];d.classList.contains("show")&&d.classList.remove("show")}}},b.stateSteps=ko.computed(function(){var a=new Array;if(null!=b.package&&null!=b.package()&&null!=b.package().status()&&null!=b.package().cancellationRequested())for(var c in PACKAGE_STATUS_ENUM)if(PACKAGE_STATUS_ENUM.hasOwnProperty(c)&&"function"!=typeof PACKAGE_STATUS_ENUM[c]&&"UNKNOWN"!==c){var d=PACKAGE_STATUS_ENUM[c];b.package().cancellationRequested()||b.package().status()==PACKAGE_STATUS_ENUM.CANCELED?d!==PACKAGE_STATUS_ENUM.BOOKED&&d!==PACKAGE_STATUS_ENUM.CLOSED&&d!==PACKAGE_STATUS_ENUM.DISCARDED&&a.push(d):b.package().status()==PACKAGE_STATUS_ENUM.DISCARDED&&b.package().previousStatus()==PACKAGE_STATUS_ENUM.INDICATED?d!=PACKAGE_STATUS_ENUM.OPEN&&d!==PACKAGE_STATUS_ENUM.INDICATED&&d!==PACKAGE_STATUS_ENUM.DISCARDED||a.push(d):b.package().status()==PACKAGE_STATUS_ENUM.DISCARDED&&b.package().previousStatus()==PACKAGE_STATUS_ENUM.INSTRUCTED?d!==PACKAGE_STATUS_ENUM.PREBOOKED&&d!==PACKAGE_STATUS_ENUM.BOOKED&&d!==PACKAGE_STATUS_ENUM.CANCELED&&d!==PACKAGE_STATUS_ENUM.CLOSED&&a.push(d):d!==PACKAGE_STATUS_ENUM.CANCELED&&d!==PACKAGE_STATUS_ENUM.DISCARDED&&a.push(d)}return a}),b.loadPackageById(a),b.startPdfVoucher=function(){b.package()&&(console.log("print voucher for package: "+b.package().id()),url="/print_package_voucher?packageId="+b.package().id()+"&download=true",window.location=url)},b.startDownloadPdfInvoice=function(){b.package()&&(b.package().invoicePdf()?(console.log("print invoice for package: "+b.package().id()),url="/print_package_invoice?packageId="+b.package().id()+"&download=false",window.open(url,"_blank","toolbar=no, location=no, status=no, scrollbars=yes, resizable=yes")):showInfo(i18n.t("packages.msg.noInvoiceYetAvailable")))},b.startSendPdfInvoice=function(){b.package()&&(j(!0,!0),console.log("send invoice for package: "+b.package().id()),$.ajax(serviceRootURL+"/packages/send_invoice/"+b.package().id(),{type:"GET",data:{id:b.package().id()},dataType:"json",contentType:"application/json",success:function(a,d,e){console.log("send invoice retrieved: ",a),b.loadPackageById(b.package().id(),c.OVERVIEW,function(){j(!1,!1),showInfo(i18n.t("packages.msg.invoiceSuccessfullySent")),$("body").find("div.modal-dialog").addClass("confirm-dialog-size-600")})},error:function(a,b,c){console.log("error on send invoice"),j(!1,!1),checkSession(a),showError("Fehler beim Versenden der Rechnung",a,b,c)}}))},b.addItineraryComment=function(){var a=i18n.t("packages.details.itineraryComment"),d=b.package().itineraryComment(),e=void 0===d||null===d||void 0===d.comment||null===d.comment?"":d.comment;bootbox.dialog({message:"<textarea  id='itineraryComment' rows=4 style='width: 100%'>"+e+"</textarea>",title:a,buttons:{cancel:{label:i18n.t("packages.orderItemGroup.dropdown.cancelBtn"),className:"btn-default",callback:function(){}},main:{label:i18n.t("packages.orderItemGroup.dropdown.saveBtn"),className:"btn-primary",callback:function(){b.showLoadingSpinner(!0);var a=$("#itineraryComment").val();void 0===b.package().itineraryComment()&&b.package().itineraryComment({id:void 0,type:void 0,comment:void 0}),b.package().itineraryComment().comment=a;var d=b.package().toJson(),e=function(){b.loadPackageById(d.id,c.COMMENTS),b.showLoadingSpinner(!1)};b.updatePackageData(d,PACKAGE_UPDATE_PART.COMMENTS,e)}}}}),$("body").find("div.modal-dialog").addClass("model-dialog-size-500")}}function showExternalAccess(){ko.cleanNode($("#external-access-container")),$("#external-access-container").load("assets/packages.html",function(){packageVM=null,packagesVM=new PackagesOverviewViewModel,ko.applyBindings(packagesVM,document.getElementById("packagesOverview"))})}function showPackageOverview(){cleanContainer(),$("#container").load("assets/packages.html",function(){null==packagesVM&&(packagesVM=new PackagesOverviewViewModel),ko.applyBindings(packagesVM,document.getElementById("packagesOverview"))})}function showPackage(a){cleanContainer(),$("#container").load("assets/packages-detail.html",function(){ko.cleanNode($("#packageDetails")[0]),null!=packageVM&&null!=packageVM.package()&&packageVM.package().id()==a||(packageVM=new packageDetailViewModel(a)),ko.applyBindings(packageVM,document.getElementById("packageDetails"))})}function showTourguideAdd(){tourguideAddVM.resetFields(),$("#tourguideAdd").modal("show"),$("#createTourguide").parsley()}function CargoReservationViewModel(a){var b=this;b.showLoadingSpinner=ko.observable(!1),b.id=ko.observable(null),b.addToCartEnabled=ko.observable(!1),b.addToFavoritesEnabled=ko.observable(!0),b.deleteFavoritesEnabled=ko.observable(!0),b.favoriteId=ko.observable(null),b.favoriteName=ko.observable(""),b.selectedFavorite=ko.observable(null),b.selectedFrom=ko.observable(null),b.selectedTo=ko.observable(null),b.selectedTransportType=ko.observable(null),b.selectedDate=ko.observable(new Date),b.selectedPackageAmount=ko.observable(1),b.selectedFeeAmount=ko.observable(1),b.selectedFee=ko.observable(),b.selectedPackageType=ko.observable(),b.selectedWeight=ko.observable(),b.selectedWareType=ko.observable(),b.selectedSender=ko.observable(),b.selectedReceiver=ko.observable(),b.selectedPayer=ko.observable(),b.selectedPaymentType=ko.observable(null),b.quantityExchangePallet=ko.observable(0),b.quantityExchangeFrame=ko.observable(0),b.quantityExchangeBoard=ko.observable(0),b.selectedRef=ko.observable(),b.totalPrice=ko.observable(0),b.price=ko.observable(null),b.selectedPaymentTypeItems=ko.observableArray([]),b.tourOperators=categoriesVM.cargoVM().tourOperators,b.favoriteItems=categoriesVM.cargoVM().favoriteItems,b.fromItems=categoriesVM.cargoVM().fromItems,b.toItems=categoriesVM.cargoVM().toItems,b.feeItems=categoriesVM.cargoVM().feeItems,b.packageItems=categoriesVM.cargoVM().packageItems,b.transportTypeItems=categoriesVM.cargoVM().transportTypeItems,b.wareItems=categoriesVM.cargoVM().wareItems,b.defaultFrom=ko.observable(),b.defaultTo=ko.observable(),b.defaultTransportType=ko.observable(),b.minDate=ko.observable(moment().startOf("month").format("YYYY-MM-DD")+" 00:00"),b.isEditable=ko.computed(function(){var a=!0;return shoppingcartVM.entries().forEach(function(b){b.categoryKey()===CATEGORY_KEY_CARGO&&(a=!1)}),a&&(b.selectedSender(null),b.selectedReceiver(null),b.selectedPayer(null),b.selectedPaymentType(null)),a}),b.formCargo=function(){return $("#js-cargo-reservation-form")};var c=function(a){var c=[{name:i18n.t("components.bootstrapSelect.placeholder"),value:null}];a.forEach(function(a){c.push({value:a,name:i18n.t("groupReservation.detail.paymenttype."+a)})}),b.selectedPaymentTypeItems(c)};b.selectedSender.subscribe(function(a){gr.ui.fillBootstrapSelectByKey(b.tourOperators,kp.get(a,"id",a),b.selectedPayer)}),b.selectedPayer.subscribe(function(a){var d=kp.get(b,"selectedPayer.paymentTypesArray",[]);d=d.filter(function(a){return a===PAYMENTTYPE_INVOICE||a===PAYMENTTYPE_CASH}),c(d),1==d.length?b.selectedPaymentType(d[0]):b.selectedPaymentType(null)}),b.setSelectBox=function(a,b,c){gr.ui.fillBootstrapSelectByKey(b,c,a)},b.updateFieldsByDefaultSettings=function(){b.setSelectBox(b.selectedFrom,b.fromItems,b.defaultFrom()),b.setSelectBox(b.selectedTo,b.toItems,b.defaultTo()),b.setSelectBox(b.selectedTransportType,b.transportTypeItems,b.defaultTransportType())},b.updateDefaultSettingsByFields=function(){b.defaultFrom(kp.get(b,"selectedFrom.key",null)),b.defaultTo(kp.get(b,"selectedTo.key",null)),b.defaultTransportType(kp.get(b,"selectedTransportType.key",null))},b.selectedFavorite.subscribe(function(a){b.loadFavorite(a)}),b.loadDefaultSettings=function(){$.getJSON(serviceRootURL+"/cargo/defaultsettings").done(function(a){b.defaultFrom(a.stationFrom),b.defaultTo(a.stationTo),b.defaultTransportType(a.transportType),b.updateFieldsByDefaultSettings()}).fail(function(a,b,c){checkSession(a),showError(i18n.t("shop.cargo.errors.loadDefaultSettings"),a,b,c)})},b.loadDefaultSettings(),b.isFavoriteNameUnique=function(){return!b.favoriteItems().find(function(a){return a.key()===b.favoriteName()})},b.isAddFavoritesEnabled=function(){return""!=b.favoriteName()&&b.isFavoriteNameUnique()&&b.addToFavoritesEnabled()},b.isDeleteFavoritesEnabled=function(){return!!b.selectedFavorite()&&b.selectedFavorite().key()===b.favoriteName()&&b.deleteFavoritesEnabled()},b.loadFavorite=function(a){if(b.resetCargoFields(),!a)return void b.favoriteName("");var c=a.dataModel();b.favoriteId(a.id()),b.favoriteName(a.value()),b.setSelectBox(b.selectedFrom,b.fromItems,c.stationFrom),b.setSelectBox(b.selectedTo,b.toItems,c.stationTo),b.setSelectBox(b.selectedSender,b.tourOperators,c.sender),b.setSelectBox(b.selectedReceiver,b.tourOperators,c.receiver),b.setSelectBox(b.selectedPayer,b.tourOperators,c.payer),b.selectedPaymentType(c.paymentType),b.setSelectBox(b.selectedTransportType,b.transportTypeItems,c.transportType),b.setSelectBox(b.selectedWareType,b.wareItems,c.ware),b.selectedPackageAmount(c.quantity),b.setSelectBox(b.selectedPackageType,b.packageItems,c.packaging),b.selectedWeight(c.totalWeight),b.quantityExchangePallet(c.quantityExchangePallet),b.quantityExchangeFrame(c.quantityExchangeFrame),b.quantityExchangeBoard(c.quantityExchangeBoard),b.selectedFeeAmount(c.quantityFee),b.setSelectBox(b.selectedFee,b.feeItems,c.fee),b.selectedRef(c.reference)},b.resetFavorite=function(){b.favoriteId(null),b.favoriteName(""),b.selectedFavorite(null)},b.resetCargoFields=function(){b.id(null),b.addToCartEnabled(!1),b.selectedFrom(null),b.selectedTo(null),b.selectedTransportType(null),b.selectedDate(new Date),b.selectedPackageAmount(1),b.selectedFeeAmount(1),b.selectedFee(null),b.selectedPackageType(null),b.selectedWeight(null),b.selectedWareType(null),b.isEditable()&&(b.selectedSender(null),b.selectedReceiver(null),b.selectedPayer(null),b.selectedPaymentType(null)),b.selectedRef(null),b.quantityExchangePallet(0),b.quantityExchangeFrame(0),b.quantityExchangeBoard(0),b.totalPrice(0)},b.resetCargo=function(){b.resetCargoFields(),b.resetFavorite(),b.updateFieldsByDefaultSettings()},b.addToCart=function(a,c){console.log("addingToCart",a),shoppingcartVM.addEntry(a.price(),c,CATEGORY_KEY_CARGO,null,!0),b.resetCargo()},b.createOrUpdateDefaultSettings=function(a,c){var d={stationFrom:kp.get(b,"selectedFrom.key",null),stationTo:kp.get(b,"selectedTo.key",null),transportType:kp.get(b,"selectedTransportType.key",null)};console.log("createOrUpdateDefaultSettings",d),b.showLoadingSpinner(!0);var e=serviceRootURL+"/cargo/defaultsettings";$.ajax(e,{type:"POST",data:JSON.stringify(d),dataType:"json",contentType:"application/json",error:function(a,b,c){checkSession(a),console.log("Server error on createOrUpdateDefaultSettings: "+a.responseText),showError(i18n.t("shop.cargo.errors.createOrUpdateDefaultSettings"),a,b,c)},success:function(a,c,d){b.updateDefaultSettingsByFields()},complete:function(){b.showLoadingSpinner(!1)}})},b.addToFavorites=function(a,c){if(console.log("addToFavorites",a),b.formCargo().parsley().validate({group:"cargoFavorites"})){var d=b.buildFavoritesJson();b.showLoadingSpinner(!0),b.addToFavoritesEnabled(!1),$.ajax(serviceRootURL+"/cargo/favorites",{type:"POST",data:JSON.stringify(d),dataType:"json",contentType:"application/json",success:function(a,b,c){a&&categoriesVM.cargoVM().loadFavoriteItems()},error:function(a,b,c){checkSession(a),console.log("Server error on addToFavorites: "+a.responseText),showError("Fehler beim Erstellen der Cargo",a,b,c)},complete:function(){b.showLoadingSpinner(!1),b.addToFavoritesEnabled(!0)}})}},b.deleteFavorites=function(a,c){b.showLoadingSpinner(!0),b.deleteFavoritesEnabled(!1),$.ajax(serviceRootURL+"/cargo/favorites/"+b.favoriteId(),{type:"DELETE",dataType:"json",contentType:"application/json",success:function(a,c,d){b.resetCargo(),categoriesVM.cargoVM().loadFavoriteItems()},error:function(a,b,c){checkSession(a),console.log("Server error on deleteFavorites: "+a.responseText),showError("Fehler beim Erstellen der Cargo",a,b,c)},complete:function(){b.deleteFavoritesEnabled(!0),b.showLoadingSpinner(!1)}})},b.buildFavoritesJson=function(){return{name:kp.get(b,"favoriteName",null),dataModel:{stationFrom:kp.get(b,"selectedFrom.key",null),stationTo:kp.get(b,"selectedTo.key",null),sender:kp.get(b,"selectedSender.id",null),receiver:kp.get(b,"selectedReceiver.id",null),payer:kp.get(b,"selectedPayer.id",null),paymentType:kp.get(b,"selectedPaymentType",null),transportType:kp.get(b,"selectedTransportType.key",""),ware:kp.get(b,"selectedWareType.key",""),quantity:kp.get(b,"selectedPackageAmount",null),packaging:kp.get(b,"selectedPackageType.key",null),totalWeight:kp.get(b,"selectedWeight",0),quantityExchangePallet:kp.get(b,"quantityExchangePallet",0),quantityExchangeFrame:kp.get(b,"quantityExchangeFrame",0),quantityExchangeBoard:kp.get(b,"quantityExchangeBoard",0),quantityFee:kp.get(b,"selectedFeeAmount",0),fee:kp.get(b,"selectedFee.key",null),reference:kp.get(b,"selectedRef",null)}}},b.validateCargoFields=function(){if(!b.formCargo().parsley().validate({group:"cargo"}))return!1;var a=!1,c=$("#from").parsley().isValid("field:validate"),d=$("#to").parsley().isValid("field:validate"),e=$("#transportType").parsley().isValid("field:validate"),f=$("#ware").parsley().isValid("field:validate"),g=$("#packing").parsley().isValid("field:validate"),h=$("#totalWeight").parsley().isValid("field:validate");if(c||d||e||f||g||h)a=b.formCargo().parsley().validate({group:"cargoTransport"});else{var i=b.quantityExchangePallet()>0,j=b.quantityExchangeFrame()>0,k=b.quantityExchangeBoard()>0,l=""!==$("#selectedFee").val();i||j||k||l?(a=b.formCargo().parsley().validate({group:"cargoFee"}),$("#selectedDate").parsley().reset(),$("#from").parsley().reset(),$("#to").parsley().reset(),$("#transportType").parsley().reset(),$("#ware").parsley().reset(),$("#packing").parsley().reset(),$("#totalWeight").parsley().reset()):(showInfo(i18n.t("shop.cargo.transportAndGoodsMessage")),a=!1)}return a},b.priceCalculation=function(a,c){if(console.log("priceCalculation"),b.addToCartEnabled(!1),b.totalPrice(0),b.validateCargoFields()){var d={id:kp.get(b,"id",null),date:moment(b.selectedDate()).format(MOMENTJS_DATE_SERVER_FORMAT),stationFrom:kp.get(b,"selectedFrom.key",null),stationTo:kp.get(b,"selectedTo.key",null),sender:kp.get(b,"selectedSender.id",null),receiver:kp.get(b,"selectedReceiver.id",null),payer:kp.get(b,"selectedPayer.id",null),paymentType:kp.get(b,"selectedPaymentType",null),transportType:kp.get(b,"selectedTransportType.key",""),ware:kp.get(b,"selectedWareType.key",""),quantity:kp.get(b,"selectedPackageAmount",null),packaging:kp.get(b,"selectedPackageType.key",null),totalWeight:kp.get(b,"selectedWeight",0),quantityExchangePallet:kp.get(b,"quantityExchangePallet",0),quantityExchangeFrame:kp.get(b,"quantityExchangeFrame",0),quantityExchangeBoard:kp.get(b,"quantityExchangeBoard",0),quantityFee:kp.get(b,"selectedFeeAmount",0),fee:kp.get(b,"selectedFee.key",null),reference:kp.get(b,"selectedRef",null)};console.log("POST priceCalculation",d),b.responsePriceCalculation=function(a){null!=a.price&&a.price>=0?(b.addToCartEnabled(!0),b.totalPrice(a.price),b.price(new cargoPriceModel(a))):(showInfo("Price not found."),b.price(null))},b.showLoadingSpinner(!0),$.ajax(serviceRootURL+"/cargoprice"+(d.id?"/"+d.id:""),{type:d.id?"PUT":"POST",data:JSON.stringify(d),dataType:"json",contentType:"application/json",success:function(a,c,d){a&&a.id&&(b.id(a.id),$.ajax(serviceRootURL+"/cargoprice/"+a.id,{type:"GET",dataType:"json",contentType:"application/json",success:function(a,c,d){b.responsePriceCalculation(a)},error:function(a,b,c){checkSession(a),console.log("Server error on cargoPriceCalculation: "+a.responseText),showError("Fehler beim Erstellen der Cargo",a,b,c)},complete:function(){b.showLoadingSpinner(!1)}}))},error:function(a,c,d){b.showLoadingSpinner(!1),checkSession(a),console.log("Server error on cargoPriceCalculation: "+a.responseText),showError("Fehler beim Erstellen der Cargo",a,c,d)}})}}}function cargoViewModel(a){var b=this;categoryViewModel.apply(b,[a]),b.selectedCategory=categoriesVM.selectedCategory,b.tourOperators=ko.observableArray([]),b.fromItems=ko.observableArray([]),b.favoriteItems=ko.observableArray([]),b.toItems=ko.observableArray([]),b.feeItems=ko.observableArray([]),b.packageItems=ko.observableArray([]),b.transportTypeItems=ko.observableArray([]),b.wareItems=ko.observableArray([]);var c=function(a){$.getJSON(serviceRootURL+"/cargo/favorites").done(function(b){var c=$.map(b,function(a){return new optionCargoFavoritesModel(a)});a(c)}).fail(function(a,b,c){checkSession(a),showError(i18n.t("shop.cargo.errors.loadFavorites"),a,b,c),showError("Fehler beim Laden der Favoriten",a,b,c)})},d=function(a,b){$.getJSON(serviceRootURL+"/options",{categoryKey:CATEGORY_KEY_CARGO,optionListKey:a,parentOptionListKey:"",parentOptionKey:"",sort:!0}).done(function(a){var c=$.map(a,function(a){return new optionModel(a)});b(c)}).fail(function(a,b,c){checkSession(a),showError("Fehler beim Laden der VONs",a,b,c)})};$.getJSON(serviceRootURL+"/partners",{operation:"cargo_customer"}).done(function(a){var c=$.map(a,function(a){return new cargoPartnersOptionModel(a)});b.tourOperators(c)}).fail(function(a,b,c){checkSession(a),showError("Fehler beim Laden der touroperators",a,b,c)}),b.loadFavoriteItems=function(){c(b.favoriteItems)},b.loadFavoriteItems(),d("from",b.fromItems),d("to",b.toItems),d("fee",b.feeItems),d("packaging",b.packageItems),d("transportType",b.transportTypeItems),d("ware",b.wareItems)}function cargoPriceModel(a,b){var c=this;ko.utils.extend(c,new priceModel(a,b)),this.supportsQuantity(!1),this.categoryKey(CATEGORY_KEY_CARGO.toLowerCase()),this.sku(CATEGORY_KEY_CARGO),this.productId(a.id),this.reservationId(a.id);var d=function(a,b,c){return ko.pureComputed(function(){return null!=b?b:null!=categoriesVM&&null!=categoriesVM.cargoVM()&&null!=categoriesVM.cargoVM()[c]()?getOptionValue(categoriesVM.cargoVM()[c](),a):void 0},this)};this.date=ko.observable(a.date),this.stationFrom=ko.observable(a.stationFrom),this.stationFromName=d(a.stationFrom,a.stationFromName,"fromItems"),this.stationTo=ko.observable(a.stationTo),this.stationToName=d(a.stationTo,a.stationToName,"toItems"),this.paymentType=ko.observable(a.paymentType),this.transportType=ko.observable(a.transportType),this.transportTypeName=d(a.transportType,a.transportTypeName,"transportTypeItems"),this.ware=ko.observable(a.ware),this.wareName=d(a.ware,a.wareName,"wareItems"),this.totalWeight=ko.observable(a.totalWeight),this.quantity=ko.observable(a.quantity),this.packaging=ko.observable(a.packaging),this.packagingName=d(a.packaging,a.packagingName,"packageItems"),this.fee=ko.observable(a.fee),this.quantityFee=ko.observable(null!=this.fee()?a.quantityFee:null),this.feeName=d(a.fee,a.feeName,"feeItems"),this.categoryName=getCategoryInfo(CATEGORY_KEY_CARGO),this.quantityExchangePallet=ko.observable(a.quantityExchangePallet),this.quantityExchangeFrame=ko.observable(a.quantityExchangeFrame),this.quantityExchangeBoard=ko.observable(a.quantityExchangeBoard),c.getSpecificAttributes=function(){return{productId:c.productId()}}}function cargoPartnersOptionModel(a){var b=this;a.key=a.id,a.localizedValue=a.name,ko.utils.extend(b,new optionModel(a)),this.shortName=ko.observable(""),this.paymentTypesArray=a.paymentTypes.split(","),this.displayName=a.name,this.optionValue=ko.observable(a.id),this.optionText=ko.observable(a.name)}function GroupReservationCheckoutItemModel(a,b,c,d,e){var f=this;ko.utils.extend(f,new ShopCheckoutItemModel(a,b,c,d,e))}function GroupReservationCheckoutViewModel(a,b,c){var d=this;d.order=b,d.reservationType=c,shopCheckoutViewModel.apply(d,[a,d.order().group().groupName(),d.order().paymentType(),null,null,ORDER_TYPE_GROUP_RESERVATION_ORDER,d.order().customerPaymentType()]);for(var e=1,f=0,g=0;g<a.length;g++)if(a[g].price()instanceof bundlePriceModel)for(var h=0;h<a[g].quantity();h++){var i=new ShopCheckoutItemBundleViewModel(f,d,a[g]);d.groupedEntries.push(i);for(var j=0;j<a[g].price().bundleItems().length;j++){var k=a[g].price().bundleItems()[j],l=new ShopCheckoutBundleItemModel(a[g].price().bundleItems()[j],e,f,i,groupReservationCategoriesCacheVM.categoriesVM().getCategory(k.categoryKey()).config());d.entries.push(l),e++}f++}else{for(var h=0;h<a[g].quantity();h++){var k=a[g],l=new GroupReservationCheckoutItemModel(a[g],e,g,ORDER_ITEM_TYPE_SIMPLE_ITEM,groupReservationCategoriesCacheVM.categoriesVM().getCategory(k.categoryKey()).config());d.entries.push(l),e++}var m=new ShopCheckoutItemGroupViewModel(g,d,a[g],!1);d.groupedEntries.push(m)}d.createGroupReservationOrderButtonLabel=ko.computed(function(){return d.order()&&d.order().bergbahnReservation()&&d.order().bergbahnReservation().type()?i18n.t("checkout.button.groupReservation."+d.reservationType):""}),d.createGroupReservationOrder=function(){console.log("createGroupReservationOrder ...");for(var a=0;a<d.entries().length;a++){d.entries()[a].coding()||showInfo("Beim Buchen werden die eigegebenen Ticket IDs ignoriert.")}d.disableCheckout(),d.performCreateGroupReservationOrder(null,null)},d.performCreateGroupReservationOrder=function(a,b){console.log("performCreateGroupReservationOrder ..."),console.log("updating order based on price: "+d.totalPrice()),groupReservationVM.screenWorking(!0);for(var e={id:d.order().id(),status:ORDER_STATUS_PRINTING,amount:d.totalPrice(),paymentType:groupReservationVM.reservationInvoiceType(),comment:d.comment(),type:ORDER_TYPE_GROUP_RESERVATION_ORDER,orderItems:[],bergbahnReservation:{type:c}},f=0;f<d.groupedEntries().length;f++){var g=d.groupedEntries()[f];if(g instanceof ShopCheckoutItemBundleViewModel){var h={type:ORDER_ITEM_TYPE_BUNDLE,bundleNr:g.groupId(),firstName:g.firstName(),lastName:g.lastName(),phone:g.phone(),dateOfBirth:g.dateOfBirth(),price:g.price().price(),sku:g.price().sku(),consumerKey:g.price().consumerKey(),categoryKey:g.categoryKey(),timeRangeId:g.price().timeRangeId(),timeRangeKey:g.price().timeRangeKey(),reductionLevel:g.price().reductionLevel(),rebateRuleId:g.price().rebateRuleId(),crossSeason:g.price().crossSeason(),productKey:g.price().productKey(),date:g.price().date()};e.orderItems.push(h)}}for(var f=0;f<d.entries().length;f++){var g=d.entries()[f],i=null,j=null,k=null,l=null,m=null,n=null;g instanceof ShopCheckoutBundleItemModel?(i=ORDER_ITEM_TYPE_BUDLE_ITEM,j=g.bundle().groupId(),k=g.bundle().firstName(),l=g.bundle().lastName(),m=g.bundle().phone(),n=g.bundle().dateOfBirth()):(i=ORDER_ITEM_TYPE_SIMPLE_ITEM,k=g.firstName(),l=g.lastName(),m=g.phone(),n=g.dateOfBirth());var h={type:i,ticketNr:g.ticketNr(),bundleNr:j,firstName:k,lastName:l,phone:m,dateOfBirth:n,price:g.price().price(),sku:g.price().sku(),consumerKey:g.price().consumerKey(),categoryKey:g.categoryKey(),timeRangeId:g.price().timeRangeId(),timeRangeKey:g.price().timeRangeKey(),reductionLevel:g.price().reductionLevel(),rebateRuleId:g.price().rebateRuleId(),crossSeason:g.price().crossSeason(),productKey:g.price().productKey(),date:g.price().date(),specificAttributes:g.price().getSpecificAttributes()};e.orderItems.push(h)}$.ajax(serviceRootURL+"/orders/"+d.order().id(),{type:"PUT",data:JSON.stringify(e),dataType:"json",contentType:"application/json",success:function(b,f,g){groupReservationVM.screenWorking(!1),d.showSpinner(!1),d.orderId(b.id),console.log("group reservation order updated (id="+b.id+")"),groupReservationVM.shoppingCart().reset(),e.paymentType==PAYMENTTYPE_STORECREDITS&&headerVM.updateStoreCredits(),d.showGroupReservationSuccess(i18n.t("checkout.msg.successGroupReservationOrderComplete."+c)),null!=a&&a()},error:function(a,c,e){groupReservationVM.screenWorking(!1),d.showSpinner(!1),console.log("Server error on updating group reservation order:\n"+a.responseText),headerVM.loadPartner(!0),d.handleGroupReservationError(a,c,e),null!=b&&b()}})},d.finishCheckout=function(){$("#shopCheckout").modal("hide"),$("#shopCheckout").on("hidden.bs.modal",function(){groupReservationVM.loadReservationOrder(function(){groupReservationVM.screenWorking(!1)})})},d.handleGroupReservationError=function(a,b,c){checkSession(a),d.showGroupReservationError(i18n.t("checkout.msg.errorCreateGroupReservationOrder")+"<br/>"+d.getError(a,b,c))},d.retryGroupReservationOrder=function(){console.log("retrying group reservation order  ..."),d.disableCheckout(),d.createGroupReservationOrder()},d.discardGroupReservation=function(){d.disableCheckout(),console.log("discarding order ..."),$.ajax({url:serviceRootURL+"/orders/"+d.order().id(),type:"PUT",data:JSON.stringify({id:d.order().id(),status:ORDER_STATUS_DISCARDED}),dataType:"json",contentType:"application/json",success:function(a,b,c){console.log("order discarded successfully"+a),$("#shopCheckout").modal("hide"),$("#shopCheckout").on("hidden.bs.modal",function(){groupReservationVM.shoppingCart().reset()})},error:function(a,b,c){console.log("Server error on discarding order:\n"+a.responseText),d.handleGroupReservationError(a,b,c)}})},d.showGroupReservationSuccess=function(a){d.successMessage(a),$("#groupReservationError").slideUp(),$("#groupReservationSuccess").slideDown(),$("#checkoutProduce, #checkoutReservation, #checkoutForward, #checkoutGroupReservation, #checkoutResume, #checkoutDiscardReservation, #checkoutDiscardForward, #checkoutDiscardGroupReservation, #checkoutFinish, #checkoutCancel").hide(),$("#checkoutFinish").show(),$("#groupReservationError").find("button").removeAttr("disabled"),$("#groupReservationSuccess").find("button").removeAttr("disabled"),$(".modal-footer").find("button").removeAttr("disabled")},d.showGroupReservationError=function(a){d.disableCheckout(),d.errorMessage(a),$("#groupReservationSuccess").slideUp(),$("#groupReservationError").slideDown(),$("#checkoutProduce, #checkoutReservation, #checkoutForward, #checkoutGroupReservation, #checkoutDiscardReservation, #checkoutDiscardGroupReservation").hide(),d.discardPossible()?($("#checkoutResume").hide(),$("#checkoutDiscardGroupReservation").show()):d.resumePossible()?($("#checkoutResume").show(),$("#checkoutDiscardGroupReservation").hide()):($("#checkoutResume").hide(),$("#checkoutDiscardGroupReservation").hide()),$("#groupReservationError").find("button").removeAttr("disabled"),$("#groupReservationSuccess").find("button").removeAttr("disabled"),$(".modal-footer").find("button").removeAttr("disabled")}}function ChefServiceViewModel(){console.log("ChefServiceViewModel 2");var a=this;a.showLoadingSpinner=ko.observable(!1),a.showRoomDialog=ko.observable(!1),a.showMenuDialog=ko.observable(!1),a.menus=ko.observable([]),a.orderId=ko.observable(),a.selectedOrder=ko.observable(),a.restaurantReservation=ko.observable(),a.roomAssignments=ko.observable(),a.clickShowRoomDialog=function(b){a.menus(kp.get(b,"restaurantReservation.menus")),a.orderId(kp.get(b,"id")),a.selectedOrder(b),a.restaurantReservation(kp.get(b,"restaurantReservation")),a.showRoomDialog(!0)},a.saveOrder=function(){var b=kp.get(a.selectedOrder,"id");console.log("save order id = "+b),a.selectedOrder().restaurantReservation().roomAssignments(a.roomAssignments().filter(function(a){return""!==a.pax()&&parseInt(a.pax())>0}));var c={id:b,type:ORDER_TYPE_GROUP_RESTAURANT_RESERVATION_ORDER,restaurantReservation:ko.toJS(a.selectedOrder().restaurantReservation()),group:ko.toJS(a.selectedOrder().group())};$.ajax(serviceRootURL+"/orders/"+b+"?action=updateReservation",{type:"PUT",data:JSON.stringify(c),dataType:"json",contentType:"application/json",success:function(a,b,c){console.log("order request updated (id="+a.id+")")},error:function(b,c,d){checkSession(b),console.log("Server error on update reservation order: "+b.responseText),showError("Fehler beim Aktualisieren der Reservierung",b,c,d),a.screenWorking(!1)}})},a.stylesStatusBar=function(a){return{width:100*(restaurantReservationApi.gastroStatusOptions().findIndex(function(b){return b.value===a})+1)/restaurantReservationApi.gastroStatusOptions().length+"%"}},a.getGastroStatus=function(a){return restaurantReservationApi.gastroStatusOptions().find(function(b){return b.value===a}).name},a.actionAllowed=ko.observable(!a.showLoadingSpinner()),a.showLoadingSpinner.subscribe(function(b){var c=!b;a.actionAllowed(c)}),a.dateStart=ko.observable(new Date),a.formattedDate=ko.computed(function(){return moment(a.dateStart()).format("dddd, MMMM D, YYYY")}),a.dateEnd=ko.observable(null),a.dateRange=ko.observable(DATE_RANGE_VALIDFROM),a.dateStart.subscribe(function(b){console.log("dateStart("+b+")"),a.datesOverlapping()&&a.dateEnd(b),a.searchOrders()}),a.dateEnd.subscribe(function(b){a.datesOverlapping()&&a.dateStart(b)}),a.datesOverlapping=function(){return null!==a.dateStart()&&""!==a.dateStart()&&null!==a.dateEnd()&&""!==a.dateEnd()&&a.dateStart().getTime()>a.dateEnd().getTime()},a.isRangeValid=function(){return!(!a.dateStart()||!a.dateEnd())&&a.dateStart().getTime()<=a.dateEnd().getTime()},a.getNextGastroStatus=function(a){
var b=restaurantReservationApi.gastroStatusOptions(),c=restaurantReservationApi.gastroStatusOptions().findIndex(function(b){return b.value===a});return c++,c<b.length?b[c].value:b[0].value},a.selectedExpert=ko.observable(),a.selectedExpert.subscribe(function(a){console.log("selected expert("+a+")")}),a.orders=ko.observableArray(),a.selectedRestaurant=ko.observable(),a.selectedRestaurantId=ko.observable(null),a.restaurantFilterOptions=ko.observableArray(),a.gastroStatusFilterOptions=ko.observableArray(),a.gastroStatusFilter=ko.observable(),a.roomFilterOptions=ko.computed(function(){var b=new Set;a.orders().forEach(function(a){kp.get(a,"restaurantReservation.roomAssignments",[]).forEach(function(a){b.add(a.name())})});var c=[];return b.forEach(function(a){c.push({key:a,name:a})}),c}),a.roomFilter=ko.observable(),a.filteredOrders=ko.computed(function(){return ko.utils.arrayFilter(a.orders(),function(b){var c=!0;if(a.selectedRestaurant()){var d=kp.get(b,"restaurantReservation.restaurantId");a.selectedRestaurant().id()!=d&&(c=!1)}if(a.gastroStatusFilter()&&a.gastroStatusFilter()!=kp.get(b,"restaurantReservation.gastroStatus")&&(c=!1),a.roomFilter()){c=!!kp.get(b,"restaurantReservation.roomAssignments",[]).find(function(b){return b.name()===a.roomFilter()})}return c})}),a.filterResults=ko.computed(function(){return i18n.t("groupReservation.overview.tableHeader.showing")+" "+a.filteredOrders().length+" / "+a.orders().length}),a.searchOrders=function(){a.showLoadingSpinner(!0);var b=a.dateStart(),c=a.dateStart(),d={fromDate:null===b?null:moment(b).format(MOMENTJS_DATE_SERVER_FORMAT),toDate:null===c?null:moment(c).format(MOMENTJS_DATE_SERVER_FORMAT),dateRange:a.dateRange(),consumptionCheck:!1,bundleMode:PARAMKEY_GETORDER_BUNDLEMODE_LEAVES,expertId:a.selectedExpert(),includeReservationInfo:!0,withRestaurantReservationsOnly:!0};$.ajax(serviceRootURL+"/orders",{type:"GET",data:d,dataType:"json",contentType:"application/json",success:function(b,c,d){var e=new Set,f=new Set,g=$.map(b,function(a){if(kp.get(a,"restaurantReservation.status")!==ORDER_STATUS_RESTAURANT_CANCELED){var b=kp.get(a,"restaurantReservation.restaurantId"),c=headerVM.nameToRestaurantIdMap[b];c&&e.add(c.trim());var d=kp.get(a,"restaurantReservation.gastroStatus");return d&&f.add(d),new groupReservationOrderModel(a)}});a.orders(g),a.createFilterOptions(e,f),a.showLoadingSpinner(!1)},error:function(b,c,d){checkSession(b),console.log("Server error on loading reservations: "+b.responseText),showError("Fehler beim Laden der Reservierungen",b,c,d),a.showLoadingSpinner(!1)}})},a.createFilterOptions=function(b,c){a.restaurantFilterOptions([]),b.forEach(function(b){a.restaurantFilterOptions.push({key:b,name:b})}),a.gastroStatusFilterOptions([]),c.forEach(function(b){a.gastroStatusFilterOptions.push({key:b,name:restaurantReservationApi.getGastroStatusByValue(b)})})},a.openGroupReservationDetail=function(a,b){var c="group-reservation-detail";b&&(c+="/"+b),null!==a&&(c=c+"/"+a),location.hash=c}}function showChefService(){ko.cleanNode($("#container")),$("#container").load("assets/groupreservation/chef/chef-service.html",function(){ko.cleanNode($("#chefService")[0]),"undefined"!=typeof chefServiceVM&&null!==chefServiceVM||(chefServiceVM=new ChefServiceViewModel),chefServiceVM.searchOrders(),ko.applyBindings(chefServiceVM,document.getElementById("chefService"))})}function restaurantAvailabilitiesModel(a){var b=this;this.from=ko.observable(a.from),this.until=ko.observable(a.until),this.used=ko.observable(a.used),this.free=ko.observable(a.free),this.overbookFree=ko.observable(a.overbookFree?a.overbookFree:0),this.overbookTotal=ko.observable(a.overbookTotal?a.overbookTotal:0),this.total=ko.observable(a.total),this.fromTimeLabel=ko.computed(function(){return moment(b.from()).format("HH:mm")}),this.isSelected=ko.observable(!1),this.isDisabled=ko.computed(function(){return b.free()+b.overbookFree()===0}),this.availability=ko.computed(function(){return 100*b.free()/b.total()}),this.tooltipLabel=function(){var a=[];return a.push(i18n.t("groupReservation.detail.seatsAvailable")+" <b>"+b.free()+"/"+b.total()+"</b>"),a.push(i18n.t("groupReservation.detail.seatsOverbookingAvailable")+"<b> "+b.overbookFree()+"/"+b.overbookTotal()+"</b>"),a.join("<br>")}}function GroupReservationOverviewViewModel(a){console.log("GroupReservationOverviewViewModel");var b=this;b.showLoadingSpinner=ko.observable(!1),b.actionAllowed=ko.observable(!b.showLoadingSpinner()),b.showLoadingSpinner.subscribe(function(a){var c=!a;b.actionAllowed(c),c?($("#buchungsdatum").parent().removeClass("disabled"),$("#ersterSkitag").parent().removeClass("disabled")):($("#buchungsdatum").parent().addClass("disabled"),$("#ersterSkitag").parent().addClass("disabled"))}),b.searchText=ko.observable(),b.searchTextHighlight=ko.observable(),b.dateStart=ko.observable(null),b.dateEnd=ko.observable(null),b.setDates=function(a){"last2Weeks"==a?(b.dateStart(b.calculateDate(-14)),b.dateEnd(new Date)):"next2Weeks"==a?(b.dateStart(new Date),b.dateEnd(b.calculateDate(14))):"today"==a&&(b.dateStart(new Date),b.dateEnd(new Date))},b.dateRange=ko.observable(DATE_RANGE_VALIDFROM),b.date=ko.observable("today"),b.setDates("today"),b.dateRange.subscribe(function(a){"orderDate"==a&&"next2Weeks"==b.date()?b.date("last2Weeks"):"validFrom"==a&&"last2Weeks"==b.date()?b.date("next2Weeks"):b.searchOrders()}),b.calculateDate=function(a){var b=new Date,c=b.getDate();return b.setDate(a+c),b},b.date.subscribe(function(a){"last2Weeks"!=a&&"next2Weeks"!=a&&"today"!=a||(b.setDates(a),b.hideDateRange(),b.searchOrders())}),b.isLast2WeeksShown=ko.computed(function(){return b.dateRange()==DATE_RANGE_ORDERDATE}),b.isNext2WeeksShown=ko.computed(function(){return b.dateRange()==DATE_RANGE_VALIDFROM}),b.selectDateFrom=function(a,c){var d=c.target,e=$(d).find("input").val();b.dateRange(e)},b.dateStart.subscribe(function(a){console.log("dateStart("+a+")"),b.datesOverlapping()&&b.dateEnd(a)}),b.dateEnd.subscribe(function(a){console.log("dateEnd("+a+")"),b.datesOverlapping()&&b.dateStart(a)}),b.datesOverlapping=function(){return null!==b.dateStart()&&""!==b.dateStart()&&null!==b.dateEnd()&&""!==b.dateEnd()&&b.dateStart().getTime()>b.dateEnd().getTime()},b.isRangeValid=function(){return!(!b.dateStart()||!b.dateEnd())&&b.dateStart().getTime()<=b.dateEnd().getTime()},b.selectedExpert=ko.observable(),b.selectedExpert.subscribe(function(a){console.log("selected expert("+a+")")}),b.experts=ko.observable(),b.orders=ko.observableArray(),b.statusFilterOptions=ko.observableArray(),b.selectedStatusFilter=ko.observable(),b.restaurantFilterOptions=ko.observableArray(),b.selectedRestaurantFilter=ko.observable(),b.gastroStatusFilterOptions=ko.observableArray(),b.gastroStatusFilter=ko.observable(),b.menuFilterOptions=ko.observableArray(),b.menuFilter=ko.observable(),b.resellerFilterOptions=ko.observableArray(),b.selectedResellerFilter=ko.observable(),b.travelDateSortOrderFilter=ko.observable("ASC"),b.resetFilters=function(){b.selectedResellerFilter(null),b.selectedStatusFilter(null),b.selectedRestaurantFilter(null),b.gastroStatusFilter(null),b.menuFilter(null),$("#reset-button").blur(),b.searchText(null),b.dateRange(DATE_RANGE_VALIDFROM),b.date("today"),b.travelDateSortOrderFilter("ASC"),b.selectedExpert(null)},b.filteredOrders=ko.computed(function(){return ko.utils.arrayFilter(b.orders(),function(c){var d=!0;if(a){kp.get(c,"type");if(ORDER_TYPE_GROUP_RESERVATION_ORDER){var e=kp.get(c,"id");d=!kp.get(c,"group.orders",[]).find(function(a){return a.id===e&&a.restaurantOrderId})}}if(b.selectedStatusFilter()&&(a?b.selectedStatusFilter()!=kp.get(c,"restaurantReservation.status")&&(d=!1):b.selectedStatusFilter()!=c.forwardOrderDisplayState()&&(d=!1)),b.selectedResellerFilter()&&b.selectedResellerFilter()!=kp.get(c,"group.partnerName")&&(d=!1),b.selectedRestaurantFilter()){var f=kp.get(c,"restaurantReservation.restaurantId");b.selectedRestaurantFilter()!=headerVM.nameToRestaurantIdMap[f]&&(d=!1)}if(b.gastroStatusFilter()&&b.gastroStatusFilter()!=kp.get(c,"restaurantReservation.gastroStatus")&&(d=!1),b.menuFilter()){-1===kp.get(c,"restaurantReservation.menus",[]).findIndex(function(a){return a.sku()===b.menuFilter()})&&(d=!1)}return d}).sort(function(c,d){if("OFF"!=b.travelDateSortOrderFilter()){var e="bergbahnReservation.date";a&&(e="restaurantReservation.from");var f=moment(kp.get(c,e)),g=moment(kp.get(d,e));return f.isSame(g)?0:"ASC"==b.travelDateSortOrderFilter()?f.isAfter(g)?-1:1:f.isAfter(g)?1:-1}return c.id()<d.id()?1:-1})}),b.filterResults=ko.computed(function(){return i18n.t("groupReservation.overview.tableHeader.showing")+" "+b.filteredOrders().length+" / "+b.orders().length}),b.changeSortOrder=function(){"ASC"==b.travelDateSortOrderFilter()?b.travelDateSortOrderFilter("DESC"):"DESC"==b.travelDateSortOrderFilter()?b.travelDateSortOrderFilter("OFF"):"OFF"==b.travelDateSortOrderFilter()&&b.travelDateSortOrderFilter("ASC")},b.formDateRange=$("#dateRange"),b.searchOrders=function(){b.showLoadingSpinner(!0);var c=b.dateStart(),d=b.dateEnd(),e={fromDate:null===c?null:moment(c).format(MOMENTJS_DATE_SERVER_FORMAT),toDate:null===d?null:moment(d).format(MOMENTJS_DATE_SERVER_FORMAT),searchText:b.searchText(),dateRange:b.dateRange(),consumptionCheck:!1,bundleMode:PARAMKEY_GETORDER_BUNDLEMODE_LEAVES,expertId:b.selectedExpert(),includeReservationInfo:!0,withRestaurantReservationsOnly:!!a};$.ajax(serviceRootURL+"/orders",{type:"GET",data:e,dataType:"json",contentType:"application/json",success:function(c,d,e){var f=new Set,g=new Set,h=new Set,i=new Set,j=new Map,k=$.map(c,function(b){a?f.add(kp.get(b,"restaurantReservation.status")):f.add(b.forwardOrderDisplayState.trim()),g.add(kp.get(b,"group.partnerName").trim());var c=kp.get(b,"restaurantReservation.restaurantId"),d=headerVM.nameToRestaurantIdMap[c];d&&h.add(d.trim());var e=kp.get(b,"restaurantReservation.gastroStatus");e&&i.add(e);var k=kp.get(b,"restaurantReservation.menus",[]);return k.length>0&&k.forEach(function(a){var b=kp.get(a,"sku","-"),c=kp.get(a,"productName","-");if(kp.get(a,"daytrip",!1)){var d="";kp.get(a,"vegetarianVariantOf",null)&&(d=" Vegeterian"),j.set(b,c+" (Daytrip"+d+")")}else j.set(b,c)}),new groupReservationOrderModel(b)});b.orders(k),b.createFilterOptions(f,g,h,i,j),b.searchTextHighlight(b.searchText()),b.showLoadingSpinner(!1)},error:function(a,c,d){checkSession(a),console.log("Server error on loading reservations: "+a.responseText),showError("Fehler beim Laden der Reservierungen",a,c,d),b.showLoadingSpinner(!1)}})},b.createFilterOptions=function(a,c,d,e,f){console.log("createFilterOptions",a,c,d),b.statusFilterOptions([]),a.forEach(function(a){b.statusFilterOptions.push({key:a,name:i18n.t("groupReservation.forwardOrderDisplayState."+a)})}),b.resellerFilterOptions([]),c.forEach(function(a){b.resellerFilterOptions.push({key:a,name:a})}),b.restaurantFilterOptions([]),d.forEach(function(a){b.restaurantFilterOptions.push({key:a,name:a})}),b.gastroStatusFilterOptions([]),e.forEach(function(a){b.gastroStatusFilterOptions.push({key:a,name:restaurantReservationApi.getGastroStatusByValue(a)})}),b.menuFilterOptions([]),f.forEach(function(a,c){b.menuFilterOptions.push({key:c,name:a})})},b.performGetOrder=function(a,b){},b.openGroupReservationDetail=function(a,b){var c="group-reservation-detail";b&&(c+="/"+b),null!==a&&(c=c+"/"+a),location.hash=c},b.showDateRange=function(){return $(".dateRange").fadeIn(),!0},b.dateRangeUpdate=function(){return!!b.isValidRange()&&(b.hideDateRange(),!0)},b.hideDateRange=function(){return $(".dateRange").fadeOut(),!0},b.isValidRange=function(){return b.formDateRange.parsley().validate({group:"dateRange"})},$.getJSON(serviceRootURL+"/experts",{}).done(function(a){var c=$.map(a,function(a){return new bergbahnGroupReservationExpertOptionModel(a)});b.experts(c)}).fail(function(a,b,c){checkSession(a),showError("Fehler beim Laden der Experten",a,b,c)})}function showGroupReservationOverview(){ko.cleanNode($("#container")),$("#container").load("assets/groupreservation/overview/group-train-reservation-overview.html",function(){ko.cleanNode($("#groupReservationOverview")[0]),"undefined"==typeof groupReservationOverviewVM||null===groupReservationOverviewVM?groupReservationOverviewVM=new GroupReservationOverviewViewModel:groupReservationOverviewVM.searchOrders(),ko.applyBindings(groupReservationOverviewVM,document.getElementById("groupReservationOverview"))})}function showGroupRestaurantReservationOverview(){ko.cleanNode($("#container")),$("#container").load("assets/groupreservation/overview/group-restaurant-reservation-overview.html",function(){ko.cleanNode($("#groupRestaurantReservationOverview")[0]),"undefined"==typeof groupRestaurantReservationOverviewVM||null===groupRestaurantReservationOverviewVM?groupRestaurantReservationOverviewVM=new GroupReservationOverviewViewModel(!0):groupRestaurantReservationOverviewVM.searchOrders(),ko.applyBindings(groupRestaurantReservationOverviewVM,document.getElementById("groupRestaurantReservationOverview"))})}function BergbahnGroupReservationCategoryBergbahnViewModel(a){var b=this;b.order=a.reservationOrder,b.categoriesCacheVM=a.categoriesCacheVM,b.shoppingCart=a.shoppingCart,b.partnerId=ko.observable(),b.showLoadingSpinner=a.showLoadingSpinner,b.StandardTariffs=ko.observableArray([]),b.DaytripTariffs=ko.observableArray([]),b.SpecialTariffs=ko.observableArray([]),b.AboTariffs=ko.observableArray([]),b.ActiveTicketTypes=ko.observableArray([]),b.Types=ko.observableArray([]),b.Consumer=ko.observableArray([]),b.Tickets=ko.observableArray([]),b.hasAddon=ko.observable(),b.hasBergbahn=ko.observable(),this.Addons=ko.observableArray(),this.Bergbahn=ko.observable(),b.selectedFrom=ko.observable(),b.selectedTo=ko.observable(),b.selectedVia=ko.observable(),b.selectedTariff=ko.observable(),b.selectedTariffOption=ko.observable(),b.selectedTicketType=ko.observable(),b.selectedTicketTypeOption=ko.observable(),b.selectedTariffType=ko.observable(),b.selectedType=ko.observable(),b.selectedDate=ko.observable(),b.TariffValue=ko.observable(),b.TicketTypeValue=ko.observable(),b.TicketTypeObject=ko.observable(),b.loadingPrices=ko.observable(!0),b.markBtnPillsSelected=function(){$(document).ready(function(){$(document.body).on("click","label:not(.filter-field)",function(){$(".selected").removeClass("selected"),$(this).addClass("selected")})})},b.activeTickets=ko.computed(function(){return ko.utils.arrayFilter(b.Tickets(),function(a){return null!=a.price()})}),b.TypeObject=ko.pureComputed(function(){return ko.utils.arrayFirst(b.Types(),function(a){return a.key()===b.selectedType()})},this),b.loadOptionsForPartner=function(){null!=b.order().bergbahnReservation().productRoute()?$.getJSON(serviceRootURL+"/bergbahngroupreservationtariffs",{productRoute:b.order().bergbahnReservation().productRoute(),partnerId:b.partnerId()}).done(function(a){if(null!=a){var c=new bergbahnGroupReservationBergbahnTicketTypeOptionModel(a);if(c.tariffType(TARIFF_TYPE_BERGBAHN_ROUTE_BASED),null!=a.localizedOptions&&null!=a.localizedOptions.standardTariffs){var d=$.map(a.localizedOptions.standardTariffs,function(a){console.log(a);var b=new bergbahnGroupReservationBergbahnTariffOptionModel(a);return b.ticketTypes().push(c),b});b.StandardTariffs(d),b.StandardTariffs().length>0&&b.selectTariff(b.StandardTariffs()[0])}if(null!=a.localizedOptions&&null!=a.localizedOptions.specialTariffs){var d=$.map(a.localizedOptions.specialTariffs,function(a){console.log(a);var b=new bergbahnGroupReservationBergbahnTariffOptionModel(a);return b.ticketTypes().push(c),b});b.SpecialTariffs(d),null==b.selectedTariff()&&b.SpecialTariffs().length>0&&b.selectTariff(b.SpecialTariffs()[0])}if(null!=a.localizedOptions&&null!=a.localizedOptions.daytripTariffs){var e=$.map(a.localizedOptions.daytripTariffs,function(a){console.log(a);var b=new daytripsGroupReservationTariffOptionModel(a),d=$.map(a.localizedOptions.daytrips,function(a){console.log(a);var b=new daytripsGroupReservationDaytripsTicketTypeOptionModel(a,c);return b.tariffType(TARIFF_TYPE_DAYTRIP),b});return b.bundles(d),b});b.DaytripTariffs(e),null==b.selectedTariff()&&b.DaytripTariffs().length>0&&b.selectTariff(b.DaytripTariffs()[0])}b.loadAboTariffs(),b.markBtnPillsSelected()}}).fail(function(a,b,c){checkSession(a),showError("Fehler beim Laden der streckenbezogenen Tarife",a,b,c)}):(showInfo(i18n.t("groupReservation.tariffSelection.msg.noProductRoute")),b.loadAboTariffs())},b.loadAboTariffs=function(){$.getJSON(serviceRootURL+"/options",{categoryKey:CATEGORY_KEY_BERGBAHN_GROUP_RESERVATION,optionListKey:"aboTariffs",partnerId:b.partnerId(),sort:!0,recursive:!0}).done(function(a){var c=$.map(a,function(a){var b=new bergbahnGroupReservationBergbahnTariffOptionModel(a);if(null!=a.localizedOptions&&null!=a.localizedOptions.vias){var c=$.map(a.localizedOptions.vias,function(a){var b=new bergbahnGroupReservationBergbahnTicketTypeOptionModel(a);return b.tariffType(TARIFF_TYPE_BERGBAHN_ABO),b});b.ticketTypes(c)}return b});b.AboTariffs(c),null==b.selectedTariff()&&b.AboTariffs().length>0&&b.selectTariff(b.AboTariffs()[0])}).fail(function(a,b,c){checkSession(a),showError("Fehler beim Laden der Abo Tarife",a,b,c)})},b.orderLoaded=ko.computed(function(){null!=b.order&&null!=b.order()&&null!=b.order().bergbahnReservation()&&(b.partnerId(b.order().group().partnerId()),b.selectedDate(b.order().bergbahnReservation().date()),b.categoriesCacheVM()?b.categoriesCacheVM().loadPartnerCategory(b.partnerId(),b.loadOptionsForPartner,b.showLoadingSpinner):b.loadOptionsForPartner())}),b.selectTicketType=function(a,c){var d=a.tariffType();b.selectedTariffType(d),b.selectedTicketType(a.key()),b.selectedTicketTypeOption(a),b.TicketTypeValue(a.value()),b.selectedTicketType()&&(d==TARIFF_TYPE_BERGBAHN_ROUTE_BASED||d==TARIFF_TYPE_BERGBAHN_ABO?b.selectTicketTypeBergbahn(d):b.selectTicketTypeDaytrip(a))},b.selectType=function(a,c){b.selectedType(a.key())},b.TypeValue=ko.pureComputed(function(){for(var a=0;a<b.Types().length;a++){var c=b.Types()[a];if(c.key()==b.selectedType())return c.tripTypeName()+", "+c.className()}return""},this),b.selectTariff=function(a,c){b.selectedTariff(a.key()),b.selectedTariffOption(a),b.TariffValue(a.value()),b.ActiveTicketTypes(a.ticketTypes()),b.ActiveTicketTypes().length>0&&b.selectTicketType(b.ActiveTicketTypes()[0])},b.selectTicketTypeBergbahn=function(a){$.getJSON(serviceRootURL+"/options",{categoryKey:CATEGORY_KEY_BERGBAHN_GROUP_RESERVATION,optionListKey:"consumer",parentOptionListKey:"",parentOptionKey:"",partnerId:b.partnerId()}).done(function(a){var c=$.map(a,function(a){return new optionModel(a)}),d=$.map(a,function(a){var b=new consumerOptionModel(a);if(!b.hidden())return new ticketModelBergbahn(b)});b.Consumer(c),b.Tickets(d)}).fail(function(a,b,c){checkSession(a),showError("Fehler beim Laden der Altersgruppen",a,b,c)});var c=b.selectedTicketType().split(".");c.length>2&&(b.selectedFrom(c[0]),b.selectedTo(c[1]),b.selectedVia(b.selectedTicketType()),null!=b.selectedFrom()&&null!=b.selectedTo()&&null!=b.selectedVia()&&$.ajax(serviceRootURL+"/optionsbergbahntypes",{type:"GET",data:{categoryKey:CATEGORY_KEY_BERGBAHN_GROUP_RESERVATION,fromKey:b.selectedFrom(),toKey:b.selectedTo(),viaKey:b.selectedVia(),partnerId:b.partnerId(),tariffKey:b.selectedTariff()},dataType:"json",contentType:"application/json",context:{tariffType:a},success:function(c,d,e){var f=$.map(c,function(a){return console.log(a),new bergbahnTypeOptionModel(a)}).filter(function(c){return console.log("tariffType="+a),a!=TARIFF_TYPE_BERGBAHN_ROUTE_BASED||!(null!=b.order().bergbahnReservation().productTripType()&&b.order().bergbahnReservation().productTripType()!=c.tripTypeKey()||null!=b.order().bergbahnReservation().productClassKey()&&b.order().bergbahnReservation().productClassKey()!=c.classKey())});b.Types(f),b.Types().length>0&&b.selectedType(b.Types()[0].key())},error:function(a,b,c){checkSession(a),showError("Fehler beim Laden der Typen",a,b,c)}}))},b.selectDaytripTariff=function(a,c){b.selectedTariff(a.key()),b.selectedTariffOption(a),b.TariffValue(a.value()),b.ActiveTicketTypes(a.bundles()),b.ActiveTicketTypes().length>0&&b.selectTicketType(b.ActiveTicketTypes()[0])},b.selectTicketTypeDaytrip=function(a){if(b.hasAddon(a.additionalInfo().hasAddon),b.hasBergbahn(a.additionalInfo().hasBergbahn),b.hasAddon()){var c=$.map(a.localizedOptions().addons,function(a){return new addOnOptionModel(a)});b.Addons(c)}else b.Addons.removeAll();if(a.localizedOptions().selections)for(var d=0;d<a.localizedOptions().selections.length;d++)if(a.localizedOptions().selections[d].key==CATEGORY_KEY_BERGBAHN){b.Bergbahn(new addOnBergbahnOptionModel(a.localizedOptions().selections[d]));var e=$.map(a.localizedOptions().selections[d].localizedOptions.type,function(a){return console.log(a),new bergbahnTypeOptionModel(a)}).filter(function(a){return!(null!=b.order().bergbahnReservation().productTripType()&&b.order().bergbahnReservation().productTripType()!=a.tripTypeKey()||null!=b.order().bergbahnReservation().productClassKey()&&b.order().bergbahnReservation().productClassKey()!=a.classKey())});b.Types(e),b.Types().length>0&&b.selectedType(b.Types()[0].key())}var e=$.map(a.localizedOptions().consumer,function(a){return new optionModel(a)}),f=$.map(a.localizedOptions().consumer,function(a){console.log(a);var b=new consumerOptionModel(a);if(!b.hidden())return new ticketModelBergbahn(b)});b.Consumer(e),b.Tickets(f)},b.daytripBergbahnDisplayValue=ko.computed(function(){return b.selectedTariffType()==TARIFF_TYPE_DAYTRIP&&b.selectedTicketTypeOption().via&&b.hasBergbahn()?b.selectedTicketTypeOption().via().value()+"<br/>":""}),b.price=ko.computed({read:function(){if(b.selectedTariffType()==TARIFF_TYPE_DAYTRIP)if(b.selectedTicketType()&&b.selectedType()&&b.TypeObject()){console.log("computing prices for all consumers...");for(var a=b.TypeObject(),c=b.partnerId(),d=0;d<b.Tickets().length;d++){var e={categoryKey:CATEGORY_KEY_DAYTRIPS_GROUP_RESERVATION,productKey:b.selectedTicketType(),dateString:b.selectedDate(),consumerKey:b.Tickets()[d].consumer().key(),selectableItems:[]},f=null;b.hasBergbahn()&&(f={categoryKey:CATEGORY_KEY_BERGBAHN_GROUP_RESERVATION,fromKey:b.selectedTicketTypeOption().fromKey(),toKey:b.selectedTicketTypeOption().toKey(),viaKey:b.selectedTicketTypeOption().via().key(),classKey:a.classKey(),tripTypeKey:a.tripTypeKey(),consumerKey:b.Tickets()[d].consumer().key(),dateString:b.selectedDate(),isAddOn:!0,partnerId:c},e.selectableItems.push(f)),b.loadingPrices(!0),$.ajax(serviceRootURL+"/daytripsprice?partnerId="+b.partnerId(),{type:"POST",data:JSON.stringify(e),dataType:"json",contentType:"application/json",context:{ticket:b.Tickets()[d],selectedTypeObject:a,selectedBundle:b.selectedTicketTypeOption()},success:function(a,c,d){if(b.loadingPrices(!1),console.log("daytrips price for consumer group "+this.ticket.consumer().key()+" found: data.price="+a.price),null!=a.price)if(price=new bundlePriceModel(a,b.selectedTicketTypeOption()),null!=a.bundleItems){for(var e=!0,f=0;f<a.bundleItems.length;f++){var g=null;if(a.bundleItems[f].categoryKey==CATEGORY_KEY_BERGBAHN_GROUP_RESERVATION){var h=a.bundleItems[f];b.Bergbahn().fromKey(h.fromKey),b.Bergbahn().fromName(h.fromName),b.Bergbahn().toKey(h.toKey),b.Bergbahn().toName(h.toName),b.Bergbahn().viaKey(this.selectedBundle.via().key()),b.Bergbahn().viaName(this.selectedBundle.via().value()),b.Bergbahn().tripTypeKey(h.tripTypeKey),b.Bergbahn().tripTypeName(this.selectedTypeObject.tripTypeName()),b.Bergbahn().classKey(h.classKey),b.Bergbahn().className(this.selectedTypeObject.className()),bundleItemPrice=getPriceBundleItemInstance(a.bundleItems[f],b.Bergbahn()),price.bundleItems().push(bundleItemPrice),bundleItemPrice.price().viaKey()==this.selectedBundle.via().key()&&bundleItemPrice.price().classKey()==this.selectedTypeObject.classKey()&&bundleItemPrice.price().tripTypeKey()==this.selectedTypeObject.tripTypeKey()&&bundleItemPrice.price().date()==b.selectedDate()||(e=!1)}else a.bundleItems[f].categoryKey==CATEGORY_KEY_ADDON&&(g=getOption(b.Addons(),a.bundleItems[f].productKey),bundleItemPrice=getPriceBundleItemInstance(a.bundleItems[f],g),price.bundleItems().push(bundleItemPrice))}e&&this.ticket.price(price)}else console.log("Bundle price items not found: "+d.responseText),this.ticket.price(null);else console.log("Bundle price not found: "+d.responseText),this.ticket.price(null)},error:function(a,c,d){b.loadingPrices(!1),500==a.status?(console.log("Error during retrieving bundle price"),showError("Fehler bei Preisermittlung",a,c,d,!0)):console.log("Price not found: "+a.responseText),checkSession(a),this.ticket.price(null)}})}}else for(var d=0;d<b.Tickets().length;d++)b.Tickets()[d].price(null);else if(b.selectedTariffType()==TARIFF_TYPE_BERGBAHN_ROUTE_BASED||b.selectedTariffType()==TARIFF_TYPE_BERGBAHN_ABO)if(b.selectedTicketType()&&b.selectedFrom()&&b.selectedTo()&&b.selectedVia()&&b.selectedType()&&b.TypeObject()){console.log("computing prices for all consumers...");for(var a=b.TypeObject(),c=b.partnerId(),d=0;d<b.Tickets().length;d++)b.Tickets()[d].tariffKey()==b.selectedTariff()?(b.loadingPrices(!0),$.ajax(serviceRootURL+"/bergbahnprice",{type:"GET",data:{categoryKey:CATEGORY_KEY_BERGBAHN_GROUP_RESERVATION,consumerKey:b.Tickets()[d].consumer().key(),fromKey:b.selectedFrom(),toKey:b.selectedTo(),viaKey:b.selectedVia(),classKey:a.classKey(),tripTypeKey:a.tripTypeKey(),dateString:b.selectedDate(),partnerId:c,provideOptionNames:!0},dataType:"json",contentType:"application/json",context:{ticket:b.Tickets()[d]},success:function(a,c,d){if(b.loadingPrices(!1),console.log("price for consumer group "+this.ticket.consumer().key()+" found: data.price="+a.price),null!=a.price){price=new bergbahnPriceModel(a);var e=b.TypeObject();price.fromKey()==b.selectedFrom()&&price.toKey()==b.selectedTo()&&price.viaKey()==b.selectedVia()&&price.classKey()==e.classKey()&&price.tripTypeKey()==e.tripTypeKey()&&price.date()==b.selectedDate()&&this.ticket.price(price)}else console.log("Bergbahn price not found: "+d.responseText),this.ticket.price(null)},error:function(a,c,d){b.loadingPrices(!1),500==a.status?(console.log("Error during retrieving price"),showError("Fehler bei Preisermittlung",a,c,d,!0)):console.log("Price not found: "+a.responseText),checkSession(a),this.ticket.price(null)}})):b.Tickets()[d].price(null)}else for(var d=0;d<b.Tickets().length;d++)b.Tickets()[d].price(null);else for(var d=0;d<b.Tickets().length;d++)b.Tickets()[d].price(null)}},b).extend({throttle:10}),b.addToCart=function(a,c){b.selectedTariffType()==TARIFF_TYPE_DAYTRIP?b.shoppingCart().addEntry(a.price(),c,CATEGORY_KEY_BUNDLE,null,!0):b.shoppingCart().addEntry(a.price(),c,CATEGORY_KEY_BERGBAHN_GROUP_RESERVATION,null,!0)}}!function(a){a(document).ready(function(){currentWidth=a(window).width(),a(".navbar-toggle").on("click",function(b){b.preventDefault(),"none"==a(".top-menu").css("display")?a(".top-menu").slideDown():a(".top-menu").slideUp()}),a("#container").on("click","#formShop .btn-group-header",function(){if(a(window).width()<=768){var b=a(this).parent(),c=b.children(".btn-group-body");c.is(":visible")?c.slideUp():b.hasClass("category-col-tg")?"#shop_category"!=location.hash?location.hash="shop_category":c.slideDown():b.hasClass("category-col")||b.hasClass("operator-col")?"#shop"!=location.hash?location.hash="shop":c.slideDown():"bergbahn"==b.parent().attr("id")?(b.hasClass("origin-col")&&("#shop_bergbahn"!=location.hash?location.hash="shop_bergbahn":c.slideDown()),b.hasClass("destination-col")&&("#shop_bergbahn_destination"!=location.hash?location.hash="shop_bergbahn_destination":c.slideDown()),b.hasClass("via-col")&&("#shop_bergbahn_via"!=location.hash?location.hash="shop_bergbahn_via":c.slideDown()),b.hasClass("type-col")&&("#shop_bergbahn_type"!=location.hash?location.hash="shop_bergbahn_type":c.slideDown()),b.hasClass("date-col")&&("#shop_bergbahn_date"!=location.hash?location.hash="shop_bergbahn_date":c.slideDown()),b.hasClass("persons-col")&&("#shop_bergbahn_persons"!=location.hash?location.hash="shop_bergbahn_persons":c.slideDown())):"railway_seat_reservation"==b.parent().attr("id")?(b.hasClass("contractor-col")&&("#shop_railway_seat_reservation"!=location.hash?location.hash="shop_railway_seat_reservation":c.slideDown()),b.hasClass("origin-col")&&("#shop_railway_seat_reservation_origin"!=location.hash?location.hash="shop_railway_seat_reservation_origin":c.slideDown()),b.hasClass("destination-col")&&("#shop_railway_seat_reservation_destination"!=location.hash?location.hash="shop_railway_seat_reservation_destination":c.slideDown()),b.hasClass("type-col")&&("#shop_railway_seat_reservation_type"!=location.hash?location.hash="shop_railway_seat_reservation_type":c.slideDown()),b.hasClass("catering-col")&&("#shop_railway_seat_reservation_catering"!=location.hash?location.hash="shop_railway_seat_reservation_catering":c.slideDown()),b.hasClass("date-col")&&("#shop_railway_seat_reservation_date"!=location.hash?location.hash="shop_railway_seat_reservation_date":c.slideDown()),b.hasClass("persons-col")&&("#shop_railway_seat_reservation_persons"!=location.hash?location.hash="shop_railway_seat_reservation_persons":c.slideDown())):"railway_seat_reservation_timetable"==b.parent().attr("id")?(b.hasClass("contractor-col")&&("#shop_railway_seat_reservation_timetable"!=location.hash?location.hash="shop_railway_seat_reservation_timetable":c.slideDown()),b.hasClass("origin-col")&&("#shop_railway_seat_reservation_timetable_origin"!=location.hash?location.hash="shop_railway_seat_reservation_timetable_origin":c.slideDown()),b.hasClass("destination-col")&&("#shop_railway_seat_reservation_timetable_destination"!=location.hash?location.hash="shop_railway_seat_reservation_timetable_destination":c.slideDown()),b.hasClass("type-col")&&("#shop_railway_seat_reservation_timetable_type"!=location.hash?location.hash="shop_railway_seat_reservation_timetable_type":c.slideDown()),b.hasClass("catering-col")&&("#shop_railway_seat_reservation_timetable_catering"!=location.hash?location.hash="shop_railway_seat_reservation_timetable_catering":c.slideDown()),b.hasClass("date-col")&&("#shop_railway_seat_reservation_timetable_date"!=location.hash?location.hash="shop_railway_seat_reservation_timetable_date":c.slideDown()),b.hasClass("persons-col")&&("#shop_railway_seat_reservation_timetable_persons"!=location.hash?location.hash="shop_railway_seat_reservation_timetable_persons":c.slideDown())):"railway_seat_reservation_mrag"==b.parent().attr("id")?(b.hasClass("contractor-col")&&("#shop_railway_seat_reservation_mrag"!=location.hash?location.hash="shop_railway_seat_reservation_mrag":c.slideDown()),b.hasClass("origin-col")&&("#shop_railway_seat_reservation_mrag_origin"!=location.hash?location.hash="shop_railway_seat_reservation_mrag_origin":c.slideDown()),b.hasClass("destination-col")&&("#shop_railway_seat_reservation_mrag_destination"!=location.hash?location.hash="shop_railway_seat_reservation_mrag_destination":c.slideDown()),b.hasClass("type-col")&&("#shop_railway_seat_reservation_mrag_type"!=location.hash?location.hash="shop_railway_seat_reservation_mrag_type":c.slideDown()),b.hasClass("catering-col")&&("#shop_railway_seat_reservation_mrag_catering"!=location.hash?location.hash="shop_railway_seat_reservation_mrag_catering":c.slideDown()),b.hasClass("date-col")&&("#shop_railway_seat_reservation_mrag_date"!=location.hash?location.hash="shop_railway_seat_reservation_mrag_date":c.slideDown()),b.hasClass("persons-col")&&("#shop_railway_seat_reservation_mrag_persons"!=location.hash?location.hash="shop_railway_seat_reservation_mrag_persons":c.slideDown())):"bergbahn_epr"==b.parent().attr("id")?(b.hasClass("origin-col")&&("#shop_bergbahn_epr"!=location.hash?location.hash="shop_bergbahn_epr":c.slideDown()),b.hasClass("destination-col")&&("#shop_bergbahn_epr_destination"!=location.hash?location.hash="shop_bergbahn_epr_destination":c.slideDown()),b.hasClass("date-col")&&("#shop_bergbahn_epr_date"!=location.hash?location.hash="shop_bergbahn_epr_date":c.slideDown()),
b.hasClass("trainup-col")&&("#shop_bergbahn_epr_trainup"!=location.hash?location.hash="shop_bergbahn_epr_trainup":c.slideDown()),b.hasClass("traindown-col")&&("#shop_bergbahn_epr_traindown"!=location.hash?location.hash="shop_bergbahn_epr_traindown":c.slideDown()),b.hasClass("persons-col")&&("#shop_bergbahn_epr_persons"!=location.hash?location.hash="shop_bergbahn_epr_persons":c.slideDown())):"bus"==b.parent().attr("id")?(b.hasClass("origin-col")&&("#shop_bus"!=location.hash?location.hash="shop_bus":c.slideDown()),b.hasClass("busup-col")&&("#shop_bus_busup"!=location.hash?location.hash="shop_bus_busup":c.slideDown()),b.hasClass("down-date-col")&&("#shop_bus_downdate"!=location.hash?location.hash="shop_bus_downdate":c.slideDown()),b.hasClass("busdown-col")&&("#shop_bus_busdown"!=location.hash?location.hash="shop_bus_busdown":c.slideDown()),b.hasClass("addon-col")&&("#shop_bus_addon"!=location.hash?location.hash="shop_bus_addon":c.slideDown()),b.hasClass("persons-col-bus")&&("#shop_bus_persons"!=location.hash?location.hash="shop_bus_persons":c.slideDown())):"skipass"==b.parent().attr("id")?(b.hasClass("skiarea-col")&&("#shop_skipass"!=location.hash?location.hash="shop_skipass":c.slideDown()),b.hasClass("duration-col")&&("#shop_skipass_duration"!=location.hash?location.hash="shop_skipass_duration":c.slideDown()),b.hasClass("date-col")&&("#shop_skipass_date"!=location.hash?location.hash="shop_skipass_date":c.slideDown()),b.hasClass("persons-col")&&("#shop_skipass_persons"!=location.hash?location.hash="shop_skipass_persons":c.slideDown())):"localevent"==b.parent().attr("id")?(b.hasClass("region-col")&&("#shop_localevent"!=location.hash?location.hash="shop_localevent":c.slideDown()),b.hasClass("product-col")&&("#shop_localevent_product"!=location.hash?location.hash="shop_localevent_product":c.slideDown()),b.hasClass("type-col")&&("#shop_localevent_type"!=location.hash?location.hash="shop_localevent_type":c.slideDown()),b.hasClass("date-col")&&("#shop_localevent_date"!=location.hash?location.hash="shop_localevent_date":c.slideDown()),b.hasClass("time-col")&&("#shop_localevent_time"!=location.hash?location.hash="shop_localevent_time":c.slideDown()),b.hasClass("persons-col")&&("#shop_localevent_persons"!=location.hash?location.hash="shop_localevent_persons":c.slideDown())):"specialevent"==b.parent().attr("id")?(b.hasClass("region-col")&&("#shop_specialevent"!=location.hash?location.hash="shop_specialevent":c.slideDown()),b.hasClass("product-col")&&("#shop_specialevent_product"!=location.hash?location.hash="shop_specialevent_product":c.slideDown()),b.hasClass("type-col")&&("#shop_specialevent_type"!=location.hash?location.hash="shop_specialevent_type":c.slideDown()),b.hasClass("date-col")&&("#shop_specialevent_date"!=location.hash?location.hash="shop_specialevent_date":c.slideDown()),b.hasClass("time-col")&&("#shop_specialevent_time"!=location.hash?location.hash="shop_specialevent_time":c.slideDown()),b.hasClass("persons-col")&&("#shop_specialevent_persons"!=location.hash?location.hash="shop_specialevent_persons":c.slideDown())):"daytrips"==b.parent().attr("id")?(b.hasClass("bundle-col")&&("#shop_daytrips"!=location.hash?location.hash="shop_daytrips":c.slideDown()),b.hasClass("addon-col")&&("#shop_daytrips_addon"!=location.hash?location.hash="shop_daytrips_addon":c.slideDown()),b.hasClass("date-col")&&("#shop_daytrips_date"!=location.hash?location.hash="shop_daytrips_date":c.slideDown()),b.hasClass("persons-col")&&("#shop_daytrips_persons"!=location.hash?location.hash="shop_daytrips_persons":c.slideDown())):"hotel"==b.parent().attr("id")?(b.hasClass("region-col")&&("#shop_hotel"!=location.hash?location.hash="shop_hotel":c.slideDown()),b.hasClass("roomcategory-col")&&("#shop_hotel_roomcategory"!=location.hash?location.hash="shop_hotel_roomcategory":c.slideDown()),b.hasClass("arrival-date-col")&&("#shop_hotel_arrivaldate"!=location.hash?location.hash="shop_hotel_arrivaldate":c.slideDown()),b.hasClass("departure-date-col")&&("#shop_hotel_departuredate"!=location.hash?location.hash="shop_hotel_departuredate":c.slideDown()),b.hasClass("room-count-col")&&("#shop_hotel_roomcount"!=location.hash?location.hash="shop_hotel_roomcount":c.slideDown()),b.hasClass("adult-count-col")&&("#shop_hotel_adultcount"!=location.hash?location.hash="shop_hotel_adultcount":c.slideDown()),b.hasClass("child-count-col")&&("#shop_hotel_childcount"!=location.hash?location.hash="shop_hotel_childcount":c.slideDown()),b.hasClass("children-col")&&("#shop_hotel_children"!=location.hash?location.hash="shop_hotel_children":c.slideDown()),b.hasClass("city-col")&&("#shop_hotel_city"!=location.hash?location.hash="shop_hotel_city":c.slideDown()),b.hasClass("hotel-col")&&("#shop_hotel_accommodation"!=location.hash?location.hash="shop_hotel_accommodation":c.slideDown()),b.hasClass("persons-col")&&("#shop_hotel_offers"!=location.hash?location.hash="shop_hotel_offers":c.slideDown())):"depot"==b.parent().attr("id")?(b.hasClass("region-col")&&("#shop_depot"!=location.hash?location.hash="shop_depot":c.slideDown()),b.hasClass("persons-col")&&("#shop_depot_persons"!=location.hash?location.hash="shop_depot_persons":c.slideDown())):"autoverlad"==b.parent().attr("id")?(b.hasClass("product-col")&&("#shop_autoverlad"!=location.hash?location.hash="shop_autoverlad":c.slideDown()),b.hasClass("direction-col")&&("#shop_autoverlad_direction"!=location.hash?location.hash="shop_autoverlad_direction":c.slideDown()),b.hasClass("type-col")&&("#shop_autoverlad_type"!=location.hash?location.hash="shop_autoverlad_type":c.slideDown()),b.hasClass("date-col")&&("#shop_autoverlad_date"!=location.hash?location.hash="shop_autoverlad_date":c.slideDown()),b.hasClass("category-col")&&("#shop_autoverlad_category"!=location.hash?location.hash="shop_autoverlad_category":c.slideDown())):"parking"==b.parent().attr("id")&&(b.hasClass("location-col")&&("#shop_parking"!=location.hash?location.hash="shop_parking":c.slideDown()),b.hasClass("persons-col")&&("#shop_depot_persons"!=location.hash?location.hash="shop_parking_tickets":c.slideDown()),b.hasClass("tickets-col")&&("#shop_parking_tickets"!=location.hash?location.hash="shop_parking_tickets":c.slideDown()))}})}),a(window).resize(debounce(function(){(currentWidth>768&&a(window).width()<=768||currentWidth<=768&&a(window).width()>768)&&responsiveDisplay(location.hash.length>5?location.hash.substr(6):""),currentWidth=a(window).width()},200))}(jQuery),ROLE_SALES_ADMIN="SalesAdmin",ROLE_SALES="Sales",ROLE_SALES_CURRENCY_EDIT="SalesCurrencyEdit",ROLE_SALES_TOURGUIDE="Tourguide",ROLE_ABACUS_EXPORT="AbacusExport",serviceHostname=window.location.host,serviceProtocol=window.location.protocol,serviceRootURL=window.location.protocol+"//"+serviceHostname,console.log("serviceRootURL = "+serviceRootURL),logoutUrl="/logout",manualUrlHotel="",subjectRoles="",subjectLocale="",subjectLang="de",subjectIdentifier="",theme="",currency=ko.observable(""),appendSkidataChecksum=!1;var paymentMsg=null,paymentTitle=null;parseCookie(),ko.bindingHandlers.numericText={update:function(a,b,c){var d=ko.utils.unwrapObservable(b()),e=ko.utils.unwrapObservable(c().precision)||ko.bindingHandlers.numericText.defaultPrecision,f=null!=d?Number(d).toFixed(e).replace(/\B(?=(\d{3})+(?!\d))/g,"'"):d;ko.bindingHandlers.text.update(a,function(){return f})},defaultPrecision:1},ko.extenders.numericInt=function(a){var b=ko.pureComputed({read:a,write:function(b){var c=/^[0-9]+$/,d=a(),e=(c.test(b)&&parseInt(b))>0?parseInt(b):d;e!==d?a(e):b!==d&&a.notifySubscribers(e)}}).extend({notify:"always"});return b(a()),b},ko.bindingHandlers.datepicker={init:function(a,b,c){var d=$(a),e=c().datepickerOptions,f=ko.mapping.toJS(e)||{};d.datepicker(f),ko.utils.registerEventHandler(a,"change",function(){b()(d.datepicker("getDate"))}),ko.utils.domNodeDisposal.addDisposeCallback(a,function(){d.datepicker("destroy")}),ko.computed(function(){var a=ko.mapping.toJS(e)||{};for(var b in a)d.datepicker("option",b)!==a[b]&&d.datepicker("option",b,a[b]);d.datepicker("refresh")})},update:function(a,b){var c=ko.utils.unwrapObservable(b()),d=$(a);c-d.datepicker("getDate")!=0&&d.datepicker("setDate",c)}};var Birthdate=function(a){var b=this;if(b.dayId=_.uniqueId("birthdate"),b.monthId=_.uniqueId("birthdate"),b.yearId=_.uniqueId("birthdate"),b.labelId=a&&a.labelId||null,b.name=a&&a.name||"birthdate",b.value=a&&a.value||ko.observable(),b.validation=a&&a.validation||{},b.disabled=a&&a.disabled||ko.observable(!1),b.isoDate=a&&a.isoDate||ko.observable(),_.isFunction(b.disabled)||(b.disabled=ko.observable(b.disabled)),_.has(b.validation,"required")&&(b.validation.birthdaterequired=!0,b.validation.validateIfEmpty=!0,_.unset(b.validation,"required")),_.has(b.validation,"requiredMessage")&&(b.validation.birthdaterequiredMessage=b.validation.requiredMessage,_.unset(b.validation,"requiredMessage")),b.validation.birthdate=!0,b.monthBeforeDay=ko.observable(!1),DATE_PICKER_FORMAT.indexOf("m")<DATE_PICKER_FORMAT.indexOf("d")&&b.monthBeforeDay(!0),_.isDate(b.value())?(b.day=ko.observable(b.value().getDate()),b.month=ko.observable(b.value().getMonth()+1),b.year=ko.observable(b.value().getFullYear()),b.isoDate($.datepicker.formatDate(DATE_SERVER_FORMAT,b.value()))):(b.day=ko.observable(),b.month=ko.observable(),b.year=ko.observable()),b.isoDate()){var c=$.datepicker.parseDate(DATE_SERVER_FORMAT,b.isoDate());b.day=ko.observable(c.getDate()),b.month=ko.observable(c.getMonth()+1),b.year=ko.observable(c.getFullYear())}var d=function(){if(b.year()&&b.month()&&b.day()&&0==isNaN(Date.parse(b.year()+"-"+b.month()+"-"+b.day()))){var a=$.datepicker.parseDate(DATE_SERVER_FORMAT,b.year()+"-"+b.month()+"-"+b.day());b.value(a),b.isoDate($.datepicker.formatDate(DATE_SERVER_FORMAT,a))}else b.value(null),b.isoDate(null)};b.day.subscribe(d),b.month.subscribe(d),b.year.subscribe(d),b.day.subscribe(function(){_.isNil(b.day())||0!==b.day().length||b.day(null)}),b.month.subscribe(function(){_.isNil(b.month())||0!==b.month().length||b.month(null)}),b.year.subscribe(function(){_.isNil(b.year())||0!==b.year().length||b.year(null)}),b.value.subscribe(function(){_.isNil(b.value())||(b.day(b.value().getDate()),b.month(b.value().getMonth()+1),b.year(b.value().getFullYear()))}),b.minBirthdateYear=(new Date).getFullYear()-120,b.maxBirthdateYear=(new Date).getFullYear()};ko.bindingHandlers.modal={init:function(a,b){$(a).modal({show:!1});var c=b();ko.isObservable(c)&&$(a).on("hidden.bs.modal",function(){c(!1)})},update:function(a,b){var c=b();ko.utils.unwrapObservable(c)?$(a).modal("show"):$(a).modal("hide")}},ko.bindingHandlers.birthdate={init:function(a,b,c,d,e){var f=$(a),g=this;if(g.currentViewModel=d,window.Parsley._validatorRegistry.validators.birthdaterequired||window.Parsley.addValidator("birthdaterequired",{messages:{de:i18n.t("components.birthdate.messages.enterBirthdate"),en:i18n.t("components.birthdate.messages.enterBirthdate")},requirementType:"boolean",validateString:function(a,b,c){var d=c.$element.closest(".birthdate"),e=d.find(".birthdate__day input"),f=d.find(".birthdate__month input"),g=d.find(".birthdate__year input");return!_.isEmpty(e.val())&&!_.isEmpty(f.val())&&!_.isEmpty(g.val())}}),window.Parsley._validatorRegistry.validators.birthdate||window.Parsley.addValidator("birthdate",{messages:{de:i18n.t("components.birthdate.messages.invalidBirthdate"),en:i18n.t("components.birthdate.messages.invalidBirthdate")},requirementType:"boolean",validateString:function(a,b,c){var d=c.$element.closest(".birthdate"),e=d.find(".birthdate__day input"),f=d.find(".birthdate__month input"),h=d.find(".birthdate__year input");if(!_.isEmpty(e.val())&&!_.isEmpty(f.val())&&!_.isEmpty(h.val())){var i=Number(e.val()),j=Number(f.val()),k=Number(h.val());if(!Number.isInteger(k)||!Number.isInteger(j)||!Number.isInteger(i))return!1;if(i<1||i>31)return!1;if(j<1||j>12)return!1;if(k<1e3||k>9999)return!1;var l=k+"-"+j+"-"+i,m=$.datepicker.parseDate(DATE_SERVER_FORMAT,l);return null!==m&&m.getTime()<=(new Date).getTime()&&h.val()<=g.currentViewModel.maxBirthdateYear&&h.val()>=g.currentViewModel.minBirthdateYear}return!0}}),!_.isNil(e.$data.validation)){var h=f.find(".birthdate__day input"),i=f.find(".birthdate__month input"),j=f.find(".birthdate__year input");_.forEach(e.$data.validation,function(a,b){h.attr("data-parsley-"+_.kebabCase(b),a),i.attr("data-parsley-"+_.kebabCase(b),a),j.attr("data-parsley-"+_.kebabCase(b),a)}),h.attr("data-parsley-trigger-after-failure","change"),i.attr("data-parsley-trigger-after-failure","change"),j.attr("data-parsley-trigger-after-failure","change")}new MutationObserver(function(a){a.forEach(function(a){null!==a.attributeName&&"class"===a.attributeName&&f.parent().parent().hasClass("has-success")&&f.parent().parent().find(".parsley-errors-list").remove(),[].slice.call(a.addedNodes).forEach(function(a){var b=$(a);b.hasClass("parsley-errors-list")&&f.parent().parent().find(".parsley-errors-list").length>1&&f.parent().parent().find(".parsley-errors-list:not(#"+b.attr("id")+")").each(function(){$(this).remove()})})})}).observe(f.parent().parent()[0],{childList:!0,subtree:!0,attributes:!0,characterData:!1}),g.currentViewModel.monthBeforeDay()&&f.find(".birthdate__month").insertBefore(f.find(".birthdate__day"));var k=function(a,b,c,d){var e=parseInt(a.val(),10),f=e;if((38===b.which||40===b.which)&&!_.isNaN(e)){var g=0;return 38===b.which?g=1:40===b.which&&(g=-1),e>=c&&e<=d&&(e===c&&-1===g?f=d:e===d&&1===g?f=c:f+=g),a.val(f),!0}return!1};f.on("keydown",".birthdate__day input",function(a){if(k($(this),a,1,31)){var b=parseInt($(this).val(),10);_.isNaN(b)||e.$data.day(b)}}),f.on("keydown",".birthdate__month input",function(a){if(k($(this),a,1,12)){var b=parseInt($(this).val(),10);_.isNaN(b)||e.$data.month(b)}}),f.on("keydown",".birthdate__year input",function(a){if(k($(this),a,e.$data.minBirthdateYear,e.$data.maxBirthdateYear)){var b=parseInt($(this).val(),10);_.isNaN(b)||e.$data.year(b)}})}},ko.components.register("birthdate",{viewModel:Birthdate,template:'<div class="birthdate" data-bind="birthdate: {}, attr: { \'aria-labelledby\': labelId }"><div class="birthdate-input"><div class="birthdate__day col-sm-4"><div class="form-group"><label class="sr-only" data-bind="attr: { id: dayId }">__(\'Day\')</label><input class="form-control" data-bind="attr: { \'aria-labelledby\': labelId + \' \' + dayId, \'aria-required\': \'true\', \'data-parsley-errors-container\': \'.birthdate__error-container-\' + labelId, placeholder: i18n.t(\'components.birthdate.placeholder.day\') }, value: day, disable: disabled" maxlength="2"></div></div><div class="birthdate__month col-sm-4"><div class="form-group"><label class="sr-only" data-bind="attr: { id: monthId }">__(\'Month\')</label><input class="form-control" data-bind="attr: { \'aria-labelledby\': labelId + \' \' + monthId, \'aria-required\': \'true\', \'data-parsley-errors-container\': \'.birthdate__error-container-\' + labelId, placeholder: i18n.t(\'components.birthdate.placeholder.month\') }, value: month, disable: disabled" maxlength="2"></div></div><div class="birthdate__year col-sm-4"><div class="form-group"><label class="sr-only" data-bind="attr: { id: yearId }">__(\'Year\')</label>'+"<input class=\"form-control\" data-bind=\"attr: { 'aria-labelledby': labelId + ' ' + yearId, 'aria-required': 'true', 'data-parsley-errors-container': '.birthdate__error-container-' + labelId, placeholder: i18n.t('components.birthdate.placeholder.year') }, value: year, disable: disabled\" maxlength=\"4\"></div></div></div><div data-bind=\"attr: { class: 'birthdate__error-container-' + labelId  }\"></div><div class=\"birthdate__dummy\" data-bind=\"visible: false\"></div></div>"}),ko.bindingHandlers.bootstrapToggle={init:function(a,b){var c=b();$(a).change(function(){c($(this).prop("checked"))});var d=c.subscribe(function(b){$(a).bootstrapToggle(b?"on":"off")});ko.utils.domNodeDisposal.addDisposeCallback(a,function(){d.dispose(),$(a).bootstrapToggle("destroy")}),$(a).bootstrapToggle(b()()?"on":"off")}};var kp={};kp.get=function(a,b,c){var d=function(a){return"object"==typeof a?a:(a=(a||"").replace(/\[(\d+)]/g,".$1").replace(/\.+/g,".").replace(/(^\.|\.$)/g,""),a.split("."))}(b),e=0,f=d.length;for(a=ko.unwrap(a);a&&e<f;)a=ko.unwrap(ko.unwrap(a)[d[e]]),e+=1;return e==f&&void 0!==a?a:c},String.prototype.startsWith||Object.defineProperty(String.prototype,"startsWith",{value:function(a,b){var c=b>0?0|b:0;return this.substring(c,c+a.length)===a}}),halAD=null,auditLogAD=null;var NEW_TICKET_READ="NEW_TICKET_READ",EXISTING_TICKET_READ="EXISTING_TICKET_READ",TICKET_PRINTED="TICKET_PRINTED",TICKET_PREPARE_CODING="TICKET_PREPARE_CODING",TICKET_PREPARE_PRINTING="TICKET_PREPARE_PRINTING",TICKET_CODED="TICKET_CODED",ORDER_CREATED="ORDER_CREATED",ORDER_UPDATED="ORDER_UPDATED",ORDER_CANCELLED="ORDER_CANCELLED",BROKEN_RABTE_RULE="REBATE_RULE_MAY_BE_BROKEN";printerAD=null,printerAllowedDsfIds=[2],CATEGORY_KEY_SKIPASS="SKIPASS",CATEGORY_KEY_BERGBAHN="BERGBAHN",CATEGORY_KEY_CARGO="CARGO",CATEGORY_KEY_BERGBAHN_GROUP_RESERVATION="BERGBAHN_GROUP_RESERVATION",CATEGORY_KEY_MENU="MENU",CATEGORY_KEY_DRINK="DRINK",CATEGORY_KEY_PUBLICTRANSPORTATION="PUBLICTRANSPORTATION",CATEGORY_KEY_RAILWAY_SEAT_RESERVATION="RAILWAY_SEAT_RESERVATION",CATEGORY_KEY_RAILWAY_SEAT_RESERVATION_TIMETABLE="RAILWAY_SEAT_RESERVATION_TIMETABLE",CATEGORY_KEY_RAILWAY_SEAT_RESERVATION_MRAG="RAILWAY_SEAT_RESERVATION_MRAG",CATEGORY_KEY_CATERING="CATERING",CATEGORY_KEY_BERGBAHN_EPR="BERGBAHN_EPR",CATEGORY_KEY_BUS="BUS",CATEGORY_KEY_DAYTRIPS="DAYTRIPS",CATEGORY_KEY_DAYTRIPS_GROUP_RESERVATION="DAYTRIPS_GROUP_RESERVATION",CATEGORY_KEY_BUNDLE="BUNDLE",CATEGORY_KEY_ADDON="ADDON",CATEGORY_KEY_LOCAL_EVENT="LOCALEVENT",CATEGORY_KEY_SPECIAL_EVENT="SPECIALEVENT",CATEGORY_KEY_HOTEL="HOTEL",CATEGORY_KEY_TOURIST_TAX="TOURISTTAX",CATEGORY_KEY_MARGIN="MARGIN",CATEGORY_KEY_ADHOC="ADHOC",CATEGORY_KEY_DEPOT="DEPOT",CATEGORY_KEY_PARKING="PARKING",CATEGORY_KEY_AUTOVERLAD="AUTOVERLAD",CATEGORY_KEY_SUBSERVICE="SUBSERVICE",CATEGORY_KEY_RESTAURANT="RESTAURANT",CATEGORY_TYPE_CASHDESKSALE="cashdeskSale",CATEGORY_TYPE_GROUP_RESERVATION="groupReservation",CONTRACTOR_KEY_GOLDENPASS="GOLDENPASS",CONTRACTOR_KEY_GOPEX="GOPEX",CONTRACTOR_KEY_GOLDENPASS_EXPRESS="GPX",CONTRACTOR_KEY_GOLDENPASS_EXPRESS_PRESTIGE="GOPEXPRESTIGE",CONTRACTOR_KEY_CHEESETRAIN="THEMATICCHEESE",CONTRACTOR_DISPLAY_NAME_CHEESETRAIN="CHEES TRAIN",CONTRACTOR_KEY_DAMPFZUG="DAMPFZUG",CONTRACTOR_KEY_DIESELZUG="DIESELZUG",MOMENTJS_TRAIN_DATE_TIME_FORMAT="YYYY-MM-DDTHH:mm",CURRENCY="CHF",INDIVIDUAL_MENU="INDIVIDUAL_MENU";var PRINTING_STATE_OPEN=0,PRINTING_STATE_ERROR=2,PRINTING_STATE_RETRY=3,PRINTING_STATE_DONE=4,PRINTING_STATE_NRINVALID=5,PRINTING_STATE_NRPROCESSING=6,PRINTING_STATE_NRINCOMPLETE=7,ORDER_TYPE_CASHDESK_ORDER=1,ORDER_TYPE_CASHDESK_CANCEL=2,ORDER_TYPE_PICKUP_ORDER=3,ORDER_TYPE_FORWARD_ORDER=4,ORDER_TYPE_RESERVATION_ORDER=5,ORDER_TYPE_RESERVATION_ORDER_B2C=6,ORDER_TYPE_PACKAGE_ORDER=7,ORDER_TYPE_PACKAGE_ADDITIONAL_ORDER=8,ORDER_TYPE_PACKAGE_COMPENSATORY_ORDER=9,ORDER_TYPE_GROUP_RESERVATION_ORDER=10,ORDER_TYPE_GROUP_RESTAURANT_RESERVATION_ORDER=11,ORDER_TYPE_PACKAGE_OPTIONAL_ORDER=12,ORDER_ITEM_TYPE_SIMPLE_ITEM="simpleitem",ORDER_ITEM_TYPE_BUNDLE="bundle",ORDER_ITEM_TYPE_BUDLE_ITEM="bundleitem",ORDER_ITEM_TYPE_PACKAGE_SUBGRP="pkgsubgrp",ORDER_ITEM_TYPE_PACKAGE_ITEM="pkgitem",ORDER_ITEM_TYPE_PACKAGE_SUBSERVICE="pkgsubsrv",ORDER_ITEM_STATE_COMPLETE="complete",ORDER_ITEM_STATE_BOOKED="booked",ORDER_ITEM_STATE_CANCELED="canceled",ORDER_STATUS_NEW="new",ORDER_STATUS_PRINTING="printing",ORDER_STATUS_CANCELED="canceled",ORDER_STATUS_COMPLETE="complete",ORDER_STATUS_DISCARDED="discarded",ORDER_STATUS_PAYMENT_COMPLETE="payment_complete",ORDER_STATUS_PLANNED="planned",ORDER_STATUS_CONVERTED="converted",ORDER_STATUS_REQUESTED="requested",ORDER_STATUS_CONFIRMED="confirmed",ORDER_STATUS_REJECTED="rejected",ORDER_STATUS_RESERVED="reserved",ORDER_STATUS_RESERVATION_CANCELED="reservation_canceled",ORDER_STATUS_OFFER_CANCELED="offer_canceled",ORDER_STATUS_SUGGESTION_CANCELED="suggestion_canceled",ORDER_STATUS_RESTAURANT_RESERVED="reserved",ORDER_STATUS_RESTAURANT_CANCELED="canceled",ORDER_STATUS_ERROR="error",ORDER_EXPORT_STATUS_FORWARDED="forwarded",ORDER_CANCEL_INFO_POSSIBLE="cancelPossible",ORDER_CANCEL_INFO_NOT_POSSIBLE="cancelNotPossible",ORDER_CANCEL_INFO_CANCELLED="cancelled",ORDER_ITEM_CANCEL_INFO_POSSIBLE="cancelPossible",ORDER_ITEM_CANCEL_INFO_NOT_POSSIBLE="cancelNotPossible",ORDER_ITEM_CANCEL_INFO_ALREADY_USED="alreadyUsed",ORDER_ITEM_CANCEL_INFO_CANCELLED="cancelled",DATE_RANGE_ORDERDATE="orderDate",DATE_RANGE_VALIDFROM="validFrom",SHOPPING_CART_MODE_DEFAULT="default",SHOPPING_CART_MODE_PACKAGE="package",SHOPPING_CART_MODE_PACKAGE_ADDITIONAL="packageAdditional",SHOPPING_CART_MODE_PACKAGE_OPTIONAL="packageOptional",SHOPPING_CART_MODE_PACKAGE_COMPENSATORY="packageCompensatory",TURNOVER_RANGE_TODAY="today",TURNOVER_RANGE_MONTH="month",TURNOVER_RANGE_YEAR="year",TURNOVER_RANGE_CUSTOM="custom",PICKUP_TYPE_RECEPTION="reception",PICKUP_TYPE_PICKUP="pickup",PICKUP_TYPE_POST="post",BERGBAHN_TRIP_TYPE_ONE_WAY="O",BERGBAHN_TRIP_TYPE_TWO_WAY="T",BERGBAHN_TRIP_TYPE_ROUNDTRIP="R",BERGBAHN_TRIP_TYPE_ABO="A",BERGBAHN_MODE_BERGBAHN=0,BERGBAHN_MODE_PUBLIC_TRANSPORTATION=1,RABATE_RULE_WEEKDAY_SKU_RULE="weekdaySkuRule",RABATE_RULE_GROUP_REDUCTION_BERGBAHN="groupReductionBergbahnRule",REBATE_RULE_INCREASE_AMOUNT="incr",REBATE_RULE_DECREASE_AMOUNT="decr",REBATE_RULE_CHANGE_QUANTITY="change",PARTNER_OPERATION_CASHDESKSALE="cashdesksale",PARTNER_OPERATION_DRIVERINFO="driverinfo",PARTNER_OPERATION_TOUROPERATOR="touroperator",PARTNER_OPERATION_ABO_ADDITIONALVALUES="abo_additional_values",PARTNER_OPERATION_ABO_PERSONALISATION="abo_personalisation",PARTNER_OPERATION_ABO_SWAPMEDIA="abo_swap_media",PARTNER_OPERATION_REGISTRATION="registration",PARTNER_OPERATION_REGISTRATION_READER="registration_reader",PARTNER_OPERATION_REGISTRATION_DISCARD="registration_discard",PARTNER_OPERATION_REGISTRATION_NON_MANDATORY="registration_non_mandatory",PARTNER_OPERATION_PACKAGES_SELLER="package_seller",PARTNER_OPERATION_PACKAGES_CUSTOMER="package_customer",PAYMENTTYPE_INVOICE="invoice",PAYMENTTYPE_STORECREDITS="store_credits",PAYMENTTYPE_CASH="cash",PAYMENTTYPE_CREDITCARD="cc",PAYMENTTYPE_FREE="free",PICKUP_TYPES_WEBSHOP="webshop",PICKUP_TYPES_RESERVATION="reservation",CONTRACT_ORDERTYPE_CASHDESK="cashdesk",CONTRACT_ORDERTYPE_RESERVATION="reservation",PARTNERTYPE_HOTEL="Hotel",PARTNERTYPE_TO="Tour Operator",FORWARD_ORDER_RECEIVER_TYPE_TOURGUIDE=1,FORWARD_ORDER_FORWARD_TYPE_EMAIL=1,FORWARD_ORDER_FORWARD_TYPE_SYSTEM=2,FORWARD_ORDER_DISPLAY_STATE_PLANNED="planned",FORWARD_ORDER_DISPLAY_STATE_BOOKED="booked",FORWARD_ORDER_DISPLAY_STATE_SENT="sent",FORWARD_ORDER_DISPLAY_STATE_CONFIRMED="confirmed",FORWARD_ORDER_DISPLAY_STATE_ERROR="error",FORWARD_ORDER_DISPLAY_STATE_PICKED_UP="pickedup",FORWARD_ORDER_DISPLAY_STATE_CANCELED="canceled",GROUP_RESERVATION_ORDER_DISPLAY_STATE_NO_SHOW="noshow",GROUP_RESERVATION_ORDER_DISPLAY_STATE_NEW="new",GROUP_RESERVATION_ORDER_DISPLAY_STATE_RESERVED="reserved",GROUP_RESERVATION_ORDER_DISPLAY_STATE_RESERVATION_CANCELED="reservation_canceled",GROUP_RESERVATION_ORDER_DISPLAY_STATE_OFFERED="offered",GROUP_RESERVATION_ORDER_DISPLAY_STATE_OFFER_CANCELED="offer_"+GROUP_RESERVATION_ORDER_DISPLAY_STATE_CANCELED,GROUP_RESERVATION_ORDER_DISPLAY_STATE_SUGGESTED="suggested",GROUP_RESERVATION_ORDER_DISPLAY_STATE_SUGGESTION_CANCELED="suggestion_"+GROUP_RESERVATION_ORDER_DISPLAY_STATE_CANCELED,GROUP_RESERVATION_ORDER_DISPLAY_STATE_OFFER_CANCELED="offer_canceled",GROUP_RESERVATION_ORDER_DISPLAY_STATE_SUGGESTION_CANCELED="suggestion_canceled",GROUP_RESERVATION_ORDER_DISPLAY_STATE_BOOKED="booked",GROUP_RESERVATION_ORDER_DISPLAY_STATE_BOOKED_NO_SHOW=GROUP_RESERVATION_ORDER_DISPLAY_STATE_BOOKED+"_"+GROUP_RESERVATION_ORDER_DISPLAY_STATE_NO_SHOW,GROUP_RESERVATION_ORDER_DISPLAY_STATE_SENT="sent",GROUP_RESERVATION_ORDER_DISPLAY_STATE_CONFIRMED="confirmed",GROUP_RESERVATION_ORDER_DISPLAY_STATE_CONFIRMED_NO_SHOW=GROUP_RESERVATION_ORDER_DISPLAY_STATE_CONFIRMED+"_"+GROUP_RESERVATION_ORDER_DISPLAY_STATE_NO_SHOW,GROUP_RESERVATION_ORDER_DISPLAY_STATE_ERROR="error",GROUP_RESERVATION_ORDER_DISPLAY_STATE_PICKED_UP="pickedup",GROUP_RESERVATION_ORDER_DISPLAY_STATE_CANCELED="canceled",FORWARD_STATUS_NEW="new",FORWARD_STATUS_FORWARDED="forwarded",FORWARD_STATUS_ERROR="error",FORWARD_STATUS_NO_TRANSFER="no",EXPORT_STATUS_NEW="new",EXPORT_STATUS_FORWARDED="forwarded",EXPORT_STATUS_ERROR="error",EXPORT_STATUS_NO_TRANSFER="no",STORE_CREDIT_ACTION_UPDATED=1,STORE_CREDIT_ACTION_CREATED=2,STORE_CREDIT_ACTION_USED=3,STORE_CREDIT_ACTION_REFUNDED=4,STORE_CREDIT_ACTION_REVERTED=5,STORE_CREDIT_HISTORY_ORDER_STATE_PENDING_PAYMENT="pending_payment",STORE_CREDIT_HISTORY_ORDER_STATE_TRANSFER_STAGED="transfer_staged",STORE_CREDIT_HISTORY_ORDER_STATE_TRANSFER_ERROR="transfer_error",STORE_CREDIT_HISTORY_ORDER_STATE_COMPLETE="complete",STORE_CREDIT_EXCHANGE_RATE_NAME="CREDITS",BERGBAHN_EPR_VIA_PREFIX_UP="1",BERGBAHN_EPR_VIA_PREFIX_DOWN="2",BERGBAHN_EPR_OUTWARD="outward",BERGBAHN_EPR_RETURN="return",BERGBAHN_TRAIN_TYPE_TRADITIONAL="traditional",BERGBAHN_TRAIN_TYPE_VBAHN="vBahn",SKIDATA="skidata",AXESS="axess",MEDIA_KEYCARD="keycard",MEDIA_SWISSPASS="swisspass",MEDIA_BARCODE="barcode",MEDIA_VOUCHER="voucher",ERR_CODE_INVALID_MEDIAID=51,ERR_CODE_CONTINGENT_VALIDATION_ERROR=96,AXESS_PRINTER_TRAY_CONFIG_SKIPASS_BERGBAHN="skipass_bergbahn",AXESS_PRINTER_TRAY_CONFIG_BERGBAHN_SKIPASS="bergbahn_skipass",AXESS_PRINTER_TRAY_CONFIG_SKIPASS_VOUCHER="skipass_voucher",AXESS_PRINTER_BERGBAHN_HAND_CONFIG_SKIPASS_PICKUP="bergbahnhand_skipasspickup",AXESS_PRINTER_BERGBAHN_TRAY_CONFIG_SKIPASS_PICKUP="bergbahntray_skipasspickup",AXESS_PRINTER_BUNDLE_CONFIG_PRINT="print",AXESS_PRINTER_BUNDLE_CONFIG_VOUCHER="voucher",CONSUMER_CHILD="child",MAX_ORDERITEMS_FOR_PRODUCTION=5,MAX_RESTAURANT_INDIVIDUAL_COURSES=4,PARAMKEY_GETORDER_BUNDLEMODE_EXPLODED="exploded",PARAMKEY_GETORDER_BUNDLEMODE_BUNDLED="bundled",PARAMKEY_GETORDER_BUNDLEMODE_LEAVES="leaves",PARAMKEY_GETORDER_BUNDLEMODE_PACKAGE_INFO="packageInfo",PARAMKEY_GETORDER_BUNDLEMODE_PACKAGE_BOOKING="packageBooking",STATION_TYPE_BERGBAHN=0,STATION_TYPE_PUBLICTRANSPORTATION=1,TRAVEL_STATES_ENUM=Object.freeze({AWAITED:"awaited",ARRIVED:"arrived",DEPARTED:"departed",NOT_ARRIVED:"notArrived"}),REGISTRATION_FORM_STATES_ENUM=Object.freeze({NEW:"new",REGISTERED_VERIFIED:"registeredVerified",REGISTERED_NOT_VERIFIED:"registeredNotVerified",DISCARDED:"discarded",COMPLETED:"completed",CHECKED_IN:"checkedIn",CHECKED_OUT:"checkedOut"}),QUICKCHECKIN_MAIL_STATES_ENUM=Object.freeze({NOT_SEND:"notSend",SEND:"send",NO_EMAIL:"noEmail",NOT_ALLOWED:"notAllowed"}),GROUP_PERSON_ENUM=Object.freeze({GROUP:"group",PERSON:"person"}),BERGBAHN_GROUP_RESERVATION_SEARCH_TIME_TYPE_DEPARTURE=0,BERGBAHN_GROUP_RESERVATION_SEARCH_TIME_TYPE_ARRIVAL=1,DUMMY_WTP_NUMBER="P7S4D2YK-771-GZ6",SPECIAL_EVENT_LIMIT=9,PUBLIC_TRANSPORTATION_LIMIT=9,GENERAL_CONFIG_TYPES=Object.freeze({MRAG_DUMMY_HOTELS:"mragdummyhotels",SHOW_MAGE_ORDER_ID:"showMageOrderIncrId"}),prepareEprOptionsFromTrain=function(a,b,c){return{trainNr:a.key(),reservationTime:null,date:b,departureDateTime:b+" "+a.deptime(),arrivalDateTime:b+" "+a.arrtime(),trainType:c}},prepareEprOptionsFromEprInfo=function(a,b){return{trainNr:a.trainId,reservationTime:null,date:b,departureDateTime:a.departureDateTime,arrivalDateTime:a.arrivalDateTime,trainType:a.trainType}},PERSONALISATION_FIELD_TYPE_TEXTINPUT="text",PERSONALISATION_FIELD_TYPE_DROPDOWN="select",Package=function(a){var b=this;b.id=ko.observable(),b.title=ko.observable(),b.status=ko.observable(),b.previousStatus=ko.observable(),b.amount=ko.observable(),b.adjustment=ko.observable(),b.updatedAt=ko.observable(),b.createdAt=ko.observable(),b.plannedArrivalDate=ko.observable(),b.plannedDepartureDate=ko.observable(),b.cancellationRequested=ko.observable(),b.seller=ko.observable(),b.customer=ko.observable(),b.orderId=ko.observable(),b.additionalOrderId=ko.observable(),b.optionalOrderId=ko.observable(),b.compensatoryOrderId=ko.observable(),b.externalOrderNumber=ko.observable(),b.tourNumber=ko.observable(),b.tourLeaderName=ko.observable(),b.tourLeaderPhone=ko.observable(),b.releaseDateOffset=ko.observable(),b.additionalInfo=ko.observable(),b.lastMinuteChange=ko.observable(),b.noAutomaticInvoice=ko.observable(),b.useLogo=ko.observable(),b.invoicePdf=ko.observable(),b.itineraryPdf=ko.observable(),b.additionalServices=ko.observable(),b.descriptionFileList=ko.observableArray(),b.attachmentFileList=ko.observableArray(),b.externalVoucherList=ko.observableArray(),b.travelMemberList=ko.observableArray(),b.activityList=ko.observableArray(),b.priceIndicationList=ko.observableArray(),b.priceIndicationHeaderList=ko.observableArray(),b.commentList=ko.observableArray(),b.itineraryComment=ko.observable(),b.selectedPriceIndication=ko.observable(),b.offer=ko.observable(new PriceIndicationOfferModel),b.invoiceError=ko.observable(),b.invoiceSent=ko.observable(),b.creditnoteError=ko.observable(),b.creditnoteSent=ko.observable(),b.orderTransferStatus=ko.observable(),b.additionalOrderTransferStatus=ko.observable(),b.setActivityLogs=function(a){b.activityList([]),a&&a.forEach(function(a){b.activityList.push(a)})},b.hasProblem=ko.computed(function(){return"error"==b.orderTransferStatus()||1==b.invoiceError()||1==b.creditnoteError()||"error"==b.additionalOrderTransferStatus()||(0==b.invoiceError()&&0==b.invoiceSent()||0==b.creditnoteError()&&0==b.creditnoteSent())}),b.updateOverviewData=function(a){a&&(b.title(a.title),b.status(a.status?PACKAGE_STATUS_ENUM.valueOf(a.status):void 0),b.previousStatus(a.previousStatus?PACKAGE_STATUS_ENUM.valueOf(a.previousStatus):void 0),b.cancellationRequested(a.cancellationRequested),b.amount(a.amount),b.adjustment(a.adjustment),b.updatedAt(a.updatedAt),b.createdAt(a.createdAt),b.plannedArrivalDate(a.plannedArrivalDate),b.plannedDepartureDate(a.plannedDepartureDate),b.seller(a.seller),b.customer(a.customer),b.externalOrderNumber(a.externalOrderNumber),b.tourNumber(a.tourNumber),b.tourLeaderName(a.tourLeaderName),b.tourLeaderPhone(a.tourLeaderPhone),b.releaseDateOffset(a.releaseDateOffset),b.additionalInfo(a.additionalInfo),b.lastMinuteChange(a.lastMinuteChange),b.noAutomaticInvoice(a.noAutomaticInvoice),b.useLogo(a.useLogo),b.invoicePdf(a.invoicePdf),b.itineraryPdf(a.itineraryPdf),b.invoiceError(a.invoiceError),b.invoiceSent(a.invoiceSent),b.creditnoteError(a.creditnoteError),b.creditnoteSent(a.creditnoteSent),b.orderTransferStatus(a.orderTransferStatus),b.additionalOrderTransferStatus(a.additionalOrderTransferStatus))},b.setDescriptionFile=function(a){b.descriptionFileList([]),a&&b.descriptionFileList.push(a),console.log("Description file set",a,b.descriptionFileList())},b.setAttachmentFiles=function(a){b.attachmentFileList([]),a&&a.forEach(function(a){b.attachmentFileList.push(a)}),console.log("Attachment files set",a,b.attachmentFileList())},b.setExternalVoucherFiles=function(a){b.externalVoucherList([]),a&&a.forEach(function(a){b.externalVoucherList.push(a)}),console.log("Ext voucher files set",a)};var c=function(a){b.descriptionFileList([]),a&&(a.isUploaded=ko.observable(!0),b.descriptionFileList.push(a))},d=function(a){b.travelMemberList([]),a&&(a.isUploaded=ko.observable(!0),b.travelMemberList.push(a))},e=function(a){b.attachmentFileList([]),a&&a.forEach(function(a){null!==a&&(a.isUploaded=ko.observable(!0),b.attachmentFileList.push(a))})},f=function(a){b.externalVoucherList([]),a&&a.forEach(function(a){a.isUploaded=ko.observable(!0),b.externalVoucherList.push(a)})};b.updateComment=function(a){b.commentList([]),a&&b.commentList(a)};var g=function(a){b.id(a.id),b.orderId(a.orderId),b.additionalOrderId(a.additionalOrderId),b.optionalOrderId(a.optionalOrderId),b.compensatoryOrderId(a.compensatoryOrderId),b.updateOverviewData(a.overviewData),c(a.descriptionFile),e(a.attachmentFileList),f(a.voucherFileList),d(a.roomingListFile),b.updatePriceIndications(a.priceIndicationList),b.setOffer(a.offer),
a.productList&&a.productList.forEach(function(a){b.productList.push(a)}),a.commentList&&b.updateComment(a.commentList),a.itineraryComment&&b.itineraryComment(a.itineraryComment),a.activityList&&a.activityList.forEach(function(a){b.activityList.push(a)})};b.dataChanged=function(){},b.setOffer=function(a){a&&(b.offer(new PriceIndicationOfferModel(a)),b.plannedArrivalDate(a.arrivalDate),b.plannedDepartureDate(a.departureDate))},b.setPriceIndicationAsOfferTemplate=function(a){if((b.status()==PACKAGE_STATUS_ENUM.INDICATED||b.status()==PACKAGE_STATUS_ENUM.OPEN)&&void 0!=a){console.log("setPriceIndicationAsOfferTemplate",a,b.offer()),b.offer().arrivalDate(a.arrivalDate()),b.offer().departureDate(a.departureDate());var c=new Map;b.offer().consumerList().forEach(function(a){c.set(a.consumerKey(),a.quantity())});for(var d=[],e=0;e<a.consumerList().length;e++){for(var f=a.consumerList()[e],g=void 0,h=0;h<b.offer().consumerList().length;h++){var i=b.offer().consumerList()[h];i.consumerKey()==f.consumerKey()&&(g=i.id())}var j=new ConsumerItemModel;j.id(g),j.consumerKey(f.consumerKey()),j.packageOfferId(b.offer().id()),j.quantity(c.has(f.consumerKey())?c.get(f.consumerKey()):null),j.price(f.price()),d.push(j)}b.offer().consumerList(d)}},b.updatePriceIndications=function(a){if(b.priceIndicationList([]),b.priceIndicationHeaderList([]),a){var c=new Set;a.forEach(function(a){a.priceIndicationConsumerList.forEach(function(a){a.consumerKey&&!c.has(a.consumerKey.toLowerCase())&&(c.add(a.consumerKey.toLowerCase()),b.priceIndicationHeaderList.push(a))})}),a.forEach(function(a){for(var c=[],d=0;d<b.priceIndicationHeaderList().length;d++){for(var e=b.priceIndicationHeaderList()[d],f=!1,g=0;g<a.priceIndicationConsumerList.length;g++){var h=a.priceIndicationConsumerList[g];if(h.consumerKey&&h.consumerKey.toLowerCase()==e.consumerKey.toLowerCase()){h.price=h.price,c.push(h),f=!0;break}}f||c.push({consomerKey:e.consumerKey,price:null})}b.priceIndicationList.push(new PriceIndicationOfferModel(a))})}},b.toJson=function(){var a=b.getEmptyPackageJson();return a.id=b.id(),a.overviewData.title=b.title(),null!=b.status()&&(a.overviewData.status=b.status().name),null!=b.previousStatus()&&(a.overviewData.previousStatus=b.previousStatus()?b.previousStatus().name:null),a.overviewData.cancellationRequested=b.cancellationRequested(),a.overviewData.createdAt=b.createdAt(),a.overviewData.updatedAt=b.updatedAt(),a.overviewData.plannedArrivalDate=b.plannedArrivalDate(),a.overviewData.plannedDepartureDate=b.plannedDepartureDate(),a.overviewData.externalOrderNumber=b.externalOrderNumber(),a.overviewData.tourLeaderName=b.tourLeaderName(),a.overviewData.tourLeaderPhone=b.tourLeaderPhone(),a.overviewData.tourNumber=b.tourNumber(),a.overviewData.amount=b.amount(),a.overviewData.adjustment=b.adjustment(),a.overviewData.releaseDateOffset=b.releaseDateOffset(),a.overviewData.additionalInfo=b.additionalInfo(),a.overviewData.lastMinuteChange=b.lastMinuteChange(),a.overviewData.noAutomaticInvoice=b.noAutomaticInvoice(),a.overviewData.useLogo=b.useLogo(),a.overviewData.invoicePdf=b.invoicePdf(),b.customer()?a.overviewData.customer=b.customer():a.overviewData.customer={id:void 0,name:void 0},a.overviewData.seller=b.seller(),a.descriptionFile={},b.descriptionFileList()[0]&&(a.descriptionFile={id:b.descriptionFileList()[0].id}),a.roomingListFile={},b.travelMemberList()[0]&&(a.roomingListFile={id:b.travelMemberList()[0].id}),a.attachmentFileList=[],b.attachmentFileList().length>0&&(a.attachmentFileList=ko.utils.arrayMap(b.attachmentFileList(),function(a){return{id:a.id}})),a.voucherFileList=[],b.externalVoucherList().length>0&&(a.voucherFileList=ko.utils.arrayMap(b.externalVoucherList(),function(a){return{id:a.id}})),b.priceIndicationList().length>0&&(a.priceIndicationList=ko.utils.arrayMap(b.priceIndicationList(),function(a){return{id:a.id()}})),a.commentList=b.commentList(),a.itineraryComment=b.itineraryComment(),a.activityList=[],b.offer().orderId(b.orderId()),b.offer().additionalOrderId(b.additionalOrderId()),b.offer().optionalOrderId(b.optionalOrderId()),a.offer=b.offer().toOfferJson(),a.orderId=b.orderId(),a.additionalOrderId=b.additionalOrderId(),a.optionalOrderId=b.optionalOrderId(),a.compensatoryOrderId=b.compensatoryOrderId(),a},b.getEmptyPriceIndicationJson=function(){return{id:void 0,packageId:void 0,arrivalDate:void 0,departureDate:void 0,priceIndicationConsumerList:void 0}},b.getEmptyPackageJson=function(){return{id:void 0,overviewData:{title:void 0,description:void 0,status:void 0,previousStatus:void 0,plannedArrivalDate:void 0,plannedDepartureDate:void 0,createdAt:void 0,updatedAt:void 0,seller:{},customer:{},price:void 0,externalOrderNumber:void 0,tourNumber:void 0,tourLeaderName:void 0,tourLeaderPhone:void 0,additionalInfo:void 0,lastMinuteChange:void 0,noAutomaticInvoice:void 0,useLogo:void 0,invoicePdf:void 0},descriptionFile:void 0,roomingListFile:void 0,voucherFileList:[],attachmentFileList:[],priceIndicationList:[],commentList:[],itineraryComment:void 0,activityList:[]}},g(a?a:b.getEmptyPackageJson()),b.setPackageData=function(a){g(a)}},PriceIndicationOfferModel=function(a){var b=this;b.id=ko.observable(),b.packageId=ko.observable(),b.arrivalDate=ko.observable(),b.orderId=ko.observable(),b.additionalOrderId=ko.observable(),b.optionalOrderId=ko.observable(),b.orderId=ko.observable(),b.departureDate=ko.observable(),b.dateFromTo=ko.computed(function(){return formatDate(b.arrivalDate())+" - "+formatDate(b.departureDate())}),b.consumerList=ko.observableArray(),b.init=function(a){b.id(a.id),b.packageId(a.packageId),b.arrivalDate(a.arrivalDate),b.departureDate(a.departureDate),b.orderId(a.orderId),b.additionalOrderId(a.additionalOrderId),b.optionalOrderId(a.optionalOrderId),a.offerConsumerList&&a.offerConsumerList.forEach(function(a){b.consumerList.push(new ConsumerItemModel(a))}),a.priceIndicationConsumerList&&a.priceIndicationConsumerList.forEach(function(a){b.consumerList.push(new ConsumerItemModel(a))})},b.addOrUpdate=function(a){var c=!1;if(b.consumerList().forEach(function(b){b.consumerKey()==a.consumerKey()&&(b.price(a.price()),c=!0)}),!c){var d=new ConsumerItemModel;d.consumerKey(a.consumerKey()),d.price(a.price()),b.consumerList.push(d)}},a&&b.init(a),b.toOfferJson=function(){var a={offerConsumerList:[]};return a.id=b.id(),a.packageId=b.packageId(),a.orderId=b.orderId(),a.additionalOrderId=b.additionalOrderId(),a.optionalOrderId=b.optionalOrderId(),a.arrivalDate=b.arrivalDate(),a.departureDate=b.departureDate(),b.consumerList().forEach(function(b){ko.utils.arrayFirst(a.offerConsumerList,function(a){return b.consumerKey()==a.consumerKey})||a.offerConsumerList.push({id:b.id(),packageOfferId:b.packageOfferId(),consumerKey:b.consumerKey(),price:b.price()?b.price():void 0,quantity:b.quantity(),confirmedQuantity:b.confirmedQuantity()})}),a},b.getAvailableEzCount=ko.computed(function(){var a=0;return b.consumerList().forEach(function(b){"adult_ez"!=b.consumerKey()&&"child_ez"!=b.consumerKey()||b.confirmedQuantity()&&(a+=b.confirmedQuantity()-b.quantity())}),a}),b.getAvailableDzCount=ko.computed(function(){var a=0;return b.consumerList().forEach(function(b){"adult_dz"!=b.consumerKey()&&"child_dz"!=b.consumerKey()||b.confirmedQuantity()&&(a+=b.confirmedQuantity()-b.quantity())}),a}),b.getAvailable3zCount=ko.computed(function(){var a=0;return b.consumerList().forEach(function(b){"adult_3z"!=b.consumerKey()&&"child_3z"!=b.consumerKey()||b.confirmedQuantity()&&(a+=b.confirmedQuantity()-b.quantity())}),a}),b.getAvailablePiccoloCount=ko.computed(function(){var a=0;return b.consumerList().forEach(function(b){"piccolo"==b.consumerKey()&&b.confirmedQuantity()&&(a+=b.confirmedQuantity()-b.quantity())}),a}),b.getAvailableChildCount=ko.computed(function(){var a=0;return b.consumerList().forEach(function(b){"child"==b.consumerKey()&&b.confirmedQuantity()&&(a+=b.confirmedQuantity()-b.quantity())}),a}),b.getAvailableAdultCount=ko.computed(function(){var a=0;return b.consumerList().forEach(function(b){"adult"==b.consumerKey()&&b.confirmedQuantity()&&(a+=b.confirmedQuantity()-b.quantity())}),a})},ConsumerItemModel=function(a){var b=this;b.id=ko.observable(),b.packageOfferId=ko.observable(),b.consumerKey=ko.observable(),b.price=ko.observable(),b.quantity=ko.observable(),b.confirmedQuantity=ko.observable(),b.focused=ko.observable(!1),b.init=function(a){b.id(a.id),b.packageOfferId(a.packageOfferId),b.consumerKey(a.consumerKey),b.price(a.price),b.quantity(a.quantity),b.confirmedQuantity(a.confirmedQuantity)},a&&b.init(a)},AccommodationModel=function(a,b,c){var d=this;d.jsonData=a,d.cityId=ko.observable(b.key()),d.cityName=ko.observable(b.value()),d.accommodationName=ko.observable(a.value()),d.accommodationId=ko.observable(a.key()),d.accommExtId=ko.observable(a.accommExtId()),d.reservationRequestHash=ko.observable(),d.selectedSingleRoomCnt=ko.observable(),d.singleRoomOptionList=ko.observableArray(),d.selectedDoubleRoomCnt=ko.observable(),d.doubleRoomOptionList=ko.observableArray(),d.selectedThreeRoomCnt=ko.observable(),d.threeRoomOptionList=ko.observableArray(),d.confirmedSingleRoomCnt=ko.observable(),d.confirmedSingleRoomOptionList=ko.observableArray(),d.confirmedDoubleRoomCnt=ko.observable(),d.confirmedDoubleRoomOptionList=ko.observableArray(),d.confirmedThreeRoomCnt=ko.observable(),d.confirmedThreeRoomOptionList=ko.observableArray(),d.singleRoomCapacity=ko.observable(c.requiredSingleRooms()),d.doubleRoomCapacity=ko.observable(c.requiredDoubleRooms()),d.tripleRoomCapacity=ko.observable(c.requiredTripleRooms()),d.isConfirmed=ko.observable(!1),d.isReserved=ko.observable(!1),d.isRequested=ko.observable(!1),d.isRejected=ko.observable(!1),d.isSelected=ko.observable(!1),d.freeRoomAssigned=ko.observable(!1),d.reservationStatus=ko.observable(),d.reservationRequestHash=ko.observable(),d.requestError=ko.observable(!1),d.orderItemList=ko.observableArray(c.orderItemList),d.subservices=ko.computed(function(){var a=[];return ko.utils.arrayForEach(d.orderItemList(),function(b){b.categoryKey()==CATEGORY_KEY_SUBSERVICE&&b.type()==ORDER_ITEM_TYPE_PACKAGE_SUBSERVICE&&a.push(b.id())}),a}),d.singleRoomOptionList([]);for(var e=0;e<=d.singleRoomCapacity();e++)d.singleRoomOptionList.push({value:e});d.doubleRoomOptionList([]);for(var e=0;e<=d.doubleRoomCapacity();e++)d.doubleRoomOptionList.push({value:e});d.threeRoomOptionList([]);for(var e=0;e<=d.tripleRoomCapacity();e++)d.threeRoomOptionList.push({value:e});d.selectedSingleRoomCnt(d.singleRoomCapacity()),d.selectedDoubleRoomCnt(d.doubleRoomCapacity()),d.selectedThreeRoomCnt(d.tripleRoomCapacity()),d.singleRoomPrice=ko.observable(),d.doubleRoomPrice=ko.observable(),d.tripleRoomPrice=ko.observable(),d.getReservationStatus=ko.computed(function(){return d.reservationStatus()?i18n.t("packages.hotel.states."+d.reservationStatus()):null}),c.orderItemList.forEach(function(a){"pkgsubgrp"==a.type()&&(1==a.occupancy()&&"FRE.1"!=a.consumerKey()&&d.singleRoomPrice(a.price()),2==a.occupancy()&&d.doubleRoomPrice(a.price()),3==a.occupancy()&&d.tripleRoomPrice(a.price()))}),d.updateConfirmedAndReservedRooms=function(a,b,c,e,f,g){d.confirmedSingleRoomOptionList([]);for(var h=0;h<=a;h++)d.confirmedSingleRoomOptionList.push({value:h});d.confirmedDoubleRoomOptionList([]);for(var h=0;h<=b;h++)d.confirmedDoubleRoomOptionList.push({value:h});d.confirmedThreeRoomOptionList([]);for(var h=0;h<=c;h++)d.confirmedThreeRoomOptionList.push({value:h});d.confirmedSingleRoomCnt(a),d.confirmedDoubleRoomCnt(b),d.confirmedThreeRoomCnt(c),d.isReserved()&&(d.confirmedSingleRoomCnt(e),d.confirmedDoubleRoomCnt(f),d.confirmedThreeRoomCnt(g))},d.updateSelectedRooms=function(a,b,c){d.selectedSingleRoomCnt(a),d.selectedDoubleRoomCnt(b),d.selectedThreeRoomCnt(c)},d.removeConfirmedHotel=function(){d.isConfirmed(!1),d.isReserved(!1)}},HotelRegion=function(a,b,c,d){var e=this;e.region={id:b,name:a},e.arrivalDate=c,e.departureDate=d,e.roomsRequired={singleRoomCnt:0,doubleRoomCnt:0,threeRoomCnt:0},e.cityList=[],e.orderItemIds=[]},HotelRegionModel=function(a,b,c,d,e){var f=this;f.regionName=ko.observable(d),f.regionId=ko.observable(c),f.cityId=ko.observable(b.key()),f.cityName=ko.observable(b.value()),f.accommodationList=ko.observableArray([a]),f.selectAllSelected=ko.observable(!1),f.selectAllSelected.subscribe(function(a){f.filteredAccommodationList().forEach(function(b){b.isSelected(a)})}),f.filteredAccommodationList=function(){return f.accommodationList()},f.groupExpanded=function(a){return $("#toggleIcon_"+a).hasClass("expand")},f.getRegionCityName=function(){return f.regionName()+" ("+f.cityName()+")"},f.getRegionAssignedRooms=function(a){return ko.computed(function(){var b=0;return f.accommodationList().forEach(function(c){1==a&&(b+=c.selectedSingleRoomCnt()),2==a&&(b+=c.selectedDoubleRoomCnt()),3==a&&(b+=c.selectedThreeRoomCnt())}),b})()},f.getFormatedRegionCapacities=function(){return f.regionRoomCapacity(1).toString()+" / "+f.regionRoomCapacity(2).toString()+" / "+f.regionRoomCapacity(3)},f.regionRoomCapacity=function(a){return ko.computed(function(){var b=0;return f.accommodationList().forEach(function(c){var d=c.getRoomCapacity();b+=d.get(a)}),b})()},f.matches=function(a){if(f.accommodationList().length>0){return f.accommodationList()[0].cityId()==a.cityId()}return!1}},HotelDistribution=function(a,b,c,d){var e=this;e.regionList=ko.observableArray([]);for(var f=null,g=null,h=null,i=0;i<d.orderItemList.length;i++){var j=d.orderItemList[i];null!=j.priceCorrection()&&("GRP.1.ADULT"!=j.consumerKey()&&"FIT.1.ADULT"!=j.consumerKey()||(f=j.priceCorrection()),"GRP.2.ADULT"!=j.consumerKey()&&"FIT.2.ADULT"!=j.consumerKey()||(g=2*j.priceCorrection()),"GRP.3.ADULT"!=j.consumerKey()&&"FIT.3.ADULT"!=j.consumerKey()||(h=3*j.priceCorrection()))}!function(c,d){c.forEach(function(c){c.accommodations().forEach(function(f){var g=new AccommodationModel(f,c,d),h=ko.utils.arrayFirst(e.regionList(),function(a){return a.matches(g)});h?h.accommodationList.push(g):(h=new HotelRegionModel(g,c,a,b,d),e.regionList.push(h))})})}(c,d),e.getConfirmedHotels=function(){var a=new HotelRegion;return d.orderItemList.forEach(function(b){"pkgsubgrp"==b.type()&&(a.orderItemIds.push(b.id()),a.arrivalDate=b.date(),a.departureDate=b.toDate()),"pkgsubsrv"==b.type()&&a.orderItemIds.push(b.id())}),a.packageId=d.packageId,e.regionList().forEach(function(b){b.accommodationList().forEach(function(c){if(c.isConfirmed()||c.isReserved()){a.region.id=b.regionId(),a.region.name=b.regionName(),a.roomsRequired.singleRoomCnt+=Number(c.confirmedSingleRoomCnt()),a.roomsRequired.doubleRoomCnt+=Number(c.confirmedDoubleRoomCnt()),a.roomsRequired.threeRoomCnt+=Number(c.confirmedThreeRoomCnt());var d=ko.utils.arrayFirst(a.cityList,function(a){return c.cityId()==a.id}),e={id:c.accommodationId(),name:c.accommodationName(),reservationRequestHash:c.reservationRequestHash(),accommExtId:c.accommExtId(),freeRoomAssigned:!!c.freeRoomAssigned(),roomsRequired:{singleRoomCnt:Number(c.confirmedSingleRoomCnt()),doubleRoomCnt:Number(c.confirmedDoubleRoomCnt()),threeRoomCnt:Number(c.confirmedThreeRoomCnt())}};if(0==e.roomsRequired.singleRoomCnt&&0==e.roomsRequired.doubleRoomCnt&&0==e.roomsRequired.threeRoomCnt&&0==e.freeRoomAssigned)return void console.log("Skipping accommodation - there are no rooms assigned");d?d.accommodationList.push(e):a.cityList.push({id:b.cityId(),name:b.cityName(),accommodationList:[e]})}})}),console.log("getConfirmedHotels",a),a},e.getSelectedHotels=function(){var a=[];return e.regionList().forEach(function(b){b.accommodationList().forEach(function(b){if(b.isSelected()){var c={id:b.accommodationId(),name:b.accommodationName(),accommExtId:b.accommExtId(),reservationRequestHash:b.reservationRequestHash(),reservationStatus:b.reservationStatus()?b.reservationStatus():RESERVATION_STATES.NEW,roomsRequired:{singleRoomCnt:Number(b.selectedSingleRoomCnt()),doubleRoomCnt:Number(b.selectedDoubleRoomCnt()),threeRoomCnt:Number(b.selectedThreeRoomCnt()),singleRoomPrice:null!=f?f:b.singleRoomPrice(),doubleRoomPrice:null!=g?g:b.doubleRoomPrice(),threeRoomPrice:null!=h?h:b.tripleRoomPrice()},subservices:b.subservices()};a.push(c)}})}),console.log("getSelectedHotels",a),a},e.toJson=function(){return c.forEach(function(a){a.accommodations().forEach(function(a){e.regionList().forEach(function(a){a.accommodationList().forEach(function(a){if(a.isConfirmed()){var b=a.confirmedSingleRoomCnt(),c=a.confirmedDoubleRoomCnt(),d=a.confirmedThreeRoomCnt();if(0==b&&0==c&&0==d)return;console.log("Rooms needed to accommodation",a,b,c,d)}})})})}),console.log("Updated hotel region json",c),c}},TrainTicketPersonalizationModel=function(a){var b=this;b.id=ko.observable(a),b.firstName=ko.observable(),b.lastName=ko.observable(),b.selectedReduction=ko.observable(),b.dateOfBirth=ko.observable(),b.includeRailwayTicket=ko.observable(headerVM.includeRailwayTicketSelected())},TrainReservationModel=function(){var a=this;a.daytripId=ko.observable(),a.from=ko.observable(),a.to=ko.observable(),a.fromName=ko.observable(),a.toName=ko.observable(),a.contractorKey=ko.observable(),a.reservationId=ko.observable(),a.trains=ko.observable(),a.personalisations=ko.observableArray()},TrainModel=function(){var a=this;a.from=ko.observable(),a.to=ko.observable(),a.departureTime=ko.observable(),a.arrivalDateTime=ko.observable(),a.seats=ko.observable()},SeatModel=function(){var a=this;a.id=ko.observable(),a.services=ko.observableArray(),a.seatNumber=ko.observable()},CateringModel=function(a){var b=this;b.id=ko.observable(),b.quantity=ko.observable(),b.cateringType=ko.observable(),b.label=ko.observable(),b.price=ko.observable(),b.productId=ko.observable(),b.value=ko.observable(),a&&(b.id(a.id),b.price(a.price),b.label(a.label),b.productId(a.productId),b.value(a.value))},TrainInformationModel=function(a){var b=this;b.arrivalDateTime=ko.observable(),b.availability=ko.observable(),b.selectedSeats=ko.observableArray(),b.campaignId=ko.observable(),b.departureTime=ko.observable(),b.forceClass=ko.observable(),b.price=ko.observable(),b.reservationRequired=ko.observable(),b.stationFrom=ko.observable(),b.stationFromCode=ko.observable(),b.stationTo=ko.observable(),b.stationToCode=ko.observable(),b.trainId=ko.observable(),b.trainNumber=ko.observable(),b.trainType=ko.observable(),b.trainSelected=ko.observable(!1),b.segments=ko.observableArray(),b.classAvailability=ko.observable(),b.reservationId=ko.observable(),b.seatReservationPrice=ko.observable(),b.connectingTrains=ko.observableArray(),b.seatsPerWagon=ko.observable(),b.availableSeats=ko.observable(),b.departureIsAfter=function(a){if(b.departureTime()){var c=moment(b.departureTime(),MOMENTJS_TRAIN_DATE_TIME_FORMAT);return a.isBefore(c)}return!1},b.isDeparted=function(){if(b.departureTime()){var a=moment(b.departureTime(),MOMENTJS_TRAIN_DATE_TIME_FORMAT);if(moment().isAfter(a))return!0}return!1},b.hasArrived=function(){if(b.arrivalDateTime()){var a=moment(b.arrivalDateTime(),MOMENTJS_TRAIN_DATE_TIME_FORMAT);if(moment().isAfter(a))return!0}return!1},b.getSeatForPerson=function(a){return ko.utils.arrayFirst(b.selectedSeats(),function(b){return null!=b.assignedPerson()&&b.assignedPerson().id()===a.id()})},b.removeSelectedSeat=function(a){var c=ko.utils.arrayFirst(b.selectedSeats(),function(b){return b.seatId()===a.seatId()});c&&b.selectedSeats.remove(c)};null!=a&&function(){b.arrivalDateTime(a.arrivalDateTime),b.availability(a.availability),b.campaignId(a.campaignId),b.departureTime(a.departureTime),b.forceClass(a.forceClass),b.price(a.price),b.reservationRequired(a.reservationRequired),b.stationFrom(a.stationFrom),b.stationFromCode(a.stationFromCode),b.stationTo(a.stationTo),b.stationToCode(a.stationToCode),b.trainId(a.trainId),b.trainNumber(a.trainNumber),b.trainType(a.trainType),b.segments(a.segments),b.classAvailability(a.classAvailability),b.availableSeats(a.availableSeats)}()};abstractContingentViewModel.prototype.getOptionReference=function(){return this.selectedType().hasOwnProperty("key")?ko.isObservable(this.selectedType().key)?this.selectedType().key():this.selectedType().key:null},self.getHotelTooltipTemplate=function(a){return"<div class='tooltip hotel-tooltip'><div class='tooltip-arrow'></div><div class='tooltip-inner'></div></div>"},self.getLocalEventTooltipTemplate=function(a){return"<div class='tooltip local-event-tooltip'><div class='tooltip-arrow'></div><div class='tooltip-inner'></div></div>"},self.getDaytripTooltipTemplate=function(a){return"<div class='tooltip daytrip-tooltip'><div class='tooltip-arrow'></div><div class='tooltip-inner'></div></div>"};var PRINTER_STATE_NOT_AVAILABLE=0,PRINTER_STATE_RUNNING=1,PRINTER_STATE_STOPPED=2,PRINTER_STATE_OUTDATED=3,PRINTER_STATE_PRINTER_NOTREADY=4,PRINTER_STATE_OUTDATED_PRINTER_NOTREADY=5,PRINT_TYPE_PDF="PDF",PRINT_TYPE_CSV="CSV",COUNTRY_CODE_CH="CH",ERR_CODE_DUPLICATE_EMAIL=98,ERR_CODE_INVALID_EMAIL_FORMAT=99,INVOICE="invoice",DATATRANS="datatrans",PAYMENT_SEPARATOR="_",DATATRANS_VIS=DATATRANS+PAYMENT_SEPARATOR+"VIS",DATATRANS_ECA=DATATRANS+PAYMENT_SEPARATOR+"ECA",DATATRANS_AMX=DATATRANS+PAYMENT_SEPARATOR+"AMX",DATATRANS_DIN=DATATRANS+PAYMENT_SEPARATOR+"DIN",DATATRANS_PEF=DATATRANS+PAYMENT_SEPARATOR+"PEF",DATATRANS_PFC=DATATRANS+PAYMENT_SEPARATOR+"PFC",DATATRANS_PAP=DATATRANS+PAYMENT_SEPARATOR+"PAP",BACHMANNPAY="bachmannpay",BACHMANNPAY_ALIPAY=BACHMANNPAY+PAYMENT_SEPARATOR+"ALIPAY",BACHMANNPAY_WECHAT=BACHMANNPAY+PAYMENT_SEPARATOR+"WECHAT",COUNTRY_CODE_CH="CH";touroperatorVM=null,categoriesVM=null,categoriesContainerVM=null,seasonVM=null,settingsVM=null,headerVM=null,shoppingcartVM=null,checkoutVM=null,salesVM=null,turnoverVM=null,ticketsVM=null,ticketsCheckoutVM=null,cancelVM=null,storeCreditsVM=null,busVM=null,driverVM=null,toursVM=null,tourguideToursVM=null,abosVM=null,registrationVM=null,registrationDetailVM=null,packagesVM=null,menuVM=new menuViewModel,packageVM=null,groupReservationVM=null,groupReservationsVM=null,groupReservationCategoriesCacheVM=null,$.ajaxSetup({cache:!1}),DATE_SERVER_FORMAT="yy-mm-dd",MOMENTJS_DATE_SERVER_FORMAT="YYYY-MM-DD",MOMENTJS_DATE_TIME_SERVER_FORMAT="YYYY-MM-DD HH:mm",DEBUG_ENABLE_MODALS=!1,$.datepicker.setDefaults($.datepicker.regional[subjectLang]),DATE_PICKER_FORMAT=$.datepicker._defaults.dateFormat,moment.locale(subjectLang);var REGISTRATION_ACTIVITY=Object.freeze({CREATED:"CREATED",CREATED_FROM_CSV_IMPORT:"CREATED_FROM_CSV_IMPORT",CREATED_FROM_API_IMPORT:"CREATED_FROM_API_IMPORT",CREATED_FROM_WEBSHOP:"CREATED_FROM_WEBSHOP",CLONED:"CLONED",DISCARDED:"DISCARDED",QUICK_CHECKIN_SEND:"QUICK_CHECKIN_SEND",SYSTEM_QUICK_CHECKIN_SEND:"SYSTEM_QUICK_CHECKIN_SEND",DIGITAL_GUESTCARD_SEND:"DIGITAL_GUESTCARD_SEND",SYSTEM_DIGITAL_GUESTCARD_SEND:"SYSTEM_DIGITAL_GUESTCARD_SEND",DATA_CHANGED:"DATA_CHANGED",VERIFIED:"VERIFIED",COMPLETED:"COMPLETED",CHECKED_IN:"CHECKED_IN",CHECKED_OUT:"CHECKED_OUT",WELCOME_MAIL_SEND:"WELCOME_MAIL_SEND",REGISTRATION_DISCARDED:"REGISTRATION_DISCARDED"}),RegistrationLogger=function(){function a(){var a=new Object("RegistrationLoggerInstance");return a.queue=[],a.enqueue=function(b,c,d){a.queue.push({registrationId:b,details:d,logEventType:c})},a.flush=function(){a.writeLogs(a.queue),a.queue=[]},a.writeLog=function(b,c,d){var e={registrationId:b,details:d,logEventType:c};a.writeLogs([e])},a.writeLogs=function(a){return $.ajax({url:serviceRootURL+"/write_registration_logs",type:"POST",data:JSON.stringify(a),dataType:"json",contentType:"application/json",success:function(a,b,c){},error:function(a,b,c){showError("Fehler beim Registration log speichern",a,b,c)}})},a.readLogs=function(a){return $.ajax({url:serviceRootURL+"/read_registration_log/"+a,type:"GET",data:{},dataType:"json",contentType:"application/json",error:function(a,b,c){return showError("Fehler beim Registration log lesen",a,b,c),[]}})},a}var b;return{getInstance:function(){return b||(b=a()),b}}}(),REGISTRATION_UPDATE_PARAM=Object.freeze({ALL:"all",ATTACHMENT:"attachment"}),RegistrationDetailedViewModel=function(a,b,c){var d=this;console.log("RegistrationDetailedViewModel",c),abstractPersonalizationViewModel.apply(d,[]),d.registrationConfig=c,d.registration=ko.observable(new RegistrationDetailedModel),d.closeDialog=ko.observable(!1),d.showLoadingSpinner=ko.observable(!1),d.mainPersonVacationStart=ko.observable(),d.mainPersonVacationEnd=ko.observable(),d.dayTextInputs=ko.observable({}),d.monthTextInputs=ko.observable({}),d.yearTextInputs=ko.observable({}),d.monthKeyHandler=function(a,b){if(b.keyCode>=48&&b.keyCode<=57||b.keyCode>=96&&b.keyCode<=105){if(!d.monthTextInputs().hasOwnProperty(b.target)){var c=d.monthTextInputs();c[b.target]=ko.observable(""),d.monthTextInputs(c)}var e=d.monthTextInputs()[b.target];e(parseInt(e()+b.key)>12?b.key:e()+b.key),a.birthdateMonth(e())}else if(8===b.keyCode){if(!d.monthTextInputs().hasOwnProperty(b.target)){var c=d.monthTextInputs();c[b.target]=ko.observable(""),d.monthTextInputs(c)}var e=d.monthTextInputs()[b.target];e().length>0&&e(e().substring(0,e().length-1)),a.birthdateMonth(e())}},d.dayKeyHandler=function(a,b){if(b.keyCode>=48&&b.keyCode<=57||b.keyCode>=96&&b.keyCode<=105){if(!d.dayTextInputs().hasOwnProperty(b.target)){var c=d.dayTextInputs();c[b.target]=ko.observable(""),d.dayTextInputs(c)}var e=d.dayTextInputs()[b.target];e(parseInt(e()+b.key)>31?b.key:e()+b.key),a.birthdateDay(parseInt(e())),console.log("Set birthdateDay",e(),a.birthdateDay())}else if(8===b.keyCode){if(!d.dayTextInputs().hasOwnProperty(b.target)){var c=d.dayTextInputs();c[b.target]=ko.observable(""),d.dayTextInputs(c)}var e=d.dayTextInputs()[b.target];e().length>0&&e(e().substring(0,e().length-1)),a.birthdateDay(e())}},d.allPersonCheckedOut=function(){var a=!0;return d.registration().ticketHolderList().forEach(function(b){b.checkedOut()||(a=!1)}),a},d.onePersonCheckedIn=function(){var a=!1;return d.registration().ticketHolderList().forEach(function(b){b.checkedIn()&&(a=!0)}),a},d.setLoading=function(a){d.showLoadingSpinner(a),a?($("#addPersonBtn").attr("disabled",!0),$("#addGroupBtn").attr("disabled",!0),$("#saveBtn").attr("disabled",!0),$("#saveAndCloseBtn").attr("disabled",!0)):(d.isViewEditAllowed()&&($("#addPersonBtn").attr("disabled",!1),$("#saveBtn").attr("disabled",!1),$("#saveAndCloseBtn").attr("disabled",!1),$("#addGroupBtn").attr("disabled",!d.addGroupEnabled())),d.registration().status()!=REGISTRATION_FORM_STATES_ENUM.CHECKED_OUT||d.allPersonCheckedOut()||($("#saveBtn").attr("disabled",!1),$("#saveAndCloseBtn").attr("disabled",!1)))},d.isReadOnly=ko.computed(function(){return menuVM.hasRegistrationReadOnlyRights()}),d.optionBtnDisabled=ko.computed(function(){return!!d.showLoadingSpinner()||!!d.isReadOnly()}),d.printBtnDisabled=ko.computed(function(){if(d.showLoadingSpinner())return!0;if(d.isReadOnly())return!0;if(d.registrationConfig.printVersion()){if("default"!=d.registrationConfig.printVersion())return!(d.registration().status()==REGISTRATION_FORM_STATES_ENUM.CHECKED_IN||d.registration().status()==REGISTRATION_FORM_STATES_ENUM.CHECKED_OUT||d.registration().status()==REGISTRATION_FORM_STATES_ENUM.COMPLETED)}return!1}),d.isRemoveAllowed=ko.computed(function(){return!(d.registration().status()==REGISTRATION_FORM_STATES_ENUM.CHECKED_IN||d.registration().status()==REGISTRATION_FORM_STATES_ENUM.CHECKED_OUT||d.registration().status()==REGISTRATION_FORM_STATES_ENUM.DISCARDED||d.registration().exportDate())}),d.discardAllowed=ko.computed(function(){return 1!=d.showLoadingSpinner()&&(!d.isReadOnly()&&d.registration().discardAllowed())});var e=new RegExp("^[0-9]+$");d.roomingListChangeCallback=function(a,b,c){if(console.log("roomingListChangeCallback",a,b,c),d.registration().formId())l(REGISTRATION_UPDATE_PARAM.ATTACHMENT);else{m(function(a){d.registration().formId(a)})}},d.billingAddressStreet=ko.computed(function(){return headerVM.billingAddress().street()}),d.billingAddressCity=ko.computed(function(){var a=headerVM.billingAddress();return a.postcode()+" "+a.city()}),d.resellerId=ko.computed(function(){var a=headerVM.billingAddress();return a.firstname()+" "+a.lastname()}),d.getPageIndexText=function(a){var b=Math.floor(d.registration().ticketHolderList().length/4)+1;if(console.log("getPageIndexText",a,b,Math.floor(a/4)-1),a){return Math.floor(a/4)+" / "+b}return b+" / "+b};var f=function(a,b,c){return!(!a.isSame(c)&&!b.isSame(c))||!(!a.isBefore(c)||!b.isAfter(c))},g=function(a){var b=[],c=[];if(!a)return d.registrationConfig.touristTaxConfigList();for(var e=0;e<d.registrationConfig.touristTaxConfigList().length;e++){var f=d.registrationConfig.touristTaxConfigList()[e];f.regionId==a.regionId&&(f.accommodationTypeName===a.accommodationTypeName&&(null!=f.cityId&&f.cityId!=a.cityId||(null!=f.serviceProviderId&&f.serviceProviderId==a.serviceProviderId?b.push(f):c.push(f))))}return b.length>0?(console.log("Using exceptional config ",b),b):c},h=function(a,b,c,d){for(var e=c.diff(b,"days"),g=0,h=0;h<d.length;h++){var i=d[h];if(i.ageFrom<=a&&(null==i.ageTo||a<=i.ageTo)){var j=moment(i.seasonStartDate,"YYYY-M-D"),k=moment(i.seasonEndDate,"YYYY-M-D"),l=f(j,k,b),m=f(j,k,c);if(l&&m)g+=i.price*e;else if(!l||m)if(l||!m);else{var n=c.diff(j,"days");g+=i.price*n}else{var n=k.diff(b,"days")+1;g+=i.price*n}}}return Number(g.toFixed(2))};d.taxRateTotal=ko.computed(function(){var a=getMomentJsDateFormat();if(null==d.registrationConfig)return 0;var b=null;headerVM.assignedServiceProviderList().forEach(function(a){d.registration()&&a.serviceProviderExternalId===d.registration().selectedServiceProvider()&&(b=a)});var c,e,f=g(b),i=0,j=0;if(d.registration()){for(var k=0;k<d.registration().ticketHolderList().length;k++){var l=d.registration().ticketHolderList()[k],m=null;if(l.birthdateMonth()&&l.birthdateDay()&&l.birthdateYear()&&l.vacationFromDate()){var n=l.birthdateYear()+"-"+l.birthdateMonth()+"-"+l.birthdateDay(),o=moment(n,"YYYY-MM-DD");if(o.isValid()){m=moment(l.vacationFromDate(),a).diff(o,"years");var p=d.registrationConfig.getPersonGroupForAge(m);p?(l.taxPersonGroupId(p.personGroupId),l.taxRateCode(p.taxRateCode),$("#personGroupSelect"+k).attr("disabled",!0)):$("#personGroupSelect"+k).attr("disabled",!1)}}if(null==m){$("#personGroupSelect"+k).removeAttr("disabled");var q=l.taxPersonGroupId();if(null!=q){var p=d.registrationConfig.getPersonGroupForId(q);p&&(m=p.ageFrom,l.taxRateCode(p.taxRateCode))}}if(null!=m&&d.registrationConfig.showTouristTax()){if(l.vacationFromDate()&&l.vacationToDate()&&null!=b){var r=moment(l.vacationFromDate(),a),s=moment(l.vacationToDate(),a);if(!0===l.mainPerson()&&(c=r,e=s),0==l.accommodationTaxExemption()&&m>=16){var t=s.diff(r,"days");i+=t,l.accommodationTaxRate(t)}else l.accommodationTaxRate(0);if(0==l.residenceTaxExemption()){var u=h(m,r,s,f);l.taxRate(u),j+=u}else l.taxRate(0)}d.registration().registrationDiscarded()&&(l.accommodationTaxRate(0),l.taxRate(0),i=0,j=0)}}var v=d.registration().groupData(),w=0,x=0;c&&e&&null!=b&&null!=v&&(v.personGroupList().forEach(function(b){var g=d.registrationConfig.getPersonGroupForId(b.personGroupId());if(null!=g){var i=coalesce(moment(b.fromDate(),a),c),j=coalesce(moment(b.toDate(),a),e),k=h(g.ageFrom,i,j,f);if(x+=k*b.nrOfPersons(),g.ageFrom>=16){var l=j.diff(i,"days");w+=l*b.nrOfPersons()}}}),d.registration().registrationDiscarded()?(v.accommodationTaxRate(0),v.taxRate(0)):(v.taxRate(x),v.accommodationTaxRate(w))),d.registration().registrationDiscarded()?(d.registration().accommodationTaxTotal(0),d.registration().taxRateTotal(0)):(d.registration().taxRateTotal(Number((x+j).toFixed(2))),d.registration().accommodationTaxTotal(Number((w+i).toFixed(2))))}return c&&d.mainPersonVacationStart(c.format("L")),e&&d.mainPersonVacationEnd(e.format("L")),d.registration().taxRateTotal()},d).extend({throttle:50}),d.clearPersonData=function(a,b){var c=ko.contextFor(b.target).$index();d.registration().clearPersonData(c),i(c,!0)},d.swissPassIDChanged=function(a,b){var c=a.swissPassId();if(isSwisspassNumber(c)){a.mediaCardId(c.replace(/-/g,"")),a.media(MEDIA_SWISSPASS),a.swissPassZipCode("");var d=b.target.id.replace("swisspass","#swisspassZip");$(d).focus(),console.log("Valid swisspassId found",a.mediaCardId())
}else a.swissPassZipCode(""),a.media(MEDIA_KEYCARD)};var i=function(a,b){var c=$("#swisspassZip"+a),d=$("#swisspass"+a),e=$("#salutation"+a),f=$("#firstName"+a),g=$("#secondName"+a),h=$("#lastName"+a),i=$("#dateOfBirthDay"+a),j=$("#dateOfBirthMonth"+a),k=$("#dateOfBirthYear"+a),l=$("#streetname"+a),m=$("#streetNumber"+a),n=$("#zipCode"+a),o=$("#city"+a),p=$("#country"+a),q=$("#swissPassBtn"+a);0==b?(c.addClass("swisspass-data"),d.addClass("swisspass-data"),e.addClass("swisspass-data"),f.addClass("swisspass-data"),g.addClass("swisspass-data"),h.addClass("swisspass-data"),i.addClass("swisspass-data"),j.addClass("swisspass-data"),k.addClass("swisspass-data"),l.addClass("swisspass-data"),m.addClass("swisspass-data"),n.addClass("swisspass-data"),o.addClass("swisspass-data"),p.addClass("swisspass-data"),$(".swisspass-data").attr("disabled"),q.removeAttr("disabled")):(c.removeClass("swisspass-data"),d.removeClass("swisspass-data"),e.removeClass("swisspass-data"),f.removeClass("swisspass-data"),g.removeClass("swisspass-data"),h.removeClass("swisspass-data"),i.removeClass("swisspass-data"),j.removeClass("swisspass-data"),k.removeClass("swisspass-data"),l.removeClass("swisspass-data"),m.removeClass("swisspass-data"),n.removeClass("swisspass-data"),o.removeClass("swisspass-data"),p.removeClass("swisspass-data"),$(".swisspass-data").removeAttr("disabled"),q.attr("disabled",!0))};d.getSwisspassInfo=function(a,b,c,e){var f={mediaId:c,zipCode:e};console.log("Retrieving swisspass info via mediacardextinfo",f);var g=$("#swisspassZip"+b),h=$("#swisspass"+b);$.ajax({url:serviceRootURL+"/mediacardextinfo",type:"GET",data:f,dataType:"json",contentType:"application/json",beforeSend:function(){d.setLoading(!0),g.blur(),g.addClass("swisspass-data"),h.addClass("swisspass-data")},success:function(a,c,e){console.log("swisspass uid: ",a),null!=a.ticketholder&&(console.log("Valid ticketholder found",a.ticketholder),d.registration().setDataFromSwisspass(a.ticketholder,b),i(b,!1))},error:function(a,c,d){console.log("mediacard service failed: "+a.responseText),checkSession(a),i(b,!0),getErrorCode(a)==ERR_CODE_INVALID_MEDIAID&&showError(i18n.t("checkout.msg.swisspassInvalidMediaId"),a,c,d,!0)},complete:function(){d.setLoading(!1)}})},d.validateNumberInput=function(a,b){return b.keyCode>=48&&b.keyCode<=57||b.keyCode>=96&&b.keyCode<=105||8==b.keyCode||9==b.keyCode},d.swissPassZipChanged=function(a,b){var c=a.swissPassZipCode();if(e.test(c)&&4==c.length){var f=a.swissPassId(),g=ko.contextFor(b.target);b.target.id.replace("swisspassZip","");d.getSwisspassInfo(a,g.$index(),f,c)}},d.removePerson=function(a){if(!d.isReadOnly())return d.registration().isPersonEmpty(a)?void d.registration().removePerson(a):void(d.isRemoveAllowed()&&(showQuestionYesNo(i18n.t("registration.details.removePersonQuestion"),function(b){1==b&&d.registration().removePerson(a)}),$(".bootbox-confirm").find("div.modal-dialog").addClass("popup-confirm-box")))},d.addGroupEnabled=ko.computed(function(){return null==d.registration().groupData()}),d.removeGroup=function(){if(!d.isReadOnly()){var a=d.registration().groupData();if(d.registration().isGroupEmpty(a))return void d.registration().removeGroup(a);d.isRemoveAllowed()&&(showQuestionYesNo(i18n.t("registration.details.removeGroupQuestion"),function(b){1==b&&d.registration().removeGroup(a)}),$(".bootbox-confirm").find("div.modal-dialog").addClass("popup-confirm-box"))}},d.setCountryOptionDisableState=function(a,b){ko.applyBindingsToNode(a,{disable:void 0!=b&&"SP"===b.key},b)},d.addPerson=function(){d.registration().addElement(GROUP_PERSON_ENUM.PERSON),$("#addPersonBtn").blur()},d.addGroup=function(){d.registration().addElement(GROUP_PERSON_ENUM.GROUP),d.registrationConfig.personGroupOptionList().forEach(function(a){var b=d.registration().createPersonGroupDataObservable();b.personGroupId(a.personGroupId),b.taxRateCode(a.taxRateCode),b.personGroupName(a.personGroupName),d.registration().groupData().personGroupList.push(b)}),$("#addGroupBtn").blur()},d.addGroupAgeRow=function(a){var b=d.registration().groupData().personGroupList()[a],c=d.registration().createPersonGroupDataObservable();c.personGroupId(b.personGroupId()),c.taxRateCode(b.taxRateCode()),c.personGroupName(b.personGroupName()),d.mainPersonVacationStart()&&c.fromDate(d.mainPersonVacationStart()),d.mainPersonVacationEnd()&&c.toDate(d.mainPersonVacationEnd()),c.showMinusBtn(ko.observable(!0));var e=d.registration().groupData().personGroupList();e.splice(a+1,0,c),d.registration().groupData().personGroupList([]),d.registration().groupData().personGroupList(e)},d.removeGroupAgeRow=function(a){var b=d.registration().groupData().personGroupList();b.splice(a,1),d.registration().groupData().personGroupList([]),d.registration().groupData().personGroupList(b)},ko.computed(function(){d.registration()&&d.registration().groupData()&&!d.registration().groupData().isGroupTravelChecked()&&d.registration().groupData().personGroupList().forEach(function(a){a.fromDate(d.mainPersonVacationStart()),a.toDate(d.mainPersonVacationEnd())})}),ko.computed(function(){if(d.registration()&&d.registration().groupData()&&d.registration().groupData().personGroupList()){var a={};d.registration().groupData().personGroupList().forEach(function(b){a[b.personGroupId()]?a[b.personGroupId()]++:a[b.personGroupId()]=1}),d.registration().groupData().personGroupList().forEach(function(b){b.showMinusBtn(a[b.personGroupId()]>1)})}}),d.createGuestcardCallback=function(a){if(a){var b=d.registration().getMainPersonLanguage();null===b&&(b="htg"===d.registrationConfig.printVersionAnalogGuestcard()?"de":"en");var c=serviceRootURL+"/guestcard/analog/"+d.registration().hash()+"?language="+b+"&type="+d.registrationConfig.printVersionAnalogGuestcard();try{window.open(c,"_blank","toolbar=no, location=no, status=no, scrollbars=yes, resizable=yes, width=600, height=800")}catch(a){window.location=c}}},d.guestcardActivatedText=function(a){if(a.guestcardCanceled())return i18n.t("registration.details.guestcardCanceled");if("complete"==a.directPurchaseStatus()){if(!d.registrationConfig.allowProlongationOfActivatedGuestcards())return i18n.t("registration.details.guestActivatedHint");if(d.registration().analogGuestcardActivated())return i18n.t("registration.details.analogGuestActivated");if(d.registration().guestcardActivated())return i18n.t("registration.details.guestActivated")}return"error"==a.directPurchaseStatus()?i18n.t("registration.details.guestcardActivationError"):null},d.printAnalogGuestCard=function(){var a=function(){d.registrationConfig.printVersionAnalogGuestcard()?"htg"==d.registrationConfig.printVersionAnalogGuestcard()?d.registrationConfig.hidePrintAnalogGuestcardMessage()?d.createGuestcardCallback(!0):bootbox.confirm({message:i18n.t("registration.details.nonDigitalGuestcard.messageHtg"),callback:d.createGuestcardCallback,buttons:{confirm:{label:i18n.t("registration.details.nonDigitalGuestcard.confirm")},cancel:{label:i18n.t("registration.details.nonDigitalGuestcard.cancel")}}}):d.createGuestcardCallback(!0):d.registrationConfig.hidePrintAnalogGuestcardMessage()?d.createGuestcardCallback(!0):bootbox.confirm({message:i18n.t("registration.details.nonDigitalGuestcard.message"),callback:d.createGuestcardCallback,buttons:{confirm:{label:i18n.t("registration.details.nonDigitalGuestcard.confirm")},cancel:{label:i18n.t("registration.details.nonDigitalGuestcard.cancel")}}})};if(d.registration().dataChanged()){if(d.registration().completed()){if(!d.validateRegistrationForm())return}l(REGISTRATION_UPDATE_PARAM.ALL,a,!0)}else a()},d.sendDigitalGuestcardMail=function(){if(d.registration().completed()){var a=d.validateRegistrationForm();if(!a)return}var a=$("#emailId0").parsley().validate();if(console.log("sendDigitalGuestcardMail",d.registration().formId()),!0===a)if(d.registration().formId()){var b=serviceRootURL+"/registration/guestcard/"+d.registration().formId();$.ajax({url:b,type:"PUT",data:JSON.stringify(d.registration().toJson()),dataType:"json",contentType:"application/json",beforeSend:function(){d.setLoading(!0)},success:function(a,b,c){console.log("sendDigitalGuestcardMail successful",a),showInfo(i18n.t("registration.details.digitalGuestcardMailSuccess"),function(){d.closeRegistrationDialog()}),$(".bootbox-alert").find("div.modal-dialog").addClass("popup-confirm-box")},error:function(a,b,c){showError("Fehler beim senden der Mail für die digitale Gästekarte",a,b,c)},complete:function(){d.setLoading(!1),$(".registrationBtns").blur()}}),d.registration().setEmailCheckedIn()}else m(function(a){showInfo(i18n.t("registration.details.digitalGuestcardMailSuccess"),function(){d.closeRegistrationDialog()}),$(".bootbox-alert").find("div.modal-dialog").addClass("popup-confirm-box")},!0)},d.quickCheckin=function(){var a=$("#emailId0").parsley().validate();if(console.log("Validating email address",a),d.registration().completed()){d.validateRegistrationForm()||d.registration().completed(!1)}if(!0===a)if(d.registration().formId()){var b=serviceRootURL+"/registration/quickcheckin/"+d.registration().formId();$.ajax({url:b,type:"PUT",data:JSON.stringify(d.registration().toJson()),dataType:"json",contentType:"application/json",beforeSend:function(){d.setLoading(!0)},success:function(a,b,c){console.log("quickCheckin successful",a),showInfo(i18n.t("registration.details.quickCheckinSent"),function(){d.closeRegistrationDialog()}),$(".bootbox-alert").find("div.modal-dialog").addClass("popup-confirm-box")},error:function(a,b,c){showError("Fehler beim senden der Mail für Quickcheckin",a,b,c)},complete:function(){d.setLoading(!1),$(".registrationBtns").blur()}}),d.registration().setEmailCheckedIn()}else m(function(a){showInfo(i18n.t("registration.details.quickCheckinSent"),function(){d.closeRegistrationDialog()}),$(".bootbox-alert").find("div.modal-dialog").addClass("popup-confirm-box")},!0)},d.printRegistration=function(){d.setLoading(!0);var a="default";if(d.registrationConfig.printVersion()&&(a=d.registrationConfig.printVersion()),"default"==a)$(".registrationBtns").blur(),ko.cleanNode($("#printSection")[0]),$("#printSection").load("assets/registration-details.html",function(){ko.applyBindings(d,document.getElementById("printSection")),$("#printSection").find("input[type=textarea], input[type=password], select, textarea").each(function(a){$(this).val()||($(this).val(" "),$(this).text(" "))}),$("#printSection").find(".main-layout").each(function(a){$(this).removeClass("col-sm-12"),$(this).addClass("col-sm-6")}),setTimeout(function(){d.setLoading(!1),window.print()},1e3)});else{var b=serviceRootURL+"/guestcard/analog/"+d.registration().hash()+"?language=de&type="+a;try{window.open(b,"_blank","toolbar=no, location=no, status=no, scrollbars=yes, resizable=yes, width=1435, height=875");d.setLoading(!1)}catch(a){window.location=b,d.setLoading(!1)}}return!1},d.discardRegistration=function(){d.registration().toJson().formId?(d.registration().guestcardActivated()?showQuestionYesNo(i18n.t("registration.details.discardRegistrationQuestionWithGuestcard"),function(a){1==a&&(d.registration().setDiscarded(),d.submitRegistrationData(!0))}):showQuestionYesNo(i18n.t("registration.details.discardRegistrationQuestion"),function(a){1==a&&(d.registration().setDiscarded(),d.submitRegistrationData(!0))}),$(".bootbox-confirm").find("div.modal-dialog").addClass("popup-confirm-box")):d.closeRegistrationDialog()},d.closeRegistrationDialog=function(){d.closeDialog(!0),$("#registrationDetails").modal("hide")},d.showFieldInfo=function(a,b){var c=b.target.id.split("-")[0];j(c)},d.closeAll=function(){$("#registrationDetails button").each(function(a){var b=$("#registrationDetails button")[a];b.id.includes("info")&&k(b.id.split("-")[0])})};var j=function(a){null!=document.getElementById(a)&&(document.getElementById("registrationBlock").style.display="block",document.getElementById("registrationDetailBlock").style.display="block",document.getElementById(a).style.display="block")},k=function(a){null!=document.getElementById(a)&&(document.getElementById("registrationBlock").style.display="none",document.getElementById("registrationDetailBlock").style.display="none",document.getElementById(a).style.display="none")};d.cancelRegistration=function(){if(!d.registration().dataChanged()||d.registration().registrationDiscarded())return void d.closeRegistrationDialog();showQuestionYesNo(i18n.t("registration.details.cancelRegistrationQuestion"),function(a){1==a&&d.closeRegistrationDialog()}),$(".bootbox-confirm").find("div.modal-dialog").addClass("popup-confirm-box")},d.setViewEnableState=function(a){$("#registrationForm :input").each(function(){var b=$(this).attr("id");null!=b?-1==b.indexOf("checkinBtn")&&-1==b.indexOf("checkoutBtn")&&-1==b.indexOf("fromDatePicker")&&-1==b.indexOf("toDatePicker")&&$(this).attr("disabled",!a):$(this).attr("disabled",!a)}),$("#cancelBtn").attr("disabled",!1),$("#closeDialogIcon").attr("disabled",!1)},d.validateRegistrationForm=function(){d.registration().groupContainsExemptions()>0&&$("#exemptionReasons").attr("required",!0),$(".input-required").attr("required",!0);var a=$("#registrationForm").parsley().validate();return $(".input-required").attr("required",!1),$("#exemptionReasons").attr("required",!1),a&&d.validateBirthdates()},d.validateBirthdates=function(){var a=!0,b=0;return d.registration().ticketHolderList().forEach(function(c){if(c.birthdateDay()&&c.birthdateMonth()&&c.birthdateYear()){var d=c.birthdateYear()+"-"+c.birthdateMonth()+"-"+c.birthdateDay(),e=moment(d,MOMENTJS_DATE_SERVER_FORMAT).isValid(),f=moment(d,MOMENTJS_DATE_SERVER_FORMAT).isAfter(moment()),g=$("#dateOfBirthDay"+b).parsley();g&&(g.removeError("invalidBirthdate"),!e||f?(a=!1,$("#dateOfBirthDay"+b).removeClass("parsley-success"),$("#dateOfBirthDay"+b).addClass("parsley-error"),$("#dateOfBirthMonth"+b).removeClass("parsley-success"),$("#dateOfBirthMonth"+b).addClass("parsley-error"),$("#dateOfBirthYear"+b).removeClass("parsley-success"),$("#dateOfBirthYear"+b).addClass("parsley-error"),g.addError("invalidBirthdate",{message:i18n.t("registration.details.invalidDate")})):($("#dateOfBirthDay"+b).removeClass("parsley-error"),$("#dateOfBirthMonth"+b).removeClass("parsley-error"),$("#dateOfBirthYear"+b).removeClass("parsley-error")))}b++}),a},d.birthdateListener=ko.computed(function(){d.validateBirthdates()}).extend({throttle:10});var l=function(a,b,c){var e=d.registration().toJson();console.log("Updating registration form",e,a);var f=serviceRootURL+"/registration/"+e.formId;a&&(f=f+"?updatePart="+a),$.ajax({url:f,type:"PUT",data:JSON.stringify(e),dataType:"json",contentType:"application/json",beforeSend:function(){d.setLoading(!0)},success:function(a,f,g){d.setLoading(!1),b&&"function"==typeof b&&b(e.formId),c&&d.updatePersonIds(d.registration().hash())},error:function(a,b,c){showError("Fehler beim Speichern der Registrierung",a,b,c),d.setLoading(!1)},complete:function(){}})},m=function(a,b){var c=d.registration().toJson(),e=serviceRootURL+"/registration";b&&(e+="?quickCheckin=true"),console.log("Calling createRegistration with",c),$.ajax({url:e,type:"POST",data:JSON.stringify(c),dataType:"json",contentType:"application/json",beforeSend:function(){d.setLoading(!0)},success:function(b,c,d){console.log("Created registration",b),a&&"function"==typeof a&&a(b.formId)},error:function(a,b,c){showError("Fehler beim Erstellen der Registrierung",a,b,c)},complete:function(){d.setLoading(!1)}})};d.confirmCloneRegistration=function(){showQuestionYesNo(i18n.t("registration.details.cloneRegistrationQuestion")+": "+d.registration().resellerNumber()+"?",function(a){1==a&&d.cloneRegistration()}),$(".bootbox-confirm").find("div.modal-dialog").addClass("popup-confirm-box")},d.cloneRegistration=function(){d.registration().formId(null),d.registration().formIdProvider(null),d.registration().comment(null),d.registration().importId(null),d.registration().clone(!0),d.registration().registrationDiscarded(!1),d.registration().verified(!1),d.registration().completed(!1),d.registration().webshopBooking(!1),d.registration().quickStatus(0),d.registration().quickStatusSubmitTime(null),d.registration().genericQuickCheckin(!1),d.registration().guestcardDefinitionAvailable(!1),d.registration().guestcardActivated(!1),d.registration().analogGuestcardActivated(!1),d.registration().status(REGISTRATION_FORM_STATES_ENUM.NEW),d.registration().ticketHolderList().forEach(function(a){a.status(TRAVEL_STATES_ENUM.AWAITED),a.personId=void 0,a.checkedIn(!1),a.checkedOut(!1),a.directPurchaseStatus(null),a.enabled(!0)}),d.registration().resetDateRestrictions(!0),d.registration().resetDateRestrictions(!1),null!=d.registration().groupData()&&(d.registration().groupData().groupId=null,d.registration().groupData().personGroupList().forEach(function(a){a.id(null)})),d.registration().historyLogs([]),d.setViewEnableState(!0),$("#registrationDetails").animate({scrollTop:0},"medium")},d.verificationDisabled=ko.computed(function(){return!!d.onePersonCheckedIn()||(!!d.showLoadingSpinner()||d.registration().status()!=REGISTRATION_FORM_STATES_ENUM.REGISTERED_NOT_VERIFIED&&d.registration().status()!=REGISTRATION_FORM_STATES_ENUM.NEW)}),d.completeCheckDisabled=ko.computed(function(){return!!d.onePersonCheckedIn()||(!!d.showLoadingSpinner()||!(d.registration().status()==REGISTRATION_FORM_STATES_ENUM.REGISTERED_VERIFIED||d.registration().status()==REGISTRATION_FORM_STATES_ENUM.REGISTERED_NOT_VERIFIED||d.registration().status()==REGISTRATION_FORM_STATES_ENUM.NEW))}),d.validationListener=ko.computed(function(){d.registration().completed()&&d.validateRegistrationForm()}),d.toggleDropDown=function(){document.getElementById("moreActions").classList.toggle("show")};var n=function(){if(d.registration().groupData()){var a=10;headerVM.registrationPartnerConfig()&&(a=headerVM.registrationPartnerConfig().personsForGroup());var b=0;if(d.registration().groupData().personGroupList().forEach(function(a){b+=Number(a.nrOfPersons())}),b<a)return showWarning(i18n.t("registration.details.notEnoughPersonsForGroup",{min:a}),"50%"),!1}return!0},o=function(a){if(d.registration().completed()){var b=d.validateRegistrationForm();if(!b)return}else{var c=!0;$(".periodSelection").each(function(){$(this).parsley().validate()||(c=!1)});var e=d.validateBirthdates();if(!c||!e)return}var b=n();b&&(d.registration().guestcardActivated()&&d.registration().checkForDurationChange()?showQuestionYesNo(i18n.t("registration.details.changedDateWithGuestcard"),function(b){1==b&&d.submitRegistrationData(a)}):d.submitRegistrationData(a))};d.saveRegistrationForm=function(){o(!1)},d.saveAndCloseRegistrationForm=function(){o(!0)};var p=function(a){!function(){var b=function(b){a?d.closeRegistrationDialog():(d.loadRegistrationById(b,!1),d.registration().saved(!0))};d.registration().formId()?l(REGISTRATION_UPDATE_PARAM.ALL,b,!a):m(b,!1)}()};d.submitRegistrationData=function(a){console.log("submitRegistrationData",d.registration());var b=d.registration().toJson();if(b.status==REGISTRATION_FORM_STATES_ENUM.COMPLETED||b.status==REGISTRATION_FORM_STATES_ENUM.CHECKED_IN&&d.registration().status()!=REGISTRATION_FORM_STATES_ENUM.COMPLETED&&d.registration().status()!=REGISTRATION_FORM_STATES_ENUM.CHECKED_IN){var c=!1;b.personList.forEach(function(a){1==a.mainPerson&&null!=a.email&&void 0!=a.email&&""!=a.email&&(c=!0)}),c?p(a):(showQuestionYesNo(i18n.t("registration.guestcard.noEmailProceedAnyway"),function(b){1==b&&p(a)}),$(".bootbox-confirm").find("div.modal-dialog").addClass("popup-confirm-box"))}else p(a);return!1};var q=function(a,b){if(b==TRAVEL_STATES_ENUM.ARRIVED&&!a.vacationFromDate()){var c=$.datepicker.formatDate(DATE_PICKER_FORMAT,new Date);a.vacationFromDate(c)}if(b==TRAVEL_STATES_ENUM.DEPARTED&&!a.vacationToDate()){var c=$.datepicker.formatDate(DATE_PICKER_FORMAT,new Date);a.vacationToDate(c)}b==TRAVEL_STATES_ENUM.ARRIVED&&a.checkedIn(!0),b==TRAVEL_STATES_ENUM.DEPARTED&&a.checkedOut(!0),a.status(b)};d.setCheckin=function(a){if(d.validateRegistrationForm())if(d.registration().verified(!0),d.registration().completed(!0),d.registration().ticketHolderList().length>1){for(var b=!1,c=0;c<d.registration().ticketHolderList().length;c++){var e=d.registration().ticketHolderList()[c];e.id()!=a.id()&&e.status()!=TRAVEL_STATES_ENUM.ARRIVED&&(b=!0)}b?showQuestionYesNo(i18n.t("registration.details.checkinAllPersons"),function(b){if(1==b)for(var c=0;c<d.registration().ticketHolderList().length;c++){var e=d.registration().ticketHolderList()[c];e.status()!=TRAVEL_STATES_ENUM.ARRIVED&&q(e,TRAVEL_STATES_ENUM.ARRIVED)}else q(a,TRAVEL_STATES_ENUM.ARRIVED)}):q(a,TRAVEL_STATES_ENUM.ARRIVED),$(".bootbox-confirm").find("div.modal-dialog").addClass("popup-confirm-box")}else q(a,TRAVEL_STATES_ENUM.ARRIVED)},d.setCheckout=function(a){if(d.validateRegistrationForm())if(d.registration().verified(!0),d.registration().completed(!0),d.registration().ticketHolderList().length>1){for(var b=!1,c=0;c<d.registration().ticketHolderList().length;c++){var e=d.registration().ticketHolderList()[c];e.id()!=a.id()&&e.status()!=TRAVEL_STATES_ENUM.DEPARTED&&(b=!0)}b?showQuestionYesNo(i18n.t("registration.details.checkoutAllPersons"),function(b){if(1==b)for(var c=0;c<d.registration().ticketHolderList().length;c++){var e=d.registration().ticketHolderList()[c];e.status()!=TRAVEL_STATES_ENUM.DEPARTED&&q(e,TRAVEL_STATES_ENUM.DEPARTED)}else q(a,TRAVEL_STATES_ENUM.DEPARTED)}):q(a,TRAVEL_STATES_ENUM.DEPARTED),$(".bootbox-confirm").find("div.modal-dialog").addClass("popup-confirm-box")}else q(a,TRAVEL_STATES_ENUM.DEPARTED)},d.isCheckinBtnEnabled=ko.computed(function(){return!d.registration().registrationDiscarded()&&!d.isReadOnly()}),d.isCheckoutBtnEnabled=ko.computed(function(){return!d.registration().registrationDiscarded()&&!d.isReadOnly()}),d.isReadOnly=ko.computed(function(){return menuVM.hasRegistrationReadOnlyRights()}),d.checkForTicketholderData=function(){for(var a=0;a<d.registration().ticketHolderList().length;a++){var b=d.registration().ticketHolderList()[a];i(a,0==b.containsSwisspassData())}},d.isViewEditAllowed=function(){return!(d.registration().status()==REGISTRATION_FORM_STATES_ENUM.DISCARDED||d.registration().status()==REGISTRATION_FORM_STATES_ENUM.CHECKED_OUT||d.registration().exportDate()||d.registration().editLimitExceeded()||d.isReadOnly())},d.setViewStatesForRegistration=function(){d.isViewEditAllowed()?d.checkForTicketholderData():(d.setViewEnableState(!1),d.registration().ticketHolderList().forEach(function(a){a.enabled(!1)}))},d.loadRegistrationById=function(a,b){d.setLoading(!0),$.ajax(serviceRootURL+"/registration/"+a,{type:"GET",data:null,dataType:"json",contentType:"application/json",success:function(c,e,f){d.registration().setData(c),console.log("Registration loaded for ID: "+a,c,d.registration()),b?d.cloneRegistration():(d.setViewStatesForRegistration(),d.loadHistory()),d.setLoading(!1),d.focusFirstInputField()},error:function(a,b,c){showError("Fehler beim laden der Registrierung",a,b,c),d.setLoading(!1)}})},d.updatePersonIds=function(a){$.ajax(serviceRootURL+"/registration_detail/"+a,{type:"GET",data:null,dataType:"json",contentType:"application/json",success:function(a,b,c){for(var e=0;e<d.registration().ticketHolderList().length;e++){var f=d.registration().ticketHolderList()[e];if(!f.id()){var g=a.personList[e];g&&(f.id(g.id),f.personId=g.id)}}},error:function(a,b,c){showError("Fehler beim laden der Registrierung",a,b,c),d.setLoading(!1)}})},d.loadRegistrationByHash=function(a,b){d.setLoading(!0),$.ajax(serviceRootURL+"/registration_detail/"+a,{type:"GET",data:null,dataType:"json",contentType:"application/json",success:function(c,e,f){d.registration().setData(c),console.log("Registration loaded for ID: "+a,c,d.registration()),b?d.cloneRegistration():(d.setViewStatesForRegistration(),d.loadHistory()),d.setLoading(!1),d.focusFirstInputField()},error:function(a,b,c){showError("Fehler beim laden der Registrierung",a,b,c),d.setLoading(!1)}})},d.focusFirstInputField=function(){$("#registrationForm :input:enabled:visible:first").focus()},a?0==d.registrationConfig.initialized()?d.registrationConfig.initialized.subscribe(function(c){d.loadRegistrationByHash(a,b)}):d.loadRegistrationByHash(a,b):(d.registration().setDefaultArrivalAndDepartureDate(),setTimeout(function(){d.focusFirstInputField()},1e3)),d.historyClicked=function(a,b){d.registration().formId()&&($("#historyLabel").text()==i18n.t("registration.details.hideHistory")?$("#historyLabel").text(i18n.t("registration.details.showHistory")):$("#historyLabel").text()==i18n.t("registration.details.showHistory")&&($("#historyLabel").text(i18n.t("registration.details.hideHistory")),d.loadHistory()))},d.loadHistory=function(){RegistrationLogger.getInstance().readLogs(d.registration().formId()).pipe(function(a,b,c){console.log("History loaded",a),d.registration().historyLogs(a)})},d.getLanguageNameByKey=function(a){for(var b=d.registrationConfig.languageOptions(),c=0;c<b.length;c++){var e=b[c];if(e.key==a)return e.name}return console.warn("Failed to look up language",a,b),null};var r=function(a,b){if(null==b)return i18n.t("registration.details.empty");if("residenceTaxExemption"==a){var c=d.registrationConfig.getResidenceTaxExemptionNameByKey(b);if(null!=c)return c}if("accommodationTaxExemption"==a){var c=d.registrationConfig.getAccommodationTaxExemptionNameByKey(b);if(null!=c)return c}if("gender"==a)for(var e=0;e<d.optionsSalutation().length;e++){var f=d.optionsSalutation()[e];if(f.key==b)return f.name}if("country"==a){var c=d.registrationConfig.getCountryNameByKey(b);if(null!=c)return c}if("nationality"==a){var c=d.registrationConfig.getNationalityNameByKey(b);if(null!=c)return c}if("language"==a){var c=d.getLanguageNameByKey(b);if(null!=c)return c}if("idType"==a){var c=d.registrationConfig.getIdTypeNameByKey(b);if(null!=c)return c}if("taxPersonGroupId"==a){var g=d.registrationConfig.getPersonGroupForId(b);if(null!=g)return g.personGroupName}if("status"==a)return i18n.t("registration.details.states."+b);if("registrationStatus"==a)return i18n.t("registration.details.states."+b);if("taxRateCode"==a){var g=d.registrationConfig.getPersonGroupByCode(b);if(null!=g)return g.personGroupName}if("arrivalBy"==a){var c=d.registrationConfig.getArrivalByNameByKey(b);if(null!=c)return c}return b},s=function(a){function b(a,b){return Object.keys(b).includes(a)?b[a]:a}function c(a,b){return 0==a.length||a.endsWith(b)||a.endsWith("\n")?"":b}function e(a,d,e,f){void 0===e&&(e="");var g=!0,h="";return Object.keys(a).forEach(function(i){var j=a[i];if(void 0!==j.from||void 0!==j.to){var k=r(i,j.from),l=r(i,j.to);h+=c(h,", ");var m=b(i,f);null==j.from?h+=e+i18n.t(d+m)+": "+l:h+=e+i18n.t(d+m)+": "+k+" -> "+l,g=!1}}),h}function f(a){if(void 0!==a&&null!==a){var b=d.registrationConfig.personGroupOptionList().find(function(b){return b.personGroupId==a});return void 0===b?null:b}return null}function g(a){if(void 0!==a&&null!==a){var b=null;return d.registrationConfig.personGroupOptionList().length>a&&(b=d.registrationConfig.personGroupOptionList()[a]),b}return null}function h(a,b){var c=b,d=f(a);return null==d&&(d=g(b)),null!==d&&(c=d.personGroupName),c}var i="";if(!a||null==a)return i;var j=JSON.parse(a),k=Object.keys(j);if(j.hasOwnProperty("changeSource")){var l=j.changeSource;i+=i18n.t("registration.details.history.changeSource."+l)+":\n"}if(j.hasOwnProperty("personList"))for(var m=j.personList,n=Object.keys(m),o=0;o<n.length;o++){var p=n[o],q=m[p];if(null!=q.from&&null==q.to){o>0&&(i+="\n"),i+=i18n.t("registration.details.personRemoved")+" ("+q.from.id+"): ";var s=!0;Object.keys(q.from).forEach(function(a){var b=q.from[a],c=r(a,b);"id"!==a&&(0==s&&(i+=", "),i+=i18n.t("registration.details."+a)+": "+c,s=!1)})}else{o>0&&(i+="\n"),null==q.from&&null!=q.to&&(i+=i18n.t("registration.details.personAdded")+": ",q=q.to),i+="Person "+ ++p+": ";var s=!0;Object.keys(q).forEach(function(a){var b=q[a],c=r(a,b.from),d=r(a,b.to);0==s&&(i+=", "),null==b.from?i+=i18n.t("registration.details."+a)+": "+d:i+=i18n.t("registration.details."+a)+": "+c+" -> "+d,s=!1})}}if(j.hasOwnProperty("groupData")){var t=j.groupData;null==t.from&&null!=t.to&&(i+=i18n.t("registration.details.groupCreated"),i+=", "),null!=t.from&&null==t.to&&(i+=i18n.t("registration.details.groupDeleted")),Object.keys(t).forEach(function(a){var b=t[a];if("groupName"==a){var d=r(a,b.from),f=r(a,b.to);null==b.from?i+=i18n.t("registration.details.group."+a)+": "+f+", ":i+=i18n.t("registration.details.group."+a)+": "+d+" -> "+f+", "}else if("personGroupList"==a)for(var g=0;g<b.length;g++){var j=b[g];if(null!=j){var k=h(j.personGroupId,g);i+=c(i,", "),i+=e(j,"registration.details.group.",k+" - ",{nrOfPersons:"count"})}}})}k.length>0&&(i+="\n");for(var u=0;u<k.length;u++){var v=k[u];if("changeSource"!=v&&"groupData"!=v&&"personList"!=v&&"accommodationTaxRate"!=v&&"taxRateTotal"!=v&&"mainPersonName"!=v&&"status"!=v&&"guestStatus"!=v&&"vacationFromDate"!=v&&"vacationToDate"!=v&&"clone"!=v){var w=r(v,j[v].from),x=r(v,j[v].to);null==j[v].from?i+=i18n.t("registration.details."+v)+": "+x+", ":i+=i18n.t("registration.details."+v)+": "+w+" -> "+x+", ",u<k.length-2&&(i+="\n")}}return i};d.historyLogsArray=ko.computed(function(){var a=[];return d.registration().historyLogs().forEach(function(b){if(b.logEventType===REGISTRATION_ACTIVITY.DIGITAL_GUESTCARD_SEND||b.logEventType===REGISTRATION_ACTIVITY.QUICK_CHECKIN_SEND||b.logEventType===REGISTRATION_ACTIVITY.SYSTEM_QUICK_CHECKIN_SEND||b.logEventType===REGISTRATION_ACTIVITY.WELCOME_MAIL_SEND){var c=i18n.t("registration.details.history."+b.logEventType.toLowerCase())+" : "+moment(b.createdAt.millis).format("L LT");a.push(c)}}),a}),d.getFormatedHistoryLog=function(a){var b=moment(a.createdAt.millis).format("L LTS"),c=b+" ("+a.userName+") - ",d=c;if(a.logEventType===REGISTRATION_ACTIVITY.DATA_CHANGED)d+=s(a.details);else if(a.logEventType===REGISTRATION_ACTIVITY.CREATED_FROM_API_IMPORT||a.logEventType===REGISTRATION_ACTIVITY.CREATED_FROM_CSV_IMPORT){var e=JSON.parse(a.details),f=e.importId;d+=f?i18n.t("registration.details.history."+a.logEventType.toLowerCase())+" - Import ID: "+f:i18n.t("registration.details.history."+a.logEventType.toLowerCase())}else if(a.logEventType===REGISTRATION_ACTIVITY.CREATED_FROM_WEBSHOP){var e=JSON.parse(a.details),g=e.orderId;d+=g?i18n.t("registration.details.history."+a.logEventType.toLowerCase())+" - "+g:i18n.t("registration.details.history."+a.logEventType.toLowerCase())}else if(a.logEventType===REGISTRATION_ACTIVITY.REGISTRATION_DISCARDED){if(null!=a.details){var e=JSON.parse(a.details);if(e&&e.hasOwnProperty("changeSource")){var h=e.changeSource;d+=i18n.t("registration.details.history.changeSource."+h)+": "}}d+=i18n.t("registration.details.history."+a.logEventType.toLowerCase())}else d+=i18n.t("registration.details.history."+a.logEventType.toLowerCase());return d},d.formatedHistory=ko.computed(function(){for(var a="",b=0;b<d.registration().historyLogs().length;b++)a+=d.getFormatedHistoryLog(d.registration().historyLogs()[b]),a+="\n";return a}),d.serviceProviderSelectDisabled=ko.computed(function(){return 1==headerVM.assignedServiceProviderList().length||!!d.registration().formId()}),window.onclick=function(a){if(!a.target.matches(".dropbtn"))for(var b=document.getElementsByClassName("dropdown-content"),c=0;c<b.length;c++){var d=b[c];d.classList.contains("show")&&d.classList.remove("show")}}},PACKAGE_LOG_STATES=Object.freeze({PACKAGE_CREATED:"CREATED",PACKAGE_REQUESTED:"REQUESTED",TRANSITION_INDICATED:"TRANSITION_INDICATED",TRANSITION_PRICE_REQUESTED:"TRANSITION_PRICE_REQUESTED",TRANSITION_OFFERED:"TRANSITION_OFFERED",TRANSITION_INSTRUCTED:"TRANSITION_INSTRUCTED",TRANSITION_PREBOOKED:"TRANSITION_PREBOOKED",TRANSITION_BOOKED:"TRANSITION_BOOKED",TRANSITION_CLOSED:"TRANSITION_CLOSED",TRANSITION_CANCELED:"TRANSITION_CANCELED",TRANSITION_DISCARDED:"TRANSITION_DISCARDED",PACKAGE_CLONED:"CLONED",CANCELLATION_REQUEST_RESET:"CANCELLATION_REQUEST_RESET",CANCELLATION_RESET:"CANCELLATION_RESET",COMMENTED:"COMMENTED",UNKNOWN:"UNKNOWN",PRICE_CHANGED:"PRICE_CHANGED"
}),PACKAGE_LOG_TYPE=Object.freeze({ACTIVITY:"ACTIVITY",FILE_ATTACHED:"FILE_ATTACHED",FILE_REMOVED:"FILE_REMOVED",PRICE_ADJUST:"PRICE_ADJUST",DESCRIPTION_FILE_ATTACHED:"DESCRIPTION_FILE_ATTACHED",DESCRIPTION_FILE_REMOVED:"DESCRIPTION_FILE_REMOVED",EXT_VOUCHER_FILE_ATTACHED:"EXT_VOUCHER_FILE_ATTACHED",EXT_VOUCHER_FILE_REMOVED:"EXT_VOUCHER_FILE_REMOVED",TRAVELMEMBER_FILE_ATTACHED:"TRAVELMEMBER_FILE_ATTACHED",TRAVELMEMBER_FILE_REMOVED:"TRAVELMEMBER_FILE_REMOVED",ATTACHMENT_FILE_ATTACHED:"ATTACHMENT_FILE_ATTACHED",ATTACHMENT_FILE_REMOVED:"ATTACHMENT_FILE_REMOVED"}),EVENT_BUS_EVENTS=Object.freeze({EDIT_EVENT_STARTED:"editEventStarted",EDIT_EVENT_FINISHED:"editEventFinished",DISABLE_EVENT:"disableEvent",ENABLE_EVENT:"enableEvent"}),PACKAGE_UPDATE_PART=Object.freeze({OVERVIEW:"updateOverview",COMMENTS:"updateComments",STATUS:"updateStatus",ATTACHMENTS:"updateAttachments",CANCEL_REQUEST:"updateCancelation"}),FILE_TRANSFER_TYPE=Object.freeze({DESCRIPTION_FILE:"package-description-attachment",ATTACHMENT_FILE:"package-file-attachment",EXT_VOUCHER_FILE:"package-ext-voucher-attachment",TRAVEL_MEMBER_LIST:"package-travel-member"}),PACKAGE_STATUS_ENUM=Object.freeze({OPEN:{name:"open",transitionName:PACKAGE_LOG_STATES.PACKAGE_CREATED,id:10},INDICATED:{name:"indicated",transitionName:PACKAGE_LOG_STATES.TRANSITION_INDICATED,id:20},PRICE_REQUESTED:{name:"price_requested",transitionName:PACKAGE_LOG_STATES.TRANSITION_PRICE_REQUESTED,id:30},OFFERED:{name:"offered",transitionName:PACKAGE_LOG_STATES.TRANSITION_OFFERED,id:40},INSTRUCTED:{name:"instructed",transitionName:PACKAGE_LOG_STATES.TRANSITION_INSTRUCTED,id:50},PREBOOKED:{name:"prebooked",transitionName:PACKAGE_LOG_STATES.TRANSITION_PREBOOKED,id:60},BOOKED:{name:"booked",transitionName:PACKAGE_LOG_STATES.TRANSITION_BOOKED,id:70},CLOSED:{name:"closed",transitionName:PACKAGE_LOG_STATES.TRANSITION_CLOSED,id:80},CANCELED:{name:"canceled",transitionName:PACKAGE_LOG_STATES.TRANSITION_CANCELED,id:90},DISCARDED:{name:"discarded",transitionName:PACKAGE_LOG_STATES.TRANSITION_DISCARDED,id:100},UNKNOWN:{name:"unknown",transitionName:PACKAGE_LOG_STATES.UNKNOWN,id:-1},valueOf:function(a){for(var b in PACKAGE_STATUS_ENUM)if(PACKAGE_STATUS_ENUM.hasOwnProperty(b)&&"function"!=typeof PACKAGE_STATUS_ENUM[b]){var c=PACKAGE_STATUS_ENUM[b];if(c.name===a)return c}return PACKAGE_STATUS_ENUM.UNKNOWN}}),RESERVATION_STATES=Object.freeze({NEW:"new",REQUESTED:"requested",CONFIRMED:"confirmed",RESERVED:"reserved",REJECTED:"rejected",RESERVATION_STATE_LT_CONFIRMED:"reservationConfirmed",CANCELED:"requestCanceled",CONFIRMED_CANCELED:"confirmedCanceled",MAIL_FAILURE:"mailRequestFailed",INVALID:"requestInvalid"}),formatDate=function(a){return headerVM&&headerVM.dateTimeOverwriteLocale()?moment(a).locale(headerVM.dateTimeOverwriteLocale()).format("L"):moment(a).format("L")},formatDateTime=function(a){return headerVM&&headerVM.dateTimeOverwriteLocale()?moment(a).locale(headerVM.dateTimeOverwriteLocale()).format("L LTS"):moment(a).format("L LTS")},formatTime=function(a){return headerVM&&headerVM.dateTimeOverwriteLocale()?moment(a).locale(headerVM.dateTimeOverwriteLocale()).format("HH:mm"):moment(a).format("HH:mm")},PackageLogger=function(){function a(){var a=new Object("PackageLoggerInstance");return a.writeLog=function(a,b,c){var d="?action="+b,e={packageId:a,details:c};return $.ajax({url:serviceRootURL+"/write_package_log"+d,type:"POST",data:JSON.stringify(e),dataType:"json",contentType:"application/json",error:function(a,b,c){showError("Fehler beim Packagelog Speichern",a,b,c)}})},a.readLogs=function(a){return $.ajax({url:serviceRootURL+"/read_package_log/"+a,type:"GET",data:{},dataType:"json",contentType:"application/json",error:function(a,b,c){return showError("Fehler beim Packagelog lesen",a,b,c),[]}})},a}var b;return{getInstance:function(){return b||(b=a()),b}}}(),AdhocServiceViewModel=function(a){var b=this;b.package=a.package,b.order=a.order,b.reloadOrder=a.reloadOrder,b.loadOrder=a.loadOrder,b.loadPackageById=a.loadPackageById,b.labelText=a.labelText,b.performAddAdhocItem=function(a,c){console.log("Package: "+b.package()),console.log("Order: "+b.order());var d=document.getElementById("descriptionInput_0").value,e=document.getElementById("vatSelect_0").value,f=document.getElementById("dateInput_0").value,g=document.getElementById("priceInput_0").value,h=document.getElementById("paxInput_0").value;document.getElementById("totalInput_0").value=g*h;var i=document.getElementById("totalInput_0").value,j="B2B.PACKAGE.ADHOC."+e,k={id:null,sku:j,productKey:d,consumerKey:d,price:g,quantity:h,amount:g*h,date:f,toDate:null};if(null!=d&&d.length>0&&null!=f&&f.length>0&&null!=g&&g.length>0&&null!=h&&h.length>0&&null!=i){var l=[moment.ISO_8601,"MM/DD/YYYY","DD.MM.YYYY","YYYY-MM-DD"];if(!moment(f,l,!0).isValid())return void showError('Date needs to follow format "MM/DD/YYYY", "DD.MM.YYYY" or "YYYY-MM-DD"');if(isNaN(g))return void showError("Price needs to be a numeric value");if(isNaN(h))return void showError("Pax needs to be a numeric value");b.updateAdditionalServices(b.order,b.package,k)}else showError("Please fill all fields of the new Ad Hoc Package Service!")},b.updateAdditionalServices=function(a,c,d){if(a()){for(var e="PUT",f="/orders/"+a().id(),g={packageId:c().id(),id:a().id(),paymentType:PAYMENTTYPE_INVOICE,type:ORDER_TYPE_PACKAGE_ADDITIONAL_ORDER,orderItems:[]},h=0;h<a().orderItems().length;h++){var i=a().orderItems()[h],j={id:i.id(),sku:i.sku(),productKey:i.productKey(),consumerKey:i.consumerKey(),price:i.price(),quantity:i.quantity(),amount:i.quantity()*i.price(),date:i.date(),toDate:i.toDate()};g.orderItems.push(j)}g.orderItems.push(d),console.log("JSON: "+g),$.ajax(serviceRootURL+f,{type:e,data:JSON.stringify(g),dataType:"json",contentType:"application/json",success:function(a,c,d){console.log("success adding item"),b.reloadOrder(b.order().type())},error:function(a,b,c){console.log("failure adding item")}})}else{console.log("order doesn't yet exist");var e="POST",f="/orders",g={packageId:c().id(),paymentType:PAYMENTTYPE_INVOICE,type:ORDER_TYPE_PACKAGE_ADDITIONAL_ORDER,orderItems:[]};g.orderItems.push(d),$.ajax(serviceRootURL+f,{type:e,data:JSON.stringify(g),dataType:"json",contentType:"application/json",success:function(a,c,d){console.log("success creating order"),b.package().additionalOrderId(a.id),b.loadPackageById(b.package().id())},error:function(a,b,c){console.log("failure creating order")}})}}};ko.components.register("adhoc-service",{viewModel:{createViewModel:function(a,b){return new AdhocServiceViewModel(a)}},template:{fromUrl:"assets/templates/adhoc-service.html",maxCacheAge:1234}});var AutocompleteInputViewModel=function(a){var b=this;b.optionList=a.optionList,b.selectedElement=a.selectedElement,b.isRequired=ko.observable(!1),b.parsleyFieldErrorId=a.parsleyFieldErrorId,b.placeholder=a.placeholder,b.id=ko.observable(a.id),b.inputValue=ko.observable(),console.log("AutocompleteInputViewModel",a),b.invalidSelectionMessage=i18n.t("packages.msg.invalidSelection"),void 0!==a.isRequired&&b.isRequired(a.isRequired),void 0!==a.invalidSelectionMessage&&(b.invalidSelectionMessage=a.invalidSelectionMessage),a.initialSelection&&a.initialSelection.subscribe(function(c){a.initialSelection()&&(b.selectedElement(a.initialSelection().id),b.inputValue(a.initialSelection().name))}),b.getDataListId=function(){return b.id()+"DataList"},b.inputValue.subscribe(function(a){var c=$("#"+b.getDataListId()).find("option[value='"+a+"']"),d=null!=c&&c.length>0;d&&b.isRequired()?b.selectedElement(c[0].getAttribute("dataId")):b.selectedElement(a),console.log("Valid value selected",d,b.selectedElement())}),window.Parsley._validatorRegistry.validators.datalistValidation||window.Parsley.addValidator("datalistValidation",{validate:function(a,c){if(""===a)return!0;var d=$("#"+b.getDataListId()).find("option[value='"+a+"']"),e=null!=d&&d.length>0;return e&&b.selectedElement(d[0].getAttribute("dataId")),e},messages:{de:b.invalidSelectionMessage,en:b.invalidSelectionMessage,fr:b.invalidSelectionMessage,it:b.invalidSelectionMessage}})};ko.components.register("autocomplete-input",{viewModel:{createViewModel:function(a,b){return new AutocompleteInputViewModel(a)}},template:{fromUrl:"assets/templates/autocomplete-input.html",maxCacheAge:1234}});var BirthdateViewModel=function(a){var b=this;if(b.minBirthdateYear=ko.observable((new Date).getFullYear()-120),b.maxBirthdateYear=ko.observable((new Date).getFullYear()),b.id=a.id,b.value=a&&a.value||ko.observable(),b.disabled=a&&a.disabled||ko.observable(!1),b.requiredMessage=ko.observable(i18n.t("components.birthdate.messages.enterBirthdate")),b.required=ko.observable(!1),b.invalidBirthdateMessage=ko.observable(i18n.t("components.birthdate.messages.invalidBirthdate")),b.monthBeforeDay=ko.observable(!1),b.disabled=a&&a.disabled||ko.observable(!1),b.isoDate=a&&a.isoDate||ko.observable(),b.day=ko.observable(),b.month=ko.observable(),b.year=ko.observable(),DATE_PICKER_FORMAT.indexOf("m")<DATE_PICKER_FORMAT.indexOf("d")&&b.monthBeforeDay(!0),a.hasOwnProperty("required")&&b.required(a.required),a.hasOwnProperty("requiredMessage")&&b.requiredMessage(a.requiredMessage),a.hasOwnProperty("invalidBirthdateMessage")&&b.invalidBirthdateMessage(a.invalidBirthdateMessage),b.getErrorContainerId=ko.pureComputed(function(){return"birthdate-error-container-"+b.id()}),b.isoDate()){var c=$.datepicker.parseDate(DATE_SERVER_FORMAT,b.isoDate());b.day(c.getDate()),b.month(c.getMonth()+1),b.year(c.getFullYear())}else _.isDate(b.value())&&(b.day(b.value().getDate()),b.month(b.value().getMonth()+1),b.year(b.value().getFullYear()),b.isoDate($.datepicker.formatDate(DATE_SERVER_FORMAT,b.value())));b.day.subscribe(function(a){a&&null!=a&&(a>31&&b.day(31),a<0&&b.day(0))}),b.month.subscribe(function(a){a&&null!=a&&(a>12&&b.month(12),a<0&&b.month(0))}),b.year.subscribe(function(a){a&&null!=a&&(a>b.maxBirthdateYear()&&b.year(b.maxBirthdateYear()),a<0&&b.year(0))}),b.generateIsoDate=ko.computed(function(){if(b.year()&&b.month()&&b.day()){var a=b.year()+"-"+b.month()+"-"+b.day();if(moment(a,"YYYY-M-D",!0).isValid()){var c=$.datepicker.parseDate(DATE_SERVER_FORMAT,a);b.value(c),b.isoDate($.datepicker.formatDate(DATE_SERVER_FORMAT,c))}else b.value(null),b.isoDate(null)}else b.value(null),b.isoDate(null)}),window.Parsley._validatorRegistry.validators.birthdateValidation||window.Parsley.addValidator("birthdateValidation",{validateString:function(a,b,c){var d=c.$element.closest(".birthdate-input"),e=d.find(".birthdate-day"),f=d.find(".birthdate-month"),g=d.find(".birthdate-year"),h=d.find(".birthdate-parsley-error-field"),i=g.val()+"-"+f.val()+"-"+e.val(),j=moment(i,"YYYY-M-D",!0),k=new Date,l=moment(k.getFullYear()-120+"-1-1","YYYY-M-D",!0),m=moment(k,!0),n=j.isValid()&&j.isAfter(l)&&j.isBefore(m);return n?(e.removeClass("parsley-error"),f.removeClass("parsley-error"),g.removeClass("parsley-error"),h.empty()):(e.addClass("parsley-error"),f.addClass("parsley-error"),g.addClass("parsley-error")),n},messages:{de:b.invalidBirthdateMessage(),en:b.invalidBirthdateMessage(),fr:b.invalidBirthdateMessage(),it:b.invalidBirthdateMessage()}})};ko.components.register("birthdate-input",{viewModel:{createViewModel:function(a,b){return new BirthdateViewModel(a)}},template:{fromUrl:"assets/templates/birthdate-input.html"}});var BootstrapSelectModel=function(a,b){var c=this;c.eventEnter=a.eventEnter,c.$el=$(b.element),c.select=c.$el.find("select"),c.allowEmpty=kp.get(a,"allowEmpty",!0),c.emptyValue=void 0!==a.emptyValue&&a.emptyValue,c.placeholder=kp.get(a,"placeholder",i18n.t("components.bootstrapSelect.placeholder")),c.itemsValue=kp.get(a,"itemsValue","optionValue"),c.itemsText=kp.get(a,"itemsText","optionText"),c.itemsGroup=kp.get(a,"itemsGroup","optionGroup"),c.itemMapper=kp.get(a,"itemMapper",null),c.optgroups=kp.get(a,"optgroups",[]),c.render=kp.get(a,"render",[]),c.searchField=kp.get(a,"searchField",null),c.itemMapperDefault=function(a){return{value:kp.get(a,c.itemsValue),text:kp.get(a,c.itemsText),group:kp.get(a,c.itemsGroup),data:a}};var d={maxItems:1,onDropdownOpen:function(){var a=this,b=a.getValue();if(b=b||"",!b.length)return void a.clear()},plugins:["enter_key_submit"],selectOnTab:!0,closeAfterSelect:!0,createOnBlur:!0,allowEmptyOption:c.allowEmpty,placeholder:c.placeholder,onChange:function(d,e,f,g){$.each(c.selectize.options,function(d,e){e.value==c.selectize.getValue()&&(a.selectedItem(e.data),$(b.element).trigger("onChange"))})},onInitialize:function(){c.selectize=c.select[0].selectize,this.eventEnter=c.eventEnter,$(c.$el).find(".selectize-input input").on("keydown",function(a){8==(a.which||a.keyCode)&&(c.selectize.renderCache={})})},optgroups:c.optgroups,render:c.render,optgroupField:"group"};a.searchField&&(d.searchField=a.searchField),c.addEmptyOption=function(){c.selectize.addOption({value:"",text:c.placeholder,data:c.emptyValue})},c.setValue=function(){var b=kp.get(a,"selectedItem."+c.itemsValue,null);c.selectize.setValue(b,!0)},c.select.selectize(d),c.availableItems=ko.observable({}),c.selectedItem=ko.observable({}),null!=a.enable?c.enable=a.enable:c.enable=ko.observable(!0),a.items.subscribe(function(){c.availableItems(kp.get(a,"items",[]))}),c.availableItems.subscribe(function(){c.fillWithAvailableItems()}),c.fillWithAvailableItems=function(){var b=$.map(c.availableItems(),function(b){return a.itemMapper?a.itemMapper(c,b):c.itemMapperDefault(b)});c.selectize.clearOptions(),c.allowEmpty&&c.addEmptyOption(),c.selectize.addOption(b),c.selectize.refreshOptions(!1),c.setValue()},c.selectize.close=function(){var a=this,b=a.isOpen;"single"===a.settings.mode&&a.items.length&&a.hideInput(),a.isOpen=!1,a.$dropdown.hide(),a.setActiveOption(null),a.refreshState(),b&&a.trigger("dropdown_close",a.$dropdown)},c.selectize.addItems=function(a,b){for(var c=$.isArray(a)?a:[a],d=0,e=c.length;d<e;d++)this.isPending=d<e-1,this.addItem(c[d],b)},a.selectedItem.subscribe(function(){var b=kp.get(a,"selectedItem."+c.itemsValue,null),d=kp.get(c,"selectedItem."+c.itemsValue,null);String(b)!=String(d)?(c.selectize.addOption({value:kp.get(a,"selectedItem."+c.itemsValue,null),text:kp.get(a,"selectedItem."+c.itemsText,null),group:kp.get(a,"selectedItem."+c.itemsGroup,null),data:kp.get(a,"selectedItem",{})}),c.selectize.setValue(b,!0)):(c.selectize.renderCache={},c.selectize.clear())}),c.selectedItem.subscribe(function(){a.selectedItem(c.selectedItem())}),c.isRequired=a.isRequired,c.dataWidth=a.width?a.width:"auto",c.name=a.name?a.name:"name-default",c.validationGroup=!1,a.validationGroup&&(c.validationGroup='["'+a.validationGroup.split(",").join('","')+'"]'),c.id=kp.get(a,"id",!1),c.availableItems(a.items()),c.setValue(),c.processDisable=ko.computed(function(){var a=c.select.selectize(),b=a[0].selectize;c.enable()?b.enable():b.disable()}),c.dataValue=ko.computed(function(){return kp.get(a,"selectedItem."+c.itemsValue)})};ko.components.register("bootstrap-select",{viewModel:{createViewModel:function(a,b){return new BootstrapSelectModel(a,b)}},template:"<debug-modal params=\"debug: availableItems\"></debug-modal> <select data-bind=\"enable: enable, attr:{ id: id, 'data-value': dataValue , 'data-parsley-group':validationGroup,'data-parsley-required':isRequired,'data-parsley-errors-messages-disabled':true, 'data-width' : dataWidth, name:name}\"></select>"}),Selectize.define("enter_key_submit",function(a){var b=this;this.onKeyDown=function(a){var c=b.onKeyDown;return function(a){return b.isOpen||"function"!=typeof b.eventEnter||b.eventEnter(null,a),c.apply(this,arguments)}}()});var CommentViewModel=function(a){var b=this,c=null;b.commentList=ko.observableArray(),b.newComment=ko.observable(),b.processingComments=ko.observable(!1),b.initialTextDisplayed=ko.observable(),b.isSeller=ko.observable(!1),b.cancelCallback=a.cancelCallback,b.optionTypeFixed=ko.observable(!1),b.selectedOption=ko.observable(),b.commentTypeOptions=[{id:1,display:i18n.t("packages.comment.general")},{id:2,display:i18n.t("packages.comment.internal")}],a.isSeller&&(b.isSeller=a.isSeller),a.commentList&&(b.commentList=a.commentList),b.selectionChanged=function(){$("#commentTextArea").focus(),console.log("selectionChanged")},b.showCommentFieldWithText=function(a,d){c=d,b.newComment(a),b.initialTextDisplayed(a),b.selectedOption(2),b.optionTypeFixed(!0),b.scrollToComment()},b.scrollToComment=function(){b.showCommentInputField(),$("#commentTextArea")[0].scrollIntoView(!0)},b.showCommentInputField=function(){$("#addCommentLink").css("display","none"),$("#addCommentInputArea").fadeIn(),$("#commentTextArea").focus()},b.hideCommentInputField=function(){$("#addCommentInputArea").css("display","none"),$("#commentTextArea").val(null),$("#addCommentLink").fadeIn()},b.cancelComment=function(){null!=c?(showQuestionYesNo(i18n.t("packages.msg.priceChangeInProcess"),function(a){!0===a&&(b.hideCommentInputField(),c=null,b.optionTypeFixed(!1),b.initialTextDisplayed(void 0),b.newComment(void 0),b.cancelCallback&&b.cancelCallback())}),$("body").find("div.modal-dialog").addClass("confirm-dialog-size-600")):(c=null,b.hideCommentInputField(),b.optionTypeFixed(!1))},b.saveComment=function(){if(void 0!==b.newComment()&&""!==b.newComment().trim()){if(b.initialTextDisplayed()){var d=b.newComment().trim(),e=b.initialTextDisplayed().trim();if(d.substring(0,e.length)!==e||d.length<=e.length)return void console.log("no valid comment entered")}if(b.processingComments(!0),b.optionTypeFixed(!1),a.hasOwnProperty("externalSaveCallback")&&"function"==typeof a.externalSaveCallback){var f=function(){null!=c&&(c(),c=null),b.processingComments(!1),b.initialTextDisplayed(void 0),b.newComment(void 0),b.hideCommentInputField()};a.externalSaveCallback(b.newComment().trim(),b.selectedOption(),f)}else b.processingComments(!1)}},b.getFormatedComment=function(a){return a.replace(/\r?\n/g,"<br>")},b.getFormatedCommentEntryHeader=function(a){return 2==a.type?a.updatedBy+" "+i18n.t("packages.details.at")+" "+moment(a.createdAt).format("L LTS")+" ("+i18n.t("packages.comment.internal")+"):":a.updatedBy+" "+i18n.t("packages.details.at")+" "+moment(a.createdAt).format("L LTS")+":"}};ko.components.register("comment",{viewModel:{createViewModel:function(a,b){return new CommentViewModel(a)}},template:{fromUrl:"assets/templates/comment.html",maxCacheAge:1234}});var EditAutoCompleteInputViewModel=function(a){var b,c=this,d=Object.freeze({VIEW:"View",EDIT:"Edit",UPDATING:"Updating"});c.valueChanged=ko.observable(!1),c.placeholder=ko.observable(a.placeholder),c.viewPlaceholder=ko.observable(a.viewPlaceholder),c.mode=ko.observable(d.VIEW),c.editAllowed=ko.observable(!0),c.initialSelection=ko.observable(),c.optionList=a.optionList,c.selectedElement=a.selectedElement,c.isRequired=ko.observable(!1),c.parsleyFieldErrorId=a.parsleyFieldErrorId,c.placeholder=a.placeholder,c.id=ko.observable(a.id),c.value=ko.observable(),c.editAllowedOverride=ko.observable(!0),c.invalidSelectionMessage=i18n.t("packages.msg.invalidSelection"),void 0!==a.isRequired&&c.isRequired(a.isRequired),void 0!==a.invalidSelectionMessage&&(c.invalidSelectionMessage=a.invalidSelectionMessage),a.initialSelection&&(c.selectedElement(a.initialSelection().id),c.value(a.initialSelection().name),a.initialSelection.subscribe(function(a){c.selectedElement(a.id),c.value(a.name)})),ko.isObservable(a.editAllowed)&&(c.editAllowedOverride=a.editAllowed,!1===c.editAllowedOverride()&&c.editAllowed(!1),c.editAllowedOverride.subscribe(function(a){console.log("Overwrite edit flag changed",a),c.editAllowed(a)})),c.getDataListId=function(){return c.id()+"DataList"},c.value.subscribe(function(a){var b=$("#"+c.getDataListId()).find("option[value='"+a+"']");null!=b&&b.length>0&&c.isRequired()?c.selectedElement(b[0].getAttribute("dataId")):c.selectedElement(a)}),window.Parsley._validatorRegistry.validators.datalistValidation||window.Parsley.addValidator("datalistValidation",{validate:function(a,b){if(""===a)return!0;var d=$("#"+c.getDataListId()).find("option[value='"+a+"']"),e=null!=d&&d.length>0;return e&&c.selectedElement(d[0].getAttribute("dataId")),e},messages:{de:c.invalidSelectionMessage,en:c.invalidSelectionMessage,fr:c.invalidSelectionMessage,it:c.invalidSelectionMessage}}),c.onEdit=function(){c.editAllowed()&&(b=c.value(),c.mode(d.EDIT),a.hasOwnProperty("eventBus")&&a.eventBus.notifySubscribers(c.id(),EVENT_BUS_EVENTS.EDIT_EVENT_STARTED),$(".editor input").focus())};var e=function(e){b=c.value(),c.mode(d.VIEW),a.hasOwnProperty("eventBus")&&a.eventBus.notifySubscribers(c.id(),EVENT_BUS_EVENTS.EDIT_EVENT_FINISHED)};c.onUpdate=function(){if(c.valueChanged()){var b=$("#form"+c.id()).parsley().validate();if(console.log("valid",b),!b)return;!0===a.confirmBeforeUpdate?(showQuestionYesNo(i18n.t(a.confirmMessage),function(b){!0===b?(c.mode(d.UPDATING),a.hasOwnProperty("updateCallback")&&"function"==typeof a.updateCallback&&a.updateCallback(e)):c.cancelEdit()}),$("body").find("div.modal-dialog").addClass("confirm-dialog-size-600")):(c.mode(d.UPDATING),a.hasOwnProperty("updateCallback")&&"function"==typeof a.updateCallback&&a.updateCallback(e))}else c.cancelEdit()},c.cancelEdit=function(){c.mode(d.VIEW),c.value(b),c.valueChanged(!1),a.hasOwnProperty("eventBus")&&a.eventBus.notifySubscribers(c.id(),EVENT_BUS_EVENTS.EDIT_EVENT_FINISHED),$("#form"+c.id()).parsley().validate()},c.checkKey=function(a,d){if(c.valueChanged(a.value()!=b),27==d.keyCode)return c.cancelEdit(),!1;if(13==d.keyCode)return c.onUpdate(),!1;$("#form"+c.id()).parsley().validate();return!0},a.hasOwnProperty("eventBus")&&(a.eventBus.subscribe(function(a){a!==c.id()&&c.editAllowedOverride()&&c.editAllowed(!1)},null,EVENT_BUS_EVENTS.EDIT_EVENT_STARTED),a.eventBus.subscribe(function(a){c.editAllowedOverride()&&c.editAllowed(!0)},null,EVENT_BUS_EVENTS.EDIT_EVENT_FINISHED),a.eventBus.subscribe(function(a){c.editAllowed(!1)},null,EVENT_BUS_EVENTS.DISABLE_EVENT))};ko.components.register("edit-autocomplete-input",{viewModel:{createViewModel:function(a,b){return new EditAutoCompleteInputViewModel(a)}},template:{fromUrl:"assets/templates/edit-autocomplete-input.html",maxCacheAge:1234}});var EditLabelViewModel=function(a){var b,c=this,d=Object.freeze({VIEW:"View",EDIT:"Edit",UPDATING:"Updating"});c.id=a.id,c.valueChanged=ko.observable(!1),c.value=a.value,c.placeholder=ko.observable(a.placeholder),c.mode=ko.observable(d.VIEW),c.editAllowed=ko.observable(!0),c.directlyDisabled=ko.observable(!1),c.numberInput=ko.observable(!1),c.min=ko.observable(),c.max=ko.observable(),a.numberInput&&(c.numberInput(a.numberInput),c.min(a.min),c.max(a.max)),c.onEdit=function(){c.editAllowed()&&(b=c.value(),c.mode(d.EDIT),a.hasOwnProperty("eventBus")&&a.eventBus.notifySubscribers(c.id,EVENT_BUS_EVENTS.EDIT_EVENT_STARTED),$(".editor input").focus())};var e=function(e){b=c.value(),c.mode(d.VIEW),a.hasOwnProperty("eventBus")&&a.eventBus.notifySubscribers(c.id,EVENT_BUS_EVENTS.EDIT_EVENT_FINISHED)};c.onUpdate=function(){if(c.valueChanged()){if(!$("#"+c.id).parsley().validate())return;c.mode(d.UPDATING),a.hasOwnProperty("updateCallback")&&"function"==typeof a.updateCallback&&a.updateCallback(e)}else c.cancelEdit()},c.cancelEdit=function(){c.mode(d.VIEW),c.value(b),c.valueChanged(!1),$("#"+c.id).parsley().validate(),a.hasOwnProperty("eventBus")&&a.eventBus.notifySubscribers(c.id,EVENT_BUS_EVENTS.EDIT_EVENT_FINISHED)},c.checkKey=function(a,d){return c.valueChanged(a.value()!=b),27==d.keyCode?(c.cancelEdit(),!1):13!=d.keyCode||(c.onUpdate(),!1)},a.hasOwnProperty("eventBus")&&(a.eventBus.subscribe(function(a){a!==c.id&&c.editAllowed(!1)},null,EVENT_BUS_EVENTS.EDIT_EVENT_STARTED),a.eventBus.subscribe(function(a){c.directlyDisabled()||c.editAllowed(!0)},null,EVENT_BUS_EVENTS.EDIT_EVENT_FINISHED),a.eventBus.subscribe(function(a){a==c.id&&(c.editAllowed(!1),c.directlyDisabled(!0))},null,EVENT_BUS_EVENTS.DISABLE_EVENT),a.eventBus.subscribe(function(a){a==c.id&&(c.editAllowed(!0),c.directlyDisabled(!1))},null,EVENT_BUS_EVENTS.ENABLE_EVENT))};ko.components.register("edit-label",{viewModel:{createViewModel:function(a,b){return new EditLabelViewModel(a)}},template:{fromUrl:"assets/templates/edit-label.html",maxCacheAge:1234}});var FileInputViewModel=function(a){var b=this;if(b.labelText=a.labelText,b.multipleFilesAllowed=ko.observable(!1),b.selectedFiles=ko.observable(),b.uploadFileList=ko.observableArray(),b.id=ko.observable(a.id),b.fileTransferInProgress=ko.observable(!1),b.allowedFiles=ko.observable(),b.type=a.type,b.simpleView=ko.observable(!1),a.multipleFilesAllowed&&b.multipleFilesAllowed(a.multipleFilesAllowed),a.fileList&&(b.uploadFileList=a.$raw.fileList()),a.package&&(b.uploadFileList=a.package()[a.id]),a.allowedFiles){var c="";a.allowedFiles.indexOf("excel")>=0&&(c=".xls,.xlsx,.csv,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet,application/vnd.ms-excel"),a.allowedFiles.indexOf("word")>=0&&(c+=" ,.doc,.docx,.xml,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document"),a.allowedFiles.indexOf("image")>=0&&(c+=" ,image/*"),a.allowedFiles.indexOf("pdf")>=0&&(c+=" ,application/pdf"),""!==c&&b.allowedFiles(c)}a.simpleView&&b.simpleView(a.simpleView),b.allFilesUploaded=function(){for(var a=0;a<b.uploadFileList().length;a++)if(!b.uploadFileList()[a].isUploaded())return!1;return!0},b.getSize=function(a){return a>1024e3?(a/1024e3).toFixed(1)+" Mb":a>1e3?(a/1e3).toFixed(0)+" kB":a.toFixed(0)+" Bytes"},b.getIconForFileType=function(a){var b=a.name.split(".").pop().toLowerCase();return"csv"===b||"xls"===b||"xlsx"===b?"fa fa-file-excel-o":"doc"===b||"docx"===b?"fa fa-file-word-o":"pdf"===b?"fa fa-file-pdf-o":"png"===b||"jpg"===b?"fa fa-file-image-o":"fa fa-file-text-o"},b.getIconClass=function(a){return 0==a.size||a.size>1024e4?"invalid-file fa fa-times":a.isUploaded()?"fa fa-check-square-o":"fa fa-square-o"},b.removeFile=function(a,c){if(a.isUploaded()&&!1!==a.deleteable)showQuestionYesNo(i18n.t("packages.fileUpload.removeMsg"),function(b){if(1==b){var e=ko.contextFor(c.target),f=e.$index();d(a.id,f)}}),$("body").find("div.modal-dialog").addClass("confirm-dialog-size-600");else{var e=ko.contextFor(c.target),f=e.$index();b.uploadFileList.splice(f,1)}},b.uploadFiles=function(){var c=new FormData;c.append("type",a.type);for(var d=0;d<b.uploadFileList().length;){var f=b.uploadFileList()[d];!f.isUploaded()&&f.size>0&&f.size<=1024e4&&c.append("file",f),0==f.size||f.size>1024e4?b.uploadFileList.splice(d,1):d++}e(c)};var d=function(c,d){$.ajax(serviceRootURL+"/packages/files/"+c,{type:"DELETE",data:JSON.stringify(c),dataType:"json",contentType:"application/json",success:function(c,e,f){var g=b.uploadFileList()[d];b.uploadFileList.splice(d,1),b.fileTransferInProgress(!1),a.callback&&"function"==typeof a.callback&&a.callback("delete",[g],b.type)},error:function(a,c,d){showError("Fehler beim löschen des files",a,c,d),console.log("File delete failed: ",d),b.fileTransferInProgress(!1)}})},e=function(c){b.fileTransferInProgress(!0),$.ajax(serviceRootURL+"/packages/files",{type:"POST",data:c,processData:!1,contentType:!1,success:function(c,d,e){for(var f=[],g=0;g<c.length;g++)for(var h=c[g],i=0;i<b.uploadFileList().length;i++){var j=b.uploadFileList()[i];j.isUploaded()||h.name===j.name&&(j.isUploaded(!0),j.id=h.id,f.push(j))}b.fileTransferInProgress(!1),a.callback&&"function"==typeof a.callback&&a.callback("upload",f,b.type)},error:function(a,c,d){showError("Fehler beim hochladen der files",a,c,d),console.log("File upload failed: ",d),b.fileTransferInProgress(!1)}})};void 0!==a.initialLoadType&&function(a){b.fileTransferInProgress(!0),$.ajax(serviceRootURL+"/packages/files_meta_data/0",{type:"GET",data:{type:a},dataType:"json",contentType:"application/json",success:function(a,c,d){a.isUploaded=ko.observable(!0),a.deleteable=!1,0==b.uploadFileList().length&&b.uploadFileList.splice(0,0,a),b.fileTransferInProgress(!1)},error:function(a,c,d){console.log("Failed to load initial file - probably file not existing"),b.fileTransferInProgress(!1)}})}(a.initialLoadType),b.downloadFile=function(a,b){window.location="/packages/files/"+a.id+"?name="+a.name},b.uploadListener=ko.computed(function(){var a=!1;b.uploadFileList().forEach(function(b){b.isUploaded()||(a=!0)}),a&&b.uploadFiles()}).extend({throttle:50})};ko.bindingHandlers.fileUpload={init:function(a,b){$(a).change(function(){for(var c=0;c<a.files.length;c++){var d=a.files[c];ko.utils.arrayFirst(b()(),function(a){return d.name===a.name})||(d.isUploaded=ko.observable(!1),b().push(d))}})},update:function(a,b){}},ko.components.register("file-upload",{viewModel:{createViewModel:function(a,b){return new FileInputViewModel(a)}},template:{fromUrl:"assets/templates/file-upload.html",maxCacheAge:1234}});var GenericLinkViewModel=function(a){var b=this;b.id=ko.observable(),b.headerTitle=ko.observable(),b.availableServiceProviders=ko.observableArray(),b.paramLanguages=a.availableLanguages,b.languages=ko.observableArray(),b.selectedServiceProvider=ko.observable(),b.selectedLanguage=ko.observable(),b.link=ko.observable(),b.loading=ko.observable(!1),b.availableLinks=ko.observable({}),a.id&&b.id(a.id),a.headerTitle&&b.headerTitle(a.headerTitle),a.serviceProviderList&&(a.serviceProviderList().forEach(function(a){a.active&&b.availableServiceProviders.push(a)}),b.availableServiceProviders().length>1&&b.availableServiceProviders.splice(0,0,{serviceProviderExternalId:"allResellerAssigned",name:i18n.t("registration.genericLink.resellerAssignedServiceProviders")})),b.paramLanguages&&b.languages(b.paramLanguages()),b.paramLanguages.subscribe(function(a){b.languages(a)}),b.openQrCodePDF=function(a,c){var d=b.availableServiceProviders().find(function(a){return a.serviceProviderExternalId===b.selectedServiceProvider()});window.open("/print_genericqrcodelink/"+b.selectedServiceProvider()+"?name="+d.name+"&lang="+b.selectedLanguage(),"_blank","toolbar=no, location=no, status=no, scrollbars=yes, resizable=yes")},b.copyToClipboard=function(a,c){var d=document.createElement("textarea");d.style.position="fixed",d.style.top=0,d.style.left=0,d.style.width="2em",d.style.height="2em",d.style.padding=0,d.style.border="none",d.style.outline="none",d.style.boxShadow="none",d.style.background="transparent",d.value=b.link(),document.getElementById(b.id()).appendChild(d),d.focus(),d.select();try{var e=document.execCommand("copy"),f=e?"successful":"unsuccessful";console.log("Copied url to clipboard "+f)}catch(a){console.log("Oops, unable to copy")}document.getElementById(b.id()).removeChild(d)},b.getUrlLabelId=function(){return"urlLabel_"+b.id()},b.getCopyClipboardBtnId=function(){return"copyClipboardBtn_"+b.id()},b.getServiceProviderSelectId=function(){return"serviceProviderSelect_"+b.id()},b.getLanguageSelectId=function(){return"languageSelect_"+b.id()},b.getGenerateLinkBtnId=function(){return"generateLinkBtn_"+b.id()},b.setEnableState=function(a){$("#"+b.getUrlLabelId()).attr("disabled",!a),$("#"+b.getCopyClipboardBtnId()).attr("disabled",!a),$("#"+b.getServiceProviderSelectId()).attr("disabled",!a),$("#"+b.getGenerateLinkBtnId()).attr("disabled",!a),$("#"+b.getLanguageSelectId()).attr("disabled",!a),b.loading(!a)},b.selectedParameters=ko.computed(function(){var a=b.selectedServiceProvider()+"-"+b.selectedLanguage();b.link(b.availableLinks()[a])}),b.generateLink=function(){var a={language:b.selectedLanguage()};$.ajax(serviceRootURL+"/registration/generic/"+b.selectedServiceProvider(),{type:"GET",data:a,dataType:"json",contentType:"application/json",beforeSend:function(){b.link(void 0),b.setEnableState(!1)},success:function(a,c,d){if(console.log("Generic link retrieved: ",a),a.hasOwnProperty("genericLink")){var e=b.selectedServiceProvider()+"-"+b.selectedLanguage(),f=b.availableLinks();f[e]=a.genericLink,b.availableLinks(f)}},error:function(a,b,c){checkSession(a),console.log("Server error on getting generic link: ",a.responseText),showError("Error getting generic link",a,b,c)},complete:function(a){b.setEnableState(!0)}})},$("#"+b.id()).on("hide.bs.modal",function(a){b.availableLinks({}),$(this).unbind()}),b.closeDialog=function(){
$("#"+b.id()).modal("hide")}};ko.components.register("generic-link",{viewModel:{createViewModel:function(a,b){return new GenericLinkViewModel(a)}},template:{fromUrl:"assets/templates/registration-generic-link.html",maxCacheAge:1234}});var MultiSelectInputViewModel=function(a){var b=this;b.optionalList=ko.observableArray(),b.exclusivList=ko.observableArray(),b.exclusivTitle=ko.observable("Main"),b.optionalTitle=ko.observable("Optional"),b.selectTitle=ko.observable("Select"),b.changeTitle=ko.observable("Change"),b.componentId=ko.observable(1),b.enableState=ko.observable(!0),b.selectSeatTitle=i18n.t("trainReservation.selectSeat");a&&(a.hasOwnProperty("componentId")&&(b.componentId=a.componentId),a.hasOwnProperty("exclusivList")&&(b.exclusivList=a.exclusivList),a.hasOwnProperty("optionalList")&&(b.optionalList=a.optionalList),a.hasOwnProperty("exclusivTitle")&&b.exclusivTitle(a.exclusivTitle),a.hasOwnProperty("optionalTitle")&&b.optionalTitle(a.optionalTitle),a.hasOwnProperty("selectTitle")&&(b.selectTitle=a.selectTitle),a.hasOwnProperty("changeTitle")&&(b.changeTitle=a.changeTitle),a.hasOwnProperty("enableState")&&(b.enableState=a.enableState),1==a.testdata&&function(){b.optionalList.push({id:1,name:"Prosecco",selected:ko.observable(!1)},{id:2,name:"O-Saft",selected:ko.observable(!1),price:ko.observable()}),b.exclusivList.push({id:3,name:"3-Gänge",selected:ko.observable(!1)},{id:4,name:"Tagesteller",selected:ko.observable(!1),price:ko.observable()})}()),b.getDescription=function(a){return a.hasOwnProperty("name")?a.name:a.hasOwnProperty("label")?a.label:""},b.nrOfSelectedItems=ko.computed(function(){var a=0;return b.exclusivList&&b.exclusivList().forEach(function(b){b.selected()&&a++}),b.optionalList&&b.optionalList().forEach(function(b){b.selected()&&a++}),a}),b.getComponentId=function(){return b.componentId()},b.toggleItemExclusivSelect=function(a,c){a.selected(!a.selected()),b.exclusivList().forEach(function(b){b.id!=a.id&&b.selected(!1)})},b.toggleItemOptionalSelect=function(a,b){a.required()||a.selected(!a.selected())},b.toggleShowOptions=function(a,c){if(b.enableState()){var d=document.getElementById("selectionOption"+b.getComponentId());"block"===d.style.display?d.style.display="none":d.style.display="block"}},b.showOptions=function(){b.toggleShowOptions()},b.getSelectTitle=ko.computed(function(){return 0===b.exclusivList().length&&0===b.optionalList().length?b.selectTitle():0==b.nrOfSelectedItems()?b.enableState()?b.selectTitle():b.selectSeatTitle:ko.isObservable(b.changeTitle)?b.changeTitle():b.changeTitle}),$(document).on("click.multiselect",function(a){if("string"==typeof a.target.className&&(a.target.className.indexOf("modal")>=0||a.target.className.indexOf("flex-row")>=0))for(var b=document.getElementsByClassName("multiselect-input-option-background"),c=0;c<b.length;c++)"block"==b[c].style.display&&(b[c].style.display="none")}),MultiSelectInputViewModel.prototype.dispose=function(){$(document).unbind("click.multiselect")}};ko.components.register("multiselect-input",{viewModel:{createViewModel:function(a,b){return new MultiSelectInputViewModel(a)}},template:{fromUrl:"assets/templates/multiselect-input.html",maxCacheAge:1234}});var PackageOrderViewModel=function(a){function b(a,b,c){a.find(".btn-time-save").prop({disabled:!(b[0].validity.valid||c[0].checked)})}var c=this;c.label=a.label,c.package=a.package,c.order=a.order,c.orderType=ko.observable(a.orderType),c.orderItemGroups=a.orderItemGroups,c.processingOrder=a.processingOrder,c.deleteOrderItem=a.deleteOrderItem,c.reloadOrder=a.reloadOrder,c.loadOrder=a.loadOrder,c.openShop=a.openShop,c.bookOrderItemGroup=a.bookOrderItemGroup,c.cancelOrderItemGroup=a.cancelOrderItemGroup,c.cancelOrderItem=a.cancelOrderItem,c.openAssignHotelDialog=a.openAssignHotelDialog,c.showReservationDialog=a.showReservationDialog,c.updateOrderCallback=a.updateOrderCallback,c.itemMoveCallback=a.itemMoveCallback,c.isSeller=a.isSeller,c.isCustomer=a.isCustomer,c.currency=a.currency,c.allExpanded=ko.observable(!0),c.id=ko.observable("serviceTableForm"+c.orderType()),c.visibleOrderItemGroups=ko.computed(function(){return ko.utils.arrayFilter(c.orderItemGroups(),function(a){return!c.isCustomer()||a.firstItem().categoryKey()!=CATEGORY_KEY_MARGIN&&a.firstItem().categoryKey()!=CATEGORY_KEY_TOURIST_TAX})}),c.serviceDetailsVisible=ko.computed(function(){return c.isSeller()}),c.isOptionalOrder=ko.computed(function(){return c.orderType()==ORDER_TYPE_PACKAGE_OPTIONAL_ORDER}),c.serviceAmountVisible=ko.computed(function(){return c.package().status()!=PACKAGE_STATUS_ENUM.OPEN&&c.isSeller()}),c.marginColumnVisible=ko.computed(function(){return c.isOptionalOrder()}),c.correctionColumnVisible=ko.computed(function(){return!c.isOptionalOrder()}),c.quantityColumnVisible=ko.computed(function(){return!c.isOptionalOrder()}),c.correctionFieldVisible=ko.computed(function(){return!!c.isSeller()&&(!!c.package().status()&&c.package().status().id<PACKAGE_STATUS_ENUM.OFFERED.id)}),c.calculateAmount=function(a,b){return a.amount()+a.packageMargin()},c.totalAmountVisible=ko.computed(function(){return!c.isOptionalOrder()}),c.groupItemAmountVisible=ko.computed(function(){return!!c.isSeller()&&(!!c.package().status()&&c.package().status().id>PACKAGE_STATUS_ENUM.OPEN.id)}),c.subserviceAllowed=ko.computed(function(){return!!c.isSeller()&&(!!c.package().status()&&void 0)}),c.serviceEditAllowed=ko.computed(function(){if(!c.isSeller())return!1;if(!c.package().status())return!1;if(c.orderType()==ORDER_TYPE_PACKAGE_COMPENSATORY_ORDER){var a=$.datepicker.parseDate(DATE_SERVER_FORMAT,c.package().plannedDepartureDate()),b=$.datepicker.formatDate(DATE_SERVER_FORMAT,new Date);return!moment(a).isBefore(moment(b))&&c.package().status()===PACKAGE_STATUS_ENUM.BOOKED}return c.package().status()===PACKAGE_STATUS_ENUM.OPEN}),c.isItemRemovable=function(a,b){return(c.orderType()!=ORDER_TYPE_PACKAGE_COMPENSATORY_ORDER||a.status()!=ORDER_STATUS_COMPLETE&&a.status()!=ORDER_STATUS_CANCELED)&&(a.categoryKey()!==CATEGORY_KEY_MARGIN&&a.categoryKey()!==CATEGORY_KEY_TOURIST_TAX)},c.isSubserviceAllowed=function(a,b){return a.categoryKey()===CATEGORY_KEY_HOTEL};var d=function(a,b){var c=a.priceModels().length>0?a.priceModels()[0].date():null,d=a.priceModels().length>0?a.priceModels()[0].toDate():null,e=a.categoryType()?(a.consumerGroup()+"."+a.categoryType()).toUpperCase():a.consumerGroup();return{type:ORDER_ITEM_TYPE_PACKAGE_SUBSERVICE,ticketNr:1,bundleNr:b,price:0,sku:a.productKey(),consumerKey:e,categoryKey:CATEGORY_KEY_SUBSERVICE,timeRangeId:null,timeRangeKey:null,reductionLevel:null,rebateRuleId:null,crossSeason:null,productKey:a.productKey(),date:c,quantity:1,amount:1,media:"voucher",refItemId:a.refItemId(),specificAttributes:{toDate:d,durationOverwrite:1,reservationRequestHash:a.reservationRequestHash}}},e=function(a,b,c,d,e){return a.getSpecificAttributes().durationOverwrite=1,{type:ORDER_ITEM_TYPE_PACKAGE_ITEM,ticketNr:c,bundleNr:d,price:1*a.price(),sku:a.sku(),consumerKey:null!=a.consumerKey()?a.consumerKey().toUpperCase():null,categoryKey:CATEGORY_KEY_SUBSERVICE,timeRangeId:a.timeRangeId(),timeRangeKey:a.timeRangeKey(),reductionLevel:a.reductionLevel(),rebateRuleId:a.rebateRuleId(),crossSeason:a.crossSeason(),productKey:e,date:a.date(),quantity:null!=a.consumerKey()&&0===a.consumerKey().indexOf("adult")?1:0,amount:1*a.price(),media:"voucher",refItemId:b,specificAttributes:a.getSpecificAttributes()}};c.addSubservice=function(a){if(null!=a){c.processingOrder(!0);var b={packageId:c.package().id(),id:c.order().id(),paymentType:PAYMENTTYPE_INVOICE,type:c.orderType(),orderItems:[]},f=1;a.forEach(function(a){var c=d(a,f);b.orderItems.push(c);var g=2;a.priceModels().forEach(function(c){b.orderItems.push(e(c,null,g,f,a.productKey())),g++}),f++}),c.updateOrderCallback(b)}},c.isStartTimeVisible=function(a){return ko.computed(function(){return null!==a.startTime()&&(!1===a.startTimeTba()||null==a.startTimeTba())},this)},c.isStartTimeTba=function(a){return ko.computed(function(){return!0===a.startTimeTba()},this)},c.groupStatusVisible=function(a){return ko.computed(function(){return!!c.isSeller()&&(a.categoryKey()!==CATEGORY_KEY_TOURIST_TAX&&a.categoryKey()!==CATEGORY_KEY_MARGIN&&(c.package()&&(c.package().status()==PACKAGE_STATUS_ENUM.DISCARDED||c.package().status()==PACKAGE_STATUS_ENUM.CANCELED||c.package().status()==PACKAGE_STATUS_ENUM.INSTRUCTED||c.package().status()==PACKAGE_STATUS_ENUM.PREBOOKED||c.package().status()==PACKAGE_STATUS_ENUM.BOOKED||c.package().status()==PACKAGE_STATUS_ENUM.CLOSED)))},this)},c.groupDropDownVisible=function(a){return ko.computed(function(){if(!c.isSeller())return!1;if(a.categoryKey()===CATEGORY_KEY_TOURIST_TAX||a.categoryKey()===CATEGORY_KEY_MARGIN)return!1;if(!c.package()||!c.package().status())return!1;if(c.orderType()==ORDER_TYPE_PACKAGE_OPTIONAL_ORDER)return c.isMoveToPackageVisible();if(c.orderType()==ORDER_TYPE_PACKAGE_COMPENSATORY_ORDER)return c.package().status()==PACKAGE_STATUS_ENUM.BOOKED&&a.status()!=ORDER_STATUS_CANCELED;switch(c.package().status()){case PACKAGE_STATUS_ENUM.INSTRUCTED:return a.status()==ORDER_STATUS_NEW||a.status()==ORDER_STATUS_REQUESTED||a.status()==ORDER_STATUS_REJECTED||a.status()==ORDER_STATUS_CONFIRMED;case PACKAGE_STATUS_ENUM.PREBOOKED:return a.status()!=ORDER_STATUS_COMPLETE;case PACKAGE_STATUS_ENUM.BOOKED:if(a.status()==ORDER_STATUS_COMPLETE)return!0;if(a.status()==ORDER_STATUS_CONFIRMED)return!1;break;default:return!1}},this)},c.requestConfirmRejectVisible=function(a){return ko.computed(function(){return a.categoryKey()!==CATEGORY_KEY_HOTEL&&a.categoryKey()!==CATEGORY_KEY_RESTAURANT&&(c.orderType()==ORDER_TYPE_PACKAGE_ORDER||c.orderType()==ORDER_TYPE_PACKAGE_ADDITIONAL_ORDER?c.package()&&c.package().status()==PACKAGE_STATUS_ENUM.INSTRUCTED:c.orderType()==ORDER_TYPE_PACKAGE_COMPENSATORY_ORDER?a.status()!=ORDER_STATUS_COMPLETE&&a.status()!=ORDER_STATUS_CANCELED&&(c.package()&&c.package().status()==PACKAGE_STATUS_ENUM.BOOKED):void 0)})},c.bookActionVisible=ko.computed(function(){return c.orderType()==ORDER_TYPE_PACKAGE_ORDER||c.orderType()==ORDER_TYPE_PACKAGE_ADDITIONAL_ORDER?c.package()&&c.package().status()==PACKAGE_STATUS_ENUM.PREBOOKED:c.orderType()==ORDER_TYPE_PACKAGE_COMPENSATORY_ORDER?c.package()&&c.package().status()==PACKAGE_STATUS_ENUM.BOOKED:void 0}),c.cancelActionVisible=ko.computed(function(){return c.orderType()==ORDER_TYPE_PACKAGE_ORDER||c.orderType()==ORDER_TYPE_PACKAGE_ADDITIONAL_ORDER?c.package()&&c.package().status()==PACKAGE_STATUS_ENUM.BOOKED:c.orderType()==ORDER_TYPE_PACKAGE_COMPENSATORY_ORDER?c.package()&&c.package().status()==PACKAGE_STATUS_ENUM.BOOKED:void 0}),c.quantitiesEditable=function(a){if(!c.package()||!c.package().status())return!1;if(a.categoryKey()==CATEGORY_KEY_HOTEL&&c.orderType()==ORDER_TYPE_PACKAGE_ORDER&&a.type()==ORDER_ITEM_TYPE_PACKAGE_ITEM&&"FRE"!==a.consumerKey().substring(0,3)&&c.package().status()==PACKAGE_STATUS_ENUM.PREBOOKED)return!0;if(c.orderType()==ORDER_TYPE_PACKAGE_ADDITIONAL_ORDER){if(a.categoryKey()==CATEGORY_KEY_TOURIST_TAX)return!1;if(a.categoryKey()==CATEGORY_KEY_HOTEL&&a.type()==ORDER_ITEM_TYPE_PACKAGE_SUBGRP)return!1;if(a.categoryKey()==CATEGORY_KEY_SUBSERVICE&&a.sku().indexOf("HOTEL")>=0)return!1;if(c.package().status()==PACKAGE_STATUS_ENUM.INDICATED)return!0}return!1},c.getTableHeaderWithCurrency=function(a){return c.isSeller()?a+" ("+i18n.t("packages.details.allPricesIn")+" "+currency()+")":a},c.setEnableState=function(){console.log("setEnabledState",item)},c.correctionInputAllowed=ko.computed(function(){return!(!c.package()||!c.package().status())&&(!!c.isSeller()&&c.package().status()==PACKAGE_STATUS_ENUM.PRICE_REQUESTED)}),c.correctionInputVisible=ko.computed(function(){return!(!c.package()||!c.package().status())&&(!!c.isSeller()&&c.package().status().id>PACKAGE_STATUS_ENUM.INDICATED.id)}),c.enableCorrectionInput=function(a,b){var c=$(b.target),d=c.parents("li").find("input");d.attr("disabled",!1),d.focus(),c.css("display","none")},c.getCurrency=ko.pureComputed(function(){return" "+c.currency()}),c.getServiceTableCss=function(a,b){var d="";return c.serviceDetailsVisible()?c.serviceAmountVisible()?d+="service-table-full ":d+="service-table-without-quantity ":d+="service-table-reduced ",a&&"function"==typeof a.status&&a.status()==ORDER_STATUS_ERROR&&(d+="failed"),!0===b&&c.serviceEditAllowed()&&(d+="right-border "),d},c.performOpenShop=function(){var a;return c.orderType()==ORDER_TYPE_PACKAGE_ORDER?a=SHOPPING_CART_MODE_PACKAGE:c.orderType()==ORDER_TYPE_PACKAGE_ADDITIONAL_ORDER?a=SHOPPING_CART_MODE_PACKAGE_ADDITIONAL:c.orderType()==ORDER_TYPE_PACKAGE_OPTIONAL_ORDER?a=SHOPPING_CART_MODE_PACKAGE_OPTIONAL:c.orderType()==ORDER_TYPE_PACKAGE_COMPENSATORY_ORDER&&(a=SHOPPING_CART_MODE_PACKAGE_COMPENSATORY),c.openShop(a)},c.checkPerformDeleteOrderItem=function(a,b){bootbox.confirm({message:i18n.t("packages.orderItemGroup.deleteOrderItem.message"),callback:function(d){1==d&&c.performDeleteOrderItem(a,b)},buttons:{confirm:{label:i18n.t("packages.orderItemGroup.deleteOrderItem.confirm")},cancel:{label:i18n.t("packages.orderItemGroup.deleteOrderItem.cancel")}}})},c.performDeleteOrderItem=function(a,b){for(var d=null,e=[a.id()],f=0;f<c.orderItemGroups().length;f++)for(var g=c.orderItemGroups()[f],h=0;h<g.items().length;h++)g.items()[h].id()==a.id()&&(d=g),null!=d&&a.categoryKey()==CATEGORY_KEY_PUBLICTRANSPORTATION&&g.items()[h].id()==a.refItemId()&&g.items()[h].status();null!=d&&1==d.items().length&&d.categoryKey()==CATEGORY_KEY_PUBLICTRANSPORTATION&&e.push(a.refItemId());var i=[],j="";e.forEach(function(a){j+=a+",",i.push(c.cancelOrderItem(a,!0))}),$.when.apply($,i).then(function(){var a=c.deleteOrderItems(j);$.when(a).done(function(){c.loadOrder()})})},c.checkPerformDeleteGroupOrderItems=function(a,b){bootbox.confirm({message:i18n.t("packages.orderItemGroup.deleteGroupOrderItems.message"),callback:function(d){1==d&&c.performDeleteGroupOrderItems(a,b)},buttons:{confirm:{label:i18n.t("packages.orderItemGroup.deleteGroupOrderItems.confirm")},cancel:{label:i18n.t("packages.orderItemGroup.deleteGroupOrderItems.cancel")}}})},c.subserviceEditVisible=function(a){return ko.computed(function(){if(!c.package()||!c.package().status())return!1;if(!a.toDate())return!1;if(-1!==a.sku().indexOf("PORTERAGE"))return!0;var b=moment(a.date(),"YYYY-MM-DD");return moment(a.toDate(),"YYYY-MM-DD").diff(b,"days")>1})},c.subserviceEditAllowed=ko.computed(function(){return!(!c.package()||!c.package().status())&&(!c.isCustomer()&&(c.package().status()==PACKAGE_STATUS_ENUM.OPEN||c.package().status()==PACKAGE_STATUS_ENUM.INDICATED))}),c.deleteOrderItems=function(a){return c.processingOrder(!0),$.ajax(serviceRootURL+"/packages_process_order_items",{type:"GET",data:{ids:a,action:"delete"},dataType:"json",contentType:"application/json",success:function(a,b,c){console.log("Delete order items successful")},error:function(a,b,d){console.log("Delete order items failed"),checkSession(a),c.processingOrder(!1),showError("Error deleting items",a,b,d)}})},c.performDeleteGroupOrderItems=function(a,b){console.log("performDeleteGroupOrderItems",a);var d=a.items();a.categoryKey()!==CATEGORY_KEY_HOTEL&&a.categoryKey()!==CATEGORY_KEY_RESTAURANT||(a.subgroups().forEach(function(a){d.push(a.groupItem())}),d.sort(function(a,b){if(a.categoryKey()===CATEGORY_KEY_SUBSERVICE&&b.categoryKey()===CATEGORY_KEY_SUBSERVICE){if(a.type()===ORDER_ITEM_TYPE_PACKAGE_SUBSERVICE&&b.type()!==ORDER_ITEM_TYPE_PACKAGE_SUBSERVICE)return 1;if(a.type()!==ORDER_ITEM_TYPE_PACKAGE_SUBSERVICE&&b.type()===ORDER_ITEM_TYPE_PACKAGE_SUBSERVICE)return-1}return a.categoryKey()===CATEGORY_KEY_SUBSERVICE?-1:b.categoryKey()===CATEGORY_KEY_SUBSERVICE?1:0})),a.categoryKey()===CATEGORY_KEY_PUBLICTRANSPORTATION&&c.orderItemGroups().forEach(function(b){b.items().forEach(function(b){a.firstItem().refItemId()===b.id()&&(d.push(b),a.items().push(b))})});var e=c.performCancelOrderItemGroup(a,!1);$.when(e).done(function(){var a="";d.forEach(function(b){a+=b.id()+","}),a=a.substr(0,a.length-1),$.when(c.deleteOrderItems(a).done(function(){c.loadOrder()}))})},c.toggleExpand=function(a,b){if($(b.target).hasClass("no-expand-on-click"))return!0;$(b.target).closest(".modal").length>0||a.groupExpanded(!a.groupExpanded())},c.toggleExpandAll=function(a,b){c.allExpanded(!c.allExpanded()),c.orderItemGroups().forEach(function(a){a.groupExpanded(c.allExpanded())})},ko.bindingHandlers.collapseVisible={init:function(a,b){var c=b(),d=ko.utils.unwrapObservable(c),e=$(a);d?e.slideDown(0):e.slideUp(0)},update:function(a,b,c){var d=b(),e=c(),f=e.slideDuration||500,g=ko.utils.unwrapObservable(d),h=$(a);g?h.slideDown(f):h.slideUp(f)}},c.openGroupDropdown=function(a,b){$(".table-container").find(".dropdown-menu").hide();var c=b.target,d=$(c).closest(".dropdown").find(".dropdown-menu");$(d).show()},c.validateStartTime=function(a){return null!=a.startTime()||null!=a.startTimeTba()||(showInfo("Start time has be set before requesting reservation"),!1)},c.requestReservation=function(a,b){a.firstItem().status()!=ORDER_STATUS_NEW&&a.firstItem().status()!=ORDER_STATUS_REQUESTED&&a.firstItem().status()!=ORDER_STATUS_REJECTED||c.validateStartTime(a.firstItem())&&(c.processingOrder(!0),$.ajax(serviceRootURL+"/packages_process_order_items",{type:"GET",data:{ids:a.idFilter(),action:"request"},dataType:"json",contentType:"application/json",success:function(a,b,d){console.log("produce order item (no coding) result retrieved: ",a),c.loadOrder()},error:function(a,b,d){console.log("error on produceorderitem (no coding)"),checkSession(a),c.processingOrder(!1),showError("Fehler beim Anfordern der Reservierung",a,b,d)}}))},c.confirmReservation=function(a,b){if(a.firstItem().status()==ORDER_STATUS_NEW||a.firstItem().status()==ORDER_STATUS_REQUESTED||a.firstItem().status()==ORDER_STATUS_REJECTED)return c.processOrderItems(a,"confirm")},c.rejectReservation=function(a,b){if(a.firstItem().status()==ORDER_STATUS_NEW||a.firstItem().status()==ORDER_STATUS_REQUESTED||a.firstItem().status()==ORDER_STATUS_CONFIRMED)return c.processOrderItems(a,"reject")},c.cancelReservation=function(a,b){if(a.firstItem().status()==ORDER_STATUS_CONFIRMED)return c.processOrderItems(a,"cancel")},c.moveToPackage=function(a,b){return c.processOrderItems(a,"move")},c.addExtendedNote=function(a,b){var d=i18n.t("packages.orderItemGroup.dropdown.extendedNoteRemark");a.firstItem().categoryKey()==CATEGORY_KEY_HOTEL&&(d+=": "+a.firstItem().productName()+", "+a.firstItem().roomCategoryName()),bootbox.dialog({message:"<textarea  id='extendedNoteMessage' rows=4 style='width: 100%'></textarea>",title:d,buttons:{cancel:{label:i18n.t("packages.orderItemGroup.dropdown.cancelBtn"),className:"btn-default",callback:function(){}},main:{label:i18n.t("packages.orderItemGroup.dropdown.saveBtn"),className:"btn-primary",callback:function(){var b=$("#extendedNoteMessage").val();a.firstItem().extendedNote()!==b&&c.processOrderItems(a,"addExtendedNote",b)}}}}),a.firstItem().extendedNote()?$("#extendedNoteMessage").val(a.firstItem().extendedNote()):$("#extendedNoteMessage").val("ETA: \nETD: \nDinner: \nPlease note:"),$("body").find("div.modal-dialog").addClass("model-dialog-size-500")},c.addNote=function(a,b){var d=i18n.t("packages.orderItemGroup.dropdown.noteRemark");a.firstItem().categoryKey()!=CATEGORY_KEY_LOCAL_EVENT&&a.firstItem().categoryKey()!=CATEGORY_KEY_CATERING&&a.firstItem().categoryKey()!=CATEGORY_KEY_RAILWAY_SEAT_RESERVATION&&a.firstItem().categoryKey()!=CATEGORY_KEY_RAILWAY_SEAT_RESERVATION_MRAG||(d+=": "+a.firstItem().productName()),a.firstItem().categoryKey()==CATEGORY_KEY_SKIPASS&&(d+=": "+a.firstItem().regionName()+", "+a.firstItem().durationName()),a.firstItem().categoryKey()!=CATEGORY_KEY_PUBLICTRANSPORTATION&&a.firstItem().categoryKey()!=CATEGORY_KEY_BERGBAHN||(d+=": "+a.firstItem().fromName()+" - "+a.firstItem().toName()+", "+a.firstItem().tripTypeName()),a.firstItem().categoryKey()==CATEGORY_KEY_HOTEL&&(d+=": "+a.firstItem().productName()+", "+a.firstItem().roomCategoryName()),bootbox.dialog({message:"<textarea  id='noteMessage' rows=4 style='width: 100%'></textarea>",title:d,buttons:{cancel:{label:i18n.t("packages.orderItemGroup.dropdown.cancelBtn"),className:"btn-default",callback:function(){}},main:{label:i18n.t("packages.orderItemGroup.dropdown.saveBtn"),className:"btn-primary",callback:function(){var b=$("#noteMessage").val();a.firstItem().note()!==b&&c.processOrderItems(a,"addNote",b)}}}}),$("#noteMessage").val(a.firstItem().note()),$("body").find("div.modal-dialog").addClass("model-dialog-size-500")},c.getStartTimeLabel=function(a){return a?i18n.t("packages.orderItemGroup.dropdown.editStartTime"):i18n.t("packages.orderItemGroup.dropdown.setStartTime")},c.setStartTime=function(a,d){var e=i18n.t("packages.orderItemGroup.dropdown.startTime"),f=bootbox.dialog({message:"<input type='time' id='startTime' required style='width: 100%' data-bind='disable: isToBeAnnounced'><label for=\"tba\">\n<input type='checkbox' id='startTimeTba' name='ba' data-bind='checked: isToBeAnnounced'> "+i18n.t("packages.orderItemGroup.dropdown.tba")+"</label><script>$('#startTimeTba').change(function(){        if ($('#startTimeTba').is(':checked')) {\n            $('#startTime').attr('disabled', 'disabled');\n            $('#startTime').val('');\n        } else {\n            $('#startTime').removeAttr('disabled');\n        }\n});<\/script>",title:e,buttons:{cancel:{label:i18n.t("packages.orderItemGroup.dropdown.cancelBtn"),className:"btn-default",callback:function(){}},main:{label:i18n.t("packages.orderItemGroup.dropdown.saveBtn"),className:"btn-primary btn-time-save",callback:function(){var b=$("#startTime"),d=$("#startTimeTba"),e=b.val(),f=d.is(":checked");(f!==a.firstItem().startTimeTba()||b[0].validity.valid&&a.firstItem().startTime()!==e)&&c.processOrderItems(a,"setStartTime",null,e,f)}}}}),g=a.firstItem().startTimeTba();$("#startTimeTba").prop("checked",g),$("#startTime").val(!1===g?a.firstItem().startTime():null),!0===g&&$("#startTime").attr("disabled","disabled"),f.init(function(){var a=$("#startTime"),c=$("#startTimeTba");b(f,a,c),a.on("change input",function(d){b(f,a,c)}),c.on("change input",function(d){b(f,a,c)})}),$("body").find("div.modal-dialog").addClass("model-dialog-size-500")},c.isMoveToPackageVisible=function(){return c.orderType()==ORDER_TYPE_PACKAGE_OPTIONAL_ORDER&&(c.package().status()==PACKAGE_STATUS_ENUM.OPEN||c.package().status()==PACKAGE_STATUS_ENUM.INDICATED||c.package().status()==PACKAGE_STATUS_ENUM.PRICE_REQUESTED)},c.processOrderItems=function(a,b,d,e,f){for(var g="",h=0;h<a.items().length;h++)g+=a.items()[h].id()+",";g=g.substr(0,g.length-1),c.processingOrder(!0),$.ajax(serviceRootURL+"/packages_process_order_items",{type:"GET",data:{ids:g,action:b,note:d,startTime:e,startTimeTba:f},dataType:"json",contentType:"application/json",success:function(a,d,e){console.log(b+" order item (no coding) result retrieved: "+a),"move"==b&&c.itemMoveCallback?c.loadOrder().pipe(function(){c.itemMoveCallback()}):c.loadOrder()},error:function(a,d,e){console.log("error on "+b),checkSession(a),c.processingOrder(!1),showError("Fehler beim "+b,a,d,e)}})},c.assignHotels=function(a,b){if(c.validateStartTime(a.firstItem())){var d=[],e=[],f=null,g=null,h=null;console.log("assignHotels",a),a.subgroups().forEach(function(a){a.groupItem().categoryKey()==CATEGORY_KEY_HOTEL&&(f=a.groupItem().date(),g=a.groupItem().toDate(),h=a.groupItem().regionName()),a.groupItem().categoryKey()==CATEGORY_KEY_SUBSERVICE&&e.push(a.groupItem())}),c.order().orderItems().forEach(function(a){a.categoryKey()==CATEGORY_KEY_HOTEL&&f==a.date()&&g==a.toDate()&&h==a.regionName()&&d.push(a)}),e.forEach(function(a){d.push(a)}),c.openAssignHotelDialog(d)}},c.openReservationDialog=function(a){c.validateStartTime(a.firstItem())&&c.showReservationDialog(a)},c.performBookOrderItemGroup=function(a,b){c.processingOrder(!0),c.bookOrderItemGroup(a,!0)},c.performCancelOrderItemGroup=function(a,b){return c.processingOrder(!0),c.cancelOrderItemGroup(a,!0)},c.isStatusLabelVisible=function(a){return c.serviceDetailsVisible()&&a.categoryKey!==CATEGORY_KEY_MARGIN&&a.categoryKey!==CATEGORY_KEY_TOURIST_TAX}};ko.components.register("package-order",{viewModel:{createViewModel:function(a,b){return new PackageOrderViewModel(a)}},template:{fromUrl:"assets/templates/package-order.html",maxCacheAge:1234}});var PaginationViewModel=function(a){var b=this;b.id=ko.observable(),b.selectedPage=a.selectedPage,b.nrOfPages=a.nrOfPages,b.availablePages=ko.observableArray(),b.selectedItemsPerPage=a.selectedItemsPerPage,b.itemsPerPage=ko.observableArray([20,50,100]),b.loading=!!a.loading&&a.loading,b.loadTrigger=a.loadTrigger,a.itemsPerPage&&(b.itemsPerPage=a.itemsPerPage);var c=function(a){if(b.availablePages([]),b.selectedPage()>a&&b.selectedPage(a),a>0)for(var c=1;c<=a;c++)b.availablePages.push({label:c,key:c});else b.availablePages.push({label:1,key:1})};b.nrOfPages.subscribe(function(a){c(a)}),c(b.nrOfPages()),b.isSelected=function(a,c){return b.selectedPage()==a.key},b.selectPage=function(a,c){b.selectedPage(a.key)},b.selectNextPage=function(a,c){if(b.availablePages().length>0){var d=b.availablePages()[b.availablePages().length-1];b.selectedPage()<d.key&&b.selectedPage(b.selectedPage()+1)}},b.selectPreviousPage=function(a,c){if(b.availablePages().length>0){var d=b.availablePages()[0];b.selectedPage()>d.key&&b.selectedPage(b.selectedPage()-1)}},b.firstSelected=ko.computed(function(){if(b.availablePages().length>0){var a=b.availablePages()[0];return b.selectedPage()==a.key}return!0}),b.lastSelected=ko.computed(function(){var a=b.availablePages();if(a.length>0){var c=a[a.length-1];return b.selectedPage()==c.key}return!0}),console.log("PaginationViewModel created",b,a)};ko.components.register("pagination",{viewModel:{createViewModel:function(a,b){return new PaginationViewModel(a)}},template:{fromUrl:"assets/templates/pagination.html",maxCacheAge:1234}});var PeriodSelectionViewModel=function(a){var b=this;b.fromDate=a.fromDate,b.toDate=a.toDate,b.labelText=a.labelText,b.dateFormat=$.datepicker._defaults.dateFormat,b.placeHolder=ko.observable("dd.mm.yyyy"),b.isRequired=ko.observable(!1),b.errorFieldId="#errorFieldId",b.labelOnTop=ko.observable(!1),b.autoJumpToToDate=!!a.autoJumpToToDate&&a.autoJumpToToDate,b.adjustToDate=!!a.adjustToDate&&a.adjustToDate,b.datePickerDateDependency=ko.observable(!0),b.rightPickerBorderOpen=ko.observable(!1),b.index=a.index?a.index():"",b.fromAfterToMessage=ko.observable(i18n.t("registration.details.fromDateAfterTo")),b.fromDatePickerId="fromDatePicker"+b.index,b.toDatePickerId="toDatePicker"+b.index,b.allowSameDate=ko.observable(!1),b.enabled=ko.observable(!0),b.invalidDateFormatMessage=ko.observable(i18n.t("packages.msg.invalidDateFormat")),void 0!==a.enabled&&(b.enabled=a.enabled),b.fromDatePickerEnabled=ko.computed(function(){return!1!==a.fromDatePickerEnabled()&&b.enabled()}),b.toDatePickerEnabled=ko.computed(function(){return!1!==a.toDatePickerEnabled()&&b.enabled()});var c,d=0;void 0!=a.datePickerDateDependency&&b.datePickerDateDependency(a.datePickerDateDependency),void 0!=a.allowSameDate&&b.allowSameDate(a.allowSameDate),c=1==a.todayAsMinDate?0:void 0,a.dayOffsetForPeriodSelection&&(d=0==a.dayOffsetForPeriodSelection?void 0:a.dayOffsetForPeriodSelection),void 0!==a.isRequired&&(ko.isObservable(a.isRequired)?b.isRequired=a.isRequired:b.isRequired(a.isRequired)),a.dateFormat&&(b.dateFormat=a.dateFormat),a.placeHolder&&(b.placeHolder(a.placeHolder),headerVM&&headerVM.dateTimeOverwriteLocale()&&("de"==headerVM.dateTimeOverwriteLocale()&&b.placeHolder("DD.MM.YYYY"),"en"!=headerVM.dateTimeOverwriteLocale()&&"ch"!=headerVM.dateTimeOverwriteLocale()||b.placeHolder("MM/DD/YYYY"),"fr"==headerVM.dateTimeOverwriteLocale()&&b.placeHolder("JJ.MM.AAAA"))),a.errorFieldId&&(b.errorFieldId=a.errorFieldId),void 0!==a.labelOnTop&&b.labelOnTop(a.labelOnTop),void 0!==a.adjustToDate&&(b.adjustToDate=a.adjustToDate),void 0!==a.autoJumpToToDate&&(b.autoJumpToToDate=a.autoJumpToToDate),void 0!==a.rightPickerBorderOpen&&b.rightPickerBorderOpen(a.rightPickerBorderOpen),a.resetDateRestrictions&&a.resetDateRestrictions.subscribe(function(a){1==a&&b.resetDateRestrictions()}),b.fromDateHandler=b.fromDate.subscribe(function(a){var c=$("#"+b.toDatePickerId);if(void 0==a){var d=$("#"+b.fromDatePickerId);d.datepicker("option","minDate",0),d.datepicker("option","maxDate",null),d.datepicker().val(void 0)}else if(b.adjustToDate&&null!=a){var f=e(a),g=new Date(c.datepicker("getDate"));if(f.getTime()>=g.getTime()){var h=new Date(f);h.setDate(h.getDate()+1),b.toDate(moment(h).format(getMomentJsDateFormat()))}}b.autoJumpToToDate&&setTimeout(function(){c.datepicker("show")},1)}),b.toDateHandler=b.toDate.subscribe(function(a){if(void 0==a){var c=$("#"+b.toDatePickerId);c.datepicker("option","minDate",d),c.datepicker("option","maxDate",null),c.datepicker().val(void 0)}});var e=function(a){if(a){var b=getMomentJsDateFormat(),c=new Date(moment(a,b).format("YYYY-MM-DD")),d=c.getMonth(),e=c.getDate(),f=c.getFullYear();return new Date(f,d,e)}return null};b.resetDateRestrictions=function(){var a=$("#"+b.fromDatePickerId);a.datepicker("option","minDate",null),a.datepicker("option","maxDate",null);var a=$("#"+b.toDatePickerId);a.datepicker("option","minDate",null),a.datepicker("option","maxDate",null)},window.Parsley._validatorRegistry.validators.dateValidation||window.Parsley.addValidator("dateValidation",{validate:function(a,b){if(""===a)return!0;var c=getMomentJsDateFormat();return moment(a,c,!0).isValid()},messages:{de:b.invalidDateFormatMessage(),en:b.invalidDateFormatMessage(),fr:b.invalidDateFormatMessage(),it:b.invalidDateFormatMessage()}}),window.Parsley._validatorRegistry.validators.periodValidation||window.Parsley.addValidator("periodValidation",{validate:function(a,b,c){var d=getMomentJsDateFormat(),e=c.parent.$element,f=e.find(".fromDatePicker"),g=c.$element,h=moment(f.val(),d,!0),i=moment(g.val(),d,!0);if(h.isValid()&&i.isValid()){return"true"==e.find(".allowSameDate").val()?i.isAfter(h)||i.isSame(h):i.isAfter(h)}},messages:{de:b.fromAfterToMessage(),en:b.fromAfterToMessage(),fr:b.fromAfterToMessage(),it:b.fromAfterToMessage()}}),setMaxDate=function(){if(void 0!=a.maxDateFixed&&a.maxDateFixed()){var c=e(b.toDate());null!=c&&$("#"+b.toDatePickerId).datepicker("option","maxDate",c)}},setMinDate=function(){if(void 0!=a.minDateFixed&&a.minDateFixed()){var c=e(b.fromDate());null!=c&&$("#"+b.fromDatePickerId).datepicker("option","minDate",c)}},b.componentLoaded=function(){if(0==b.datePickerDateDependency())return $("#"+b.fromDatePickerId).datepicker(),$("#"+b.toDatePickerId).datepicker(),setMaxDate(),void setMinDate();$("#"+b.fromDatePickerId).datepicker($.extend({onSelect:function(){var a=$(this).datepicker("getDate");a.setDate(a.getDate()+d),b.fromDate($(this).datepicker({dateFormat:b.dateFormat}).val()),$("#"+b.toDatePickerId).datepicker("option","minDate",a),$(this).parsley().validate()}},{minDate:c,dateFormat:b.dateFormat})),$("#"+b.toDatePickerId).datepicker($.extend({onSelect:function(){var a=$(this).datepicker("getDate");a.setDate(a.getDate()-d),b.toDate($(this).datepicker({dateFormat:b.dateFormat}).val()),$("#"+b.fromDatePickerId).datepicker("option","maxDate",a),$(this).parsley().validate()}},{minDate:void 0!=c?c+d:void 0,dateFormat:b.dateFormat}));var a=$("#"+b.toDatePickerId).datepicker("getDate");null!=a&&(a.setDate(a.getDate()-d),$("#"+b.fromDatePickerId).datepicker("option","maxDate",a));var e=$("#"+b.fromDatePickerId).datepicker("getDate");null!=e&&(e.setDate(e.getDate()+d),$("#"+b.toDatePickerId).datepicker("option","minDate",e))},PeriodSelectionViewModel.prototype.dispose=function(){b.fromDateHandler.dispose(),b.toDateHandler.dispose()}};ko.components.register("period-selection",{viewModel:{createViewModel:function(a,b){return new PeriodSelectionViewModel(a)}},template:{fromUrl:"assets/templates/period-selection.html",maxCacheAge:1234}});var PhotoUpload=function(a){var b=this;b.imgMaxSize=a&&a.imgMaxSize||ko.observable([0,0]),
b.imgMinSize=a&&a.imgMinSize||ko.observable([0,0]),b.aspectRatio=a&&a.aspectRatio||ko.observable(4/3),b.photo=a&&a.photo||ko.observable(),b.placeholder=a&&a.placeholder||ko.observable(""),b.tooSmallMessage=a&&a.tooSmallMessage||ko.observable(""),b.requiredMessage=a&&a.requiredMessage||ko.observable(""),b.confirmMessage=a&&a.confirmMessage||ko.observable(""),b.required=a&&a.required?ko.observable(!0):ko.observable(!1),b.enabled=a&&a.enabled?ko.observable(!0):ko.observable(!1),b.tooSmall=ko.observable(!1),b.isEditMode=ko.observable(!1),b.isResizing=ko.observable(!1),b.cropper=null,b.cropperLoading=ko.observable(!1),b.zoomingIn=null,b.zoomingOut=null,b.imgMaxSize=ko.observable(b.imgMaxSize),b.imgMinSize=ko.observable(b.imgMinSize),b.aspectRatio=ko.observable(b.aspectRatio),b.placeholder=ko.observable(b.placeholder),b.tooSmallMessage=ko.observable(b.tooSmallMessage),b.confirmMessage=ko.observable(b.confirmMessage),b.hasPhoto=ko.observable(null!=b.photo())};ko.bindingHandlers.photoupload={init:function(a,b,c,d,e){var f=$(a),g=$("body"),h=f.find(".photoupload__drop-area"),i=f.find(".photoupload__img"),j=i[0],k={aspectRatio:e.$data.aspectRatio(),viewMode:3,dragMode:"move"},l=function(){null!=e.$data.cropper&&e.$data.cropper.destroy(),f.find(".photoupload__fallback").val(""),i.attr("src",""),e.$data.photo(null),e.$data.hasPhoto(!1),e.$data.isEditMode(!1)};window.Parsley._validatorRegistry.validators.photo||window.Parsley.addValidator("photo",{messages:{en:"Please confirm the uploaded photo by clicking OK."},requirementType:"boolean",validateString:function(){return!e.$data.isEditMode()}}),j.addEventListener("load",function(){e.$data.isEditMode()&&(e.$data.cropperLoading(!0),e.$data.cropper=new Cropper(this,k))},!1),j.addEventListener("ready",function(){e.$data.isEditMode()&&(e.$data.cropperLoading(!1),e.$data.hasPhoto(!0))},!1),g.on("dragenter dragleave",function(a){var b="dragenter"===a.type?1:-1,c=(h.data("dragCount")||0)+b;h.data("dragCount",c).toggleClass("dragged",c>0)}),f.on("dragenter dragleave",".photoupload__drop-area",function(a){var b="dragenter"===a.type?1:-1,c=(h.data("dragOverCount")||0)+b;h.data("dragOverCount",c).toggleClass("predrop",c>0)}),g.on("drop",function(a){a.preventDefault(),h.removeClass("dragged").removeData("dragCount").removeData("dragOverCount")}),g.on("dragover",function(a){a.preventDefault()}),f.on("dragover",".photoupload__drop-area",function(a){a.preventDefault()}),h[0].addEventListener("drop",function(a){if(!e.$data.hasPhoto()){var b=a.dataTransfer.files;if(b.length>0){var c=b[0];if("undefined"!=typeof FileReader&&-1!==c.type.indexOf("image")){var d=new FileReader;d.onload=function(a){if("undefined"!=typeof Image){var b=new Image,c=e.$data.imgMaxSize();b.onload=function(){if(this.width<c[0]||this.height<c[1])return l(),void e.$data.tooSmall(!0);e.$data.tooSmall(!1),b=null},b.src=a.target.result}e.$data.isEditMode(!0),j.src=a.target.result},d.readAsDataURL(c)}}}h.removeClass("predrop"),a.preventDefault()},!1),f.on("click",".photoupload__drop-area",function(a){a.preventDefault(),h.hasClass("has-image")||f.find(".photoupload__fallback").trigger("click")}),f.on("change",".photoupload__fallback",function(a){if(!e.$data.hasPhoto()){var b=a.target.files[0];if("undefined"!=typeof FileReader&&-1!==b.type.indexOf("image")){var c=new FileReader;c.onload=function(a){if("undefined"!=typeof Image){var b=new Image,c=e.$data.imgMinSize();b.onload=function(){if(this.width<c[0]||this.height<c[1])return l(),void e.$data.tooSmall(!0);e.$data.tooSmall(!1),b=null},b.src=a.target.result}e.$data.isEditMode(!0),j.src=a.target.result},c.readAsDataURL(b)}}h.removeClass("predrop")}),f.on("click",".photoupload__clear",function(a){a.preventDefault(),l()}),f.on("click",".photoupload__zoomin",function(a){e.$data.cropper.zoom(.1)}),f.on("mousedown",".photoupload__zoomin",function(a){e.$data.zoomingIn=setInterval(function(){e.$data.cropper.zoom(.1)},100)}),f.on("mouseup",".photoupload__zoomin",function(a){clearInterval(e.$data.zoomingIn)}),f.on("click",".photoupload__zoomout",function(a){e.$data.cropper.zoom(-.1)}),f.on("mousedown",".photoupload__zoomout",function(a){e.$data.zoomingOut=setInterval(function(){e.$data.cropper.zoom(-.1)},100)}),f.on("mouseup",".photoupload__zoomout",function(a){clearInterval(e.$data.zoomingOut)}),f.on("click",".photoupload__rotateright",function(a){e.$data.cropper.rotate(90)}),f.on("click",".photoupload__rotateleft",function(a){e.$data.cropper.rotate(-90)}),f.on("click",".photoupload__submit",function(a){var b=e.$data.cropper.getCroppedCanvas(),c=e.$data.imgMaxSize(),d=1;c[0]>0&&c[1]>0&&(d=b.width>c[0]&&b.height<=c[1]?c[0]/(b.width/100)/100:b.height>c[1]&&b.width<=c[0]?c[1]/(b.height/100)/100:c[0]/(b.width/100)/100),d<1?(e.$data.isResizing(!0),Hermite.resample(b,Math.floor(b.width*d),Math.floor(b.height*d),!0,function(){e.$data.isEditMode(!1),e.$data.isResizing(!1),e.$data.photo(b.toDataURL("image/jpeg")),e.$data.cropper.destroy()})):(e.$data.isEditMode(!1),e.$data.photo(b.toDataURL("image/jpeg")),e.$data.cropper.destroy())})}},ko.components.register("photoupload",{viewModel:{createViewModel:function(a,b){return new PhotoUpload(a)}},template:{fromUrl:"assets/templates/photoupload.html"}});var CategoryFilterVM=function(a){var b=this;b.selectedCategory=ko.observable(),b.categoryOptions=ko.observableArray([]),b.loading=ko.observable(!1),a.selectedCategory&&(b.selectedCategory=a.selectedCategory),b.changeListener=function(){a.changeListener&&a.changeListener(b.selectedCategory())},b.resetFilter=function(){null!=b.selectedCategory()&&(b.selectedCategory(null),b.changeListener())},b.loadCategories=function(){b.loading(!0),$.getJSON(serviceRootURL+"/categories?categoryType="+CATEGORY_TYPE_CASHDESKSALE,function(a){var c=$.map(a,function(a){return a.key==CATEGORY_KEY_DAYTRIPS&&(a.key=CATEGORY_KEY_BUNDLE),new categoryModel(a)});b.categoryOptions(c),b.loading(!1)}).fail(function(a,c,d){showError("Fehler beim Laden der Categorien",a,c,d),b.loading(!1)})},b.loadCategories()};ko.components.register("category-filter",{viewModel:{createViewModel:function(a,b){return new CategoryFilterVM(a)}},template:{fromUrl:"assets/templates/category-filter.html",maxCacheAge:1234}});var formatDate=function(a){return headerVM&&headerVM.dateTimeOverwriteLocale()?moment(a).locale(headerVM.dateTimeOverwriteLocale()).format("L"):moment(a).format("L")},ShoppingCartEntryViewModel=function(a){var b=this;b.entry=a.entry,b.cart=a.cart,b.showPrices=a.showPrices,b.selectedRate=a.selectedRate,b.selectedRateName=a.selectedRateName,b.skipassShowReduced=a.skipassShowReduced,b.currency=a.currency,b.incrEntryQuantity=function(a,c){b.cart.incrEntryQuantity(b.entry,c)},b.decrEntryQuantity=function(a,c){b.cart.decrEntryQuantity(b.entry,c)},b.removeEntry=function(a,c){b.entry.categoryKey()==CATEGORY_KEY_BUNDLE&&b.entry.price().bundleItems().forEach(function(a){var b=a.price();b instanceof eprAddonPriceModel&&b.eprSelected(!1)}),b.cart.removeEntry(b.entry,c)},b.selectEpr=function(a,b,c){var d=b.price().eprSelected(),e=b.price().direction();console.log("selectEpr",b,a.price().bundleItems());for(var f=1;f<a.price().bundleItems().length;f++){var g=a.price().bundleItems()[f].price();g instanceof eprAddonPriceModel&&e==g.direction()&&(b.price().id()==g.id()?g.eprSelected(d):g.eprSelected(!1))}return!0},b.selectAddon=function(a,b,c){var d=b.price().selected();console.log("selectAddon",b,a.price().bundleItems());for(var e=1;e<a.price().bundleItems().length;e++){var f=a.price().bundleItems()[e].price();f instanceof addonPriceModel&&(b.price().id()==f.id()?f.selected(d):f.selected(!1))}return!0},b.compareBundleItems=function(a,b){return moment(a.price().date()).isSame(moment(b.price().date()))?a.price().categoryKey()==b.price().categoryKey()?a.price().categoryKey()==CATEGORY_KEY_ADDON&&b.price().categoryKey()==CATEGORY_KEY_ADDON&&a.price()instanceof eprAddonPriceModel&&b.price()instanceof eprAddonPriceModel?a.price().direction()==b.price().direction()?a.price().trainType()==BERGBAHN_TRAIN_TYPE_TRADITIONAL?-1:b.price().trainType()==BERGBAHN_TRAIN_TYPE_TRADITIONAL?1:0:a.price().direction()==BERGBAHN_EPR_OUTWARD?-1:b.price().direction()==BERGBAHN_EPR_OUTWARD?1:a.price().direction()<b.price().direction():null!=a.price().reductionLevel()&&""!=a.price().reductionLevel()||null==b.price().reductionLevel()||""==b.price().reductionLevel()?null!=b.price().reductionLevel()&&""!=b.price().reductionLevel()||null==a.price().reductionLevel()||""==a.price().reductionLevel()?a.price().consumerKey()&&b.price().consumerKey()?a.price().consumerKey()>b.price().consumerKey()?1:-1:0:1:-1:a.price().categoryKey()==CATEGORY_KEY_ADDON?1:b.price().categoryKey()==CATEGORY_KEY_ADDON?-1:a.price().categoryKey()>b.price().categoryKey()?1:-1:moment(a.price().date()).isAfter(moment(b.price().date()))?1:-1},b.firstItemOfDirection=function(a,b){for(var c=1;c<a.price().bundleItems().length;c++){var d=a.price().bundleItems()[c].price();if(d instanceof eprAddonPriceModel&&b.price().id()==d.id()){var e=a.price().bundleItems()[c-1].price();return!(e instanceof eprAddonPriceModel)||d.direction()!=e.direction()}}return!1},b.getDirectionText=function(a){if(a.price()instanceof eprAddonPriceModel){if(a.price().direction()==BERGBAHN_EPR_OUTWARD)return i18n.t("checkout.epr.outwardTitle");if(a.price().direction()==BERGBAHN_EPR_RETURN)return i18n.t("checkout.epr.returnTitle")}return null}};ko.components.register("shopping-cart-entry",{viewModel:{createViewModel:function(a,b){return new ShoppingCartEntryViewModel(a)}},template:{fromUrl:"assets/templates/shopping-cart-entry.html",maxCacheAge:1234}});var SubserviceSelectionViewModel=function(a){var b=this;b.availableSubservices=ko.observableArray([]),b.loading=ko.observable(!1),b.category=ko.observable(),b.consumerGroup=ko.observable(),b.regionName=ko.observable(),b.type=ko.observable(),b.date=ko.observable(a.serviceGroup.date()),b.toDate=ko.observable(a.serviceGroup.toDate()),b.selectTitle=ko.observable(i18n.t("packages.subservices.placeholder")),console.log("SubserviceSelectionViewModel",b,a),a.serviceGroup.firstItem&&a.serviceGroup.firstItem()&&(b.consumerGroup(-1!=a.serviceGroup.firstItem().consumerKey().indexOf("GRP")?"group":"fit"),a.serviceGroup.firstItem().roomCategoryName&&b.category(a.serviceGroup.firstItem().roomCategoryName().toLowerCase()),b.regionName(a.serviceGroup.firstItem().regionName())),b.id=ko.observable(a.serviceGroup.categoryKey()+"_"+a.serviceGroup.firstItem().id()),a.serviceGroup.categoryKey&&b.type(a.serviceGroup.categoryKey().toLowerCase()),b.addSubservice=function(){if(a.addSubserviceCallback){var c=[];b.availableSubservices().forEach(function(d){d.selected()&&(a.serviceGroup&&(d.refItemId(a.serviceGroup.firstItem().id()),d.priceModels().forEach(function(a){a.date(b.date()),a.toDate(b.toDate())})),c.push(d))}),a.addSubserviceCallback(c)}b.closeDialog()},b.changeListener=function(){},b.showAddDialog=function(){$("#"+b.id()).modal("show")},b.closeDialog=function(){$("#"+b.id()).modal("hide")};var c=function(){if(a.serviceGroup){var c=[];b.availableSubservices().forEach(function(b){a.serviceGroup.subgroups().forEach(function(a){a instanceof PackageOrderItemSubServiceViewModel&&a.groupItem().productKey()===b.productKey()&&(b.selected(!0),c.push(b))})}),b.availableSubservices(b.availableSubservices().filter(function(a){return!c.includes(a)})),b.availableSubservices().length>0?b.selectTitle(i18n.t("packages.subservices.placeholder")):b.selectTitle(i18n.t("packages.subservices.noServicesAvailable"))}};b.loadSubservices=function(){b.loading(!0),$.getJSON(serviceRootURL+"/options?categoryKey=SUBSERVICE&optionListKey="+b.type(),function(a){b.availableSubservices([]),a&&a.length>0&&a[0].additionalInfo.subservices.forEach(function(a){if(a.regionName==b.regionName()){var c=!1;if(a.items.forEach(function(a){a.consumerGroup!==b.consumerGroup()||null!=a.categoryType&&b.category()!==a.categoryType||(c=!0)}),c){var d=new SubserviceMultiSelectOptionModel(a,b.category(),b.consumerGroup());b.availableSubservices.push(d),d.items().forEach(function(a){var c=serviceRootURL+"/subserviceprice?productKey="+a.product.sku+"&fromDateString="+b.date();$.getJSON(c,function(a){d.priceModels.push(new SubservicePriceModel(a))})})}}}),c(),b.loading(!1)}).fail(function(a,c,d){showError("Fehler beim Laden der Subservices",a,c,d),b.loading(!1)})},b.loadSubservices(),b.addServiceDisabled=ko.computed(function(){return b.availableSubservices().length>0}),b.addServiceBtnDisabled=ko.computed(function(){for(var a=0;a<b.availableSubservices().length;a++)if(b.availableSubservices()[a].selected())return!1;return!0}),b.componentLoaded=function(){$("#"+b.id()).on("hidden.bs.modal",function(){var a=document.getElementById("selectionOption"+b.id());a&&(a.style.display="none")})}};ko.components.register("subservice-selection",{viewModel:{createViewModel:function(a,b){return new SubserviceSelectionViewModel(a)}},template:{fromUrl:"assets/templates/subservice-selection.html",maxCacheAge:1234}});var templateFromUrlLoader={loadTemplate:function(a,b,c){if(b.fromUrl){var d=b.fromUrl;$.get(d,function(b){ko.components.defaultLoader.loadTemplate(a,b,c)})}else c(null)}};ko.components.loaders.unshift(templateFromUrlLoader);var TimeSelectionViewModel=function(a){var b=this;b.upContingents=ko.observableArray(),b.downContingents=ko.observableArray(),b.upContingentsVbahn=ko.observableArray(),b.downContingentsVbahn=ko.observableArray(),b.trainsUpTraditional=ko.observableArray(),b.trainsDownTraditional=ko.observableArray(),b.trainsUpVbahn=ko.observableArray(),b.trainsDownVbahn=ko.observableArray(),b.trainsUpTraditionalTemp=ko.observableArray(),b.trainsDownTraditionalTemp=ko.observableArray(),b.trainsDownVbahnTemp=ko.observableArray(),b.trainsUpVbahnTemp=ko.observableArray(),b.selectedTrainUp=ko.observable(),b.selectedTrainDown=ko.observable(),b.selectedTrainUpVbahn=ko.observable(),b.selectedTrainDownVbahn=ko.observable(),b.checkoutEntries=a.checkoutEntries,b.outwardCheckoutAddonItems=ko.observableArray(),b.returnCheckoutAddonItems=ko.observableArray(),b.outwardTrainType=ko.observable(BERGBAHN_TRAIN_TYPE_TRADITIONAL),b.returnTrainType=ko.observable(BERGBAHN_TRAIN_TYPE_TRADITIONAL),b.externalDisableFlag=ko.observable(!0),a.externalDisableFlag&&(b.externalDisableFlag=a.externalDisableFlag),b.addonOutwardItemSet={},b.addonReturnItemSet={},b.upTrainsLoading=ko.observable(),b.downTrainsLoading=ko.observable(),b.upTrainsLoadingVbahn=ko.observable(),b.downTrainsLoadingVbahn=ko.observable(),b.outwardVbahnContained=ko.observable(!1),b.returnVbahnContained=ko.observable(!1),b.outwardTraditionalContained=ko.observable(!1),b.returnTraditionalContained=ko.observable(!1),b.produceDisabled=a.produceDisabled;b.upTrainSelectionEnabled=ko.computed(function(){return b.trainsUpTraditional().length>0&&!b.externalDisableFlag()}),b.downTrainSelectionEnabled=ko.computed(function(){return b.trainsDownTraditional().length>0&&!b.externalDisableFlag()}),b.upTrainVbahnSelectionEnabled=ko.computed(function(){return b.trainsUpVbahn().length>0&&!b.externalDisableFlag()}),b.downTrainVbahnSelectionEnabled=ko.computed(function(){return b.trainsDownVbahn().length>0&&!b.externalDisableFlag()});var c=function(a){var c=a.bundle().price().sku(),d=a.price().direction();if(d==BERGBAHN_EPR_OUTWARD){var e=a.price().trainType()==BERGBAHN_TRAIN_TYPE_TRADITIONAL?"trainsUpTraditional":"trainsUpVbahn";a.price().trainType()==BERGBAHN_TRAIN_TYPE_TRADITIONAL?(b.upTrainsLoading(!0),b.trainsUpTraditional([])):(b.upTrainsLoadingVbahn(!0),b.trainsUpVbahn([])),b.loadTrains(e,c,function(c){a.price().trainType()==BERGBAHN_TRAIN_TYPE_TRADITIONAL?b.trainsUpTraditionalTemp(c):b.trainsUpVbahnTemp(c),b.loadContingent(a)},function(c){a.price().trainType()==BERGBAHN_TRAIN_TYPE_TRADITIONAL?(b.trainsUpTraditional([]),b.trainsUpTraditionalTemp([])):(b.trainsUpVbahn([]),b.trainsUpVbahnTemp([]))})}else if(d==BERGBAHN_EPR_RETURN){var e=a.price().trainType()==BERGBAHN_TRAIN_TYPE_TRADITIONAL?"trainsDownTraditional":"trainsDownVbahn";a.price().trainType()==BERGBAHN_TRAIN_TYPE_TRADITIONAL?(b.downTrainsLoading(!0),b.trainsDownTraditional([])):(b.downTrainsLoadingVbahn(!0),b.trainsDownVbahn([])),b.loadTrains(e,c,function(c){a.price().trainType()==BERGBAHN_TRAIN_TYPE_TRADITIONAL?b.trainsDownTraditionalTemp(c):b.trainsDownVbahnTemp(c),b.loadContingent(a)},function(c){a.price().trainType()==BERGBAHN_TRAIN_TYPE_TRADITIONAL?(b.trainsDownTraditional([]),b.trainsDownTraditionalTemp([])):(b.trainsDownVbahn([]),b.trainsDownVbahnTemp([]))})}};b.computeProduceAllowed=ko.computed(function(){b.produceDisabled&&(b.upTrainsLoading()||b.downTrainsLoading()||b.upTrainsLoadingVbahn()||b.downTrainsLoadingVbahn()?b.produceDisabled(!0):b.trainsUpVbahn().length>0&&!b.selectedTrainUpVbahn()?b.produceDisabled(!0):b.trainsDownVbahn().length>0&&!b.selectedTrainDownVbahn()?b.produceDisabled(!0):b.trainsUpTraditional().length>0&&!b.selectedTrainUp()?b.produceDisabled(!0):b.trainsDownTraditional().length>0&&!b.selectedTrainDown()?b.produceDisabled(!0):b.produceDisabled(!1))}),b.trainSelectionOutwardVisible=ko.computed(function(){return 0!=b.outwardCheckoutAddonItems().length}),b.trainSelectionReturnVisible=ko.computed(function(){return 0!=b.returnCheckoutAddonItems().length}),b.getOptionHtml=function(a){if(a.data){var b=a.data.contingent()?a.data.contingent().status():0,c="time-selection-option train-availability";return 0==b&&(c+=" disabled"),"<div class="+c+">"+a.data.deptime()+" (an "+a.data.arrtime()+")</div>"}return'<div class="time-selection-option">'+i18n.t("checkout.epr.pleaseSelect")+"</div>"},b.outwardTrainType.subscribe(function(a){b.selectedTrainUp(null)}),b.returnTrainType.subscribe(function(a){b.selectedTrainDown(null)}),b.setSelectedTrainToAddons=function(a,b,c){a.forEach(function(a){if(a.price().eprSelected()){var d=0==b?null:b;c==a.price().trainType()&&(a.price().selectedTrain(d),a.disabledInCheckout(null==d))}else a.price().selectedTrain(null),a.disabledInCheckout(!0)})},b.selectedTrainUp.subscribe(function(a){b.setSelectedTrainToAddons(b.outwardCheckoutAddonItems(),a,BERGBAHN_TRAIN_TYPE_TRADITIONAL)}),b.selectedTrainDown.subscribe(function(a){b.setSelectedTrainToAddons(b.returnCheckoutAddonItems(),a,BERGBAHN_TRAIN_TYPE_TRADITIONAL)}),b.selectedTrainUpVbahn.subscribe(function(a){b.setSelectedTrainToAddons(b.outwardCheckoutAddonItems(),a,BERGBAHN_TRAIN_TYPE_VBAHN)}),b.selectedTrainDownVbahn.subscribe(function(a){b.setSelectedTrainToAddons(b.returnCheckoutAddonItems(),a,BERGBAHN_TRAIN_TYPE_VBAHN)});var d=function(a,b){for(var c=0;c<b.length;c++)for(var d=b[c],e=0;e<a.length;e++){var f=a[e];if(d.trainNumber()===f.id()){d.contingent(f);break}}},e=function(a){return ko.utils.arrayFilter(a,function(a){return!!a.contingent()&&a.contingent().freeSeats()>0})};b.loadContingent=function(a){$.getJSON(serviceRootURL+"/contingent_info",{categoryKey:CATEGORY_KEY_BERGBAHN_EPR,dateString:a.price().date(),productId:a.price().id()}).done(function(c){var f=$.map(c,function(a){return new categoryContingentModel(a)});console.log("Timeselection EPR contingent received",f),a.price().direction()==BERGBAHN_EPR_OUTWARD&&(a.price().trainType()==BERGBAHN_TRAIN_TYPE_TRADITIONAL?(b.upContingents(f),d(b.upContingents(),b.trainsUpTraditionalTemp()),b.trainsUpTraditional(e(b.trainsUpTraditionalTemp())),b.upTrainsLoading(!1)):(b.upContingentsVbahn(f),d(b.upContingentsVbahn(),b.trainsUpVbahnTemp()),b.trainsUpVbahn(e(b.trainsUpVbahnTemp())),b.upTrainsLoadingVbahn(!1))),a.price().direction()==BERGBAHN_EPR_RETURN&&(a.price().trainType()==BERGBAHN_TRAIN_TYPE_TRADITIONAL?(b.downContingents(f),d(b.downContingents(),b.trainsDownTraditionalTemp()),b.trainsDownTraditional(e(b.trainsDownTraditionalTemp())),b.downTrainsLoading(!1)):(b.downContingentsVbahn(f),d(b.downContingentsVbahn(),b.trainsDownVbahnTemp()),b.trainsDownVbahn(e(b.trainsDownVbahnTemp())),b.downTrainsLoadingVbahn(!1)))}).fail(function(){console.log("Timeselection contingent info not found for addon",a),a.price().direction()==BERGBAHN_EPR_OUTWARD&&(a.price().trainType()==BERGBAHN_TRAIN_TYPE_TRADITIONAL&&(b.upContingents.removeAll(),b.upTrainsLoading(!1)),a.price().trainType()==BERGBAHN_TRAIN_TYPE_VBAHN&&(b.upContingentsVbahn.removeAll(),b.upTrainsLoadingVbahn(!1))),a.price().direction()==BERGBAHN_EPR_RETURN&&(a.price().trainType()==BERGBAHN_TRAIN_TYPE_TRADITIONAL&&(b.downContingents.removeAll(),b.downTrainsLoading(!1)),a.price().trainType()==BERGBAHN_TRAIN_TYPE_VBAHN&&(b.downContingentsVbahn.removeAll(),b.downTrainsLoadingVbahn(!1)))})},b.loadTrains=function(a,b,c,d){var e=null!=touroperatorVM.selectedTouroperator()?touroperatorVM.selectedTouroperator().id():"";return $.getJSON(serviceRootURL+"/options",{categoryKey:CATEGORY_KEY_DAYTRIPS,optionListKey:a,parentOptionListKey:"routes",parentOptionKey:b,partnerId:e}).done(function(b){var d=$.map(b,function(a){return new bergbahnEprTrainOptionModel(a)});console.log("Trains loaded ",d,a,b),c(d)}).fail(function(){console.log("trains not found for route ",route,a),d()})},function(){if(b.checkoutEntries&&b.checkoutEntries()){for(var a=0;a<b.checkoutEntries().length;a++){var d=b.checkoutEntries()[a];d instanceof ShopCheckoutBundleItemModel&&(d.categoryKey()==CATEGORY_KEY_BERGBAHN&&d.price().date(),d.categoryKey()==CATEGORY_KEY_ADDON&&d.price()instanceof eprAddonPriceModel&&(d.disabledInCheckout(!0),d.price().direction()==BERGBAHN_EPR_OUTWARD?(b.addonOutwardItemSet[d.price().id()]||(b.addonOutwardItemSet[d.price().id()]=d),d.price().eprSelected()&&(b.outwardCheckoutAddonItems.push(d),d.price().trainType()==BERGBAHN_TRAIN_TYPE_TRADITIONAL?b.outwardTraditionalContained(!0):b.outwardVbahnContained(!0))):d.price().direction()==BERGBAHN_EPR_RETURN&&(b.addonReturnItemSet[d.price().id()]||(b.addonReturnItemSet[d.price().id()]=d),d.price().eprSelected()&&(b.returnCheckoutAddonItems.push(d),d.price().trainType()==BERGBAHN_TRAIN_TYPE_TRADITIONAL?b.returnTraditionalContained(!0):b.returnVbahnContained(!0)))))}b.outwardCheckoutAddonItems().forEach(function(a){a.price().eprSelected()&&c(a)}),b.returnCheckoutAddonItems().forEach(function(a){a.price().eprSelected()&&c(a)})}}()};ko.components.register("time-selection",{viewModel:{createViewModel:function(a,b){return new TimeSelectionViewModel(a)}},template:{fromUrl:"assets/templates/time-selection.html",maxCacheAge:1234}});var TimeoutDialogViewModel=function(a){var b=this;b.id=ko.observable(),b.loading=ko.observable(!1),b.headerTitle=ko.observable(),b.counter=ko.observable("00:00"),b.intervalId=null,b.expireCheckId=null,b.expiresInSeconds=ko.observable(),console.log("TimeoutDialogViewModel",a),a.id&&b.id(a.id),b.logout=function(){b.loading(!0),b.stopTimer(),b.stopExpireCheck(),window.location.replace("/logout"),b.loading(!1)},b.renewSession=function(){b.loading(!0),b.stopTimer(),$.ajax({url:serviceRootURL+"/renewSession",type:"GET",contentType:"application/json",success:function(a,c,d){console.log("renewSession",a),b.closeDialog(),b.loading(!1),b.expiresInSeconds(a.expiresInSeconds),b.startExpireCheck(0)},error:function(a,c,d){showError("renewSession error",a,c,d),b.startTimer()}})};var c=function(){var a=Math.floor(b.expiresInSeconds()/60),c=Math.floor(b.expiresInSeconds()%60);b.counter(String(a).padStart(2,"0")+":"+String(c).padStart(2,"0")),b.expiresInSeconds()<=0&&(b.stopTimer(),b.logout()),b.expiresInSeconds(b.expiresInSeconds()-1)},d=function(){$.ajax({url:serviceRootURL+"/validateSession",type:"GET",contentType:"application/json",success:function(a,c,d){b.expiresInSeconds(a.expiresInSeconds-30),console.log("expireCheck - session still valid for "+b.expiresInSeconds()+" s"),b.expiresInSeconds()<=300&&(b.stopExpireCheck(),b.startTimer(),b.expiresInSeconds()>0&&setTimeout(b.showDialog,1e3))},error:function(a,b,c){showError("ExpireCheck error",a,b,c)}})};b.startTimer=function(){b.intervalId=setInterval(c,1e3)},b.stopTimer=function(){null!=b.intervalId&&clearInterval(b.intervalId)},b.startExpireCheck=function(a){setTimeout(function(){b.expireCheckId=setInterval(d,6e4)},a)},b.stopExpireCheck=function(){null!=b.expireCheckId&&clearInterval(b.expireCheckId)},b.showDialog=function(){$("#"+b.id()).modal({backdrop:"static",keyboard:!1})},b.closeDialog=function(){$("#"+b.id()).modal("hide")},b.startExpireCheck(0),TimeoutDialogViewModel.prototype.dispose=function(){console.log("Timeout dialog disposed",b.id()),b.stopTimer()}};ko.components.register("timeout",{viewModel:{createViewModel:function(a,b){return new TimeoutDialogViewModel(a)}},template:{fromUrl:"assets/templates/timeout-dialog.html",maxCacheAge:1234}});var TourguideAddViewModel=function(a){var b=this;b.name="TourguideAddViewModel",b.tourGuidesReseller=a.tourGuidesReseller,b.partnerId=a.partnerId,b.callback=a.callback,b.callbackEdit=a.callbackEdit,b.id=ko.observable(),b.username=ko.observable(),b.firstname=ko.observable(),b.lastname=ko.observable(),b.email=ko.observable(),b.phone=ko.observable(),b.password=ko.observable().extend({minLength:{params:3,message:"Bitte gültige Zahl eingeben"},maxLength:10}),b.changepwd=ko.observable(!1),b.Locales=ko.observableArray([]),b.selectedLocale=ko.observable(),b.isRequired=ko.observable(),b.isEdit=ko.observable(!1),b.formItem=null,"expert"==a.userMode?b.isRequired(!1):b.isRequired(!0),b.prepareAsEditForm=function(a){b.formItem=a,b.resetFields(),b.id(kp.get(b.formItem(),"id")),b.username(kp.get(b.formItem(),"username")),b.firstname(kp.get(b.formItem(),"firstname")),b.lastname(kp.get(b.formItem(),"lastname")),b.password(kp.get(b.formItem(),"password")),b.email(kp.get(b.formItem(),"email")),b.phone(kp.get(b.formItem(),"phone")),b.selectedLocale(kp.get(b.selectedLocale(),"locale")),b.showSaveBtn()},b.hideElements=ko.observable(),$("#tourguideDetails").find("select, input").attr("disabled","disabled"),$(".form-group-login, .form-group-password, .form-group-locale").slideDown(),$("#linkTourguide").hide(),$("#saveTourguide").hide(),b.hideElements(0),b.loadLocales=function(){$.getJSON(serviceRootURL+"/common_options",{key:"locales"}).pipe(function(a){var c=$.map(a,function(a){return console.log(a),new optionModel(a)});b.Locales(c)}).fail(function(a,b,c){showError("Fehler beim Laden der Locales",a,b,c)})},b.showSaveBtn=function(){$("#tourguideDetails").find("select, input").removeAttr("disabled"),$("#linkTourguide").hide(),$("#saveTourguide").show(),b.hideElements(0)},b.showLinkBtn=function(){$("#tourguideDetails").find("select, input").attr("disabled","disabled"),$("#linkTourguide").show(),$("#saveTourguide").hide()},b.findTourguide=function(a,c){if(!b.isEdit()){if(c.preventDefault(),$("#searchTourguide").attr("disabled","disabled"),$(".form-group-email").find("input").attr("disabled","disabled"),$("#tourguideDetails").find("select, input").attr("disabled","disabled"),$("#linkTourguide").hide(),$("#saveTourguide").hide(),null==b.email()||""==b.email())return void showInfo(i18n.t("settings.tourguideDetail.msg.emailValidation"),function(){$("#searchTourguide").removeAttr("disabled"),$(".form-group-email").find("input").removeAttr("disabled")});var d=ko.utils.arrayFilter(b.tourGuidesReseller,function(a){return a.email()==b.email()});if(null!=d&&d.length>0)return void showInfo(i18n.t("settings.tourguideDetail.msg.alreadyLinked"),function(){$("#searchTourguide").removeAttr("disabled"),$(".form-group-email").find("input").removeAttr("disabled")});$.getJSON(serviceRootURL+"/tourguides",{email:b.email()}).pipe(function(a){$("#searchTourguide").removeAttr("disabled"),$(".form-group-email").find("input").removeAttr("disabled"),null!=a&&1==a.length?(console.log("tourguide: "+a),b.id(a[0].id),b.username(a[0].username),b.firstname(a[0].firstname),b.lastname(a[0].lastname),b.email(a[0].email),b.phone(a[0].phone),b.showLinkBtn()):(b.id(null),b.username(""),b.firstname(""),b.lastname(""),b.password(""),b.phone(""),b.showSaveBtn())}).fail(function(a,b,c){$("#searchTourguide").removeAttr("disabled"),$(".form-group-email").find("input").removeAttr("disabled"),console.log("tourguide service failed: "+a.responseText),checkSession(a),showError("Fehler beim Durchsuchen der Tourguides",a,b,c)})}},b.createTourguide=function(a){if($("#createTourguide").parsley().isValid()){var c={id:b.id(),username:b.username(),firstname:b.firstname(),lastname:b.lastname(),email:b.email(),phone:b.phone(),locale:b.selectedLocale(),password:b.password()};b.isEdit()?groupReservationApi.updateTourGuide(ko.toJS(c)).then(function(){$("#tourguideAdd").modal("hide"),$("#tourguideAdd").one("hidden.bs.modal",function(){null!==b.callbackEdit&&b.callbackEdit(new tourguideModel(c))}),b.hideElements(0)}):$.ajax(serviceRootURL+"/tourguides",{type:"POST",data:JSON.stringify(c),dataType:"json",contentType:"application/json",success:function(a,c,d){console.log("create tourguide request successful"),$("#tourguideAdd").modal("hide"),$("#tourguideAdd").one("hidden.bs.modal",function(){null!==b.callback&&b.callback(new tourguideModel(a))}),b.hideElements(0)},error:function(a,c,d){showError("Error when creating the tourguide",a,c,d),b.hideElements(0)}})}},b.loadLocales=function(){$.getJSON(serviceRootURL+"/common_options",{key:"locales"}).pipe(function(a){var c=$.map(a,function(a){return new optionModel(a)});b.Locales(c)}).fail(function(a,b,c){showError("Fehler beim Laden der Locales",a,b,c)})},b.loadLocales(),b.resetFields=function(){b.id(null),b.username(""),b.firstname(""),b.lastname(""),b.password(""),b.email(""),b.phone(""),b.hideElements(0)}};ko.components.register("tourguide-add",{viewModel:{createViewModel:function(a,b){return tourguideAddVM=new TourguideAddViewModel(a),window.__tourguideAddVM=tourguideAddVM,tourguideAddVM}},template:{fromUrl:"assets/templates/tourguide-add.html",maxCacheAge:1234}});var TrainConnectionViewModel=function(a){var b=this,c=null;b.selectedClass=a.selectedClass?a.selectedClass:ko.observable(),b.personList=a.personList?a.personList:ko.observableArray(),b.direction=a.direction?a.direction:"simple",b.loadingState=a.loadingState?a.loadingState:ko.observable(),b.selectedTrain=a.selectedTrain,b.selectedContractor=a.selectedContractor?a.selectedContractor:ko.observable(),b.selectedDate=a.selectedDate?a.selectedDate:ko.observable(),b.selectedTime=a.selectedTime?a.selectedTime:ko.observable(),b.selectedType=a.selectedType?a.selectedType:ko.observable(),b.reservingTrain=a.reservingTrain?a.reservingTrain:ko.observable(!1),b.selectedOutwardTrain=a.selectedOutwardTrain?a.selectedOutwardTrain:null,b.loadingTrains=ko.observable(),b.trainStatus=ko.observable(),b.trainReservationStatus=ko.observable(),b.availableConnections=ko.observableArray(),b.disposeManuallyList=[],b.availableConnectionParts=ko.observableArray();var d=function(a,b,d,e,f,g){console.log(""+b,a,d);var h=$.ajax({url:a,type:b,data:d,dataType:"json",contentType:"application/json",beforeSend:function(){1==g&&null!=c&&c.abort()},success:function(c,d,f){console.log("Response "+b+" "+a+" "+d,c),e(c)},error:function(c,d,e){console.log("Response "+b+" "+a+" failed:"+e+": "+c.responseText),0!=g&&"abort"==d||f(c,d,e)},complete:function(){g&&(c=null)}});g&&(c=h)};b.selectTrain=function(a){b.availableConnectionParts([]),b.availableConnections().forEach(function(c){c.trainId()!=a?(c.trainSelected(!1),c.reservationId(void 0)):(c.trainSelected(!0),b.selectedTrain(c))}),b.selectedTrain()&&(b.getReservationPrice(b.selectedTrain()),b.availableConnectionParts.push(b.selectedTrain()),b.selectedTrain().connectingTrains().forEach(function(a){b.availableConnectionParts.push(a)}))},b.getReservationPrice=function(c){c.connectingTrains().forEach(function(a){b.getReservationPrice(a)});var e={categoryKey:a.selectedCategory().key().toUpperCase(),contractorKey:a.selectedContractor().additionalInfo().contractorKey,fromKey:c.stationFromCode(),toKey:c.stationToCode(),dateString:a.selectedDate(),tripTypeKey:a.selectedType().tripTypeKey(),classKey:a.selectedType().classKey(),trainNumber:c.trainNumber(),departureTime:c.departureTime(),arrivalTime:c.arrivalDateTime(),trainType:c.trainType(),fromName:c.stationFrom(),toName:c.stationTo(),daytripId:a.selectedContractor().id()
},f=serviceRootURL+"/reservationprice";"E"==e.classKey&&a.selectedContractor().additionalInfo().contractorKey!=CONTRACTOR_KEY_GOLDENPASS_EXPRESS_PRESTIGE||d(f,"GET",e,function(a){a.length>0?c.seatReservationPrice(a[0]):console.warn("No seat reservation price found for selected route")},function(a,b,c){"no prices returned: reservation not allowed that far in the future"!=a.responseText&&(checkSession(a),showError("Error loading prices",a,b,c))},!1)},b.getConnections=function(){var c={daytripId:a.selectedContractor().id(),stationFrom:a.selectedFrom(),stationTo:a.selectedTo(),date:a.selectedDate(),time:a.selectedTime,count:a.selectedNrOfPersons(),wagonClass:a.selectedType().tripTypeKey()+"."+a.selectedType().classKey()},e=serviceRootURL+"/railway_seat_reservation/trains";b.trainStatus(i18n.t("trainReservation.loadingConnections")),b.availableConnections([]),b.loadingState(!0),b.loadingTrains(!0),d(e,"GET",c,function(a){if(b.trainStatus(void 0),a.hasOwnProperty("message")&&null!=a.message.outward){if(a.message.outward.forEach(function(a){var c=null;a.forEach(function(a){var d=new TrainInformationModel(a);null==c?(b.availableConnections.push(d),c=d):c.connectingTrains.push(d)})}),1==b.availableConnections().length){var c=b.availableConnections()[0];c.isDeparted()||b.selectTrain(c.trainId())}}else b.trainStatus(i18n.t("trainReservation.noTrainsAvailable"));b.loadingState(!1),b.loadingTrains(!1)},function(a,c,d){b.loadingState(!1),b.loadingTrains(!1)},!0)};var e=function(){b.availableConnections([]),b.availableConnectionParts([]),b.selectedTrain(null),b.getConnections()};b.disposeManuallyList.push(a.resetFlag.subscribe(function(a){a&&b.selectedTrain()&&b.selectedTrain().selectedSeats([])})),b.disposeManuallyList.push(a.selectedDate.subscribe(function(a){e()})),e(),TrainConnectionViewModel.prototype.dispose=function(){console.log("TrainConnectionViewModel disposed"),b.disposeManuallyList.forEach(function(a){a.dispose()})}};ko.components.register("train-connection",{viewModel:{createViewModel:function(a,b){return new TrainConnectionViewModel(a)}},template:{fromUrl:"assets/templates/train-connection.html",maxCacheAge:1234}});var TrainInformationViewModel=function(a){var b=this;b.dependingOutwardTrain=a.dependingOutwardTrain?a.dependingOutwardTrain:null,b.trainModel=ko.observable(),b.travelTime=ko.pureComputed(function(){if(b.trainModel()){if(b.trainModel().hasArrived())return i18n.t("trainReservation.trainArrivedAtDestination");if(b.trainModel().isDeparted())return i18n.t("trainReservation.trainAlreadyLeft");var a=moment(b.trainModel().departureTime(),"yyyy-MM-DDThh:mm"),c=moment(b.getLastConnection().arrivalDateTime(),"yyyy-MM-DDThh:mm"),d=moment.duration(c.diff(a));return(d.hours()<10?"0"+d.hours():d.hours())+"h "+(d.minutes()<10?"0"+d.minutes():d.minutes())+"m"}return""});var c=function(){if(b.trainModel()){var c=a.selectedClass();if(null!=c&&b.trainModel().classAvailability()){var d=b.trainModel().classAvailability()[c];return null==d&&"excellence"==c&&(d=b.trainModel().classAvailability().first),d}if(b.trainModel().availableSeats())return b.trainModel().availableSeats()[c]}return null};b.getClassAvailabilityText=function(){var a=c();return null!=a?a.quantity+" "+i18n.t("trainReservation.seatsFree"):0},b.getLastConnection=function(){return 0==b.trainModel().connectingTrains().length?b.trainModel():b.trainModel().connectingTrains()[b.trainModel().connectingTrains().length-1]},b.isSelectable=function(){if(b.trainModel()){if(null!=b.dependingOutwardTrain){if(null!=b.dependingOutwardTrain()){var a=moment(b.dependingOutwardTrain().arrivalDateTime(),"yyyy-MM-DDThh:mm"),c=!b.trainModel().isDeparted()&&b.trainModel().departureIsAfter(a);return c||!0!==b.trainModel().trainSelected()||("rhb"==theme?(showQuestionOkCancel(i18n.t("trainReservation.noValidReturnRouteRhb"),function(a){a&&window.location.reload()}),b.trainModel().trainSelected(!1)):(showQuestionOkCancel(i18n.t("trainReservation.noValidReturnRoute"),function(a){a&&window.location.reload()}),b.trainModel().trainSelected(!1))),c}return!1}return!b.trainModel().isDeparted()}return!1},b.getDestinationName=ko.pureComputed(function(){return b.trainModel()?b.getLastConnection().stationTo():null}),b.getDestinationArrivalTime=ko.pureComputed(function(){return b.trainModel()?moment(b.getLastConnection().arrivalDateTime(),"yyyy-MM-DDThh:mm").format("HH:mm"):null}),b.getConnectingCountText=ko.pureComputed(function(){return b.trainModel()&&b.trainModel().connectingTrains().length>0?b.trainModel().connectingTrains().length+"x umsteigen":null}),b.getClassAvailabilityNumber=function(){var a=c();return null!=a?a.availability:0},b.selectTrain=function(){return 0==b.trainModel().trainSelected()&&a.selectTrain&&b.isSelectable()&&a.selectTrain(b.trainModel().trainId()),!1},b.getTrainIdIfSelected=ko.computed(function(){return b.trainModel()&&b.trainModel().trainSelected()?b.trainModel().trainId():null}),b.getName=function(){if(b.trainModel())return b.trainModel().stationFromCode()+"-"+b.trainModel().stationToCode()+"-"+b.trainModel().departureTime()},void 0!=a&&(b.trainModel(a.data),console.log("TrainInformationViewModel",b.trainModel()))};ko.components.register("train-information",{viewModel:{createViewModel:function(a,b){return new TrainInformationViewModel(a)}},template:{fromUrl:"assets/templates/train-information.html",maxCacheAge:1234}});var TrainReservationViewModel=function(a){var b=this;console.log("TrainReservationViewModel created",a,a.contractor(),a.stationFrom(),a.stationTo(),a.selectedDate(),a.count(),a.selectedType(),a.tripId()),b.selectedCategory=a.selectedCategory,b.selectedContractor=a.contractor,b.selectedFrom=a.stationFrom,b.selectedTo=a.stationTo,b.selectedVia=a.selectedVia,b.selectedDate=a.selectedDate,b.selectedTime=a.selectedTime,b.selectedType=a.selectedType,b.selectedNrOfPersons=a.count,b.selectedTripId=a.tripId,b.selectedDaytripId=b.selectedContractor().id(),b.disposeManuallyList=[],b.personList=ko.observableArray(),b.seatReservationText=ko.observable(),b.ticketText=ko.observable(),b.availableServices=ko.observableArray(),b.availableConsumers=ko.observableArray(),b.availablePublicTransportationConsumers=ko.observableArray(),b.availableTickets=ko.observableArray(),b.availableTicketsJson=ko.observableArray(),b.loadingTickets=ko.observable(!1),b.reservingTrain=ko.observable(!1),b.trainStatus=ko.observable(),b.trainReservationStatus=ko.observable(),b.selectedOutwardTrain=ko.observable(),b.selectedReturnTrain=ko.observable(),b.presaleDeadlineExceeded=ko.observable(!1),b.trainClass=ko.observable(),b.loadingStateSimple=ko.observable(!1),b.loadingStateRetour=ko.observable(void 0),b.resetFlag=a.resetFlag,b.publicTransportationRequest=null,b.retourEnabled=ko.computed(function(){return!!b.selectedType()&&"T"==b.selectedType().tripTypeKey()}),b.selectedClass=ko.computed(function(){if(a.selectedType()){if("E"==a.selectedType().classKey())return"excellence";if("1"==a.selectedType().classKey())return"first";if("2"==a.selectedType().classKey())return"second"}return null}),b.tripTypeText=ko.computed(function(){var c="";return a.selectedType()&&(b.selectedVia()&&(c+=" via "+b.selectedVia()),c+=", "+a.selectedType().tripTypeName(),1==a.selectedType().additionalInfo().isPrestigeClass&&"E"==a.selectedType().classKey()?c+=", "+i18n.t("trainReservation.prestigeClass"):"E"==a.selectedType().classKey()&&(c+=", "+i18n.t("trainReservation.excellenceClass")),"1"==a.selectedType().classKey()&&(c+=", "+i18n.t("trainReservation.firstClass")),"2"==a.selectedType().classKey()&&(c+=", "+i18n.t("trainReservation.secondClass"))),c}),b.isExcellenceClass=ko.computed(function(){return!!a.selectedType()&&"E"==a.selectedType().classKey()});var c=function(a){var b=0;return a&&a.seatReservationPrice()?(b+=a.seatReservationPrice().price,a.connectingTrains().forEach(function(a){a.seatReservationPrice()&&(b+=a.seatReservationPrice().price)}),b):null};b.totalPrice=ko.computed(function(){var a=0,d=c(b.selectedOutwardTrain()),e=c(b.selectedReturnTrain());return b.personList().forEach(function(c){c.includeRailwayTicket()&&b.availableTickets().forEach(function(b){b.consumer().key()==c.selectedReduction()&&(a+=b.price().price())}),null!=d&&(a+=d),null!=e&&(a+=e)}),b.selectedOutwardTrain()&&b.selectedOutwardTrain().selectedSeats().forEach(function(b){b.services().forEach(function(b){b.selected()&&(a+=b.price)})}),b.selectedReturnTrain()&&b.selectedReturnTrain().selectedSeats().forEach(function(b){b.services().forEach(function(b){b.selected()&&(a+=b.price)})}),a});var d=null;b.travelTimeTextOutward=ko.computed(function(){var c="",d=a.selectedDate();b.selectedOutwardTrain()&&(d=b.selectedOutwardTrain().departureTime());var e=i18n.t("trainReservation.departureOn");b.retourEnabled()&&(e=i18n.t("trainReservation.outwardJourneyOn"));var d=moment(d),f=d.format("L"),g=d.format("HH:mm");if("00:00"!=g){c=e+" "+f+" "+i18n.t("trainReservation.departureAt")+" "+g}else c=e+" "+f;return b.selectedOutwardTrain()&&b.selectedOutwardTrain().reservationId()&&(c=c+" ("+i18n.t("trainReservation.reserved")+")"),c}),b.travelTimeTextReturn=ko.computed(function(){var c="",d=a.selectedDate();b.selectedReturnTrain()&&(d=b.selectedReturnTrain().departureTime());var e=i18n.t("trainReservation.returnJourneyOn"),d=moment(d),f=d.format("L"),g=d.format("HH:mm");if("00:00"!=g){c=e+" "+f+" "+i18n.t("trainReservation.departureAt")+" "+g}else c=e+" "+f;return b.selectedReturnTrain()&&b.selectedReturnTrain().reservationId()&&(c=c+" ("+i18n.t("trainReservation.reserved")+")"),c}),b.reservationSummaryText=ko.computed(function(){var a=b.personList().length,d=c(b.selectedOutwardTrain()),e=c(b.selectedReturnTrain()),f=0,h=0;null!=d&&(f+=d,h+=a),null!=e&&(f+=e,h+=a);var i=0,j=0,k=0,l=0;b.personList().forEach(function(a){a.includeRailwayTicket()&&b.availableTicketsJson().forEach(function(b){g(b.consumerKey,a.selectedReduction())&&(k++,i+=b.price)})}),b.selectedOutwardTrain()&&b.selectedOutwardTrain().selectedSeats().forEach(function(a){a.services().forEach(function(a){a.selected()&&(l++,j+=a.price)})}),b.selectedReturnTrain()&&b.selectedReturnTrain().selectedSeats().forEach(function(a){a.services().forEach(function(a){a.selected()&&(l++,j+=a.price)})});var m=null;if(h>0&&null!=f&&(m=h+"x "+i18n.t("trainReservation.seatReservation")+" ("+f.toFixed(2)+" "+currency()+")"),k>0){null!=i&&(i=i.toFixed(2));var n=k+"x "+i18n.t("trainReservation.railwayTicket")+" ("+i+" "+currency()+")";null!=m?m+=", "+n:m=n}if(l>0){null!=j&&(j=j.toFixed(2));var o=l+"x "+i18n.t("trainReservation.services")+" ("+j+" "+currency()+")";null!=m?m+=", "+o:m=o}return m}),b.trainsReserved=ko.computed(function(){var a=!1,c=!1;return b.selectedOutwardTrain()&&b.selectedOutwardTrain().reservationId()&&(a=!0),b.selectedReturnTrain()&&b.selectedReturnTrain().reservationId()&&(c=!0),b.retourEnabled()?a&&c:a});var e=function(a){var c=b.personList().length,d=!0;return a?(a.selectedSeats().length!=c&&(d=!1),a.connectingTrains().forEach(function(a){a.selectedSeats().length!=c&&(d=!1)})):d=!1,d};b.reserveTrainBtnEnabled=ko.computed(function(){if(b.trainsReserved())return!1;var a=!0;return b.isExcellenceClass()||(b.selectedOutwardTrain()&&void 0==b.selectedOutwardTrain().seatReservationPrice()&&(a=!1),b.retourEnabled()&&b.selectedReturnTrain()&&void 0==b.selectedReturnTrain().seatReservationPrice()&&(a=!1)),e(b.selectedOutwardTrain())||(a=!1),b.retourEnabled()&&(e(b.selectedReturnTrain())||(a=!1)),a}),b.addToCartEnabled=ko.computed(function(){return!b.loadingTickets()&&!!b.trainsReserved()});var f=function(b,c,d,e){if(!d)return null;var f=new railwaySeatReservationPriceModel(d);return f.id(b.id()),f.categoryKey(CATEGORY_KEY_RAILWAY_SEAT_RESERVATION),f.reservationId(c),f.firstName(b.firstName()),f.lastName(b.lastName()),f.dateOfBirth(b.dateOfBirth()),f.supportsQuantity(!1),f.seatNumber(e.seatNumber()),f.seatId(e.seatId()),f.classKey(a.selectedType().classKey()),f.className(a.selectedType().className()),f},g=function(a,b){if(!b||!a)return!1;var c=b.split(".");return a==b||c.length>1&&"660"!=c[0]&&a==c[1]},h=function(a,c){if(a.includeRailwayTicket())for(var d=0;d<b.availableTicketsJson().length;d++){var e=b.availableTicketsJson()[d],f=["600.ga","600.daycard-hf","600.community-daycard","600.daycard-child","600.familycard","600.travelpass","600.stp","600.transfer-special","600.eurrail","600.daycard","600.travelpass-flexi","600.interrailpass","600.no-ticket"],g=a.selectedReduction().split("."),h=null;if(2===g.length&&(h=g[1]),(e.consumerKey===a.selectedReduction()||null!=h&&e.consumerKey===h)&&!f.includes(e.consumerKey)){var i=b.createTicketFromJson(e,b.selectedContractor().additionalInfo().railwayTicketCategoryType);return i.price().reservationId(c),i.price().firstName(a.firstName()),i.price().lastName(a.lastName()),i.price().dateOfBirth(a.dateOfBirth()),i.price().supportsQuantity(!1),i.price().id(a.id()),i.price().personalizationId(a.id()),i}}return null},i=function(b,c,d,e){var f=k(c),g={id:c.id,productId:c.productId,price:c.price,categoryKey:CATEGORY_KEY_CATERING,productName:c.label,date:a.selectedDate(),sku:null!=f?f.key():null,productKey:null!=f?f.key():null,seatNumber:e.seatNumber(),seatId:e.seatId(),personalizationId:b.id()},h=new cateringPriceModel(g,null);return h.reservationId(d),h.firstName(b.firstName()),h.lastName(b.lastName()),h.dateOfBirth(b.dateOfBirth()),h.supportsQuantity(!1),h},j=function(a,c){var d=null;if(a&&(d=a.reservationId()),!d||null==d)return void console.log("Cannot add to cart without reservation ID",a);console.log("Adding to cart",d,a),shoppingcartVM.removeEntriesWithReservationId(d),a.selectedSeats().forEach(function(e){var g=e.assignedPerson(),j=h(g,d),k=moment.duration(moment().diff(moment(g.dateOfBirth()))).asYears();if(null!=j&&null!=j.consumer()&&null!=j.consumer().optionValue()&&("600.juniorcard"==j.consumer().optionValue()&&k>=16||"600.half-fare"==j.consumer().optionValue()&&k<16))throw console.log("Cannot add to cart, birthdate and ticket type don't fit",j),showError("Error putting ticket in cart: Please check birth dates and ticket types"),new Error("Error putting ticket in cart");var l=f(g,d,a.seatReservationPrice(),e),m=null;null!=l&&(console.log("Adding seat reservation",l),m=shoppingcartVM.addEntry(l,null,c,null,!0)),null!=j&&("600.juniorcard"!=j.consumer().optionValue()||j.price()>0)&&(console.log("Adding ticket",j),shoppingcartVM.addEntry(j.price(),null,b.selectedContractor().additionalInfo().railwayTicketCategoryType,m,!0)),e.services().forEach(function(a){if(a.selected()){var b=i(g,a,d,e);console.log("Adding service",b,g),shoppingcartVM.addEntry(b,null,CATEGORY_KEY_CATERING,m,!0)}})}),a.connectingTrains().forEach(function(a){a.selectedSeats().forEach(function(b){var e=b.assignedPerson(),g=f(e,d,a.seatReservationPrice(),b),h=null;null!=g&&(console.log("Adding seat reservation",g,a.seatReservationPrice()),h=shoppingcartVM.addEntry(g,null,c,null,!0)),b.services().forEach(function(a){if(a.selected()){var c=i(e,a,d,b);console.log("Adding service",c,e),shoppingcartVM.addEntry(c,null,CATEGORY_KEY_CATERING,h,!0)}})})})};b.validateAgeAndTicket=function(){var a=!0;return b.personList().forEach(function(b){var c=moment.duration(moment().diff(moment(b.dateOfBirth()))).asYears();("600.juniorcard"==b.selectedReduction()||"600.kid"==b.selectedReduction()||"600.child"==b.selectedReduction())&&c>=16&&b.includeRailwayTicket()&&(a=!1)}),a||showWarning(i18n.t("trainReservation.birthdateAndTicketTypeMismatch")),a},b.addToCart=function(a,c){var d=$("#personalisationForm").parsley().validate();return!!d&&(!!(d=b.validateAgeAndTicket())&&(b.selectedOutwardTrain()&&j(b.selectedOutwardTrain(),a.selectedCategory().key().toUpperCase()),b.retourEnabled()&&j(b.selectedReturnTrain(),a.selectedCategory().key().toUpperCase()),void $("#trainReservationAddToCartBtn").blur()))};var k=function(a){for(var c=0;c<b.availableServices().length;c++){var d=b.availableServices()[c],e=d.key().split(".");if(e[e.length-1]==a.id)return d}return console.error("No service product found for service: "+a.label+" with ID: "+a.id+". Check imported services and category assignment!"),showInfo("No service product found for service: "+a.label),null};b.loadingState=ko.computed(function(){var c=b.loadingStateSimple()||void 0!=b.loadingStateRetour()&&1==b.loadingStateRetour();return a.loadingState(c),c});var l=function(a,b,c,e,f,g){console.log(""+b,a,c);var h=$.ajax({url:a,type:b,data:c,dataType:"json",contentType:"application/json",beforeSend:function(){1==g&&null!=d&&d.abort()},success:function(c,d,f){console.log("Response "+b+" "+a+" "+d,c),e(c)},error:function(c,d,e){console.log("Response "+b+" "+a+" failed:"+e+": "+c.responseText),0!=g&&"abort"==d||f(c,d,e)},complete:function(){g&&(d=null)}});return g&&(d=h),h};b.getSbbTicketPrice=function(){if(!b.railwayTicketDeadlineExceeded()){a.contractor().additionalInfo().contractorKey;b.availableTickets([]),b.availableTicketsJson([]);var c=b.isExcellenceClass()?"1":a.selectedType().classKey(),d={categoryKey:b.selectedCategory().key().toUpperCase(),contractorKey:a.contractor().additionalInfo().contractorKey,fromKey:a.stationFrom(),toKey:a.stationTo(),viaKey:b.selectedVia(),dateString:a.selectedDate(),tripTypeKey:a.selectedType().tripTypeKey(),classKey:c,includeAddons:!1,daytripId:b.selectedDaytripId,tripId:a.tripId()},e=serviceRootURL+"/publictransportationprices";b.loadingTickets(!0),null!=b.publicTransportationPricesRequest&&b.publicTransportationPricesRequest.abort(),b.publicTransportationPricesRequest=l(e,"GET",d,function(a){b.loadingTickets(!1),b.availableTickets([]),b.availableTicketsJson([]),a.forEach(function(a){var c=b.createTicketFromJson(a,CATEGORY_KEY_PUBLICTRANSPORTATION);null!=c&&(b.availableTickets.push(c),b.availableTicketsJson.push(a))}),b.publicTransportationPricesRequest=null},function(a,c,d){"abort"!=c&&(b.publicTransportationPricesRequest=null,b.loadingTickets(!1),checkSession(a),showError("Error loading ticket prices",a,c,d))},!1)}},b.createTicketFromJson=function(a,c){a.categoryKey=c;var d=null;d=c==CATEGORY_KEY_PUBLICTRANSPORTATION?new publicTransportationPriceModel(a):new bergbahnPriceModel(a);var e=null;if(null!=(e=a.contractorKey==CONTRACTOR_KEY_GOPEX||a.contractorKey==CONTRACTOR_KEY_GOLDENPASS||a.contractorKey==CONTRACTOR_KEY_GOLDENPASS_EXPRESS||a.contractorKey==CONTRACTOR_KEY_GOLDENPASS_EXPRESS_PRESTIGE?ko.utils.arrayFirst(b.availablePublicTransportationConsumers(),function(a){return a.key()===d.consumerKey()}):ko.utils.arrayFirst(b.availableConsumers(),function(a){return g(d.consumerKey(),a.key())}))){var f=new ticketModelBergbahn(e,c);return f.price(d),f}return null},b.getAvailableConsumers=function(){var c={categoryKey:b.selectedCategory().key().toUpperCase(),optionListKey:"railwayConsumer",parentOptionListKey:"contractors",parentOptionKey:a.contractor().key()},d=serviceRootURL+"/options";b.availableConsumers([]),l(d,"GET",c,function(a){a.forEach(function(a){if(-1==a.key.indexOf("660.")){var c=new consumerOptionModel(a);b.availableConsumers.push(c)}}),b.selectedContractor().additionalInfo().railwayTicketCategoryType==CATEGORY_KEY_BERGBAHN&&m()},function(a,b,c){checkSession(a),showError("Error loading contractors",a,b,c)},!1)};var m=function(){b.availableTickets([]),b.availableTicketsJson([]);var a=serviceRootURL+"/daytripsprice";b.availableConsumers().forEach(function(c){var d={productKey:b.selectedContractor().additionalInfo().sku,dateString:b.selectedDate(),consumerKey:c.key(),selectableItems:[],tripTypeKey:b.selectedType().tripTypeKey(),selectedAddonIds:null},e={categoryKey:CATEGORY_KEY_BERGBAHN,fromKey:b.selectedFrom(),toKey:b.selectedTo(),viaKey:b.selectedFrom()+" - "+b.selectedTo(),classKey:b.selectedType().classKey(),tripTypeKey:b.selectedType().tripTypeKey(),consumerKey:c.key(),dateString:b.selectedDate(),isAddOn:!0};d.selectableItems.push(e),$.ajax(a,{type:"POST",data:JSON.stringify(d),dataType:"json",contentType:"application/json",success:function(a,c,d){if(console.log("bergbahn price from daytrip",a),null!=a.price&&null!=a.bundleItems)for(var e=0;e<a.bundleItems.length;e++)if(a.bundleItems[e].categoryKey==CATEGORY_KEY_BERGBAHN){var f=a.bundleItems[e],g=b.createTicketFromJson(f,CATEGORY_KEY_BERGBAHN);null!=g&&(b.availableTickets.push(g),b.availableTicketsJson.push(f))}},error:function(a,b,c){500==a.status&&(console.log("Error during retrieving bundle price"),showError("Fehler bei Preisermittlung",a,b,c,!0)),checkSession(a)}})})};b.getAvailablePublicTransportationConsumers=function(){var c={categoryKey:"PUBLICTRANSPORTATION",optionListKey:"consumer",parentOptionKey:a.contractor().key()},d=serviceRootURL+"/options";b.availablePublicTransportationConsumers([]),l(d,"GET",c,function(a){a.forEach(function(a){-1==a.key.indexOf("660.")&&b.availablePublicTransportationConsumers.push(new consumerOptionModel(a))})},function(a,b,c){checkSession(a),showError("Error loading public transportation consumers",a,b,c)},!1)},b.getAvailableServices=function(){var c={categoryKey:b.selectedCategory().key().toUpperCase(),optionListKey:"catering",parentOptionListKey:"contractors",parentOptionKey:a.contractor().key(),recursive:!1,sort:!0},d=serviceRootURL+"/options";b.availableServices([]),l(d,"GET",c,function(a){a.forEach(function(a){b.availableServices.push(new railwaySeatReservationCateringOptionViewModel(a))})},function(a,b,c){checkSession(a),showError("Error loading services",a,b,c)},!1)},b.postReserveTrain=function(a,c){var d=serviceRootURL+"/railway_seat_reservation/reserve";b.reservingTrain(!0),b.trainReservationStatus(i18n.t("trainReservation.reservingTrain")),$("#reserveTrainBtn").attr("disabled",!0),l(d,"POST",JSON.stringify(a),function(a){c.reservationId(a.reservationId),c.connectingTrains().forEach(function(b){b.reservationId(a.reservationId)}),b.trainReservationStatus(i18n.t("trainReservation.trainReserved")),b.reservingTrain(!1),setTimeout(function(){b.trainReservationStatus(void 0)},3e3)},function(a,c,d){checkSession(a),showError("Train reservation failed",a,c,d),b.trainReservationStatus(void 0),b.reservingTrain(!1),$("#reserveTrainBtn").attr("disabled",!1)},!1)},b.reserveTrains=function(){b.selectedOutwardTrain()&&b.createTrainReservation(b.selectedOutwardTrain()),b.selectedReturnTrain()&&b.createTrainReservation(b.selectedReturnTrain())};var n=function(a){var b=new TrainModel;b.from=a.stationFromCode(),b.to=a.stationToCode(),b.departureTime=a.departureTime(),b.arrivalDateTime=a.arrivalDateTime();var c={};return a.selectedSeats().forEach(function(a){var b=new SeatModel;b.id(a.seatId()),b.seatNumber(a.seatNumber()),a.services().forEach(function(a){a.selected()&&b.services.push(a.id)}),c.hasOwnProperty(a.wagonId())||(c[a.wagonId()]={}),c[a.wagonId()][b.id()]=b}),b.seats(c),b};b.createTrainReservation=function(c){var d=new TrainReservationModel;d.daytripId=a.contractor().id(),d.from=c.stationFromCode(),d.to=c.stationToCode(),d.fromName=c.stationFrom(),d.toName=c.stationTo(),d.class=a.selectedType().classKey(),d.contractorKey=a.contractor().additionalInfo().contractorKey;var e={};e[c.trainNumber()]=n(c),c.connectingTrains().forEach(function(a){e[a.trainNumber()]=n(a)}),d.trains(e),d.personalisations(b.personList());var f={};f.message=ko.toJS(d),b.postReserveTrain(f,c)},b.disposeManuallyList.push(a.count.subscribe(function(a){var c=b.personList().length;if(c<a)for(var d=0;d<a-c;d++){var e=new TrainTicketPersonalizationModel;b.personList.push(e),e.id(b.personList().length)}else b.personList.splice(a,c-a);b.selectedOutwardTrain()&&b.selectedOutwardTrain().reservationId()&&o(),$("#personalisationForm").parsley().reset()})),b.isSbbContractor=ko.pureComputed(function(){return b.selectedContractor().additionalInfo().railwayTicketCategoryType==CATEGORY_KEY_PUBLICTRANSPORTATION}),b.railwayTicketDeadlineExceeded=ko.computed(function(){if(!b.isSbbContractor())return!1;var c=moment().add(2,"M");return!!moment(a.selectedDate()).isAfter(c)}),b.resetReservationAndPersons=function(){b.personList([]);for(var c=0;c<a.count();c++){var d=new TrainTicketPersonalizationModel(c);b.personList.push(d)}},b.reset=function(){if(b.selectedOutwardTrain()&&b.selectedOutwardTrain().reservationId(void 0),b.selectedReturnTrain()&&b.selectedReturnTrain().reservationId(void 0),b.availableTickets([]),headerVM.gexPresalePeriod()&&headerVM.gexPresalePeriod()>0){var c=moment(a.selectedDate()),d=moment(),e=c.diff(d,"days")+1;b.presaleDeadlineExceeded(e>headerVM.gexPresalePeriod())}b.resetReservationAndPersons()};var o=function(){b.reset(),b.isSbbContractor()&&b.getSbbTicketPrice()};a&&(!function(){b.personList([]);for(var c=0;c<a.count();c++){var d=new TrainTicketPersonalizationModel(c);b.personList.push(d)}b.getAvailableConsumers(),b.getAvailablePublicTransportationConsumers(),b.getAvailableServices()}(),o()),b.disposeManuallyList.push(a.resetFlag.subscribe(function(a){a&&b.reset()})),b.disposeManuallyList.push(a.selectedDate.subscribe(function(a){b.isSbbContractor()?b.getSbbTicketPrice():m()})),TrainReservationViewModel.prototype.dispose=function(){console.log("TrainReservationViewModel disposed"),b.disposeManuallyList.forEach(function(a){a.dispose()})}};ko.components.register("train-reservation",{viewModel:{createViewModel:function(a,b){return new TrainReservationViewModel(a)}},template:{fromUrl:"assets/templates/train-reservation.html",maxCacheAge:1234}});var TrainSeatSelectionViewModel=function(a){function b(a,b){return null!=a.logicalSequence&&null!=b.logicalSequence?a.logicalSequence<b.logicalSequence?-1:a.logicalSequence>b.logicalSequence?1:0:-1}var c=this;c.personList=ko.observableArray(),c.classInfo=ko.observable(),c.disposeManuallyList=[],c.selectedTrain=ko.observable(),c.selectedWagon=ko.observable(),c.loadingState=ko.observable(),c.selectedClass=ko.observable(),c.loadingSeatReservation=ko.observable(!1),c.seatReservationStatus=ko.observable(),c.isCollapsed=ko.observable(!1),c.reservingTrain=ko.observable(!1),c.contractor=ko.observable(),a&&(console.log("TrainSeatSelectionViewModel",a,c),c.selectedTrain(a.selectedTrain),c.personList=a.personList,c.loadingState=a.loadingState,c.nrOfSelectedSeats=a.nrOfSelectedSeats,c.selectedClass=a.selectedClass,c.reservingTrain=a.reservingTrain,c.contractor=a.selectedContractor),c.toggleExpand=function(){c.isCollapsed(!c.isCollapsed())};var d=null,e=function(a,b,c,e,f,g){console.log(""+b,a,c);var h=$.ajax({url:a,type:b,data:c,dataType:"json",contentType:"application/json",beforeSend:function(){1==g&&null!=d&&d.abort()},success:function(c,d,f){console.log("Response "+b+" "+a+" "+d,c),e(c)},error:function(c,d,e){console.log("Response "+b+" "+a+" failed:"+e+": "+c.responseText),0!=g&&"abort"==d||f(c,d,e)},complete:function(){g&&(d=null)}});g&&(d=h)};c.nrOfSelectedSeats=ko.computed(function(){var a=0;return c.selectedTrain()&&c.selectedTrain().seatsPerWagon()&&Object.keys(c.selectedTrain().seatsPerWagon()).forEach(function(b){c.selectedTrain().seatsPerWagon()[b].forEach(function(b){b.selected()&&a++})}),a}),c.maxSelection=ko.computed(function(){return a.personList?a.personList().length:0}),c.seatList=ko.computed(function(){if(c.selectedTrain()){if(!c.selectedTrain().seatsPerWagon()||!c.selectedWagon())return[];if(c.selectedTrain().seatsPerWagon().hasOwnProperty(c.selectedWagon().wagonId))return c.selectedTrain().seatsPerWagon()[c.selectedWagon().wagonId]}return[]}),c.usedSeats=ko.computed(function(){var a=0,b=0,d=0,e=0;return c.seatList().forEach(function(c){a++,c.booked()&&b++,c.selected()&&d++,c.wrongClass()&&e++}),{total:a,booked:b,selected:d,free:a-b,wrongClass:e}}),c.getSelectionInfo=ko.computed(function(){var a=c.nrOfSelectedSeats(),b=c.usedSeats();if(0==b.free)return i18n.t("trainReservation.noFreeSeats");if(c.trainReserved())return a+" "+i18n.t("trainReservation.seatsReserved");var d=b.total-b.selected-b.booked,e=a+" "+i18n.t("trainReservation.of")+" "+c.maxSelection()+" "+i18n.t("trainReservation.seatsSelected");return null!=d&&(e+=" ("+d+" von "+(b.total-b.wrongClass)+" "+i18n.t("trainReservation.seatsFree")+")"),e}),c.wrongClassText=ko.computed(function(){var b="";return a.selectedType()&&(b+=", "+a.selectedType().tripTypeName(),1==a.selectedType().additionalInfo().isPrestigeClass&&"E"==a.selectedType().classKey()?b+=", "+i18n.t("trainReservation.prestigeClass"):"E"==a.selectedType().classKey()&&(b+=", "+i18n.t("trainReservation.excellenceClass")),"1"==a.selectedType().classKey()&&(b+=", "+i18n.t("trainReservation.firstClass")),"2"==a.selectedType().classKey()&&(b+=", "+i18n.t("trainReservation.secondClass"))),b}),c.trainReserved=ko.computed(function(){return c.selectedTrain()&&c.selectedTrain().reservationId()||c.reservingTrain()}),c.isTrain=ko.computed(function(){if(c.selectedTrain())for(var a=0;a<c.selectedTrain().segments().length;a++){var b=c.selectedTrain().segments()[a];if("Autobus"==b.wagonTypeName)return!1}return!0}),c.checkWagonClass=function(a){return console.log("checkWagonClass - Wagon class: "+a.class+" - Selected class: "+c.selectedClass()+" - Excellence type: "+c.isExcellenceType(a),a),!c.trainReserved()&&("Autobus"==a.wagonTypeName||("Prestige"==a.wagonTypeName?"excellence"==c.selectedClass()||a.class==c.selectedClass():c.isExcellenceType(a)?"excellence"==c.selectedClass():c.selectedClass()==a.class||null==a.class||"mixed"==a.class))},c.getWagonButtonText=function(a,b){return i18n.t("trainReservation.wagon")+" "+a.displayName},c.isWagonSelected=function(a){return!!c.selectedWagon()&&c.selectedWagon().wagonId==a.wagonId},c.getCollapseTargetId=function(){if(c.selectedTrain())return"train"+c.selectedTrain().trainNumber()},c.selectWagon=function(a){c.selectedWagon()&&a.wagonId==c.selectedWagon().wagonId||c.selectedWagon(a)},c.getTravelingDirection=function(){if(c.selectedTrain().segments().length>0&&c.selectedTrain().segments()[0].travelingDirection){var a=c.selectedTrain().segments()[0].travelingDirection;if("U"===a.code)return null;if("L"===a.code)return"left";if("R"===a.code)return"right"}return null},c.showDefaultWagonSelection=ko.computed(function(){return!0}),c.computeWagonClassText=ko.computed(function(){var a="";if(c.selectedWagon()){var b=c.selectedWagon().wagonTypeName,d=c.selectedWagon().class;"first"==d?a=i18n.t("trainReservation.firstClass"):"second"==d?a=i18n.t("trainReservation.secondClass"):"mixed"==d&&(a=i18n.t("trainReservation.mixedClass")),null!=b&&(a+=" "+b)}c.classInfo(a)}),c.getWagonText=function(a){return"Wagon "+a.id};var f=function(a){for(var b=0;b<c.personList().length;b++){var d=c.personList()[b];null==c.selectedTrain().getSeatForPerson(d)&&a.assignedPerson(d)}};c.selectSeat=function(a,b){if(c.trainReserved())return!1;if(void 0!=a.seatId()&&!a.booked()){var d=c.nrOfSelectedSeats();if(1==a.selected())a.selected(!1),a.assignedPerson(void 0),c.selectedTrain().removeSelectedSeat(a);else{if(d>=c.maxSelection()){for(var e=null,g=0;g<c.selectedTrain().selectedSeats().length;g++){var h=c.selectedTrain().selectedSeats()[g];if(h.seatId()!=a.seatId()||h.wagonId()!=a.wagonId()){e=h,h.selected(!1),h.assignedPerson(void 0);break}}c.selectedTrain().removeSelectedSeat(e)}a.selected(!0),c.selectedTrain().selectedSeats.push(a),f(a)}}};var g=function(){for(var a=0;a<c.selectedTrain().segments().length;a++){var b=c.selectedTrain().segments()[a];if(c.checkWagonClass(b))return void c.selectWagon(b)}},h=function(a){a&&(a.seatsPerWagon(void 0),a.selectedSeats().forEach(function(a){a.assignedPerson(void 0),a.selected(!1)}))},i=function(a,b,c){var d=c[a],e=[];return d&&d.forEach(function(a){b.forEach(function(b){if(b.id==a){var c=b;if(c){var d={id:c.id,label:c.label,price:c.price,value:c.value,productId:c.productId,selected:ko.observable(!1),required:ko.observable(!1)};"Zuschlag Excellence Class"!=d.label&&"Prestige Individuel"!=d.label||(d.selected(!0),d.required(!0)),e.push(d)}}})}),e};c.parseSeatsAndServices=function(a){for(var b=new DOMParser,d=b.parseFromString(a.seatLayout,"image/svg+xml"),e=d.getElementsByTagName("svg"),f=[],g=0;g<e.length;g++){var h=e[g];if(h.id&&""!==h.id){
var j=-1!==h.className.baseVal.indexOf("window"),k=-1!==h.className.baseVal.indexOf("chair_left"),l=-1!==h.className.baseVal.indexOf("booked"),m=h.y.baseVal.value,n=h.getAttribute("data-seat-number"),o=[];a.services&&(o=i(h.id,a.services.options,a.services.seatMap));var p={x:h.x.baseVal.value,y:m,seatId:h.id,seatNumber:n,wagonId:a.wagonNumber,seatType:j?"Window":"Aisle",directionForward:!k,services:o,wrongClass:l,booked:l};f.push(new TrainSeatViewModel(p))}}return c.setOccupiedSeats(f,a.occupiedSeats),f},c.getAvailableSeatsForWagon=function(b,d){var f={daytripId:a.selectedContractor().id(),stationFrom:c.selectedTrain().stationFrom(),stationTo:c.selectedTrain().stationTo(),date:a.selectedDate(),wagonId:b.wagonId,wagonType:b.wagonType,trainNo:c.selectedTrain().trainNumber(),excellenceClass:"E"==a.selectedType().tripTypeKey(),wagonClass:c.selectedClass(),departureDateTime:c.selectedTrain().departureTime(),arrivalDateTime:c.selectedTrain().arrivalDateTime()},g=serviceRootURL+"/railway_seat_reservation/sections";c.loadingSeatReservation(!0),c.loadingState(!0),c.seatReservationStatus(i18n.t("trainReservation.loadingSeatLayout")),e(g,"GET",f,function(a){if(a.hasOwnProperty("message")){var e=c.parseSeatsAndServices(a.message),f=d.seatsPerWagon();f||(f={}),f[b.wagonId]=e,d.seatsPerWagon(f)}c.loadingState(!1),c.loadingSeatReservation(!1),c.seatReservationStatus(void 0)},function(a,b,d){c.loadingState(!1),c.loadingSeatReservation(!1),c.seatReservationStatus(void 0),checkSession(a),showError("Error loading seats",a,b,d)},!1)},c.isExcellenceType=function(a){return a.hasOwnProperty("excellenceType")&&!0===a.excellenceType},c.getSeatsForTrain=function(a){if(h(a),a){a.segments().sort(b);for(var d=0;d<a.segments().length;d++){var e=a.segments()[d];c.checkWagonClass(e)&&c.getAvailableSeatsForWagon(e,a)}g()}},c.setOccupiedSeats=function(a,b){a.forEach(function(a){b.forEach(function(b){b.seatId==a.seatId()&&a.booked(!0)})})},c.getSeatsForTrain(c.selectedTrain()),TrainSeatSelectionViewModel.prototype.dispose=function(){console.log("TrainSeatSelectionViewModel disposed"),c.disposeManuallyList.forEach(function(a){a.dispose()})}};ko.components.register("train-seat-selection",{viewModel:{createViewModel:function(a,b){return new TrainSeatSelectionViewModel(a)}},template:{fromUrl:"assets/templates/train-seat-selection.html",maxCacheAge:1234}});var TrainSeatViewModel=function(a){var b=this;b.width=ko.observable(25),b.height=ko.observable(25),b.selected=ko.observable(!1),b.booked=ko.observable(!1),b.wrongClass=ko.observable(!1),b.directionForward=ko.observable(!1),b.seatId=ko.observable(),b.seatType=ko.observable(),b.seatNumber=ko.observable(),b.seatLabel=ko.observable(),b.x=ko.observable(0),b.y=ko.observable(0),b.services=ko.observable(),b.wagonId=ko.observable(),b.assignedPerson=ko.observable(),b.getTranslate=ko.computed(function(){return"translate("+b.x()+","+b.y()+")"}),b.seatRestSize=ko.computed(function(){return{x:b.directionForward()?b.width()-7:3,y:3,width:4,height:b.height()-6}}),b.reservedLine1=ko.pureComputed(function(){return{x1:b.directionForward()?3:8,y1:5,x2:b.directionForward()?b.width()-10:b.width()-3,y2:b.height()-4}}),b.reservedLine2=ko.pureComputed(function(){return{x1:b.directionForward()?3:8,y1:b.height()-4,x2:b.directionForward()?b.width()-10:b.width()-3,y2:5}}),a.data?(b.x(Number(a.data.x)),b.y(Number(a.data.y)),b.seatId(a.data.seatId),b.directionForward(a.data.directionForward),b.booked(a.data.booked),b.selected(a.data.selected),b.seatNumber(a.data.seatNumber),b.seatType(a.data.seatType),b.wagonId(a.data.wagonId),b.wrongClass(a.data.wrongClass)):a&&(b.x(a.x),b.y(a.y),b.seatId(a.seatId),b.directionForward(a.directionForward),b.booked(a.booked),b.selected(a.selected),b.seatNumber(a.seatNumber),b.seatType(a.seatType),b.services(a.services),b.wagonId(a.wagonId),b.wrongClass(a.wrongClass))};ko.components.register("train-seat",{viewModel:{createViewModel:function(a,b){return new TrainSeatViewModel(a)}},template:{fromUrl:"assets/templates/train-seat.html",maxCacheAge:1234}});var TrainTicketPersonalisationViewModel=function(a){var b=this;b.personModel=ko.observable(a.data),b.ticketOptionCaption=ko.observable(i18n.t("trainReservation.ticketCaption.selectTicket")),b.trainsReserved=ko.observable(!1),b.railwayTicketDeadlineExceeded,b.selectServiceTitle=ko.observable(i18n.t("trainReservation.selectService")),b.excellenceClass=ko.observable(!1),b.changeServiceTitle=ko.observable(i18n.t("trainReservation.changeServices")),b.seatServicesVisible=ko.observable(!0),b.selectedOutwardTrain=ko.observable(),b.selectedReturnTrain=ko.observable(),b.componentId=ko.observable(),b.loadingTickets=ko.observable(!1),b.reservingTrain=ko.observable(!1),a&&(b.selectedOutwardTrain=a.selectedOutwardTrain,b.selectedReturnTrain=a.selectedReturnTrain,b.componentId(a.componentId()),b.trainsReserved=a.trainsReserved,b.railwayTicketDeadlineExceeded=a.railwayTicketDeadlineExceeded,b.excellenceClass=a.excellenceClass,a.selectedContractor&&"BEX"==a.selectedContractor().additionalInfo().contractorKey&&b.seatServicesVisible(!1),b.loadingTickets=a.loadingTickets,b.reservingTrain=a.reservingTrain,console.log("TrainTicketPersonalisationViewModel",a)),b.seatServices=ko.computed(function(){if(b.selectedOutwardTrain()){var a=b.selectedOutwardTrain().getSeatForPerson(b.personModel());if(null!=a)return 1==a.services().length&&a.services()[0].selected(!0),a.services()}return[]}),b.getTicketText=function(a){return a.localizedValue+" - "+a.price.toFixed(2)+" "+currency()},b.getTravellerText=function(){var a=b.componentId()+1,c=i18n.t("trainReservation.traveller")+" "+a;if(b.selectedOutwardTrain()){var d=b.selectedOutwardTrain().getSeatForPerson(b.personModel());d&&(c+=" - "+i18n.t("trainReservation.seat.number")+" "+d.seatNumber()),b.selectedOutwardTrain().connectingTrains().forEach(function(a){var d=a.getSeatForPerson(b.personModel());d&&(c+=", "+d.seatNumber())})}if(b.selectedReturnTrain()){var e=b.selectedReturnTrain().getSeatForPerson(b.personModel());e&&(c+=" - "+i18n.t("trainReservation.seat.number")+" "+e.seatNumber()),b.selectedReturnTrain().connectingTrains().forEach(function(a){var d=a.getSeatForPerson(b.personModel());d&&(c+=", "+d.seatNumber())})}return c},b.servicesAvailable=ko.computed(function(){if(b.selectedOutwardTrain()){var a=b.selectedOutwardTrain().getSeatForPerson(b.personModel());return null!=a&&a.services().length>1}return!1}),b.reductionOptions=ko.computed(function(){if(b.loadingTickets())return b.ticketOptionCaption(i18n.t("trainReservation.ticketCaption.loadingTickets")),[];b.ticketOptionCaption(void 0);var c=[];return b.railwayTicketDeadlineExceeded()?b.ticketOptionCaption(i18n.t("trainReservation.ticketCaption.noTicketsAvailable")):b.personModel().includeRailwayTicket()?(b.ticketOptionCaption(void 0),a.availableTickets?a.availableTickets().forEach(function(a){c.push({id:a.consumer().key(),localizedValue:a.consumer().value(),price:a.price().price()})}):b.ticketOptionCaption(i18n.t("trainReservation.ticketCaption.noTicketsAvailable"))):b.ticketOptionCaption(i18n.t("trainReservation.ticketCaption.noTicketNeeded")),c=c.sort(function(a,b){return a.price==b.price?0:a.price>b.price?-1:1})}),b.railwayTicketCheckboxEnabled=ko.computed(function(){return!b.railwayTicketDeadlineExceeded()&&(!a.availableTickets||0!=a.availableTickets().length)}),b.reductionEnabled=ko.computed(function(){return b.railwayTicketDeadlineExceeded()&&b.personModel().includeRailwayTicket(!1),b.reductionOptions().length>1&&1==b.personModel().includeRailwayTicket()&&!b.railwayTicketDeadlineExceeded()}),b.servicesEnabled=ko.computed(function(){return b.servicesAvailable()&&!b.trainsReserved()&&!b.reservingTrain()})};ko.components.register("train-ticket-personalisation",{viewModel:{createViewModel:function(a,b){return new TrainTicketPersonalisationViewModel(a)}},template:{fromUrl:"assets/templates/train-ticket-personalisation.html",maxCacheAge:1234}}),ko.components.register("cargo-reservation",{viewModel:{createViewModel:function(a){return new CargoReservationViewModel(a)}},template:{fromUrl:"assets/templates/cargo/cargo-reservation.html",maxCacheAge:1e3}});var PersonalisationCategoryLocalEvent=function(a,b){var c=this;return c.personalisationInfo=a.personalisationInfo,c};ko.components.register("personalisation-category-localevent",{viewModel:{createViewModel:function(a,b){return new PersonalisationCategoryLocalEvent(a,b)}},template:{fromUrl:"assets/templates/personalisation/personalisation-category-localevent.html",maxCacheAge:1234}});var PersonalisationFieldAddress=function(a,b){var c=this;c.valueStreet=ko.observable(null),c.valueStreetNumber=ko.observable(null),c.valueZipCode=ko.observable(null),c.valueCity=ko.observable(null),c.valueCountry=ko.observable(null);var d=function(a,b,c,d){return new personalisationModelField({id:a,label:b,type:PERSONALISATION_FIELD_TYPE_TEXTINPUT,frontend:1,required:1,pattern:d},c)};return c.fieldStreet=d("street",i18n.t("ticketsDetail.ticketholder.placeholder.street"),c.valueStreet,'[^+!|#%";?$=*<>^§\\€~{}\\[\\]_]*'),c.fieldStreetNumber=d("streetNumber",i18n.t("ticketsDetail.ticketholder.placeholder.streetNumber"),c.valueStreetNumber,'[^+!|#%";?$=*<>^§\\€~{}\\[\\]_]*'),c.fieldZipCode=d("zipCode",i18n.t("ticketsDetail.ticketholder.placeholder.zipCode"),c.valueZipCode,"([a-zA-Z0-9- ]*)"),c.fieldCity=d("city",i18n.t("ticketsDetail.ticketholder.placeholder.city"),c.valueCity,'[^+!|#%";?$=*<>^§\\€~{}\\[\\]_]*'),a.value({street:c.valueStreet,streetNumber:c.valueStreetNumber,zipCode:c.valueZipCode,city:c.valueCity,country:c.valueCountry}),c};ko.components.register("personalisation-field-address",{viewModel:{createViewModel:function(a,b){return new PersonalisationFieldAddress(a,b)}},template:{fromUrl:"assets/templates/personalisation/personalisation-field-address.html",maxCacheAge:1234}});var PersonalisationFieldBirthDate=function(a,b){var c=this;return c.value=a.value,c};ko.components.register("personalisation-field-birthdate",{viewModel:{createViewModel:function(a,b){return new PersonalisationFieldBirthDate(a,b)}},template:{fromUrl:"assets/templates/personalisation/personalisation-field-birthdate.html",maxCacheAge:1234}});var PersonalisationFieldCountry=function(a,b){var c=this;return abstractPersonalizationViewModel.apply(c,[]),c.optionsText="name",c.optionsValue="key",c.field=new personalisationModelField({id:"country",type:PERSONALISATION_FIELD_TYPE_DROPDOWN,options:this.optionsCountry(),frontend:!0,required:!0},a.value),c.fieldOptions=ko.computed(function(){return[{name:i18n.t("ticketsDetail.ticketholder.options.country.caption"),key:null}].concat(kp.get(c,"field.options",[]))}),c};ko.components.register("personalisation-field-country",{viewModel:{createViewModel:function(a,b){return new PersonalisationFieldCountry(a,b)}},template:{fromUrl:"assets/templates/personalisation/personalisation-field-dropdown.html",maxCacheAge:1234}});var PersonalisationFieldDropDown=function(a,b){var c=this;return c.field=a.field,c.fieldOptions=ko.computed(function(){return[{label:i18n.t("checkout.placeholder.selectEmpty"),value:null}].concat(kp.get(a,"field.options",[]))}),c};ko.components.register("personalisation-field-dropdown",{viewModel:{createViewModel:function(a,b){return new PersonalisationFieldDropDown(a,b)}},template:{fromUrl:"assets/templates/personalisation/personalisation-field-dropdown.html",maxCacheAge:1234}});var PersonalisationFieldEmail=function(a,b){var c=this;return c.field=new personalisationModelField({id:"email",label:i18n.t("registration.details.email"),type:PERSONALISATION_FIELD_TYPE_TEXTINPUT,frontend:1,required:1,parsleyType:"email",inputType:"email",pattern:"[_\\.0-9A-Za-z\\.\\!\\#\\$\\%\\&\\'\\*\\+\\-\\/\\=\\?\\^\\`\\{\\|\\}\\~]+@([0-9A-Za-z-]+\\.)*[0-9A-Za-z-]{2,}\\.[A-Za-z]{2,6}"},a.value),c};ko.components.register("personalisation-field-email",{viewModel:{createViewModel:function(a,b){return new PersonalisationFieldEmail(a,b)}},template:{fromUrl:"assets/templates/personalisation/personalisation-field-text.html",maxCacheAge:1234}});var PersonalisationFieldGender=function(a,b){var c=this;return abstractPersonalizationViewModel.apply(c,[]),c.optionsText="name",c.optionsValue="key",c.field=new personalisationModelField({id:"gender",type:PERSONALISATION_FIELD_TYPE_DROPDOWN,options:this.optionsSalutation(),frontend:1,required:1,pattern:null,patternmsg:null},a.value),c.fieldOptions=ko.computed(function(){return[{name:i18n.t("registration.details.salutationOptions.placeholder"),key:null}].concat(kp.get(c,"field.options",[]))}),c};ko.components.register("personalisation-field-gender",{viewModel:{createViewModel:function(a,b){return new PersonalisationFieldGender(a,b)}},template:{fromUrl:"assets/templates/personalisation/personalisation-field-dropdown.html",maxCacheAge:1234}});var PersonalisationFieldLanguage=function(a,b){var c=this;return abstractPersonalizationViewModel.apply(c,[]),c.optionsText="name",c.optionsValue="key",c.field=new personalisationModelField({id:"country",type:PERSONALISATION_FIELD_TYPE_DROPDOWN,options:this.languageOptions(),frontend:!0,required:!0},a.value),c.fieldOptions=ko.computed(function(){return[{name:i18n.t("common.language.select"),key:null}].concat(kp.get(c,"field.options",[]))}),c};ko.components.register("personalisation-field-language",{viewModel:{createViewModel:function(a,b){return new PersonalisationFieldLanguage(a,b)}},template:{fromUrl:"assets/templates/personalisation/personalisation-field-dropdown.html",maxCacheAge:1234}});var PersonalisationFieldName=function(a,b){var c=this;return c.valueFirstName=ko.observable(null),c.valueLastName=ko.observable(null),c.fieldFirstName=new personalisationModelField({id:"firstname",label:i18n.t("registration.details.firstName"),type:PERSONALISATION_FIELD_TYPE_TEXTINPUT,frontend:1,required:1,pattern:'[^+!|#%";?$=*<>^§\\€~{}\\[\\]_]*'},c.valueFirstName),c.fieldLastName=new personalisationModelField({id:"lastname",label:i18n.t("registration.details.lastName"),type:PERSONALISATION_FIELD_TYPE_TEXTINPUT,pattern:'[^+!|#%";?$=*<>^§\\€~{}\\[\\]_]*',frontend:1,required:1},c.valueLastName),a.value({firstName:c.valueFirstName,lastName:c.valueLastName}),c};ko.components.register("personalisation-field-name",{viewModel:{createViewModel:function(a,b){return new PersonalisationFieldName(a,b)}},template:{fromUrl:"assets/templates/personalisation/personalisation-field-name.html",maxCacheAge:1234}});var PersonalisationFieldPhone=function(a,b){var c=this;return c.field=new personalisationModelField({id:"phone",label:i18n.t("checkout.placeholder.phone"),type:PERSONALISATION_FIELD_TYPE_TEXTINPUT,frontend:!0,required:!0,pattern:null,inputType:"tel"},a.value),c};ko.components.register("personalisation-field-phone",{viewModel:{createViewModel:function(a,b){return new PersonalisationFieldPhone(a,b)}},template:{fromUrl:"assets/templates/personalisation/personalisation-field-text.html",maxCacheAge:1234}});var PersonalisationFieldText=function(a,b){var c=this;return c.field=a.field,c};ko.components.register("personalisation-field-text",{viewModel:{createViewModel:function(a,b){return new PersonalisationFieldText(a,b)}},template:{fromUrl:"assets/templates/personalisation/personalisation-field-text.html",maxCacheAge:1234}});var PersonalisationField=function(a,b){var c=this;return c.field=a.field,c};ko.components.register("personalisation-field",{viewModel:{createViewModel:function(a,b){return new PersonalisationField(a,b)}},template:"\x3c!-- ko if: kp.get(field,'type') == PERSONALISATION_FIELD_TYPE_DROPDOWN --\x3e <personalisation-field-dropdown params='field: field'></personalisation-field-dropdown> \x3c!-- /ko --\x3e \x3c!-- ko if: kp.get(field,'type') == PERSONALISATION_FIELD_TYPE_TEXTINPUT --\x3e <personalisation-field-text params='field: field'></personalisation-field-text> \x3c!-- /ko --\x3e "});var groupReservationApi={root:null,openGroupReservationDetail:function(a){var b="group-reservation-detail";null!==a&&(b=b+"/"+a),location.hash=b},searchSectionsByValues:function(a,b,c,d,e,f,g){var h=b,i=d,j=c,k=f||2,g=g||!1,l=moment(e).format(MOMENTJS_DATE_SERVER_FORMAT);if(!h&&!j)return void a([]);var m=$.ajax(serviceRootURL+"/bergbahn_reservation/sections",{type:"GET",data:{stationFrom:h,stationTo:j,stationVia:i,date:l},dataType:"json",contentType:"application/json",success:function(b,c,d){var e=$.map(b,function(a){var b=new sectionModel(a);return b.firstClassEnabled(1==f),b});$.Deferred(function(a){var b=[];e.forEach(function(a,c){b.push(a.fetchTrainsDeferred(k))}),$.when.apply($,b).then(function(){g&&a.resolve()},function(b){a.reject()}),g||a.resolve()}).promise().done(function(){a(!0,e)})},error:function(b,c,d){if(self.searchAjaxRequestsCleaning)return void groupReservationApi.root.screenWorking(!1);console.log("Server error on creating sections request:\n"+b.responseText+" status: "+c+"error thrown: "+d),checkSession(b),showError("Fehler beim Laden der Routen",b,c,d),a(!1),groupReservationApi.root.screenWorking(!1)}});groupReservationApi.root.searchAjaxRequests.push(m)},changeOvernightStaySections:function(){return $.Deferred(function(a){var b=!1,c=[];groupReservationApi.root.selectedSectionsOutward().forEach(function(a){a.hasOvernightStay()&&(b=!0),b&&c.push(gr.sections.addOvernightDayToSection(a))}),groupReservationApi.root.selectedSectionsReturn().forEach(function(a){a.hasOvernightStay()&&(b=!0),b&&c.push(gr.sections.addOvernightDayToSection(a))});var d=function(a){var b=function(a,b){return a.forEach(function(c){if(ko.unwrap(c.stationFrom)==ko.unwrap(b.stationFrom)&&ko.unwrap(c.stationTo)==ko.unwrap(b.stationTo)){var d=a.indexOf(c);b.hasOvernightStay(c.hasOvernightStay()),a.splice(d,1,b)}}),a};groupReservationApi.root.selectedSectionsOutward(b(groupReservationApi.root.selectedSectionsOutward(),a)),groupReservationApi.root.selectedSectionsReturn(b(groupReservationApi.root.selectedSectionsReturn(),a))};$.when.apply($,c).then(function(){$.each(arguments,function(a,b){d(b)}),a.resolve()},function(b){a.reject()})}).promise()},searchOrders:function(a,b,c){var d={searchText:a,dateRange:"orderDate",includeReservationInfo:!0,consumptionCheck:!1,bundleMode:"leaves",withRestaurantReservationsOnly:!!b};return $.ajax(serviceRootURL+"/orders",{type:"GET",data:d,dataType:"json",contentType:"application/json",success:function(a,b,d){var e=$.map(a,function(a){return new groupReservationOrderModel(a)});c(e)},error:function(a,b,c){checkSession(a),"abort"!==b&&(console.log("Server error on loading reservations: "+a.responseText),showError("Fehler beim Laden der Reservierungen",a,b,c))}})},searchSections:function(a,b,c,d){var e="function"==typeof a.key?a.key():null,f="function"==typeof b.key?b.key():null,g=ko.unwrap(c)?ko.unwrap(c):null;return $.Deferred(function(a){groupReservationApi.searchSectionsByValues(function(b,c){if(b){a.notify(c);var d=function(){if(c)for(var a=0;a<c.length;a++)if(!kp.get(c,a+".trains",[]).length)return!1;return!0};checkTrainsLoadedFn=function(){d()&&(clearInterval(e),a.resolve(c))};var e=setInterval(checkTrainsLoadedFn,300)}else a.reject()},e,f,g,d)}).promise()},searchTrainsForSection:function(a,b,c,d,e){b=ko.unwrap(b),c=ko.unwrap(c);var f=$.ajax(serviceRootURL+"/bergbahn_reservation/trains",{type:"GET",data:{stationFrom:b,stationTo:c,date:d,wagonClass:e},dataType:"json",contentType:"application/json",success:function(d,e,f){var g=$.map(d,function(a){return a.stationFrom=b,a.stationTo=c,new trainModel(a)});a(g)},error:function(a,b,c){if(self.searchAjaxRequestsCleaning)return void groupReservationApi.root.screenWorking(!1);console.log("Server error on creating trains request:\n"+a.responseText+" status: "+b+"error thrown: "+c),checkSession(a),showError("Fehler beim Laden der Züge",a,b,c),groupReservationApi.root.screenWorking(!1)}});groupReservationApi.root.searchAjaxRequests.push(f)},getTrainDetails:function(a,b,c){c=moment(c).format(MOMENTJS_DATE_SERVER_FORMAT);var d=$.ajax(serviceRootURL+"/bergbahn_reservation/trains/"+kp.get(b,"trainNumber"),{type:"GET",data:{date:c,stationFrom:kp.get(b,"stationFrom"),stationTo:kp.get(b,"stationTo")},dataType:"json",contentType:"application/json",success:function(b,c,d){console.log("get train details request successful");var e=$.map(b,function(a){return new trainTimeTableEntry(a)});a(e)},error:function(a,b,c){if(self.searchAjaxRequestsCleaning)return void groupReservationApi.root.screenWorking(!1);console.log("Server error on creating train detail request:\n"+a.responseText+" status: "+b+"error thrown: "+c),checkSession(a),showError("Fehler beim Laden der Zwischenstationen",a,b,c),groupReservationApi.root.screenWorking(!1)}});groupReservationApi.root.searchAjaxRequests.push(d)},searchTourGuides:function(a,b){var c={};null!==a&&(c.partnerId=a),$.ajax(serviceRootURL+"/tourguides",{type:"GET",data:c,dataType:"json",contentType:"application/json",success:function(a,c,d){console.log("get group tourguides request successful");var e=$.map(a,function(a){return new tourguideModel(a)});b(e)},error:function(a,b,c){console.log("Server error on creating get group tourguides request:\n"+a.responseText+" status: "+b+"error thrown: "+c),checkSession(a),showError("Error when requesting group tourguides",a,b,c),groupReservationApi.root.screenWorking(!1)}})},getTourGuideById:function(a,b){$.ajax(serviceRootURL+"/tourguides",{type:"GET",data:{partnerId:a},dataType:"json",contentType:"application/json",success:function(a,c,d){console.log("get group tourguides request successful");var e=$.map(a,function(a){return new tourguideModel(a)});b(e[0])},error:function(a,b,c){console.log("Server error on creating get group tourguides request:\n"+a.responseText+" status: "+b+"error thrown: "+c),checkSession(a),showError("Error when requesting group tourguides",a,b,c),groupReservationApi.root.screenWorking(!1)}})},createTourGuide:function(a,b,c){var d={email:a.email(),firstname:a.firstname(),lastname:a.lastname(),phone:a.phone(),partnerId:a.partnerId(),locale:b};$.ajax(serviceRootURL+"/tourguides",{type:"POST",data:JSON.stringify(d),dataType:"json",contentType:"application/json",success:function(a,b,d){console.log("create tourguide request successful"),c(new tourguideModel(a))},error:function(a,b,c){console.log("Server error on creating tourguide request:\n"+a.responseText+" status: "+b+"error thrown: "+c),checkSession(a),showError("Error when creating tourguide",a,b,c),groupReservationApi.root.screenWorking(!1)}})},updateTourGuide:function(a){var b=kp.get(a,"id");return $.Deferred(function(c){$.ajax({url:serviceRootURL+"/tourguides/"+b,type:"PUT",data:JSON.stringify(a),dataType:"json",contentType:"application/json"}).done(function(a){c.resolve()}).fail(function(a,b,c){checkSession(a),showError("Fehler beim Laden der Texts",a,b,c),groupReservationApi.root.screenWorking(!1)})}).promise()},getRestaurants:function(a,b,c){$.getJSON(serviceRootURL+"/options",{categoryKey:CATEGORY_KEY_MENU,optionListKey:b===CATEGORY_KEY_MENU?"restaurants":"restaurantsTrain",parentOptionListKey:"",parentOptionKey:"",recursive:c||!1,sort:!0}).done(function(b){var c=$.map(b,function(a){return new bergbahnGroupReservationRestaurantOptionModel(a)});c.forEach(function(a){var b={};a.menuVegetarianEntries().forEach(function(a){var c=a.additionalInfo?a.additionalInfo.vegetarian_variant_of:null;c&&(b[c]||(b[c]=[]),b[c].push(new bergbahnGroupReservationRestaurantMenuOptionModelNew(a)))});var c=$.map(a.menuEntries(),function(a){var c=new bergbahnGroupReservationRestaurantMenuOptionModelNew(a);return c.menuVegetarianOptionList=ko.observableArray(b[a.id]?b[a.id]:[]),c});a.menuOptionList=ko.observableArray(c)}),a(c)}).fail(function(a,b,c){checkSession(a),showError("Fehler beim Laden der returnFroms",a,b,c),groupReservationApi.root.screenWorking(!1)})},getMenus:function(a,b){return $.Deferred(function(c){$.getJSON(serviceRootURL+"/options",{categoryKey:CATEGORY_KEY_BERGBAHN_GROUP_RESERVATION,optionListKey:"menus",parentOptionListKey:"restaurants",parentOptionKey:b,sort:!0}).done(function(b){var d=$.map(b,function(a){return new bergbahnGroupReservationRestaurantMenuOptionModel(a)});a(d),c.resolve(d)}).fail(function(a,b,d){checkSession(a),showError("Fehler beim Laden der returnFroms",a,b,d),groupReservationApi.root.screenWorking(!1),c.reject()})}).promise()},getRoutePresets:function(a){$.getJSON(serviceRootURL+"/options",{categoryKey:CATEGORY_KEY_BERGBAHN_GROUP_RESERVATION,optionListKey:"routePresets",parentOptionListKey:"",parentOptionKey:"",sort:!0}).done(function(b){var c=$.map(b,function(a){return new bergbahnGroupReservationPresetOptionModel(a)});a(c)}).fail(function(a,b,c){checkSession(a),showError("Fehler beim Laden der returnFroms",a,b,c),groupReservationApi.root.screenWorking(!1)})},getTextGroups:function(a){$.getJSON(serviceRootURL+"/options",{categoryKey:CATEGORY_KEY_BERGBAHN_GROUP_RESERVATION,optionListKey:"textGroups",parentOptionListKey:"",parentOptionKey:"",sort:!0}).done(function(b){var c=$.map(b,function(a){return new bergbahnGroupReservationTextGroupOptionModel(a)});a(c)}).fail(function(a,b,c){checkSession(a),showError("Fehler beim Laden der TextGroups",a,b,c),groupReservationApi.root.screenWorking(!1)})},getTexts:function(a,b){return $.Deferred(function(c){$.getJSON(serviceRootURL+"/options",{categoryKey:CATEGORY_KEY_BERGBAHN_GROUP_RESERVATION,optionListKey:"texts",parentOptionListKey:"textGroups",parentOptionKey:a,sort:!0}).done(function(a){var d=$.map(a,function(a){return new bergbahnGroupReservationPresetOptionModel(a)});b&&b(d),c.resolve(d)}).fail(function(a,b,c){checkSession(a),showError("Fehler beim Laden der Texts",a,b,c),groupReservationApi.root.screenWorking(!1)})}).promise()},getText:function(a,b){return $.Deferred(function(c){$.getJSON(serviceRootURL+"/option",{categoryKey:CATEGORY_KEY_BERGBAHN_GROUP_RESERVATION,optionListKey:"textsAll",optionKey:a,sort:!0}).done(function(a){var d=new bergbahnGroupReservationPresetOptionModel(a);b&&b(d),c.resolve(d)}).fail(function(a,b,c){checkSession(a),showError("Fehler beim Laden der Texts",a,b,c),groupReservationApi.root.screenWorking(!1)})}).promise()},clearRequests:function(){self.searchAjaxRequestsCleaning=!0;for(var a=0;a<groupReservationApi.root.searchAjaxRequests.length;a++){groupReservationApi.root.searchAjaxRequests[a].abort()}self.searchAjaxRequestsCleaning=!1,groupReservationApi.root.searchAjaxRequests=[]},getPartnerById:function(a,b){$.ajax(serviceRootURL+"/partner/"+a,{type:"GET",data:{},dataType:"json",contentType:"application/json",success:function(a,c,d){b(a)},error:function(a,b,c){}})},getTravelAgencies:function(a){return $.Deferred(function(b){$.getJSON(serviceRootURL+"/travelagencies",{partnerId:a}).done(function(a){var c=$.map(a,function(a){return new bergbahnGroupTravelAgencyOptionModel(a)});b.resolve(c)}).fail(function(a,b,c){checkSession(a),showError("Fehler beim Laden der Texts",a,b,c),groupReservationApi.root.screenWorking(!1)})}).promise()},updateTravelAgency:function(a){var b=kp.get(a,"id");return $.Deferred(function(c){$.ajax({url:serviceRootURL+"/travelagencies/"+b,type:"PUT",data:JSON.stringify(a),dataType:"json",contentType:"application/json"}).done(function(a){c.resolve()}).fail(function(a,b,c){checkSession(a),showError("Fehler beim Laden der Texts",a,b,c),groupReservationApi.root.screenWorking(!1)})}).promise()},updateResellerDefaults:function(a,b,c){return $.Deferred(function(d){$.ajax({url:serviceRootURL+"/partner/"+a,type:"PUT",data:JSON.stringify({id:a,travelagencyDefaultId:b,contactPersonDefaultId:c}),dataType:"json",contentType:"application/json"}).done(function(a){d.resolve()}).fail(function(a,b,c){checkSession(a),showError("Fehler beim Laden der Texts",a,b,c)})}).promise()},createTravelAgency:function(a){kp.get(a,"id");return $.Deferred(function(b){$.ajax({url:serviceRootURL+"/travelagencies",type:"POST",data:JSON.stringify(a),dataType:"json",contentType:"application/json"}).done(function(a){b.resolve()}).fail(function(a,b,c){checkSession(a),showError("Fehler beim Laden der Texts",a,b,c),groupReservationApi.root.screenWorking(!1)})}).promise()},getContactPersons:function(a){return $.Deferred(function(b){$.getJSON(serviceRootURL+"/partnercontactpersons",{partnerId:a}).done(function(a){var c=$.map(a,function(a){return new bergbahnGroupContactPartnerOptionModel(a)});b.resolve(c)}).fail(function(a,b,c){checkSession(a),showError("Fehler beim Laden der Texts",a,b,c),groupReservationApi.root.screenWorking(!1)})}).promise()},getTourGuidesReseller:function(a){return $.Deferred(function(b){$.getJSON(serviceRootURL+"/tourguides",{partnerId:a}).done(function(a){var c=$.map(a,function(a){return new tourguideModel(a)});b.resolve(c)}).fail(function(a,b,c){checkSession(a),showError("Error when loading reseller tour guides",a,b,c),groupReservationApi.root.screenWorking(!1)})}).promise()},updateContactPerson:function(a){var b=kp.get(a,"id");return $.Deferred(function(c){$.ajax({url:serviceRootURL+"/partnercontactpersons/"+b,type:"PUT",data:JSON.stringify(a),dataType:"json",contentType:"application/json"}).done(function(a){c.resolve(a)}).fail(function(a,b,c){checkSession(a),showError("Fehler beim Laden der Texts",a,b,c),groupReservationApi.root.screenWorking(!1)})}).promise()},createContactPerson:function(a){return $.Deferred(function(b){$.ajax({url:serviceRootURL+"/partnercontactpersons",type:"POST",data:JSON.stringify(a),dataType:"json",contentType:"application/json"}).done(function(a){b.resolve(a)}).fail(function(a,b,c){checkSession(a),showError("Fehler beim Laden der Texts",a,b,c),groupReservationApi.root.screenWorking(!1)})}).promise()},sendGroupNotification:function(a,b,c){groupReservationApi.root.screenWorking(!0);var d=serviceRootURL+"/groups/"+a+"?action="+(b?"notifyWithPrice":"notifyWithoutPrice");$.ajax(d,{type:"PUT",data:JSON.stringify({id:a}),dataType:"json",contentType:"application/json",success:function(b,d,e){console.log("group notification sent (id="+a+")"),groupReservationApi.root.screenWorking(!1),c()},error:function(a,b,c){checkSession(a),console.log("Server error on group notification sending: "+a.responseText),showError(i18n.t("groupReservation.notifications.message_error"),a,b,c),groupReservationApi.root.screenWorking(!1)}})}},BootstrapDatepickerModel=function(a,b){var c=this;c.$el=$(b.element),c.input=c.$el.find("input"),c.inputBtn=c.$el.find("button"),c.inputId=kp.get(a,"id","qa-gr--travel-date"),c.input.attr("id",c.inputId),c.selectedDate=ko.observable({}),c.selectedDate.subscribe(function(){a.date(c.selectedDate())}),c.input.on("change",function(b){var d=c.input.val(),e=getMomentJsDateFormat();moment(d,e,!0).isValid()&&function(){return a.dateMin?moment(d,e,!0).isSameOrAfter(a.dateMin()):!a.dateMax||moment(d,e,!0).isSameOrBefore(a.dateMax())}()?c.selectedDate($.datepicker.parseDate(DATE_PICKER_FORMAT,c.input.val())):(c.input.css("color","red"),setTimeout(function(){c.input.css("color","inherit").val("")},500)),b.preventDefault(),b.stopPropagation()}),null!==a.dateMax?c.dateMax=a.dateMax:c.dateMax=ko.observable(null),null!==a.dateMin?c.dateMin=a.dateMin:c.dateMin=ko.observable(null);var d={};"dateMax"in a&&null!==a.dateMax&&(d.maxDate=new Date(a.dateMax()),console.log("max date: "+d.maxDate)),"dateMin"in a&&null!==a.dateMin&&(d.minDate=new Date(a.dateMin()),console.log("min date: "+d.minDate)),c.input.datepicker(d),c.inputBtn.on("click",function(){c.input.focus()}),a.date&&c.input.val($.datepicker.formatDate(DATE_PICKER_FORMAT,a.date())),c.setInDate=a.date,c.setInDate.subscribe(function(){c.input.datepicker("setDate",c.setInDate())}),c.dataValue=ko.computed(function(){return moment(c.setInDate()).format(MOMENTJS_DATE_SERVER_FORMAT)}),c.isRequired=a.isRequired,null!=a.enable?c.enable=a.enable:c.enable=ko.observable(!0),null!=a.readonly?c.readonly=a.readonly:c.readonly=ko.observable(!1),c.validationGroup=!1,a.validationGroup&&(c.validationGroup='["'+a.validationGroup.split(",").join('","')+'"]')};ko.components.register("bootstrap-datepicker",{viewModel:{createViewModel:function(a,b){return new BootstrapDatepickerModel(a,b)}},
template:"<div><div class=\"input-group input-group--append\">\n    <input data-bind=\"enable: enable, attr:{                   'readonly': readonly,                    'data-value': dataValue ,                    'data-parsley-required':isRequired,                    'data-parsley-date-validation': isRequired,                    'data-parsley-group': validationGroup               }\""+'    type="text" autocomplete="off" name="customDate" class="customDate datepicker datepicker-input form-control pull-left">\n    <span class="input-group-btn ">\n    <button tabindex="-1" class="btn btn-append" type="button">\n    <i class="fa fa-fw fa-calendar"></i>\n    </button>\n    </span>\n</div></div>'});var BoostrapTags=function(a,b){var c=this;c.eventEnter=a.eventEnter,c.$el=$(b.element),c.select=c.$el.find("input"),c.allowEmpty=kp.get(a,"allowEmpty",!0),c.itemsValue=kp.get(a,"itemsText","optionValue"),c.itemsText=kp.get(a,"itemsText","optionText");var d={options:[],delimiter:",",persist:!0,create:!1,plugins:["remove_button","drag_drop"],placeholder:i18n.t("components.bootstrapSelect.placeholder"),onInitialize:function(){c.selectize=c.select[0].selectize},onChange:function(d,e,f,g){var h=[],i=String(c.selectize.getValue()).split(",");$.each(i,function(a,b){var d=_.find(c.selectize.options,function(a){return String(kp.get(a,"value"))==String(b)});d&&h.push(d.data)}),a.selectedItem(h),$(b.element).find(".item.active").removeClass(".active")}};c.select.selectize(d),c.availableItems=ko.observable({}),c.selectedItem=ko.observable({}),null!=a.enable?c.enable=a.enable:c.enable=ko.observable(!0),a.items.subscribe(function(){c.availableItems(kp.get(a,"items",[]))}),c.isRequired=a.isRequired,c.dataWidth=a.width?a.width:"auto",c.name=a.name?a.name:"name-default",c.validationGroup=!1,a.validationGroup&&(c.validationGroup='["'+a.validationGroup.split(",").join('","')+'"]'),c.id=kp.get(a,"id",!1),c.availableItems(a.items()),c.dataValue=ko.computed(function(){return kp.get(a,"selectedItem."+c.itemsValue)}),a.selectedItem.subscribe(function(){c.refreshTags()}),c.refreshTags=function(){for(var d=_.uniq(a.selectedItem()),e=[],f=[],g=0;g<d.length;g++){var h=d[g];e.push({value:kp.get(h,c.itemsValue,null),text:kp.get(h,c.itemsText,null),data:ko.toJS(h)}),f.push(kp.get(h,c.itemsValue,null))}c.selectize.addOption(e),c.selectize.setValue(f,!0),$(b.element).find(".item.active").removeClass(".active")},c.refreshTags()};ko.components.register("bootstrap-tags",{viewModel:{createViewModel:function(a,b){return new BoostrapTags(a,b)}},template:{fromUrl:"assets/groupreservation/bootstrap-tags.html",maxCacheAge:1234}});var BoostrapTimepicker=function(a,b){var c=this;return c.selectedDate=a.selectedDate,c.$el=$(b.element),c.input=c.$el.find("input"),c.selectedDate.subscribe(function(){a.selectedDate(c.selectedDate())}),c.id=a.id,c.isRequired=a.isRequired,c.validationGroup=a.validationGroup,c.dateFormat="HH:mm",a.dateFormat&&(c.dateFormat=a.dateFormat),c.flatpickr=c.input.flatpickr({enableTime:!0,noCalendar:!0,dateFormat:"H:i",time_24hr:!0,minuteIncrement:15,onKeyDown:function(b,d,e,f){var g=f.which||f.keyCode;(g>=48&&g<=57||13==g||9==g||46==g||g>=37&&g<=40)&&("function"==typeof a.eventEnter&&($(".flatpickr-hour",c.flatpickr.calendarContainer).is(":focus")||$(".flatpickr-minute",c.flatpickr.calendarContainer).is(":focus"))&&(13!=f.which&&13!=f.keyCode||a.eventEnter(null,f)),setTimeout(function(){var a,b,d=e;g>=48&&g<=57&&(a=$(".flatpickr-hour",c.flatpickr.calendarContainer).val(),b=$(".flatpickr-minute",c.flatpickr.calendarContainer).val(),$(".flatpickr-hour",c.flatpickr.calendarContainer).is(":focus")?a.length>=2&&$(".flatpickr-minute",c.flatpickr.calendarContainer).focus():$(".flatpickr-minute",c.flatpickr.calendarContainer).is(":focus")&&b.length>=2&&(c.flatpickr.setDate(a+":"+b,!0),c.flatpickr.close(),$(d._input).closest(".form-group").length>0?$(d._input).closest(".form-group").next(".form-group").find(".selectize-control input").focus():$(d._input).closest(".reservation-break__form").length>0&&$(d._input).closest(".reservation-break__form").find("input:visible").first().focus()))},1))},onOpen:function(a,b,d){c.selectedDate()||c.selectedDate("12:00")},onChange:function(a,b,d){var e=_.head(a);e&&(nearest15min=function(a,b){const c=Math.round(b.clone().minute()/a)*a;return b.clone().minute(c).second(0)}(15,moment(e)),b=nearest15min.format("HH:mm"),c.selectedDate(b),c.flatpickr.setDate(b))},formatDate:function(a,b,d){return moment(a).format(c.dateFormat)}}),a.selectedDate.subscribe(function(){c.flatpickr.setDate(a.selectedDate())}),c.flatpickr.setDate(a.selectedDate()),c};ko.components.register("bootstrap-timepicker",{viewModel:{createViewModel:function(a,b){return new BoostrapTimepicker(a,b)}},template:{fromUrl:"assets/groupreservation/bootstrap-timepicker.html",maxCacheAge:1234}});var ChefServiceRoomDialogModel=function(a){var b=this;b.showLoadingSpinner=ko.observable(!1),this.showDialog=a.showDialog,this.saveOrder=a.saveOrder,this.restaurantReservation=a.restaurantReservation,this.roomAssignments=a.roomAssignments,this.pax=ko.observable(),this.menus=a.menus,this.orderId=a.orderId,this.courses=ko.observableArray([1,2,3,4]),this.getAddonsByCourse=function(a,b){return a.addons().filter(function(a){if(a.course()===b)return a})},this.totalPax=ko.computed(function(){var a=0;return b.roomAssignments()&&b.roomAssignments().forEach(function(b){""===b.pax()&&b.pax(0),a+=parseInt(b.pax())}),a}),b.isSaveDisabled=ko.computed(function(){return b.totalPax()>b.pax()}),this.restaurantReservation.subscribe(function(){console.log("this.roomAssignments.subscribe"),b.showLoadingSpinner(!0);var a=kp.get(b.restaurantReservation(),"restaurantId"),c=kp.get(b.restaurantReservation(),"id"),d=kp.get(b.restaurantReservation(),"from"),e=kp.get(b.restaurantReservation(),"until");b.pax(kp.get(b.restaurantReservation(),"pax"));var f=kp.get(b.restaurantReservation(),"roomAssignments",[]),g={};f.forEach(function(a){g[a.roomId()]=a.pax()});var h=[],i=$.map(headerVM.roomsToRestaurantIdMap[a],function(a){return a.pax=g[a.roomId]?g[a.roomId]:0,h.push(a.roomId),new restaurantRoomModel(a)});contingentReservationApi.getRoomsContingentAvailabilities(a,c,h,d,e).done(function(){$.each(arguments,function(a,b){if(b&&b[0]&&b[0].length>0){var c=b[0][0].free,d=b[0][0].total;b[0].forEach(function(a){c=Math.min(c,a.free),d=Math.min(d,a.total)}),i[a].maxPax(d),i[a].freePax(c)}}),b.roomAssignments(i),b.showLoadingSpinner(!1)})}),this.submit=function(){b.showDialog(!1),console.log(b.roomAssignments()),b.saveOrder(b.roomAssignments())},b.cancel=function(){console.log("cancel clicked!"),b.showDialog(!1)}};ko.components.register("chef-service-room-dialog",{viewModel:{createViewModel:function(a){return new ChefServiceRoomDialogModel(a)}},template:{fromUrl:"assets/groupreservation/chef/chef-service-room-dialog.html",maxCacheAge:1e3}});var CommentInput=function(a,b){var c=this;c.formComment=ko.observable({comment:ko.observable(null)}),c.comment=ko.observable(null),c.maxLength=a.maxLength||1024,c.enableTags=a.enableTags||!1,c.showTextBlocks=ko.observable(!1),void 0!==a.isTextBlocksHidden&&(null!==a.isTextBlocksHidden()&&!1!==a.isTextBlocksHidden()||c.showTextBlocks(!0)),c.selectedTextGroup=ko.observable({}),c.availableTags=ko.observable([]),c.availableTags=groupReservationApi.root.commentTextGroups,c.isLoadingTags=ko.observable(!1),c.selectedTags=ko.observableArray([]),c.selectedTags(ko.toJS(kp.get(a,"selectedTags",[]))),c.enableTags&&a.selectedTags.subscribe(function(){c.selectedTags(ko.toJS(kp.get(a,"selectedTags",[])))}),c.selectedTextGroup.subscribe(function(){var a=ko.toJS(c.selectedTags()),b=kp.get(c,"selectedTextGroup.id"),d=kp.get(c,"selectedTextGroup"),e=kp.get(c,"selectedTextGroup.texts",[]);b&&(e.length?c.selectedTags(a.concat(e)):(c.isLoadingTags(!0),groupReservationApi.getTexts(kp.get(d,"key"),function(b){d.texts(b),c.selectedTags(a.concat(b)),c.isLoadingTags(!1)}))),b&&c.selectedTags(a.concat(e))}),c.comment.subscribe(function(){a.comment(c.comment())}),c.enabled=void 0===a.enabled?ko.observable(!0):a.enabled,a.comment.subscribe(function(){a.comment()!==c.comment()&&c.comment(a.comment())}),c.openModal=function(){c.enabled&&1==c.enabled()&&(c.formComment({comment:ko.observable(c.comment())}),c.enableTags&&(c.selectedTextGroup({}),c.selectedTags(ko.toJS(kp.get(a,"selectedTags",[])))),$(b.element).find(".modal").modal("show"))},c.updateComment=function(){$(b.element).find("form").parsley().whenValid().then(function(){c.comment(c.formComment().comment()),c.enableTags&&a.selectedTags(c.selectedTags()),$(b.element).find(".modal").modal("hide"),$(b.element).find("form").parsley().reset()})},c.closeModal=function(){$(b.element).find(".modal").modal("hide"),$(b.element).find("form").parsley().reset()},c.hookTooltip=function(){var a=i18n.t("groupReservation.detail.comment.tooltip");$(b.element).find(".js-open-comment-modal").tooltip({placement:"bottom",title:a})},c.destroyTooltip=function(){$(b.element).find(".js-open-comment-modal").tooltip("destroy")};var d=function(){c.enabled()?c.hookTooltip():c.destroyTooltip()};return c.enabled.subscribe(d),d(),c.comment(a.comment()),c};ko.components.register("comment-input",{viewModel:{createViewModel:function(a,b){return new CommentInput(a,b)}},template:{fromUrl:"assets/groupreservation/comment-input.html",maxCacheAge:1234}});var PlusMinusModel=function(a,b){var c=this;c.value=a.value?a.value:ko.observable(0),c.enable=a.enable?a.enable:ko.observable(!0),c.maxValue=ko.observable(999),c.minValue=ko.observable(1),a.maxValue&&c.maxValue(a.maxValue()),a.minValue&&c.minValue(a.minValue()),c.value.subscribe(function(a){a>c.maxValue()&&c.value(c.maxValue()),a<c.minValue()&&c.value(c.minValue())}),c.minus=function(){var a=parseInt(c.value());isNaN(a)&&(a=c.minValue()+1),a>c.minValue()&&c.value(a-1)},c.ensureNumberical=function(a,b){return!!b.key.match(/[0-9]/g)},c.plus=function(){var a=parseInt(c.value());isNaN(a)&&(a=0),a<c.maxValue()&&c.value(a+1)}};ko.components.register("plus-minus-input",{viewModel:{createViewModel:function(a,b){return new PlusMinusModel(a,b)}},template:'<div class="plus-minus-input" style="width: 103px;">           <div class="input-group">\n             <span class="input-group-btn"><button class="btn btn-sm value-control" data-bind="click: minus, attr: { disabled: !enable() } " data-target="font-size"><span class="glyphicon glyphicon-minus"></span></button></span>\n               <input type="text" pattern="[0-9]+" maxlength="3" data-bind="value: value, event: { keypress: ensureNumberical }, attr: { disabled: !enable() } " class="form-control">\n             <span class="input-group-btn"><button class="btn btn-sm value-control" data-bind="click: plus, attr: { disabled: !enable() } " data-target="font-size"><span class="glyphicon glyphicon-plus"></span></button></span>\n          </div>       </div>'});var ContactpersonSelect=function(a,b){var c=this;return c.openModal=function(){$(b.element).find(".modal").modal("show")},c.selectedTourOperator=a.selectedTourOperator,c.selectedItem=a.selectedItem,c.salutations=ko.observableArray((new abstractPersonalizationViewModel).optionsSalutation()),null!=a.enable?c.enable=a.enable:c.enable=ko.observable(!0),c.isEdit=ko.observable(!1),c.formItem=ko.observable({}),c.resetForm=function(){c.formItem({id:ko.observable(null),partnerId:ko.observable(kp.get(c,"selectedTourOperator.key")),firstname:ko.observable(null),lastname:ko.observable(null),gender:ko.observable(null),email:ko.observable(null),default:ko.observable(!1)})},c.resetForm(),c.openModal=function(){c.isEdit(!1),c.resetForm(),$(b.element).find(".modal").modal("show")},c.openEditModal=function(){c.isEdit(!0),c.resetForm(),c.formItem({id:ko.observable(kp.get(c,"selectedItem.id")),partnerId:ko.observable(kp.get(c,"selectedTourOperator.key")),firstname:ko.observable(kp.get(c,"selectedItem.firstname")),lastname:ko.observable(kp.get(c,"selectedItem.lastname")),gender:ko.observable(kp.get(c,"selectedItem.gender")),email:ko.observable(kp.get(c,"selectedItem.email")),default:ko.observable(kp.get(c,"selectedTourOperator.contactPersonDefaultId")==kp.get(c,"selectedItem.id"))}),$(b.element).find(".modal").modal("show")},c.updateItem=function(){$(b.element).find("form").parsley().whenValidate().then(function(){var a=kp.get(c,"formItem.default",!1),d=ko.toJS(c.formItem());delete d.default;var e;e=c.isEdit()?groupReservationApi.updateContactPerson(d).then(function(){for(var a=c.items(),b=0;b<a.length;b++){kp.get(a,b+".id")==kp.get(c.formItem(),"id")&&(a[b]=new bergbahnGroupContactPartnerOptionModel(ko.toJS(c.formItem())),c.items(a),c.selectedItem(a[b]))}}):groupReservationApi.createContactPerson(d).then(function(a){var b=new bergbahnGroupContactPartnerOptionModel(a);c.items().push(b),c.selectedItem(b)}),e.then(function(){var d=kp.get(c,"selectedTourOperator.contactPersonDefaultId",null);a?d=kp.get(c,"selectedItem.id"):kp.get(c,"selectedItem.id")==d&&(d=null),groupReservationApi.updateResellerDefaults(kp.get(c,"selectedTourOperator.key"),kp.get(c,"selectedTourOperator.travelagencyDefaultId",null),d).then(function(){c.selectedTourOperator().contactPersonDefaultId(d),$(b.element).find(".modal").modal("hide"),$(b.element).find("form").parsley().reset()})})})},c.closeModal=function(){$(b.element).find(".modal").modal("hide"),$(b.element).find("form").parsley().reset()},c.createDisabled=ko.computed(function(){var a=!c.selectedTourOperator().id;return a}),c.items=a.items,c.id=a.id,c.isRequired=a.isRequired,c.validationGroup=a.validationGroup,c};ko.components.register("contactperson-select",{viewModel:{createViewModel:function(a,b){return new ContactpersonSelect(a,b)}},template:{fromUrl:"assets/groupreservation/contactperson-select.html",maxCacheAge:1234}});var contingentReservationApi={getContingentAvailabilities:function(a){return $.ajax(serviceRootURL+"/contingentavailabilities",{type:"GET",data:a,dataType:"json",contentType:"application/json"}).fail(function(a,b,c){checkSession(a),console.log("Server error on loading restaurant availabilities: "+a.responseText),showError("Fehler beim Laden der Reservierungen",a,b,c)})},getRestaurantContingentAvailabilities:function(a,b,c,d,e){var f={restaurantId:a,from:c,until:d};return b&&(f.reservationId=b),this.getContingentAvailabilities(f)},getRoomsContingentAvailabilities:function(a,b,c,d,e){var f=this,g=[];return c.forEach(function(c){var h={restaurantId:a,roomId:c,from:d,until:e};b&&(h.reservationId=b),g.push(f.getContingentAvailabilities(h))}),$.when.apply($,g)}},ReservationContingentBlock=function(a,b){var c=this;return c.from=a.contingent.from,c.until=a.contingent.until,c.isSelected=a.contingent.isSelected,c.isDisabled=a.contingent.isDisabled,c.used=a.contingent.used,c.free=a.contingent.free,c.total=a.contingent.total,c.availability=a.contingent.availability,c.fromTimeLabel=a.contingent.fromTimeLabel,c.contingentTooltip=a.contingent.tooltipLabel,c.selectTimeInterval=a.selectTimeInterval,c.cssClasses=ko.computed(function(){return{"group-reservation-contingent__connection--red":c.availability()<RESERVATION_AVAILABILITY_TRESHHOLD_RED,"group-reservation-contingent__connection--orange":c.availability()>=RESERVATION_AVAILABILITY_TRESHHOLD_RED&&c.availability()<RESERVATION_AVAILABILITY_TRESHHOLD_ORANGE,"group-reservation-contingent__connection--green":c.availability()>=RESERVATION_AVAILABILITY_TRESHHOLD_ORANGE,"group-reservation-contingent__connection--selected":c.isSelected(),"group-reservation-contingent__connection--not-allowed":c.isDisabled()}}),c.stylesStatusBar=ko.computed(function(){return{width:c.availability()+"%"}}),c.selectTime=function(b){console.log("selectTime ..."),b.isDisabled()||c.selectTimeInterval(a.contingent)},c};ko.components.register("group-reservation-contingent-block",{viewModel:{createViewModel:function(a,b){return new ReservationContingentBlock(a,b)}},template:{fromUrl:"assets/groupreservation/contingent/group-reservation-contingent-block.html",maxCacheAge:1234}});var RESTAURANT_RESERVATION_TIME_INTERVAL_SLOT=15,RESTAURANT_RESERVATION_DEFAULT_DURATION=45,GroupReservationContingent=function(a,b){var c=this;c.messagesI18={selectRestaurant:i18n.t("groupReservation.restaurant.contingent.messages.selectRestaurant"),selectTime:i18n.t("groupReservation.restaurant.contingent.messages.selectTime"),selectDuration:i18n.t("groupReservation.restaurant.contingent.messages.selectDuration"),selectDate:i18n.t("groupReservation.restaurant.contingent.messages.selectDate"),emptyContingent:i18n.t("groupReservation.restaurant.contingent.messages.emptyResult")},c.componentInfo=b,c.showLoadingSpinner=ko.observable(!1),c.contingents=ko.observableArray(),c.restaurantId=a.restaurantId,c.restaurantReservationId=a.restaurantReservationId,c.from=a.from,c.until=a.until,c.isRestaurantLinkedToTrainOrder=a.isRestaurantLinkedToTrainOrder,c.selectedRestaurantContingentDate=ko.observable(new Date),c.selectedRestaurantMaxAvailablePax=a.selectedRestaurantMaxAvailablePax,c.selectedTrainContingentDate=ko.observable(),c.fromTime=ko.observable(),c.untilTime=ko.observable(),a.fromTime&&(c.fromTime=a.fromTime),a.untilTime&&(c.untilTime=a.untilTime),c.selectedRestaurantContingentDateFormatted=ko.computed(function(){return moment(c.selectedRestaurantContingentDate()).format("dddd, MMMM D, YYYY")}),a.selectedTimeInterval?(c.selectedTimeInterval=a.selectedTimeInterval,c.selectedTimeInterval(c.messagesI18.selectRestaurant)):c.selectedTimeInterval=ko.observable(c.messagesI18.selectRestaurant);var d=(new Date).setHours(0,RESTAURANT_RESERVATION_DEFAULT_DURATION);if(c.from()&&c.until()){var e=moment.duration(moment(c.until()).diff(moment(c.from()))).asMinutes();d=(new Date).setHours(0,e)}c.duration=ko.observable(moment(d).format("HH:mm")),c.gridScrollOffset=ko.observable(50),c.selectedIdx=null,c.isContingentError=ko.computed(function(){return!c.from()||!c.until()}),c.resetDateTime=function(){c.from(null),c.until(null),c.fromTime(null),c.untilTime(null)},c.animateScrollgrid=simpleDebounce(function(){$(c.componentInfo.element).find(".group-reservation-contingent__inner-connections-scroll").stop(!0).animate({scrollLeft:c.gridScrollOffset()+0},400)},400),c.updateGridScrollPosition=function(a){var b=78*a-45;c.gridScrollOffset(b),c.animateScrollgrid(),c.selectedIdx=a},c.updateIntervalLabel=function(a,b){c.from(moment(c.contingents()[a].from())),c.until(moment(c.contingents()[b].until()));var d=moment(c.from()).format("HH:mm"),e=moment(c.until()).format("HH:mm");c.fromTime(d),c.untilTime(e),c.selectedTimeInterval(d+" - "+e)},c.selectedRestaurantContingentDate.subscribe(function(){console.log("Date selected = "+c.selectedRestaurantContingentDate()),c.getAvailabilitiesForRestaurantId()}),c.selectedTrainContingentDate.subscribe(function(){c.selectedRestaurantContingentDate(moment(c.selectedTrainContingentDate().key()).toDate())}),c.restaurantId.subscribe(function(){console.log("Restaurant selected = "+c.restaurantId()),c.getAvailabilitiesForRestaurantId()}),c.duration.subscribe(function(){null!=c.selectedIdx&&c.selectedIdx>=0&&c.selectTimeInterval(c.contingents()[c.selectedIdx])});var f=moment((new Date).setHours(0,0,0,0));c.selectTimeInterval=function(a){console.log(a),endDate=moment(c.duration(),"HH:mm");var b=moment.duration(endDate.diff(f));if(console.log("durationMinutes=",b.asMinutes()),!(b.minutes()+b.hours())>0)return c.selectedTimeInterval(c.messagesI18.selectDuration),c.from(null),void c.until(null);var d,e,g,h=b.asMinutes()/RESTAURANT_RESERVATION_TIME_INTERVAL_SLOT;console.log("durationCount=",h);var i=null,j=null;c.contingents().forEach(function(b,c){b.isSelected(!1),b==a&&(b.isSelected(!0),g=c,d=c+h),d&&c<d&&(b.isSelected(!0),e=c,j=b.free()+b.overbookFree(),(null===i||j<i)&&(i=j))}),c.selectedRestaurantMaxAvailablePax(i),c.updateIntervalLabel(g,e),c.updateGridScrollPosition(g)},c.getAvailabilitiesForRestaurantId=function(){return c.restaurantId()?c.selectedRestaurantContingentDate()?(c.selectedTimeInterval("-"),c.showLoadingSpinner(!0),void contingentReservationApi.getRestaurantContingentAvailabilities(c.restaurantId(),c.restaurantReservationId(),moment(c.selectedRestaurantContingentDate()).startOf("day").format(),moment(c.selectedRestaurantContingentDate()).endOf("day").format()).done(function(a){if(c.showLoadingSpinner(!1),0==a.length)c.selectedTimeInterval(c.messagesI18.emptyContingent),c.contingents([]);else{var b=$.map(a,function(a){return new restaurantAvailabilitiesModel(a)});if(c.contingents(b),c.from()&&c.until()){var d=moment(c.from()).format(DATETIME_SERVER_FORMAT),e=moment(c.until()).format(DATETIME_SERVER_FORMAT),f=-1,g=-1,h=!1,i=null,j=null;c.contingents().forEach(function(a,b){a.from()===d&&(h=!0,g=b),a.isSelected(h),j=a.free()+a.overbookFree(),h&&(null===i||j<i)&&(i=j),a.until()===e&&(h=!1,f=b)}),c.selectedRestaurantMaxAvailablePax(i),g>-1&&f>-1?(c.updateIntervalLabel(g,f),c.updateGridScrollPosition(g)):c.resetDateTime()}c.fromTime()&&c.untilTime()?c.selectedTimeInterval(c.fromTime()+" - "+c.untilTime()):c.selectedTimeInterval(c.messagesI18.selectTime)}}).fail(function(){c.showLoadingSpinner(!1)})):void c.selectedTimeInterval(c.messagesI18.selectDate):void c.selectedTimeInterval(c.messagesI18.selectRestaurant)},a.selectedTrainContingentDate?c.selectedTrainContingentDate(a.selectedTrainContingentDate()):a.from&&a.from()&&c.selectedRestaurantContingentDate(a.from()),a.restaurantId()&&(c.restaurantId=a.restaurantId)};ko.components.register("group-reservation-contingent",{viewModel:{createViewModel:function(a,b){return new GroupReservationContingent(a,b)}},template:{fromUrl:"assets/groupreservation/contingent/group-reservation-contingent.html",maxCacheAge:1e3}}),ko.components.register("group-reservation-train-contingent",{viewModel:{createViewModel:function(a,b){return new GroupReservationContingent(a,b)}},template:{fromUrl:"assets/groupreservation/contingent/group-reservation-train-contingent.html",maxCacheAge:1e3}});var DebugModal=function(a,b){var c=this;return c.debug=ko.observable(a.debug),c.openModal=function(){c.debug(a.debug),$(b.element).find(".modal").modal("show")},c};ko.components.register("debug-modal",{viewModel:{createViewModel:function(a,b){return new DebugModal(a,b)}},template:{fromUrl:"assets/groupreservation/debug-modal.html",maxCacheAge:1234}});var gr={ui:{fillBootstrapSelectByKey:function(a,b,c,d,e){d||(d="optionValue"),$.each(a(),function(a,e){if(kp.get(e,d)==b)return c(e),!1})},getBootstrapSelectByKey:function(a,b,c,d){c||(c="optionValue");var e;return $.each(a(),function(a,d){if(kp.get(d,c)==b)return e=d,!1}),e}},sections:{stationHasAccommodation:function(a){return _.find(headerVM.accommodations(),function(b){return String(b.key)==String(a)})},searchByTrainDeferred:function(a,b,c){return b||(b=kp.get(a,"wagonClass",2)),$.Deferred(function(d){groupReservationApi.searchSectionsByValues(function(b,e){c&&c();var f=e[0];b?(f.selectedTrain(a),d.resolve(f)):d.reject()},ko.unwrap(a.stationFrom),ko.unwrap(a.stationTo),null,ko.unwrap(a.date),b)}).promise()},selectFirstPossibleTrains:function(a,b){var c=_.first(a);c&&gr.sections.selectFirstPossibleTrainOnSection(c,b),a.forEach(function(b,c){var d=a[c],e=a[c+1];if(e&&d){var f=kp.get(d,"selectedTrain");e.selectNextPossibleTrain(f)}})},selectTrainsByTime:function(a,b,c,d){if(c==BERGBAHN_GROUP_RESERVATION_SEARCH_TIME_TYPE_ARRIVAL){var e=_.last(a);if(!e)return;for(var f=e.trains().length-1;f>=0;f--){lastTrain=e.trains()[f];var g=moment(moment(lastTrain.arrivalTime()).format(MOMENTJS_DATE_SERVER_FORMAT)+" "+ko.unwrap(b));if(g.isAfter(lastTrain.arrivalTime())&&gr.trains.hasTrainEnoughSeats(lastTrain)){e.selectedTrain(lastTrain);break}}for(var f=a.length-1;f>=0;f--)if(sectionCurrent=a[f],sectionShouldBeBefore=a[f-1],sectionShouldBeAfter=a[f+1],!kp.get(sectionCurrent,"selectedTrain"))for(var h=sectionCurrent.trains().length-1;h>=0;h--)if(lastTrain=sectionCurrent.trains()[h],lastSelectedTrain=kp.get(sectionShouldBeAfter,"selectedTrain"),lastSelectedTrain){var g=moment(lastSelectedTrain.departureTime());if(ko.unwrap(lastSelectedTrain.date)!=ko.unwrap(lastTrain.date))continue;if(moment(lastSelectedTrain.departureTime()).isAfter(lastTrain.arrivalTime())&&gr.trains.hasTrainEnoughSeats(lastTrain)){sectionCurrent.selectedTrain(lastTrain);break}}}else if(c==BERGBAHN_GROUP_RESERVATION_SEARCH_TIME_TYPE_DEPARTURE){var i=_.first(a);if(!i)return;var g=moment(moment(i.date()).format(MOMENTJS_DATE_SERVER_FORMAT)+" "+ko.unwrap(b));if(d){var j=moment(d.arrivalTime(),DATETIME_SERVER_FORMAT);j.isSameOrAfter(g)&&(g=j)}i&&gr.sections.selectTrainOnSectionAfterDate(g,0,i),a.forEach(function(b,c){var d=a[c],e=a[c+1];a[c-1];if(e&&d){if(ko.unwrap(e.date)!=ko.unwrap(d.date))return;var f=kp.get(d,"selectedTrain");f&&e.selectNextPossibleTrain(f)}})}},fillSectionsByTrains:function(a,b){b||(b=2);parseInt(50/a.length);return a=_.sortBy(a,function(a){return moment(ko.unwrap(a.departureTime),DATETIME_SERVER_FORMAT).unix()}),$.Deferred(function(b){var c=[],d=b,e=[];a.forEach(function(a){c.push(gr.sections.searchByTrainDeferred(a,void 0,function(){d.notify(e)})),d.notify(e)}),$.when.apply($,c).then(function(){$.each(arguments,function(a,b){e.push(b)}),d.notify(e);var a=function(){for(var a=0;a<e.length;a++)if(!kp.get(e,a+".trains",[]).length)return!1;return!0};checkTrainsLoadedFn=function(){a()&&(clearInterval(c),b.resolve(e))};var c=setInterval(checkTrainsLoadedFn,300)},function(a){b.reject()})}).promise()},splitSectionsByTimeTableEntry:function(a,b,c){return $.Deferred(function(d){var e=!1,f=!1;if(a.forEach(function(a){kp.get(a,"stationFrom")==kp.get(c,"station")&&(e=!0,f=a)}),e){var g=a.indexOf(f),h=kp.get(c,"arrivalTime");h||(h=kp.get(c,"departureTime")),f=gr.sections.selectTrainOnSectionAfterDate(new Date(h),30,f),a.splice(g,1,f),d.resolve(a)}else{var i={},j={};if(g=a.indexOf(b),sectionNextIndex=a.indexOf(b)+1,i={from:ko.unwrap(b.stationFrom),to:ko.unwrap(c.station),date:new Date(ko.unwrap(b.date)),sections:[],finished:!1},j={from:ko.unwrap(c.station),to:kp.get(a,sectionNextIndex+"stationFrom",ko.unwrap(b.stationTo)),date:new Date(ko.unwrap(b.date)),sections:[],finished:!1},i&&j){var k=2;b.firstClassEnabled()&&(k=1);var l=$.Deferred(function(a){groupReservationApi.searchSectionsByValues(function(b,c){b?(i.sections=c,i.finished=!0,a.resolve(c)):a.reject()},i.from,i.to,null,i.date,k,!0)}).promise(),m=$.Deferred(function(a){groupReservationApi.searchSectionsByValues(function(b,c){b?(j.sections=c,j.finished=!0,a.resolve(c)):a.reject()},j.from,j.to,null,i.date,k,!0)}).promise();$.when(l,m).done(function(b,e){var f=kp.get(a,g+".selectedTrain.trainNumber");b[0]=gr.sections.selectTrainOnSectionByTrainNumber(b[0],f),e[0]=gr.sections.selectTrainOnSectionAfterDate(new Date(kp.get(c,"arrivalTime")),30,e[0]);var h=a;h.splice(g,1,b),h.splice(g+1,0,e),h=_.flatten(h),d.resolve(h)})}}}).promise()},addOvernightDayToSection:function(a){return $.Deferred(function(b){var c=moment(new Date(ko.unwrap(a.date))).add(1,"day").toDate();groupReservationApi.searchSectionsByValues(function(a,c){a?b.resolve(_.head(c)):b.reject()},ko.unwrap(a.stationFrom),ko.unwrap(a.stationTo),null,c,void 0,!0)}).promise()},splitSectionsForOvernightStay:function(a,b,c){return $.Deferred(function(d){for(var e=!1,f=!1,g=0;g<a.length;g++){var h=a[g];if(kp.get(h,"stationFrom")==kp.get(b,"stationFrom")&&kp.get(h,"stationTo")==kp.get(b,"stationTo")){e=!0,f=h;break}}if(e&&kp.get(c,"station")!==kp.get(f,"stationFrom")&&(e=!1),e){var i=a.indexOf(f),j=kp.get(c,"arrivalTime");j||(j=kp.get(c,"departureTime")),f=gr.sections.selectTrainOnSectionAfterDate(new Date(j),0,f),f.hasOvernightStay(!0),a.splice(i,1,f),d.resolve(a)}else{var k={},l={};i=a.indexOf(b),sectionNextIndex=a.indexOf(b)+1,k={from:ko.unwrap(b.stationFrom),to:ko.unwrap(c.station),date:new Date(ko.unwrap(b.date)),sections:[],finished:!1};var m=a[sectionNextIndex];if(m?stationToInsertTo=ko.unwrap(ko.unwrap(m.stationFrom)):(m=_.last(a),stationToInsertTo=ko.unwrap(ko.unwrap(m.stationTo))),l={from:ko.unwrap(c.station),to:stationToInsertTo,date:new Date(ko.unwrap(b.date)),sections:[],finished:!1},k&&l){var n=$.Deferred(function(a){groupReservationApi.searchSectionsByValues(function(b,c){b?(k.sections=c,k.finished=!0,a.resolve(c)):a.reject()},k.from,k.to,null,k.date)}).promise(),o=$.Deferred(function(a){groupReservationApi.searchSectionsByValues(function(b,c){b?(l.sections=c,l.finished=!0,a.resolve(c)):a.reject()},l.from,l.to,null,k.date)}).promise();$.when(n,o).done(function(b,e){var f=kp.get(a,i+".selectedTrain.trainNumber");b[0]=gr.sections.selectTrainOnSectionByTrainNumber(b[0],f),e[0]=gr.sections.selectTrainOnSectionAfterDate(new Date(kp.get(c,"arrivalTime")),0,e[0]),e[0].hasOvernightStay(!0);var g=a;g.splice(i,1,b),g.splice(i+1,0,e),g=_.flatten(g),d.resolve(g)})}}}).promise()},selectPossibleTrains:function(a){return a.forEach(function(b,c){var d=a[c],e=a[c+1];if(e&&d){var f=kp.get(d,"selectedTrain");f&&e.selectNextPossibleTrain(f)}}),a},selectPossibleTrainsAfterSection:function(a){var b=function(a,b){for(var c=a.indexOf(b),d=c;d<a.length;d++){var e=a[d],f=a[d+1];if(f&&e){var g=kp.get(e,"selectedTrain");g&&f.selectNextPossibleTrain(g)}}return a};groupReservationApi.root.selectedSectionsOutward(b(groupReservationApi.root.selectedSectionsOutward(),a)),groupReservationApi.root.selectedSectionsReturn(b(groupReservationApi.root.selectedSectionsReturn(),a)),gr.sections.selectPossibleReturnJourneysectionAfterOutward()},checkForOvernightStay:function(a){for(var b=kp.get(groupReservationApi.root,"selectedSectionsOutward",[]),c=kp.get(groupReservationApi.root,"selectedSectionsReturn",[]),d=0;d<b.length;d++){var e=b[d],f=b[d-1];e&&f&&ko.unwrap(e.date)!=ko.unwrap(f.date)&&e.hasOvernightStay(!0)}for(var d=0;d<c.length;d++){var e=c[d],f=c[d-1];f||(f=_.last(b)),e&&f&&ko.unwrap(e.date)!=ko.unwrap(f.date)&&e.hasOvernightStay(!0)}},selectPossibleReturnJourneysectionAfterOutward:function(){var a=kp.get(groupReservationApi.root,"selectedSectionsOutward",[]),b=kp.get(groupReservationApi.root,"selectedSectionsReturn",[]);if(a.length&&b.length){var c=_.last(a),d=_.head(b);if(c&&d){var e=kp.get(c,"selectedTrain");e&&(d.selectNextPossibleTrain(e),gr.sections.selectPossibleTrains(b))}}},selectTrainOnSectionByTrainNumber:function(a,b){var c=null;return ko.unwrap(a.trains).forEach(function(a,d){ko.unwrap(a.trainNumber)==b&&(c=a)}),null!==c&&a.selectedTrain(c),a},selectTrainOnSectionAfterDate:function(a,b,c){for(var a=moment(a).add(b,"minutes"),d=ko.unwrap(c.trains),e=_.last(d),f=0;f<d.length;f++)if(d[f].departsAfterDate(a)&&gr.trains.hasTrainEnoughSeats(d[f])){e=d[f];break}return c.selectedTrain(e),c},selectFirstPossibleTrainOnSection:function(a,b){for(var c=kp.get(a,"trains",[]),d=0;d<c.length;d++){var e=c[d];if((!b||e.departsAfter(b))&&gr.trains.hasTrainEnoughSeats(e))return void a.selectedTrain(e)}return a},hasATrainSelected:function(a){if(a)for(var b=0;b<a.length;b++)if(kp.get(a[b],"selectedTrain"))return!0;return!1},unselectTrains:function(a){if(a)for(var b=0;b<a.length;b++)a[b].selectedTrain(null)}},trains:{mapTrainUnique:function(a){return kp.get(a,"stationFrom")+"|"+moment(kp.get(a,"date")).format(MOMENTJS_DATE_SERVER_FORMAT)+"|"+kp.get(a,"trainNumber")},hasTrainEnoughSeats:function(a){var b=kp.get(a,"freeSeats",0),c=kp.get(a,"freeHandicapSeats",0),d=kp.get(a,"freeOverbookingContingent",0),e=kp.get(a,"freeOverbookingReserveSeats",0),f=kp.get(groupReservationApi.root.reservationOrder,"id"),g=gr.trains.mapTrainUnique(a);if(f&&g){var h=_.map(ko.toJS(kp.get(groupReservationApi.root.reservationOrder,"bergbahnReservation.outwardJourney.trains",[])),gr.trains.mapTrainUnique),i=_.map(ko.toJS(kp.get(groupReservationApi.root.reservationOrder,"bergbahnReservation.returnJourney.trains",[])),gr.trains.mapTrainUnique);if(-1!==h.indexOf(g)||-1!==i.indexOf(g)){var j=parseInt(kp.get(groupReservationApi.root.reservationOrder,"bergbahnReservation.numberOfSeats",0)),k=parseInt(kp.get(groupReservationApi.root.reservationOrder,"bergbahnReservation.numberOfHandicapSeats",0));b+=j,c+=k}}
return!(b+d+e<groupReservationApi.root.selectedSeats()||c<groupReservationApi.root.selectedHandicapSeats())}},restaurants:{restaurantById:function(a){!isNaN(a)&&headerVM.reservationRestaurants&&headerVM.reservationRestaurants()&&headerVM.reservationRestaurants().find(function(b){return parseInt(ko.unwrap(b.key))==parseInt(a)})}},texts:{textCache:{},resolveByIds:function(a){return $.Deferred(function(b){for(var c=[],d=a,e=0;e<d.length;e++){var f=d[e];!_.get(gr.texts.textCache,f)&&f&&c.push(groupReservationApi.getText(f,function(a){_.set(gr.texts.textCache,kp.get(a,"key"),a)}))}$.when.apply($,c).then(function(){for(var a=[],c=0;c<d.length;c++){var e=_.get(gr.texts.textCache,d[c]);e&&a.push(e)}b.resolve(a)})}).promise()}}};ko.components.register("icon",{viewModel:function(a){var b=this;b.iconName=ko.observable(!1),b.iconSize=ko.observable("md"),b.enabled=ko.observable(!0),b.iconClasses=ko.observable(),void 0!==a.enabled&&(b.enabled=a.enabled);var c=Object.keys(a)[0];"icon"===c?(b.iconName(a.icon),a.size&&b.iconSize(a.size)):b.iconName(c),String(b.iconName()).startsWith("icon--")||b.iconName("icon--"+b.iconName()),b.iconClasses=ko.computed(function(){var a="";return 0==b.enabled()&&(a="inactive"),b.iconName()+" icon--"+b.iconSize()+" "+a})},template:'<span class="icon" data-bind="css: iconClasses"></span>'}),ko.components.register("icon-xs",{viewModel:function(a){var b=this;b.iconName=ko.observable(Object.keys(a)[0]),b.enabled=void 0!==a.enabled?a.enabled:ko.observable(!0)},template:'\x3c!-- ko component: { name:"icon", params: { icon: iconName(), size: "xs", enabled: enabled } } --\x3e \x3c!-- /ko --\x3e '});var ProgressBarModel=function(a,b){var c=this;c.percent=a.percent,c.barStyles=ko.computed(function(){return{width:c.percent()+"%"}}),c.barLabel=ko.computed(function(){return c.percent()+" %"})};ko.components.register("progress-bar",{viewModel:{createViewModel:function(a,b){return new ProgressBarModel(a,b)}},template:'<div class="progress">\n                <div class="progress-bar" data-bind="style: barStyles, text: barLabel" role="progressbar"></div>            </div>'});var ReservationGridRoute=function(a,b){var c=this;$(b.element).on("refresh:grid-position",function(){c.updateGridScrollPosition()}),c.journeyComment=a.journeyComment,c.previousSections=a.previousSections,c.previousSections&&(c.previousGridSection=c.previousSections()[c.previousSections().length-1]),c.nextSections=a.nextSections,void 0!==c.nextSections&&c.nextSections()&&(c.nextGridSection=c.nextSections()[0]),c.route=a.route,c.isLoading=a.isLoading,c.sections=a.sections,c.label=a.label,c.componentInfo=b,c.gridWorking=ko.observable(!1),c.toggleGridWorking=simpleDebounce(function(){var a=!0;kp.get(c,"sections",[]).forEach(function(b){b.isLoading()&&(a=!1)}),a?c.gridWorking(!1):(c.gridWorking(!0),setTimeout(function(){c.toggleGridWorking()},50))},50),c.gridWorking(!0),c.toggleGridWorking(),c.gridScrollOffset=ko.observable(0),c.styleScrollGrid=ko.computed(function(){return{paddingLeft:c.gridScrollOffset()+"px"}}),c.animateScrollgrid=simpleDebounce(function(){var a=kp.get(c,"sections.0.selectedTrain",0),b=kp.get(c,"sections.0.trains",[]).indexOf(a);$(c.componentInfo.element).find(".reservation-grid__inner-connections-scroll").stop(!0).animate({scrollLeft:c.gridScrollOffset()+140*b-70},400),c.toggleGridWorking(!1)},400),c.updateGridScrollPosition=function(){var a=0;$.each(c.sections(),function(b,c){c.sectionOffset()>a&&(a=c.sectionOffset())}),c.gridScrollOffset(a),c.animateScrollgrid()},c.firstReturnJourneySection=ko.computed(function(){var a=_.head(kp.get(groupReservationApi.root,"selectedSectionsReturn",[]));return!!a&&ko.unwrap(a)}),c.toggleTimeTables=function(a,b){a.timeTableEnabled(!a.timeTableEnabled()),c.updateSize(a,b)},c.switchSectionClass=function(a,b){groupReservationApi.root.screenWorking(!0);var d=kp.get(a,"firstClassEnabled",!1),e=[],f=function(a){return a.hasFirstClass()&&a.firstClassEnabled(d),e.push(a.fetchTrainsDeferred()),a};groupReservationApi.root.selectedSectionsReturn().forEach(f),groupReservationApi.root.selectedSectionsOutward().forEach(f),$.when.apply(null,e).done(function(){groupReservationApi.root.screenWorking(!1),c.updateSize(a,b)})},c.updateSize=function(a,b){c.gridWorking(!0);var d=$(b.currentTarget),e=function(){var b=d.parents(".reservation-grid__connection-title");a.sectionDisplayHeight(b.innerHeight())};setTimeout(function(){e(),setTimeout(function(){e()},200)},10)},c.classesSectionTitle=function(a,b){var c={"is-expanded":a.timeTableEnabled,"is-closed":!a.timeTableEnabled};return c["has-overnight-stay"]=ko.unwrap(a.hasOvernightStay)&&b>0,c},c.updateSections=function(a,b,d){c.gridWorking(!0);var e=ko.unwrap(c.sections),f=ko.unwrap(d.section),g=ko.unwrap(d.timeTableEntry);gr.sections.splitSectionsByTimeTableEntry(e,f,g).done(function(a){c.sections(a),c.sections(gr.sections.selectPossibleTrains(c.sections())),gr.sections.selectPossibleReturnJourneysectionAfterOutward(),c.toggleGridWorking(!1)})},c.addOvernightStay=function(a,b,d){var e=ko.unwrap(c.sections),f=ko.unwrap(d.section),g=ko.unwrap(d.timeTableEntry);groupReservationApi.root.screenWorking(!0),gr.sections.splitSectionsForOvernightStay(e,f,g).done(function(a){c.sections(a),groupReservationApi.changeOvernightStaySections().done(function(){c.sections(gr.sections.selectPossibleTrains(c.sections()));var a=kp.get(groupReservationApi.root,"selectedSectionsOutward",[]),b=kp.get(groupReservationApi.root,"selectedSectionsReturn",[]);if(a.length&&b.length){var d=kp.get(_.last(a),"date"),e=kp.get(_.head(b),"date");d==e&&null!==e&&gr.sections.selectPossibleReturnJourneysectionAfterOutward()}groupReservationApi.root.screenWorking(!1)})})},c.triggerOverNightStayForFirstReturn=function(){var a=_.head(kp.get(groupReservationApi.root,"selectedSectionsReturn",{})),b=kp.get(a,"selectedTrain",{});return groupReservationApi.root.screenWorking(!0),groupReservationApi.getTrainDetails(function(d){b.timeTableEntries(d);var e={section:a,timeTableEntry:_.head(d)};c.addOvernightStay({},{},e)},b,new Date(b.date())),!1},c.allowOvernightStay=function(){var a=_.head(ko.unwrap(c.sections)),b=_.head(kp.get(groupReservationApi.root,"selectedSectionsReturn",[])),d=kp.get(_.head(ko.unwrap(c.sections)),"selectedTrain",!1),e=!1;return a&&b&&ko.unwrap(a.stationFrom)==ko.unwrap(b.stationFrom)&&(e=!0),!(a&&!gr.sections.stationHasAccommodation(ko.unwrap(a.stationFrom)))&&!groupReservationApi.root.hasLayover()&&e&&groupReservationApi.root.enableChangeTrains()&&d}};ko.components.register("reservation-grid-route",{viewModel:{createViewModel:function(a,b){return new ReservationGridRoute(a,b)}},template:{fromUrl:"assets/groupreservation/reservation-grid-route.html",maxCacheAge:1234}});var ReservationGridSection=function(a,b){var c=this;return c.componentInfo=b,$(b.element).on("refresh:section-offset",function(){c.calculateSectionOffset()}),c.index=a.index,c.section=a.section,c.previousSection=a.previousSection,c.nextSection=a.nextSection,c.firstSection=a.firstSection,c.hasOvernightStay=ko.computed(function(){return ko.unwrap(c.section.hasOvernightStay)&&ko.unwrap(c.index)>0}),c.calculateSectionOffset=function(){if(void 0!==c.firstSection()&&kp.get(c.firstSection,"selectedTrain")){var b=c.firstSection().trains().indexOf(kp.get(c.firstSection,"selectedTrain"))+1,d=c.section.trains().indexOf(c.section.selectedTrain())+1,e=b-d;c.offset(-1*e*140),a.section.sectionOffset(140*e),$(c.componentInfo.element).trigger("updateGridScrollPosition")}$(c.componentInfo.element).trigger("updateGridScrollPosition")},c.offset=ko.observable(0),c.updateSectionOffsetIndex=simpleDebounce(function(){c.calculateSectionOffset()},3e3),a.section.selectedTrain.subscribe(function(){c.calculateSectionOffset()}),c.styleReservationGridSection=ko.computed(function(){return $(c.componentInfo.element).trigger("updateGridScrollPosition"),{marginLeft:-1*c.offset()+"px",height:c.section.sectionDisplayHeight()+"px"}}),c};ko.components.register("reservation-grid-section",{viewModel:{createViewModel:function(a,b){return new ReservationGridSection(a,b)}},template:{fromUrl:"assets/groupreservation/reservation-grid-section.html",maxCacheAge:1234}});var ReservationGridTrainTimeTable=function(a,b){var c=this;return c.componentInfo=b,c.section=a.section,c.selectedTrain=c.section.selectedTrain,c.isFetchingTimeTableEntries=ko.observable(!1),c.eventUpdateSize=function(){$(b.element).trigger("updateSize",{section:c.section})},c.eventUpdateSections=function(a){$(b.element).trigger("updateSections",{section:ko.unwrap(c.section),timeTableEntry:a,timeTableEntries:kp.get(c.selectedTrain,"timeTableEntries",[])})},c.eventUpdateSectionsOvernightStay=function(a){$(b.element).trigger("updateSectionsOvernightStay",{section:ko.unwrap(c.section),timeTableEntry:a,timeTableEntries:kp.get(c.selectedTrain,"timeTableEntries",[])})},c.fetchTimeTableEntries=function(){c.eventUpdateSize(),c.selectedTrain().timeTableEntries().length>0||(c.isFetchingTimeTableEntries(!0),groupReservationApi.getTrainDetails(function(a){c.selectedTrain().timeTableEntries(a),c.isFetchingTimeTableEntries(!1),c.eventUpdateSize()},c.selectedTrain(),new Date(c.selectedTrain().date())))},c.selectedTrain.subscribe(function(){c.fetchTimeTableEntries()}),c.selectedTrain()&&c.fetchTimeTableEntries(),c.eventUpdateSize(),c.allowOvernightStay=function(a){var b=_.head(kp.get(groupReservationApi.root,"selectedSectionsOutward",[]));return(!b||ko.unwrap(b.stationFrom)!=ko.unwrap(a.station))&&(!!gr.sections.stationHasAccommodation(ko.unwrap(a.station))&&!groupReservationApi.root.hasLayover())},c};ReservationGridTrainTimeTable.prototype.dispose=function(){this.eventUpdateSize()},ko.components.register("reservation-grid-train-timetable",{viewModel:{createViewModel:function(a,b){return new ReservationGridTrainTimeTable(a,b)}},template:{fromUrl:"assets/groupreservation/reservation-grid-train-timetable.html",maxCacheAge:1234}});var ReservationGridTrain=function(a,b){var c=this;return c.componentInfo=b,c.trainNumber=a.train.trainNumber,c.trainTimeLabel=a.train.trainTimeLabel,c.currentTrain=a.train,c.trainTooltip=ko.observable(),c.hookTooltip=function(){c.trainTooltip(c.currentTrain.tooltipLabel())},c.hookNotEnouthSeatsTooltip=function(){c.trainTooltip(c.currentTrain.tooltipNotEnoughSeatsLabel())},c.destroyTooltip=function(){c.trainTooltip(null)},c.currentSection=a.currentSection,c.currentSectionSelectedTrain=c.currentSection.selectedTrain,c.currentSection.selectedTrain()&&kp.get(c.currentSection,"selectedTrain.trainNumber")==kp.get(a.train,"trainNumber")&&(c.currentTrain.id(c.currentSection.selectedTrain().id()),c.currentSection.selectedTrain(c.currentTrain),$(b.element).trigger("updateSelectedTrains"),$(b.element).trigger("updateSectionOffsetIndex")),c.currentSectionSelectedTrain.subscribe(function(){$(b.element).trigger("updateSelectedTrains")}),c.previousSection=a.previousSection,c.nextSection=a.nextSection,c.isDisabled=ko.computed(function(){return c.destroyTooltip(),kp.get(c.previousSection,"selectedTrain")&&c.previousSection().selectedTrain().departsBefore(c.currentTrain)?(c.currentTrain.isValidSelection(!1),!0):gr.trains.hasTrainEnoughSeats(a.train)?(c.hookTooltip(),c.currentTrain.isValidSelection(!0),!1):(c.hookNotEnouthSeatsTooltip(),c.currentTrain.isValidSelection(!1),!0)}),c.availability=a.train.availabilityPercent(),c.cssClasses=ko.computed(function(){var b=!1;return c.currentSection.selectedTrain()==a.train&&(b=!0),{"reservation-grid__connection--red":c.availability<RESERVATION_AVAILABILITY_TRESHHOLD_RED,"reservation-grid__connection--orange":c.availability>=RESERVATION_AVAILABILITY_TRESHHOLD_RED&&c.availability<RESERVATION_AVAILABILITY_TRESHHOLD_ORANGE,"reservation-grid__connection--green":c.availability>=RESERVATION_AVAILABILITY_TRESHHOLD_ORANGE,"reservation-grid__connection--selected":b,"reservation-grid__connection--not-allowed":c.isDisabled}}),c.stylesStatusBar=ko.computed(function(){return{width:c.availability+"%"}}),c.selectTrain=function(){c.isDisabled()||(c.currentSection.selectedTrain(c.currentTrain),c.nextSection()&&gr.sections.selectPossibleTrainsAfterSection(ko.unwrap(c.currentSection)))},c.trainId="qa-gr--train-"+a.train.trainNumber(),c};ReservationGridTrain.prototype.dispose=function(){this.destroyTooltip()},ko.components.register("reservation-grid-train",{viewModel:{createViewModel:function(a,b,c,d,e){return new ReservationGridTrain(a,b)}},template:{fromUrl:"assets/groupreservation/reservation-grid-train.html",maxCacheAge:1234}});var ReservationGridModel=function(a,b){var c=this;c.subscriptions=[],c.sectionsOutward=ko.observableArray([]),c.sectionsReturn=ko.observableArray([]),ko.utils.domNodeDisposal.addDisposeCallback(b.element,function(){console.log("reservation-grid component destroyed"),c.subscriptions.forEach(function(a){a.dispose()})});var d=$(b.element);d.on("refresh:train-positions",function(){c.refreshTrainPositions()}),c.refreshTrainPositions=function(){console.log("Refresh <reservation-grid/> Train Positions"),d.find("reservation-grid-section").trigger("refresh:section-offset"),d.find("reservation-grid-route").trigger("refresh:grid-position")},c.sectionsOutward.subscribe(function(){c.sectionsOutward()&&a.selectedSectionsOutward(c.sectionsOutward())}),c.sectionsReturn.subscribe(function(){void 0!==c.sectionsReturn()&&a.selectedSectionsReturn(c.sectionsReturn())}),a.selectedSectionsOutward.subscribe(function(){c.sectionsReturn(a.selectedSectionsReturn())}),a.selectedSectionsOutward.subscribe(function(){c.sectionsReturn(a.selectedSectionsReturn())}),c.isFetchingOutwardSectionsOnly=ko.observable(!1),c.isFetchingReturnSectionsOnly=ko.observable(!1),c.isFetchingOutwardSections=ko.observable(!1),c.isFetchingReturnSections=ko.observable(!1),c.fillSectionsWithTrains=function(a,b){$.each(a,function(a,c){$.each(b,function(a,b){$.each(kp.get(c,"trains",[]),function(a,d){gr.trains.mapTrainUnique(b)==gr.trains.mapTrainUnique(d)&&(c.selectedTrain(d),1==d.wagonClass()?c.firstClassEnabled(!0):c.firstClassEnabled(!1))})})})},c.loadAndRenderSectionsAndTrains=function(b){if(!1!==c.searchQuery()){if(b)return c.sectionsOutward(a.selectedSectionsOutward()),void c.sectionsReturn(a.selectedSectionsReturn());groupReservationApi.clearRequests(),c.sectionsOutward([]),c.sectionsReturn([]),c.isFetchingOutwardSections(!0),c.isFetchingReturnSections(!0),c.isFetchingOutwardSectionsOnly(!0),c.isFetchingReturnSectionsOnly(!0);var d=kp.get(a.reservationOrder,"id"),e=kp.get(a.searchQuery,"loadReservation");if(d&&e){var f=kp.get(a.reservationOrder,"bergbahnReservation.outwardJourney.trains",[]),g=kp.get(a.reservationOrder,"bergbahnReservation.returnJourney.trains",[]),h=[];h.push($.Deferred(function(b){gr.sections.fillSectionsByTrains(f,parseInt(kp.get(a.reservationOrder,"bergbahnReservation.productClassKey",2))).done(function(a){c.sectionsOutward(a),b.resolve()}).progress(function(a){c.sectionsOutward(a),a.length&&c.isFetchingOutwardSectionsOnly(!1)}).fail(function(){c.sectionsOutward([]),c.searchQuery().hasFailed(!0),b.reject()})}).promise()),h.push($.Deferred(function(b){gr.sections.fillSectionsByTrains(g,parseInt(kp.get(a.reservationOrder,"bergbahnReservation.productClassKey",2))).done(function(a){c.sectionsReturn(a),b.resolve()}).progress(function(a){c.sectionsReturn(a),a.length&&c.isFetchingReturnSectionsOnly(!1)}).fail(function(){c.sectionsReturn([]),c.searchQuery().hasFailed(!0),b.reject()})}).promise()),$.when.apply($,h).then(function(){groupReservationApi.root.trainsNonDirty(!1),gr.sections.checkForOvernightStay(),c.isFetchingOutwardSections(!1),c.isFetchingOutwardSectionsOnly(!1),c.isFetchingReturnSections(!1),c.isFetchingReturnSectionsOnly(!1),c.refreshTrainPositions()},function(a){})}else{var h=[];h.push($.Deferred(function(a){groupReservationApi.searchSections(c.searchQuery().outwardFrom,c.searchQuery().outwardTo,c.searchQuery().outwardVia,c.searchQuery().reservationDate).done(function(b){a.resolve(b)}).progress(function(a){c.sectionsOutward(a),a.length&&c.isFetchingOutwardSectionsOnly(!1)}).fail(function(){c.sectionsOutward([]),c.searchQuery().hasFailed(!0)})}).promise()),h.push($.Deferred(function(a){groupReservationApi.searchSections(c.searchQuery().returnFrom,c.searchQuery().returnTo,c.searchQuery().returnVia,c.searchQuery().reservationDate).done(function(b){a.resolve(b)}).progress(function(a){c.sectionsReturn(a),a&&a.length&&c.isFetchingOutwardSectionsOnly(!1)}).fail(function(){c.sectionsReturn([]),c.searchQuery().hasFailed(!0)})}).promise()),$.when.apply($,h).then(function(b,e){groupReservationApi.root.selectedOutwardTime()?gr.sections.selectTrainsByTime(b,groupReservationApi.root.selectedOutwardTime(),groupReservationApi.root.outwardJourneySearchTimeType()):d?(c.fillSectionsWithTrains(b,kp.get(a.reservationOrder,"bergbahnReservation.outwardJourney.trains",[])),!gr.sections.hasATrainSelected(b)&&b&&gr.sections.selectTrainsByTime(b,groupReservationApi.root.selectedOutwardTime(),groupReservationApi.root.outwardJourneySearchTimeType())):b&&gr.sections.selectFirstPossibleTrains(b),c.sectionsOutward(b),!gr.sections.hasATrainSelected(b)&&b&&showError(i18n.t("groupReservation.msg.alertReservationTrainSelection"));var f=kp.get(_.last(c.sectionsOutward()),"selectedTrain");groupReservationApi.root.selectedReturnTime()?gr.sections.selectTrainsByTime(e,groupReservationApi.root.selectedReturnTime(),groupReservationApi.root.returnJourneySearchTimeType(),f):d&&e?(c.fillSectionsWithTrains(e,kp.get(a.reservationOrder,"bergbahnReservation.returnJourney.trains",[])),!gr.sections.hasATrainSelected(e)&&e&&gr.sections.selectTrainsByTime(e,groupReservationApi.root.selectedReturnTime(),groupReservationApi.root.returnJourneySearchTimeType(),f)):e&&gr.sections.selectFirstPossibleTrains(e,f),c.sectionsReturn(e),!gr.sections.hasATrainSelected(e)&&e&&showError(i18n.t("groupReservation.msg.alertReservationTrainSelection")),c.isFetchingOutwardSections(!1),c.isFetchingOutwardSectionsOnly(!1),c.isFetchingReturnSections(!1),c.isFetchingReturnSectionsOnly(!1),c.refreshTrainPositions()},function(a){})}}},c.searchQuery=a.searchQuery,c.subscriptions.push(c.searchQuery.subscribe(function(a){c.loadAndRenderSectionsAndTrains()})),c.isLoading=ko.computed(function(){var a=c.isFetchingOutwardSections()||c.isFetchingReturnSections();return c.searchQuery()&&c.searchQuery().isLoading(a),a}),c.isLoadingSections=ko.computed(function(){return c.isFetchingOutwardSectionsOnly()&&c.isFetchingReturnSectionsOnly()});var e=function(){c.isLoading()||c.sectionsOutward()&&(gr.sections.unselectTrains(c.sectionsOutward()),gr.sections.selectTrainsByTime(c.sectionsOutward(),groupReservationApi.root.selectedOutwardTime(),groupReservationApi.root.outwardJourneySearchTimeType()))},f=function(){c.isLoading()||c.sectionsReturn()&&(gr.sections.unselectTrains(c.sectionsReturn()),gr.sections.selectTrainsByTime(c.sectionsReturn(),groupReservationApi.root.selectedReturnTime(),groupReservationApi.root.returnJourneySearchTimeType()))};groupReservationApi.root.outwardJourneySearchTimeType.subscribe(e),groupReservationApi.root.selectedOutwardTime.subscribe(e),groupReservationApi.root.returnJourneySearchTimeType.subscribe(f),groupReservationApi.root.selectedReturnTime.subscribe(f),c.increasePercentByDelay=function(a){var b=function(){a(parseInt(a()+Math.floor(2*Math.random()+1))),setTimeout(b,Math.floor(1e3*Math.random()+550))};setTimeout(b,250)},c.outwardLabel=ko.computed(function(){if(c.sectionsOutward()&&c.sectionsOutward().length)return i18n.t("groupReservation.detail.journeyOutward.label")+" "+c.sectionsOutward()[0].displayDate()}),c.returnLabel=ko.computed(function(){if(c.sectionsReturn()&&c.sectionsReturn().length)return i18n.t("groupReservation.detail.journeyReturn.label")+" "+c.sectionsReturn()[0].displayDate()}),c.loadAndRenderSectionsAndTrains(!0)};ko.components.register("reservation-grid",{viewModel:{createViewModel:function(a,b){return new ReservationGridModel(a,b)}},template:{fromUrl:"assets/groupreservation/reservation-grid.html",maxCacheAge:1234}});var ReservationQuickoverviewRoute=function(a,b){var c=this;c.reservationOrder=a.reservationOrder,c.highlight=a.highlight,c.tripTypeClass=ko.computed(function(){var a=kp.get(c.reservationOrder,"bergbahnReservation.productTripType");return a||(a="O"),{retour:a==BERGBAHN_TRIP_TYPE_TWO_WAY,simple:a==BERGBAHN_TRIP_TYPE_ONE_WAY,roundtrip:a==BERGBAHN_TRIP_TYPE_ROUNDTRIP,abo:a==BERGBAHN_TRIP_TYPE_ABO}}),c.displayRoute=ko.computed(function(){var a=function(a){var b=ko.unwrap(a.trains);b||(b=[]);var c="";return b.forEach(function(a){var b=a.displayDepartureTime,d=a.displayArrivalTime;c+=b+" "+ko.unwrap(a.stationFromName)+" - "+d+" "+ko.unwrap(a.stationToName)+"<br>"}),c},d=ko.toJS(kp.get(c.reservationOrder,"bergbahnReservation.outwardJourney",{})),e=ko.toJS(kp.get(c.reservationOrder,"bergbahnReservation.returnJourney",!1)),f="";f=e?a(d)+"<br>"+a(e):a(d),$(b.element).find(".js-reservation-quickoverview").html(f)})};ko.components.register("reservation-quickoverview-route",{viewModel:{createViewModel:function(a,b){return new ReservationQuickoverviewRoute(a,b)}},template:'<div class="reservation-quickoverview__triptype"><span class="reservation-quickoverview__triptype-icon" data-bind="css: tripTypeClass"></span><span class="js-reservation-quickoverview reservation-quickoverview__triptype-c ption" data-bind="highlight: highlight"></span></div>'});var ReservationQuickoverviewTrainnumbers=function(a,b){var c=this;c.reservationOrder=a.reservationOrder,c.highlight=a.highlight,c.separator1="<br>",c.separator2="<br><br>",a.separator1&&(c.separator1=a.separator1),a.separator2&&(c.separator2=a.separator2),c.displayRoute=ko.computed(function(){var a=function(a){var b=ko.unwrap(a.trains);b||(b=[]);var d=[];return b.forEach(function(a){-1===d.indexOf(a.trainNumber)&&d.push(ko.unwrap(a.trainNumber))}),d.join(c.separator1)},d=ko.toJS(kp.get(c.reservationOrder,"bergbahnReservation.outwardJourney",{})),e=ko.toJS(kp.get(c.reservationOrder,"bergbahnReservation.returnJourney",!1)),f="";f=e?a(d)+c.separator2+a(e):a(d),$(b.element).find(".js-reservation-quickoverview").html(f)})};ko.components.register("reservation-quickoverview-trainnumbers",{viewModel:{createViewModel:function(a,b){return new ReservationQuickoverviewTrainnumbers(a,b)}},template:'<span class="js-reservation-quickoverview" data-bind="highlight: highlight"></span>'});var ReservationQuickoverviewModel=function(a,b){var c=this;c.reservationOrder=a.reservationOrder,c.displayStatus=ko.computed(function(){return i18n.t("groupReservation.quickoverview.displayStatus."+kp.get(c.reservationOrder,"bergbahnReservation.status",""))}),c.momentDeparture=function(){var a=_.head(kp.get(c.reservationOrder,"bergbahnReservation.outwardJourney.trains",[]));return a&&(departureTime=kp.get(a,"departureTime"),departureTime)?moment(departureTime,DATETIME_SERVER_FORMAT):null},c.momentArrival=function(){var a=_.last(kp.get(c.reservationOrder,"bergbahnReservation.outwardJourney.trains",[])),b=_.last(kp.get(c.reservationOrder,"bergbahnReservation.returnJourney.trains",[]));return trainToTake=a,b&&(trainToTake=b),trainToTake&&(arrivalTime=kp.get(trainToTake,"arrivalTime"),arrivalTime)?moment(arrivalTime,DATETIME_SERVER_FORMAT):null},c.switchToReservation=function(){groupReservationApi.root.openReservation()},c.displayType=ko.computed(function(){return kp.get(c.reservationOrder,"bergbahnReservation.productClassKey","")+". Kl"}),c.displayFrom=ko.computed(function(){var a=c.momentDeparture();return a?a.format(DATETIME_DISPLAY_FORMAT+" HH:mm"):"-"}),c.displayTo=ko.computed(function(){var a=c.momentArrival();return a?a.format(DATETIME_DISPLAY_FORMAT+" HH:mm"):"-"}),c.displayTripDuration=ko.computed(function(){if(c.momentArrival()){var a=moment.duration(c.momentArrival().diff(c.momentDeparture()));return function(a,b){var c=moment.duration(a,b),d=[];return c.days()>0&&(d.push(c.days()+"d"),c.subtract(c.days(),"days")),c.hours()>0&&(d.push(c.hours()+"h"),c.subtract(c.hours(),"hours")),c.minutes()>0&&d.push(c.minutes()+"m"),1===d.length?d[0]:d.join(" ")}(a,a.asMinutes())}}),c.displayReservation=ko.computed(function(){var a=gr.restaurants.restaurantById(kp.get(c.reservationOrder,"restaurantReservation.restaurantId"));return a?kp.get(a,"value"):kp.get(groupReservationApi.root,"selectedRestaurant.value",i18n.t("groupReservation.quickoverview.none"))}),c.displayOvernightStay=ko.observable(i18n.t("groupReservation.quickoverview.none")),c.fetchOverNightStayByReservationOrder=function(){var a=kp.get(c.reservationOrder,"bergbahnReservation.outwardJourney.trains",[]),b=kp.get(c.reservationOrder,"bergbahnReservation.returnJourney.trains",[]),d=_.last(a),e=null,f=function(a,b){for(var c=0;c<a.length;c++){var d=a[c],f=a[c-1];!f&&b&&(f=b),d&&f&&ko.unwrap(d.date)!=ko.unwrap(f.date)&&(e=d)}};f(a),f(b,d),e&&c.displayOvernightStay(kp.get(e,"stationFromName"))},c.reservationOrder.subscribe(simpleDebounce(function(){c.fetchOverNightStayByReservationOrder()}),500),c.fetchOverNightStayByReservationOrder(),c.showNoShowButton=ko.computed(function(){return 1==headerVM.noShowAllowed()&&(null==c.reservationOrder()||null!=c.reservationOrder()&&(c.reservationOrder().forwardOrderDisplayState()==GROUP_RESERVATION_ORDER_DISPLAY_STATE_BOOKED||c.reservationOrder().forwardOrderDisplayState()==GROUP_RESERVATION_ORDER_DISPLAY_STATE_BOOKED_NO_SHOW||c.reservationOrder().forwardOrderDisplayState()==GROUP_RESERVATION_ORDER_DISPLAY_STATE_CONFIRMED||c.reservationOrder().forwardOrderDisplayState()==GROUP_RESERVATION_ORDER_DISPLAY_STATE_CONFIRMED_NO_SHOW))}),c.toggleNoShow=function(){groupReservationVM.toggleNoShow()},c.showUpdateSurchargeButton=headerVM.updateSurchargeAllowed,c.toggleUpdateSurcharge=function(){groupReservationVM.toggleUpdateSurcharge()}};ko.components.register("reservation-quickoverview",{viewModel:{createViewModel:function(a,b){return new ReservationQuickoverviewModel(a,b)}},template:{fromUrl:"assets/groupreservation/reservation-quickoverview.html",maxCacheAge:1234}});var MIN_CHARACTERS_SEARCH=2,SEARCH_ORDERS_TIMEOUT=2e3,ReservationSearchBar=function(a,b){var c=this;c.$el=$(b.element),c.$input=c.$el.find(".reservation-search__input"),c.dropdownVisible=ko.observable(!1),c.trainOrders=ko.observableArray([]),c.restaurantOrders=ko.observableArray([]),c.isTrainLoading=ko.observable(!1),c.isRestaurantLoading=ko.observable(!1),c.query=ko.observable(null),c.searchTrainOrdersCall=null,c.searchRestaurantOrdersCall=null,$("body").append("<div class='reservation-search__backdrop' style='display:none;'></div>"),c.$backdrop=$(".reservation-search__backdrop"),c.$backdrop.on("click",function(){c.dropdownVisible(!1)}),c.dropdownVisible.subscribe(function(a){a?c.$backdrop.fadeIn():c.$backdrop.fadeOut()}),c.$input.on("focus",function(){c.dropdownVisible(!0)}),c.openTrainReservationOverview=function(){c.dropdownVisible(!1),headerVM.selectTrainOverview()},c.openRestaurantReservationOverview=function(){c.dropdownVisible(!1),headerVM.selectRestaurantOverview()},c.searchOrders=simpleDebounce(function(){c.query()!==c.$input.val()&&c.$input.val().length>MIN_CHARACTERS_SEARCH?(c.query(c.$input.val()),c.query()&&(c.dropdownVisible(!0),c.isTrainLoading(!0),c.isRestaurantLoading(!0),c.trainOrders([]),c.searchTrainOrdersCall&&(c.searchTrainOrdersCall.abort(),c.searchTrainOrdersCall=null),c.searchTrainOrdersCall=groupReservationApi.searchOrders(c.query(),!1,function(a){c.isTrainLoading(!1),c.trainOrders(a)}),c.restaurantOrders([]),c.searchRestaurantOrdersCall&&(c.searchRestaurantOrdersCall.abort(),c.searchRestaurantOrdersCall=null),c.searchRestaurantOrdersCall=groupReservationApi.searchOrders(c.query(),!0,function(a){c.isRestaurantLoading(!1),c.restaurantOrders(a)}))):(c.isTrainLoading(!1),c.isRestaurantLoading(!1))},SEARCH_ORDERS_TIMEOUT),c.keydownItem=function(a,b){var d=$(b.target),e=function(){b.preventDefault();var a=d.prev();a.length?a.focus():c.$input.focus()};switch(b.which){case 27:return void c.close();case 38:e();break;case 9:case 40:b.shiftKey?e():function(){b.preventDefault();var a=d.next();a.length&&a.focus()}();break;case 13:c.clickItem(a,b)}},c.close=function(){c.dropdownVisible(!1)},c.clickItem=function(a,b){c.close();var d=$(b.currentTarget),e=d.attr("data-order-id");groupReservationApi.openGroupReservationDetail(e)},c.$input.on("keydown",function(a){switch(a.which){case 27:return void c.close();case 40:case 9:if(!a.shiftKey){var b=$(".reservation-search__list-item").eq(0)[0];b&&(a.preventDefault(),b.focus())}}c.query()!==c.$input.val()&&c.$input.val().length>MIN_CHARACTERS_SEARCH&&(c.isTrainLoading(!0),c.isRestaurantLoading(!0)),c.searchOrders()})};ko.components.register("reservation-search",{viewModel:{createViewModel:function(a,b){return new ReservationSearchBar(a,b)}},template:{fromUrl:"assets/groupreservation/reservation-search.html",maxCacheAge:1234}});var ReservationShortcuts=function(a,b){var c=this;c.shortcuts=a.shortcuts;var d=function(a,b){return kp.get(_.find(ko.toJS(a),function(a){return parseInt(ko.unwrap(a.key))==parseInt(b)}),"value")};c.hookTooltips=function(a,c){var e=[];viasToStrings=function(a,b){return a?(viaArray=a.split(","),_.map(viaArray,function(a){return d(b,a)}).join(", ")):null},outwardSearchTime=kp.get(c,"additionalInfo.outward_search_time"),outwardFrom=d(headerVM.outwardFroms,kp.get(c,"additionalInfo.outward_from")),outwardTo=d(headerVM.outwardTos,kp.get(c,"additionalInfo.outward_to")),outwardVia=viasToStrings(kp.get(c,"additionalInfo.outward_via"),headerVM.outwardVias),returnFrom=d(headerVM.returnFroms,kp.get(c,"additionalInfo.return_from")),returnTo=d(headerVM.returnTos,kp.get(c,"additionalInfo.return_to")),returnVia=viasToStrings(kp.get(c,"additionalInfo.return_via"),headerVM.returnVias);var f=function(a){return"<strong>"+a+": </strong>"};e.push(f(i18n.t("groupReservation.detail.journeyOutward.label"))),outwardSearchTime&&e.push(f(i18n.t("groupReservation.detail.journeyOutward.time"))+" "+outwardSearchTime),outwardFrom&&e.push(f(i18n.t("groupReservation.detail.journeyOutward.stationFrom"))+" "+outwardFrom),outwardTo&&e.push(f(i18n.t("groupReservation.detail.journeyOutward.stationTo"))+" "+outwardTo),outwardVia&&e.push(f(i18n.t("groupReservation.detail.journeyOutward.stationVia"))+" "+outwardVia),returnFrom&&(e.push(""),e.push(f(i18n.t("groupReservation.detail.journeyReturn.label"))),e.push(f(i18n.t("groupReservation.detail.journeyReturn.stationFrom"))+" "+returnFrom)),returnTo&&e.push(f(i18n.t("groupReservation.detail.journeyReturn.stationTo"))+" "+returnTo),returnVia&&e.push(f(i18n.t("groupReservation.detail.journeyReturn.stationVia"))+" "+returnVia),$(b.element).find(".shortcut__entry").tooltip({placement:"bottom",title:e.join("<br>"),html:!0})}};ko.components.register("reservation-shortcuts",{viewModel:{createViewModel:function(a,b){return new ReservationShortcuts(a,b)}},template:{fromUrl:"assets/groupreservation/reservation-shortcuts.html",maxCacheAge:1234}});var ReservationSummaryList=function(a,b){var c=this;return c.sections=a.sections,c.sectionsReturn=a.sectionsReturn,c.label=ko.computed(function(){if(ko.unwrap(c.sections).length)return a.label+" "+kp.get(c.sections,"0.displayDate")}),c.route=a.route,c.firstReturnJourneySection=ko.computed(function(){var a=_.head(kp.get(c,"sectionsReturn",[]));return!!a&&ko.unwrap(a)}),c};ReservationSummaryList.prototype.dispose=function(){},ko.components.register("reservation-summary-list",{viewModel:{createViewModel:function(a,b){return new ReservationSummaryList(a,b)}},template:{fromUrl:"assets/groupreservation/reservation-summary-list.html",maxCacheAge:1234}});var ReservationSummaryModal=function(a,b){var c=this;return c.reservationOrder=a.reservationOrder,c.openModal=function(){$(b.element).find(".modal").modal("show")},c.hookTooltip=function(){var a=i18n.t("groupReservation.quickoverview.modalTooltip");$(b.element).find(".js-open-summary-modal").tooltip({placement:"bottom",title:a})},c.hookTooltip(),c};ko.components.register("reservation-summary-modal",{viewModel:{createViewModel:function(a,b){return new ReservationSummaryModal(a,b)}},template:{
fromUrl:"assets/groupreservation/reservation-summary-modal.html",maxCacheAge:1234}});var ReservationSummary=function(a,b){var c=this;c.reservationOrder=a.reservationOrder,c.layout=a.layout,kp.get(c.reservationOrder,"id");var d=function(a){for(var b=[],c=0;c<a.length;c++){var d=new trainModel(ko.toJS(a[c])),e=a[c-1],f=!1,g=!1;d&&e&&ko.unwrap(d.date)!=ko.unwrap(e.date)&&(f=!0,g=kp.get(d,"displayDate")),b.push({displayDate:kp.get(d,"displayDate"),displayDepartureTime:kp.get(d,"displayDepartureTime"),displayArrivalTime:kp.get(d,"displayArrivalTime"),stationFromName:kp.get(d,"stationFromName"),stationToName:kp.get(d,"stationToName"),hasOvernightStay:f,overnightStayDate:g,trainNumber:kp.get(d,"trainNumber")})}return b},e=function(a){for(var b=[],c=0;c<a.length;c++){var d=a[c];b.push({displayDate:kp.get(d,"displayDate"),displayDepartureTime:kp.get(d,"selectedTrain.displayDepartureTime"),displayArrivalTime:kp.get(d,"selectedTrain.displayArrivalTime"),stationFromName:kp.get(d,"stationFromName"),stationToName:kp.get(d,"stationToName"),hasOvernightStay:kp.get(d,"hasOvernightStay",!1),overnightStayDate:kp.get(d,"displayDate"),trainNumber:kp.get(d,"selectedTrain.trainNumber")})}return b};return c.sectionsOutward=ko.computed(function(){return kp.get(c.reservationOrder,"id")?d(kp.get(c.reservationOrder,"bergbahnReservation.outwardJourney.trains",[])):e(kp.get(a,"selectedSectionsOutward",[]))}),c.sectionsReturn=ko.computed(function(){return kp.get(c.reservationOrder,"id")?d(kp.get(c.reservationOrder,"bergbahnReservation.returnJourney.trains",[])):e(kp.get(a,"selectedSectionsReturn",[]))}),c.restaurantName=ko.computed(function(){if(!kp.get(c.reservationOrder,"id"))return kp.get(groupReservationApi.root,"selectedRestaurant.value");var a=gr.restaurants.restaurantById(kp.get(c.reservationOrder,"restaurantReservation.restaurantId"));return a?kp.get(a,"value"):void 0}),c.isContingentValid=ko.computed(function(){var a=kp.get(groupReservationApi.root,"selectedRestaurantFromDate"),b=kp.get(groupReservationApi.root,"selectedRestaurantUntilDate");return a&&b}),c.restaurantTime=ko.computed(function(){return kp.get(c.reservationOrder,"id")?gr.restaurants.restaurantById(kp.get(c.reservationOrder,"restaurantReservation.restaurantId"))?moment(kp.get(c.reservationOrder,"restaurantReservation.from")).format("L"):void 0:moment(kp.get(groupReservationApi.root,"selectedRestaurantDate.key")).format("L")}),c};ReservationSummary.prototype.dispose=function(){},ko.components.register("reservation-summary",{viewModel:{createViewModel:function(a,b){return new ReservationSummary(a,b)}},template:{fromUrl:"assets/groupreservation/reservation-summary.html",maxCacheAge:1234}});var ReservationViaInput=function(a,b){var c=this;c.id=a.id,c.items=a.items,c.selectedItem=ko.observable(a.selectedItem()),c.selectedVias=ko.observableArray([]),c.eventEnter=a.eventEnter,c.isOpened=ko.observable(!1),c.toggleOpen=function(){c.isOpened(!c.isOpened())},c.inputBodyVisible=ko.computed(function(){return c.selectedVias().length<=1||c.isOpened()}),c.stringValue=ko.observable(""),c.calculateStringValue=function(){for(var b=[],d=0;d<c.selectedVias().length;d++){var e=c.selectedVias()[d],f=kp.get(e,"station.key");f&&b.push(f)}strValue=b.join(","),a.selectedItem(strValue),c.stringValue(strValue),c.selectedVias(c.selectedVias())},c.titleKeyPress=function(a,b){13!=b.which&&13!=b.keyCode&&32!=b.which&&32!=b.keyCode||c.toggleOpen()},c.stringDisplayValue=ko.computed(function(){for(var a=[],b=0;b<c.selectedVias().length;b++){var d=c.selectedVias()[b],e=kp.get(d,"station.optionText");e&&a.push(e)}return a.join(", ")}),c.titleTabIndex=ko.computed(function(){return c.selectedVias().length>1?0:-1}),c.convertStringToObject=function(){var a=String(ko.unwrap(c.selectedItem)).split(",");c.selectedVias([]);for(var b=0;b<a.length;b++){var d=_.find(c.items(),function(c){return ko.unwrap(c.key)==a[b]});d&&c.selectedVias.push({station:ko.observable(d),id:c.id+"--"+b})}0==c.selectedVias().length&&c.addVia()},c.clickAddVia=function(){c.isOpened(!0),c.addVia(),c.calculateStringValue()},c.addVia=function(){var a,b=1;do{a=c.id+"--"+b,b++}while(-1!==_.findIndex(c.selectedVias(),{id:a})&&b<1e4);c.selectedVias.push({station:ko.observable({}),id:a})},c.removeVia=function(a){c.selectedVias.splice(a.idx,1),c.calculateStringValue()},c.items.subscribe(function(){c.convertStringToObject()}),a.selectedItem.subscribe(function(){c.selectedItem(a.selectedItem())}),c.onViasChanged=function(){c.calculateStringValue(),console.log("on vias changed")},c.convertStringToObject(),$(b.element).on("close",function(){c.isOpened(!1)}),$(b.element).on("refresh",function(){c.convertStringToObject(),c.isOpened(!1)}),c.selectedItem.subscribe(function(){!1===c.selectedItem()&&(c.selectedVias([]),c.convertStringToObject())})};ko.components.register("reservation-via-input",{viewModel:{createViewModel:function(a,b){return new ReservationViaInput(a,b)}},template:{fromUrl:"assets/groupreservation/reservation-via-input.html",maxCacheAge:1234}});var restaurantReservationApi={gastroStatusOptionsMap:null,getGastroStatusByValue:function(a){if(!this.gastroStatusOptionsMap){var b=this;this.gastroStatusOptionsMap={},this.gastroStatusOptions().forEach(function(a){b.gastroStatusOptionsMap[a.value]=a.name})}return this.gastroStatusOptionsMap[a]},gastroStatusOptions:function(){return[{name:i18n.t("groupReservation.restaurant.detail.gastroStatus.statusesList.new"),value:"new"},{name:i18n.t("groupReservation.restaurant.detail.gastroStatus.statusesList.arrived"),value:"arrived"},{name:i18n.t("groupReservation.restaurant.detail.gastroStatus.statusesList.course_1"),value:"course_1"},{name:i18n.t("groupReservation.restaurant.detail.gastroStatus.statusesList.course_2"),value:"course_2"},{name:i18n.t("groupReservation.restaurant.detail.gastroStatus.statusesList.course_3"),value:"course_3"},{name:i18n.t("groupReservation.restaurant.detail.gastroStatus.statusesList.course_4"),value:"course_4"},{name:i18n.t("groupReservation.restaurant.detail.gastroStatus.statusesList.left"),value:"left"}]},selectSaveGastroStatus:function(a,b,c){if(b){var d={reservationId:a,status:b};$.ajax(serviceRootURL+"/gastrostatus",{type:"PUT",data:JSON.stringify(d),dataType:"json",contentType:"application/json",success:function(a,b,c){console.log("Gastro status updated!")},error:function(a,b,c){checkSession(a),console.log("Server error on updating gastro status: "+a.responseText),showError("Server error on updating gastro status",a,b,c)},complete:function(){c&&c()}})}}},GroupReservationRestaurantBookingItems=function(a){var b=this;b.reservationOrder=a.reservationOrder,b.showLoadingSpinner=ko.observable(!1),b.totalAmount=ko.observable(0),b.isAllItemsSelected=ko.observable(),b.totalDescription=ko.observable(""),b.selectedItems=ko.observableArray(),b.bookingItems=ko.observableArray([]),b.selectAllItems=function(){return b.selectedItems()==b.bookingItems()?(b.selectedItems([]),setTimeout(function(){b.isAllItemsSelected(!1)},0)):(b.selectedItems(b.bookingItems()),setTimeout(function(){b.isAllItemsSelected(!0)},0)),!0},b.selectItem=function(a){console.log("selected item: ",a,b,this)},b.confirmCancelOrderItems=function(){if(console.log("confirmCancelOrderItems"),0!=b.selectedItems().length){b.showLoadingSpinner(!0);var a=b.selectedItems(),c=[];if(a!=b.bookingItems()){for(var d=0;d<a.length;d++)c.push({id:a[d].id,status:ORDER_ITEM_STATE_CANCELED});var e="cancelRestaurantOrderItems"}else var e="cancelRestaurantOrder";var f={id:b.reservationOrder().id(),type:ORDER_TYPE_GROUP_RESTAURANT_RESERVATION_ORDER,status:b.reservationOrder().status(),orderItems:c};$.ajax(serviceRootURL+"/orders/"+b.reservationOrder().id()+"?action="+e,{type:"PUT",data:JSON.stringify(f),dataType:"json",contentType:"application/json",success:function(a,b,c){console.log("order items canceled"),location.reload()},error:function(a,b,c){checkSession(a),console.log("Server error on loading menus: "+a.responseText),showError("Server error on loading menus",a,b,c)},complete:function(){b.showLoadingSpinner(!1)}})}},b.getOrderItems=function(){if(b.reservationOrder&&b.reservationOrder().orderItems&&b.reservationOrder().orderItems().length>0){var a=b.reservationOrder().orderItems();console.log(b,a);for(var c=0,d=0,e=0;e<a.length;e++)b.bookingItems.push({id:a[e].id(),type:a[e].productName,product:"Addon",sku:a[e].sku(),price:a[e].price()+" "+CURRENCY,date:a[e].date(),status:a[e].status()==ORDER_ITEM_STATE_COMPLETE?ORDER_ITEM_STATE_BOOKED:a[e].status()}),b.totalAmount(b.totalAmount()+a[e].price()),a[e].status()==ORDER_ITEM_STATE_COMPLETE?c++:a[e].status()==ORDER_ITEM_STATE_CANCELED&&d++;b.totalDescription(c+" items booked, "+d+" canceled")}},b.getOrderItems()};ko.components.register("group-reservation-restaurant-bookingitems",{viewModel:{createViewModel:function(a){return new GroupReservationRestaurantBookingItems(a)}},template:{fromUrl:"assets/groupreservation/restaurant/group-reservation-restaurant-bookingitems.html",maxCacheAge:1e3}});var GroupReservationRestaurantDetail=function(a){var b=this;b.screenWorking=ko.observable(!0),b.createRestaurantReservationBase=a.createRestaurantReservationBase,b.updateRestaurantReservationBase=a.updateRestaurantReservationBase,b.selectedTourGuidePaymentTypes=a.selectedTourGuidePaymentTypes,b.reservationGroupOrderDirty=a.reservationGroupOrderDirty,b.trainOrderId=a.trainOrderId,b.showLoadingSpinner=ko.observable(!1),b.enableMenus=ko.observable(!0),b.showLoadingSpinnerGastroStatus=ko.observable(!1),b.screenState=ko.observable(BERGBAHN_GROUP_RESERVATION_SCREEN_STATE_RESERVATION),b.reservationOrder=ko.observable(null),b.invoiceTypesList=ko.observableArray([]),b.menus=ko.observableArray([]),b.drinks=ko.observableArray([]),b.from=ko.observable(null),b.until=ko.observable(null),b.restaurantReservationInvoiceType=ko.observable(null),b.reservationOrderId=ko.observable(null),b.menusTotal=ko.observable(0),b.menusDiscountTotal=ko.observable(0),b.drinksTotal=ko.observable(0),b.drinksDiscountTotal=ko.observable(0),b.selectedGastroStatus=ko.observable(null),b.total=ko.computed(function(){var a=b.menusTotal();return a+=b.drinksTotal()}),b.discountTotal=ko.computed(function(){var a=b.menusDiscountTotal();return a+=b.drinksDiscountTotal()}),b.reservationRestaurants=headerVM.reservationRestaurants,b.selectedRestaurant=ko.observable(),b.selectedRestaurantId=ko.observable(null),b.restaurantReservationId=ko.observable(null),b.restaurantComment=ko.observable(),b.pax=ko.observable(1),b.selectedRestaurantMaxAvailablePax=ko.observable(),b.reservationGroupOrderDirtyComputed=ko.computed(function(){return b.reservationGroupOrderDirty()}),b.selectedRestaurant.subscribeChanged(function(a,c){a&&(b.formRestaurant().parsley().validate({group:"selectedRestaurant"}),b.selectedRestaurantId(a.id()))});var c=function(){var a=[{name:i18n.t("components.bootstrapSelect.placeholder"),value:null}];b.selectedTourGuidePaymentTypes()&&b.selectedTourGuidePaymentTypes().forEach(function(b){a.push({value:b,name:i18n.t("groupReservation.detail.paymenttype."+b)})}),b.invoiceTypesList(a)};c(),b.selectedTourGuidePaymentTypes.subscribe(function(){c()}),b.origMenus=[],b.origMenus=ko.observableArray([]),b.origDrinks=ko.observableArray([]),b.reservationOrder.subscribe(function(){if(b.reservationOrder()){var a=b.reservationOrder().restaurantReservation,c=kp.get(b.reservationOrder,"id");c&&(b.reservationOrderId(c),b.restaurantReservationInvoiceType(kp.get(b.reservationOrder,"paymentType"))),a&&(b.restaurantComment(kp.get(a,"customerComment")),b.pax(kp.get(a,"pax")),b.selectedGastroStatus(kp.get(a,"gastroStatus")),b.restaurantReservationId(kp.get(b,"reservationOrder.restaurantReservation.id")),b.menus(kp.get(b,"reservationOrder.restaurantReservation.menus")),b.drinks(kp.get(b,"reservationOrder.restaurantReservation.drinks")),b.origMenus(ko.toJS(kp.get(b.reservationOrder,"restaurantReservation.menus"))),b.origDrinks(ko.toJS(kp.get(b.reservationOrder,"restaurantReservation.drinks"))),gr.ui.fillBootstrapSelectByKey(b.reservationRestaurants,kp.get(a(),"restaurantId"),b.selectedRestaurant),b.from(moment(kp.get(a,"from")).toDate()),b.until(moment(kp.get(a,"until")).toDate()))}}),b.isContingentError=ko.computed(function(){return!b.from()||!b.until()}),b.showReservationCreateButton=ko.computed(function(){return!b.reservationOrderId()&&!b.isContingentError()}),b.showReservationUpdateButton=ko.computed(function(){return kp.get(b,"reservationOrder.status")==ORDER_STATUS_RESTAURANT_RESERVED&&b.reservationOrderId()&&(b.reservationOrderDirty()||b.reservationGroupOrderDirtyComputed())&&!b.isContingentError()}),b.isStandAloneRestaurantReservationOrder=ko.computed(function(){var a=b.reservationOrder();if(a&&a.group&&a.group().orders&&a.group().orders()){for(var c=a.group().orders(),d=0;d<c.length;d++)if(c[d].restaurantOrderId==a.id())return!1;return!0}return!0}),b.showReservationCancelButton=ko.computed(function(){var a=b.isStandAloneRestaurantReservationOrder();return!(kp.get(b,"reservationOrder.status")!=ORDER_STATUS_RESTAURANT_RESERVED||!b.reservationOrderId()||!a)}),b.showBookOrderButton=ko.computed(function(){return!(kp.get(b,"reservationOrder.status")!=ORDER_STATUS_RESTAURANT_RESERVED||!b.reservationOrderId())}),b.enableDetailSelector=ko.computed(function(){return kp.get(b,"reservationOrder.status")!=ORDER_STATUS_RESTAURANT_RESERVED&&b.reservationOrderId()?(b.enableMenus(!1),!1):(b.enableMenus(!0),!0)}),b.showBookingItems=ko.computed(function(){return!(kp.get(b,"reservationOrder.status")!=ORDER_STATUS_COMPLETE||!b.reservationOrderId())}),b.showCancelOrderButton=ko.computed(function(){return!(kp.get(b,"reservationOrder.status")!=ORDER_STATUS_COMPLETE||!b.reservationOrderId())}),b.showReservationChooseProductButton=ko.computed(function(){return b.reservationOrderId()&&b.showReservationCancelButton()}),b.isMenusDirty=ko.computed(function(){var a=function(a){var b=ko.unwrap(a.sku),c=parseInt(ko.unwrap(a.quantity)),d=parseInt(ko.unwrap(a.discountPercent)),e=parseInt(ko.unwrap(a.quantityFree)),f=function(a){return ko.unwrap(a.sku)+"-"+parseInt(ko.unwrap(a.quantity))+"_"+parseInt(ko.unwrap(a.discountPercent))+"_"+parseInt(ko.unwrap(a.quantityFree))};return b+"-"+c+"_"+d+"_"+e+_.map(ko.toJS(kp.get(a,"addons")),f).join(":")},c=_.map(ko.toJS(kp.get(b,"menus")),a);console.log(c);var d=_.map(b.origMenus(),a);console.log(d);var e=_.difference(c,d);return console.log("menuDirty = ",!!e.length&&c.length!==d.length),!!e.length||c.length!==d.length}),b.isDrinksDirty=ko.computed(function(){var a=function(a){return ko.unwrap(a.id)+"-"+ko.unwrap(a.category)+"-"+parseInt(ko.unwrap(a.quantity))+"-"+ko.unwrap(a.description)+"-"+ko.unwrap(a.revenue)+"_"+ +ko.unwrap(a.discountPercent)+"-"+ko.unwrap(a.quantityFree)},c=_.map(ko.toJS(kp.get(b,"drinks")),a);console.log(c);var d=_.map(b.origDrinks(),a);console.log(d);var e=_.difference(c,d);return console.log("drinksDirty = "+e.length),!!e.length||c.length!==d.length}),b.sanitizeComment=function(a){if(a)return String(a)},b.reservationOrderDirty=ko.computed(function(){var a=kp.get(b,"restaurantReservationInvoiceType")!=kp.get(b.reservationOrder,"paymentType"),c=kp.get(b,"selectedGastroStatus")!=kp.get(b.reservationOrder,"restaurantReservation.gastroStatus"),d=kp.get(b,"pax")!=kp.get(b.reservationOrder,"restaurantReservation.pax"),e=kp.get(b,"selectedRestaurantId")!=kp.get(b.reservationOrder,"restaurantReservation.restaurantId"),f=moment(kp.get(b,"from")).format(DATETIME_SERVER_FORMAT)!=kp.get(b.reservationOrder,"restaurantReservation.from"),g=moment(kp.get(b,"until")).format(DATETIME_SERVER_FORMAT)!=kp.get(b.reservationOrder,"restaurantReservation.until"),h=b.sanitizeComment(kp.get(b,"restaurantComment"))!=b.sanitizeComment(kp.get(b.reservationOrder,"restaurantReservation.customerComment"));return d||e||f||g||a||b.isMenusDirty()||b.isDrinksDirty()||h||c}),b.selectSaveGastroStatus=function(){b.showLoadingSpinnerGastroStatus(!0),restaurantReservationApi.selectSaveGastroStatus(kp.get(b.reservationOrder,"restaurantReservation.id"),b.selectedGastroStatus(),function(){b.showLoadingSpinnerGastroStatus(!1)})},b.formRestaurant=function(){return $("#js-groupreservation-restaurant-form")},b.formGroupForm=function(){return $("#js-group-form")},b.formRestaurantMenu=function(){return $("#js-groupreservation-restaurant-menu-form")},b.formRestaurantDrink=function(){return $("#js-groupreservation-restaurant-drinks-form")},b.isValidFormRestaurant=function(){return b.from()&&b.until()&&b.formGroupForm().parsley().validate({group:"reservation"})&&b.formRestaurantMenu().parsley().validate({group:"menu"})&&b.formRestaurantDrink().parsley().validate({group:"drink"})&&b.formRestaurant().parsley().validate({group:"restaurant"})},b.getRestaurantReservationEntity=function(){var a=parseInt(kp.get(b,"pax")),c=parseInt(kp.get(b,"reservationOrder.restaurantReservation.pax",0)),d=kp.get(b,"reservationOrder.restaurantReservation.roomAssignments",[]);return{id:parseInt(kp.get(b,"reservationOrder.restaurantReservation.id")),paymentType:b.restaurantReservationInvoiceType(),type:"standard",categoryKey:CATEGORY_KEY_MENU,restaurantId:parseInt(kp.get(b,"selectedRestaurantId")),customerComment:kp.get(b,"restaurantComment"),pax:kp.get(b,"pax"),from:b.from().format(DATETIME_SERVER_FORMAT),until:b.until().format(DATETIME_SERVER_FORMAT),gastroStatus:b.selectedGastroStatus(),menus:ko.toJS(b.menus()),roomAssignments:a<c?[]:d,drinks:ko.toJS(b.drinks())}},b.isRestaurantLinkedToTrainOrder=function(){if(b.reservationOrder()&&b.reservationOrder().id()&&b.reservationOrder().group()&&b.reservationOrder().group().orders()){return b.reservationOrder().group().orders().findIndex(function(a){return parseInt(a.restaurantOrderId)===b.reservationOrder().id()})>-1}return b.reservationOrder()&&b.reservationOrder().bergbahnReservation&&b.trainOrderId()},b.createRestaurantReservation=function(){console.log("createRestaurantReservation ..."),b.isValidFormRestaurant()&&(b.reservationOrder()&&b.reservationOrder().bergbahnReservation?b.updateRestaurantReservationBase(b.getRestaurantReservationEntity(),"updateReservation",b.reservationOrder(),b.trainOrderId()):b.createRestaurantReservationBase(b.getRestaurantReservationEntity()))},b.updateRestaurantReservation=function(){console.log("updateRestaurantReservation ..."),b.isValidFormRestaurant()&&b.updateRestaurantReservationBase(b.getRestaurantReservationEntity())},b.bookRestaurantReservation=function(){if(console.log("bookRestaurantReservation ..."),b.isValidFormRestaurant()){var a=b.getRestaurantReservationEntity();a.status=ORDER_STATUS_RESTAURANT_RESERVED,b.updateRestaurantReservationBase(a,"bookRestaurantOrder")}},b.confirmCancelReservation=function(){if(console.log("confirmCancelReservation ..."),b.isValidFormRestaurant()){var a=b.getRestaurantReservationEntity();a.status=ORDER_STATUS_RESERVATION_CANCELED,b.updateRestaurantReservationBase(a,"cancelRestaurantReservation")}},b.confirmCancelOrder=function(){console.log("confirmCancelOrder ...");var a=b.getRestaurantReservationEntity();a.status=ORDER_STATUS_RESTAURANT_CANCELED,b.updateRestaurantReservationBase(a,"cancelRestaurantOrder")},a.reservationOrder&&b.reservationOrder(a.reservationOrder())};ko.components.register("group-reservation-restaurant-detail",{viewModel:{createViewModel:function(a){return new GroupReservationRestaurantDetail(a)}},template:{fromUrl:"assets/groupreservation/restaurant/group-reservation-restaurant-detail.html",maxCacheAge:1e3}});var GroupReservationRestaurantDrinks=function(a){var b=this;b.showLoadingSpinner=ko.observable(!1),b.discountTotal=ko.observable(0),b.drinks=a.drinks,b.enableDrinks=a.enableDrinks,b.categoryTypes=ko.observableArray([{name:i18n.t("groupReservation.restaurant.drinks.category.alcoholic"),key:"alcoholic"},{name:i18n.t("groupReservation.restaurant.drinks.category.nonalcoholic"),key:"nonalcoholic"}]),b.addDrink=function(){console.log("Add drink clicked!"),b.drinks.push(new drinkModel({quantity:1,category:"alcoholic"}))},b.deleteDrink=function(a){console.log("deleteDrink index = ",a),b.drinks().splice(a,1),b.drinks(b.drinks())},b.total=ko.computed(function(){var c=0,d=0;return b.drinks()&&(b.drinks().forEach(function(a){a.totalPrice()&&(c+=a.totalPrice()),a.discountTotalPrice()&&(d+=a.discountTotalPrice())}),b.discountTotal(d),a.drinksDiscountTotal(d),a.drinksTotal(c)),c})};ko.components.register("group-reservation-restaurant-drinks",{viewModel:{createViewModel:function(a){return new GroupReservationRestaurantDrinks(a)}},template:{fromUrl:"assets/groupreservation/restaurant/group-reservation-restaurant-drinks.html",maxCacheAge:1e3}});var GroupReservationRestaurantMenuExtras=function(a){var b=this;this.showDialog=a.showDialog,this.showInfoDialog=ko.observable(!1),this.selectedOptionItem=a.selectedOptionItem,this.selectedAddonOptionItem=ko.observable(null),this.selectedMenuItem=a.selectedMenuItem,this.selectedSkus={},this.addons=ko.observableArray([]),this.priceToProdSkuMap=a.priceToProdSkuMap,this.menuAddonList=ko.observableArray([]),b.formExtras=function(){return $("#js-groupreservation-restaurant-extras-form")},b.isValidForm=function(){return b.formExtras().parsley().validate({group:"extras"})},b.selectedOptionItem.subscribeChanged(function(a,c){b.showDialog()&&a&&a.addons&&b.menuAddonList(a.addons())}),b.setAddonsMenuList=function(a){a.forEach(function(a){a.menuAddonList(b.menuAddonList().filter(function(c){return!b.selectedSkus[c.key()]||c.key()==a.sku()}))})},b.selectedMenuItem.subscribeChanged(function(a,c){if(b.rendering=!0,b.showDialog()&&a){b.selectedSkus={},b.addons([]);ko.toJS(kp.get(a,"addons",[])).forEach(function(a){b.selectedSkus[a.sku]=!0,b.addons.push(new addonModel(a))}),b.setAddonsMenuList(b.addons()),b.addons(b.addons())}}),this.selectBySku=function(a){return gr.ui.getBootstrapSelectByKey(b.menuAddonList,a)},this.changeSelectedSku=function(a,c,d){if(d>=0&&b.addons().length>0){var e=b.addons()[d];a?(e.sku(a.key()),b.selectedSkus[a.key()]=!0):e.sku(null),e.price(b.priceToProdSkuMap[e.sku()]),b.selectedSkus[c]=!1,b.setAddonsMenuList(b.addons())}},b.chooseInfo=function(a){console.log("chooseInfo sku = ",a.sku());var c=gr.ui.getBootstrapSelectByKey(b.menuAddonList,a.sku());console.log("chooseInfo optionItem = ",c),b.showInfoDialog(!0),b.selectedAddonOptionItem(c)},this.submit=function(){b.isValidForm()&&(b.selectedMenuItem().addons(b.addons()),b.showDialog(!1))},b.cancel=function(){console.log("cancel clicked!"),b.selectedSkus={},b.addons([]),b.menuAddonList([]),b.showDialog(!1)},this.addMeal=function(){console.log("add meal");var a=b.menuAddonList().filter(function(a){return!b.selectedSkus[a.key()]});b.addons.push(new addonModel({quantity:1,menuAddonList:a}))},this.deleteItem=function(a){console.log("delete meal index = ",a);var c=b.addons()[a].sku();b.selectedSkus[c]=!1,b.addons().splice(a,1),b.setAddonsMenuList(b.addons()),b.addons(b.addons())}};ko.components.register("group-reservation-restaurant-extras",{viewModel:{createViewModel:function(a){return new GroupReservationRestaurantMenuExtras(a)}},template:{fromUrl:"assets/groupreservation/restaurant/group-reservation-restaurant-extras.html",maxCacheAge:1e3}});var GroupReservationRestaurantMenuIndividual=function(a){function b(a){this.course=ko.observable(a.course),this.addons=ko.observableArray(a.addons),c.setAddonsMenuList(this.addons())}var c=this;this.showDialog=a.showDialog,this.showInfoDialog=ko.observable(!1),this.selectedOptionItem=a.selectedOptionItem,this.selectedAddonOptionItem=ko.observable(null),this.selectedMenuItem=a.selectedMenuItem,c.selectedSkus={},this.courses=ko.observableArray(),this.priceToProdSkuMap=a.priceToProdSkuMap,this.menuAddonList=ko.observableArray([]),c.formIndiv=function(){return $("#js-groupreservation-restaurant-indiv-form")},c.isValidForm=function(){return c.formIndiv().parsley().validate({group:"individual"})},c.setAddonsMenuList=function(a){a.forEach(function(a){a.menuAddonList(c.menuAddonList().filter(function(b){return!c.selectedSkus[a.course()][b.key()]||b.key()==a.sku()}))})},c.selectedMenuItem.subscribeChanged(function(a,d){if(c.showDialog()&&a&&a.addons){c.selectedSkus={},c.courses([]);for(var e=1;e<=MAX_RESTAURANT_INDIVIDUAL_COURSES;e++){var f=a.addons().filter(function(a){if(a.course()===e)return a});c.selectedSkus[e]={},f.length>0&&(f.forEach(function(a){c.selectedSkus[e][a.sku()]=!0}),c.courses.push(new b({course:e,addons:f})))}}}),c.selectedOptionItem.subscribeChanged(function(a,b){c.showDialog()&&a&&a.addons&&c.menuAddonList(a.addons())}),this.selectBySku=function(a){return gr.ui.getBootstrapSelectByKey(c.menuAddonList,a)},this.changeSelectedSku=function(a,b,d){var e=c.courses()[d-1].addons()[b],f=e.sku();e.sku(a.key()),e.price(c.priceToProdSkuMap[e.sku()]),c.selectedSkus[d][a.key()]=!0,c.selectedSkus[d][f]=!1,c.setAddonsMenuList(c.courses()[d-1].addons())},c.chooseInfo=function(a){console.log("chooseInfo sku = ",a.sku());var b=gr.ui.getBootstrapSelectByKey(c.menuAddonList,a.sku());console.log("chooseInfo optionItem = ",b),c.showInfoDialog(!0),c.selectedAddonOptionItem(b)},this.submit=function(){if(c.isValidForm()){var a=[];c.courses().forEach(function(b){a=a.concat(b.addons())}),c.selectedMenuItem().addons(a),c.showDialog(!1)}},this.addCourse=function(){console.log("addCourse"),c.courses.push(new b({course:c.courses().length+1,addons:[]}))},this.addMeal=function(a){console.log("addMeal");var b=c.menuAddonList().filter(function(b){return!c.selectedSkus[a+1][b.key()]});c.courses()[a].addons.push(new addonModel({quantity:1,course:a+1,menuAddonList:b}))},this.deleteItem=function(a,b){console.log("delete meal index = ",a),console.log("delete meal course = ",b);var d=c.courses()[b-1].addons()[a].sku();c.selectedSkus[b][d]=!1,c.courses()[b-1].addons().splice(a,1),c.setAddonsMenuList(c.courses()[b-1].addons()),c.courses()[b-1].addons(c.courses()[b-1].addons())}};ko.components.register("group-reservation-restaurant-individual",{viewModel:{createViewModel:function(a){return new GroupReservationRestaurantMenuIndividual(a)}},template:{fromUrl:"assets/groupreservation/restaurant/group-reservation-restaurant-individual.html",maxCacheAge:1e3}});var GroupReservationRestaurantMenuInfo=function(a){this.showDialog=a.showDialog,this.selectedOptionItem=a.selectedOptionItem};ko.components.register("group-reservation-restaurant-info",{viewModel:{createViewModel:function(a){return new GroupReservationRestaurantMenuInfo(a)}},template:{fromUrl:"assets/groupreservation/restaurant/group-reservation-restaurant-info.html",maxCacheAge:1e3}});var GroupReservationRestaurantMenus=function(a){var b=this;b.showLoadingSpinner=ko.observable(!1),b.selectedRestaurant=a.selectedRestaurant,b.menus=a.menus,b.enableMenus=a.enableMenus,b.menuOptionList=ko.observable(),b.selectedSkus={},b.showExtrasDialog=ko.observable(!1),b.showInfoDialog=ko.observable(!1),b.showMenusDialog=ko.observable(!1),b.selectedOptionItem=ko.observable(),b.selectedMenuItem=ko.observable(),b.priceToProdSkuMap={},b.nameToProdSkuMap={},b.loadOptionList=function(){b.menuOptionList().forEach(function(a){a.addons().forEach(function(a){b.nameToProdSkuMap[a.key()]=a.optionText()})})},b.selectedRestaurant()&&b.selectedRestaurant().menuOptionList&&(b.menuOptionList=b.selectedRestaurant().menuOptionList,b.loadOptionList()),b.selectedRestaurant.subscribeChanged(function(a,c){b.menus([]),a&&a.menuOptionList&&(b.menuOptionList(a.menuOptionList()),b.loadOptionList())}),b.rendering=!0,b.menuItemMapper=function(a,c){var d=kp.get(c,"key");return!b.selectedSkus[d]||a.dataValue&&a.dataValue()===d||b.rendering?{value:kp.get(c,a.itemsValue),text:kp.get(c,a.itemsText),group:kp.get(c,a.itemsGroup),data:c}:null},b.selectBySku=function(a){return gr.ui.getBootstrapSelectByKey(b.menuOptionList,a)},b.changeSelectedSku=function(a,c,d){if(d>=0&&b.menus().length>0){var e=b.menus()[d];b.selectedSkus[c]=!1,a?(b.selectedSkus[a.key()]=!0,e.sku(a.key())):e.sku(null),e.price(b.priceToProdSkuMap[e.sku()]),setTimeout(function(){b.menuOptionList(b.menuOptionList())},0)}},b.discountTotal=ko.observable(0),b.total=ko.computed(function(){var c=0,d=0;return b.menus()&&(b.menus().forEach(function(a){a.totalPrice()&&(c+=a.totalPrice()),a.discountTotalPrice()&&(d+=a.discountTotalPrice()),a.addons().forEach(function(a){a.totalPrice()&&(c+=a.totalPrice()),a.discountTotalPrice()&&(d+=a.discountTotalPrice())})}),b.discountTotal(d),a.menusDiscountTotal(d),a.menusTotal(c)),c}),b.chooseExtras=function(a){console.log("chooseExtras sku = ",a.sku());var c=gr.ui.getBootstrapSelectByKey(b.menuOptionList,a.sku());console.log("chooseExtras optionItem = ",c),b.showExtrasDialog(!0),b.selectedOptionItem(c),b.selectedMenuItem(a)},b.chooseInfo=function(a){console.log("chooseInfo sku = ",a.sku());var c=gr.ui.getBootstrapSelectByKey(b.menuOptionList,a.sku());console.log("chooseInfo optionItem = ",c),b.showInfoDialog(!0),b.selectedOptionItem(c)},b.chooseMeals=function(a){console.log("chooseMeals sku = ",a.sku());var c=gr.ui.getBootstrapSelectByKey(b.menuOptionList,a.sku());console.log("chooseMeals optionItem = ",c),b.showMenusDialog(!0),b.selectedOptionItem(c),b.selectedMenuItem(a)},b.addMenu=function(){console.log("Add menu clicked!"),b.menus.push(new menuModel({quantity:1,daytrip:!1}))},b.deleteMenu=function(a,c){console.log("deleteMenu index = ",a),console.log("deleteMenu sku = ",c),b.selectedSkus[c]=!1,b.menus().splice(a,1),b.menus(b.menus()),b.menuOptionList(b.menuOptionList())},b.getAllMenuPrices=function(){console.log("getAllMenuPrices"),b.showLoadingSpinner(!0);var a={categoryKey:CATEGORY_KEY_MENU};$.ajax(serviceRootURL+"/menuprices",{type:"GET",data:a,dataType:"json",contentType:"application/json",success:function(a,c,d){console.log("Menu prices loaded!"),a&&a.length&&(a.forEach(function(a){b.priceToProdSkuMap[a.sku]=a.price}),b.menus().forEach(function(a,c){b.selectedSkus[a.sku()]=!0,a.daytrip()?a.price(0):a.price(b.priceToProdSkuMap[a.sku()]),a.addons().forEach(function(a){a.price(b.priceToProdSkuMap[a.sku()])})})),b.rendering=!1,b.menuOptionList(b.menuOptionList())},error:function(a,b,c){checkSession(a),console.log("Server error on loading menus: "+a.responseText),showError("Server error on loading menus",a,b,c)},complete:function(){b.showLoadingSpinner(!1)}})},b.getAllMenuPrices()};ko.components.register("group-reservation-restaurant-menus",{viewModel:{createViewModel:function(a){return new GroupReservationRestaurantMenus(a)}},template:{fromUrl:"assets/groupreservation/restaurant/group-reservation-restaurant-menus.html",maxCacheAge:1e3}});var TARIFF_TYPE_BERGBAHN_ROUTE_BASED="bergbahnRouteBased",TARIFF_TYPE_BERGBAHN_ABO="bergbahnAbo",TARIFF_TYPE_DAYTRIP="daytrip",BergbahnGroupReservationTariffSelection=function(a,b){var c=this;return c.bergbahn=ko.observable(new BergbahnGroupReservationCategoryBergbahnViewModel(a)),c};BergbahnGroupReservationTariffSelection.prototype.dispose=function(){},ko.components.register("tariff-selection",{viewModel:{createViewModel:function(a,b){return new BergbahnGroupReservationTariffSelection(a,b)}},template:{fromUrl:"assets/groupreservation/tariff-selection.html",maxCacheAge:1234}});var TourguideSelect=function(a,b){var c=this;return c.formItem=ko.observable({}),c.openModal=function(){window.__tourguideAddVM.isEdit(!1),window.__tourguideAddVM.resetFields(),window.__tourguideAddVM.showLinkBtn(),$(b.element).find(".modal").modal("show")},c.openEditModal=function(){window.__tourguideAddVM.isEdit(!0),c.formItem({id:ko.observable(kp.get(c,"selectedTourGuide.id")),username:ko.observable(kp.get(c,"selectedTourGuide.username")),firstname:ko.observable(kp.get(c,"selectedTourGuide.firstname")),lastname:ko.observable(kp.get(c,"selectedTourGuide.lastname")),email:ko.observable(kp.get(c,"selectedTourGuide.email")),phone:ko.observable(kp.get(c,"selectedTourGuide.phone")),locale:ko.observable(kp.get(c,"selectedTourGuide.locale")),changepwd:ko.observable(kp.get(c,"selectedTourGuide.changepwd"))}),window.__tourguideAddVM.prepareAsEditForm(c.formItem),window.__tourguideAddVM.showSaveBtn(),$(b.element).find(".modal").modal("show")},
c.selectedTourOperator=a.selectedTourOperator,c.parsleyRemote=serviceRootURL+"/tourguides",c.parsleyRemoteOptions={type:"GET",dataType:"json",data:{request:"ajax"}},c.selectedTourGuide=ko.observable({}),null!=a.enable?c.enable=a.enable:c.enable=ko.observable(!0),c.selectedTourGuide=a.selectedItem,c.tourGuideAddCallback=function(a){c.selectedTourGuide(a),c.tourGuidesReseller().push(a),c.addCallback(a)},c.tourGuideEditCallback=function(a){c.selectedTourGuide(a);var b=c.tourGuidesReseller().findIndex(function(b){return b.id()===a.id()});c.tourGuidesReseller()[b]=a,c.addCallback(a)},c.closeModal=function(){$(b.element).find(".modal").modal("hide"),$(b.element).find("form").parsley().reset()},c.hookTooltip=function(){$(b.element).find(".js-create-tourguide-button").tooltip({placement:"bottom",title:"Bitte zuerst ein Reisebüro wählen"})},c.destroyTooltip=function(){$(b.element).find(".js-create-tourguide-button").tooltip("destroy")},c.itemMapper=function(a,b){var c=a.itemMapperDefault(b),d=kp.get(b,"phone",null);return d&&(c.phone=d),c},c.createDisabled=ko.computed(function(){var a=!c.selectedTourOperator().id;return a?c.hookTooltip():c.destroyTooltip(),a}),c.tourGuidesReseller=a.tourGuidesReseller,c.tourGuidesAll=a.tourGuidesAll,c.tourGuides=ko.computed(function(){return c.tourGuidesReseller&&c.tourGuidesReseller().forEach(function(a){a.optionGroup="assigned"}),c.tourGuidesAll&&c.tourGuidesAll().forEach(function(a){a.optionGroup="available"}),c.tourGuidesReseller().concat(c.tourGuidesAll())}),c.partnerId=ko.computed(function(){return null!=c.selectedTourOperator&&null!=c.selectedTourOperator()&&null!=c.selectedTourOperator().id&&null!=c.selectedTourOperator().id()?c.selectedTourOperator().id():null}),c.id=a.id,c.isRequired=a.isRequired,c.validationGroup=a.validationGroup,c.addCallback=a.addCallback,c};ko.components.register("tourguide-select",{viewModel:{createViewModel:function(a,b){return tourguideSelectVM=new TourguideSelect(a,b),tourguideSelectVM}},template:{fromUrl:"assets/groupreservation/tourguide-select.html",maxCacheAge:1234}}),window.Parsley.addAsyncValidator("validateTourGuideEmail",function(a){return!a.responseJSON.length});var TravelagencySelect=function(a,b){var c=this;return c.openModal=function(){$(b.element).find(".modal").modal("show")},c.selectedTourOperator=a.selectedTourOperator,c.selectedItem=a.selectedItem,c.locales=ko.observableArray([{key:"de_CH",name:i18n.t("common.language.german"),enabled:ko.observable(!0)},{key:"en_GB",name:i18n.t("common.language.english"),enabled:ko.observable(!0)},{key:"it_IT",name:i18n.t("common.language.italian"),enabled:ko.observable(!0)},{key:"fr",name:i18n.t("common.language.france"),enabled:ko.observable(!0)}]),c.countries=ko.observableArray((new abstractPersonalizationViewModel).optionsCountry()),null!=a.enable?c.enable=a.enable:c.enable=ko.observable(!0),c.isEdit=ko.observable(!1),c.formItem=ko.observable({}),c.resetForm=function(){c.formItem({city:ko.observable(null),country:ko.observable(null),email:ko.observable(null),id:ko.observable(null),locale:ko.observable(null),name:ko.observable(null),partnerId:ko.observable(kp.get(c,"selectedTourOperator.key")),street:ko.observable(null),streetNumber:ko.observable(null),zipCode:ko.observable(null),default:ko.observable(!1)})},c.resetForm(),c.openModal=function(){c.isEdit(!1),c.resetForm(),$(b.element).find(".modal").modal("show")},c.openEditModal=function(){c.isEdit(!0),c.resetForm(),c.formItem({id:ko.observable(kp.get(c,"selectedItem.id")),city:ko.observable(kp.get(c,"selectedItem.city")),country:ko.observable(kp.get(c,"selectedItem.country")),email:ko.observable(kp.get(c,"selectedItem.email")),locale:ko.observable(kp.get(c,"selectedItem.locale")),name:ko.observable(kp.get(c,"selectedItem.name")),partnerId:ko.observable(kp.get(c,"selectedTourOperator.key")),street:ko.observable(kp.get(c,"selectedItem.street")),streetNumber:ko.observable(kp.get(c,"selectedItem.streetNumber")),zipCode:ko.observable(kp.get(c,"selectedItem.zipCode")),default:ko.observable(kp.get(c,"selectedTourOperator.travelagencyDefaultId")==kp.get(c,"selectedItem.id"))}),$(b.element).find(".modal").modal("show")},c.updateItem=function(){$(b.element).find("form").parsley().whenValidate().then(function(){var a=kp.get(c,"formItem.default",!1),d=ko.toJS(c.formItem());delete d.default,c.isEdit()?groupReservationApi.updateTravelAgency(d).then(function(){for(var a=c.items(),d=0;d<a.length;d++){kp.get(a,d+".id")==kp.get(c.formItem(),"id")&&(a[d]=new bergbahnGroupTravelAgencyOptionModel(ko.toJS(c.formItem())),c.items(a),c.selectedItem(a[d]))}$(b.element).find(".modal").modal("hide"),$(b.element).find("form").parsley().reset()}):groupReservationApi.createTravelAgency(d).then(function(){var a=new bergbahnGroupTravelAgencyOptionModel(ko.toJS(c.formItem()));c.items().push(a),c.selectedItem(a),$(b.element).find(".modal").modal("hide"),$(b.element).find("form").parsley().reset()});var e=kp.get(c,"selectedTourOperator.travelagencyDefaultId",null);a?e=kp.get(c,"selectedItem.id"):kp.get(c,"selectedItem.id")==e&&(e=null),groupReservationApi.updateResellerDefaults(kp.get(c,"selectedTourOperator.key"),e,kp.get(c,"selectedTourOperator.contactPersonDefaultId",null)).then(function(){c.selectedTourOperator().travelagencyDefaultId(e)})})},c.closeModal=function(){$(b.element).find(".modal").modal("hide"),$(b.element).find("form").parsley().reset()},c.createDisabled=ko.computed(function(){var a=!c.selectedTourOperator().id;return a}),c.items=a.items,c.id=a.id,c.isRequired=a.isRequired,c.validationGroup=a.validationGroup,c};ko.components.register("travelagency-select",{viewModel:{createViewModel:function(a,b){return new TravelagencySelect(a,b)}},template:{fromUrl:"assets/groupreservation/travelagency-select.html",maxCacheAge:1234}});